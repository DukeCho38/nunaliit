!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.n2es6=t():e.n2es6=t()}(window,function(){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="../dist/",i(i.s=9)}([function(e,t){},function(e,t,i){(function(e){function i(e,t){for(var i=0,n=e.length-1;n>=0;n--){var r=e[n];"."===r?e.splice(n,1):".."===r?(e.splice(n,1),i++):i&&(e.splice(n,1),i--)}if(t)for(;i--;i)e.unshift("..");return e}var n=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,r=function(e){return n.exec(e).slice(1)};function o(e,t){if(e.filter)return e.filter(t);for(var i=[],n=0;n<e.length;n++)t(e[n],n,e)&&i.push(e[n]);return i}t.resolve=function(){for(var t="",n=!1,r=arguments.length-1;r>=-1&&!n;r--){var s=r>=0?arguments[r]:e.cwd();if("string"!=typeof s)throw new TypeError("Arguments to path.resolve must be strings");s&&(t=s+"/"+t,n="/"===s.charAt(0))}return(n?"/":"")+(t=i(o(t.split("/"),function(e){return!!e}),!n).join("/"))||"."},t.normalize=function(e){var n=t.isAbsolute(e),r="/"===s(e,-1);return(e=i(o(e.split("/"),function(e){return!!e}),!n).join("/"))||n||(e="."),e&&r&&(e+="/"),(n?"/":"")+e},t.isAbsolute=function(e){return"/"===e.charAt(0)},t.join=function(){var e=Array.prototype.slice.call(arguments,0);return t.normalize(o(e,function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e}).join("/"))},t.relative=function(e,i){function n(e){for(var t=0;t<e.length&&""===e[t];t++);for(var i=e.length-1;i>=0&&""===e[i];i--);return t>i?[]:e.slice(t,i-t+1)}e=t.resolve(e).substr(1),i=t.resolve(i).substr(1);for(var r=n(e.split("/")),o=n(i.split("/")),s=Math.min(r.length,o.length),a=s,l=0;l<s;l++)if(r[l]!==o[l]){a=l;break}var c=[];for(l=a;l<r.length;l++)c.push("..");return(c=c.concat(o.slice(a))).join("/")},t.sep="/",t.delimiter=":",t.dirname=function(e){var t=r(e),i=t[0],n=t[1];return i||n?(n&&(n=n.substr(0,n.length-1)),i+n):"."},t.basename=function(e,t){var i=r(e)[2];return t&&i.substr(-1*t.length)===t&&(i=i.substr(0,i.length-t.length)),i},t.extname=function(e){return r(e)[3]};var s="b"==="ab".substr(-1)?function(e,t,i){return e.substr(t,i)}:function(e,t,i){return t<0&&(t=e.length+t),e.substr(t,i)}}).call(this,i(2))},function(e,t){var i,n,r=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(i===setTimeout)return setTimeout(e,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(e){i=o}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var l,c=[],d=!1,u=-1;function h(){d&&l&&(d=!1,l.length?c=l.concat(c):u=-1,c.length&&p())}function p(){if(!d){var e=a(h);d=!0;for(var t=c.length;t;){for(l=c,c=[];++u<t;)l&&l[u].run();u=-1,t=c.length}l=null,d=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.push(new f(e,t)),1!==c.length||d||a(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=m,r.addListener=m,r.once=m,r.off=m,r.removeListener=m,r.removeAllListeners=m,r.emit=m,r.prependListener=m,r.prependOnceListener=m,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,i){"use strict";e.exports=r,e.exports.default=r;var n=i(4);function r(e,t){if(!(this instanceof r))return new r(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&this._initFormat(t),this.clear()}function o(e,t,i){if(!i)return t.indexOf(e);for(var n=0;n<t.length;n++)if(i(e,t[n]))return n;return-1}function s(e,t){a(e,0,e.children.length,t,e)}function a(e,t,i,n,r){r||(r=m(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var o,s=t;s<i;s++)o=e.children[s],l(r,e.leaf?n(o):o);return r}function l(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function c(e,t){return e.minX-t.minX}function d(e,t){return e.minY-t.minY}function u(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function h(e){return e.maxX-e.minX+(e.maxY-e.minY)}function p(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function f(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function m(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function v(e,t,i,r,o){for(var s,a=[t,i];a.length;)(i=a.pop())-(t=a.pop())<=r||(s=t+Math.ceil((i-t)/r/2)*r,n(e,s,t,i,o),a.push(t,s,s,i))}r.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,i=[],n=this.toBBox;if(!f(e,t))return i;for(var r,o,s,a,l=[];t;){for(r=0,o=t.children.length;r<o;r++)s=t.children[r],f(e,a=t.leaf?n(s):s)&&(t.leaf?i.push(s):p(e,a)?this._all(s,i):l.push(s));t=l.pop()}return i},collides:function(e){var t=this.data,i=this.toBBox;if(!f(e,t))return!1;for(var n,r,o,s,a=[];t;){for(n=0,r=t.children.length;n<r;n++)if(o=t.children[n],f(e,s=t.leaf?i(o):o)){if(t.leaf||p(e,s))return!0;a.push(o)}t=a.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}var n=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var r=this.data;this.data=n,n=r}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=m([]),this},remove:function(e,t){if(!e)return this;for(var i,n,r,s,a=this.data,l=this.toBBox(e),c=[],d=[];a||c.length;){if(a||(a=c.pop(),n=c[c.length-1],i=d.pop(),s=!0),a.leaf&&-1!==(r=o(e,a.children,t)))return a.children.splice(r,1),c.push(a),this._condense(c),this;s||a.leaf||!p(a,l)?n?(i++,a=n.children[i],s=!1):a=null:(c.push(a),d.push(i),i=0,n=a,a=a.children[0])}return this},toBBox:function(e){return e},compareMinX:c,compareMinY:d,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var i=[];e;)e.leaf?t.push.apply(t,e.children):i.push.apply(i,e.children),e=i.pop();return t},_build:function(e,t,i,n){var r,o=i-t+1,a=this._maxEntries;if(o<=a)return s(r=m(e.slice(t,i+1)),this.toBBox),r;n||(n=Math.ceil(Math.log(o)/Math.log(a)),a=Math.ceil(o/Math.pow(a,n-1))),(r=m([])).leaf=!1,r.height=n;var l,c,d,u,h=Math.ceil(o/a),p=h*Math.ceil(Math.sqrt(a));for(v(e,t,i,p,this.compareMinX),l=t;l<=i;l+=p)for(v(e,l,d=Math.min(l+p-1,i),h,this.compareMinY),c=l;c<=d;c+=h)u=Math.min(c+h-1,d),r.children.push(this._build(e,c,u,n-1));return s(r,this.toBBox),r},_chooseSubtree:function(e,t,i,n){for(var r,o,s,a,l,c,d,h,p,f;n.push(t),!t.leaf&&n.length-1!==i;){for(d=h=1/0,r=0,o=t.children.length;r<o;r++)l=u(s=t.children[r]),p=e,f=s,(c=(Math.max(f.maxX,p.maxX)-Math.min(f.minX,p.minX))*(Math.max(f.maxY,p.maxY)-Math.min(f.minY,p.minY))-l)<h?(h=c,d=l<d?l:d,a=s):c===h&&l<d&&(d=l,a=s);t=a||t.children[0]}return t},_insert:function(e,t,i){var n=this.toBBox,r=i?e:n(e),o=[],s=this._chooseSubtree(r,this.data,t,o);for(s.children.push(e),l(s,r);t>=0&&o[t].children.length>this._maxEntries;)this._split(o,t),t--;this._adjustParentBBoxes(r,o,t)},_split:function(e,t){var i=e[t],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);var o=this._chooseSplitIndex(i,r,n),a=m(i.children.splice(o,i.children.length-o));a.height=i.height,a.leaf=i.leaf,s(i,this.toBBox),s(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(i,a)},_splitRoot:function(e,t){this.data=m([e,t]),this.data.height=e.height+1,this.data.leaf=!1,s(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,i){var n,r,o,s,l,c,d,h,p,f,m,v,g,y;for(c=d=1/0,n=t;n<=i-t;n++)r=a(e,0,n,this.toBBox),o=a(e,n,i,this.toBBox),p=r,f=o,m=void 0,v=void 0,g=void 0,y=void 0,m=Math.max(p.minX,f.minX),v=Math.max(p.minY,f.minY),g=Math.min(p.maxX,f.maxX),y=Math.min(p.maxY,f.maxY),s=Math.max(0,g-m)*Math.max(0,y-v),l=u(r)+u(o),s<c?(c=s,h=n,d=l<d?l:d):s===c&&l<d&&(d=l,h=n);return h},_chooseSplitAxis:function(e,t,i){var n=e.leaf?this.compareMinX:c,r=e.leaf?this.compareMinY:d;this._allDistMargin(e,t,i,n)<this._allDistMargin(e,t,i,r)&&e.children.sort(n)},_allDistMargin:function(e,t,i,n){e.children.sort(n);var r,o,s=this.toBBox,c=a(e,0,t,s),d=a(e,i-t,i,s),u=h(c)+h(d);for(r=t;r<i-t;r++)o=e.children[r],l(c,e.leaf?s(o):o),u+=h(c);for(r=i-t-1;r>=t;r--)o=e.children[r],l(d,e.leaf?s(o):o),u+=h(d);return u},_adjustParentBBoxes:function(e,t,i){for(var n=i;n>=0;n--)l(t[n],e)},_condense:function(e){for(var t,i=e.length-1;i>=0;i--)0===e[i].children.length?i>0?(t=e[i-1].children).splice(t.indexOf(e[i]),1):this.clear():s(e[i],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}},function(e,t,i){e.exports=function(){"use strict";function e(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function t(e,t){return e<t?-1:e>t?1:0}return function(i,n,r,o,s){!function t(i,n,r,o,s){for(;o>r;){if(o-r>600){var a=o-r+1,l=n-r+1,c=Math.log(a),d=.5*Math.exp(2*c/3),u=.5*Math.sqrt(c*d*(a-d)/a)*(l-a/2<0?-1:1),h=Math.max(r,Math.floor(n-l*d/a+u)),p=Math.min(o,Math.floor(n+(a-l)*d/a+u));t(i,n,h,p,s)}var f=i[n],m=r,v=o;for(e(i,r,n),s(i[o],f)>0&&e(i,r,o);m<v;){for(e(i,m,v),m++,v--;s(i[m],f)<0;)m++;for(;s(i[v],f)>0;)v--}0===s(i[r],f)?e(i,r,v):e(i,++v,o),v<=n&&(r=v+1),n<=v&&(o=v-1)}}(i,n,r||0,o||i.length-1,s||t)}}()},function(module,exports,__webpack_require__){"use strict";(function(process,module){var __WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__,__WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__,nunaliit2;"function"!=typeof nunaliit2&&(nunaliit2=function(){},"undefined"!=typeof window&&(window.nunaliit2=nunaliit2)),void 0===nunaliit2.coreScriptName&&(nunaliit2.coreScriptName="nunaliit2-debug-il.js");
/*! Tiles.js | http://thinkpixellab.com/tilesjs | 2012-12-03 */
var Tiles={};!function(e){var t=Tiles.Tile=function(t,i){this.id=t,this.top=0,this.left=0,this.width=0,this.height=0,this.$el=e(i||document.createElement("div"))};t.prototype.appendTo=function(e,t,i,n){this.$el.hide().appendTo(e),t?this.$el.delay(i).fadeIn(n):this.$el.show()},t.prototype.remove=function(t,i){t?this.$el.fadeOut({complete:function(){e(this).remove()}}):this.$el.remove()},t.prototype.resize=function(e,t,i,n,r){var o={},s=!1;this.left!==t.x&&(o.left=t.x,this.left=t.x,s=!0),this.top!==t.y&&(o.top=t.y,this.top=t.y,s=!0),this.width!==t.width&&(o.width=t.width,this.width=t.width,s=!0),this.height!==t.height&&(o.height=t.height,this.height=t.height,s=!0);var a=this,l=function(){var e=a.$el[0];a.left!==e.offsetLeft&&a.$el.css("left",a.left),a.top!==e.offsetTop&&a.$el.css("top",a.top),r&&r()};i&&s?this.$el.animate(o,{duration:n,easing:"swing",complete:l}):(s&&this.$el.css(o),setTimeout(l,n))}}(jQuery),function(e){function t(e,t,i,n){this.x=e,this.y=t,this.width=i,this.height=n}t.prototype.copy=function(){return new t(this.x,this.y,this.width,this.height)},Tiles.Rectangle=t;Tiles.Template=function(e,t,i){this.rects=e,this.numTiles=this.rects.length,this.numRows=i,this.numCols=t},Tiles.Template.prototype.copy=function(){var e,t,i=[];for(t=0,e=this.rects.length;t<e;t++)i.push(this.rects[t].copy());return new Tiles.Template(i,this.numCols,this.numRows)},Tiles.Template.prototype.append=function(e){if(this.numCols!==e.numCols)throw"Appended templates must have the same number of columns";var i,n,r,o=this.numRows;for(i=0,n=e.rects.length;i<n;i++)r=e.rects[i],this.rects.push(new t(r.x,o+r.y,r.width,r.height));this.numRows+=e.numRows},Tiles.Template.fromJSON=function(e){var i=function(e){var t,i,n,r,o,s=[],a=e.length;for(i=0;i<a;i++)for(n=e[i],s[i]=[],t=0,r=n.length;t<r;t++)" "!==(o=n[t])&&s[i].push(o);return s}(e),n=function(e){var i,n,r,o,s,a,l,c=[],d=e.length,u=0===d?0:e[0].length;for(e=e.slice(),s=0;s<d;s++)e[s]=e[s].slice();for(s=0;s<d;s++)for(o=0;o<u;o++)if(null!=(i=e[s][o])){if(r=1,n=1,i!==Tiles.Template.SINGLE_CELL){for(;r+o<u&&i===e[s][o+r];)r++;for(;n+s<d&&i===e[s+n][o];)n++}for(l=0;l<n;l++)for(a=0;a<r;a++)e[s+l][o+a]=null;c.push(new t(o,s,r,n))}return c}(i);return new Tiles.Template(n,i.length>0?i[0].length:0,i.length)},Tiles.Template.prototype.toJSON=function(){var e,t,i,n,r,o,s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a=s.length,l=0,c=[];for(r=0;r<this.numRows;r++)for(c[r]=[],n=0;n<this.numCols;n++)c[r][n]=Tiles.Template.SINGLE_CELL;for(e=0,t=this.rects.length;e<t;e++)if((i=this.rects[e]).width>1||i.height>1){for(o=s[l],r=0;r<i.height;r++)for(n=0;n<i.width;n++)c[i.y+r][i.x+n]=o;l=(l+1)%a}for(r=0;r<this.numRows;r++)c[r]=c[r].join("");return c},Tiles.Template.SINGLE_CELL="."}(jQuery),Tiles.UniformTemplates={get:function(e,t){var i,n,r=Math.ceil(t/e),o=[];for(n=0;n<r;n++)for(i=0;i<e;i++)o.push(new Tiles.Rectangle(i,n,1,1));return new Tiles.Template(o,e,r)}},function(e){var t=Tiles.Grid=function(t){this.$el=e(t),this.animationDuration=500,this.cellSizeMin=150,this.templateFactory=Tiles.UniformTemplates,this.priorityPageSize=Number.MAX_VALUE,this.cellPadding=10,this.cellSize=0,this.numCols=1,this.template=null,this.isDirty=!0,this.tiles=[],this.tilesAdded=[],this.tilesRemoved=[]};function i(e,t,i){var n=e.y+e.height,r=e.x+e.width;return!(!t||t.top>n||t.top+t.height<e.y||t.left>r||t.left+t.width<e.x)||!(!i||i.y>n||i.y+i.height<e.y||i.x>r||i.x+i.width<e.x)}t.prototype.getContentWidth=function(){return this.$el.width()},t.prototype.resizeColumns=function(){var e=this.getContentWidth();return Math.max(1,Math.floor((e+this.cellPadding)/(this.cellSizeMin+this.cellPadding)))},t.prototype.resizeCellSize=function(){var e=this.getContentWidth();return Math.ceil((e+this.cellPadding)/this.numCols)-this.cellPadding},t.prototype.resize=function(){var e=this.resizeColumns();this.numCols!==e&&e>0&&(this.numCols=e,this.isDirty=!0);var t=this.resizeCellSize();this.cellSize!==t&&t>0&&(this.cellSize=t,this.isDirty=!0)},t.prototype.updateTiles=function(t){var i,n,r,o,s=(t=function(t){var i,n,r=[],o=t?t.length:0;for(i=0;i<o;i++)n=t[i],-1===e.inArray(n,r)&&r.push(n);return r}(t)).length,a=[];for(i=this.tiles.length-1;i>=0;i--)n=this.tiles[i],(o=e.inArray(n.id,t))<0?this.tilesRemoved.push(n):a[o]=n;for(this.tiles=[],i=0;i<s;i++){if(!(n=a[i])){if(r=t[i],this.createTile){if(!(n=this.createTile(r)))continue}else n=new Tiles.Tile(r);this.tilesAdded.push(n)}this.tiles.push(n)}},t.prototype.insertTiles=function(e){this.addTiles(e,!0)},t.prototype.addTiles=function(e,t){if(e&&0!==e.length){var i,n=[],r=this.tiles.length;for(i=0;i<r;i++)n.push(this.tiles[i].id);var o=t?e.concat(n):n.concat(e);this.updateTiles(o)}},t.prototype.removeTiles=function(t){if(t&&0!==t.length){var i,n,r,o=[];for(i=0,n=this.tiles.length;i<n;i++)r=this.tiles[i].id,-1===e.inArray(r,t)&&o.push(r);this.updateTiles(o)}},t.prototype.createTemplate=function(e,t){e=Math.max(1,e);var i=this.templateFactory.get(e,t);return i||(i=Tiles.UniformTemplates.get(e,t)),i},t.prototype.ensureTemplate=function(e){if(this.template&&this.template.numCols===this.numCols){var t=e-this.template.rects.length;t>0&&(this.template.append(this.createTemplate(this.numCols,t)),this.isDirty=!0)}else this.template=this.createTemplate(this.numCols,e),this.isDirty=!0},t.prototype.shouldRedraw=function(){return this.cellSize<=0&&this.resize(),this.ensureTemplate(this.tiles.length),this.isDirty||this.tilesAdded.length>0||this.tilesRemoved.length>0},t.prototype.redraw=function(t,n){if(this.shouldRedraw()){var r,o,s,a,l,c,d,u,h,p,f,m=this.tiles.length,v=this.priorityPageSize,g=this.animationDuration,y=this.cellSize+this.cellPadding,_=0,S=0,b=new Tiles.Rectangle(this.$el.scrollLeft(),this.$el.scrollTop(),this.$el.width(),this.$el.height());for(_=0;_<m;_+=v)for(s=this.template.rects.slice(_,_+v),a=this.tiles.slice(_,_+v),p=s.slice(0),f=a.slice(0),this.prioritizePage&&this.prioritizePage(p,f),l=0,c=f.length;l<c;l++)r=f[l],o=e.inArray(r,this.tilesAdded)>=0,d=p[l],u=new Tiles.Rectangle(d.x*y,d.y*y,d.width*y-this.cellPadding,d.height*y-this.cellPadding),r.resize(d,u,t&&!o&&i(b,r,u),g),o&&(S=(h=t&&i(b,null,u))&&this.getAppendDelay?this.getAppendDelay(d,s,p,r,a,f):0,r.appendTo(this.$el,h,S,g));for(l=0,c=this.tilesRemoved.length;l<c;l++)r=this.tilesRemoved[l],h=t&&i(b,r,null),r.remove(h,g);this.tilesRemoved=[],this.tilesAdded=[],this.isDirty=!1,n&&setTimeout(function(){n(!0)},g+10)}else n&&n(!1)}}(jQuery);
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||function(e){if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,i=function(){return e.URL||e.webkitURL||e},n=t.createElementNS("http://www.w3.org/1999/xhtml","a"),r="download"in n,o=e.webkitRequestFileSystem,s=e.requestFileSystem||o||e.mozRequestFileSystem,a=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l=0,c=function(t){var n=function(){"string"==typeof t?i().revokeObjectURL(t):t.remove()};e.chrome?n():setTimeout(n,500)},d=function(e,t,i){for(var n=(t=[].concat(t)).length;n--;){var r=e["on"+t[n]];if("function"==typeof r)try{r.call(e,i||e)}catch(e){a(e)}}},u=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e},h=function(t,a,h){h||(t=u(t));var p,f,m,v=this,g=t.type,y=!1,_=function(){d(v,"writestart progress write writeend".split(" "))},S=function(){(!y&&p||(p=i().createObjectURL(t)),f)?f.location.href=p:null==e.open(p,"_blank")&&"undefined"!=typeof safari&&(e.location.href=p);v.readyState=v.DONE,_(),c(p)},b=function(e){return function(){if(v.readyState!==v.DONE)return e.apply(this,arguments)}},I={create:!0,exclusive:!1};if(v.readyState=v.INIT,a||(a="download"),r)return p=i().createObjectURL(t),n.href=p,n.download=a,void setTimeout(function(){var e,t;e=n,t=new MouseEvent("click"),e.dispatchEvent(t),_(),c(p),v.readyState=v.DONE});e.chrome&&g&&"application/octet-stream"!==g&&(m=t.slice||t.webkitSlice,t=m.call(t,0,t.size,"application/octet-stream"),y=!0),o&&"download"!==a&&(a+=".download"),("application/octet-stream"===g||o)&&(f=e),s?(l+=t.size,s(e.TEMPORARY,l,b(function(e){e.root.getDirectory("saved",I,b(function(e){var i=function(){e.getFile(a,I,b(function(e){e.createWriter(b(function(i){i.onwriteend=function(t){f.location.href=e.toURL(),v.readyState=v.DONE,d(v,"writeend",t),c(e)},i.onerror=function(){var e=i.error;e.code!==e.ABORT_ERR&&S()},"writestart progress write abort".split(" ").forEach(function(e){i["on"+e]=v["on"+e]}),i.write(t),v.abort=function(){i.abort(),v.readyState=v.DONE},v.readyState=v.WRITING}),S)}),S)};e.getFile(a,{create:!1},b(function(e){e.remove(),i()}),b(function(e){e.code===e.NOT_FOUND_ERR?i():S()}))}),S)}),S)):S()},p=h.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,i){return i||(e=u(e)),navigator.msSaveOrOpenBlob(e,t||"download")}:(p.abort=function(){this.readyState=this.DONE,d(this,"abort")},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,function(e,t,i){return new h(e,t,i)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content),nunaliit2,$n2,EmptyInit,codex,JSON,patcher;module.exports?module.exports.saveAs=saveAs:null!==__webpack_require__(7)&&null!=__webpack_require__(8)&&(__WEBPACK_AMD_DEFINE_ARRAY__=[],__WEBPACK_AMD_DEFINE_RESULT__=function(){return saveAs}.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__),void 0===__WEBPACK_AMD_DEFINE_RESULT__||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)),__WEBPACK_AMD_DEFINE_ARRAY__=[],void 0===(__WEBPACK_AMD_DEFINE_RESULT__="function"==typeof(__WEBPACK_AMD_DEFINE_FACTORY__=function(){var e,t,i="undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==i?i:{},n=!i.document&&!!i.postMessage,r=n&&/(\?|&)papaworker(=|&|$)/.test(i.location.search),o=!1,s={},a=0,l={parse:function(t,n){var r=(n=n||{}).dynamicTyping||!1;if(I(r)&&(n.dynamicTypingFunction=r,r={}),n.dynamicTyping=r,n.worker&&l.WORKERS_SUPPORTED){var c=function(){if(!l.WORKERS_SUPPORTED)return!1;if(!o&&null===l.SCRIPT_PATH)throw new Error("Script path cannot be determined automatically when Papa Parse is loaded asynchronously. You need to set Papa.SCRIPT_PATH manually.");var t=l.SCRIPT_PATH||e;t+=(-1!==t.indexOf("?")?"&":"?")+"papaworker";var n=new i.Worker(t);return n.onmessage=g,n.id=a++,s[n.id]=n,n}();return c.userStep=n.step,c.userChunk=n.chunk,c.userComplete=n.complete,c.userError=n.error,n.step=I(n.step),n.chunk=I(n.chunk),n.complete=I(n.complete),n.error=I(n.error),delete n.worker,void c.postMessage({input:t,config:n,workerId:c.id})}var d=null;return"string"==typeof t?d=n.download?new u(n):new p(n):!0===t.readable&&I(t.read)&&I(t.on)?d=new f(n):(i.File&&t instanceof File||t instanceof Object)&&(d=new h(n)),d.stream(t)},unparse:function(e,t){var i=!1,n=!0,r=",",o="\r\n",s='"';"object"==typeof t&&("string"==typeof t.delimiter&&1===t.delimiter.length&&-1===l.BAD_DELIMITERS.indexOf(t.delimiter)&&(r=t.delimiter),("boolean"==typeof t.quotes||t.quotes instanceof Array)&&(i=t.quotes),"string"==typeof t.newline&&(o=t.newline),"string"==typeof t.quoteChar&&(s=t.quoteChar),"boolean"==typeof t.header&&(n=t.header));var a=new RegExp(s,"g");if("string"==typeof e&&(e=JSON.parse(e)),e instanceof Array){if(!e.length||e[0]instanceof Array)return d(null,e);if("object"==typeof e[0])return d(c(e[0]),e)}else if("object"==typeof e)return"string"==typeof e.data&&(e.data=JSON.parse(e.data)),e.data instanceof Array&&(e.fields||(e.fields=e.meta&&e.meta.fields),e.fields||(e.fields=e.data[0]instanceof Array?e.fields:c(e.data[0])),e.data[0]instanceof Array||"object"==typeof e.data[0]||(e.data=[e.data])),d(e.fields||[],e.data||[]);throw"exception: Unable to serialize unrecognized input";function c(e){if("object"!=typeof e)return[];var t=[];for(var i in e)t.push(i);return t}function d(e,t){var i="";"string"==typeof e&&(e=JSON.parse(e)),"string"==typeof t&&(t=JSON.parse(t));var s=e instanceof Array&&e.length>0,a=!(t[0]instanceof Array);if(s&&n){for(var l=0;l<e.length;l++)l>0&&(i+=r),i+=u(e[l],l);t.length>0&&(i+=o)}for(var c=0;c<t.length;c++){for(var d=s?e.length:t[c].length,h=0;h<d;h++){h>0&&(i+=r);var p=s&&a?e[h]:h;i+=u(t[c][p],h)}c<t.length-1&&(i+=o)}return i}function u(e,t){if(null==e)return"";e=e.toString().replace(a,s+s);var n="boolean"==typeof i&&i||i instanceof Array&&i[t]||function(e,t){for(var i=0;i<t.length;i++)if(e.indexOf(t[i])>-1)return!0;return!1}(e,l.BAD_DELIMITERS)||e.indexOf(r)>-1||" "===e.charAt(0)||" "===e.charAt(e.length-1);return n?s+e+s:e}}};if(l.RECORD_SEP=String.fromCharCode(30),l.UNIT_SEP=String.fromCharCode(31),l.BYTE_ORDER_MARK="\ufeff",l.BAD_DELIMITERS=["\r","\n",'"',l.BYTE_ORDER_MARK],l.WORKERS_SUPPORTED=!n&&!!i.Worker,l.SCRIPT_PATH=null,l.LocalChunkSize=10485760,l.RemoteChunkSize=5242880,l.DefaultDelimiter=",",l.Parser=v,l.ParserHandle=m,l.NetworkStreamer=u,l.FileStreamer=h,l.StringStreamer=p,l.ReadableStreamStreamer=f,i.jQuery){var c=i.jQuery;c.fn.parse=function(e){var t=e.config||{},n=[];return this.each(function(e){var r="INPUT"===c(this).prop("tagName").toUpperCase()&&"file"===c(this).attr("type").toLowerCase()&&i.FileReader;if(!r||!this.files||0===this.files.length)return!0;for(var o=0;o<this.files.length;o++)n.push({file:this.files[o],inputElem:this,instanceConfig:c.extend({},t)})}),r(),this;function r(){if(0!==n.length){var t,i,r,s,a=n[0];if(I(e.before)){var d=e.before(a.file,a.inputElem);if("object"==typeof d){if("abort"===d.action)return t="AbortError",i=a.file,r=a.inputElem,s=d.reason,void(I(e.error)&&e.error({name:t},i,r,s));if("skip"===d.action)return void o();"object"==typeof d.config&&(a.instanceConfig=c.extend(a.instanceConfig,d.config))}else if("skip"===d)return void o()}var u=a.instanceConfig.complete;a.instanceConfig.complete=function(e){I(u)&&u(e,a.file,a.inputElem),o()},l.parse(a.file,a.instanceConfig)}else I(e.complete)&&e.complete()}function o(){n.splice(0,1),r()}}}function d(e){this._handle=null,this._paused=!1,this._finished=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},function(e){var t=S(e);t.chunkSize=parseInt(t.chunkSize),e.step||e.chunk||(t.chunkSize=null),this._handle=new m(t),this._handle.streamer=this,this._config=t}.call(this,e),this.parseChunk=function(e){if(this.isFirstChunk&&I(this._config.beforeFirstChunk)){var t=this._config.beforeFirstChunk(e);void 0!==t&&(e=t)}this.isFirstChunk=!1;var n=this._partialLine+e;this._partialLine="";var o=this._handle.parse(n,this._baseIndex,!this._finished);if(!this._handle.paused()&&!this._handle.aborted()){var s=o.meta.cursor;this._finished||(this._partialLine=n.substring(s-this._baseIndex),this._baseIndex=s),o&&o.data&&(this._rowCount+=o.data.length);var a=this._finished||this._config.preview&&this._rowCount>=this._config.preview;if(r)i.postMessage({results:o,workerId:l.WORKER_ID,finished:a});else if(I(this._config.chunk)){if(this._config.chunk(o,this._handle),this._paused)return;o=void 0,this._completeResults=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(o.data),this._completeResults.errors=this._completeResults.errors.concat(o.errors),this._completeResults.meta=o.meta),!a||!I(this._config.complete)||o&&o.meta.aborted||this._config.complete(this._completeResults,this._input),a||o&&o.meta.paused||this._nextChunk(),o}},this._sendError=function(e){I(this._config.error)?this._config.error(e):r&&this._config.error&&i.postMessage({workerId:l.WORKER_ID,error:e,finished:!1})}}function u(e){var t;(e=e||{}).chunkSize||(e.chunkSize=l.RemoteChunkSize),d.call(this,e),this._nextChunk=n?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(e){this._input=e,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(t=new XMLHttpRequest,this._config.withCredentials&&(t.withCredentials=this._config.withCredentials),n||(t.onload=b(this._chunkLoaded,this),t.onerror=b(this._chunkError,this)),t.open("GET",this._input,!n),this._config.downloadRequestHeaders){var e=this._config.downloadRequestHeaders;for(var i in e)t.setRequestHeader(i,e[i])}if(this._config.chunkSize){var r=this._start+this._config.chunkSize-1;t.setRequestHeader("Range","bytes="+this._start+"-"+r),t.setRequestHeader("If-None-Match","webkit-no-cache")}try{t.send()}catch(e){this._chunkError(e.message)}n&&0===t.status?this._chunkError():this._start+=this._config.chunkSize}},this._chunkLoaded=function(){4==t.readyState&&(t.status<200||t.status>=400?this._chunkError():(this._finished=!this._config.chunkSize||this._start>function(e){var t=e.getResponseHeader("Content-Range");return null===t?-1:parseInt(t.substr(t.lastIndexOf("/")+1))}(t),this.parseChunk(t.responseText)))},this._chunkError=function(e){var i=t.statusText||e;this._sendError(i)}}function h(e){var t,i;(e=e||{}).chunkSize||(e.chunkSize=l.LocalChunkSize),d.call(this,e);var n="undefined"!=typeof FileReader;this.stream=function(e){this._input=e,i=e.slice||e.webkitSlice||e.mozSlice,n?((t=new FileReader).onload=b(this._chunkLoaded,this),t.onerror=b(this._chunkError,this)):t=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var e=this._input;if(this._config.chunkSize){var r=Math.min(this._start+this._config.chunkSize,this._input.size);e=i.call(e,this._start,r)}var o=t.readAsText(e,this._config.encoding);n||this._chunkLoaded({target:{result:o}})},this._chunkLoaded=function(e){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(e.target.result)},this._chunkError=function(){this._sendError(t.error)}}function p(e){var t;e=e||{},d.call(this,e),this.stream=function(e){return t=e,this._nextChunk()},this._nextChunk=function(){if(!this._finished){var e=this._config.chunkSize,i=e?t.substr(0,e):t;return t=e?t.substr(e):"",this._finished=!t,this.parseChunk(i)}}}function f(e){e=e||{},d.call(this,e);var t=[],i=!0;this.stream=function(e){this._input=e,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._nextChunk=function(){t.length?this.parseChunk(t.shift()):i=!0},this._streamData=b(function(e){try{t.push("string"==typeof e?e:e.toString(this._config.encoding)),i&&(i=!1,this.parseChunk(t.shift()))}catch(e){this._streamError(e)}},this),this._streamError=b(function(e){this._streamCleanUp(),this._sendError(e.message)},this),this._streamEnd=b(function(){this._streamCleanUp(),this._finished=!0,this._streamData("")},this),this._streamCleanUp=b(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function m(e){var t,i,n,r=/^\s*-?(\d*\.?\d+|\d+\.?\d*)(e[-+]?\d+)?\s*$/i,o=this,s=0,a=!1,c=!1,d=[],u={data:[],errors:[],meta:{}};if(I(e.step)){var h=e.step;e.step=function(t){if(u=t,f())p();else{if(p(),0===u.data.length)return;s+=t.data.length,e.preview&&s>e.preview?i.abort():h(u,o)}}}function p(){if(u&&n&&(g("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+l.DefaultDelimiter+"'"),n=!1),e.skipEmptyLines)for(var t=0;t<u.data.length;t++)1===u.data[t].length&&""===u.data[t][0]&&u.data.splice(t--,1);return f()&&function(){if(u){for(var e=0;f()&&e<u.data.length;e++)for(var t=0;t<u.data[e].length;t++)d.push(u.data[e][t]);u.data.splice(0,1)}}(),function(){if(!u||!e.header&&!e.dynamicTyping)return u;for(var t=0;t<u.data.length;t++){for(var i=e.header?{}:[],n=0;n<u.data[t].length;n++){var r=n,o=u.data[t][n];e.header&&(r=n>=d.length?"__parsed_extra":d[n]),o=m(r,o),"__parsed_extra"===r?(i[r]=i[r]||[],i[r].push(o)):i[r]=o}u.data[t]=i,e.header&&(n>d.length?g("FieldMismatch","TooManyFields","Too many fields: expected "+d.length+" fields but parsed "+n,t):n<d.length&&g("FieldMismatch","TooFewFields","Too few fields: expected "+d.length+" fields but parsed "+n,t))}return e.header&&u.meta&&(u.meta.fields=d),u}()}function f(){return e.header&&0===d.length}function m(t,i){return function(t){return e.dynamicTypingFunction&&void 0===e.dynamicTyping[t]&&(e.dynamicTyping[t]=e.dynamicTypingFunction(t)),!0===(e.dynamicTyping[t]||e.dynamicTyping)}(t)?"true"===i||"TRUE"===i||"false"!==i&&"FALSE"!==i&&(n=i,r.test(n)?parseFloat(n):n):i;var n}function g(e,t,i,n){u.errors.push({type:e,code:t,message:i,row:n})}this.parse=function(r,o,s){if(e.newline||(e.newline=function(e){var t=(e=e.substr(0,1048576)).split("\r"),i=e.split("\n"),n=i.length>1&&i[0].length<t[0].length;if(1===t.length||n)return"\n";for(var r=0,o=0;o<t.length;o++)"\n"===t[o][0]&&r++;return r>=t.length/2?"\r\n":"\r"}(r)),n=!1,e.delimiter)I(e.delimiter)&&(e.delimiter=e.delimiter(r),u.meta.delimiter=e.delimiter);else{var c=function(t,i){for(var n,r,o,s=[",","\t","|",";",l.RECORD_SEP,l.UNIT_SEP],a=0;a<s.length;a++){var c=s[a],d=0,u=0;o=void 0;for(var h=new v({delimiter:c,newline:i,preview:10}).parse(t),p=0;p<h.data.length;p++){var f=h.data[p].length;u+=f,void 0!==o?f>1&&(d+=Math.abs(f-o),o=f):o=f}h.data.length>0&&(u/=h.data.length),(void 0===r||d<r)&&u>1.99&&(r=d,n=c)}return e.delimiter=n,{successful:!!n,bestDelimiter:n}}(r,e.newline);c.successful?e.delimiter=c.bestDelimiter:(n=!0,e.delimiter=l.DefaultDelimiter),u.meta.delimiter=e.delimiter}var d=S(e);return e.preview&&e.header&&d.preview++,t=r,i=new v(d),u=i.parse(t,o,s),p(),a?{meta:{paused:!0}}:u||{meta:{paused:!1}}},this.paused=function(){return a},this.pause=function(){a=!0,i.abort(),t=t.substr(i.getCharIndex())},this.resume=function(){a=!1,o.streamer.parseChunk(t)},this.aborted=function(){return c},this.abort=function(){c=!0,i.abort(),u.meta.aborted=!0,I(e.complete)&&e.complete(u),t=""}}function v(e){var t=(e=e||{}).delimiter,i=e.newline,n=e.comments,r=e.step,o=e.preview,s=e.fastMode,a=e.quoteChar||'"';if(("string"!=typeof t||l.BAD_DELIMITERS.indexOf(t)>-1)&&(t=","),n===t)throw"Comment character same as delimiter";!0===n?n="#":("string"!=typeof n||l.BAD_DELIMITERS.indexOf(n)>-1)&&(n=!1),"\n"!=i&&"\r"!=i&&"\r\n"!=i&&(i="\n");var c=0,d=!1;this.parse=function(e,l,u){if("string"!=typeof e)throw"Input must be a string";var h=e.length,p=t.length,f=i.length,m=n.length,v=I(r);c=0;var g=[],y=[],_=[],S=0;if(!e)return O();if(s||!1!==s&&-1===e.indexOf(a)){for(var b=e.split(i),C=0;C<b.length;C++){var _=b[C];if(c+=_.length,C!==b.length-1)c+=i.length;else if(u)return O();if(!n||_.substr(0,m)!==n){if(v){if(g=[],k(_.split(t)),A(),d)return O()}else k(_.split(t));if(o&&C>=o)return g=g.slice(0,o),O(!0)}}return O()}for(var D=e.indexOf(t,c),w=e.indexOf(i,c),E=new RegExp(a+a,"g");;)if(e[c]!==a)if(n&&0===_.length&&e.substr(c,m)===n){if(-1===w)return O();c=w+f,w=e.indexOf(i,c),D=e.indexOf(t,c)}else if(-1!==D&&(D<w||-1===w))_.push(e.substring(c,D)),c=D+p,D=e.indexOf(t,c);else{if(-1===w)break;if(_.push(e.substring(c,w)),M(w+f),v&&(A(),d))return O();if(o&&g.length>=o)return O(!0)}else{var x=c;for(c++;;){var x=e.indexOf(a,x+1);if(-1===x)return u||y.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:g.length,index:c}),L();if(x===h-1){var T=e.substring(c,x).replace(E,a);return L(T)}if(e[x+1]!==a){if(e[x+1]===t){_.push(e.substring(c,x).replace(E,a)),c=x+1+p,D=e.indexOf(t,c),w=e.indexOf(i,c);break}if(e.substr(x+1,f)===i){if(_.push(e.substring(c,x).replace(E,a)),M(x+1+f),D=e.indexOf(t,c),v&&(A(),d))return O();if(o&&g.length>=o)return O(!0);break}}else x++}}return L();function k(e){g.push(e),S=c}function L(t){return u?O():(void 0===t&&(t=e.substr(c)),_.push(t),c=h,k(_),v&&A(),O())}function M(t){c=t,k(_),_=[],w=e.indexOf(i,c)}function O(e){return{data:g,errors:y,meta:{delimiter:t,linebreak:i,aborted:d,truncated:!!e,cursor:S+(l||0)}}}function A(){r(O()),g=[],y=[]}},this.abort=function(){d=!0},this.getCharIndex=function(){return c}}function g(e){var t=e.data,i=s[t.workerId],n=!1;if(t.error)i.userError(t.error,t.file);else if(t.results&&t.results.data){var r={abort:function(){n=!0,y(t.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:_,resume:_};if(I(i.userStep)){for(var o=0;o<t.results.data.length&&(i.userStep({data:[t.results.data[o]],errors:t.results.errors,meta:t.results.meta},r),!n);o++);delete t.results}else I(i.userChunk)&&(i.userChunk(t.results,r,t.file),delete t.results)}t.finished&&!n&&y(t.workerId,t.results)}function y(e,t){var i=s[e];I(i.userComplete)&&i.userComplete(t),i.terminate(),delete s[e]}function _(){throw"Not implemented."}function S(e){if("object"!=typeof e)return e;var t=e instanceof Array?[]:{};for(var i in e)t[i]=S(e[i]);return t}function b(e,t){return function(){e.apply(t,arguments)}}function I(e){return"function"==typeof e}return r?i.onmessage=function(e){var t=e.data;if(void 0===l.WORKER_ID&&t&&(l.WORKER_ID=t.workerId),"string"==typeof t.input)i.postMessage({workerId:l.WORKER_ID,results:l.parse(t.input,t.config),finished:!0});else if(i.File&&t.input instanceof File||t.input instanceof Object){var n=l.parse(t.input,t.config);n&&i.postMessage({workerId:l.WORKER_ID,results:n,finished:!0})}}:l.WORKERS_SUPPORTED&&(t=document.getElementsByTagName("script"),e=t.length?t[t.length-1].src:"",document.body?document.addEventListener("DOMContentLoaded",function(){o=!0},!0):o=!0),u.prototype=Object.create(d.prototype),u.prototype.constructor=u,h.prototype=Object.create(d.prototype),h.prototype.constructor=h,p.prototype=Object.create(p.prototype),p.prototype.constructor=p,f.prototype=Object.create(d.prototype),f.prototype.constructor=f,l})?__WEBPACK_AMD_DEFINE_FACTORY__.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__):__WEBPACK_AMD_DEFINE_FACTORY__)||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__),"function"!=typeof nunaliit2&&(nunaliit2=function(){},"undefined"!=typeof window&&(window.nunaliit2=nunaliit2)),void 0===nunaliit2.coreScriptName&&(nunaliit2.coreScriptName="nunaliit2.js"),function(e){e.log=function(e,t){if("object"==typeof window&&window.console&&"function"==typeof window.console.log)try{window.console.log.apply(window.console,arguments)}catch(e){}},e.logError=function(){if("object"==typeof window&&window.console&&"function"==typeof window.console.error)try{window.console.error.apply(window.console,arguments)}catch(e){}else e.log.apply(this,arguments)},"undefined"!=typeof window&&void 0===window.log&&(window.log=e.log);var t=null;"undefined"!=typeof Array&&Array.prototype&&(t=Array.prototype.indexOf);var i=null;"undefined"!=typeof String&&String.prototype&&(i=String.prototype.trim);var n=null;e.ERROR_NO_SUPRESS={};var r={};e.reportError=function(t,i){arguments.length<1||(arguments.length<2&&(i=t),e.logError.apply(null,arguments),t===e.ERROR_NO_SUPRESS?alert(i):r[t]||(r[t]=1,alert(i)))},e.reportErrorForced=function(t){e.reportError(e.ERROR_NO_SUPRESS,t)},e.isDefined=function(e){return void 0!==e&&null!=e},"undefined"!=typeof window&&void 0===window.isDefined&&(window.isDefined=e.isDefined),e.isArray=function(e){return null!==e&&(void 0!==e&&("object"==typeof e&&("number"==typeof e.length&&("function"==typeof e.push&&("function"==typeof e.pop&&("function"==typeof e.concat&&("function"==typeof e.join&&("function"==typeof e.slice&&("function"==typeof e.reverse&&("function"==typeof e.splice&&"function"==typeof e.sort))))))))))},e.inArray=function(e,i,n){var r;if(i){if(t)return t.call(i,e,n);for(r=i.length,n=(n=n||0)<0?Math.max(0,r+n):n;n<r;++n)if(n in i&&i[n]===e)return n}return-1};var o=0;e.getUniqueId=function(e){var t=(e=e||"nunaliit2_uniqueId_")+o;return++o,t},e.getMediaType=function(e,t){var i=null;if(void 0!==t&&null!=t&&""!=t){var n=t.split("/");"image"!==n[0]&&"video"!==n[0]&&"audio"!==n[0]||(i=n[0]),null===i&&"application/ogg"===t&&(i="audio")}if(null===i&&void 0!==e&&null!=e&&""!=e){var r=e.split("."),o=r[r.length-1];"mp3"===o.toLowerCase()?i="audio":"ogg"===o.toLowerCase()?i="audio":"jpg"===o.toLowerCase()?i="image":"png"===o.toLowerCase()?i="image":"jpeg"===o.toLowerCase()?i="image":"bmp"===o.toLowerCase()?i="image":"mov"===o.toLowerCase()&&(i="video")}return i};var s=/^\s*([0-9]{1,2})(°|d|\u00B0)\s*([0-9]{1,2})['m]\s*([0-9]{1,2}(\.[0-9]+)?)["s]\s*([NS])\s*,?\s*([0-9]{1,3})(°|d|\u00B0)\s*([0-9]{1,2})['m]\s*([0-9]{1,2}(\.[0-9]+)?)["s]\s*([WE])\s*$/;e.parseLongLatText=function(e){var t={},i=e.match(s);if(null==i)return null;var n=1;"S"===i[6]&&(n=-1),t.lng=n*(1*i[1]+1*i[3]/60+1*i[4]/3600);var r=1;return"W"===i[12]&&(r=-1),t.lat=r*(1*i[7]+1*i[9]/60+1*i[10]/3600),t},e.generateHyperlinkHTML=function(t,i,n){var r="",o="";""!==(r=e.isArray(n)?function(e){for(var t="",i=0;i<e.length;i++)"".concat(t,e[i]),t=" ";return""}(n):n)&&(o=' class="'+r+'"');var s=i;e.isDefined(s)&&""!==s||(s="");var a=t;e.isDefined(a)&&""!==a||(a=s);return""!==s?"<a"+o+' href="'+s+'" target="_blank">'+a+"</a>":"<div"+o+">"+a+"</div>"},e.extend=function(){var t=arguments[0]||{},i=!1,n=1;"boolean"==typeof t&&(i=t,t=arguments[1]||{},n=2);for(var r=arguments.length;n<r;++n){var o=arguments[n];if(null!=o)for(var s in o){var a=t[s],l=o[s];if(t!==l)if(i&&l&&e.isArray(l)){var c=a&&e.isArray(a)?a:[];t[s]=e.extend(i,c,l)}else if(i&&l&&"object"==typeof l){c="object"==typeof a?a:{};t[s]=e.extend(i,c,l)}else void 0!==l&&(t[s]=l)}}return t},e.deepCopy=function(t){if(null===t)return t;if(void 0===t)return t;if(e.isArray(t)){for(var i=[],n=0,r=t.length;n<r;++n)i[n]=e.deepCopy(t[n]);return i}if("object"==typeof t){i={};for(var n in t)i[n]=e.deepCopy(t[n]);return i}return t},e.loc=function(t,i,n){return e.l10n&&e.l10n.getLocalizedString?e.l10n.getLocalizedString(t,i,n):t};var a=/^[\s\t\x0d\x0a]+/,l=/[\s\t\x0d\x0a]+$/;e.trim=function(e){return null===e?"":i?i.call(e):e.toString().replace(a,"").replace(l,"")},e.utils={_callbacks:{},stringToHtmlId:function(e){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i];if(r>="a"&&r<="z")t.push(r);else if(r>="A"&&r<="Z")t.push(r);else if(r>="0"&&r<="9")t.push(r);else{var o=r.charCodeAt(0),s=48+(7&o),a=48+(o>>3&7),l=48+(o>>6&7);t.push("_"),t.push(String.fromCharCode(l)),t.push(String.fromCharCode(a)),t.push(String.fromCharCode(s))}}return t.join("")},unescapeHtmlId:function(e){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i];if("_"===r){++i;var o=e.charCodeAt(i);++i;var s=e.charCodeAt(i);++i;var a=(o-48<<6)+(s-48<<3)+(e.charCodeAt(i)-48);t.push(String.fromCharCode(a))}else t.push(r)}return t.join("")},getBrowserInfo:function(){if(n)return n;var e,t=[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],i=[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}],r={};return r.browser=o(t)||"An unknown browser",r.version=s(navigator.userAgent)||s(navigator.appVersion)||"an unknown version",r.OS=o(i)||"an unknown OS",n=r,r;function o(t){for(var i=0;i<t.length;i++){var n=t[i].string,r=t[i].prop;if(e=t[i].versionSearch||t[i].identity,n){if(-1!=n.indexOf(t[i].subString))return t[i].identity}else if(r)return t[i].identity}}function s(t){var i=t.indexOf(e);if(-1!=i)return parseFloat(t.substring(i+e.length+1))}},isNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},findJavascriptDeclaration:function(e){for(var t=null,i=null,n=new RegExp("(^|(.*?\\/))"+e+"$"),r=document.getElementsByTagName("script"),o=0;o<r.length;++o){var s=r[o].getAttribute("src");if(s){var a=s.match(n);if(a){t=a[1],i=r[o];break}}}var l=null;return null!=i&&(l={element:i,location:t,name:e}),l},insertJavascriptDeclarations:function(e,t,i){"string"==typeof t&&(t=[t]);for(var n=e.location,r=e.element,o=!1,s=0;s<t.length;++s){var a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("src",n+t[s]),a.onreadystatechange=a.onload=function(){o||(o=!0,"function"==typeof i&&i())},r.parentNode.insertBefore(a,r)}},formatString:function(t,i){return t.replace(/{([^}]+)}/g,function(t,n){return""===(n=e.trim(n))?t:void 0!==i[n]?i[n]:t})},getCurrentTime:Date.now||function(){return+new Date},formatDate:function(e,t){var i=t.replace("%Y",""+e.getFullYear()),n=""+(e.getMonth()+1);n.length<2&&(n="0"+n),i=i.replace("%m",n);var r=""+e.getDate();r.length<2&&(r="0"+r),i=i.replace("%d",r);var o=""+e.getHours();o.length<2&&(o="0"+o),i=i.replace("%H",o);var s=""+e.getMinutes();s.length<2&&(s="0"+s),i=i.replace("%M",s);var a=""+e.getSeconds();return a.length<2&&(a="0"+a),i=i.replace("%S",a)},parseHttpJsonError:function(e,t){if(!JSON||"function"!=typeof JSON.parse)return r();var i=e.responseText;if(!i)return r();var n=JSON.parse(i);return n||r();function r(){return{error:t,reason:t}}},debounce:function(e,t,i){var n=null;return function(){var r=this,o=arguments;i&&!n&&e.apply(r,o),clearTimeout(n),n=setTimeout(function(){n=null,i||e.apply(r,o)},t)}},throttle:function(e,t){var i=void 0,n=void 0,r=function(){var r=this,o=arguments,s=!1;n?Date.now()-n>=t&&(s=!0):s=!0;if(s)e.apply(r,o),n=Date.now();else if(i);else{var a=t-(Date.now()-n);i=setTimeout(function(){e.apply(r,o),n=Date.now(),i=void 0},a)}};return r.setImmediate=function(){n=void 0},r},getElementIdentifier:function(t){var i=$(t),n=i.attr("id");return n||(n=e.getUniqueId(),i.attr("id",n)),n},values:function(e){var t=[];for(var i in e)t[t.length]=e[i];return t},keys:function(e){var t=[];for(var i in e)t[t.length]=i;return t}};var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},d=/[&<>"'`]/g,u=/[&<>"'`]/,h=function(e){return c[e]||""};e.utils.escapeHtml=function(e){return"string"!=typeof e?"":u.test(e)?e.replace(d,h):e}}(nunaliit2),function(e){function t(){var t={};if("undefined"!=typeof document&&document.cookie)for(var i=document.cookie.split(";"),n=0,r=i.length;n<r;++n){var o=i[n].split("=");if(o.length&&o.length>1){var s=decodeURIComponent(e.trim(o[0])),a=decodeURIComponent(e.trim(o[1]));t[s]=a}}return t}e.cookie={getCookies:t,getCookie:function(e){var i=t();return void 0===i[e]?null:i[e]},setCookie:function(t){var i=e.extend({name:null,value:null,end:null,path:null,domain:null,secure:!1},t),n=[escape(i.name),"=",escape(i.value)];if(null!==i.end)switch(typeof i.end){case"number":n.push("; max-age="+i.end);break;case"string":n.push("; expires="+i.end);break;case"object":i.end.hasOwnProperty("toGMTString")&&n.push("; expires="+i.end.toGMTString())}i.domain&&n.push("; domain="+i.domain),i.path&&n.push("; path="+i.path),i.secure&&n.push("; secure"),document.cookie=n.join("")},deleteCookie:function(e){document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:01 GMT;"}}}(nunaliit2),function(e){var t={};function i(e){var t=["http://","https://"];for(var i in t){var n=t[i];if(e.substr(0,n.length)===n)return!0}return!1}function n(e){var t=null;if("object"==typeof document)for(var i=new RegExp("(^|(.*?\\/))"+e+"$"),n=document.getElementsByTagName("script"),r=0;r<n.length;++r){var o=n[r].getAttribute("src");if(o){var s=o.match(i);if(s){t={location:s[1],elem:n[r]};break}}}return t}function r(){var e;if("object"==typeof document){var t=document.getElementsByTagName("script");if(t.length>0){var i=t.item(0);e={location:i.getAttribute("src"),elem:i}}}return e}function o(t){var i=e.extend({url:null,scriptLocation:null,onLoaded:null,onError:null},t),n=i.url,r=i.scriptLocation,o=document.getElementsByTagName("script"),s=o.item(o.length-1);r&&r.elem&&(s=r.elem);var a=document.createElement("script");a.src=n,a.type="text/javascript","function"==typeof a.addEventListener?("function"==typeof i.onLoaded&&a.addEventListener("load",i.onLoaded),"function"==typeof i.onError&&a.addEventListener("error",i.onError)):("function"==typeof i.onLoaded&&(a.onload=i.onLoaded),"function"==typeof i.onError&&(a.onerror=i.onError)),s.parentNode.insertBefore(a,s)}e.scripts={getScriptLocation:n,getCoreScriptLocation:function(){return"string"==typeof e.coreScriptName?n(e.coreScriptName):null},getFirstScriptLocation:r,loadScript:o,loadCustomScripts:function(r){var o=document.getElementsByTagName("script"),s=o.item(o.length-1),a="",l=n("nunaliit_custom.js");if(l&&l.elem&&(s=l.elem,a=l.location),"string"==typeof r&&(r=[r]),e.isArray(r))for(var c=0,d=r.length;c<d;++c){var u=r[c];if("string"==typeof u){var h={url:u,requiredForConfiguration:!0};r[c]=h}}if(e.isArray(r)){var p=[];for(c=0,d=r.length;c<d;++c)(f=(h=e.extend({url:null,requiredForConfiguration:!0},r[c])).url)&&(t[f]||(t[f]=h,h.loaded=!1,p.push(h)));for(c=0,d=p.length;c<d;++c){var f=(h=p[c]).url,m=document.createElement("script");i(f)?m.src=f:m.src=a+f,m.type="text/javascript";var v=g(f);"function"==typeof m.addEventListener?(m.addEventListener("load",v),m.addEventListener("error",v)):(m.onload=v,m.onerror=v),s.parentNode.insertBefore(m,s)}}function g(e){return function(){return function(e){var i=t[e];i&&(i.loaded=!0)}(e),!0}}},areAllCustomScriptsLoaded:function(){var e=!0;for(var i in t){var n=t[i];n.requiredForConfiguration&&!n.loaded&&(e=!1)}return e},loadGoogleMapApi:function(t){var i=e.extend({googleMapApiKey:null,onLoaded:null,onError:null},t),n=!1;if("object"==typeof document)for(var s=document.getElementsByTagName("script"),a=0;a<s.length;++a){var l=s.item(a).getAttribute("src");"string"==typeof l&&(l.indexOf("maps.google.com/maps/api/js")>=0&&(n=!0),l.indexOf("maps.googleapis.com/maps/api/js")>=0&&(n=!0))}if(n)"function"==typeof i.onError&&(i.onError("Google Map API library already installed"),e.logError("Hint: remove Google Map script inclusion from HTML page"));else if("object"==typeof window&&window.google&&window.google.maps)i.onError("Google Map API library already loaded");else{var c=r(),d="https://maps.googleapis.com/maps/api/js";"string"==typeof i.googleMapApiKey&&(d+="?key="+i.googleMapApiKey),o({url:d,scriptLocation:c,onLoaded:i.onLoaded,onError:i.onError})}}}}(nunaliit2),function(e,t){t.css={setCss:function(i){var n=t.extend({css:null,name:null},i);if("string"!=typeof n.css)throw new Error("setCss() must specify css as a string");var r=void 0,o=void 0;(function(){var t=[];return e("head").children("link,style").each(function(){var i=e(this),n=i.prop("tagName");if("STYLE"===n)t.push(i);else if("LINK"===n){var r=i.attr("rel");r||(r="");var o=i.attr("type");o||(o=""),"stylesheet"===r.toLowerCase()&&"text/css"===o.toLowerCase()&&t.push(i)}}),t})().forEach(function(e){o=e;var t=e.attr("n2-name");n.name&&n.name===t&&(r=e)}),r?r.text(n.css):(r=e("<style>").attr("type","text/css").text(n.css),"string"==typeof n.name&&r.attr("n2-name",n.name),o?o.after(r):e("head").append(r))}}}(jQuery,nunaliit2),$n2=nunaliit2,EmptyInit=function(){},$n2.Class=function(){for(var e={},t={},i=null,n=function(){if(this.initialize!==e.initialize)throw new Error('"new" must be called when creating an instance of this class');for(var n in t)null===t[n]?this[n]=t[n]:$n2.isArray(t[n])?this[n]=$n2.extend(!0,[],t[n]):"object"==typeof t[n]?this[n]=$n2.extend(!0,{},t[n]):"function"==typeof t[n]||(this[n]=t[n]);"string"==typeof i&&(this._classname=i),this.initialize.apply(this,arguments)},r=0,o=arguments.length;r<o;++r)if(0===r&&"string"==typeof arguments[r])n._classname=i=arguments[r];else if("function"==typeof arguments[r]){var s=arguments[r].prototype;for(var a in s)"function"==typeof s[a]?e[a]=s[a]:t[a]=s[a];arguments[r]._vars&&$n2.extend(t,arguments[r]._vars)}else{var l=arguments[r];for(var a in l)"function"==typeof l[a]?e[a]=l[a]:t[a]=l[a]}return e.initialize||(e.initialize=EmptyInit),e.getClass=function(){return n},n.prototype=e,n._vars=t,n},function(e){e.Construct=function(){var t={},i={},n=null,r=!1,o=function(t){for(var s in i)null===i[s]?this[s]=i[s]:e.isArray(i[s])?this[s]=e.extend(!0,[],i[s]):"object"==typeof i[s]?this[s]=e.extend(!0,{},i[s]):"function"==typeof i[s]||(this[s]=i[s]);"string"==typeof n&&(this._classname=n),0==r?(this.initialize.apply(this,arguments),o.base(this,"constructor",t)):this.customConstructor.apply(this,arguments)};o.base=function(e,t,i){for(var n=new Array(arguments.length-2),r=2;r<arguments.length;r++)n[r-2]=arguments[r];o.superClass_&&o.superClass_[t].apply(e,n)};for(var s=!0,a=0,l=arguments.length;a<l;++a)if(0===a&&"string"==typeof arguments[a])o._classname=n=arguments[a];else if("function"==typeof arguments[a]){if(!s)throw new Error("multi inheritance not support");s=!1,u.prototype=arguments[a].prototype,o.superClass_=arguments[a].prototype,t=new u,arguments[a]._vars&&e.extend(i,arguments[a]._vars)}else{var c=arguments[a];for(var d in c)"function"==typeof c[d]?(t[d]=c[d],r|="constructor"===d):i[d]=c[d]}return t.initialize||(t.initialize=function(){}),t.getClass=function(){return o},o.prototype=t,o.prototype.customConstructor=t.constructor||function(){},o._vars=i,o.prototype.constructor=o,o;function u(){}}}(nunaliit2),function(e){var t=function(t,i){return e.loc(t,"nunaliit2",i)},i=e.Class({msg:void 0,cause:void 0,conditions:void 0,initialize:function(t){var i=e.extend({msg:void 0,cause:void 0,conditions:void 0},t);if(this.msg=i.msg,this.cause=i.cause,e.isArray(i.conditions))for(var n=0,r=i.conditions.length;n<r;++n){var o=i.conditions[n];this.setCondition(o)}},getMessage:function(){return"string"==typeof this.msg?this.msg:t("<error>")},setCondition:function(e){"string"==typeof e&&(this.conditions||(this.conditions={}),this.conditions[e]=!0)},isConditionSet:function(e){if("string"==typeof e){if(this.conditions&&this.conditions[e])return!0;if(this.cause&&"function"==typeof this.cause.isConditionSet)return this.cause.isConditionSet(e)}return!1},getCause:function(){return this.cause},setCause:function(e){this.cause=e},toString:function(){for(var e=[],i=this;i;)i.msg&&e.push(i.msg),i=i.cause;return e.length<1&&e.push(t("<error>")),e.join(": ")}});e.error={Error:i,fromString:function(e,t){return new i({msg:e,cause:t})},checkErrorCondition:function(e,t){return"object"==typeof e&&"function"==typeof e.isConditionSet&&e.isConditionSet(t)}}}(nunaliit2),function(e){var t=0,i="";function n(e){return s(r(c(e)))}function r(e){return u(h(d(e),8*e.length))}function o(e,t){var i=d(e);i.length>16&&(i=h(i,8*e.length));for(var n=Array(16),r=Array(16),o=0;o<16;o++)n[o]=909522486^i[o],r[o]=1549556828^i[o];var s=h(n.concat(d(t)),512+8*t.length);return u(h(r.concat(s),672))}function s(e){for(var i,n=t?"0123456789ABCDEF":"0123456789abcdef",r="",o=0;o<e.length;o++)i=e.charCodeAt(o),r+=n.charAt(i>>>4&15)+n.charAt(15&i);return r}function a(e){for(var t="",n=e.length,r=0;r<n;r+=3)for(var o=e.charCodeAt(r)<<16|(r+1<n?e.charCodeAt(r+1)<<8:0)|(r+2<n?e.charCodeAt(r+2):0),s=0;s<4;s++)8*r+6*s>8*e.length?t+=i:t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(o>>>6*(3-s)&63);return t}function l(e,t){var i,n,r,o,s=t.length,a=Array(),l=Array(Math.ceil(e.length/2));for(i=0;i<l.length;i++)l[i]=e.charCodeAt(2*i)<<8|e.charCodeAt(2*i+1);for(;l.length>0;){for(o=Array(),r=0,i=0;i<l.length;i++)r=(r<<16)+l[i],r-=(n=Math.floor(r/s))*s,(o.length>0||n>0)&&(o[o.length]=n);a[a.length]=r,l=o}var c="";for(i=a.length-1;i>=0;i--)c+=t.charAt(a[i]);var d=Math.ceil(8*e.length/(Math.log(t.length)/Math.log(2)));for(i=c.length;i<d;i++)c=t[0]+c;return c}function c(e){for(var t,i,n="",r=-1;++r<e.length;)t=e.charCodeAt(r),i=r+1<e.length?e.charCodeAt(r+1):0,55296<=t&&t<=56319&&56320<=i&&i<=57343&&(t=65536+((1023&t)<<10)+(1023&i),r++),t<=127?n+=String.fromCharCode(t):t<=2047?n+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?n+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(n+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return n}function d(e){for(var t=Array(e.length>>2),i=0;i<t.length;i++)t[i]=0;for(i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<24-i%32;return t}function u(e){for(var t="",i=0;i<32*e.length;i+=8)t+=String.fromCharCode(e[i>>5]>>>24-i%32&255);return t}function h(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var i=Array(80),n=1732584193,r=-271733879,o=-1732584194,s=271733878,a=-1009589776,l=0;l<e.length;l+=16){for(var c=n,d=r,u=o,h=s,g=a,y=0;y<80;y++){i[y]=y<16?e[l+y]:v(i[y-3]^i[y-8]^i[y-14]^i[y-16],1);var _=m(m(v(n,5),p(y,r,o,s)),m(m(a,i[y]),f(y)));a=s,s=o,o=v(r,30),r=n,n=_}n=m(n,c),r=m(r,d),o=m(o,u),s=m(s,h),a=m(a,g)}return Array(n,r,o,s,a)}function p(e,t,i,n){return e<20?t&i|~t&n:e<40?t^i^n:e<60?t&i|t&n|i&n:t^i^n}function f(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function m(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function v(e,t){return e<<t|e>>>32-t}e.crypto||(e.crypto={}),e.crypto.hex_sha1=n,e.crypto.b64_sha1=function(e){return a(r(c(e)))},e.crypto.any_sha1=function(e,t){return l(r(c(e)),t)},e.crypto.hex_hmac_sha1=function(e,t){return s(o(c(e),c(t)))},e.crypto.b64_hmac_sha1=function(e,t){return a(o(c(e),c(t)))},e.crypto.any_hmac_sha1=function(e,t,i){return l(o(c(e),c(t)),i)}}(nunaliit2),function(e){var t=null,i=null;var n=e.Class({browserObj:null,initialize:function(e){this.browserObj=e},getKeys:function(){for(var e=[],t=this.browserObj.length,i=0;i<t;++i)e.push(this.browserObj.key(i));return e},getItem:function(e){return this.browserObj.getItem(e)},setItem:function(e,t){this.browserObj.setItem(e,t)},removeItem:function(e){this.browserObj.removeItem(e)},clear:function(){this.browserObj.clear()}}),r=e.Class({store:null,initialize:function(){this.store={}},getKeys:function(){var e=[];for(var t in this.store)e.push(t);return e},getItem:function(e){return this.store[e]?this.store[e]:null},setItem:function(e,t){this.store[e]=t},removeItem:function(e){delete this.store[e]},clear:function(){this.store={}}});e.storage={getSessionStorage:function(){return t||(t=window.sessionStorage?new n(window.sessionStorage):new r),t},getLocalStorage:function(){return i||(i=window.localStorage?new n(window.localStorage):new r),i},Storage:n}}(nunaliit2),function(e){var t=function(t,i){return e.loc(t,"nunaliit2-couch",i)},i="n2.indexedDb",n="docs",r="info",o=e.Class("DocumentCache",{db:null,dispatchService:null,id:null,changes:null,changesByDocId:null,initialize:function(t){var i=e.extend({db:null,dispatchService:null},t);this.db=i.db,this.dispatchService=i.dispatchService,this.id=e.getUniqueId(),this.changes=null,this.changesByDocId={}},initializeCache:function(t){var i=e.extend({dbName:null,updateSequence:null,onSuccess:function(){},onError:function(e){}},t),n=this,r=i.dbName;if("string"!=typeof r)throw new Error("When initializing document cache, dd name must be a string");var o=i.updateSequence;if("string"!=typeof o)throw new Error("When initializing document cache, update sequence must be a number");this.clearCache({onSuccess:function(){n._writeUpdateSequence({dbName:r,updateSequence:o,onSuccess:function(){n.changes=null,n.changesByDocId={},i.onSuccess()},onError:function(t){e.log("Error while recording initial sequence number. "+t),i.onError(t)}})},onError:function(t){e.log("Error while clearing document store. "+t),i.onError(t)}})},getUpdateSequence:function(t){var i,n=e.extend({dbName:null,onSuccess:function(e){},onError:function(e){}},t);this.db;if("string"!=typeof n.dbName)throw new Error('DocumentCache.getUpdateSequence() must have a string attribute for "dbName"');this.changes&&this.changes.forEach(function(e){e&&e.updateSequence&&e.dbName===n.dbName&&(i=e.updateSequence)}),i?n.onSuccess(i):this._readUpdateSequence({dbName:n.dbName,onSuccess:n.onSuccess,onError:n.onError})},performChanges:function(n){var r=this;this.db;n.forEach(function(e){if("object"!=typeof e)throw new Error("A cache change must be an object");if("string"!=typeof e.dbName)throw new Error('A cache change must have a string "dbName" attribute');if(e.updateSequence,e.doc){var t={};for(var i in e.doc)i.length>=2&&"_"===i[0]&&"_"===i[1]||(t[i]=e.doc[i]);e.doc=t}"string"==typeof e.id&&"string"==typeof e.dbName&&(e.id=e.dbName+"|"+e.id,delete e.dbName)});var o=!0;this.changes?o=!1:(this.changes=[],this.changesByDocId={}),n.forEach(function(e){if(r.changes.push(e),e.id){var t=r.changesByDocId[e.id];if(t){var i=r._getNumberFromRevision(t.rev),n=r._getNumberFromRevision(e.rev);n>i?r.changesByDocId[e.id]=e:n===i&&r._mergeChanges(t,e)}else r.changesByDocId[e.id]=e}}),o&&setTimeout(function n(){r.dispatchService&&r.dispatchService.send(i,{type:"waitReport",requester:r.id,name:"cacheDocuments",label:t("Caching documents"),count:r.changes.length});if(r.changes.length<=0)r.changes=null;else{var o=r.changes.shift();if(o.updateSequence)r._writeUpdateSequence({dbName:o.dbName,updateSequence:o.updateSequence,onSuccess:n,onError:n});else if(o.id){var s=r.changesByDocId[o.id];s&&o.id===s.id&&o.rev===s.rev?(delete r.changesByDocId[o.id],r._getCacheEntry({id:s.id,onSuccess:function(e){if(e){var t=r._getNumberFromRevision(e.rev),i=r._getNumberFromRevision(s.rev);t>i?n():t<i?r._storeCacheEntry({cacheEntry:s,onSuccess:n,onError:n}):(r._mergeChanges(e,s),r._storeCacheEntry({cacheEntry:e,onSuccess:n,onError:n}))}else r._storeCacheEntry({cacheEntry:s,onSuccess:n,onError:n})}})):n()}else e.logError("Unrecognized change to document cache",o),n()}},0)},getDocument:function(t){var i=e.extend({dbName:null,docId:null,onSuccess:function(e){},onError:function(e){}},t),n=this,r=i.dbName;if("string"!=typeof r)throw new Error("DocumentCache.getDocument() must have dbName specified as a string attribute");var o=i.docId;if("string"!=typeof o)throw new Error("DocumentCache.getDocument() must have docId specified as a string attribute");var s,a=r+"|"+o;this.changesByDocId&&this.changesByDocId[a]&&(s=this.changesByDocId[a]),this._getCacheEntry({id:a,onSuccess:function(e){if(e&&s){var t=n._getNumberFromRevision(e.rev),r=n._getNumberFromRevision(s.rev);t>r||(t<r?e=s:n._mergeChanges(e,s))}e&&e.doc?i.onSuccess(e.doc):i.onSuccess(void 0)},onError:i.onError})},getDocuments:function(t){var i=e.extend({dbName:null,docIds:null,onSuccess:function(e){},onError:function(e){}},t),n=this,r=i.dbName;if("string"!=typeof r)throw new Error("DocumentCache.getDocuments() must have dbName specified as a string attribute");var o=[],s=i.docIds.slice(),a=0;!function e(){if(a>=s.length)i.onSuccess(o);else{var t=s[a];++a,n.getDocument({dbName:r,docId:t,onSuccess:function(t){t&&o.push(t),e()},onError:e})}}()},getAttachment:function(t){var i=e.extend({dbName:null,docId:null,attName:null,onSuccess:function(e,t){},onError:function(e){}},t),n=this,r=i.dbName;if("string"!=typeof r)throw new Error("DocumentCache.getAttachment() must have dbName specified as a string attribute");var o=i.docId;if("string"!=typeof o)throw new Error("DocumentCache.getAttachment() must have docId specified as a string attribute");var s=i.attName;if("string"!=typeof s)throw new Error("DocumentCache.getAttachment() must have attName specified as a string attribute");var a,l=r+"|"+o;this.changesByDocId&&this.changesByDocId[l]&&(a=this.changesByDocId[l]),this._getCacheEntry({id:l,onSuccess:function(e){if(e&&a){var t=n._getNumberFromRevision(e.rev),r=n._getNumberFromRevision(a.rev);t>r||(t<r?e=a:n._mergeChanges(e,a))}if(e)if(e.attachments){var o=e.attachments[s];i.onSuccess(o,e.rev)}else i.onSuccess(void 0);else i.onSuccess(void 0)},onError:i.onError})},clearCache:function(t){var i=e.extend({onSuccess:function(){},onError:function(e){}},t),n=this;this._clearDocumentStore({onSuccess:function(){n._clearInfoStore({onSuccess:i.onSuccess,onError:i.onError})},onError:i.onError})},_clearDocumentStore:function(t){var i=e.extend({onSuccess:function(){},onError:function(e){}},t),r=this.db.transaction(n,"readwrite").objectStore(n).clear();r.onsuccess=i.onSuccess,r.onerror=function(t){var n=this.error;e.log("Unable to clear indexedDb document store",n),i.onError(n)}},_clearInfoStore:function(t){var i=e.extend({onSuccess:function(){},onError:function(e){}},t),n=this.db.transaction(r,"readwrite").objectStore(r).clear();n.onsuccess=i.onSuccess,n.onerror=function(t){var n=this.error;e.log("Unable to clear indexedDb info store",n),i.onError(n)}},_storeCacheEntry:function(t){var i=e.extend({cacheEntry:null,onSuccess:function(){},onError:function(e){}},t),r=(this.db,i.cacheEntry),o=this.db.transaction(n,"readwrite").objectStore(n).put(r);o.onsuccess=function(e){i.onSuccess()},o.onerror=function(){i.onError(this.error)}},_getCacheEntry:function(t){var i=e.extend({id:null,onSuccess:function(e){},onError:function(e){}},t),r=this.db,o=i.id,s=r.transaction(n,"readonly").objectStore(n).get(o);s.onsuccess=function(e){var t=this.result;i.onSuccess(t)},s.onerror=function(e){i.onError(this.error)}},_readUpdateSequence:function(t){var i=e.extend({dbName:null,onSuccess:function(e){},onError:function(e){}},t),n=this.db;if("string"!=typeof i.dbName)throw new Error("dbName must be a string");var o=n.transaction(r,"readonly").objectStore(r).get(i.dbName+"|sequenceNumber");o.onsuccess=function(t){var n=this.result;if("object"==typeof n&&"string"==typeof n.updateSequence)i.onSuccess(n.updateSequence);else if("object"==typeof n&&"number"==typeof n.updateSequence)i.onSuccess(""+n.updateSequence);else if(void 0===n)i.onSuccess(void 0);else{var r=e.error.fromString("Invalid format for indexedDb sequence number");i.onError(r)}},o.onerror=function(e){i.onError(this.error)}},_writeUpdateSequence:function(t){var i=e.extend({dbName:null,updateSequence:null,onSuccess:function(){},onError:function(e){}},t),n=this.db;if("string"!=typeof i.dbName)throw new Error("dbName must be a string");if("string"!=typeof i.updateSequence)throw new Error("updateSequence must be a string");var o=n.transaction(r,"readwrite").objectStore(r).put({_id:i.dbName+"|sequenceNumber",updateSequence:i.updateSequence});o.onsuccess=i.onSuccess,o.onerror=function(e){i.onError(this.error)}},_getNumberFromRevision:function(e){return 1*e.split("-")[0]},_mergeChanges:function(e,t){if("object"!=typeof e)throw new Error("DocumentCache._mergeChanges() targetChange must be an object");if("object"!=typeof t)throw new Error("DocumentCache._mergeChanges() change must be an object");if("string"!=typeof e.id)throw new Error("DocumentCache._mergeChanges() targetChange.id must be a string");if(e.id!==t.id)throw new Error("DocumentCache._mergeChanges() targetChange.id and change.id must be the same");if("string"!=typeof e.rev)throw new Error("DocumentCache._mergeChanges() targetChange.rev must be a string");if(e.rev!==t.rev)throw new Error("DocumentCache._mergeChanges() targetChange.rev and change.rev must be the same");if(e.deleted);else if(t.deleted)e.deleted=!0,delete e.doc,delete e.attachments;else if(t.doc&&(e.doc=t.doc),t.attachments)for(var i in e.attachments||(e.attachments={}),t.attachments)e.attachments[i]=t.attachments[i]}}),s=e.Class("IndexedDbService",{db:null,documentCache:null,initialize:function(t){var i=e.extend({db:null,dispatchService:null},t);this.db=i.db,this.documentCache=new o({db:this.db,dispatchService:i.dispatchService})},getDocumentCache:function(){return this.documentCache}}),a="nunaliit",l=4;e.indexedDb={openIndexedDb:function(t){var i=e.extend({dispatchService:null,onSuccess:function(e){},onError:function(e){}},t);"object"!=typeof indexedDB&&i.onError(new Error("IndexedDB not available in this browser"));var o=indexedDB.open(a,l);o.onsuccess=function(e){var t=this.result,n=new s({db:t,dispatchService:i.dispatchService});i.onSuccess(n)},o.onerror=function(t){e.log("openDb:",t.target.errorCode),i.onError(this.error)},o.onupgradeneeded=function(t){var i=this.result,o=void 0,s=void 0;t&&t.currentTarget&&(s=t.newVersion,o=t.oldVersion),e.log("Upgrading indexDB "+a+" from: "+o+" to: "+s),o<1?i.createObjectStore(n,{keyPath:"id"}):o<4&&(i.deleteObjectStore(n),i.createObjectStore(n,{keyPath:"id"})),o<2&&i.createObjectStore(r,{keyPath:"_id"})}}}}(nunaliit2),function(e){var t=e.Class({initialize:function(t){e.extend({},t)},loadConfiguration:function(){var t=e.storage.getLocalStorage().getItem("n2debug_configuration"),i=void 0;if(t)try{i=JSON.parse(t)}catch(t){e.log("Unable to parse Debug configuration:"+t)}return i||(i={}),i},saveConfiguration:function(t){var i=e.storage.getLocalStorage(),n=JSON.stringify(t);i.setItem("n2debug_configuration",n)},deleteConfiguration:function(){e.storage.getLocalStorage().removeItem("n2debug_configuration")},isBadProxyEnabled:function(){return!!this.loadConfiguration().badProxy},setBadProxyEnabled:function(e){var t=this.loadConfiguration();e?t.badProxy=!0:t.badProxy&&delete t.badProxy,this.saveConfiguration(t)},isEventLoggingEnabled:function(){return!!this.loadConfiguration().logging},setEventLoggingEnabled:function(e){var t=this.loadConfiguration();e?t.logging=!0:t.logging&&delete t.logging,this.saveConfiguration(t)},isCouchDbCachingEnabled:function(){return!!this.loadConfiguration().couchDbCaching},setCouchDbCachingEnabled:function(e){var t=this.loadConfiguration();e?t.couchDbCaching=!0:t.couchDbCaching&&delete t.couchDbCaching,this.saveConfiguration(t)},isCouchDbCachingDisabled:function(){return!!this.loadConfiguration().disableCouchDbCaching},setCouchDbCachingDisabled:function(e){var t=this.loadConfiguration();e?t.disableCouchDbCaching=!0:t.disableCouchDbCaching&&delete t.disableCouchDbCaching,this.saveConfiguration(t)},forceSlowConnectionHandling:function(){return!!this.loadConfiguration().forceSlowConnectionHandling},setForceSlowConnectionHandling:function(e){var t=this.loadConfiguration();e?t.forceSlowConnectionHandling=!0:t.forceSlowConnectionHandling&&delete t.forceSlowConnectionHandling,this.saveConfiguration(t)}});e.debug={DebugConfiguration:t,setBadProxy:function(e){(new t).setBadProxyEnabled(e)}}}(nunaliit2),function(e){var t=e.Class({url:null,initialize:function(t){var i=e.extend({url:null},t);this.url=i.url},clone:function(){return new t({url:this.url})},getUrl:function(){return this.url},getUrlWithoutHash:function(){var e=this.getUrl(),t=e.indexOf("#");return t>=0&&(e=e.substr(0,t)),e},getHash:function(){var e=void 0,t=this.getUrl(),i=t.indexOf("#");return i>=0&&(e=t.substr(i+1)),e},setHash:function(e){var t=this.getUrl(),i=t.indexOf("#");return i>=0?this.url=e?t.substr(0,i+1)+e:t.substr(0,i):e&&(this.url=t+"#"+e),this},getUrlWithoutParams:function(){var e=this.getUrlWithoutHash(),t=e.indexOf("?");return t>=0&&(e=e.substr(0,t)),e},getParams:function(){var e={},t=this.getUrlWithoutHash(),i=t.indexOf("?");if(i>=0)for(var n=t.slice(i+1).split("&"),r=0;r<n.length;++r){var o=n[r].split("="),s=decodeURIComponent(o[0]),a=decodeURIComponent(o[1]);null==e[s]&&(e[s]=[]),e[s].push(a)}return e},getParam:function(e){var t=this.getParams();return null==t[e]?[]:t[e]},getParamValue:function(e,t){var i=this.getParams();return null==i[e]?t:i[e][0]},setParamValue:function(e,t){var i=this.getHash(),n=this.getUrlWithoutParams(),r=this.getParams();return r[e]=[t],this._setUrlFromComponents(n,r,i),this},_setUrlFromComponents:function(e,t,i){var n=[e];if(t){var r=!0;for(var o in t)for(var s=t[o],a=0,l=s.length;a<l;++a){var c=s[a];r?(r=!1,n.push("?")):n.push("&"),n.push(encodeURIComponent(o)),n.push("="),n.push(encodeURIComponent(c))}}return i&&(n.push("#"),n.push(i)),this.url=n.join(""),this}});e.url={Url:t,getCurrentLocation:function(){return"object"==typeof window&&window.location&&window.location.href?new t({url:window.location.href}):null},getUrlWithoutHash:function(){var t=e.url.getCurrentLocation();return t?t.getUrlWithoutHash():null},getUrlWithoutParams:function(){var t=e.url.getCurrentLocation();return t?t.getUrlWithoutParams():null},getParams:function(){var t=e.url.getCurrentLocation();return t?t.getParams():{}},getParam:function(t){var i=e.url.getCurrentLocation();return i?i.getParam(t):null},getParamValue:function(t,i){var n=e.url.getCurrentLocation();return n?n.getParamValue(t,i):i}}}(nunaliit2),function(e){function t(t){if(!e.isArray(t))throw"In CSV conversion, values must be given in the form of an array";for(var i=[],n=0,r=t.length;n<r;++n){var o=t[n];"string"==typeof o?(o=o.replace(/"/g,'""'),i.push('"'+o+'"')):void 0===o?i.push(""):i.push(""+o)}return i.join(",")}e.csv={ComputeCsvLine:t,ValueTableToCsvString:function(i){var n=!0;if(e.isArray(i))for(var r=0,o=i.length;r<o;++r){var s=i[r];if(!e.isArray(s)){n=!1;break}}else n=!1;if(!n)throw"In CSV conversion, a table must be given in the form of an array of arrays of values";var a=[];for(r=0,o=i.length;r<o;++r){var l=t(s=i[r]);a.push(l)}return a.join("\n")},Parse:function(t){var i=e.extend({csv:void 0},t);if("string"!=typeof i.csv)throw new Error('When parsing CSV, parameter "csv" must be a string');var n=Papa.parse(i.csv,{header:!0,skipEmptyLines:!0});if(n.errors&&n.errors.length>0){var r=n.errors[0],o="Row "+r.row+": "+r.message;throw new Error(o)}return n.data}}}(nunaliit2),function(e,t){var i=nunaliit2.utils.getBrowserInfo();i&&"Explorer"===i.browser&&"number"==typeof i.version&&i.version<9&&(e.ajaxSetup&&e.ajaxSetup({cache:!1}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length>>>0,i=Number(arguments[1])||0;for((i=i<0?Math.ceil(i):Math.floor(i))<0&&(i+=t);i<t;++i)if(i in this&&this[i]===e)return i;return-1})),"function"==typeof e.widget&&e.widget("nunaliit.menuselector",{options:{menuClass:null},_create:function(){var t=this;this.wrapper=e("<span>").addClass("nunaliit-menuselector").insertAfter(this.element);var i=this.element.attr("class"),n=this.element.find("option").first().text();this.button=e("<select>").appendTo(this.wrapper).mousedown(function(e){return t._toggleMenu(),!1}),i&&this.button.attr("class",i),e("<option>").text(n).appendTo(this.button),this.menu=e("<div>").addClass("nunaliit-menuselector").css("position","absolute").css("left","0px").css("top","0px").css("display","block").css("z-index",1e3).hide().appendTo(this.wrapper),this.element.hide()},_createMenu:function(t){var i=this,n=e("<ul>").appendTo(t).addClass("nunaliit-menuselector-menu");this.options.menuClass&&n.addClass(this.options.menuClass),this.element.find("option").each(function(){var t=e(this),r=t.val();if(r){var o=e("<li>").appendTo(n);e("<a>").appendTo(o).attr("href","#").text(t.text()).click(function(e){return function(){return i._click(e),!1}}(r))}}),n.menu()},_toggleMenu:function(){var e=this.wrapper.children("div");e.is(":visible")?(e.empty(),e.hide()):(this._createMenu(e),e.show(),e.position({my:"left top",at:"left bottom",of:this.button}))},_click:function(e){this._toggleMenu(),this.element.val(e),this.element.trigger("change")},_destroy:function(){this.wrapper.remove(),this.element.show()}})}(jQuery),function(e){e.l10n||(e.l10n={}),e.l10n.strings||(e.l10n.strings={}),e.l10n.strings.en||(e.l10n.strings.en={});var t=/^([a-z][a-z])-([a-zA-Z][a-zA-Z])$/,i=/^([a-z][a-z])$/,n=e.l10n.strings,r=null,o={};function s(){if(r)return r;var n;null==r&&e.cookie&&((n=e.cookie.getCookie("nunaliit-l10n"))&&(r=o(n)));null==r&&e.url&&((n=e.url.getParamValue("lang",null))&&(r=o(n)));return null==r&&"object"==typeof navigator&&(navigator.language?r=o(navigator.language):navigator.browserLanguage?r=o(navigator.browserLanguage):navigator.systemLanguage?r=o(navigator.systemLanguage):navigator.userLanguage&&(r=o(navigator.userLanguage))),null==r&&(r=o("en-US")),r;function o(n){if(null==n)return null;var r=n.match(t);if(r)return{locale:n,lang:r[1],country:r[2]};var o=n.match(i);return o?{locale:n,lang:o[1],country:null}:(e.log("Locale specified, but not in xx-YY format. Ignored.",n),null)}}function a(e){var t=n[e];return t||(t={},n[e]=t),t}function l(e,t){var i={str:null,lang:null,fallback:!1};if("string"==typeof e)i.str=e;else if("object"==typeof e&&"localized"===e.nunaliit_type)if("string"==typeof e[t])i.str=e[t],i.lang=t;else if("string"==typeof e.en)i.str=e.en,i.lang=t,i.fallback=!0;else for(var n in e)if("nunaliit_type"!==n){i.str=e[n],i.lang=n,i.fallback=!0;break}return i}function c(t,i,n){var r=function(e){var t=o[e];return t||(t={},o[e]=t),t}(i),s=r[t];s||(s={lang:i,str:t,packageName:n},r[t]=s,e.l10n.sendTranslationRequest&&e.l10n.sendTranslationRequest(s))}if(e.l10n.getLocale=s,e.l10n.getLocalizedString=function(t,i,n){var r=!1;if(null===t)return t;if(void 0===t)return t;var o=s().lang,l=t,d="en";if("localized"===t.nunaliit_type)if(r=!0,l=null,"string"==typeof t[o])l=t[o],d=o;else if("string"==typeof t.en)l=t.en,d=o;else for(var u in t)if("nunaliit_type"===u);else if("string"==typeof t[u]){l=t[u],d=u;break}var h=a(o),p=h[l];return p||(p=l,d!==o&&(r||c(l,o,i),h[l]=p)),n?e.utils.formatString(p,n):p},e.l10n.getStringForLang=l,e.l10n.getStringForLocale=function(e){return l(e,s().lang)},e.l10n.requestTranslation=c,e.l10n.translationRequests=o,e.l10n.lookupDictionaryTranslation=function(t,i,n){var r=s().lang,o=a(r)[t];return o||("en"!==r?c(t,r,i):o=t),o&&n?e.utils.formatString(o,n):o},e.l10n.addLocalizedString=function(t,i,n){a(i)[t]=n,e.l10n.refreshLocalizedStrings()},e.l10n.addLocalizedStrings=function(t,i){var n=a(t);for(var r in i){var o=i[r];"string"==typeof o&&o&&(n[r]=o)}e.l10n.refreshLocalizedStrings()},e.l10n.refreshLocalizedStrings=function(){"undefined"!=typeof jQuery&&jQuery("body").find(".n2s_waiting_for_localization").each(function(){var t=$(this),i=t.text(),n=e.l10n.lookupDictionaryTranslation(i,"nunaliit2");"string"==typeof n&&(t.text(n),t.removeClass("n2s_waiting_for_localization"))})},e.scripts){var d=s(),u=e.scripts.getCoreScriptLocation();if(u){if("en"!==d.lang){var h=u.location+"nunaliit2."+d.lang+".js";e.scripts.loadScript({url:h,scriptLocation:u})}var p=u.location+"../nunaliit_lang."+d.lang+".js";e.scripts.loadScript({url:p,scriptLocation:u})}"undefined"!=typeof jQuery&&jQuery("body").addClass("nunaliit_language_"+d.lang)}}(nunaliit2),function(e){var t=function(t,i){return e.loc(t,"nunaliit2",i)},i=e.Class({min:null,max:null,initialize:function(i){var n=e.extend({min:null,max:null},i);if("number"!=typeof n.min)throw t("Interval min must be a number");if("number"!=typeof n.max)throw t("Interval max must be a number");if(n.min>n.max)throw t("Interval min can not be greater than max");this.min=n.min,this.max=n.max},size:function(){return this.max-this.min},equals:function(e){return!!e&&("number"==typeof e.min&&("number"==typeof e.max&&(this.min===e.min&&this.max===e.max)))},isIncludedIn:function(e){return!!e&&("number"==typeof e.min&&("number"==typeof e.max&&(this.min>=e.min&&this.max<=e.max)))},extendTo:function(e){var t=this.min,i=this.max;return e&&(t>e.min&&(t=e.min),i<e.max&&(i=e.max)),new(this.getClass())({min:t,max:i})},intersectsWith:function(e){return!!e&&(!(this.min>e.max)&&!(this.max<e.min))},intersection:function(e){if(!this.intersectsWith(e))return null;var t=this.min,i=this.max;return t<e.min&&(t=e.min),i>e.max&&(i=e.max),new(this.getClass())({min:t,max:i})}});e.Interval=i,e.interval={Interval:i}}(nunaliit2),function(e){var t=function(t,i){return e.loc(t,"nunaliit2",i)},i=e.Class({dateStr:null,min:null,max:null,ongoing:null,initialize:function(i){var n=e.extend({dateStr:null,min:null,max:null,ongoing:!1,now:null},i);if(this.ongoing=n.ongoing,this.dateStr=i.dateStr,"number"!=typeof n.min)throw t("Interval min must be a number");if(this.min=n.min,this.ongoing){if(this.max=this.min,n.now&&this.min>n.now)throw t("Ongoing time interval must begin before now")}else{if("number"!=typeof n.max)throw t("Interval max must be a number");if(n.min>n.max)throw t("Interval min can not be greater than max");this.max=n.max}},getMin:function(){return this.min},getMax:function(e){return this.ongoing?e:this.max},getDateString:function(){return this.dateStr},getDocumentStructure:function(){var e={nunaliit_type:"date",date:this.dateStr,min:this.min};return this.ongoing?e.ongoing=!0:e.max=this.max,e},size:function(e){return this.getMax(e)-this.min},equals:function(e){if(!e)return!1;if("number"!=typeof e.min)return!1;var t=!1;if("boolean"==typeof e.ongoing&&(t=e.ongoing),!t&&"number"!=typeof e.max)return!1;if(this.ongoing!==t)return!1;if(this.ongoing){if(this.min===e.min)return!0}else if(this.min===e.min&&this.max===e.max)return!0;return!1},isIncludedIn:function(e,t){return!!e&&(this.getMin()>=e.getMin()&&this.getMax(t)<=e.getMax(t))},extendTo:function(e,t){if(!e)return this;if(t);else if(this.ongoing!==e.ongoing)throw"Can not extend ongoing and regular date intervals";if(this.ongoing&&e.ongoing)return this.min>e.min?new i({ongoing:!0,min:e.min}):this;var n=!1,r=this.min,o=e.min,s=this.getMax(t),a=e.getMax(t);r>o&&(r=o,n=!0);var l=!1;return s<a?(s=a,n=!0,e.ongoing&&(l=!0)):this.ongoing&&(l=!0),n?new i(l?{ongoing:!0,min:r}:{ongoing:!1,min:r,max:s}):this},intersectsWith:function(e,t){return!!e&&(!(this.getMin()>e.getMax(t))&&!(this.getMax(t)<e.getMin()))},intersection:function(e,t){if(!this.intersectsWith(e,t))return null;if(this.ongoing&&e.ongoing)return this.min>=e.min?this:new i({ongoing:!0,min:e.min});var n=this.getMin(),r=this.getMax(t);return n<e.getMin()&&(n=e.getMin()),r>e.getMax(t)&&(r=e.getMax(t)),new i({ongoing:!1,min:n,max:r})},save:function(){var e=null;return e=this.ongoing?{ongoing:!0,min:this.min}:{min:this.min,max:this.max},this.dateStr&&(e.dateStr=this.dateStr),e}}),n=/(^|[^a-zA-Z0-9])(\d\d\d\d)/,r=/^-(\d\d)-(\d\d)/,o=/^(\d\d)(\d\d)/,s=/^-?(\d\d)/,a=/^( +|T)(\d\d):(\d\d)(:(\d\d))?/,l=/^( +|T)(\d\d)(\d\d)(\d\d)?/,c=/^([^a-zA-Z0-9]|$)/;function d(e,t){var d=void 0,u=(t=t||0)>0?e.substr(t):e,p=n.exec(u);if(p){var f=!1;d={input:e,index:p.index+t+p[1].length,year:1*p[2]},t=t+p.index+p[1].length+p[2].length;u=e.substr(t);var m=r.exec(u);if(m){if(d.month=1*m[1],d.day=1*m[2],d.month<1||d.month>12||d.day<1||d.day>31)return h(e,t);t+=m[0].length,u=e.substr(t),f=!0}else{var v=o.exec(u);if(v){if(d.month=1*v[1],d.day=1*v[2],d.month<1||d.month>12||d.day<1||d.day>31)return h(e,t);t+=v[0].length,u=e.substr(t),f=!0}else{var g=s.exec(u);if(g){if(d.month=1*g[1],d.month<1||d.month>12)return h(e,t);t+=g[0].length,u=e.substr(t)}}}if(f){var y=function(e,t){var i=void 0,n=(t=t||0)>0?e.substr(t):e,r=a.exec(n),o=l.exec(n);if(r){if(i={index:t,hours:1*r[2],minutes:1*r[3]},void 0!==r[5]&&(i.seconds=1*r[5]),i.hours>23||i.minutes>59||void 0!==i.seconds&&i.seconds>59)return;t+=r[0].length}else{if(!o)return i;if(i={index:t,hours:1*o[2],minutes:1*o[3]},void 0!==o[4]&&(i.seconds=1*o[4]),i.hours>23||i.minutes>59||void 0!==i.seconds&&i.seconds>59)return;t+=o[0].length}var s=t-i.index;i.str=e.substr(i.index,s),n=e.substr(t),c.exec(n)||(i=void 0);return i}(u);y&&(d.hours=y.hours,d.minutes=y.minutes,d.seconds=y.seconds,t+=y.index+y.str.length,u=e.substr(t))}if(!c.exec(u))return h(e,t);var _=t-d.index;if(d.str=e.substr(d.index,_),u=e.substr(t),void 0!==d.seconds){var S=new Date(d.year,d.month-1,d.day,d.hours,d.minutes,d.seconds).getTime(),b=new Date(d.year,d.month-1,d.day,d.hours,d.minutes,d.seconds+1).getTime();d.interval=new i({min:S,max:b-1e3,dateStr:d.str})}else if(void 0!==d.minutes){S=new Date(d.year,d.month-1,d.day,d.hours,d.minutes).getTime(),b=new Date(d.year,d.month-1,d.day,d.hours,d.minutes+1).getTime();d.interval=new i({min:S,max:b-1e3,dateStr:d.str})}else if(void 0!==d.hours){S=new Date(d.year,d.month-1,d.day,d.hours).getTime(),b=new Date(d.year,d.month-1,d.day,d.hours+1).getTime();d.interval=new i({min:S,max:b-1e3,dateStr:d.str})}else if(void 0!==d.day){S=new Date(d.year,d.month-1,d.day).getTime(),b=new Date(d.year,d.month-1,d.day+1).getTime();d.interval=new i({min:S,max:b-1e3,dateStr:d.str})}else if(void 0!==d.month){S=new Date(d.year,d.month-1,1).getTime(),b=new Date(d.year,d.month,1).getTime();d.interval=new i({min:S,max:b-1e3,dateStr:d.str})}else{S=new Date(d.year,0,1).getTime(),b=new Date(d.year+1,0,1).getTime();d.interval=new i({min:S,max:b-1e3,dateStr:d.str})}}return d}var u=/^\s*\/\s*/;function h(e,t){var n=d(e,t);if(n){t=n.index+n.str.length;var r=e.substr(t),o=u.exec(r);if(o)if("-"===e[t+=o[0].length]){var s=++t-n.index;n.str=e.substr(n.index,s),n.interval=new i({ongoing:!0,min:n.interval.min,dateStr:n.str}),void 0!==n.year&&delete n.year,void 0!==n.month&&delete n.month,void 0!==n.day&&delete n.day,void 0!==n.hours&&delete n.hours,void 0!==n.minutes&&delete n.minutes,void 0!==n.seconds&&delete n.seconds}else{var a=d(e,t);a&&a.index==t&&(n.str=e.substr(n.index,a.index+a.str.length-n.index),n.interval=n.interval.extendTo(a.interval),n.interval.dateStr=n.str,void 0!==n.year&&delete n.year,void 0!==n.month&&delete n.month,void 0!==n.day&&delete n.day,void 0!==n.hours&&delete n.hours,void 0!==n.minutes&&delete n.minutes,void 0!==n.seconds&&delete n.seconds)}}return n}function p(i){var n=null,r=e.trim(i),o=h(r,0);if(o&&r===o.str&&(n=o.interval),null==n)throw t("Can not parse date: {date}",{date:i});return n}e.date={DateInterval:i,parseUserDate:p,parseDateStructure:function(e){if(!e||"string"!=typeof e.date)throw t("Invalid date structure");return p(e.date)},findDateString:h,findAllDateStrings:function(e){for(var t=[],i=h(e);i;)t.push(i),i=h(e,i.index+i.str.length);return t}}}(nunaliit2),function(e,t){var i=t.Class({url:null,initialize:function(e){var i=t.extend({url:null},e);this.url=i.url},getDocIdsFromInterval:function(i){var n=t.extend({interval:null,onSuccess:function(e){},onError:function(e){}},i),r=null;if(n.interval&&"number"==typeof n.interval.min){var o=!1,s=r=n.interval.min;if("boolean"==typeof n.interval.ongoing&&(o=n.interval.ongoing),!o){if("number"!=typeof n.interval.max)return void n.onError("Interval must contain ongoing or max");s=n.interval.max}var a={min:r};o?a.ongoing=!0:a.max=s,e.ajax({url:this.url+"docIdsFromInterval",type:"get",async:!0,data:a,dataType:"json",success:function(e){e.docIds?n.onSuccess(e.docIds):n.onError("Malformed response for doc ids from interval("+r+","+s+")")},error:function(e,i,o){var a=t.utils.parseHttpJsonError(e,i).error;n.onError("Error obtaining doc ids from interval("+r+","+s+"): "+a)}})}else n.onError("Interval must be supplied")}});t.dateService={DateService:i}}(jQuery,nunaliit2),codex="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",nunaliit2.Base64={encode:function(e){for(var t=[],i=0;i<e.length;){var n=e.charCodeAt(i++),r=e.charCodeAt(i++),o=e.charCodeAt(i++),s=n>>2,a=(3&n)<<4|r>>4,l=(15&r)<<2|o>>6,c=63&o;isNaN(r)?l=c=64:isNaN(o)&&(c=64),t.push(codex.charAt(s)+codex.charAt(a)+codex.charAt(l)+codex.charAt(c))}return t.join("")},decode:function(e){var t=[];e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(var i=0;i<e.length;){var n=codex.indexOf(e.charAt(i++)),r=codex.indexOf(e.charAt(i++)),o=codex.indexOf(e.charAt(i++)),s=codex.indexOf(e.charAt(i++)),a=n<<2|r>>4,l=(15&r)<<4|o>>2,c=(3&o)<<6|s;t.push(String.fromCharCode(a)),64!=o&&t.push(String.fromCharCode(l)),64!=s&&t.push(String.fromCharCode(c))}return t.join("")}},function(e,t){var i=function(){},n=t.Class({options:null,id:null,initialize:function(n,r){var o=this;this.options=t.extend({time:500,data:null,onBeforeOpen:i,onAfterOpen:i,onBeforeClose:i,onAfterClose:i},r);var s=n.attr("id");null==s&&(s=t.getUniqueId(),n.attr("id",s)),this.id=s;var a=n.children().first(),l=a.next();n.addClass("n2Blind ui-accordion ui-widget ui-helper-reset ui-accordion-icons");var c=a.text();a.empty().append(e('<span class="ui-icon ui-icon-triangle-1-e"></span>')).append(e('<a class="n2BlindA" href="#"></a>')).click(function(){return o._headerClicked(),!1}),a.find("a").text(c),a.addClass("ui-accordion-header ui-helper-reset ui-state-default ui-corner-top"),l.addClass("ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active").css("display","none")},setText:function(t){e("#"+this.id).children().first().find("a").text(t)},setHtml:function(t){e("#"+this.id).children().first().find("a").html(t)},_headerClicked:function(){var t=this,i=e("#"+this.id);if(!(i.length<1)){var n=i.children().first(),r=n.find("a"),o=n.next(),s={data:this.options.data,link:r,content:o};o.hasClass("n2uiActive")?(n.removeClass("ui-state-active "),n.find("span").removeClass("ui-icon-triangle-1-s").addClass("ui-icon-triangle-1-e"),o.removeClass("n2uiActive"),this.options.onBeforeClose(s),o.hide("blind",{},this.options.time,function(){t.options.onAfterClose(s)})):(n.addClass("ui-state-active "),n.find("span").removeClass("ui-icon-triangle-1-e").addClass("ui-icon-triangle-1-s"),o.addClass("n2uiActive"),this.options.onBeforeOpen(s),o.show("blind",{},this.options.time,function(){t.options.onAfterOpen(s)}))}}});t.blindWidget=function(e,t){return new n(e.first(),t)}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n={},r=t.Class({helpDialogId:null,title:null,htmlContent:null,textContent:null,initialize:function(e){var i=t.extend({title:"Help",htmlContent:null,textContent:null},e);this.title=i.title,this.htmlContent=i.htmlContent,this.textContent=i.textContent,this.helpDialogId=t.getUniqueId()},show:function(e){var t=this._getDialogElem();t.length>0?t.dialog("open"):this._createDialog(e)},hide:function(){var e=this._getDialogElem();e.length>0&&e.dialog("close")},toggle:function(e){var t=this._getDialogElem();t.length>0?t.dialog("isOpen")?this.hide(e):this.show(e):this.show(e)},_getDialogElem:function(){return e("#"+this.helpDialogId)},_createDialog:function(t){if(e.fn&&e.fn.dialog){var n=e("<div>").attr("id",this.helpDialogId).addClass("n2help_content").appendTo(e("body"));if(this.htmlContent){var r=i(this.htmlContent);n.html(r)}else{if(!this.textContent)return;r=i(this.textContent);n.text(r)}n.appendTo(e("body"));var o=n.height(),s=n.width(),a=e(window).height(),l=e(window).width(),c=Math.floor(.8*a),d=Math.floor(.8*l),u={autoOpen:!0,dialogClass:"n2help_dialog",title:i(this.title),modal:!1,width:400,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}},h=o;o>c&&(u.height=c,h=c);var p=s;if(s>d&&(u.width=d,p=d),t){var f=t.offset(),m=!1,v=!1,g=!1,y=!1;f.top>=h&&(m=!0),a-f.top-t.height()>=h&&(v=!0),f.left>=p&&(g=!0),l-f.left-t.width()>=h&&(y=!0),v&&g?u.position={my:"right top",at:"right bottom",of:t}:v&&y?u.position={my:"left top",at:"left bottom",of:t}:v?u.position={my:"center top",at:"center bottom",of:t}:m&&g?u.position={my:"right bottom",at:"right top",of:t}:m&&y?u.position={my:"left bottom",at:"left top",of:t}:m?u.position={my:"center bottom",at:"center top",of:t}:g?u.position={my:"right center",at:"left center",of:t}:y&&(u.position={my:"left center",at:"right center",of:t})}n.dialog(u)}}});t.help={ShowHelp:function(e,t){var i=n[e];i&&i.show(t)},ToggleHelp:function(e,t){var i=n[e];i&&i.toggle(t)},InstallHelpInfo:function(e,t){e&&t&&("html"===t.type&&t.content?n[e]=new r({htmlContent:t.content,title:t.title}):"text"===t.type&&t.content&&(n[e]=new r({textContent:t.content,title:t.title})))}}}(jQuery,nunaliit2),function(e){var t=function(){var e=function(e,t,i,n){for(i=i||{},n=e.length;n--;i[e[n]]=t);return i},t=[1,4],i=[1,7],n=[1,8],r=[5,7,8,11,12,14,15,16,17,18,19,24,25,26,27,28,29,30,32,33],o=[1,13],s=[1,12],a=[1,15],l=[1,16],c=[1,17],d=[1,18],u=[1,23],h=[1,24],p=[1,25],f=[1,26],m=[1,27],v=[1,28],g=[1,29],y=[1,30],_=[1,31],S=[1,32],b=[1,33],I=[1,34],C=[1,35],D=[8,11,12,14,15,16,17,18,19,24,25,26,27,28,29,33],w=[8,11,12,29,33],E=[8,11,12,14,15,16,17,18,19,29,33],x=[8,11,12,14,15,16,17,18,19,24,25,29,33],T={trace:function(){},yy:{},symbols_:{error:2,program:3,prgroot:4,EOF:5,identifier:6,"(":7,")":8,arguments:9,value:10,"&&":11,"||":12,"!":13,"==":14,"!=":15,">=":16,"<=":17,">":18,"<":19,true:20,false:21,NUMBER:22,STRING:23,"+":24,"-":25,"*":26,"/":27,"%":28,",":29,".":30,VAR_NAME:31,"[":32,"]":33,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",7:"(",8:")",11:"&&",12:"||",13:"!",14:"==",15:"!=",16:">=",17:"<=",18:">",19:"<",20:"true",21:"false",22:"NUMBER",23:"STRING",24:"+",25:"-",26:"*",27:"/",28:"%",29:",",30:".",31:"VAR_NAME",32:"[",33:"]"},productions_:[0,[3,2],[4,1],[4,3],[4,4],[10,3],[10,3],[10,2],[10,3],[10,3],[10,3],[10,3],[10,3],[10,3],[10,3],[10,3],[10,4],[10,1],[10,1],[10,1],[10,1],[10,1],[10,3],[10,3],[10,3],[10,3],[10,3],[9,3],[9,1],[6,3],[6,4],[6,1]],performAction:function(e,t,i,n,r,o,s){var a=o.length-1;switch(r){case 1:return o[a-1];case 2:this.$=new L(o[a],null);break;case 3:this.$=new L(o[a-2],null);break;case 4:this.$=new L(o[a-3],o[a-1]);break;case 5:this.$=new A(o[a-2],"&&",o[a]);break;case 6:this.$=new A(o[a-2],"||",o[a]);break;case 7:this.$=new A(o[a],"!");break;case 8:this.$=o[a-1];break;case 9:this.$=new R(o[a-2],o[a],"==");break;case 10:this.$=new R(o[a-2],o[a],"!=");break;case 11:this.$=new R(o[a-2],o[a],">=");break;case 12:this.$=new R(o[a-2],o[a],"<=");break;case 13:this.$=new R(o[a-2],o[a],">");break;case 14:this.$=new R(o[a-2],o[a],"<");break;case 15:this.$=new M(o[a-2],null);break;case 16:this.$=new M(o[a-3],o[a-1]);break;case 17:this.$=o[a];break;case 18:this.$=new F(!0);break;case 19:this.$=new F(!1);break;case 20:this.$=new F(1*o[a]);break;case 21:this.$=new F(o[a]);break;case 22:this.$=new N(o[a-2],o[a],"+");break;case 23:this.$=new N(o[a-2],o[a],"-");break;case 24:this.$=new N(o[a-2],o[a],"*");break;case 25:this.$=new N(o[a-2],o[a],"/");break;case 26:this.$=new N(o[a-2],o[a],"%");break;case 27:this.$=new O(o[a-2],o[a]);break;case 28:this.$=new O(o[a]);break;case 29:var l=new F(o[a]);this.$=new P(l,o[a-2]);break;case 30:this.$=new P(o[a-1],o[a-3]);break;case 31:this.$=new B(o[a])}},table:[{3:1,4:2,6:3,31:t},{1:[3]},{5:[1,5]},{5:[2,2],7:[1,6],30:i,32:n},e(r,[2,31]),{1:[2,1]},{6:14,7:o,8:[1,9],9:10,10:11,13:s,20:a,21:l,22:c,23:d,31:t},{31:[1,19]},{6:14,7:o,10:20,13:s,20:a,21:l,22:c,23:d,31:t},{5:[2,3]},{8:[1,21]},{8:[2,28],11:u,12:h,14:p,15:f,16:m,17:v,18:g,19:y,24:_,25:S,26:b,27:I,28:C,29:[1,22]},{6:14,7:o,10:36,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:37,13:s,20:a,21:l,22:c,23:d,31:t},e(D,[2,17],{7:[1,38],30:i,32:n}),e(D,[2,18]),e(D,[2,19]),e(D,[2,20]),e(D,[2,21]),e(r,[2,29]),{11:u,12:h,14:p,15:f,16:m,17:v,18:g,19:y,24:_,25:S,26:b,27:I,28:C,33:[1,39]},{5:[2,4]},{6:14,7:o,9:40,10:11,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:41,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:42,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:43,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:44,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:45,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:46,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:47,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:48,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:49,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:50,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:51,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:52,13:s,20:a,21:l,22:c,23:d,31:t},{6:14,7:o,10:53,13:s,20:a,21:l,22:c,23:d,31:t},e(D,[2,7]),{8:[1,54],11:u,12:h,14:p,15:f,16:m,17:v,18:g,19:y,24:_,25:S,26:b,27:I,28:C},{6:14,7:o,8:[1,55],9:56,10:11,13:s,20:a,21:l,22:c,23:d,31:t},e(r,[2,30]),{8:[2,27]},e(w,[2,5],{14:p,15:f,16:m,17:v,18:g,19:y,24:_,25:S,26:b,27:I,28:C}),e(w,[2,6],{14:p,15:f,16:m,17:v,18:g,19:y,24:_,25:S,26:b,27:I,28:C}),e(E,[2,9],{24:_,25:S,26:b,27:I,28:C}),e(E,[2,10],{24:_,25:S,26:b,27:I,28:C}),e(E,[2,11],{24:_,25:S,26:b,27:I,28:C}),e(E,[2,12],{24:_,25:S,26:b,27:I,28:C}),e(E,[2,13],{24:_,25:S,26:b,27:I,28:C}),e(E,[2,14],{24:_,25:S,26:b,27:I,28:C}),e(x,[2,22],{26:b,27:I,28:C}),e(x,[2,23],{26:b,27:I,28:C}),e(D,[2,24]),e(D,[2,25]),e(D,[2,26]),e(D,[2,8]),e(D,[2,15]),{8:[1,57]},e(D,[2,16])],defaultActions:{5:[2,1],9:[2,3],21:[2,4],40:[2,27]},parseError:function(e,t){if(!t.recoverable)throw i.prototype=Error,new i(e,t);function i(e,t){this.message=e,this.hash=t}this.trace(e)},parse:function(e){var t=this,i=[0],n=[null],r=[],o=this.table,s="",a=0,l=0,c=0,d=r.slice.call(arguments,1),u=Object.create(this.lexer),h={yy:{}};for(var p in this.yy)Object.prototype.hasOwnProperty.call(this.yy,p)&&(h.yy[p]=this.yy[p]);u.setInput(e,h.yy),h.yy.lexer=u,h.yy.parser=this,void 0===u.yylloc&&(u.yylloc={});var f=u.yylloc;r.push(f);var m=u.options&&u.options.ranges;"function"==typeof h.yy.parseError?this.parseError=h.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var v,g,y,_,S,b,I,C,D,w=function(){var e;return"number"!=typeof(e=u.lex()||1)&&(e=t.symbols_[e]||e),e},E={};;){if(y=i[i.length-1],this.defaultActions[y]?_=this.defaultActions[y]:(null==v&&(v=w()),_=o[y]&&o[y][v]),void 0===_||!_.length||!_[0]){var x="";for(b in D=[],o[y])this.terminals_[b]&&b>2&&D.push("'"+this.terminals_[b]+"'");x=u.showPosition?"Parse error on line "+(a+1)+":\n"+u.showPosition()+"\nExpecting "+D.join(", ")+", got '"+(this.terminals_[v]||v)+"'":"Parse error on line "+(a+1)+": Unexpected "+(1==v?"end of input":"'"+(this.terminals_[v]||v)+"'"),this.parseError(x,{text:u.match,token:this.terminals_[v]||v,line:u.yylineno,loc:f,expected:D})}if(_[0]instanceof Array&&_.length>1)throw new Error("Parse Error: multiple actions possible at state: "+y+", token: "+v);switch(_[0]){case 1:i.push(v),n.push(u.yytext),r.push(u.yylloc),i.push(_[1]),v=null,g?(v=g,g=null):(l=u.yyleng,s=u.yytext,a=u.yylineno,f=u.yylloc,c>0&&c--);break;case 2:if(I=this.productions_[_[1]][1],E.$=n[n.length-I],E._$={first_line:r[r.length-(I||1)].first_line,last_line:r[r.length-1].last_line,first_column:r[r.length-(I||1)].first_column,last_column:r[r.length-1].last_column},m&&(E._$.range=[r[r.length-(I||1)].range[0],r[r.length-1].range[1]]),void 0!==(S=this.performAction.apply(E,[s,l,a,h.yy,_[1],n,r].concat(d))))return S;I&&(i=i.slice(0,-1*I*2),n=n.slice(0,-1*I),r=r.slice(0,-1*I)),i.push(this.productions_[_[1]][0]),n.push(E.$),r.push(E._$),C=o[i[i.length-2]][i[i.length-1]],i.push(C);break;case 3:return!0}}}},k={Math:Math};T.global=k;var L=function(e,t){this.fnId=e,this.args=t};L.prototype.getValue=function(e){var t={args:[]};return t.fn=this.fnId.getValue(e),this.args&&this.args.pushOnArray(e,t.args),t};var M=function(e,t){this.value=e,this.args=t};M.prototype.getValue=function(e){var t=this.value.getValue(e);if("function"==typeof t){var i=[];return this.args&&this.args.pushOnArray(e,i),t.apply(e,i)}return!1};var O=function(e,t){this.valueNode=e,this.nextArgument=t||null};O.prototype.getCount=function(){return this.nextArgument?1+this.nextArgument.getCount():1},O.prototype.getArgument=function(e,t){if(t<1)return this.valueNode.getValue(e);this.nextArgument&&this.nextArgument.getArgument(e,t-1)},O.prototype.pushOnArray=function(e,t){var i=this.valueNode.getValue(e);t.push(i),this.nextArgument&&this.nextArgument.pushOnArray(e,t)};var A=function(e,t,i){this.n1=e,this.n2=i,this.op=t};A.prototype.getValue=function(e){var t=this.n1.getValue(e),i=void 0;return this.n2&&(i=this.n2.getValue(e)),"!"===this.op?!t:"&&"===this.op?t&&i:"||"===this.op&&(t||i)};var F=function(e){this.value=e};F.prototype.getValue=function(e){return this.value};var R=function(e,t,i){this.leftNode=e,this.rightNode=t,this.op=i};R.prototype.getValue=function(e){var t=this.leftNode.getValue(e),i=this.rightNode.getValue(e);return"=="===this.op?t==i:"!="===this.op?t!=i:">="===this.op?t>=i:"<="===this.op?t<=i:">"===this.op?t>i:"<"===this.op&&t<i};var N=function(e,t,i){this.leftNode=e,this.rightNode=t,this.op=i};N.prototype.getValue=function(e){var t=this.leftNode.getValue(e),i=this.rightNode.getValue(e);return"+"===this.op?t+i:"-"===this.op?t-i:"*"===this.op?t*i:"/"===this.op?t/i:"%"===this.op?t%i:0};var P=function(e,t){this.idNode=e,this.previousSelector=t};P.prototype.getValue=function(e){var t=this.previousSelector.getValue(e);if("object"==typeof t){var i=this.idNode.getValue(e);if(void 0===i)return;return t[i]}};var B=function(e){this.variableName=e};B.prototype.getValue=function(e){var t=void 0;return e&&"doc"===this.variableName?t=e.doc:e&&e.funcMap&&e.funcMap[this.variableName]?t=e.funcMap[this.variableName]:k&&k[this.variableName]&&(t=k[this.variableName]),t};var U={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,i=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),i.length-1&&(this.yylineno-=i.length-1);var r=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:i?(i.length===n.length?this.yylloc.first_column:0)+n[n.length-i.length].length-i[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[r[0],r[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var i,n,r;if(this.options.backtrack_lexer&&(r={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(r.yylloc.range=this.yylloc.range.slice(0))),(n=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],i=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),i)return i;if(this._backtrack){for(var o in r)this[o]=r[o];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,i,n;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var r=this._currentRules(),o=0;o<r.length;o++)if((i=this._input.match(this.rules[r[o]]))&&(!t||i[0].length>t[0].length)){if(t=i,n=o,this.options.backtrack_lexer){if(!1!==(e=this.test_match(i,r[o])))return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?!1!==(e=this.test_match(t,r[n]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return(e=this.conditionStack.length-1-Math.abs(e||0))>=0?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(e,t,i,n){switch(i){case 0:break;case 1:return 20;case 2:return 21;case 3:return 22;case 4:return 31;case 5:return t.yytext=t.yytext.substr(1,t.yytext.length-2),23;case 6:return 14;case 7:return 15;case 8:return 16;case 9:return 17;case 10:return 18;case 11:return 19;case 12:return 7;case 13:return 8;case 14:return"{";case 15:return"}";case 16:return 32;case 17:return 33;case 18:return 29;case 19:return 30;case 20:return 13;case 21:return 24;case 22:return 25;case 23:return 26;case 24:return 27;case 25:return 28;case 26:return 11;case 27:return 12;case 28:return 5;case 29:return"INVALID"}},rules:[/^(?:\s+)/,/^(?:true\b)/,/^(?:false\b)/,/^(?:[0-9]+(\.[0-9]+)?\b)/,/^(?:[_a-zA-Z][_a-zA-Z0-9]*)/,/^(?:'(\\'|[^'])*')/,/^(?:==)/,/^(?:!=)/,/^(?:>=)/,/^(?:<=)/,/^(?:>)/,/^(?:<)/,/^(?:\()/,/^(?:\))/,/^(?:\{)/,/^(?:\})/,/^(?:\[)/,/^(?:\])/,/^(?:,)/,/^(?:\.)/,/^(?:!)/,/^(?:\+)/,/^(?:-)/,/^(?:\*)/,/^(?:\/)/,/^(?:%)/,/^(?:&&)/,/^(?:\|\|)/,/^(?:$)/,/^(?:.)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29],inclusive:!0}}};function j(){this.yy={}}return T.lexer=U,j.prototype=T,T.Parser=j,new j}();exports.parser=t,exports.Parser=t.Parser,exports.parse=function(){return t.parse.apply(t,arguments)},exports.main=function(e){e[1]||(console.log("Usage: "+e[0]+" FILE"),process.exit(1));var t=__webpack_require__(0).readFileSync(__webpack_require__(1).normalize(e[1]),"utf8");return exports.parser.parse(t)},__webpack_require__.c[__webpack_require__.s]===module&&exports.main(process.argv.slice(1)),e.docFnCall={parse:function(){return t.parse.apply(t,arguments)},getGlobalContext:function(){return t.global}}}(nunaliit2),function($,$n2){var _loc=function(e,t){return $n2.loc(e,"nunaliit2",t)},defaultErrorFn=function(e){$n2.reportError(e)},defaultSuccessFn=function(){},typeClassStringPrefix="n2schema_type_",HTML=":html",INPUT=":input",FIELD=":field",SELECTOR=":selector",ITERATE=":iterate",EMPTY=":empty",CONTEXT=":context",PARENT=":parent",SELECT="::cur-selector",LOCALIZE=":localize",ARRAY=":array";function parseSelectorString(e){if("."===e)return new $n2.objectSelector.ObjectSelector([]);var t=e.split(".");return new $n2.objectSelector.ObjectSelector(t)}var customFieldHandlers={};function registerCustomFieldHandler(e){var t=$n2.extend({customType:null,handler:null},e);"string"==typeof t.customType&&"function"==typeof t.handler&&(customFieldHandlers[t.customType]=t.handler)}function _localizeString(){var e=[];e.push.apply(e,arguments);for(var t=e.pop().fn(this).split(","),i=t[0],n={},r=1,o=t.length;r<o;++r){var s=t[r].split("=");if(s.length>1){var a=s[1].split("+");a.length>1?n[s[0]]=a:n[s[0]]=[s[1]]}else n[s[0]]=[]}var l=parseSelectorString(i).getValue(this);if(l&&"object"==typeof l&&"localized"===l.nunaliit_type){var c="en";if($n2.l10n&&$n2.l10n.getLocale&&(c=$n2.l10n.getLocale().lang),l[c])return n.html?l[c]:p=$n2.utils.escapeHtml(l[c]);var d="en";if(!l[d])for(var u in d=null,l)if(u.length>0&&":"===u[0]);else if("nunaliit_type"===u);else if(l[u]){d=u;break}if(d){var h=[];if(h.push('<span class="n2_localized_string n2_localize_fallback">'),h.push('<span class="n2_localize_fallback_lang">('),h.push(d),h.push(")</span>"),l[d])if(n.html)h.push(""+l[d]);else{var p=$n2.utils.escapeHtml(l[d]);h.push(p)}return h.push("</span>"),h.join("")}return""}return void 0===l?"":null===l?"":n.html?""+l:p=$n2.utils.escapeHtml(""+l)}function _formSingleField(e,t,i){if(i.textarea?e.push("<textarea"):i.checkbox?e.push('<input type="checkbox"'):e.push('<input type="text"'),i.placeholder&&"string"==typeof i.placeholder[0]){var n=i.placeholder[0];n=(n=n.replace(/&/g,"&amp;")).replace(/"/g,"&quot;"),e.push(' placeholder="'),e.push(_loc(n)),e.push('"')}e.push(' class="n2schema_input');var r=createClassStringFromSelector(t);e.push(" "+r),i.date?e.push(" "+typeClassStringPrefix+"date"):i.numeric?e.push(" "+typeClassStringPrefix+"numeric"):i.layers?e.push(" "+typeClassStringPrefix+"layers"):i.localized&&e.push(" "+typeClassStringPrefix+"localized"),i.textarea?e.push('"></textarea>'):(i.checkbox,e.push('"/>')),i.date&&e.push('<div class="n2schema_help_date"></div>'),i.wikiTransform&&e.push('<div class="n2schema_help_wiki"></div>')}function _formField(){var e=[];e.push.apply(e,arguments);var t=e.pop(),i=null;t&&t.data&&t.data.n2_selector?i=t.data.n2_selector:"object"==typeof this&&null!==this&&this[SELECT]&&(i=this[SELECT]);var n=t.fn(this).split(","),r=parseSelectorString(n[0]),o=r.getValue(this),s=i.getChildSelector(r);o&&"object"==typeof o&&!o[SELECT]&&(o[SELECT]=s);for(var a={},l=1,c=n.length;l<c;++l){var d=n[l].split("=");if(d.length>1){for(var u=d[1].split("+"),h=0,p=u.length;h<p;++h)u[h]=decodeURIComponent(u[h]);a[d[0]]=u}else a[d[0]]=[]}var f=[];if(f.push('<div class="n2schema_field_wrapper">'),a.custom)f.push('<div class="n2schema_field_container n2schema_field_custom"'),a.custom.length>0&&"string"==typeof a.custom[0]?f.push(' n2-custom-type="'+a.custom+'"'):f.push(' nunaliit-error="Custom type not specified"'),f.push(' nunaliit-selector="'+s.encodeForDomAttribute()+'"'),f.push(">"),f.push("</div>");else if(o&&"localized"===o.nunaliit_type){var m=_(a.localized,o);a.localized||(a.localized=[]);for(l=0,c=m.length;l<c;++l){var v=m[l],g=s.getChildSelector(v);f.push('<div class="n2schema_field_container n2schema_field_container_localized'),a.textarea&&f.push(" n2schema_field_container_textarea"),f.push('">'),f.push('<span class="n2_localize_lang">('+v+")</span>"),_formSingleField(f,g,a),f.push("</div>")}}else if(!o&&a.localized)for(l=0,c=(m=_(a.localized,null)).length;l<c;++l){v=m[l],g=s.getChildSelector(v);f.push('<div class="n2schema_field_container n2schema_field_container_localized'),a.textarea&&f.push(" n2schema_field_container_textarea"),f.push('">'),f.push('<span class="n2_localize_lang">('+v+")</span>"),_formSingleField(f,g,a),f.push("</div>")}else if(a.reference){var y=s.encodeForDomAttribute();f.push('<span class="n2schema_field_reference" nunaliit-selector="'+y+'"'),a.search&&a.search[0]&&f.push(' n2-search-func="'+a.search[0]+'"'),f.push("></span>")}else if(a.geometry){y=s.encodeForDomAttribute();f.push('<textarea class="n2schema_field_geometry" nunaliit-selector="'+y+'"'),f.push("></textarea>")}else f.push('<div class="n2schema_field_container'),a.textarea&&f.push(" n2schema_field_container_textarea"),f.push('">'),_formSingleField(f,s,a),f.push("</div>");return f.push("</div>"),f.join("");function _(e,t){var i={};if(t)for(var n in t)"nunaliit_type"===n||":"===n[0]||(i[n]=!0);if(e)for(var r=0,o=e.length;r<o;++r){i[n=e[r]]=!0}var s=$n2.languageSupport.getLanguages();if(s)for(r=0,o=s.length;r<o;++r){i[n=s[r].code]=!0}var a=[];for(var n in i)a.push(n);var l=$n2.l10n.getLocale().lang;return a.sort(function(e,t){return e===l?-1:t===l?1:e<t?-1:e>t?1:0}),a}}function _inputField(){var e=[];e.push.apply(e,arguments);var t=e.pop(),i=t.fn(this).split(","),n=i[0],r=null;if(t&&t.data&&t.data.n2_selector)r=t.data.n2_selector;else{if(!this[SELECT])return"";r=this[SELECT]}if("."===n);else{var o=n.split(".");r=r.getChildSelector(o)}var s="n2schema_input "+createClassStringFromSelector(r),a="";return i[1]&&(a=" n2schema_type_"+i[1]),s+a}function _arrayField(){var e=[];e.push.apply(e,arguments);var t=e.pop(),i=e[0],n=null;e.length>1&&(n=e[1]);var r=[];if(r.push('<div class="n2schema_array">'),i&&i.length)for(var o=0,s=i.length;o<s;++o){var a=i[o],l=i[SELECT],c=createClassStringFromSelector(l=l.getChildSelector(o));r.push('<div class="n2schema_array_item">'),r.push('<div class="n2schema_array_item_buttons">'),r.push('<div class="n2schema_array_item_delete '+c+'"></div>'),r.push('<div class="n2schema_array_item_up '+c+'"></div>'),r.push('<div class="n2schema_array_item_down '+c+'"></div>'),r.push("</div>"),r.push('<div class="n2schema_array_item_wrapper">'),r.push(t.fn(a,{data:{n2_selector:l}})),r.push("</div></div>")}var d=void 0;if(i)d=i[SELECT];else if(t&&t.ids&&t.ids.length){var u=[];!function e(t,i){t._parent&&e(t._parent,i);t.contextPath&&i.push(t.contextPath)}(t.data,u),u.push(t.ids[0]),d=new $n2.objectSelector.ObjectSelector(u)}if(d){var h=createClassStringFromSelector(d);r.push('<div class="n2schema_array_add '+h+'"'),n&&r.push('n2_array_new_type="'+n+'"'),r.push("></div>")}return r.push("</div>"),r.join("")}function _selectorField(){var e=[];e.push.apply(e,arguments);var t=e.pop(),i=null;if(t&&t.data&&t.data.n2_selector?i=t.data.n2_selector:"object"==typeof this&&null!==this&&this[SELECT]&&(i=this[SELECT]),!i)return"";var n=parseSelectorString(t.fn(this));return i.getChildSelector(n).encodeForDomAttribute()}function computeViewObj(e,t,i,n){if(i||(i=new $n2.objectSelector.ObjectSelector([])),null===e)return e;if(void 0===e)return null;if($n2.isArray(e)){(l=[])[CONTEXT]=t,l[PARENT]=n,l[SELECT]=i;for(var r=0,o=e.length;r<o;++r){var s=i.getChildSelector(r),a=computeViewObj(e[r],t,s,l);l.push(a)}return l}if("object"==typeof e){var l={};for(var c in l[ITERATE]=[],l[CONTEXT]=t,l[PARENT]=n,l[SELECT]=i,e)if("__n2Source"!==c){s=i.getChildSelector(c),a=computeViewObj(e[c],t,s,l);l[c]=a,l[ITERATE].push({key:c,value:a})}return l[EMPTY]=0==l[ITERATE].length,l[ITERATE].sort(function(e,t){return e.key<t.key?-1:e.key>t.key?1:0}),l}return e}"undefined"!=typeof Handlebars&&Handlebars.registerHelper?(Handlebars.registerHelper(LOCALIZE,_localizeString),Handlebars.registerHelper(FIELD,_formField),Handlebars.registerHelper(INPUT,_inputField),Handlebars.registerHelper(ARRAY,_arrayField),Handlebars.registerHelper(SELECTOR,_selectorField)):$n2.log("Unable to register helper functions with Handlebars. Schemas will not work properly.");var ObjectQueryResults=$n2.Class({objects:null,length:0,initialize:function(e){null===e?this.objects=[]:void 0===e?this.objects=[]:$n2.isArray(e)?this.objects=e:this.objects="object"==typeof e?[e]:[],this.length=this.objects.length},query:function(e){if(null===e){var t=this._selectInterim(null,this.objects);return new ObjectQueryResults(t)}if("string"==typeof e){t=this._selectInterim(e,this.objects);return new ObjectQueryResults(t)}if(void 0===e)return ObjectQueryResultsEmpty;if($n2.isArray(e)){t=this.objects;for(var i=0,n=e.length;i<n;++i){var r=e[i];t=this._selectInterim(r,t)}return new ObjectQueryResults(t)}return ObjectQueryResultsEmpty},each:function(e){for(var t=0,i=this.objects.length;t<i;++t){e(this.objects[t],t)}},_selectInterim:function(e,t){for(var i=[],n=0,r=t.length;n<r;++n)this._selectFromObject(t[n],e,i);return i},_selectFromObject:function(e,t,i){if(null===t)for(var n in e){var r=e[n];i.push(r)}else if("string"==typeof t)void 0!==e[t]&&i.push(e[t]);else if("function"==typeof t)for(var n in e)t(e,n)&&i.push(e[n])}}),ObjectQueryResultsEmpty=new ObjectQueryResults;$n2.ObjectQuery=function(e,t){return new ObjectQueryResults(e).query(t)};var SchemaRepositoryFunctions=$n2.Class({onCreateFns:null,initialize:function(){this.onCreateFns=[]},addOnDocumentCreateFunction:function(e){"function"==typeof e&&this.onCreateFns.push(e)},onDocumentCreate:function(e,t){for(var i=0,n=this.onCreateFns.length;i<n;++i){(0,this.onCreateFns[i])(e,t)}}}),SchemaRepository=$n2.Class({schemasByName:null,loadSchemasFn:null,rootSchemasQueried:!1,repositoryFunctions:null,initialize:function(){this.schemasByName={},this.repositoryFunctions=new SchemaRepositoryFunctions},addSchemas:function(e){var t=$n2.extend({schemas:null,onSuccess:defaultSuccessFn,onError:defaultErrorFn},e),i=t.schemas;$n2.isArray(i)||(i=[i]);for(var n=0,r=i.length;n<r;++n){var o=i[n];if(o.isSchema)(s=o).repositoryFunctions=this.repositoryFunctions;else var s=new Schema(this,o);var a=s.name;this.schemasByName[a]=s}this._resolveSchemaDependencies(t)},getSchema:function(e){var t=this,i=$n2.extend({name:null,onSuccess:defaultSuccessFn,onError:defaultErrorFn},e);this.schemasByName[i.name]?this.schemasByName[i.name]._error?i.onError('Schema "'+i.name+'" not found'):i.onSuccess(this.schemasByName[i.name]):this.loadSchemasFn?this._loadSchemaDefinitions({names:[i.name],onSuccess:function(){t.schemasByName[i.name]._error?i.onError('Schema "'+i.name+'" not found'):i.onSuccess(t.schemasByName[i.name])},onError:i.onError}):i.onError("Can not find schema named: "+i.name)},getSchemas:function(e){for(var t=this,i=$n2.extend({names:null,onSuccess:defaultSuccessFn,onError:defaultErrorFn},e),n=[],r=null,o=0,s=i.names.length;o<s;++o){var a=i.names[o],l=this.schemasByName[a];l&&l._error||(l?n[n.length]=l:(null===r&&(r=[]),r[r.length]=a))}null!==r?this.loadSchemasFn?this._loadSchemaDefinitions({names:r,onSuccess:function(){for(var e=0,o=r.length;e<o;++e){var s=t.schemasByName[r[e]];s&&!s._error&&(n[n.length]=s)}i.onSuccess(n)},onError:i.onError}):i.onError("Can not find requested schemas: "+r):i.onSuccess(n)},getRootSchemas:function(e){var t=$n2.extend({onSuccess:defaultSuccessFn,onError:defaultErrorFn},e),i=this;if(this.rootSchemasQueried||!this.loadSchemasFn){var n=[];for(var r in this.schemasByName){var o=this.schemasByName[r];o._error||o.isRootSchema&&n.push(o)}t.onSuccess(n)}else{i=this;this._loadSchemaDefinitions({rootSchemas:!0,onSuccess:function(){i.rootSchemasQueried=!0,i.getRootSchemas(e)},onError:t.onError})}},reset:function(){this.schemasByName={},this.rootSchemasQueried=!1},getRepositoryFunctions:function(){return this.repositoryFunctions},_loadSchemaDefinitions:function(e){var t=this,i={names:e.names,onSuccess:function(i){if(e.names)for(var r=0,o=e.names.length;r<o;++r){var s=e.names[r],a=n(s,i);a||(i.push({name:s,isRootSchema:!1,display:"",form:"",brief:"",create:{},extensions:[],nunaliit_type:"schema",_error:!0}),$n2.log("schema definition not found: "+s))}t.addSchemas({schemas:i,onSuccess:e.onSuccess,onError:e.onError})},onError:e.onError};function n(e,t){for(var i=0,n=t.length;i<n;++i){var r=t[i];if(r.name===e)return r}return null}this.loadSchemasFn(i)},_resolveSchemaDependencies:function(e){var t={},i=this.schemasByName;for(var n in this.schemasByName){this.schemasByName[n]._resolveSchemaDependencies(i,t)}var r=[];for(var o in t)r.push(o);r.length<1?e.onSuccess():r.length>0&&!this.loadSchemasFn?e.onError("Can not find missing dependencies"):this._loadSchemaDefinitions({names:r,onSuccess:e.onSuccess,onError:e.onError})},_getSchemaMap:function(){return this.schemasByName}}),SchemaExtension=$n2.Class({selector:null,create:null,schemaName:null,dependentSchema:null,initialize:function(e){this.selector=e.selector,this.schemaName=e.schemaName,this.create=!1,"boolean"==typeof e.create&&(this.create=e.create)},createObject:function(e,t){for(var i=t,n=0,r=this.selector.length-1;n<r;++n){var o=this.selector[n];i&&(i=i[o])}o=this.selector[n];if(i&&(i=i[o]),this.create||i){var s=e;for(n=0,r=this.selector.length-1;n<r;++n){s[o=this.selector[n]]?s=s[o]:(s[o]={},s=s[o])}s[o=this.selector[n]]=this.dependentSchema.createObject(i)}},_resolveSchemaDependencies:function(e,t){!this.dependentSchema&&this.schemaName&&(e[this.schemaName]?this.dependentSchema=e[this.schemaName]:t[this.schemaName]=1)}}),Schema=$n2.Class({isSchema:null,isRootSchema:!1,name:null,repositoryFunctions:null,displayTemplate:null,briefTemplate:null,popupTemplate:null,formTemplate:null,relatedSchemaNames:null,extensions:null,extensionsByName:null,cachedDisplay:null,cachedBrief:null,cachedPopup:null,csvExport:null,exportInfo:null,label:null,definition:null,options:null,jsonDefinition:null,_error:null,initialize:function(e,t){if(this.repositoryFunctions=e.getRepositoryFunctions(),this.name=t.name,this.displayTemplate=t.display,this.briefTemplate=t.brief,this.popupTemplate=t.popup,this.formTemplate=t.form,this.create=t.create,this.csvExport=t.csvExport,this.exportInfo=t.export,this.label=t.label,this.definition=t.definition,this.options=t.options,this.jsonDefinition=t,t.isRootSchema&&(this.isRootSchema=!0),t._error&&(this._error=!0),this.relatedSchemaNames=t.relatedSchemas,this.relatedSchemaNames||(this.relatedSchemaNames=[]),this.extensions=[],this.extensionsByName={},t.extensions)if($n2.isArray(t.extensions))for(var i=0,n=t.extensions.length;i<n;++i){var r=new SchemaExtension(t.extensions[i]);this.extensions.push(r),this.extensionsByName[r.schemaName]=r}else for(var o in t.extensions){r=new SchemaExtension(t.extensions[o]);this.extensions.push(r),this.extensionsByName[r.schemaName]=r}this.isSchema=!0},getLabel:function(){return this.label?_loc(this.label):this.name},createObject:function(e){var t={};if(this.create&&$n2.extend(!0,t,this.create),e)for(var i in e)this.extensionsByName[i]||(t[i]=e[i]);for(var n=0,r=this.extensions.length;n<r;++n){this.extensions[n].createObject(t,e)}return this.repositoryFunctions.onDocumentCreate(t,this),t},display:function(e,t,i){this.displayTemplate&&(this.cachedDisplay||(this.cachedDisplay=new Display(this,"displayTemplate")),this.cachedDisplay.display(e,t,i))},brief:function(e,t,i){this.briefTemplate&&(this.cachedBrief||(this.cachedBrief=new Display(this,"briefTemplate")),this.cachedBrief.display(e,t,i))},popup:function(e,t,i){this.popupTemplate&&(this.cachedPopup||(this.cachedPopup=new Display(this,"popupTemplate")),this.cachedPopup.display(e,t,i))},form:function(e,t,i,n,r){var o=new Form(this);return o.form(e,t,i,n,r),o},_resolveSchemaDependencies:function(e,t){for(var i=0,n=this.extensions.length;i<n;++i){this.extensions[i]._resolveSchemaDependencies(e,t)}}});function DisplaySelectAny(e,t){return EMPTY!==t&&ITERATE!==t&&CONTEXT!==t}var DisplayExtension=$n2.Class({schemaExtension:null,subDisplay:null,selector:null,initialize:function(e,t){this.schemaExtension=e,this.templateName=t;var i=this.schemaExtension.dependentSchema;this.subDisplay=new Display(i,t),this.selector=[];for(var n=0,r=e.selector.length;n<r;++n){var o=e.selector[n];null===o?this.selector.push(DisplaySelectAny):this.selector.push(o)}},getName:function(){return this.schemaExtension.name},_setHtml:function(e){var t=this.subDisplay;$n2.ObjectQuery(e,this.selector).each(function(e){t._setHtml(e)})}}),Display=$n2.Class({schema:null,templateName:null,extensions:null,initialize:function(e,t){this.schema=e,this.templateName=t,this.templateName||(this.templateName="displayTemplate"),this.extensions=[];for(var i=0,n=e.extensions.length;i<n;++i){var r=new DisplayExtension(e.extensions[i],this.templateName);this.extensions.push(r)}},display:function(e,t,i){var n={root:e};$n2.extend(n,i);var r=computeViewObj(e,n);this._setHtml(r),r[HTML]&&t.html(r[HTML])},_setHtml:function(e){if(null!=e){for(var t=0,i=this.extensions.length;t<i;++t){this.extensions[t]._setHtml(e)}var n=this.schema[this.templateName+"__compiled"];if(!n){var r=this.schema[this.templateName];r&&(n=Handlebars.compile(r,{trackIds:!0}),this.schema[this.templateName+"__compiled"]=n)}n&&(e[HTML]=n(e))}}}),selectorClassStringPrefix="n2schema_selector";function escapeSelector(e){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i];if(r>="a"&&r<="z")t.push(r);else if(r>="A"&&r<="Z")t.push(r);else if(r>="0"&&r<="9")t.push(r);else{var o=r.charCodeAt(0),s=48+(7&o),a=48+(o>>3&7),l=48+(o>>6&7);t.push("_"),t.push(String.fromCharCode(l)),t.push(String.fromCharCode(a)),t.push(String.fromCharCode(s))}}return t.join("")}function unescapeSelector(e){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i];if("_"===r){++i;var o=e.charCodeAt(i);++i;var s=e.charCodeAt(i);++i;var a=(o-48<<6)+(s-48<<3)+(e.charCodeAt(i)-48);t.push(String.fromCharCode(a))}else t.push(r)}return t.join("")}function createClassStringFromSelector(e){return selectorClassStringPrefix+e.encodeForDomAttribute()}function createSelectorFromClassString(e){if(selectorClassStringPrefix===e.substr(0,selectorClassStringPrefix.length)){var t=e.substr(selectorClassStringPrefix.length);return $n2.objectSelector.decodeFromDomAttribute(t)}return null}function parseClassNames(e){for(var t={},i=0,n=e.length;i<n;++i){var r=e[i],o=createSelectorFromClassString(r);if(o&&(t.selector=o),typeClassStringPrefix===r.substr(0,typeClassStringPrefix.length)){var s=r.substr(typeClassStringPrefix.length);t.type=s}}return t}var FormExtension=$n2.Class({schemaExtension:null,innerForm:null,selector:null,initialize:function(e){this.schemaExtension=e;var t=this.schemaExtension.dependentSchema;this.innerForm=new Form(t),this.selector=[];for(var i=0,n=e.selector.length;i<n;++i){var r=e.selector[i];null===r?this.selector.push(DisplaySelectAny):this.selector.push(r)}},getName:function(){return this.schemaExtension.name},_setHtml:function(e){var t=this.innerForm;$n2.ObjectQuery(e,this.selector).each(function(e){t._setHtml(e)})}}),Form=$n2.Class({schema:null,extensions:null,obj:null,elemId:null,context:null,callback:null,initialize:function(e){this.schema=e,this.extensions=[];for(var t=0,i=e.extensions.length;t<i;++t){var n=new FormExtension(e.extensions[t]);this.extensions.push(n)}},form:function(e,t,i,n,r){if(this.obj=e,this.context=$n2.extend({root:e},i),this.callback=n,this.callback||(this.callback=function(e,t,i){}),this.functionMap={},r)for(var o in r)this.functionMap[o]=r[o];var s=t.attr("id");void 0===s&&(s=$n2.getUniqueId(),t.attr("id",s)),this.elemId=t.attr("id"),this.refresh(t)},refresh:function($elem){if(void 0===$elem&&($elem=$("#"+this.elemId)),$elem.length>0){var view=computeViewObj(this.obj,this.context);this._setHtml(view);var currentHeight=$elem.height(),currentWidth=$elem.width();currentHeight>0&&$elem.css("min-height",currentHeight+"px"),currentWidth>0&&$elem.css("min-width",currentWidth+"px"),window.setTimeout(function(){$elem.removeAttr("style")},500),$elem.empty();var $divEvent=$("<div>").addClass("n2schema_editorEvent").appendTo($elem);if(view[HTML]){$divEvent.html(view[HTML]);var _this=this;$divEvent.find(".n2schema_input").each(function(){_this._installHandlers($elem,$(this),_this.obj,_this.callback)}),$divEvent.find(".n2schema_field_reference").each(function(){_this._installReference($elem,$(this))}),$divEvent.find(".n2schema_field_geometry").each(function(){_this._installGeometry($elem,$(this))}),$divEvent.find(".n2schema_field_custom").each(function(){_this._installCustomType($elem,$(this),_this.obj,_this.callback)}),$divEvent.click(function(e){var $clicked=$(e.target),classString=$clicked.attr("class"),classNames=null;classNames=classString?classString.split(" "):[];var classInfo=parseClassNames(classNames);if($clicked.hasClass("n2schema_array_add")){var newType=$clicked.attr("n2_array_new_type"),ary=classInfo.selector.getValue(_this.obj);if(!ary){var parentSelector=classInfo.selector.getParentSelector(),parentObj=void 0;parentSelector&&(parentObj=parentSelector.getValue(_this.obj)),parentObj&&"object"==typeof parentObj&&(classInfo.selector.setValue(_this.obj,[]),ary=classInfo.selector.getValue(_this.obj))}if(ary&&$n2.isArray(ary)){var newItem="";if("reference"===newType)newItem=null;else if("date"===newType)newItem=null;else if("string"===newType)newItem="";else if("localized"===newType){newItem={nunaliit_type:"localized"};var locale=$n2.l10n.getLocale(),lang=locale.lang;newItem[lang]=""}else if("textarea"===newType)newItem="";else if(newType)try{eval("newItem = "+newType)}catch(e){$n2.log("Error creating a new item: "+e)}ary.push(newItem)}_this.refresh($elem),_this.callback(_this.obj,classInfo.selector.selectors,ary)}else if($clicked.hasClass("n2schema_array_item_delete")){var itemIndex=1*classInfo.selector.getKey(),parentSelector=classInfo.selector.getParentSelector(),ary=parentSelector.getValue(_this.obj);ary.splice(itemIndex,1);var $item=$clicked.parents(".n2schema_array_item").first();$item.remove(),_this.callback(_this.obj,classInfo.selector.selectors,ary)}else if($clicked.hasClass("n2schema_array_item_up")){var itemIndex=1*classInfo.selector.getKey();if(itemIndex>0){var parentSelector=classInfo.selector.getParentSelector(),ary=parentSelector.getValue(_this.obj),removedItems=ary.splice(itemIndex,1);ary.splice(itemIndex-1,0,removedItems[0]);var $item=$clicked.parents(".n2schema_array_item").first(),$prevItem=$item.prev();$item.insertBefore($prevItem),_this.callback(_this.obj,classInfo.selector.selectors,ary)}}else if($clicked.hasClass("n2schema_array_item_down")){var itemIndex=1*classInfo.selector.getKey(),parentSelector=classInfo.selector.getParentSelector(),ary=parentSelector.getValue(_this.obj);if(itemIndex<ary.length-1){var removedItems=ary.splice(itemIndex,1);ary.splice(itemIndex+1,0,removedItems[0]);var $item=$clicked.parents(".n2schema_array_item").first(),$nextItem=$item.next();$item.insertAfter($nextItem),_this.callback(_this.obj,classInfo.selector.selectors,ary)}}else if($clicked.hasClass("n2schema_referenceDelete")){var referenceKey=classInfo.selector.getKey(),parentSelector=classInfo.selector.getParentSelector(),parentObj=parentSelector.getValue(_this.obj);parentObj[referenceKey]&&(delete parentObj[referenceKey],_this.refresh($elem),_this.callback(_this.obj,classInfo.selector.selectors,null))}else $clicked.hasClass("n2schema_help_date")?$n2.help.ToggleHelp("dates",$clicked):$clicked.hasClass("n2schema_help_wiki")&&$n2.help.ToggleHelp("wiki",$clicked)})}}},_setHtml:function(e){if(e){for(var t=0,i=this.extensions.length;t<i;++t){this.extensions[t]._setHtml(e)}var n=this.schema.formTemplate__compiled;if(!n){var r=this.schema.formTemplate;r&&(n=Handlebars.compile(r,{trackIds:!0}),this.schema.formTemplate__compiled=n)}n&&(e[HTML]=n(e))}},_installHandlers:function(e,t,i,n){var r=this,o=parseClassNames(t.attr("class").split(" ")),s=t.prop("nodeName");if("string"==typeof s&&(s=s.toLowerCase()),"reference"===o.type&&o.selector){var a=$("<span>").attr("nunaliit-selector",o.selector.encodeForDomAttribute());return t.after(a),t.remove(),void this._installReference(e,a)}var l=o.selector;if(l){var c=l.getParentSelector(),d=l.getKey(),u=this._createChangeHandler(i,l,c,o.type,function(t,i,s){"reference"===o.type&&r.refresh(e),n(t,i.selectors,s)}),h=this._createChangeHandler(i,l,c,o.type,function(e,t,i){});t.change(u),"date"!==o.type&&t.keyup(h);var p=l.getValue(i);if("checkbox"===t.attr("type"))p?t.attr("checked",!0):t.attr("checked",!1);else if("date"===o.type)p&&(p=p.date),t.val(p),t.attr("n2OriginalDate",p),t.datepicker&&t.datepicker({dateFormat:"yy-mm-dd",gotoCurrent:!0,changeYear:!0,constrainInput:!1,onSelect:function(){var e=$(this);u.call(e)}});else if("numeric"===o.type)t.val(p),t.keydown(function(e){var t=$(this),i=t.val();t.attr("n2Numeric",i)}),t.keyup(function(e){var t=$(this),i=t.attr("n2Numeric"),n=t.val();return""===n||"+"===n||"-"===n||$n2.utils.isNumber(n)||46===e.keyCode||8===e.keyCode||9===e.keyCode||27===e.keyCode||65===e.keyCode&&e.ctrlKey||e.keyCode>=35&&e.keyCode<=36||37===e.keyCode||39===e.keyCode||e.keyCode>=16&&e.keyCode<=18||t.val(i),!0});else if("layers"===o.type){$n2.isArray(p)&&(p=p.join(",")),t.val(p);var f=this.functionMap.getLayers;f&&t.is("input")&&t.focus(function(e,n){if(n&&n.inhibitCallback)return!0;var r=l.getValue(i);return f({currentLayers:r,onSelected:function(e){var n=c.getValue(i);n&&(n[d]=e,e&&0!==e.length||delete n[d]),e&&(t.val(e.join(",")),u.call(t)),t.trigger("focus",{inhibitCallback:!0})},onReset:function(){t.trigger("focus",{inhibitCallback:!0})}}),!0})}else t.val(p);if("select"===s){var m=p;null==m&&(m="");var v=t[0].selectedOptions;if(v){for(var g=!1,y=0,_=v.length;y<_;++y){var S=v.item(y);$(S).attr("value")===m&&(g=!0)}g||($("<option>").attr("value",m).attr("disabled","disabled").text(m).prependTo(t),t.val(p))}}}},_installReference:function(e,t){var i=this,n=t.attr("nunaliit-selector"),r=$n2.objectSelector.decodeFromDomAttribute(n),o=r.getParentSelector(),s=r.getKey(),a=t.attr("n2-search-func"),l=r.getValue(this.obj);if(l&&l.doc)t.empty(),$("<span>").addClass("n2s_briefDisplay").text(l.doc).appendTo(t),$("<div>").addClass("n2schema_referenceDelete").appendTo(t).click(function(){var t=o.getValue(i.obj);$n2.isArray(t)&&"number"==typeof s&&t.length>s?t[s]&&(t.splice(s,1),i.refresh(e),i.callback(i.obj,r.selectors,null)):t[s]&&(delete t[s],i.refresh(e),i.callback(i.obj,r.selectors,null))});else{t.empty();var c=$("<input>").attr("type","text").appendTo(t),d=function(t){var n=$(this),a=o.getValue(i.obj);if(a){var l=n.val(),c=null;null===l||""===l?a[s]&&delete a[s]:(a[s]||(a[s]={}),a[s].nunaliit_type="reference",a[s].doc=l,c=a[s]),i.refresh(e),i.callback(i.obj,r.selectors,c)}};c.change(d);var u={fn:this.functionMap.getDocumentId,args:[]};if(a&&$n2.docFnCall)try{var h=$n2.docFnCall.parse(a);if(h){var p=h.getValue({doc:i.obj,funcMap:this.functionMap});p&&(u=p)}}catch(e){$n2.logError("Error while processing focus handler "+a,e)}u&&c.focus(function(e,t){var n=$(this);return!(!t||!t.inhibitCallback)||(window.setTimeout(function(){u.fn({contextDoc:i.obj,args:u.args,onSelected:function(e){var t=o.getValue(i.obj);t&&(t[s]||(t[s]={}),t[s].nunaliit_type="reference",t[s].doc=e,n.val(e),d.call(n),n.trigger("focus",{inhibitCallback:!0}))},onReset:function(){n.trigger("focus",{inhibitCallback:!0})}})},0),!0)})}},_installGeometry:function(e,t){var i=this,n=t.attr("nunaliit-selector"),r=$n2.objectSelector.decodeFromDomAttribute(n),o=r.getParentSelector(),s=r.getKey(),a=r.getValue(this.obj);a&&a.wkt?t.val(a.wkt):t.val(""),t.change(function(t){var n=$(this),a=o.getValue(i.obj);if(a){var l=n.val(),c=null;null===l||""===l?a[s]&&delete a[s]:(a[s]||(a[s]={}),a[s].nunaliit_type="geometry",a[s].wkt=l,a[s].bbox&&delete a[s].bbox,a[s].simplified&&delete a[s].simplified,c=a[s]),i.refresh(e),i.callback(i.obj,r.selectors,c)}})},_installCustomType:function(e,t,i,n){var r=this,o=t.attr("n2-custom-type"),s=t.attr("nunaliit-selector"),a=null;if(s&&(a=$n2.objectSelector.decodeFromDomAttribute(s)),"string"==typeof o){var l=customFieldHandlers[o];if(l){var c=void 0;a&&i&&(c=a.getValue(i)),l({elem:t,doc:i,obj:c,selector:a,customType:o,callbackFn:function n(s,l){if(l){t.empty();var c=customFieldHandlers[o];if(c){var d=void 0;a&&i&&(d=a.getValue(i)),c({elem:t,doc:i,obj:d,selector:a,customType:o,callbackFn:n,functionMap:r.functionMap})}}else r.refresh(e);r.callback(i,a,s)},functionMap:r.functionMap})}else t.attr("nunaliit-error",'No handler found for custom type: "'+o+'"')}else t.attr("nunaliit-error","Custom type not provided")},_createChangeHandler:function(e,t,i,n,r){return function(o){var s=$(this),a=i.getValue(e),l=t.getKey();a||"localized"===n&&(d=s.val())&&(i.setValue(e,{nunaliit_type:"localized"}),a=i.getValue(e));if(a){var c=!0;if("checkbox"===s.attr("type"))if(s.is(":checked"))var d=!0;else d=!1;else if("reference"===n)null===(d=s.val())||""===d?(c=!1,a[l]&&delete a[l]):(a[l]?a[l].nunaliit_type="reference":a[l]={nunaliit_type:"reference"},a=a[l],l="doc");else if("localized"===n){d=s.val(),a[l]=d,c=!1;var u=!0;for(var h in a)"nunaliit_type"===h||a[h]&&(u=!1);u&&i.removeValue(e)}else if("date"===n){c=!1;var p=s.val();if(p)if(""===$n2.trim(p))a[l]&&(a[l]=null);else{var f=null;try{f=$n2.date.parseUserDate(p)}catch(o){var m=_loc("Invalid date: {err}",{err:o});$n2.log(m),alert(m);var v=s.attr("n2OriginalDate");s.val(v)}f&&(a[l]=f.getDocumentStructure())}else a[l]&&(a[l]=null);d=a[l]}else if("numeric"===n)d=s.val(),0==$n2.utils.isNumber(d)?c=!1:d*=1;else if("layers"===n)if(null===(d=s.val())||""===d)c=!1,a[l]&&delete a[l];else{var g=0;for(o=(d=d.split(",")).length;g<o;++g)d[g]=$n2.trim(d[g])}else d=s.val();c&&(a[l]=d),r(e,t.selectors,d)}}}});$n2.schema={Schema:Schema,SchemaRepository:SchemaRepository,Display:Display,Form:Form,registerCustomFieldHandler:registerCustomFieldHandler}}(jQuery,nunaliit2),function(e){var t={},i={},n=e.Class({logging:null,loggingIncludesMessage:null,loggingHandleMap:null,loggingTypeMap:null,listeners:null,handles:null,dispatching:null,queue:null,initialize:function(t){var i=e.extend({logging:!1,loggingIncludesMessage:!1,loggingHandles:null,loggingTypes:null},t),n=this;this.logging=i.logging,this.loggingIncludesMessage=i.loggingIncludesMessage,this.loggingHandleMap={},e.isArray(i.loggingHandles)&&i.loggingHandles.forEach(function(e){"string"==typeof e&&(n.loggingHandleMap[e]=!0)}),this.loggingTypeMap={},e.isArray(i.loggingTypes)&&i.loggingTypes.forEach(function(e){"string"==typeof e&&(n.loggingTypeMap[e]=!0)}),this.listeners={},this.handles={},this.dispatching=!1,this.queue=[]},getHandle:function(e){var i=this.handles[e];return i||(i={dispatch:!0,name:e,receives:{},sends:{},_marker:t},this.handles[e]=i),i},isHandle:function(e){return"object"==typeof e&&e._marker===t},isAddress:function(e){return"object"==typeof e&&e._marker===i},register:function(t,n,r){if("string"==typeof t&&(t=this.getHandle(t)),!this.isHandle(t))throw new Error("DispatchService.register: invalid handle");if("string"!=typeof n)throw new Error("DispatchService.register: type must be a string");if("function"!=typeof r)throw new Error("DispatchService.register must provide a function");this.listeners[n]||(this.listeners[n]=[]);var o={type:n,id:e.getUniqueId(),_marker:i};return this.listeners[n].push({handle:t,fn:r,address:o}),t.receives[n]=!0,o},deregister:function(e){if(!this.isAddress(e))throw new Error("DispatchService.deregister: invalid address");var t=e.type,i=e.id;if(t&&i){var n=this.listeners[t];if(n){for(var r=-1,o=0,s=n.length;o<s;++o){var a=n[o];if(a.address&&a.address.id===i){r=o;break}}r>=0&&this.listeners[t].splice(r,1)}}},isEventTypeRegistered:function(e){var t=this.listeners[e];return!!(t&&t.length>0)},send:function(e,t){if(t.time=Date.now(),"string"==typeof e&&(e=this.getHandle(e)),this.dispatching)this.queue.push({h:e,m:t});else for(this._sendImmediate(e,t);this.queue.length>0;){var i=this.queue.splice(0,1)[0];this._sendImmediate(i.h,i.m)}},_sendImmediate:function(t,i){var n=!1;this.logging?n=!0:this.loggingHandleMap[t.name]?n=!0:this.loggingTypeMap[i.type]&&(n=!0);var r=this.loggingIncludesMessage,o=i.type;t.sends[o]=!0,this.dispatching=!0;var s=this.listeners[o];if(s)for(var a=s.slice(0),l=0,c=a.length;l<c;++l){var d=a[l];if(n){var u="";i.time&&(u=i.time/1e3+" "),r?e.log(u+t.name+" >"+o+"> "+d.handle.name,i):e.log(u+t.name+" >"+o+"> "+d.handle.name)}try{d.fn(i,d.address,this)}catch(c){this._reportError(c,i)}}else void 0===s&&(s=[],this.listeners[o]=s);(!s||s.length<1)&&n&&(r?e.log(t.name+" >"+o+" not observed",i):e.log(t.name+" >"+o+" not observed")),this.dispatching=!1},_reportError:function(t,i){e.log("Error while dispatching "+i.type+": "+t),t.stack&&e.log("Stack: "+t.stack)},synchronousCall:function(e,t){t.time=Date.now(),"string"==typeof e&&(e=this.getHandle(e));var i=this.dispatching;if(this._sendImmediate(e,t),this.dispatching=i,!i)for(;this.queue.length>0;){var n=this.queue.splice(0,1)[0];this._sendImmediate(n.h,n.m)}}});e.dispatch={Dispatcher:n}}(nunaliit2),function(e,t){var i=t.Class({divId:null,initialize:function(e){},reportError:function(e){this.log(e)},log:function(e){throw new Error("Subclasses must implement function log()")}}),n=t.Class("HtmlLogger",i,{divId:null,initialize:function(n){var r=t.extend({elem:null},n);i.prototype.initialize.apply(this,arguments);var o=e(r.elem).addClass("n2logger_html");this.divId=t.utils.getElementIdentifier(o),t.log("HtmlLogger",this)},reportError:function(t){var i=this._getLogsDiv(),n=e('<div class="error"></div>');n.text(t),i.append(n)},log:function(t,i){var n=this._getLogsDiv(),r=e('<div class="log"></div>');r.text(t),i&&i.preserveSpaces&&r.css({"white-space":"pre"}),n.append(r)},clear:function(){this._getLogsDiv().empty()},_getLogsDiv:function(){return e("#"+this.divId)}}),r=t.Class("CustomLogger",i,{logFn:null,reportErrorFn:null,initialize:function(e){var n=t.extend({logFn:null,reportErrorFn:null},e);if(i.prototype.initialize.apply(this,arguments),this.logFn=n.logFn,this.reportErrorFn=n.reportErrorFn,"function"!=typeof this.logFn)throw new Error("In CustomLogger, a function must be provided for logFn");this.logFn=this.logFn,"function"==typeof this.reportErrorFn&&(this.reportError=this.reportErrorFn),t.log("CustomLogger",this)}});t.logger={Logger:i,HtmlLogger:n,CustomLogger:r}}(jQuery,nunaliit2),function(e){var t=e.Class("Geometry",{}),i=e.Class("Point",t,{x:void 0,y:void 0,z:void 0,initialize:function(t){var i=e.extend({x:void 0,y:void 0,z:void 0},t);this.x=i.x,this.y=i.y,this.z=i.z},toString:function(){return"POINT("+this.x+" "+this.y+(void 0!==this.z?" "+this.z:"")+")"}}),n=e.Class("LineString",t,{points:void 0,initialize:function(t){var i=e.extend({points:void 0},t),n=this;this.points=[],e.isArray(i.points)&&i.points.forEach(function(e){n.points.push(e)})},getPoints:function(){return this.points},toString:function(){var e=[];e.push("LINESTRING(");var t=!0;return this.points.forEach(function(i){t?t=!1:e.push(","),e.push(i.x),e.push(" "),e.push(i.y),void 0!==i.z&&(e.push(" "),e.push(i.z))}),e.push(")"),e.join("")}}),r=e.Class("Polygon",t,{linearRings:void 0,initialize:function(t){var i=e.extend({linearRings:void 0},t),n=this;this.linearRings=[],e.isArray(i.linearRings)&&i.linearRings.forEach(function(e){n.linearRings.push(e)})},getLinearRings:function(){return this.linearRings},toString:function(){var e=[];e.push("POLYGON(");var t=!0;return this.linearRings.forEach(function(i){t?t=!1:e.push(","),e.push("(");var n=i.getPoints(),r=!0;n.forEach(function(t){r?r=!1:e.push(","),e.push(t.x),e.push(" "),e.push(t.y),void 0!==t.z&&(e.push(" "),e.push(t.z))}),e.push(")")}),e.push(")"),e.join("")}}),o=e.Class("GeometryCollection",t,{geometries:void 0,initialize:function(t){var i=e.extend({geometries:void 0},t),n=this;this.geometries=[],e.isArray(i.geometries)&&i.geometries.forEach(function(e){n.geometries.push(e)})},getGeometries:function(){return this.geometries},toString:function(){var e=[];e.push("GEOMETRYCOLLECTION(");var t=!0;return this.geometries.forEach(function(i){t?t=!1:e.push(","),e.push(i.toString())}),e.push(")"),e.join("")}}),s=e.Class("GeometryAssembly",t,{getSize:function(){throw new Error("Subclasses to GeometryAssembly must implements getSize()")},getGeometries:function(){throw new Error("Subclasses to GeometryAssembly must implements getGeometries()")}}),a=e.Class("MultiPoint",s,{points:void 0,initialize:function(t){var i=e.extend({points:void 0},t),n=this;this.points=[],e.isArray(i.points)&&i.points.forEach(function(e){n.points.push(e)})},getSize:function(){return points.length},getGeometries:function(){return this.points},toString:function(){var e=[];e.push("MULTIPOINT(");var t=!0;return this.points.forEach(function(i){t?t=!1:e.push(","),e.push("("),e.push(i.x),e.push(" "),e.push(i.y),void 0!==i.z&&(e.push(" "),e.push(i.z)),e.push(")")}),e.push(")"),e.join("")}}),l=e.Class("MultiLineString",s,{lineStrings:void 0,initialize:function(t){var i=e.extend({points:void 0},t),n=this;this.lineStrings=[],e.isArray(i.lineStrings)&&i.lineStrings.forEach(function(e){n.lineStrings.push(e)})},getSize:function(){return lineStrings.length},getGeometries:function(){return this.lineStrings},toString:function(){var e=[];e.push("MULTILINESTRING(");var t=!0;return this.lineStrings.forEach(function(i){t?t=!1:e.push(","),e.push("(");var n=i.getPoints(),r=!0;n.forEach(function(t){r?r=!1:e.push(","),e.push(t.x),e.push(" "),e.push(t.y),void 0!==t.z&&(e.push(" "),e.push(t.z))}),e.push(")")}),e.push(")"),e.join("")}}),c=e.Class("MultiPolygon",s,{polygons:void 0,initialize:function(t){var i=e.extend({polygons:void 0},t),n=this;this.polygons=[],e.isArray(i.polygons)&&i.polygons.forEach(function(e){n.polygons.push(e)})},getSize:function(){return polygons.length},getGeometries:function(){return this.polygons},toString:function(){var e=[];e.push("MULTIPOLYGON(");var t=!0;return this.polygons.forEach(function(i){t?t=!1:e.push(","),e.push("(");var n=i.getLinearRings(),r=!0;n.forEach(function(t){r?r=!1:e.push(","),e.push("(");var i=t.getPoints(),n=!0;i.forEach(function(t){n?n=!1:e.push(","),e.push(t.x),e.push(" "),e.push(t.y),void 0!==t.z&&(e.push(" "),e.push(t.z))}),e.push(")")}),e.push(")")}),e.push(")"),e.join("")}}),d=e.Class({str:void 0,index:void 0,initialize:function(t){var i=e.extend({str:void 0},t);if("string"!=typeof i.str)throw new Error("CharacterStream must be initialized with a string");this.str=i.str,this.index=0},getPosition:function(){return this.index},setPosition:function(e){if(e>this.str.length)throw new Error("CharacterStream.setPosition() index is out of bounds");this.index=e},atEnd:function(){return this.index>=this.str.length},peekChar:function(){if(this.index<this.str.length)return this.str[this.index]},getChar:function(){if(this.index<this.str.length){var e=this.str[this.index];return++this.index,e}},startsWith:function(e,t){if(this.str.length-this.index<e.length)return!1;var i=this.str.substr(this.index,e.length);return t?e.toLowerCase()===i.toLowerCase():e===i},skipCharacters:function(e){if(this.index+e>this.str.length)throw new Error("CharacterStream.skipCharacters() out of bounds");this.index+=e},skipSpaces:function(){for(;this.index<this.str.length;){if(!e(this.str[this.index]))break;++this.index}function e(e){return" "===e||"\n"===e||"\r"===e}}}),u=e.Class({initialize:function(){},parseWkt:function(e){var t=new d({str:e}),i=this._parseGeometry(t);if(t.skipSpaces(),!t.atEnd())throw new Error("Expected end of stream at position: "+t.getPosition());return i},_parseGeometry:function(e){if(e.skipSpaces(),e.startsWith("POINT",!0)){if(e.skipCharacters("POINT".length),e.skipSpaces(),"("!==(p=e.getChar()))throw new Error('Expected character "(" at position: '+e.getPosition());e.skipSpaces();var t=this._parsePoint(e);if(e.skipSpaces(),")"!==(p=e.getChar()))throw new Error('Expected character ")" at position: '+e.getPosition());return t}if(e.startsWith("MULTIPOINT",!0)){var i=[];if(e.skipCharacters("MULTIPOINT".length),e.skipSpaces(),"("!==(p=e.getChar()))throw new Error('Expected character "(" at position: '+e.getPosition());e.skipSpaces();for(var n=!1;!n;){if("("===(p=e.peekChar())){e.getChar();t=this._parsePoint(e);if(i.push(t),e.skipSpaces(),")"!==e.getChar())throw new Error('Expected character ")" at position: '+e.getPosition())}else{t=this._parsePoint(e);i.push(t)}if(e.skipSpaces(),")"===(p=e.peekChar())&&(e.getChar(),n=!0),!n){if(e.skipSpaces(),","!==e.getChar())throw new Error('Expected character "," or ")" at position: '+e.getPosition());e.skipSpaces()}}return new a({points:i})}if(e.startsWith("LINESTRING",!0))return e.skipCharacters("LINESTRING".length),e.skipSpaces(),s=this._parseLineString(e);if(e.startsWith("MULTILINESTRING",!0)){if(e.skipCharacters("MULTILINESTRING".length),e.skipSpaces(),"("!==(p=e.getChar()))throw new Error('Expected character "(" at position: '+e.getPosition());e.skipSpaces();var r=[];for(n=!1;!n;){var s=this._parseLineString(e);if(r.push(s),e.skipSpaces(),","===(p=e.peekChar()))e.getChar(),e.skipSpaces();else{if(")"!==p)throw new Error('Expected character "," or ")" at position: '+e.getPosition());e.getChar(),n=!0}}return new l({lineStrings:r})}if(e.startsWith("POLYGON",!0))return e.skipCharacters("POLYGON".length),u=this._parsePolygon(e);if(e.startsWith("MULTIPOLYGON",!0)){if(e.skipCharacters("MULTIPOLYGON".length),e.skipSpaces(),"("!==(p=e.getChar()))throw new Error('Expected character "(" at position: '+e.getPosition());var d=[];for(n=!1;!n;){var u=this._parsePolygon(e);if(d.push(u),e.skipSpaces(),","===(p=e.peekChar()))e.getChar(),e.skipSpaces();else{if(")"!==p)throw new Error('Expected character "," or ")" at position: '+e.getPosition());e.getChar(),n=!0}}return new c({polygons:d})}if(e.startsWith("GEOMETRYCOLLECTION",!0)){if(e.skipCharacters("GEOMETRYCOLLECTION".length),e.skipSpaces(),"("!==(p=e.getChar()))throw new Error('Expected character "(" at position: '+e.getPosition());var h=[];for(n=!1;!n;){var p,f=this._parseGeometry(e);if(h.push(f),e.skipSpaces(),","===(p=e.peekChar()))e.getChar(),e.skipSpaces();else{if(")"!==p)throw new Error('Expected character "," or ")" at position: '+e.getPosition());e.getChar(),n=!0}}return new o({geometries:h})}throw new Error("Unexpected character at position: "+e.getPosition())},_parsePolygon:function(e){var t=[];if(e.skipSpaces(),"("!==(n=e.getChar()))throw new Error('Expected character "(" at position: '+e.getPosition());e.skipSpaces();for(var i=!1;!i;){var n,o=this._parseLineString(e);if(o.getPoints().length<3)throw new Error("LinearRing must have at least 3 points, at position: "+e.getPosition());if(t.push(o),e.skipSpaces(),","===(n=e.peekChar()))e.getChar(),e.skipSpaces();else{if(")"!==n)throw new Error('Expected character "," or ")" at position: '+e.getPosition());e.getChar(),i=!0}}return new r({linearRings:t})},_parseLineString:function(e){var t=[];e.skipSpaces();var i=e.getChar();if("("!==i)throw new Error('Expected character "(" at position: '+e.getPosition());for(var r=!1;!r;){var o=this._parsePoint(e);if(t.push(o),e.skipSpaces(),")"===(i=e.peekChar())&&(e.getChar(),r=!0),!r){if(e.skipSpaces(),","!==e.getChar())throw new Error('Expected character "," or ")" at position: '+e.getPosition());e.skipSpaces()}}if(t.length<2)throw new Error("LineString requires more than one point: "+e.getPosition());return new n({points:t})},_parsePoint:function(e){e.skipSpaces();var t=this._parseNumber(e);e.skipSpaces();var n,r=this._parseNumber(e),o=e.getPosition();e.skipSpaces();try{n=this._parseNumber(e)}catch(t){e.setPosition(o),n=void 0}return new i({x:t,y:r,z:n})},_parseNumber:function(e){var t=e.getPosition(),i=1,n=e.peekChar();"-"===n&&(e.getChar(),i=-1,n=e.peekChar());var r=0;if(!("0"<=n&&"9">=n))throw e.setPosition(t),new Error("Number expected at position: "+t);for(;"0"<=n&&"9">=n;){e.getChar(),r=10*r+1*(n-"0"),n=e.peekChar()}if("."===n){e.getChar();var o=1;for(n=e.peekChar();"0"<=n&&"9">=n;){e.getChar(),r+=(o/=10)*(n-"0"),n=e.peekChar()}}return i*r}});e.geometry={Point:i,LineString:n,Polygon:r,GeometryCollection:o,MultiPoint:a,MultiLineString:l,MultiPolygon:c,WktParser:u,compareGeometries:function e(t,s){if(t===s)return 0;if(!t)return-1;if(!s)return 1;if(t.getClass()!==s.getClass()){var d=t._classname,u=s._classname;if(d===u)return 0;if(!d)return-1;if(!u)return 1;if(d<u)return-1;if(d>u)return 1}if(t.getClass()===i)return m(t,s);if(t.getClass()===a)return h=s,p=t.getGeometries(),f=h.getGeometries(),g(p,f);var h,p,f;if(t.getClass()===n)return v(t,s);if(t.getClass()===l)return function(e,t){var i=e.getGeometries(),n=t.getGeometries();return g(i,n)}(t,s);if(t.getClass()===r)return function(e,t){var i=e.getLinearRings(),n=t.getLinearRings();if(i.length!==n.length)return i.length-n.length;for(var r=0,o=i.length;r<o;++r){var s=i[r],a=n[r],l=v(s,a);if(0!==l)return l}return 0}(t,s);if(t.getClass()===c)return function(e,t){var i=e.getGeometries(),n=t.getGeometries();return g(i,n)}(t,s);if(t.getClass()===o)return g(t.getGeometries(),s.getGeometries());throw new Error("Unable to compare geometries: "+t._classname+" "+s._classname);function m(e,t){if(e.x!==t.x)return e.x-t.x;if(e.y!==t.y)return e.y-t.y;if(e.z!==t.z){if("number"==typeof e.z&&"number"==typeof t.z)return e.z-t.z;if(void 0===typeof e.z)return-1;if(null===typeof e.z)return-1;if(void 0===typeof t.z)return 1;if(null===typeof t.z)return 1}return 0}function v(e,t){var i=e.getPoints(),n=t.getPoints();if(i.length!==n.length)return i.length-n.length;for(var r=0,o=i.length;r<o;++r){var s=m(i[r],n[r]);if(0!==s)return s}return 0}function g(t,i){if(t.length!==i.length)return t.length-i.length;var n=t.slice(),r=i.slice();n.sort(e),r.sort(e);for(var o=0,s=n.length;o<s;++o){var a=e(n[o],r[o]);if(0!==a)return a}return 0}}}}(nunaliit2),function(e){var t="n2.analytics",i=e.Class({dispatchService:null,initialize:function(i){var n=e.extend({dispatchService:null},i),r=this;if(this.dispatchService=n.dispatchService,this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(t,"start",o),this.dispatchService.register(t,"selected",o)}},_sendEvent:function(e,t){if("function"==typeof ga){var i={hitType:"event",eventCategory:"nunaliit",eventAction:e};"number"==typeof t?i.eventValue=t:"string"==typeof t&&(i.eventLabel=t),ga("send",i)}},_handle:function(e,i,n){if("start"===e.type){var r={type:"moduleGetCurrent"};this.dispatchService.synchronousCall(t,r),r.moduleId&&this._sendEvent("module",r.moduleId)}else"selected"===e.type&&(e.docId?this._sendEvent("selected",e.docId):e.doc&&e.doc._id&&this._sendEvent("selected",e.doc._id))}});e.analytics={AnalyticsService:i}}(nunaliit2),function(e){var t=e.Class({custom:null,initialize:function(e){void 0===window.nunaliit_custom&&(window.nunaliit_custom={}),this.custom=window.nunaliit_custom,this._check()},setOption:function(e,t){this._check(),this.custom.options[e]=t,this.custom.info[e]?++this.custom.info[e].writes:this.custom.info[e]={reads:0,writes:1}},getOption:function(e,t){return this._check(),this.custom.info[e]?++this.custom.info[e].reads:this.custom.info[e]={reads:1,writes:0},void 0===this.custom.options[e]?t:this.custom.options[e]},updateOption:function(e,t){var i=this.getOption(t);void 0!==i&&(e[t]=i)},_check:function(){this.custom.options||(this.custom.options={}),this.custom.info||(this.custom.info={})}});e.custom={CustomService:t}}(nunaliit2),function(e){var t=e.Class({dispatchService:null,initialize:function(t){var i=e.extend({dispatchService:void 0},t),n=this;if(this.dispatchService=i.dispatchService,!this.dispatchService)throw new Error("When creating an instance of CustomType, the dispatchService must be provided");var r=this.getTypeName();this.dispatchService.register("n2.customType","showCustom",function(e,t,i){n._handleShowCustom(e,t,i)}),e.schema.registerCustomFieldHandler({customType:r,handler:function(e){n.fieldHandler(e)}})},getTypeName:function(){throw new Error("Subclasses of CustomType must implement getTypeName()")},show:function(t){e.extend({elem:void 0,doc:void 0,selector:void 0,showService:void 0,m:void 0},t)},fieldHandler:function(t){e.extend({elem:null,doc:null,obj:null,selector:null,customType:null,callbackFn:null},t)},_handleShowCustom:function(e,t,i){var n=e.elem,r=e.doc,o=e.customType,s=e.selector,a=e.showService;this.getTypeName()==o&&this.show({elem:n,doc:r,selector:s,showService:a,m:e})}});e.customType={CustomType:t}}(nunaliit2),function(e,t){var i="x",n="m",r="s";function o(e){var i=JSON.stringify(e);return t.Base64.encode(i)}function s(e){return e.s||(e.s=(new Date).getTime()),e}function a(){var e=window.location.hash;return e&&(e=e.substr(1)),e}function l(e){var o=void 0;if("nostate"===e);else if(e&&""!==e){var s=function(e){var i=void 0;try{var n=t.Base64.decode(e);i=JSON.parse(n)}catch(e){}return i}(e);if(s&&i===s.t)o={type:"userSelect",docId:s.i};else if(s&&n===s.t){var a=function(e){var i=t.storage.getSessionStorage().getItem("n2_historyHash");if(!i)return{};var n=null;try{n=JSON.parse(i)}catch(e){t.log("Error parsing history hash(1):"+i),n={}}n||(n={});var r=n[""+e];if(!r)return{};return r}(s.s).docIds;a||(a=[]),o={type:"userSelect",docIds:a}}else if(s&&r===s.t){o={type:"searchInitiate",searchLine:s.l}}}else o={type:"unselected"};return o}function c(e){return l(new t.url.Url({url:e}).getHash())}var d=t.Class({sessionId:null,dispatchService:null,entries:null,currentEntry:null,lastUpdated:null,lastHref:null,lastHistorySize:null,retrievedFromStorage:null,hint:null,initialize:function(e){var i=t.extend({sessionId:void 0,dispatchService:null},e),n=this;if(this.sessionId=i.sessionId,this.dispatchService=i.dispatchService,this.entries=[],this.currentEntry=void 0,this.lastHref=void 0,this.lastHistorySize=void 0,this.lastUpdated=void 0,this.retrievedFromStorage=!1,this.hint=void 0,this.sessionId||(this.sessionId="s"+(new Date).getTime()),this.dispatchService){var r=function(e,t,i){n._handle(e,t,i)},o="n2.history.History";this.dispatchService.register(o,"start",r),this.dispatchService.register(o,"historyHashModified",r),this.dispatchService.register(o,"historyGetState",r),this.dispatchService.register(o,"historyBack",r),this.dispatchService.register(o,"historyForward",r)}},saveToStorage:function(){function e(e){var t=[];for(var i in e){var n=e[i];t.push({s:i,h:n})}return t.sort(function(e,t){e.h.lastUpdated,t.h.lastUpdated;return 0}),t.length>1&&(delete e[i=t[0].s],!0)}for(var i={entries:[],lastUpdated:this.lastUpdated},n=0,r=this.entries.length;n<r;++n){var o=this.entries[n],s={h:o.href,i:o.historySize};i.entries.push(s)}var a=t.storage.getSessionStorage(),l=a.getItem("n2_history"),c=null;try{c=JSON.parse(l)}catch(s){c={}}c||(c={}),c[this.sessionId]=i;for(var d=JSON.stringify(c);d.length>2e6;){if(!e(c))break;d=JSON.stringify(c)}a.setItem("n2_history",d)},_reloadFromJson:function(e){if(this.entries=[],e&&e.entries)for(var t=0,i=e.entries.length;t<i;++t){var n=e.entries[t],r={href:n.h,historySize:n.i,event:c(n.h)};this.entries.push(r)}this.lastUpdated=e.lastUpdated},_reloadFromStorage:function(e,i){var n=!1;if(!this.retrievedFromStorage){for(var r=function(){var e=t.storage.getSessionStorage().getItem("n2_history"),i=null;try{i=JSON.parse(e)}catch(e){i={}}i||(i={});var n=[];for(var r in i){var o=i[r],s=new d({sessionId:r});s._reloadFromJson(o),n.push(s)}return n}(),o=0,s=void 0,a=void 0,l=0,c=r.length;l<c;++l){var u=r[l];(p=u._entryWithHref(e,i))&&(++o,s=u,a=p)}if(1===o){if(this.sessionId===s.sessionId);else{this.sessionId=s.sessionId,this.lastUpdated=s.lastUpdated;var h=[];for(l=0,c=s.entries.length;l<c;++l){var p=s.entries[l];h.push(p)}this.entries=h,this.currentEntry=a,n=!0}this.retrievedFromStorage=!0}}return n},_entryWithHref:function(e,t){for(var i=void 0,n=0,r=this.entries.length;n<r;++n){var o=this.entries[n];o.href===e&&o.historySize<=t&&(i=o)}return i},_indexFromEntry:function(e){for(var t=void 0,i=0,n=this.entries.length;i<n;++i){this.entries[i]===e&&(t=i)}return t},_handle:function(e,t,i){if(e)if("historyHashModified"===e.type)this._checkHistoryChange();else if("start"===e.type)this._checkHistoryChange();else if("historyGetState"===e.type){var n=this._computeState();e.state=n}else"historyBack"===e.type?this.hint="back":"historyForward"===e.type&&(this.hint="forward")},_checkHistoryChange:function(){var e=void 0;window&&window.history&&(e=window.history.length);var t=window.location.href;this.lastHref!==t&&this._historyChanged(t,e)},_historyChanged:function(e,i){function n(e,t,i){for(var n={href:t,historySize:i,event:c(t)},r=void 0,o=0,s=e.entries.length;o<s;++o){if(e.entries[o].historySize===i){r=o;break}}"number"==typeof r&&(e.entries=e.entries.slice(0,r)),e.entries.push(n),e.currentEntry=n}if(this._reloadFromStorage(e,i))t.log("history reloaded from storage");else if(this.lastHistorySize!==i)n(this,e,i);else{for(var r=[],o=void 0,s=0,a=this.entries.length;s<a;++s){var l=this.entries[s];l.href===e&&r.push(s),l===this.currentEntry&&(o=s)}if(r.length<1)this.currentEntry&&this.currentEntry.historySize===i-1?n(this,e,i):t.log("history problem. Lost position");else{"back"===this.hint&&r.reverse();var d=void 0,u=void 0;if("number"==typeof o)for(s=0,a=r.length;s<a;++s){var h=r[s],p=h<o?o-h:h-o;void 0===d?(d=p,u=h):p<=d&&(d=p,u=h)}if("number"==typeof u){var f=this.entries[u];this.currentEntry=f}}}this.lastHref=e,this.lastHistorySize=i,this.lastUpdated=(new Date).getTime(),this.saveToStorage(),this._reportChange()},_computeState:function(){var e=this._indexFromEntry(this.currentEntry),t=!1,i=!1;return"number"==typeof e&&(e>0&&(t=!0),e<this.entries.length-1&&(i=!0)),{entries:this.entries,currentEntry:this.currentEntry,currentIndex:e,backIsAvailable:t,forwardIsAvailable:i}},_reportChange:function(){var e={type:"historyReportState",state:this._computeState()};this._dispatch(e)},_dispatch:function(e){var t=this.dispatchService;t&&t.send("n2.history.History",e)}}),u=t.Class({options:null,initialize:function(i){this.options=t.extend({directory:null},i);var n=this;window&&"onhashchange"in window&&e(window).bind("hashchange",function(e){n._hashChange(e)});var r=this._getDispatcher();if(r){var o=function(e){n._handle(e)},s="n2.history.Monitor";r.register(s,"historyBack",o),r.register(s,"historyForward",o),r.register(s,"setHash",o),r.register(s,"replaceHash",o)}},_getDispatcher:function(){var e=null;return this.options.directory&&(e=this.options.directory.dispatchService),e},_dispatch:function(e){var t=this._getDispatcher();t&&t.send("n2.history.Monitor",e)},_hashChange:function(e){var t=a();this._dispatch({type:"hashChanged",hash:t}),this._dispatch({type:"historyHashModified",hash:t})},_handle:function(e){if("historyBack"===e.type)window.history.back&&window.history.back();else if("historyForward"===e.type)window.history.forward&&window.history.forward();else if("setHash"===e.type){var t=e.hash;window.history.pushState?t?window.history.pushState({},"","#"+t):window.history.pushState({},"","#"):window.location=t?"#"+t:"#",this._dispatch({type:"historyHashModified",hash:a()})}else if("replaceHash"===e.type){t=e.hash;window.history.replaceState?t?window.history.replaceState({},"","#"+t):window.history.replaceState({},"","#"):window.location=t?"#"+t:"#",this._dispatch({type:"historyHashModified",hash:a()})}}}),h=t.Class({options:null,last:null,waitingDocId:null,forceHashReplay:null,initialize:function(e){this.options=t.extend({dispatchService:null,disabled:!1},e);var i=this;this.last={},this.forceHashReplay=!1;var n=this._getDispatcher();if(n){var r=function(e){i._handle(e)},o="n2.history.Tracker";n.register(o,"start",r),n.register(o,"hashChanged",r),n.register(o,"userSelect",r),n.register(o,"userSelectCancelled",r),n.register(o,"unselected",r),n.register(o,"documentCreated",r),n.register(o,"documentUpdated",r),n.register(o,"documentDeleted",r),n.register(o,"searchInitiate",r),n.register(o,"editInitiate",r),n.register(o,"editCreateFromGeometry",r),n.register(o,"editClosed",r)}},getForceHashReplay:function(){return this.forceHashReplay},setForceHashReplay:function(e){this.forceHashReplay=!!e},_getDispatcher:function(){var e=null;return this.options&&(e=this.options.dispatchService),e},_dispatch:function(e){var t=this._getDispatcher();t&&t.send("n2.history.Tracker",e)},_synchronousCall:function(e){var t=this._getDispatcher();t&&t.synchronousCall("n2.history.Tracker",e)},_handle:function(e){if(!this.options.disabled)if("start"===e.type)(c=a())&&""!==c&&this._dispatch({type:"hashChanged",hash:c});else if("userSelect"===e.type){if(e.docId){if(this.last={selected:e.docId},!e._suppressSetHash){var l="setHash";e._replaceHash&&(l="replaceHash");var c=o(s({t:i,i:e.docId}));this._dispatch({type:l,hash:c}),this.waitingDocId=null}}else if(e.docIds&&(this.last={multi_selected:e.docIds},!e._suppressSetHash)){l="setHash";e._replaceHash&&(l="replaceHash");var d=(new Date).getTime();!function(e,i){t.log("Save hash "+e);var n=t.storage.getSessionStorage(),r=n.getItem("n2_historyHash"),o=null;try{o=JSON.parse(r)}catch(e){t.log("Error parsing history hash(2):"+r),o={}}o||(o={});o[""+e]=i;var s=JSON.stringify(o);for(;s.length>2e6;)p(o),s=JSON.stringify(o);n.setItem("n2_historyHash",s)}(d,{docIds:e.docIds});c=o(s({t:n,s:d}));this._dispatch({type:l,hash:c}),this.waitingDocId=null}}else if("userSelectCancelled"===e.type)this.last={selectCancel:!0},e._suppressSetHash||this._dispatch({type:"historyBack"});else if("unselected"===e.type)this.last={unselected:!0},e._suppressSetHash||(this._dispatch({type:"setHash",hash:null}),this.waitingDocId=null);else if("documentDeleted"===e.type){var u=e.docId;this.last.selected===u&&(this.last={deleted:u},this._dispatch({type:"historyBack"}))}else if("searchInitiate"===e.type){if(this.last={search:e.searchLine},!e._suppressSetHash){c=o(s({t:r,l:e.searchLine}));this._dispatch({type:"setHash",hash:c}),this.waitingDocId=null}}else if("editInitiate"===e.type||"editCreateFromGeometry"===e.type)this.last={edit:!0},this.waitingDocId=null,this._dispatch({type:"setHash",hash:"nostate"});else if("editClosed"===e.type){var h=!1;this.last.edit&&(h=!0),this.last={editClosed:!0},e.inserted&&!e.submissionDs?this._dispatch({type:"userSelect",docId:e.doc._id,_replaceHash:!0}):e.inserted&&e.submissionDs?(h&&this._dispatch({type:"historyBack"}),this.waitingDocId=e.doc._id):h&&this._dispatch({type:"historyBack"})}else if("hashChanged"===e.type){if(this.last.editClosed||(this.waitingDocId=null),"nostate"===e.hash);else{var f={type:"historyIsHashChangePermitted",permitted:!0};this._synchronousCall(f),f.permitted?""!==e.hash&&e.hash?this._reloadHash(e.hash):this.last.unselected||this._dispatch({type:"unselected",_suppressSetHash:!0}):this._dispatch({type:"historyForward"})}}else"documentCreated"!==e.type&&"documentUpdated"!==e.type||e.docId&&e.docId===this.waitingDocId&&this._dispatch({type:"userSelect",docId:e.docId})},_reloadHash:function(e){var t=l(e);t&&(t._suppressSetHash=!0,"userSelect"===t.type&&"string"==typeof t.docId&&this.last.selected===t.docId?this.forceHashReplay&&this._dispatch(t):this._dispatch(t))}});function p(e){var t=null;for(var i in e)t?i<t&&(t=i):t=i;t&&delete e[t]}t.history={Monitor:u,Tracker:h,History:d}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n=1;function r(t){if(t.jquery||(t=e(elem)),t.length>1&&(t=e(elem).first()),t.hasClass("tree"))return t;var i=t.parent();return i.length>0?r(i):null}function o(e){var t=r(e);return t?t[0].treeUuid:-1}function s(e){var i=r(e);return i?i.attr("id"):(t.log("tree getTreeId(): can not find tree root"),null)}function a(t){return t.jquery||(t=e(t)),t.length<1?null:"li"===t[0].nodeName.toLowerCase()?t:a(t.parent())}function l(e){e.hasClass("treeHideChildren")?(e.removeClass("treeHideChildren"),e.addClass("treeShowChildren")):(e.addClass("treeHideChildren"),e.removeClass("treeShowChildren"))}function c(){l(a(this))}var d={allClosed:!0,onKeyClick:function(e){return!0}};function u(t,i){t.each(function(){var t=this.treeUuid;t||(t=n,++n,this.treeUuid=t);var i=e(this),r=i.attr("id");r&&void 0!==r||(r="tree_"+t,i.attr("id",r))}),h(t,i)}function h(t,i){t.find("li").each(function(t,n){var r=e(n);if(0==r.hasClass("treeEditAdd")){var o=r.children("div.treeExpand");o.length<1&&(o=e('<div class="treeExpand"></div>'),r.prepend(o)),0==o.hasClass("treeClickInstalled")&&(o.click(c),o.addClass("treeClickInstalled"));var s=r.children("span").first();0==s.hasClass("treeKey")&&s.addClass("treeKey"),0==s.hasClass("treeClickInstalled")&&(s.click(function(){!function(e,t){var i=a(e);t.onKeyClick(i)&&l(i)}(this,i)}),s.addClass("treeClickInstalled")),r.children("ul").addClass("treeChildren"),r.children(".treeChildren").length>0?r.removeClass("treeNoChildren"):r.addClass("treeNoChildren"),0==r.hasClass("treeHideChildren")&&0==r.hasClass("treeShowChildren")&&(i.allClosed?r.addClass("treeHideChildren"):r.addClass("treeShowChildren"))}})}var p=t.Class({treeId:null,options:null,initialize:function(t,i){this.options=e.extend({},d,i),u(t,this.options),this.treeId=s(t)},getRoot:function(){var i=e("#"+this.treeId);return 1!=i.length?(t.log("Tree.getRoot(): id not found: "+this.treeId),null):i},getId:function(){return this.treeId},refresh:function(){var e=this.getRoot();e&&h(e,this.options)}});function f(e){if(1!=e.length)return null;var t=[];return 0==function e(t,i){var n=t.parent();if(n.length>0&&0==n.hasClass("tree")){var r=n.parent();if(0==e(r,i))return!1}var o=t[0];return void 0!==o.treeArrayIndex?(i.push(1*o.treeArrayIndex),!0):void 0!==o.treeObjectKey&&(i.push(o.treeObjectKey),!0)}(e,t)?null:t}function m(e){if("string"==typeof e){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i];if(r>="a"&&r<="z")t.push(r);else if(r>="A"&&r<="Z")t.push(r);else if(r>="0"&&r<="9")t.push(r);else{var o=r.charCodeAt(0),s=48+(7&o),a=48+(o>>3&7),l=48+(o>>6&7);t.push("_"),t.push(String.fromCharCode(l)),t.push(String.fromCharCode(a)),t.push(String.fromCharCode(s))}}return t.join("")}return"number"==typeof e?""+e:""}function v(e,t){for(var i=[],n=0,r=t.length;n<r;++n)i.push(m(t[n]));return"tree"+e+"_"+i.join("_")}function g(e){for(var t=[],i=0,n=e.length;i<n;++i)t.push(m(e[i]));return"tree_sel_"+t.join("_")}function y(t){var i=null;t.each(function(){var t=e(this),n=f(t);i||(i=o(t));var r=v(i,n);t.attr("id",r)})}function _(e,t){var i=v(o(e),t);return e.find("#"+i)}function S(e,i){if(null===i||0===i.length)return e;if(null==e||"number"==typeof e||"string"==typeof e||void 0===e||"function"==typeof e)return null;if(t.isArray(e)){var n=1*i[0];return n>=e.length?null:i.length<2?e[n]:S(e[n],i.slice(1))}if("object"==typeof e){var r=e[i[0]];return void 0===r?null:i.length<2?r:S(r,i.slice(1))}return null}function b(e,i,n){if(null===i||0===i.length)return!1;if(t.isArray(e)){var r=1*i[0];return!(r>=e.length)&&(i.length>1?b(e[r],i.slice(1),n):(e[r]=n,!0))}if("object"==typeof e){var o=i[0];if(1==i.length)return e[o]=n,!0;var s=e[o];return void 0!==s&&b(s,i.slice(1),n)}return!1}function I(e,i){if(null===i||0===i.length)return!1;if(null===e)return!1;if(t.isArray(e)){var n=1*i[0];return!(n>=e.length)&&(i.length>1?I(e[n],i.slice(1)):(e.splice(n,1),!0))}if("object"==typeof e){var r=i[0],o=e[r];return void 0!==o&&(i.length>1?I(o,i.slice(1)):(delete e[r],!0))}return!1}function C(t,i,n,r,s){var a=o(n);n.children("li").each(function(i,n){if(e(this).hasClass("treeEditAdd"));else{var r=this.treeObjectKey;null==r?e(this).remove():void 0===t[r]&&e(this).remove()}});var l=[];for(var c in t)l.push(c);l.sort();for(var d=0,u=l.length;d<u;++d){c=l[d];var h=t[c];if(s.indexOf(h)>=0);else{i.push(c),s.push(h);var p=v(a,i),f=g(i),m=n.children("#"+p);m.length<1&&(m=e("<li>").attr("id",p).addClass("tree_sel "+f),e("<span>").addClass("treeKey").text(c).appendTo(m),m[0].treeObjectKey=c,n.append(m)),D(h,i,m,r,s),s.pop(),i.pop()}}}function D(i,n,r,s,a){var l=null;s.valueDisplayFn&&(l=s.valueDisplayFn(i,s));var c=r.children("span.treeValue");if(l)if(c.length>0)c.text(l.str);else{(c=e('<span class="treeValue"></span>')).text(l.str);var d=r.children(".treeKey");c.insertAfter(d)}else c.remove();if(null===i)r.children(".treeChildren").remove();else if("string"==typeof i){if(r.children(".treeChildren").remove(),l)if(l.truncated)(u=e('<div class="treeChildren"></div>')).text(i),r.append(u)}else if("number"==typeof i||"boolean"==typeof i){if(r.children(".treeChildren").remove(),l&&l.truncated){var u=e('<div class="treeChildren">'+i+"</div>");r.append(u)}}else if(t.isArray(i)){(h=r.children(".treeChildren")).length>0&&"ul"!==h[0].nodeName.toLowerCase()&&(h.remove(),h=null),(!h||h.length<1)&&(h=e('<ul class="treeChildren"></ul>'),r.append(h)),function(t,i,n,r,s){var a=o(n);n.children("li").each(function(i,n){if(e(this).hasClass("treeEditAdd"));else{var r=this.treeArrayIndex;"number"!=typeof r?e(this).remove():(r>=t.length||r<0)&&e(this).remove()}});for(var l=0,c=t.length;l<c;++l){var d=t[l];if(s.indexOf(d)>=0);else{i.push(l),s.push(d);var u=v(a,i),h=g(i),p=n.children("#"+u);p.length<1&&(p=e("<li>").attr("id",u).addClass("tree_sel "+h),e("<span>").addClass("treeKey").text(l).appendTo(p),p[0].treeArrayIndex=l,n.append(p)),D(d,i,p,r,s),s.pop(),i.pop()}}}(i,n,h,s,a)}else if("object"==typeof i){var h;(h=r.children(".treeChildren")).length>0&&"ul"!==h[0].nodeName.toLowerCase()&&(h.remove(),h=null),(!h||h.length<1)&&(h=e('<ul class="treeChildren"></ul>'),r.append(h)),C(i,n,h,s,a)}else r.children(".treeChildren").remove()}var w={valueDisplayFn:function(e,i){var n={truncated:!1},r=[];i.valueSeparator&&r.push(i.valueSeparator);var o=i.valueMaxLen-i.valueEllipsis.length,s=function(e,i){var n=[];return function e(n,r,o,s){if(null===n){var a="null";return r.push(a),a.length}if("number"==typeof n){var a=""+n;return r.push(a),a.length}if("string"==typeof n){var a='"'+n+'"';return r.push(a),a.length}if("boolean"==typeof n){var a=""+n;return r.push(a),a.length}if(t.isArray(n)){var l=1;r.push("[");for(var c=0,d=n.length;c<d;++c){0!=c&&(r.push(","),++l);var u=n[c],h=e(u,r,o+l,s);if((l+=h)+o>=i)return l}return r.push("]"),++l}if("object"==typeof n){var l=1;r.push("{");var p=[];for(var f in n)p.push(f);p.sort();for(var c=0,d=p.length;c<d;++c){0!=c&&(r.push(","),++l);var f=p[c];r.push(f),r.push(":"),l+=f.length+1;var u=n[f],h=e(u,r,o+l,s);if((l+=h)+o>=i)return l}return r.push("}"),++l}return 0}(e,n,0,i),n.join("")}(e,o);return s.length>o&&(s=s.substr(0,o)+i.valueEllipsis,n.truncated=!0),r.push(s),n.str=r.join(""),n},valueSeparator:" : ",valueEllipsis:"...",valueMaxLen:30};var E=t.Class({treeId:null,options:null,obj:null,initialize:function(t,i,n){if(this.options=e.extend({},d,w,n),this.obj=i,this.obj){var r=function(t,i,n){t.empty();var r=e('<ul class="tree"></ul>').appendTo(t);return u(r,n),C(i,[],r,n,[]),h(r,n),r}(t,this.obj,this.options);this.treeId=s(r)}else this.treeId=t.find("ul.tree").attr("id")},getRoot:function(){var i=e("#"+this.treeId);return 1!=i.length?(t.log("ObjectTree.getRoot(): id not found: "+this.treeId),null):i},getId:function(){return this.treeId},getObject:function(){return this.obj},refresh:function(){var e=this.getRoot();e&&function(e,t,i){C(t,[],e,i,[]),h(e,i)}(e,this.obj,this.options)},findLiFromSelectors:function(e){var t=this.getRoot();return t?_(t,e):null}});var x={onObjectChanged:function(e){},beforeValueChanged:function(e,t,i){},afterValueChanged:function(e,t,i){},beforeKeyChanged:function(e,t,i,n){},afterKeyChanged:function(e,t,i,n){},beforeKeyAdded:function(e,t,i){},afterKeyAdded:function(e,t,i){},beforeKeyDeleted:function(e,t){},afterKeyDeleted:function(e,t){},beforeIndexSwap:function(e,t,i){},afterIndexSwap:function(e,t,i){},createNewKey:function(e,t,i,n){for(var r=0,o="newkey_"+r;void 0!==n[o];)if(o="newkey_"+ ++r,r>100)return;e(i,o,null)},getDeleteConfirmation:function(e,t,n){confirm(i("Do you wish to delete this element?"))&&e()},getAbortConfirmation:function(e){confirm(i("This object is being modified. Do you wish to continue and revert current changes?"))&&e()},isKeyEditingAllowed:function(e,t,i){return!0},isValueEditingAllowed:function(e,t,i){return!0},isKeyDeletionAllowed:function(e,t,i){return!0}},T=t.Class({$tree:null,obj:null,options:null,initialize:function(i,n,r){i||t.log("ObjectTreeEditor.initialize(): null tree"),i.getRoot&&((i=i.getRoot())||t.log("ObjectTreeEditor.initialize(): null root")),this.options=e.extend({},d,w,x,r),this.$tree=i,this.obj=n,this._installEditors()},destroy:function(){this._removeEditors(),this.$tree=null,this.obj=null,this.options=null},getRoot:function(){return this.$tree},getId:function(){return s(this.$tree)},getObject:function(){return this.obj},refresh:function(e){null==e||e.length<1?C(this.obj,[],this.$tree,this.options,[]):D(S(this.obj,e),e,_(this.$tree,e),this.options,[]);this._installEditors(),h(this.$tree,this.options)},isEditing:function(){return this.$tree.find(".treeEditingValue").length>0||this.$tree.find(".treeEditingKey").length>0},cancelEditing:function(){this.$tree.find(".treeEditingValue").removeClass("treeEditingValue"),this.$tree.find(".treeEditingKey").removeClass("treeEditingKey"),this.$tree.find(".treeValueEditor").remove(),this.$tree.find(".treeKeyEditor").remove()},_installEditors:function(){var t=this;function i(){var i=e(this),n=i.children("li.treeEditAdd");n.remove(),n=e('<li class="treeEditAdd"></li>');var r=e("<div><div/>");r.click(function(){t._initiateAddKey(this)}),n.append(r),i.append(n)}this.$tree.find("li").each(function(i,n){var r=e(this);if(0==r.hasClass("treeEditAdd")){var o=f(r),s=S(t.obj,o),a=t.options.isKeyEditingAllowed(t.obj,o,s),l=t.options.isValueEditingAllowed(t.obj,o,s),c=t.options.isKeyDeletionAllowed(t.obj,o,s),d=r.children("div.treeChildren");if(d.length>0&&l&&0==d.hasClass("treeEditorClickInstalled")&&(d.click(function(){t._initiateValueEdit(this)}),d.addClass("treeEditorClickInstalled")),n.treeObjectKey){var u=r.children("span.treeKey");u.length>0&&a&&0==u.hasClass("treeEditorClickInstalled")&&(u.unbind("click"),u.click(function(){t._initiateKeyEdit(this)}),u.addClass("treeEditorClickInstalled"))}var h=r.children("span.treeValue");h.length>0&&l&&0==h.hasClass("treeEditorClickInstalled")&&(h.click(function(){t._initiateValueEdit(this)}),h.addClass("treeEditorClickInstalled"));var p=r.children(".treeEditDelete");if(p.length<1&&c&&(p=e('<div class="treeEditDelete treeEditorClickInstalled"></div>'),h.after(p),p.click(function(){t._initiateDeleteKey(this)})),"number"==typeof n.treeArrayIndex){var m=r.children(".treeEditDown");m.length<1&&(m=e('<div class="treeEditDown treeEditorClickInstalled"></div>'),h.after(m),m.click(function(){t._initiateSwapKeys(this,1)}));var v=r.children(".treeEditUp");v.length<1&&(v=e('<div class="treeEditUp treeEditorClickInstalled"></div>'),h.after(v),v.click(function(){t._initiateSwapKeys(this,-1)}))}}}),this.$tree.each(i),this.$tree.find("ul").each(i)},_removeEditors:function(){this.cancelEditing(),this.$tree.find("li.treeEditAdd").remove(),this.$tree.find(".treeEditorClickInstalled").unbind("click").removeClass("treeEditorClickInstalled").removeClass("treeClickInstalled"),this.$tree.find(".treeEditDelete").remove(),this.$tree.find(".treeEditUp").remove(),this.$tree.find(".treeEditDown").remove(),h(this.$tree,this.options)},_continueWithEditing:function(e){if(0==this.isEditing())e();else{var t=this;this.options.getAbortConfirmation(function(){t.cancelEditing(),e()})}},_initiateValueEdit:function(e){var t=this;this._continueWithEditing(function(){t._startValueEdit(e)})},_startValueEdit:function(t){var i=this,n=a(t);n.addClass("treeEditingValue");var r=f(n),o=S(this.obj,r),s=JSON.stringify(o),l=n.children("div.treeValueEditor");if(l.length<1){l=e('<div class="treeValueEditor"><br/></div>'),n.children(".treeEditDelete").after(l);var c=e("<textarea></textarea>");l.prepend(c),c.keydown(function(e){i._valueEditKeyDown(e,this)});var d=e('<input type="button" value="OK"/>');l.append(d),d.click(function(){i._acceptValueEdit(this)});var u=e('<input type="button" value="Cancel"/>');l.append(u),u.click(function(){i.cancelEditing()})}n.children(".treeValueEditor").find("textarea").val(s).focus()},_acceptValueEdit:function(e){var n=a(e),r=f(n),o=n.children(".treeValueEditor").find("textarea").val();try{var s=JSON.parse(o)}catch(e){return t.log("JSON error",e),void alert(i("Unable to parse JSON string: ")+e)}n.removeClass("treeEditingValue"),this._beforeValueChanged(r,s),b(this.obj,r,s),this._afterValueChanged(r,s),this.cancelEditing(),this.refresh()},_valueEditKeyDown:function(e,t){e&&13==e.keyCode?this._acceptValueEdit(t):e&&27==e.keyCode&&this.cancelEditing()},_initiateAddKey:function(e){var t=this;this._continueWithEditing(function(){t._startAddKey(e)})},_startAddKey:function(i){var n=this,r=e(i).parents("ul").first();if(1==r.length){if(r[0].treeUuid)var o=this.obj,s=[];else s=f(a(r)),o=S(this.obj,s);if(null==o)this.refresh();else if(t.isArray(o)){var l=o.length;this._beforeKeyAdded(s,l),o.push(null),this._afterKeyAdded(s,l),this.refresh()}else"object"==typeof o&&this.options.createNewKey(function(e,t,i){n._acceptNewObjectKey(e,t,i)},this.obj,s,o)}},_acceptNewObjectKey:function(e,t,i){var n=S(this.obj,e);n&&(this._beforeKeyAdded(e,t),n[t]=i,this._afterKeyAdded(e,t),this.refresh())},_initiateDeleteKey:function(e){var t=this;this._continueWithEditing(function(){t._startDeleteKey(e)})},_startDeleteKey:function(e){var t=a(e),i=this,n=f(t);this.options.getDeleteConfirmation(function(){i._acceptDeleteKey(n)},this.obj,n)},_acceptDeleteKey:function(e){this._beforeKeyDeleted(e),I(this.obj,e),this._afterKeyDeleted(e),this.refresh()},_initiateSwapKeys:function(e,t){var i=this;this._continueWithEditing(function(){i._acceptSwapKeys(e,t)})},_acceptSwapKeys:function(t,i){var n=a(t),r=f(n),s=1*r.pop(),l=S(this.obj,r),c=s+i;if(!(c<0||c>=l.length)){var d=o(n);i<0?this._beforeIndexSwap(r,c):this._beforeIndexSwap(r,s);var u=e("#tree"+d+"_"+r.join("_")+"_"+c);if(1==u.length){i<0?n.after(u):u.after(n),n.children("span.treeKey").empty().text(c),u.children("span.treeKey").empty().text(s),n[0].treeArrayIndex=c,u[0].treeArrayIndex=s;var h=u.find("span.treeKey").parent();h.removeAttr("id"),y(n.find("span.treeKey").parent()),y(h);var p=l[s];l[s]=l[c],l[c]=p}i<0?this._afterIndexSwap(r,c):this._afterIndexSwap(r,s)}},_initiateKeyEdit:function(e){var t=this;this._continueWithEditing(function(){t._startKeyEdit(e)})},_startKeyEdit:function(i){var n=this,r=a(i);r.addClass("treeEditingKey");var o=f(r),s=o.pop(),l=S(this.obj,o);t.log("Key editing",s,l,o);var c=r.children("span.treeKey"),d=e('<span class="treeKeyEditor"></span>'),u=e('<input class="treeEditorKeyInput" type="text"/>');u.val(s),d.append(u),u.keydown(function(e){n._keyEditKeyDown(e,this)});var h=e('<div class="treeEditOk"></div>');d.append(h),h.click(function(){n._acceptKeyEdit(this)});var p=e('<div class="treeEditCancel"></div>');d.append(p),p.click(function(){n.cancelEditing()}),c.after(d),u.focus()},_acceptKeyEdit:function(e){var n=a(e),r=f(n),o=r.pop(),s=S(this.obj,r),l=n.children(".treeKeyEditor").find("input").val();try{JSON.parse('{"'+l+'":0}')}catch(e){return t.log("parsing error",e),void alert(i("Unable to parse key: ")+e)}l!==o?void 0===s[l]?(this._beforeKeyChanged(r,o,l),s[l]=s[o],delete s[o],this._afterKeyChanged(r,o,l),r.push(l),n.children("span.treeKey").empty().text(l),n[0].treeObjectKey=l,y(n.find("span.treeKey").parent()),this.cancelEditing(),this.refresh()):alert(i("Key already in use: ")+l):this.cancelEditing()},_keyEditKeyDown:function(e,t){e&&13==e.keyCode?this._acceptKeyEdit(t):e&&27==e.keyCode&&this.cancelEditing()},_beforeValueChanged:function(e,t){this.options.beforeValueChanged(this.obj,e,t)},_afterValueChanged:function(e,t){this.options.afterValueChanged(this.obj,e,t),this.options.onObjectChanged(this.obj)},_beforeKeyChanged:function(e,t,i){this.options.beforeKeyChanged(this.obj,e,t,i)},_afterKeyChanged:function(e,t,i){this.options.afterKeyChanged(this.obj,e,t,i),this.options.onObjectChanged(this.obj)},_beforeKeyAdded:function(e,t){this.options.beforeKeyAdded(this.obj,e,t)},_afterKeyAdded:function(e,t){this.options.afterKeyAdded(this.obj,e,t),this.options.onObjectChanged(this.obj)},_beforeKeyDeleted:function(e){this.options.beforeKeyDeleted(this.obj,e)},_afterKeyDeleted:function(e){this.options.afterKeyDeleted(this.obj,e),this.options.onObjectChanged(this.obj)},_beforeIndexSwap:function(e,t){this.options.beforeIndexSwap(this.obj,e,t)},_afterIndexSwap:function(e,t){this.options.afterIndexSwap(this.obj,e,t),this.options.onObjectChanged(this.obj)}});t.tree={Tree:p,ObjectTree:E,ObjectTreeEditor:T,support:{findDataFromObject:S,setObjectData:b,deleteObjectData:I}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)};function n(e,i){if(null===i||0===i.length)return e;if(null==e||"number"==typeof e||"string"==typeof e||void 0===e||"function"==typeof e)return null;if(t.isArray(e)){var r=1*i[0];return r>=e.length?null:i.length<2?e[r]:n(e[r],i.slice(1))}if("object"==typeof e){var o=e[i[0]];return void 0===o?null:i.length<2?o:n(o,i.slice(1))}return null}function r(e,t){for(var i=0,n=e.length;i<n;++i)if(e[i]===t)return void e.splice(i,1)}var o={onObjectChanged:function(e){},objectKeySortAllowed:!0,objectKeySort:function(e){var t=[];for(var i in e)t.push(i);t.sort();var n=[];if(e.n2se_keyorder)for(var o=0,s=e.n2se_keyorder.length;o<s;++o)void 0!==e[i=e.n2se_keyorder[o]]&&(r(t,i),n.push(i));for(o=0,s=t.length;o<s;++o)i=t[o],n.push(i);return n},objectKeyOrderSave:function(e,t){e.n2se_keyorder=t},getDeleteConfirmation:function(e){confirm(i("Do you wish to delete this element?"))&&e()},isKeyDisplayed:function(e,t,i){return!(t.length>0&&"n2se_keyorder"===t[t.length-1])},isKeyEditingAllowed:function(e,t,i){return!0},isValueEditingAllowed:function(e,t,i){return!0},isKeyDeletionAllowed:function(e,t,i){return!0},createNewKey:function(e,t,i,n){for(var r=0,o="newkey_"+r;void 0!==n[o];)if(o="newkey_"+ ++r,r>100)return;e(i,o,"")}},s=t.Class({divId:null,obj:null,options:null,currentSelectors:null,initialize:function(i,n,r){this.options=e.extend({},o,r);var s=i.attr("id");s||(s=t.getUniqueId(),i.attr("id",s)),this.divId=s,this.obj=n,this.currentSelectors=[],this._installEditors()},destroy:function(){this._removeEditors(),this.divId=null,this.obj=null,this.options=null},getDiv:function(){if(this.divId){var t=e("#"+this.divId);if(t.length>1)return t.first();if(t.length>0)return t}return null},getId:function(){return this.divId},getObject:function(){return this.obj},refresh:function(){var e=this.currentSelectors,t=n(this.obj,e);if(null!==t)this._refresh();else{for(;!t;)e.pop(),t=n(this.obj,e);this._refresh({back:!0})}},_refresh:function(e){this._refreshHistory(e),this._refreshDisplay(e)},_refreshHistory:function(){var t=this,n=this.currentSelectors,r=this.getDiv();if(r){var o=r.find(".n2se_history");o.empty();var s=e('<span class="n2se_history_back"><span class="n2se_btn"></span><span class="n2se_label">'+i("Back")+"</span></span>");o.append(s),s.click(function(e){t._backClicked(e)});var a=e('<span class="n2se_history_head"></span>');o.append(a);var l=e('<span class="n2se_history_level">'+i("top")+"</span>");o.append(l),l.click(m(t,0));for(var c=0,d=n.length;c<d;++c){var u=e('<span class="n2se_history_inter"></span>');o.append(u);var h=n[c],p=e('<span class="n2se_history_level">'+h+"</span>");o.append(p),p.click(m(t,c+1))}var f=e('<span class="n2se_history_tail"></span>');o.append(f)}function m(e,t){return function(){e._historyClicked(t)}}},_refreshDisplay:function(t){var i=this.currentSelectors,r=this.getDiv();if(r){var o=n(this.obj,i),s=[];if(s.push.apply(s,i),t&&t.back){var a=(c=r.find(".n2se_main")).find(".n2se_display"),l=e('<div class="n2se_display"></div>');a.length>0?a.first().before(l):c.append(l),this._drawDisplayPage(l,this.obj,s,o),l.effect("slide",{mode:"show",direction:"left"},500,null),a.effect("slide",{mode:"hide",direction:"right"},500,function(){a.remove()})}else if(t&&t.forward){var c;a=(c=r.find(".n2se_main")).find(".n2se_display"),l=e('<div class="n2se_display"></div>');c.append(l),this._drawDisplayPage(l,this.obj,s,o),a.effect("slide",{mode:"hide",direction:"left"},500,function(){a.remove()}),l.effect("slide",{mode:"show",direction:"right"},500,null)}else{(l=r.find(".n2se_display")).empty(),this._drawDisplayPage(l,this.obj,s,o)}}},_drawDisplayPage:function(r,o,s,a){var l=this,c=!1,d=!1;if("string"==typeof a){var u=this.options.isValueEditingAllowed(o,s,a),h=s.pop(),p=n(o,s),f=e('<textarea class="n2se_textarea"></textarea>');r.append(f),f.val(a),u?f.keyup(function(t){var i=e(this).val();p[h]!==i&&(p[h]=i,l._reportObjectChange())}):f.attr("disabled","disabled")}else if(t.isArray(a)){d=!0,c=!0;var m=e('<div class="n2se_entries"></div>');r.append(m);for(var v=0,g=a.length;v<g;++v){f=e('<div class="n2se_entry"></div>');m.append(f),s.push(v);u=this.options.isValueEditingAllowed(o,s,a[v]);var y=this.options.isKeyDeletionAllowed(o,s,a[v]);s.pop(),w(l,f,a,v,c,!1,u,y)}m.sortable(),m.bind("sortupdate",function(){l._resortArray(r,a)})}else{d=!0;m=e('<div class="n2se_entries"></div>');r.append(m);var _=this.options.objectKeySort(a),S=0;for(g=_.length;S<g;++S){v=_[S];s.push(v);var b=this.options.isKeyDisplayed(o,s,a[v]),I=this.options.isKeyEditingAllowed(o,s,a[v]);u=this.options.isValueEditingAllowed(o,s,a[v]),y=this.options.isKeyDeletionAllowed(o,s,a[v]);if(s.pop(),b){f=e('<div class="n2se_entry"></div>');m.append(f),w(l,f,a,v,c,I,u,y)}}this.options.objectKeySortAllowed&&(m.sortable(),m.bind("sortupdate",function(){l._resortObject(r,a)}))}if(d){var C=e('<div class="n2se_addbar"></div>');r.append(C);var D=e('<span class="n2se_addbar_addButton"><span class="n2se_btn"></span><span class="n2se_label">'+i("Add")+"</span></span>");C.append(D),D.click(function(){c?(a.push(""),l._refreshDisplay(),l._reportObjectChange()):l.options.createNewKey(function(e,t,i){a[t]=i,l._refreshDisplay(),l._reportObjectChange()},o,s,a)})}function w(n,r,o,s,a,l,c,d){var u=o[s],h=e('<span class="n2se_entry_delete"></span>');if(r.append(h),d?h.click(function(){n.options.getDeleteConfirmation(function(){a?o.splice(s,1):delete o[s],n._refreshDisplay(),n._reportObjectChange()})}):h.addClass("n2se_entry_delete_disabled"),a){var p=e('<span class="n2se_entry_key">'+s+"</span>");r.append(p)}else{p=e('<input class="n2se_entry_key" type="text"/>');r.append(p),p.val(s),l?p.change(function(t){var i=e(this),u=i.val();s!=u&&(o[u]?i.val(s):(o[u]=o[s],delete o[s],r.empty(),w(n,r,o,u,a,l,c,d),n._reportObjectChange()))}):p.attr("disabled","disabled")}r.append(e('<span class="n2se_entry_is"> '+i("is")+" </span>"));var f=e('<select class="n2se_entry_select"></select>');r.append(f),f.append(e('<option value="string">'+i("a String")+"</option>")),f.append(e('<option value="number">'+i("a Number")+"</option>")),f.append(e('<option value="boolean">'+i("a Checkbox")+"</option>")),f.append(e('<option value="array">'+i("an Array")+"</option>")),f.append(e('<option value="object">'+i("an Object")+"</option>")),f.append(e('<option value="null">'+i("empty")+"</option>"));var m=!1,v=!1,g=!1;if(null===u?f.val("null"):void 0===u?f.val("null"):t.isArray(u)?(f.val("array"),g=!0):"object"==typeof u?(f.val("object"),g=!0):"string"==typeof u?(f.val("string"),m=!0,g=!0):"number"==typeof u?(f.val("number"),m=!0):"boolean"==typeof u?(f.val("boolean"),v=!0):(f.val("string"),m=!0,g=!0),c?f.change(function(t){var i=e(this).val();"string"===i?"object"==typeof o[s]?o[s]="":o[s]=""+o[s]:"array"===i?o[s]=[o[s]]:"object"===i?o[s]={}:"number"===i?(o[s]=1*o[s],isNaN(o[s])&&(o[s]=0)):o[s]="boolean"!==i&&("null"===i?null:""),r.empty(),w(n,r,o,s,a,l,c,d),n._reportObjectChange()}):f.attr("disabled","disabled"),g){var y=e('<span class="n2se_entry_forward"></span>');r.append(y),y.click(function(e){n._forwardClicked(s)})}if(m){var _=e('<input class="n2se_entry_text" type="text"/>');r.append(_),_.val(u),c?_.keyup(function(t){var i=e(this),r=i.val();"number"==typeof o[s]?(r*=1,isNaN(r)?i.val(o[s]):(o[s]=r,n._reportObjectChange())):(o[s]=r,n._reportObjectChange())}):_.attr("disabled","disabled")}else if(v){var S=e('<input class="n2se_entry_cb" type="checkbox"/>');r.append(S),u&&S.attr("checked","checked"),c?S.click(function(t){var i=e(this).is(":checked");o[s]=i,n._reportObjectChange()}):S.attr("disabled","disabled")}}},_installEditors:function(){var t=this,i=this.getDiv();if(i){i.empty();var n=e('<div class="n2se_root"></div>');i.append(n);var r=e('<div class="n2se_history"></div>');n.append(r);var o=e('<div class="n2se_main"></div>');n.append(o);var s=e('<div class="n2se_back"></div>');o.append(s),s.click(function(e){t._backClicked(e)});var a=e('<div class="n2se_display"></div>');o.append(a),this._refresh()}},_removeEditors:function(){var e=this.getDiv();e&&(e.empty(),this.divId=null)},_backClicked:function(e){this.currentSelectors.length>0&&(this.currentSelectors.pop(),this._refresh({back:!0}))},_forwardClicked:function(e){this.currentSelectors.push(e),this._refresh({forward:!0})},_historyClicked:function(e){var t=this.currentSelectors.length-e;t>0&&(this.currentSelectors.splice(e,t),this._refresh({back:!0}))},_reportObjectChange:function(){try{this.options.onObjectChanged(this.obj)}catch(e){t.log("Error reported on object refresh",e)}},_resortArray:function(i,n){var r=i.find(".n2se_entry_key");t.log("$keys",r);var o=[];r.each(function(t,i){var r=1*e(i).text();o.push(n[r])}),n.splice(0,n.length);for(var s=0,a=o.length;s<a;++s)n.push(o[s]);this._refresh(),this._reportObjectChange()},_resortObject:function(t,i){var n=t.find(".n2se_entry_key"),r=[];n.each(function(t,i){var n=e(i).val();r.push(n)}),this.options.objectKeyOrderSave(i,r),this._refresh(),this._reportObjectChange()}});t.slideEditor={Editor:s,support:{findDataFromObject:n,setObjectData:function e(i,n,r){if(null===n||0===n.length)return!1;if(t.isArray(i)){var o=1*n[0];return!(o>=i.length)&&(n.length>1?e(i[o],n.slice(1),r):(i[o]=r,!0))}if("object"==typeof i){var s=n[0];if(1==n.length)return i[s]=r,!0;var a=i[s];return void 0!==a&&e(a,n.slice(1),r)}return!1},deleteObjectData:function e(i,n){if(null===n||0===n.length)return!1;if(null===i)return!1;if(t.isArray(i)){var r=1*n[0];return!(r>=i.length)&&(n.length>1?e(i[r],n.slice(1)):(i.splice(r,1),!0))}if("object"==typeof i){var o=n[0],s=i[o];return void 0!==s&&(n.length>1?e(s,n.slice(1)):(delete i[o],!0))}return!1}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)};function n(e,i,n){return"string"==typeof i&&(i=i.split(".")),function e(i,n,r,o){if(r>=n.length)return!1;if(null==i||"number"==typeof i||"string"==typeof i||void 0===i||"function"==typeof i)return!1;if(r==n.length-1){if(t.isArray(i)){var s=1*n[r];return!(s>=i.length)&&(i[s]=o,!0)}if("object"==typeof i){var a=n[r];return i[a]=o,!0}return!1}if(t.isArray(i)){var s=1*n[r];return!(s>=i.length)&&e(i[s],n,r+1,o)}if("object"==typeof i){var a=n[r],l=i[a];return void 0!==l&&e(l,n,r+1,o)}return!1}(e,i,0,n)}function r(e,i){return"string"==typeof i&&(i=i.split(".")),function e(i,n,r){if(r>=n.length)return i;if(null==i||"number"==typeof i||"string"==typeof i||void 0===i||"function"==typeof i)return null;if(t.isArray(i)){var o=1*n[r];return o>=i.length?null:e(i[o],n,r+1)}if("object"==typeof i){var s=n[r],a=i[s];return void 0===a?null:e(a,n,r+1)}return null}(e,i,0)}var o=t.Class({defaultValue:null,name:null,label:null,selector:null,type:"text",className:null,options:null,initialize:function(t){e.extend(this,t),null==this.label&&(this.label=this.name),null==this.selector&&(this.selector=this.name)},isHidden:function(){return"hidden"===this.type}}),s=t.Class({name:null,label:null,initialize:function(e,t){this.name=e,this.label=t}}),a=t.Class({attributes:[],title:"",okButton:!1,okButtonLabel:i("OK"),cancelButton:!1,cancelButtonLabel:i("Cancel"),resetButton:!1,resetButtonLabel:i("Reset"),buttons:null,initialize:function(e){if(e.title&&(this.title=e.title),e.okButton&&(this.okButton=e.okButton),e.okButtonLabel&&(this.okButtonLabel=e.okButtonLabel),e.cancelButton&&(this.cancelButton=e.cancelButton),e.cancelButtonLabel&&(this.cancelButtonLabel=e.cancelButtonLabel),e.resetButton&&(this.resetButton=e.resetButton),e.resetButtonLabel&&(this.resetButtonLabel=e.resetButtonLabel),e.attributes){this.attributes=[];for(var t=0,i=e.attributes.length;t<i;++t){var n=e.attributes[t];this.attributes.push(new o(n))}}if(e.buttons){this.buttons=[];for(t=0,i=e.buttons.length;t<i;++t){var r=e.buttons[t];this.buttons.push(new s(r.name,r.label))}}},createForm:function(e,t,i){return new u(this,e,t,i)},getTitle:function(){return this.formSchema&&this.formSchema.title?this.formSchema.title:null}}),l=t.Class({uniqueId:null,attribute:null,jQuerySet:null,data:null,input:null,initialValue:null,onChanged:null,initialize:function(e,t,i,n,r){this.uniqueId=e,this.attribute=t,this.data=i,this.jQuerySet=n,this.onChanged=r,this.render()},render:function(){var t=this.attribute,i=[];if("select"==t.type){i.push('<select id="'),i.push(this.uniqueId),t.name&&(i.push('" name="'),i.push(t.name)),t.className&&(i.push('" class="'),i.push(t.className)),i.push('">');for(var n=0,r=t.options.length;n<r;++n){var o=t.options[n];"string"==typeof o&&(o={value:o});var s=o.label?o.label:o.value;i.push('<option value="'),i.push(o.value),i.push('">'),i.push(s),i.push("</option>")}i.push("</select>")}else"date"==t.type?(i.push('<input id="'),i.push(this.uniqueId),i.push('" type="text'),t.name&&(i.push('" name="'),i.push(t.name)),t.className&&(i.push('" class="'),i.push(t.className)),i.push('"/>')):"file"==t.type?(i.push('<input id="'),i.push(this.uniqueId),i.push('" type="file'),t.name&&(i.push('" name="'),i.push(t.name)),t.className&&(i.push('" class="'),i.push(t.className)),i.push('"/>')):"textarea"==t.type?(i.push('<textarea id="'),i.push(this.uniqueId),t.name&&(i.push('" name="'),i.push(t.name)),t.className&&(i.push('" class="'),i.push(t.className)),i.push('"></textarea>')):"array"==t.type?(i.push('<div id="'),i.push(this.uniqueId),i.push('"/>')):(i.push('<input id="'),i.push(this.uniqueId),t.type&&(i.push('" type="'),i.push(t.type)),t.name&&(i.push('" name="'),i.push(t.name)),t.className&&(i.push('" class="'),i.push(t.className)),i.push('"/>'));this.input=e(i.join("")),this.input.change(this.onChanged);var a=null;if(this.data&&(a=this.getData()),null==a&&this.attribute.defaultValue&&(a=this.attribute.defaultValue),null==a&&(a=""),this.input.val(a),this.initialValue=a,this.jQuerySet.append(this.input),"date"==t.type&&e.ui&&e.ui.datepicker){var l=e.extend({dateFormat:"yy-mm-dd",gotoCurrent:!0,changeYear:!0},t.datePicker);this.input.datepicker(l)}else t.type},refreshFromData:function(){var e=this.getData();null==e&&(e=""),this.setCurrentValue(e)},getName:function(){return this.attribute.name},getCurrentValue:function(){return this.input.val()},setCurrentValue:function(e){this.input.val(e)},resetValue:function(){this.input.val(this.initialValue)},hasValueChanged:function(){return this.getCurrentValue()!=this.initialValue},getInputElement:function(){return this.input},getData:function(){return r(this.data,this.attribute.selector)},setData:function(e){return n(this.data,this.attribute.selector,e)},refreshObject:function(){var e=this.getCurrentValue();this.setData(e)}}),c=function(e){return!0},d={formClass:"n2Form",preCancel:function(e){return!(e.hasAnyValueChanged()&&!window.confirm("Form has changed. Are you sure you want to cancel?"))},postCancel:c,preReset:function(e){return!(e.hasAnyValueChanged()&&!window.confirm("Form has changed. Are you sure you want to reset it?"))},postReset:c,preOK:c,postOK:c,buttonPressed:c,onChanged:c,action:null,enctype:null,method:null,target:null,title:null,titleClass:null},u=t.Class({schema:null,inputs:null,inputsById:null,inputsByName:null,elem:null,data:null,form:null,options:null,inputChangedCallback:null,initialize:function(t,i,n,r){this.options=e.extend(!0,{},d,r),this.schema=t,this.data=n,this.elem=e(i[0]),this.inputs=[],this.inputsByName={},this.inputsById={};var o=this;this.inputChangedCallback=function(t){var i=e(this).attr("id");o._inputChanged(i)},this.render()},render:function(){this.elem.empty();var t=this,i=[];i.push("<form"),this.options.formClass&&(i.push(' class="'),i.push(this.options.formClass),i.push('"')),this.options.action&&(i.push(' action="'),i.push(this.options.action),i.push('"')),this.options.enctype&&(i.push(' enctype="'),i.push(this.options.enctype),i.push('"')),this.options.method&&(i.push(' method="'),i.push(this.options.method),i.push('"')),this.options.target&&(i.push(' target="'),i.push(this.options.target),i.push('"')),i.push("></form>");var n=e(i.join(""));if(this.form=n[0],this.options.title){var r=e("<div>"+this.options.title+"</div>");this.options.titleClass&&r.addClass(this.options.titleClass),n.append(r)}var o=e("<table></table>");n.append(o);for(var s=this.schema,a=0,l=s.attributes.length;a<l;++a){if(!(m=s.attributes[a]).isHidden()){var c=e("<tr></tr>");o.append(c);var d=e("<td>"+m.label+"</td>");c.append(d),d=e("<td></td>"),c.append(d),this._addInput(m,d)}}var u=!1;if(s.resetButton||s.okButton||s.cancelButton?u=!0:s.buttons&&s.buttons.length>0&&(u=!0),u){c=e("<tr></tr>");o.append(c);d=e("<td></td>");if(c.append(d),d=e("<td></td>"),c.append(d),s.okButton)(p=e("<button>"+s.okButtonLabel+"</button>")).button&&p.button({icons:{primary:"ui-icon-check"}}),d.append(p),p.click(function(){return t._ok(),!1});if(s.cancelButton)(p=e("<button>"+s.cancelButtonLabel+"</button>")).button&&p.button({icons:{primary:"ui-icon-cancel"}}),d.append(p),p.click(function(){return t._cancel(),!1});if(s.resetButton){var h=e("<button>"+s.resetButtonLabel+"</button>");h.button&&h.button({icons:{primary:"ui-icon-arrowrefresh-1-s"}}),d.append(h),h.click(function(){return t._reset(),!1})}if(s.buttons)for(a=0,l=s.buttons.length;a<l;++a){var p,f=s.buttons[a];(p=e("<button>"+f.label+"</button>")).button&&p.button(),d.append(p),p.click(v(this,f.name))}}for(a=0,l=s.attributes.length;a<l;++a){var m;(m=s.attributes[a]).isHidden()&&this._addInput(m,n)}function v(e,t){return function(){return e._buttonPressed(t),!1}}this.elem.append(n)},refreshFromData:function(){for(var e=0,t=this.inputs.length;e<t;++e)this.inputs[e].refreshFromData()},getInputFromName:function(e){return this.inputsByName[e]},_addInput:function(e,i){var n=t.getUniqueId(),r=new l(n,e,this.data,i,this.inputChangedCallback);this.inputs.push(r),this.inputsByName[e.name]=r,this.inputsById[n]=r},_ok:function(){this.options.preOK(this)&&(this.form.submit(),this.options.postOK(this))},_cancel:function(){this.options.preCancel(this)&&(this.elem.empty(),this.form=null,this.inputs=[],this.inputsbyName={},this.options.postCancel(this))},_reset:function(){if(this.options.preReset(this)){for(var e=0,t=this.inputs.length;e<t;++e)this.inputs[e].resetValue();this.options.postReset(this)}},_buttonPressed:function(e){this.options.buttonPressed(this,e)},_inputChanged:function(e){this.inputsById[e].refreshObject(),this.options.onChanged()},getFormElement:function(){return this.form},getInputElements:function(){for(var e=[],t=0,i=this.inputs.length;t<i;++t)e.push(this.inputs[t].getInputElement());return e},hasAnyValueChanged:function(){for(var e=0,t=this.inputs.length;e<t;++e)if(this.inputs[e].hasValueChanged())return!0;return!1}});t.form={Schema:a,Form:u}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n=t.Class({images:null,initialize:function(e){this.images=[]},getCountInfo:function(e){return{count:this.images.length,index:e+1}},getInfo:function(e){var t=null,i=this.images[e];return i&&(t={index:e,url:i.url,type:i.type,isPhotosphere:i.isPhotosphere,width:i.width,height:i.height}),t},printText:function(e,t,i){t.empty();var n=this.images[e];n&&n.text&&(t.text(n.text),i&&i(e))},loadImage:function(e,t){var i=this,n=this.images[e];if(n)if(n.loaded)t&&t(r=this.getInfo(e));else if(t&&(n.cb?n.cb.push(t):n.cb=[t]),!n.preload){n.preload=new Image,n.preload.onload=function(){var t=i.images[e];if(t.loaded=!0,t.width=t.preload.width,t.height=t.preload.height,t.preload.onload=function(){},t.cb){var n=t.cb;t.cb=null;for(var r=i.getInfo(e),o=0,s=n.length;o<s;++o)n[o](r)}};var r=this.getInfo(e);n.preload.src=r.url}},addImage:function(e,t){this.images.push({url:e,text:t,type:"image",isPhotosphere:!1})},addPhotosphere:function(e,t){this.images.push({url:e,text:t,type:"image",isPhotosphere:!0})},getPreviousIndex:function(e,t){if(!(this.images.length<2)){var i=e-1;i<0&&(i=this.images.length-1),t(i,e)}},getNextIndex:function(e,t){if(!(this.images.length<2)){var i=e+1;i>=this.images.length&&(i=0),t(i,e)}}}),r=t.Class({showService:null,dispatchService:null,images:null,initialize:function(e){var i=t.extend({showService:null,dispatchService:null},e);this.images=[],this.showService=i.showService,this.dispatchService=i.dispatchService},getCountInfo:function(e){return{count:this.images.length,index:e+1}},getInfo:function(e){var t=null,i=this.images[e];if(i){var n=i.doc,r=void 0;if(this.dispatchService){var o={type:"documentSourceFromDocument",doc:n};this.dispatchService.synchronousCall("n2.displayBox",o),r=o.documentSource}var s=void 0,a=void 0;if(r){var l=r.getDocumentAttachment(n,i.attName);s=l.computeUrl();var c=l.getOriginalAttachment();c&&(a=c.computeUrl())}var d=i.att.fileClass,u=!1;i.att.photosphere&&"panorama"===i.att.photosphere.type&&(u=!0),t={index:e,url:s,originalUrl:a,type:d,isPhotosphere:u,width:i.width,height:i.height}}return t},printText:function(e,t,i){t.empty();var n=this.images[e];n&&this.showService&&this.showService.displayBriefDescription(t,{onDisplayed:function(t,n,r,o){i&&i(e)}},n.doc)},loadImage:function(e,t){var i=this,n=this.images[e];if(n)if(n.loaded){if(t){var r=this.getInfo(e);t({index:e,url:r.url,type:r.type,isPhotosphere:r.isPhotosphere,width:n.width,height:n.height})}}else if(t&&(n.cb?n.cb.push(t):n.cb=[t]),!n.preload){r=this.getInfo(e);n.preload=new Image,n.preload.onload=function(){var t=i.images[e];if(t.loaded=!0,t.width=t.preload.width,t.height=t.preload.height,t.preload.onload=function(){},t.cb){var n=t.cb;t.cb=null;for(var o=0,s=n.length;o<s;++o)n[o]({index:e,url:r.url,type:r.type,isPhotosphere:r.isPhotosphere,width:t.width,height:t.height})}},n.preload.src=r.url}},addDocument:function(e,t){var i=null;e&&e.nunaliit_attachments&&e.nunaliit_attachments.files&&e.nunaliit_attachments.files[t]&&(i=e.nunaliit_attachments.files[t]),i&&this.images.push({doc:e,att:i,attName:t})},getPreviousIndex:function(e,t){if(!(this.images.length<2)){var i=e-1;i<0&&(i=this.images.length-1),t(i,e)}},getNextIndex:function(e,t){if(!(this.images.length<2)){var i=e+1;i>=this.images.length&&(i=0),t(i,e)}}}),o=t.Class({overlayId:null,displayDivId:null,settings:null,windowResizeHandler:null,resizing:null,imageSource:null,currentImageIndex:null,currentImage:null,currentGeometries:null,imageLastClick:null,clickOrigin:null,initialize:function(i){var r=t.extend({url:null,text:null,imageSource:null,startIndex:0},i),o=this;this.resizing=!1,this.currentImageIndex=r.startIndex,this.currentGeometries={},this.imageLastClick=0,this.clickOrigin=null,this._initSettings(),this._refreshCurrentGeometries(),this.windowResizeHandler=function(){o._windowResized()},e(window).on("resize",this.windowResizeHandler),r.imageSource?this.imageSource=r.imageSource:(this.imageSource=new n,r.url&&r.text&&this.imageSource.addImage(r.url,r.text)),this._draw(),this._setImageToView()},_draw:function(){var n=this,r=e("body");e("embed, object, select").css("visibility","hidden"),this.overlayId=t.getUniqueId();var o=e("<div>").attr("id",this.overlayId).addClass("n2DisplayBoxOverlay").appendTo(r);this.displayDivId=t.getUniqueId();var s=e("<div>").attr("id",this.displayDivId).addClass("n2DisplayBoxOuter").appendTo(r),a=e("<div>").addClass("n2DisplayBoxTitleBar").appendTo(s);e("<a>").attr("href","#").attr("title",i("Close")).addClass("n2DisplayBoxButtonClose").appendTo(a).click(function(){return n._close(),!1});var l=e("<div>").addClass("n2DisplayBoxImageOuter").appendTo(s),c=e("<div>").addClass("n2DisplayBoxImageInner").appendTo(l).click(function(e){return e.preventDefault(),!1}).bind("selectstart",function(e){return e.preventDefault(),!1});e("<a>").attr("href","#").addClass("n2DisplayBoxNavBtn n2DisplayBoxNavBtnPrev").appendTo(c).bind("click",function(e){return e.preventDefault(),n._previousImage(),!1}),e("<a>").attr("href","#").addClass("n2DisplayBoxNavBtn n2DisplayBoxNavBtnNext").appendTo(c).bind("click",function(e){return e.preventDefault(),n._nextImage(),!1});var d=e("<div>").addClass("n2DisplayBoxLoading").appendTo(c),u=e("<a>").addClass("n2DisplayBoxLoadingLink").attr("href","#").appendTo(d).click(function(){return n._close(),!1});e("<img>").addClass("n2DisplayBoxLoadingImg").appendTo(u);var h=e("<div>").addClass("n2DisplayBoxDataOuter").appendTo(s).click(function(e){return n._isPassThruEvent(e)}),p=e("<div>").addClass("n2DisplayBoxDataInner").appendTo(h),f=e("<div>").addClass("n2DisplayBoxDataDetails").appendTo(p);e("<span>").addClass("n2DisplayBoxDataCaption").appendTo(f),e("<span>").addClass("n2DisplayBoxDataNumber").appendTo(f);var m=e("<div>").addClass("n2DisplayBoxButtons").appendTo(p);e("<a>").attr("href","#").attr("title",i("Download")).attr("download","image").addClass("n2DisplayBoxButtonDownload n2DisplayBox_passThru").appendTo(m),o.css({backgroundColor:this.settings.overlayBgColor,opacity:this.settings.overlayOpacity}).fadeIn().click(function(){return n._close(),!1}),s.hide().click(function(e){return!!n._isPassThruEvent(e)||(n._close(),!1)}),this._resizeOverlay(),this._resizeDisplay()},_close:function(){var t=this._getOverlayDiv();this._getDisplayDiv().remove(),t.fadeOut(function(){t.remove()}),e("embed, object, select").css("visibility","visible"),this.imageSource=null},_windowResized:function(){var t=this,i=this._getOverlayDiv(),n=this._getDisplayDiv();i.length<1&&n.length<1?e(window).off("resize",this.windowResizeHandler):(i.hide(),n.hide(),window.setTimeout(function(){t._refreshCurrentGeometries(),t._resizeOverlay(),t._resizeDisplay()},0))},_refreshCurrentGeometries:function(){var e=this._getPageSize();this.currentGeometries.pageHeight=e.pageHeight,this.currentGeometries.pageWidth=e.pageWidth,this.currentGeometries.windowWidth=e.windowWidth,this.currentGeometries.windowHeight=e.windowHeight;var t=this._getPageScroll();this.currentGeometries.xScroll=t.xScroll,this.currentGeometries.yScroll=t.yScroll},_resizeOverlay:function(){this._getOverlayDiv().css({width:this.currentGeometries.pageWidth,height:this.currentGeometries.pageHeight}).show()},_resizeDisplay:function(){this._getDisplayDiv().css({top:this.currentGeometries.yScroll+this.currentGeometries.windowHeight/10,left:this.currentGeometries.xScroll}),this._resizeContainerImageBox()},_resizeContainerImageBox:function(){if(!this.resizing){var e=this._getDisplayDiv();if(!(e.length<1)){var t=this;this.resizing=!0;var i=this._computeMinMaxRatios();if(i&&this.currentImage){"number"==typeof this.currentImage.ratio?(this.currentImage.ratio<i.min&&(this.currentImage.ratio=i.min),this.currentImage.ratio>i.max&&(this.currentImage.ratio=i.max)):this.currentImage.ratio=i.min,this.currentImage.viewFullImage&&(this.currentImage.ratio=i.min);var n=Math.floor(this.currentImage.ratio*this.currentImage.width),r=Math.floor(this.currentImage.ratio*this.currentImage.height),o=Math.floor(i.min*this.currentImage.width),s=Math.floor(i.min*this.currentImage.height);this.currentGeometries.imageWrapperWidth=o,this.currentGeometries.imageWrapperHeight=s,e.css({top:"30px",left:0}).show(),e.find(".n2DisplayBoxImageWrapper").css({width:o,height:s}).hide(),e.find(".n2DisplayBoxImage").css({width:n,height:r}),e.find(".n2DisplayBoxLoadingLink").show(),e.find(".n2DisplayBoxDataOuter").hide(),e.find(".n2DisplayBoxDataNumber").hide();var a=o+2*this.settings.containerBorderSize,l=s+2*this.settings.containerBorderSize;e.find(".n2DisplayBoxTitleBar").css({width:o}),e.find(".n2DisplayBoxImageOuter").css({width:a,height:l}),window.setTimeout(function(){t._showImage()},0),e.find(".n2DisplayBoxDataOuter").css({width:o})}this.resizing=!1}}},_computeMinMaxRatios:function(){var e=null;if(this.currentImage){var t=this.currentImage.width,i=this.currentImage.height;if(this.settings.constrainImage){var n=1,r=this.currentGeometries.windowWidth-2*this.settings.containerBorderSize;t>r&&(n=r/t);var o=this.currentGeometries.windowHeight-2*this.settings.containerBorderSize-60-100;if(i>o){var s=o/i;s<n&&(n=s)}e={min:n,max:1}}else e={min:1,max:1}}return e},_showImage:function(){var e=this,t=this._getDisplayDiv();t.find(".n2DisplayBoxLoading").hide(),t.find(".n2DisplayBoxImageWrapper").fadeIn(function(){e._showImageData(),e._setNavigation(),e._imagePositionUpdated()}),e._preloadNeighborImages()},_showImageData:function(){var e=this,t=this._getDisplayDiv();t.find(".n2DisplayBoxDataOuter").slideDown("fast");var n=t.find(".n2DisplayBoxDataCaption").hide();this.imageSource.printText(this.currentImageIndex,n,function(t){e.currentImageIndex==t&&n.show()});var r=this.imageSource.getCountInfo(this.currentImageIndex);if(r){var o=i("{index}/{count}",{index:r.index,count:r.count});t.find(".n2DisplayBoxDataNumber").text(o).show()}else t.find(".n2DisplayBoxDataNumber").hide();var s=this.imageSource.getInfo(this.currentImageIndex),a=s.originalUrl;a||(a=s.url);var l=s.name;if(!l){var c=a.split("/");c.length>0?(l=c[c.length-1],l=decodeURIComponent(l)):l="image"}var d=t.find(".n2DisplayBoxButtonDownload");d.attr("href",a),d.attr("download",l)},_setNavigation:function(){var e=this,t=this._getDisplayDiv();t.find(".n2DisplayBoxNavBtnPrev").hide(),this.imageSource.getPreviousIndex(this.currentImageIndex,function(i,n){e.currentImageIndex===n&&t.find(".n2DisplayBoxNavBtnPrev").show()}),t.find(".n2DisplayBoxNavBtnNext").hide(),this.imageSource.getNextIndex(this.currentImageIndex,function(i,n){e.currentImageIndex===n&&t.find(".n2DisplayBoxNavBtnNext").show()})},_nextImage:function(){var e=this;this.imageSource.getNextIndex(this.currentImageIndex,function(t){e.currentImageIndex=t,e._setImageToView()})},_previousImage:function(){var e=this;this.imageSource.getPreviousIndex(this.currentImageIndex,function(t){e.currentImageIndex=t,e._setImageToView()})},_setImageToView:function(){var i=this,n=this._getDisplayDiv();n.find(".n2DisplayBoxLoading").show(),n.find(".n2DisplayBoxDataOuter").hide(),n.find(".n2DisplayBoxDataNumber").hide(),n.find(".n2DisplayBoxNavBtn").hide(),n.find(".n2DisplayBoxImageWrapper").remove(),n.find(".n2DisplayBoxImageZoom").remove(),this.imageSource.loadImage(this.currentImageIndex,function(r){if(i.currentImageIndex===r.index){var o=n.find(".n2DisplayBoxImageInner");if(o.find(".n2DisplayBoxImageWrapper").remove(),i.currentImage={width:r.width,height:r.height,viewFullImage:!0,top:0,left:0},"image"===r.type)if(r.isPhotosphere&&t.photosphere&&t.photosphere.IsAvailable()){var s=e("<div>").addClass("n2DisplayBoxImageWrapper").prependTo(o);new t.photosphere.PhotosphereDisplay({elem:s,url:r.url}),i.currentImage.width=Math.floor(3*i.currentImage.height/2)}else{var a=e("<div>").addClass("n2DisplayBoxImageWrapper").prependTo(o).mouseout(function(e){i._imageMouseOut(e)});e("<img>").addClass("n2DisplayBoxImage").attr("src",r.url).appendTo(a).mousedown(function(e){i._imageMouseDown(e)}).mousemove(function(e){i._imageMouseMove(e)}).mouseup(function(e){i._imageMouseUp(e)}),e("<div>").addClass("n2DisplayBoxImageZoom n2DisplayBoxImageZoomPlus").appendTo(o).click(function(e){return e.preventDefault(),i._imageZoom(1),!1}),e("<div>").addClass("n2DisplayBoxImageZoom n2DisplayBoxImageZoomMinus").appendTo(o).click(function(e){return e.preventDefault(),i._imageZoom(-1),!1})}i._resizeContainerImageBox()}})},_preloadNeighborImages:function(){var e=this;this.imageSource.getPreviousIndex(this.currentImageIndex,function(t){e.imageSource.loadImage(t)}),this.imageSource.getNextIndex(this.currentImageIndex,function(t){e.imageSource.loadImage(t)})},_getDisplayDiv:function(){return e("#"+this.displayDivId)},_getOverlayDiv:function(){return e("#"+this.overlayId)},_getPageSize:function(){var e,t,i=0,n=0;return window.innerHeight&&window.scrollMaxY?(e=window.innerWidth+window.scrollMaxX,t=window.innerHeight+window.scrollMaxY):document.body.scrollHeight>document.body.offsetHeight?(e=document.body.scrollWidth,t=document.body.scrollHeight):(e=document.body.offsetWidth,t=document.body.offsetHeight),window.self.innerHeight?(i=document.documentElement.clientWidth?document.documentElement.clientWidth:window.self.innerWidth,n=document.documentElement.clientWidth?document.documentElement.clientHeight:window.self.innerHeight):document.documentElement&&document.documentElement.clientHeight?(i=document.documentElement.clientWidth,n=document.documentElement.clientHeight):document.body&&(i=document.body.clientWidth,n=document.body.clientHeight),{pageWidth:e<i?e:i,pageHeight:t<n?n:t,windowWidth:i,windowHeight:n}},_getPageScroll:function(){var e=0,t=0;return window.self.pageYOffset?(t=window.self.pageYOffset,e=window.self.pageXOffset):document.documentElement&&document.documentElement.scrollTop?(t=document.documentElement.scrollTop,e=document.documentElement.scrollLeft):document.body&&(t=document.body.scrollTop,e=document.body.scrollLeft),{xScroll:e,yScroll:t}},_initSettings:function(){this.settings={overlayBgColor:"#000",overlayOpacity:.8,containerBorderSize:10,constrainImage:!0}},_imageZoom:function(e){if(!(this._getDisplayDiv().length<1)){var t=this.currentImage.ratio;if("number"==typeof t){e>0?t+=.25:t-=.25,this.currentImage.viewFullImage=!1;var i=this._computeMinMaxRatios();if(i){t<i.min&&(t=i.min),t>i.max&&(t=i.max);var n=this.currentGeometries.imageWrapperWidth/2-this.currentImage.left;n/=this.currentImage.ratio;var r=this.currentGeometries.imageWrapperHeight/2-this.currentImage.top;r/=this.currentImage.ratio,this.currentImage.ratio=t,this.currentImage.left=Math.floor(this.currentGeometries.imageWrapperWidth/2-n*this.currentImage.ratio),this.currentImage.top=Math.floor(this.currentGeometries.imageWrapperHeight/2-r*this.currentImage.ratio),this._imagePositionUpdated()}}}},_imagePositionUpdated:function(){var e=this._getDisplayDiv();if(!(e.length<1)){var t=e.find(".n2DisplayBoxImage"),i=this.currentImage.height*this.currentImage.ratio,n=this.currentImage.width*this.currentImage.ratio,r=this.currentGeometries.imageWrapperHeight-i,o=this.currentGeometries.imageWrapperWidth-n;this.currentImage.top>0&&(this.currentImage.top=0),this.currentImage.top<r&&(this.currentImage.top=r),this.currentImage.left>0&&(this.currentImage.left=0),this.currentImage.left<o&&(this.currentImage.left=o),t.css({height:i,width:n,top:this.currentImage.top,left:this.currentImage.left,position:"relative"});var s=this._computeMinMaxRatios();this.currentImage.ratio<=s.min?e.find(".n2DisplayBoxImageZoomMinus").addClass("n2DisplayBoxImageZoomDisabled"):e.find(".n2DisplayBoxImageZoomMinus").removeClass("n2DisplayBoxImageZoomDisabled"),this.currentImage.ratio>=s.max?e.find(".n2DisplayBoxImageZoomPlus").addClass("n2DisplayBoxImageZoomDisabled"):e.find(".n2DisplayBoxImageZoomPlus").removeClass("n2DisplayBoxImageZoomDisabled")}},_imageMouseDown:function(e){e.preventDefault();var t=(new Date).getTime();this.imageLastClick>t-200?this._imageZoom(1):this.imageLastClick=t,this.currentImage.startLeft=this.currentImage.left,this.currentImage.startTop=this.currentImage.top,this.clickOrigin=this._getEventCoords(e)},_imageMouseUp:function(e){this.clickOrigin=null},_imageMouseOut:function(e){this.clickOrigin=null},_imageMouseMove:function(e){if(this.clickOrigin){e.preventDefault();var t=this._getEventCoords(e);return this.currentImage.left=this.currentImage.startLeft+(t[0]-this.clickOrigin[0]),this.currentImage.top=this.currentImage.startTop+(t[1]-this.clickOrigin[1]),this._imagePositionUpdated(),!1}return!0},_getEventCoords:function(e){var t=[];return e.touches&&e.touches.length?(t[0]=e.touches[0].clientX,t[1]=e.touches[0].clientY):(t[0]=e.clientX,t[1]=e.clientY),t},_isPassThruEvent:function(t){var i=e(t.target),n=!1;(i.hasClass("n2DisplayBox_passThru")&&(n=!0),n)||i.parents(".n2DisplayBox_passThru").length>0&&(n=!0);return n}});t.displayBox={DisplayBox:o,DisplayImageSource:n,DisplayImageSourceDoc:r}}(jQuery,nunaliit2),function(e,t){var i="http://www.maptiler.org/img/none.png",n=t.Class({url:null,extension:null,elemId:null,mapBounds:null,mapMinZoom:null,mapMaxZoom:null,numZoomLevels:null,maxResolution:null,docId:null,showService:null,initialize:function(i){var n,r=t.extend({url:null,parent:null,tileMapResourceName:null,extension:"png",docId:null,showService:null},i),o=this;if(this.url=r.url,this.extension=r.extension,this.docId=r.docId,this.showService=r.showService,"string"==typeof r.parent?(n=e("#"+r.parent)).length<1&&(n=void 0):r.parent&&(n=e(r.parent)),n||(n=e(".nunaliit_content").first()).length<1&&(n=void 0),n||(n=e("body")),this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2TiledImage").appendTo(n),r.tileMapResourceName){var s=this.url+"/"+r.tileMapResourceName;e.ajax({url:s,type:"get",async:!0,dataType:"xml",success:function(e){o._readTimeMapResourceDoc(e)},error:function(e,i,n){var r,o;alert((r="Unable to retrieve time map resource at {url}",o={url:s},t.loc(r,"nunaliit2",o)))}})}},_draw:function(){var i=this,n=e("#"+this.elemId).empty(),r=e("<div>").addClass("n2TiledImage_container").appendTo(n),o=t.getUniqueId();e("<div>").attr("id",o).addClass("n2TiledImage_map").appendTo(r);var s=e("<div>").addClass("n2TiledImage_footer").appendTo(r);if(e("<div>").addClass("n2TiledImage_close").appendTo(s).click(function(){return i._close(),!1}),this.docId&&this.showService){var a=e("<div>").addClass("n2TiledImage_desc").appendTo(s);this.showService.printBriefDescription(a,this.docId)}this._drawMap(o)},_drawMap:function(e){var t=this,n={div:e,controls:[],maxExtent:this.mapBounds,maxResolution:this.maxResolution,numZoomLevels:this.numZoomLevels},r=new OpenLayers.Map(n),o=new OpenLayers.Layer.TMS("TMS Layer","",{serviceVersion:".",layername:".",alpha:!0,type:this.extension,getURL:function(e){e=this.adjustBounds(e);var n=this.getServerResolution(),r=Math.round((e.left-this.tileOrigin.lon)/(n*this.tileSize.w)),o=Math.round((e.bottom-this.tileOrigin.lat)/(n*this.tileSize.h)),s=this.getServerZoom(),a="/"+s+"/"+r+"/"+o+"."+this.type,l=t.url;OpenLayers.Util.isArray(l)&&(l=this.selectUrl(a,l));return t.mapBounds.intersectsBounds(e)&&s>=t.mapMinZoom&&s<=t.mapMaxZoom?l+a:i}});r.addLayer(o),r.zoomToExtent(this.mapBounds),r.addControls([new OpenLayers.Control.Zoom,new OpenLayers.Control.Navigation])},_close:function(){e("#"+this.elemId).remove()},_readTimeMapResourceDoc:function(e){var i=this;t.log("Time Map Resource",e);for(var n=e.documentElement.childNodes,r=0;r<n.length;++r){var o=n.item(r);1===o.nodeType&&("BoundingBox"===o.localName?s(o):"TileFormat"===o.localName?a(o):"TileSets"===o.localName&&l(o))}function s(e){var t=e.attributes,n=0,r=0,o=0,s=0,a=t.getNamedItem("minx");a&&(n=1*a.value);var l=t.getNamedItem("maxx");l&&(r=1*l.value);var c=t.getNamedItem("miny");c&&(o=1*c.value);var d=t.getNamedItem("maxy");d&&(s=1*d.value),i.mapBounds=new OpenLayers.Bounds(n,o,r,s)}function a(e){var t=e.attributes.getNamedItem("extension");t&&(i.extension=t.value)}function l(e){for(var t=void 0,n=void 0,r=void 0,o=0,s=e.childNodes,a=0;a<s.length;++a){var l=s.item(a);if(1===l.nodeType&&"TileSet"===l.localName){var c=l.attributes,d=c.getNamedItem("href");if(d){var u=1*d.value;++o,void 0===t?t=u:t>u&&(t=u),void 0===n?n=u:n<u&&(n=u)}var h=c.getNamedItem("units-per-pixel");if(h){var p=1*h.value;void 0===r?r=p:r<p&&(r=p)}}}void 0!==t&&(i.mapMinZoom=t),void 0!==n&&(i.mapMaxZoom=n),void 0!==r&&(i.maxResolution=r),i.numZoomLevels=o}this._draw()}});t.displayTiledImage={DisplayTiledImage:n}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n=i("View Media"),r={autoOpen:!0,modal:!0,dialogClass:"n2MediaDisplayDialog"};t.MediaDisplay=t.Class({initialize:function(){},displayMedia:function(i){var n=t.extend({type:null,url:null,mimeType:null,title:null,author:null,description:null,width:null,height:null,suppressLeaveConfirmation:!1,onClose:function(e){},onError:function(e){t.reportError(e)}},i);n.onCloseHook=function(e,t){n.onClose(n)},null==n.url&&n.onError("URL must be provided to display a media"),"image"===n.type?this._displayImage(n):"photosphere"===n.type?this._displayPhotosphere(n):"audio"===n.type?e.fn&&e.fn.mediaelementplayer?this._displayAudioMediaElement(n):this._displayAudio(n):"video"===n.type?e.fn&&e.fn.mediaelementplayer?this._displayVideoMediaElement(n):this._displayVideo(n):n.suppressLeaveConfirmation?window.location.href=n.url:this._displayUnknown(n)},_displayImage:function(i){if(e.lightBox){var o="";i.metaDataHtml?o=i.metaDataHtml:(i.title&&(o+=i.title),i.author&&(o+=" (by "+i.author+")"),i.description&&(o+=" <br />"+i.description)),e.lightBox({},[{href:i.url,title:o}])}else{var s=n;i.title&&(s=i.title);var a=t.getUniqueId(),l="image";i.title&&(l=i.title);var c=e('<div id="'+a+'"><img alt="'+l+'"/></div>'),d=e('<div class="n2_dialogMetaData"></div>');c.append(d),this._addMetaData(i,d);var u=t.extend({},r,{title:s,width:360,height:360,close:function(){e("#"+a).remove(),i.onCloseHook()}});c.dialog(u);var h=new Image;h.onload=function(){var t=e("#"+a);t.find("img").attr("src",i.url);var n=h.width,r=h.height;h.onload=function(){};var o=t.find(".n2_dialogMetaData"),s=o.width()||0,l=n;l<s&&(l=s);var c=r+(o.height()||0);t.dialog("option","width",l+30),t.dialog("option","height",c+60)},h.src=i.url}},_displayPhotosphere:function(i){if(t.photosphere.IsAvailable()){var o=n;i.title&&(o=i.title);var s=t.getUniqueId();i.title&&i.title;var a=e("<div>").attr("id",s),l=e("<div>").addClass("n2MediaDisplayPhotosphere").appendTo(a),c=e("<div>").addClass("n2_dialogMetaData").appendTo(a);this._addMetaData(i,c);var d=t.extend({},r,{title:o,width:1024,height:600,close:function(){e("#"+s).remove(),i.onCloseHook()}});a.dialog(d),new t.photosphere.PhotosphereDisplay({elem:l,url:i.url})}else this._displayImage(i)},_displayVideo:function(i){var o=n;i.title&&(o=i.title);var s=t.getUniqueId(),a=[];a.push('<div id="'+s+'">');var l=t.utils.getBrowserInfo();if("Safari"===l.browser&&5<=l.version)var c=this.generateHtml5Tag({url:i.url,sourceType:"video",mimeType:i.mimeType,autoplay:!0,loop:!1,controller:!0});else{var d=t.extend({},{url:i.url,sourceType:"video",mimeType:i.mimeType,controller:!0});i.mediaDisplayVideoWidth?d.width=i.mediaDisplayVideoWidth:i.width?d.width=i.width:d.width=320,i.mediaDisplayVideoHeight?d.height=i.mediaDisplayVideoHeight+16:i.height?d.height=i.height+16:d.height=256;c=this.generateEmbedMarkup(d)}a.push(c),a.push("</div>");var u=e(a.join(""));this._addMetaData(i,u),this._addDownloadButton(i,u);var h=t.extend({},r,{title:o,close:function(){e("#"+s).remove(),i.onCloseHook()}});i.mediaDisplayVideoWidth?h.width=i.mediaDisplayVideoWidth+40:i.width?h.width=i.width+40:h.width=360,i.mediaDisplayVideoHeight&&(h.height=i.mediaDisplayVideoHeight+56),u.dialog(h)},_displayVideoMediaElement:function(i){var o=n;i.title&&(o=i.title);var s=t.getUniqueId(),a=t.getUniqueId(),l=320;i.mediaDisplayVideoWidth?l=i.mediaDisplayVideoWidth:i.width&&(l=i.width);var c=240;i.mediaDisplayVideoHeight?c=i.mediaDisplayVideoHeight+16:i.height&&(c=i.height+16);var d=[];d.push('<div id="'+s+'">'),d.push('<video id="'+a+'" controls="controls"  width="'+l+'" height="'+c+'">'),d.push('<source src="'+i.url+'"'),i.mimeType&&d.push(' type="'+i.mimeType+'"'),d.push(">"),d.push("</video>");var u=e(d.join(""));this._addMetaData(i,u),this._addDownloadButton(i,u);var h=t.extend({},r,{title:o,width:l+25,close:function(){e("#"+s).remove(),i.onCloseHook()}});u.dialog(h),e("#"+a).mediaelementplayer({features:["playpause","progress","volume","sourcechooser","fullscreen"]})},_displayAudio:function(i){var o=n;i.title&&(o=i.title);var s=t.getUniqueId();if(e.jPlayer){var a=e('<div id="'+s+'"></div>'),l=e('<div class="n2Media_jPlayer"></div>');a.append(l)}else{var c=t.utils.getBrowserInfo(),d=[];if(d.push('<div id="'+s+'">'),"Safari"===c.browser&&5<=c.version)var u=this.generateHtml5Tag({url:i.url,sourceType:"audio",mimeType:i.mimeType,autoplay:!0,loop:!1,controller:!0});else{var h={url:i.url,sourceType:"audio",mimeType:i.mimeType,controller:!0};u=this.generateEmbedMarkup(h)}d.push(u),d.push("</div>");a=e(d.join(""))}this._addMetaData(i,a),this._addDownloadButton(i,a);var p=t.extend({},r,{title:o,width:320,close:function(){e("#"+s).remove(),i.onCloseHook()}});(a.dialog(p),e.jPlayer)&&(l=a.find(".n2Media_jPlayer")).jPlayer({ready:function(){e(this).jPlayer("setMedia",{mp3:i.url})},swfPath:"./js-external/jQuery.jPlayer/",size:{width:100,height:100}})},_displayAudioMediaElement:function(i){var o=n;i.title&&(o=i.title);var s=t.getUniqueId(),a=t.getUniqueId(),l=(t.utils.getBrowserInfo(),[]);l.push('<div id="'+s+'">'),l.push('<audio id="'+a+'" controls="controls" width="300">'),l.push('<source src="'+i.url+'"'),i.mimeType&&l.push(' type="'+i.mimeType+'"'),l.push(">"),l.push("</audio>"),l.push("</div>");var c=e(l.join(""));this._addMetaData(i,c),this._addDownloadButton(i,c);var d=t.extend({},r,{title:o,width:325,close:function(){e("#"+s).remove(),i.onCloseHook()}});c.dialog(d),e("#"+a).mediaelementplayer({features:["playpause","progress","volume","sourcechooser"]})},_displayUnknown:function(o){var s=n;o.title&&(s=o.title);var a=t.getUniqueId(),l=e("<div></div>");l.attr("id",a);e("<div></div>").appendTo(l);this._addMetaData(o,l);var c=e('<div class="n2Media_explain"></div>');c.text(i("You must leave the atlas to view this file.")),l.append(c);var d=e('<div class="n2Display_buttons"></div>').appendTo(l);e('<a class="nunaliit_form_link"></a>').attr("href",o.url).text(i("Proceed")).appendTo(d);var u=t.extend({},r,{title:s,width:320,close:function(){e("#"+a).remove(),o.onCloseHook()}});l.dialog(u)},_addMetaData:function(t,n){if(n.append(e("<br/>")),t.metaDataHtml){var r=e("<span></span>");r.html(t.metaDataHtml),n.append(r)}else{if(t.author){var o=e("<span></span>");o.text(i("(by {author})",{author:t.author})),n.append(o),n.append(e("<br/>"))}if(t.description){var s=e("<span></span>");s.text(t.description),n.append(s)}}},_addDownloadButton:function(t,n){e("<a>").attr("href",t.url).attr("title",i("Download")).addClass("n2DisplayBoxButtonDownload").click(function(e){return!!t.suppressLeaveConfirmation||!!confirm(i("You are about to leave this page. Do you wish to continue?"))}).appendTo(n)},generateInlineHtmlForMedia:function(e){var n=t.extend({type:null,url:null,mimeType:null,autoplay:!0,caption:null,headerHtml:null,footerHtml:null,onError:function(e){t.reportError(e)}},e),r=[];if(r.push("<div><p>"),n.headerHtml&&(r.push(n.headerHtml),r.push("</p><p>")),"image"===n.type)r.push('<img src="'+n.url+'" alt="'),"string"==typeof n.caption&&""!==n.caption?r.push(n.caption):r.push(i("an image")),r.push('"/>');else if("video"===n.type){var o=this.generateEmbedMarkup({url:n.url,sourceType:"video",mimeType:n.mimeType,width:320,height:256,autoplay:n.autoplay});r.push(o)}else if("audio"===n.type){var s=t.utils.getBrowserInfo(),a={url:n.url,sourceType:"audio",mimeType:n.mimeType,width:250,autoplay:n.autoplay};"Safari"===s.browser&&(a.height=16);o=this.generateEmbedMarkup(a);r.push(o)}return n.footerHtml&&(r.push("</p><p>"),r.push(n.footerHtml)),r.push("</p></div>"),r.join("")},generateEmbedMarkup:function(e){var i=t.extend({url:null,sourceType:null,mimeType:null,width:null,height:null,autoplay:!1,loop:!1,controller:!1},e);if("function"==typeof QT_GenerateOBJECTText){var n=[];return n.push(i.url),n.push(i.width),n.push(i.height),n.push(""),i.autoplay&&(n.push("autoplay"),n.push("true")),i.loop&&(n.push("loop"),n.push("true")),i.controller&&(n.push("controller"),n.push("true")),QT_GenerateOBJECTText.apply(null,n)}var r=[];return r.push("<object"),i.width&&r.push(' width="'+i.width+'"'),i.height&&r.push(' height="'+i.height+'"'),r.push(' codebase="http://www.apple.com/qtactivex/qtplugin.cab#version=7,3,0,0"'),r.push('classid="clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B"'),r.push('><param name="src" value="'),r.push(i.url),r.push('">'),r.push('<param name="autoplay" value="'),i.autoplay?r.push('true">'):r.push('false">'),i.controller&&r.push('<param name="controller" value="true">'),i.loop&&r.push('<param name="loop" value="true">'),r.push("<embed"),i.width&&r.push(' width="'+i.width+'"'),i.height&&r.push(' height="'+i.height+'"'),i.autoplay?r.push(' autoplay="true"'):r.push(' autoplay="false"'),i.controller&&r.push(' controller="true"'),i.loop&&r.push(' loop="true"'),r.push(' pluginspage="http://www.apple.com/quicktime/download/" src="'),r.push(i.url),r.push('"></embed></object>'),r.join("")},generateHtml5Tag:function(e){var i=t.extend({url:null,sourceType:null,mimeType:null,width:null,height:null,autoplay:!1,loop:!1,controller:!1},e),n=[];if("video"===i.sourceType)n.push("<video");else{if("audio"!==i.sourceType)return null;n.push("<audio")}if(i.width&&n.push(' width="'+i.width+'"'),i.height&&n.push(' height="'+i.height+'"'),i.controller&&n.push(' controls="controls"'),i.autoplay&&n.push(' autoplay="autoplay"'),n.push(' src="'),n.push(i.url),n.push('"'),i.mimeType&&n.push(' type="'+i.mimeType+'"'),n.push(">"),n.push("<embed"),i.width&&n.push(' width="'+i.width+'"'),i.height&&n.push(' height="'+i.height+'"'),i.autoplay?n.push(' autoplay="true"'):n.push(' autoplay="false"'),i.controller&&n.push(' controller="true"'),i.loop&&n.push(' loop="true"'),n.push(' src="'),n.push(i.url),n.push('"></embed>'),"video"===i.sourceType)n.push("</video>");else{if("audio"!==i.sourceType)return null;n.push("</audio>")}return n.join("")}}),t.mediaDisplay=new t.MediaDisplay}(jQuery,nunaliit2),function(e){var t=e.Class({elemId:null,camera:null,scene:null,renderer:null,isUserInteracting:null,hasUserInteracted:null,onMouseDownMouseX:null,onMouseDownMouseY:null,lon:null,lat:null,onMouseDownLon:null,onMouseDownLat:null,phi:null,theta:null,animateFn:null,lastCanvasWidth:null,lastCanvasHeight:null,initialize:function(t){var i=e.extend({elem:null,url:null},t),n=this;this.isUserInteracting=!1,this.hasUserInteracted=!1,this.onMouseDownMouseX=0,this.onMouseDownMouseY=0,this.lon=0,this.lat=0,this.onMouseDownLon=0,this.onMouseDownLat=0,this.phi=0,this.theta=0,this.animateFn=function(){n._animate()},this.lastCanvasWidth=-1,this.lastCanvasHeight=-1;var r=i.elem;this.elemId=e.utils.getElementIdentifier(r);var o=this._getCanvasSize();this.camera=new THREE.PerspectiveCamera(75,o.width/o.height,1,1100),this.camera.target=new THREE.Vector3(0,0,0),this.scene=new THREE.Scene;var s=new THREE.SphereGeometry(500,60,40);s.applyMatrix((new THREE.Matrix4).makeScale(-1,1,1));var a=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(i.url)}),l=new THREE.Mesh(s,a);this.scene.add(l),this.renderer=new THREE.WebGLRenderer,this.renderer.setSize(o.width,o.height),r[0].appendChild(this.renderer.domElement),r.mousedown(function(e){e.preventDefault(),n.isUserInteracting=!0,n.hasUserInteracted=!0,n.onPointerDownPointerX=e.clientX,n.onPointerDownPointerY=e.clientY,n.onPointerDownLon=n.lon,n.onPointerDownLat=n.lat}),r.mousemove(function(e){!0===n.isUserInteracting&&(n.lon=.1*(n.onPointerDownPointerX-e.clientX)+n.onPointerDownLon,n.lat=.1*(e.clientY-n.onPointerDownPointerY)+n.onPointerDownLat)}),r.mouseup(function(e){n.isUserInteracting=!1}),r.mouseout(function(e){n.isUserInteracting=!1}),r.on("mousewheel",function(e){e.originalEvent&&(e=e.originalEvent),n.hasUserInteracted=!0,e.wheelDeltaY?n.camera.fov-=.05*e.wheelDeltaY:e.wheelDelta?n.camera.fov-=.05*e.wheelDelta:e.detail&&(n.camera.fov+=1*e.detail),n.camera.fov<1?n.camera.fov=1:n.camera.fov>100&&(n.camera.fov=100),n.camera.updateProjectionMatrix()}),r.on("DOMMouseScroll",function(e){e.wheelDeltaY?n.camera.fov-=.05*e.wheelDeltaY:e.wheelDelta?n.camera.fov-=.05*e.wheelDelta:e.detail&&(n.camera.fov+=1*e.detail),n.camera.fov<1?n.camera.fov=1:n.camera.fov>100&&(n.camera.fov=100),n.camera.updateProjectionMatrix()}),this._animate()},_animate:function(){if(this._getElem().length>0){window.requestAnimationFrame(this.animateFn);var e=this._getCanvasSize();e.width===this.lastCanvasWidth&&e.height===this.lastCanvasHeight||(this._onCanvasResize(),this.lastCanvasWidth=e.width,this.lastCanvasHeight=e.height),this._update()}},_update:function(){!1===this.hasUserInteracted&&(this.lon+=.1),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=THREE.Math.degToRad(90-this.lat),this.theta=THREE.Math.degToRad(this.lon),this.camera.target.x=500*Math.sin(this.phi)*Math.cos(this.theta),this.camera.target.y=500*Math.cos(this.phi),this.camera.target.z=500*Math.sin(this.phi)*Math.sin(this.theta),this.camera.lookAt(this.camera.target),this.renderer.render(this.scene,this.camera)},_getElem:function(){return $("#"+this.elemId)},_getCanvasSize:function(){var e={},t=this._getElem();return e.width=t.width(),e.height=t.height(),e},_onCanvasResize:function(){var e=this._getCanvasSize();this.camera.aspect=e.width/e.height,this.camera.updateProjectionMatrix(),this.renderer.setSize(e.width,e.height)}});e.photosphere={PhotosphereDisplay:t,IsAvailable:function(){return void 0!==window.THREE}}}(nunaliit2),function(e,t){var i=t.Class({descriptor:null,data:null,entries:null,isCellsData:null,isListData:null,initialize:function(e){var i=t.extend({descriptor:null,data:null,isCellsData:!1,isListData:!1},e);this.descriptor=i.descriptor,this.data=i.data,this.isCellsData=i.isCellsData,this.isListData=i.isListData,this.entries=null},getDescriptor:function(){return this.descriptor},getTitle:function(){return this.descriptor?this.descriptor.title:null},getData:function(){return this.data},getEntries:function(){return null===this.entries&&(this.isCellsData?this.entries=function(e){var t=[];if(e&&e.feed&&e.feed.entry){for(var i=e.feed.entry,n=[],r=[],o={},s=0,l=i.length;s<l;++s){var c=i[s];if(c.id&&c.id.$t){var d=a.exec(c.id.$t);if(d)if(c._row=1*d[1],c._col=1*d[2],1===c._row){var u="_"+c._col;c.content&&c.content.$t&&(u=c.content.$t);var h=null;o[u]?o[u].isArray=!0:(h={name:u,isArray:!1},o[u]=h),r[c._col]=h}else n.push(c)}}n.sort(function(e,t){return e._row<t._row?-1:e._row>t._row?1:e._col<t._col?-1:e._col>t._col?1:0});for(var p=null,f=-1,s=0,l=n.length;s<l;++s){var c=n[s];f!=c._row&&(p&&y(p),f=c._row,p={},t.push(p));var m=!0,v="_",h=r[c._col];h&&(m=h.isArray,v=h.name);var g="";c.content&&c.content.$t&&(g=c.content.$t),m?(p[v]||(p[v]=[]),p[v].push(g)):p[v]=g}p&&y(p)}return t;function y(e){if(e)for(var t in o){var i=o[t];void 0===e[t]&&(i.isArray?e[t]=[]:e[t]="")}}}(this.data):this.isListData&&(this.entries=function(e){var t=[];if(e&&e.feed&&e.feed.entry)for(var i=e.feed.entry,n=0;n<i.length;++n){var r=i[n],o={};for(var a in r){var l=a.match(s);if(l){var c=r[a].$t;o[l[1]]=c}}t.push(o)}return t}(this.data))),this.entries}}),n=t.Class({key:null,id:null,position:null,cellsFeedUrl:null,listFeedUrl:null,title:null,initialize:function(e){var i=t.extend({key:null,id:null,position:null,title:null,cellsFeedUrl:null,listFeedUrl:null},e);this.key=i.key,this.id=i.id,this.position=i.position,this.title=i.title,this.cellsFeedUrl=i.cellsFeedUrl,this.listFeedUrl=i.listFeedUrl},getSpreadSheet:function(t){var i=e.extend({onSuccess:function(e){},onError:function(e){}},t),n={key:this.key,descriptor:this,onSuccess:i.onSuccess,onError:function(e){i.onError("Error loading spreadsheet at position "+this.position+": "+e)}};this.cellsFeedUrl&&(n.cellsFeedUrl=this.cellsFeedUrl),this.position&&(n.position=this.position),this.listFeedUrl&&(n.listFeedUrl=this.listFeedUrl),o(n)}}),r=t.Class({key:null,title:null,author:null,spreadSheetDescriptors:null,initialize:function(e){var i=t.extend({key:null,title:null},e);this.spreadSheetDescriptors=[],this.key=i.key,this.title=i.title},getSpreadSheetDescriptors:function(){return this.spreadSheetDescriptors},getSpreadSheetDescriptor:function(e){for(var i=t.extend({id:null,position:null,title:null},e),n=0,r=this.spreadSheetDescriptors.length;n<r;++n){var o=this.spreadSheetDescriptors[n];if(i.id&&i.id===o.id)return o;if("number"==typeof i.position&&i.position===o.position)return o;if(i.title&&i.title===o.title)return o}return null},getSpreadSheet:function(e){var i=t.extend({id:null,position:null,title:null,onSuccess:function(e){},onError:function(e){}},e),n=this.getSpreadSheetDescriptor(i);n?n.getSpreadSheet({onSuccess:i.onSuccess,onError:i.onError}):i.onError("SpreadSheet descriptor not found: "+i.title+"/"+i.id+"/"+i.position)},getAllSpreadSheets:function(e){var i=t.extend({onSuccess:function(e){},onError:function(e){}},e),n=this.getSpreadSheetDescriptors(),r=[];if(n.length<=0)i.onSuccess(r);else{for(var o=[],s=0,a=n.length;s<a;++s)o.push(n[s]);for(s=0,a=n.length;s<a;++s){n[s].getSpreadSheet({onSuccess:l,onError:i.onError})}}function l(e){var t=e.getDescriptor(),n=o.indexOf(t);n>=0&&o.splice(n,1),r.push(e),o.length>0||i.onSuccess(r)}}});function o(t){var n=e.extend({key:null,position:null,cellsFeedUrl:null,listFeedUrl:null,descriptor:null,onSuccess:function(e){},onError:function(e){}},t),r=null,o=!1,s=!1;if(n.cellsFeedUrl)r=n.cellsFeedUrl,o=!0;else if(n.key&&n.position)r="https://spreadsheets.google.com/feeds/cells/"+n.key+"/"+n.position+"/public/values",o=!0;else{if(!n.listFeedUrl)return void n.onError("Requested spreadsheet not identified.");r=n.listFeedUrl,s=!0}e.ajax({async:!0,dataType:"json",data:{alt:"json"},traditional:!0,url:r,success:function(e){var t=new i({descriptor:n.descriptor,data:e,isCellsData:o,isListData:s});n.onSuccess(t)},error:function(e,t,i){n.onError("Unable to load spreadsheet: "+t)}})}var s=/^gsx\$(.*)$/;var a=/\/R([0-9]+)C([0-9]+)$/;t.googleDocs={getWorkBook:function(t){var i=e.extend({key:null,onSuccess:function(e){},onError:function(e){}},t);i.key||i.onError("Google Spreadsheet key required."),e.ajax({async:!0,dataType:"json",data:{alt:"json"},traditional:!0,url:"https://spreadsheets.google.com/feeds/worksheets/"+i.key+"/public/basic",success:function(e){var t=new r({key:i.key});if(e&&e.feed){var o=e.feed;if(o.title&&o.title.$t&&(t.title=o.title.$t),o.author&&(t.author={},o.author.name&&o.author.name.$t&&(t.author.name=o.author.name.$t),o.author.email&&o.author.email.$t&&(t.author.email=o.author.email.$t)),o.entry)for(var s=0,a=o.entry.length;s<a;++s){var l=o.entry[s],c={key:i.key,position:s+1};if(l.title&&(c.title=l.title.$t),l.id&&l.id.$t){var d=l.id.$t.lastIndexOf("/");d>=0&&(c.id=l.id.$t.substr(d+1))}if(l.link)for(var u=0,h=l.link.length;u<h;++u){var p=l.link[u];"http://schemas.google.com/spreadsheets/2006#cellsfeed"===p.rel?c.cellsFeedUrl=p.href:"http://schemas.google.com/spreadsheets/2006#listfeed"===p.rel&&(c.listFeedUrl=p.href)}var f=new n(c);t.spreadSheetDescriptors.push(f)}}i.onSuccess(t)},error:function(e,t,n){i.onError("Unable to load workbook: "+t)}})},loadSpreadSheet:o}}(jQuery,nunaliit2),function(e,t){nunaliit2.dbSearchEngine=function(t){var i=e.extend({},{url:"./search",relMediaPath:"test_media/"},t);return{getRelMediaPath:function(e){return e?i.relMediaPath+e:i.relMediaPath},getHoverSound:function(t,n){e.ajax({type:"POST",url:i.url+"/getHoverMedia",data:{id:t},dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(e){if(e&&e.media&&e.media.length>0){var t=e.media[0];t&&t.hover_audio&&n.installSoundFn(t.hover_audio,n)}}})},searchForContributions:function(t,n){e.ajax({type:"POST",url:i.url+"/searchContributions",data:{content:t},dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(e){e.contributions&&n(e.contributions)}})},searchForPlaceNames:function(t,n){e.ajax({type:"POST",url:i.url+"/searchFeatures",data:{content:t},dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(e){e.features&&n(e.features)}})},findGeometryCentroidFromPlaceId:function(t,n){e.ajax({type:"POST",url:i.url+"/findGeometryCentroid",data:{type:"place_id",id:t},dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(e){e&&e.features&&n(e.features)}})},findGeometryCentroidFromId:function(t,n){e.ajax({type:"POST",url:i.url+"/findGeometryCentroid",data:{type:"id",id:t},dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(e){e&&e.features&&n(e.features)}})},getAudioMediaFromPlaceId:function(t,n){e.ajax({type:"POST",url:i.url+"/getAudioMedia",data:{id:t},dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(e){e&&e.media&&n(e.media)}})}}}}(jQuery),function(e,t){nunaliit2.contributionDb=function(t){e.extend({},{url:"./contributions"},t);return{getContributionsFromPlaceId:function(t,i){e.getJSON("./contributions/fromName?name="+encodeURIComponent(t),function(e){var t=e.contributions;t&&i(t)})}}}}(jQuery),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)};function n(t){var i=t.getProgressKey(),n=e("#n2UploadProgress_"+i);if(n.length<1)t.cancel();else{var r=t.getTotal(),o=t.getCurrent(),s=0;0!=r&&(s=o/r*100),n.find(".n2UploadProgressBar").css("width",s+"%").attr("alt","File Upload "+s+"%"),n.find(".n2UploadProgressBarBackground").attr("alt","File Upload "+s+"%")}}var r={url:null,progressServer:null},o=t.Class({options:null,welcomeMessage:null,initialize:function(e){this.options=t.extend({},r,e)},buildForm:function(r,o){var s=this,a=e.extend({onSuccess:function(e){},onError:function(e){t.reportError(e)}},this.options,o);function l(t){var i=e(this).parents(".n2UploadForm");i.find(".n2UploadInputButton").attr("disabled","disabled"),a.progressServer?a.progressServer.requestProgressKey(function(e){c(i,e)}):c(i,null)}function c(t,r){if(t.find(".n2UploadProgressId").remove(),r&&t.prepend(e('<input class="n2UploadProgressId" type="hidden" name="progressId" value="'+r+'"/>')),t.ajaxSubmit({type:"post",url:a.url+"put",dataType:"json",success:function(e){t.find("*").removeAttr("disabled"),e.error?a.onError(i("Error while uploading: ")+e.error,o):a.onSuccess(e,o)},error:function(e,n,r){t.find("*").removeAttr("disabled"),a.onError(i("Error while uploading: ")+r,o)}}),r){var l=e('<div id="n2UploadProgress_'+r+'" class="n2UploadProgress"><div class="n2UploadProgressBarBackground"><div class="n2UploadProgressBar"></div></div></div>');t.after(l),s.options.progressServer.createProgressTracker({progressKey:r,onUpdate:n})}}r.empty(),e.fn.ajaxSubmit||a.onError(i("Can not perform file uploads unless jquery.form.js is included")),r.each(function(t,n){!function(t,n,r){var o=e(t),s=e('<form class="n2UploadForm" method="post"></form>'),a=e('<input class="n2UploadInputButton" type="button"/>');s.append(e('<input class="n2UploadInputFile" type="file" name="_attachments"/>')),a.val(i("Upload")),s.append(a),o.append(s),a.click(l)}(n,a.docId,a.rev)})},submitForm:function(r){var o=this,s=e.extend({form:null,uploadFile:null,suppressInformationDialog:!1,onSuccess:function(e){},onError:function(e){t.reportError(e)}},this.options,r);if(e.fn.ajaxSubmit)if(s.form){var a=s.form;"string"==typeof a&&(a=e("#"+a)),a.find(".n2UploadInputButton").attr("disabled","disabled"),s.progressServer?s.progressServer.requestProgressKey(function(e){l(a,s.uploadFile,e)}):l(a,null)}else s.onError("Form element is required");else s.onError("Can not perform file uploads unless jquery.form.js is included");function l(t,a,l){t.find(".n2UploadProgressId").remove(),l&&t.prepend(e('<input class="n2UploadProgressId" type="hidden" name="progressId" value="'+l+'"/>'));var c=new FormData(t[0]);if(null!==s.uploadFile&&c.append("media",a),e.ajax({type:"POST",url:s.url+"put",data:c,dataType:"json",processData:!1,contentType:!1,success:function(e){t.find("*").removeAttr("disabled"),e.error?s.onError(i("Error while uploading: ")+e.error,r):(s.suppressInformationDialog||o._uploadSucessfulDialog(),s.onSuccess(e,r))},error:function(e,n,o){t.find("*").removeAttr("disabled"),s.onError(i("Error while uploading: ")+o,r)}}),l){var d=e('<div id="n2UploadProgress_'+l+'" class="n2UploadProgress"><div class="n2UploadProgressBarBackground"><div class="n2UploadProgressBar"></div></div></div>');t.after(d),o.options.progressServer.createProgressTracker({progressKey:l,onUpdate:n})}}},checkWelcome:function(i){var n=e.extend({onSuccess:function(e){},onError:function(e){t.reportError(e)}},this.options,i);this.welcomeMessage?n.onSuccess(this.welcomeMessage):this.getWelcome(n)},getWelcome:function(i){var n=e.extend({onSuccess:function(e){},onError:function(e){t.reportError(e)}},this.options,i),r=this;e.ajax({url:n.url+"welcome",type:"GET",dataType:"json",success:function(e,t,i){e&&e.ok?(r.welcomeMessage=e,n.onSuccess(e)):n.onError(e)},error:function(e,t,i){n.onError(i)}})},_uploadSucessfulDialog:function(){if(e.fn.button&&e.fn.dialog){var n=t.getUniqueId(),r=e('<div id="'+n+'"></div>'),o=e("<span></span>");o.text(i("Your file was uploaded and will become available when it has been approved.")),r.append(o),e("<br/>").appendTo(r);var s=e("<button></button>");s.text(i("OK")),s.button({icons:{primary:"ui-icon-check"}}),r.append(s),s.click(function(){return e("#"+n).dialog("close"),!1});var a={autoOpen:!0,title:i("File Uploaded"),modal:!0,width:500,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};r.dialog(a)}}});t.upload={Upload:o}}(jQuery,nunaliit2),jQuery,"undefined"!=typeof OpenLayers&&OpenLayers.Style&&OpenLayers.Style.prototype&&(OpenLayers.Style.prototype.addPropertyStyles=function(e,t){var i;for(var n in t)"string"==typeof(i=t[n])&&i.match(/\$\{\w+(\.\w+)*\}/)&&(e[n]=!0);return e}),"undefined"!=typeof OpenLayers&&OpenLayers.Map&&(OpenLayers.Strategy.N2BBOX=OpenLayers.Class(OpenLayers.Strategy.BBOX,{getMapBounds:function(){return null===this.layer.map?null:this.layer.map.getExtent()},CLASS_NAME:"OpenLayers.Strategy.N2BBOX"})),function(e,t){function i(e,i){t.reportError("OL_FILTER","Filter error. Application might not work properly. "+e),log("Filter error: "+e,i)}var n=function(e,t){if(t||(t=i),e.comparison)return null==e.property?(t('Missing "property" from comparison filter',e),null):null==e.value?(t('Missing "value" from comparison filter',e),null):"="==e.comparison?new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:e.property,value:e.value}):(t("Invalid comparison filter: "+e.comparison,e),null);if(e.logical){if(null==e.filters)return t('Missing "filters" from logical filter',e),null;var r=function(e,t){for(var i=[],r=0;r<e.length;++r){var o=n(e[r],t);o&&i.push(o)}return i}(e.filters,t);return"and"==e.logical?new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:r}):"or"==e.logical?new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR,filters:r}):(t("Invalid logical filter: "+e.logical,e),null)}return t("Unknown filter type",e),null},r=t.Class({olFilter:null,initialize:function(){},parseJsonFilter:function(e){var r=t.extend({json:null,onError:i},e);return r.json?(this.olFilter=n(r.json,r.onError),null!=this.olFilter):(r.onError("Invalid JSON",this),!1)},fromFids:function(e){return this.olFilter=new OpenLayers.Filter.FeatureId({fids:e}),!0},getOpenLayerFilter:function(){return this.olFilter},matches:function(e){return!this.olFilter||this.olFilter.evaluate(e)}});t.olFilter={CreateOpenLayersFilter:n,Filter:r,fromJson:function(e){var t=new r;return t.parseJsonFilter({json:e}),t},fromFid:function(e){var t=new r;return t.fromFids([e]),t},fromFids:function(e){var t=new r;return t.fromFids(e),t}}}(jQuery,nunaliit2),"undefined"!=typeof OpenLayers&&(OpenLayers.StyleMapCallback=OpenLayers.Class({callback:null,initialize:function(e,t){this.callback=e,OpenLayers.Util.extend(this,t)},destroy:function(){this.callback=null},styles:{},createSymbolizer:function(e,t){return this.callback?this.callback(e,t):{display:"none"}},CLASS_NAME:"OpenLayers.StyleMapCallback"})),function(e,t){function i(e,t){var i=e._n2Sort;i||(i=n(e));var r=t._n2Sort;return r||(r=n(t)),i.isPoint&&r.isPoint?0:i.isPoint?1:r.isPoint?-1:i.isLineString&&r.isLineString?i.largestDim>r.largestDim?-1:1:i.isLineString?1:r.isLineString?-1:i.largestDim>r.largestDim?-1:1}function n(e){e._n2Sort={};var t=e.geometry.CLASS_NAME;if(e._n2Sort.isPoint=t.indexOf("Point")>=0,e._n2Sort.isPoint)e._n2Sort.isLineString=!1,e._n2Sort.isPolygon=!1,e._n2Sort.largestDim=0;else if(e._n2Sort.isLineString=t.indexOf("LineString")>=0,e._n2Sort.isLineString){var i=e.geometry.getBounds();e._n2Sort.largestDim=i.top-i.bottom;var n=i.right-i.left;e._n2Sort.largestDim<n&&(e._n2Sort.largestDim=n)}else{e._n2Sort.isPolygon=!0;i=e.geometry.getBounds();e._n2Sort.largestDim=(i.top-i.bottom)*(i.right-i.left)}return e._n2Sort}function r(e){e._n2Sort={};var t=e.getGeometry().getType();if(e._n2Sort.isPoint=t.indexOf("Point")>=0,e._n2Sort.isPoint)e._n2Sort.isLineString=!1,e._n2Sort.isPolygon=!1,e._n2Sort.largestDim=0;else if(e._n2Sort.isLineString=t.indexOf("LineString")>=0,e._n2Sort.isLineString){var i=e.getGeometry().computeExtent();e._n2Sort.largestDim=i[2]-i[0];var n=i[3]-i[1];e._n2Sort.largestDim<n&&(e._n2Sort.largestDim=n)}else{e._n2Sort.isPolygon=!0;i=e.getGeometry().computeExtent();e._n2Sort.largestDim=(i[2]-i[0])*(i[3]-i[1])}return e._n2Sort}nunaliit2.olUtils={isValidGeom:function(e){for(var t=e.getVertices(),i=0,n=t.length;i<n;++i){var r=t[i];if("number"!=typeof r.x||r.x!=r.x)return!1;if("number"!=typeof r.y||r.y!=r.y)return!1}return!0},sortFeatures:function(e){e.forEach(function(e){delete e._n2Sort}),e.sort(i)},featureSorting:i,ol5FeatureSorting:function(e,t){var i=r(e),n=r(t);return i.isPoint&&n.isPoint?0:i.isPoint?1:n.isPoint?-1:i.isLineString&&n.isLineString?i.largestDim>n.largestDim?-1:1:i.isLineString?1:n.isLineString?-1:i.largestDim>n.largestDim?-1:1}}}(jQuery),function(e,t){"undefined"!=typeof OpenLayers&&(OpenLayers.Control.N2LoadingPanel=OpenLayers.Class(OpenLayers.Control,{counter:0,maximized:!1,visible:!0,initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,[e])},setVisible:function(e){this.visible=e,e?OpenLayers.Element.show(this.div):OpenLayers.Element.hide(this.div)},getVisible:function(){return this.visible},hide:function(){this.setVisible(!1)},show:function(){this.setVisible(!0)},toggle:function(){this.setVisible(!this.getVisible())},increaseCounter:function(){this.counter++,this.counter>0&&!this.maximized&&this.visible&&this.maximizeControl()},decreaseCounter:function(){this.counter>0&&this.counter--,0==this.counter&&this.maximized&&this.visible&&this.minimizeControl()},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments),e("<div>").addClass("n2LoadingPanel_overlay").appendTo(this.div);var i,n,r=e("<div>").addClass("n2LoadingPanel_outertext").appendTo(this.div);return e("<div>").text((i="Loading...",t.loc(i,"nunaliit2-couch",n))).appendTo(r),this.maximized?this.maximizeControl():this.minimizeControl(),this.div},minimizeControl:function(e){this.div&&(this.div.style.display="none"),this.maximized=!1,null!=e&&OpenLayers.Event.stop(e)},maximizeControl:function(e){this.div&&(this.div.style.display="block"),this.maximized=!0,null!=e&&OpenLayers.Event.stop(e)},destroy:function(){OpenLayers.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.N2LoadingPanel"}))}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)};"undefined"!=typeof OpenLayers&&(OpenLayers.Control.NunaliitLayerSwitcher=OpenLayers.Class(OpenLayers.Control,{layerStates:null,layersDiv:null,baseLayersDiv:null,baseLayers:null,dataLbl:null,dataLayersDiv:null,dataLayers:null,minimizeDiv:null,maximizeDiv:null,ascending:!0,cachedSymbols:null,initialize:function(t){var i=this;OpenLayers.Control.prototype.initialize.apply(this,arguments),this.layerStates=[],this.cachedSymbols={},this.__baseFn=function(t){var n=e(this);return i._onBaseLayerChanged(n,t)},this.__overlayFn=function(t){var n=e(this);return i._onOverlayChanged(n,t)}},destroy:function(){this.clearLayersArray("base"),this.clearLayersArray("data"),this.map.events.un({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this}),OpenLayers.Control.prototype.destroy.apply(this,arguments)},setMap:function(e){OpenLayers.Control.prototype.setMap.apply(this,arguments),this.map.events.on({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this})},draw:function(){var t=this;return OpenLayers.Control.prototype.draw.apply(this),this.loadContents(),this.outsideViewport||this.minimizeControl(),this.redraw(),e(this.div).click(function(i){var n=e(this);return t._onButtonClick(n,i),i.stopPropagation?i.stopPropagation():i.cancelBubble=!0,!0}),e(this.div).dblclick(function(e){return e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,!1}),this.div},_onButtonClick:function(t,i){(t=e(i.target)).attr("_layer_switcher");t.hasClass("minimizeDiv")?this.minimizeControl():t.hasClass("maximizeDiv")&&this.maximizeControl()},_onBaseLayerChanged:function(e,t){if(e.is(":checked")){var i=e.attr("_layer");this.map.setBaseLayer(this.map.getLayer(i))}return!0},_onOverlayChanged:function(e,t){this.updateMap()},_onSvgClick:function(t,i){var n=e("#"+t);0==n.is(":disabled")&&(n.is(":checked")?n.removeAttr("checked"):n.attr("checked","checked"),this.updateMap())},clearLayersArray:function(e){this[e+"LayersDiv"].innerHTML="",this[e+"Layers"]=[]},checkRedraw:function(){var e=!1;if(this.layerStates.length&&this.map.layers.length==this.layerStates.length)for(var t=0,i=this.layerStates.length;t<i;t++){var n=this.layerStates[t],r=this.map.layers[t];if(n.name!=r.name||n.inRange!=r.inRange||n.id!=r.id||n.visibility!=r.visibility){e=!0;break}}else e=!0;return e},redraw:function(){var i=this;if(!this.checkRedraw())return this.div;this.clearLayersArray("base"),this.clearLayersArray("data");var n=!1,r=!1,o=this.map.layers.length;this.layerStates=new Array(o);for(var s=0;s<o;s++){var a=this.map.layers[s];this.layerStates[s]={name:a.name,visibility:a.visibility,inRange:a.inRange,id:a.id}}var l=this.map.layers.slice();this.ascending||l.reverse();for(s=0,o=l.length;s<o;s++){var c=(a=l[s]).isBaseLayer;if(a.displayInLayerSwitcher){c?r=!0:n=!0;var d=c?a==this.map.baseLayer:a.getVisibility(),u=t.getUniqueId(),h=e("<input/>").attr("id",u).attr("_layer",a.id).attr("_layer_switcher",this.id).attr("defaultChecked",d).val(a.name).addClass("olButton");c?h.attr("type","radio").attr("name",this.id+"_baseLayers"):h.attr("type","checkbox").attr("name",a.name),d&&h.attr("checked","checked"),c||a.inRange||h.attr("disabled","disabled");var p=e('<div class="n2layerSwitcher_input_container"></div>').append(h),f=e("<label/>").attr("for",u).addClass("labelSpan").addClass("olButton").attr("_layer_switcher",this.id).text(a.name);c||a.inRange||f.addClass("n2layerSwitcher_outOfRange"),c?f.addClass("n2layerSwitcher_alignBottom"):f.addClass("n2layerSwitcher_alignBaseline");var m=e('<div class="n2layerSwitcher_label_container"></div>').append(f),v=null;if(!c&&a.styleMap){var g=new OpenLayers.Geometry.Point(0,0),y=new OpenLayers.Feature.Vector(g),_=a.styleMap.createSymbolizer(y),S=this._createSVGNode("svg");if(S){this._setAttr(S,"version","1.1"),this._setAttr(S,"style","display:inline-block"),this._setAttr(S,"width",14),this._setAttr(S,"height",14),this._setAttr(S,"viewBox","-7 -7 14 14"),this._addClass(S,"n2layerSwitcher_svg");var b=e(S),I=null;if(_.graphicName&&this.cachedSymbols[_.graphicName])I=this._createSVGNode("path"),this._setAttr(I,"d",this.cachedSymbols[_.graphicName]);else if(_.graphicName&&OpenLayers.Renderer.symbol[_.graphicName]){var C=this._computePathFromSymbol(OpenLayers.Renderer.symbol[_.graphicName]);this.cachedSymbols[_.graphicName]=C,I=this._createSVGNode("path"),this._setAttr(I,"d",this.cachedSymbols[_.graphicName])}else I=this._createSVGNode("circle"),this._setAttr(I,"r",5);if(I){for(var D in _){var w=_[D];"fillColor"===D?this._setAttr(I,"fill",w):"fillOpacity"===D?this._setAttr(I,"fill-opacity",w):"strokeColor"===D?this._setAttr(I,"stroke",w):"strokeOpacity"===D?this._setAttr(I,"stroke-opacity",w):"strokeWidth"===D?this._setAttr(I,"stroke-width",w):"strokeLinecap"===D?this._setAttr(I,"stroke-linecap",w):this._setAttr(I,D,w)}S.appendChild(I),I.onclick=T(u)}v=e('<div class="n2layerSwitcher_preview_container"></div>').append(b)}}(c?this.baseLayers:this.dataLayers).push({layer:a,inputElem:h,labelSpan:f});var E=c?this.baseLayersDiv:this.dataLayersDiv,x=e('<div class="n2layerSwitcher_layer"/>').append(p).append(m).appendTo(e(E));v&&x.append(v),c?h.change(this.__baseFn):h.change(this.__overlayFn)}}return this.dataLbl.style.display=n?"":"none",this.baseLbl.style.display=r?"":"none",this.div;function T(e){return function(t){return i._onSvgClick(e,t)}}},_createSVGNode:function(e,t){var i=null;return document.createElementNS&&(i=document.createElementNS("http://www.w3.org/2000/svg",e),t&&i.setAttributeNS(null,"id",t)),i},_setAttr:function(e,t,i){e.setAttributeNS(null,t,i)},_addClass:function(e,t){var i=[],n=e.getAttribute("class")||"";n&&(i=n.split(" ")),i.indexOf(t)<0&&i.push(t),e.setAttribute("class",i.join(" "))},updateMap:function(){for(var e=0,t=this.baseLayers.length;e<t;e++){(i=this.baseLayers[e]).inputElem.is(":checked")&&this.map.setBaseLayer(i.layer,!1)}for(e=0,t=this.dataLayers.length;e<t;e++){var i,n=(i=this.dataLayers[e]).inputElem.is(":checked");i.layer.setVisibility(n)}},maximizeControl:function(e){this.div.style.width="",this.div.style.height="",this.showControls(!1),null!=e&&OpenLayers.Event.stop(e)},minimizeControl:function(e){this.div.style.width="0px",this.div.style.height="0px",this.showControls(!0),null!=e&&OpenLayers.Event.stop(e)},showControls:function(e){this.maximizeDiv.style.display=e?"":"none",this.minimizeDiv.style.display=e?"none":"",this.layersDiv.style.display=e?"none":""},loadContents:function(){this.layersDiv=document.createElement("div"),this.layersDiv.id=this.id+"_layersDiv",OpenLayers.Element.addClass(this.layersDiv,"layersDiv"),this.baseLbl=document.createElement("div"),this.baseLbl.innerHTML=i("Base Layer"),OpenLayers.Element.addClass(this.baseLbl,"baseLbl"),this.baseLayersDiv=document.createElement("div"),OpenLayers.Element.addClass(this.baseLayersDiv,"baseLayersDiv"),this.dataLbl=document.createElement("div"),this.dataLbl.innerHTML=i("Overlays"),OpenLayers.Element.addClass(this.dataLbl,"dataLbl"),this.dataLayersDiv=document.createElement("div"),OpenLayers.Element.addClass(this.dataLayersDiv,"dataLayersDiv"),this.ascending?(this.layersDiv.appendChild(this.baseLbl),this.layersDiv.appendChild(this.baseLayersDiv),this.layersDiv.appendChild(this.dataLbl),this.layersDiv.appendChild(this.dataLayersDiv)):(this.layersDiv.appendChild(this.dataLbl),this.layersDiv.appendChild(this.dataLayersDiv),this.layersDiv.appendChild(this.baseLbl),this.layersDiv.appendChild(this.baseLayersDiv)),this.div.appendChild(this.layersDiv);var e=OpenLayers.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_MaximizeDiv",null,null,e,"absolute"),OpenLayers.Element.addClass(this.maximizeDiv,"maximizeDiv olButton"),this.maximizeDiv.style.display="none",this.div.appendChild(this.maximizeDiv);e=OpenLayers.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_MinimizeDiv",null,null,e,"absolute"),OpenLayers.Element.addClass(this.minimizeDiv,"minimizeDiv olButton"),this.minimizeDiv.style.display="none",this.div.appendChild(this.minimizeDiv)},_computePathFromSymbol:function(e){for(var t=void 0,i=void 0,n=void 0,r=void 0,o=0,s=e.length;o<s;o+=2){var a=e[o],l=e[o+1];void 0===t?t=a:t>a&&(t=a),void 0===i?i=a:i<a&&(i=a),void 0===n?n=l:n>l&&(n=l),void 0===r?r=l:r<l&&(r=l)}var c=[],d=(t+i)/2,u=(n+r)/2,h=i-t,p=r-n,f=h>p?h/10:p/10;f<=0&&(f=1);for(o=0,s=e.length;o<s;o+=2){var m=((a=e[o])-d)/f,v=((l=e[o+1])-u)/f;m=Math.floor(100*m)/100,v=Math.floor(100*v)/100,0===o?c.push("M "):c.push("L "),c.push(""+m),c.push(" "+v+" ")}return c.push("Z"),c.join("")},CLASS_NAME:"OpenLayers.Control.LayerSwitcher"}))}(jQuery,nunaliit2),jQuery,"undefined"!=typeof OpenLayers&&OpenLayers.Class&&OpenLayers.Handler&&(OpenLayers.Handler.NunaliitFeature=OpenLayers.Class(OpenLayers.Handler,{EVENTMAP:{click:{in:"click",out:"clickout"},mousemove:{in:"over",out:"out"},dblclick:{in:"dblclick",out:null},mousedown:{in:null,out:null},mouseup:{in:null,out:null},touchstart:{in:"click",out:"clickout"}},feature:null,lastFeature:null,lastClickedFeature:null,down:null,up:null,clickTolerance:4,geometryTypes:null,stopClick:!0,stopDown:!1,stopUp:!1,initialize:function(e,t,i,n){OpenLayers.Handler.prototype.initialize.apply(this,[e,i,n]),this.layer=t},touchstart:function(e){return this.startTouch(),!!OpenLayers.Event.isMultiTouch(e)||this.mousedown(e)},touchmove:function(e){OpenLayers.Event.preventDefault(e)},mousedown:function(e){return(OpenLayers.Event.isLeftClick(e)||OpenLayers.Event.isSingleTouch(e))&&(this.down=e.xy),!this.handle(e)||!this.stopDown},mouseup:function(e){return this.up=e.xy,!this.handle(e)||!this.stopUp},click:function(e){return!this.handle(e)||!this.stopClick},mousemove:function(e){return!this.callbacks.over&&!this.callbacks.out||(this.handle(e),!0)},dblclick:function(e){return!this.handle(e)},geometryTypeMatches:function(e){return null==this.geometryTypes||OpenLayers.Util.indexOf(this.geometryTypes,e.geometry.CLASS_NAME)>-1},handle:function(e){var t=e.type,i=!1,n=!!this.feature,r="click"==t||"dblclick"==t||"touchstart"==t;if(this.feature=this.layer.getFeatureFromEvent(e),this.feature&&!this.feature.layer&&(this.feature=null),this.lastFeature&&!this.lastFeature.layer&&(this.lastFeature=null),this.feature&&r)"touchstart"===t&&OpenLayers.Event.preventDefault(e),this.geometryTypeMatches(this.feature)?(this.triggerCallback(t,"in",[this.feature]),this.lastClickedFeature=this.feature,i=!0):(this.lastClickedFeature&&this.lastClickedFeature.layer?this.triggerCallback(t,"out",[this.lastClickedFeature]):this.triggerCallback(t,"out",[]),this.lastClickedFeature=null);else if(r)this.lastClickedFeature&&this.lastClickedFeature.layer?this.triggerCallback(t,"out",[this.lastClickedFeature]):this.triggerCallback(t,"out",[]),this.lastClickedFeature=null;else if(this.feature){var o=this.feature!==this.lastFeature;this.geometryTypeMatches(this.feature)?(n&&o?(this.lastFeature&&this.triggerCallback(t,"out",[this.lastFeature]),this.triggerCallback(t,"in",[this.feature])):n||this.triggerCallback(t,"in",[this.feature]),this.lastFeature=this.feature,i=!0):(n&&o&&(this.lastFeature?this.triggerCallback(t,"out",[this.lastFeature]):this.triggerCallback(t,"out",[])),this.feature=null)}else n&&(this.lastFeature?this.triggerCallback(t,"out",[this.lastFeature]):this.triggerCallback(t,"out",[]));return i},triggerCallback:function(e,t,i){var n=!1,r=this.EVENTMAP[e][t];return r&&("click"==e&&this.up&&this.down?(Math.sqrt(Math.pow(this.up.x-this.down.x,2)+Math.pow(this.up.y-this.down.y,2))<=this.clickTolerance&&(this.callback(r,i),n=!0),this.up=this.down=null):(this.callback(r,i),n=!0)),n},activate:function(){var e=!1;return OpenLayers.Handler.prototype.activate.apply(this,arguments)&&(this.moveLayerToTop(),this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),e=!0),e},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.moveLayerBack(),this.feature=null,this.lastFeature=null,this.down=null,this.up=null,this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),e=!0),e},handleMapEvents:function(e){"removelayer"!=e.type&&"order"!=e.property||this.moveLayerToTop()},moveLayerToTop:function(){var e=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(e)},moveLayerBack:function(){var e=this.layer.getZIndex()-1;e>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(e):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"OpenLayers.Handler.NunaliitFeature"})),"undefined"!=typeof OpenLayers&&OpenLayers.Control&&OpenLayers.Class&&(OpenLayers.Control.NunaliitGazetteer=OpenLayers.Class(OpenLayers.Control,{activateListener:null,initialize:function(e){this.handlers={},OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.deactivate(),OpenLayers.Control.prototype.destroy.apply(this,arguments)},activate:function(){if("function"!=typeof this.activateListener)return OpenLayers.Control.prototype.activate.apply(this,arguments);this.activateListener()},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.NunaliitGazetteer"})),function(e){if("undefined"!=typeof OpenLayers&&OpenLayers.Strategy&&OpenLayers.Class){var t=e.Class({whiteList:null,docIdMap:null,initialize:function(t){var i=e.extend({whiteList:!1},t);this.whiteList=i.whiteList,this.docIdMap={}},setDocIds:function(e){var t=this;this.docIdMap={},"string"==typeof e?this.docIdMap[e]=!0:e.forEach(function(e){t.docIdMap[e]=!0})},performFiltering:function(e,t){var i=this,n=[];return e.forEach(function(e){i._isFeatureVisible(e)?n.push(e):t&&t.push(e)}),n},_isFeatureVisible:function(e){var t=!0,i=void 0;return e&&e.data&&(i=e.data._id),i&&this.docIdMap[i]&&(t=!1),this.whiteList&&(t=!t),t}}),i=e.Class({minimumLinePixelSize:10,minimumPolygonPixelSize:10,initialize:function(t){var i=e.extend({minimumLinePixelSize:10,minimumPolygonPixelSize:10},t);this.minimumLinePixelSize=10,"number"==typeof i.minimumLinePixelSize&&(this.minimumLinePixelSize=i.minimumLinePixelSize),this.minimumPolygonPixelSize=10,"number"==typeof i.minimumPolygonPixelSize&&(this.minimumPolygonPixelSize=i.minimumPolygonPixelSize)},processFeatures:function(e,t){for(var i,n=0;n<e.length;++n)if(i=e[n],this._shouldTurnToPoint(i,t)){var r=i.geometry.getBounds().getCenterLonLat(),o=new OpenLayers.Geometry.Point(r.lon,r.lat);i.n2MinSizeGeom=i.geometry,i.geometry=o}else if(this._shouldRestore(i,t)){var s=i.n2MinSizeGeom;i.geometry=s,delete i.n2MinSizeGeom}return e},_shouldTurnToPoint:function(e,t){var i=!1;if(e.geometry.CLASS_NAME.indexOf("Line")>=0){var n=e.geometry.getBounds();this._boundsToPixels(n,t)<this.minimumLinePixelSize&&(i=!0)}else if(e.geometry.CLASS_NAME.indexOf("Polygon")>=0){n=e.geometry.getBounds();this._boundsToPixels(n,t)<this.minimumLinePixelSize&&(i=!0)}return i},_shouldRestore:function(e,t){var i=!1,n=e.n2MinSizeGeom;if(n)if(n.CLASS_NAME.indexOf("Line")>=0){var r=n.getBounds();this._boundsToPixels(r,t)>=this.minimumPolygonPixelSize&&(i=!0)}else if(n.CLASS_NAME.indexOf("Polygon")>=0){r=n.getBounds();this._boundsToPixels(r,t)>=this.minimumPolygonPixelSize&&(i=!0)}return i},_boundsToPixels:function(e,t){var i=(e.right-e.left)/t,n=(e.top-e.bottom)/t;return i>n?i:n}}),n=e.Class({distance:void 0,minimumPolygonPixelSize:void 0,minimumLinePixelSize:void 0,disableDynamicClustering:!1,clusterPointsOnly:!1,threshold:null,resolution:null,projection:null,clusterPrefix:null,clusterId:null,initialize:function(t){var i=e.extend({distance:20,minimumPolygonPixelSize:void 0,minimumLinePixelSize:void 0,disableDynamicClustering:!1,clusterPointsOnly:!1,threshold:null},t);this.distance=i.distance,this.minimumPolygonPixelSize=i.minimumPolygonPixelSize,this.minimumLinePixelSize=i.minimumLinePixelSize,this.disableDynamicClustering=i.disableDynamicClustering,this.clusterPointsOnly=i.clusterPointsOnly,this.threshold=i.threshold,this.resolution=1,this.clusterPrefix="cluster_"+e.getUniqueId()+"_",this.clusterId=1,void 0===this.minimumPolygonPixelSize&&(this.minimumPolygonPixelSize=this.distance),void 0===this.minimumLinePixelSize&&(this.minimumLinePixelSize=this.distance)},setResolution:function(e){this.resolution=e},setProjection:function(e){this.projection=e},performClustering:function(e){this.resolution;for(var t,i,n,r=[],o=[],s=0;s<e.length;++s)if(t=e[s],this._isEligibleFeature(t)){if(t.geometry){i=!1;for(var a=r.length-1;a>=0;--a)if(n=r[a],this._shouldCluster(n,t)){this._addToCluster(n,t),i=!0;break}if(!i){var l=this._createCluster(t);r.push(l),o.push(l)}}}else o.push(t);var c=[];if(this.threshold>1){s=0;for(var d=o.length;s<d;++s){var u=o[s];u.cluster&&u.cluster.length<this.threshold?u.cluster.forEach(function(e){c[c.length]=e}):c[c.length]=u}}else c=o;return c},_shouldCluster:function(e,t){var i=e.geometry.getBounds().getCenterLonLat(),n=t.geometry.getBounds().getCenterLonLat();return Math.sqrt(Math.pow(i.lon-n.lon,2)+Math.pow(i.lat-n.lat,2))/this.resolution<=this.distance},_addToCluster:function(e,t){e.cluster.push(t),e.attributes.count+=1},_createCluster:function(e){var t=e.geometry.getBounds().getCenterLonLat(),i=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(t.lon,t.lat),{count:1});return i.cluster=[e],i.fid=this.clusterPrefix+this.clusterId,++this.clusterId,i},_isEligibleFeature:function(e){if(e.n2DisableClustering)return!1;var t=!0;if(this.disableDynamicClustering)this.clusterPointsOnly&&(t=!1,e.geometry.CLASS_NAME.indexOf("Point")>=0&&(t=!0));else if(t=!1,r=this._computeFullBoundingBox(e)){var i=(r.right-r.left)/this.resolution,n=(r.top-r.bottom)/this.resolution;i<this.minimumLinePixelSize&&n<this.minimumLinePixelSize&&(t=!0)}else if(e.geometry.CLASS_NAME.indexOf("Point")>=0)t=!0;else if(e.geometry.CLASS_NAME.indexOf("Line")>=0){i=((r=e.geometry.getBounds()).right-r.left)/this.resolution,n=(r.top-r.bottom)/this.resolution;i<this.minimumLinePixelSize&&n<this.minimumLinePixelSize&&(t=!0)}else if(e.geometry.CLASS_NAME.indexOf("Polygon")>=0){var r;i=((r=e.geometry.getBounds()).right-r.left)/this.resolution,n=(r.top-r.bottom)/this.resolution;i<this.minimumPolygonPixelSize&&n<this.minimumPolygonPixelSize&&(t=!0)}return t},_computeFullBoundingBox:function(t){return e.mapAndControls.ComputeFeatureOriginalBboxForMapProjection(t,this.projection)}}),r=e.Class({initialize:function(t){e.extend({},t)},performSorting:function(t){return e.olUtils.sortFeatures(t),t}});OpenLayers.Strategy.NunaliitFeatureStrategy=OpenLayers.Class(OpenLayers.Strategy,{filtering:null,editFiltering:null,minimumSize:null,clustering:null,sorting:null,addingToLayer:null,initialize:function(e){OpenLayers.Strategy.prototype.initialize.apply(this,arguments),this.addingToLayer=!1,this.filtering=null,this.editFiltering=null,this.clustering=null,this.sorting=new r},setMinimumSize:function(e){this.minimumSize=new i(e)},setClustering:function(e){this.clustering=new n(e)},setWhiteListDocumentIds:function(e){e?(this.filtering=new t({whiteList:!0}),this.filtering.setDocIds(e)):this.filtering=null,this.filtering.setDocIds(e);var i=this._computeFeatureSet();this._accountForFeatures(i)},setEditedFeatureIds:function(e){e?(this.editFiltering=new t,this.editFiltering.setDocIds(e)):this.editFiltering=null;var i=this._computeFeatureSet();this._accountForFeatures(i)},activate:function(){var e=OpenLayers.Strategy.prototype.activate.call(this);return e&&this.layer.events.on({beforefeaturesadded:this._beforeFeaturesAdded,moveend:this._moveEnd,scope:this}),e},deactivate:function(){var e=OpenLayers.Strategy.prototype.deactivate.call(this);return e&&this.layer.events.un({beforefeaturesadded:this._beforeFeaturesAdded,moveend:this._moveEnd,scope:this}),e},_beforeFeaturesAdded:function(e){if(this.addingToLayer)return!0;var t=this._computeFeatureSet(e.features);return this._accountForFeatures(t),!1},_moveEnd:function(e){if(e&&e.zoomChanged){var t=this._computeFeatureSet();this._accountForFeatures(t)}},_accountForFeatures:function(e){var t=[];if(e.forEach(function(e){e.style&&delete e.style,e.n2FilteredOut=!1}),this.editFiltering&&(e=this.editFiltering.performFiltering(e,t)),this.filtering&&(e=this.filtering.performFiltering(e,t)),this.minimumSize){var i=this.layer.map.getResolution();e=this.minimumSize.processFeatures(e,i)}if(this.clustering){i=this.layer.map.getResolution();this.clustering.setResolution(i);var n=this.layer.map.getProjectionObject();this.clustering.setProjection(n),e=this.clustering.performClustering(e)}this.sorting&&(e=this.sorting.performSorting(e)),t&&t.forEach(function(t){t.style={display:"none"},t.n2FilteredOut=!0,e[e.length]=t}),this._installFeaturesOnLayer(e)},_computeFeatureSet:function(e){for(var t=[],i=0,n=this.layer.features.length;i<n;++i){if((s=this.layer.features[i]).cluster)for(var r=0,o=s.cluster.length;r<o;++r)t[t.length]=s.cluster[r];else t[t.length]=s}if(e)for(i=0,n=e.length;i<n;++i){var s;if((s=e[i]).cluster)for(r=0,o=s.cluster.length;r<o;++r)t[t.length]=s.cluster[r];else t[t.length]=s}return t},_installFeaturesOnLayer:function(e){this.addingToLayer||(this.addingToLayer=!0,this.layer.removeAllFeatures({silent:!0}),this.layer.addFeatures(e),this.addingToLayer=!1)},CLASS_NAME:"OpenLayers.Strategy.NunaliitFeatureStrategy"})}}(nunaliit2),function(e){"undefined"!=typeof OpenLayers&&(OpenLayers.Format.Model=OpenLayers.Class(OpenLayers.Format,{dbProj:null,initialize:function(e){OpenLayers.Format.prototype.initialize.apply(this,[e]),this.dbProj=new OpenLayers.Projection("EPSG:4326")},read:function(t){try{for(var i=[],n=0,r=t.length;n<r;++n){var o=t[n],s=null,a=null;if(o._id&&(s=o._id),o.nunaliit_geom&&o.nunaliit_geom.wkt&&((a=OpenLayers.Geometry.fromWKT(o.nunaliit_geom.wkt))&&(e.olUtils.isValidGeom(a)||(a=null)),a||e.log("Invalid WKT("+o._id+"): "+o.nunaliit_geom.wkt)),s&&a){var l=new OpenLayers.Feature.Vector(a,o);l.fid=s,l.n2GeomProj=this.dbProj,i.push(l)}}return i}catch(r){e.log("Error during CouchDB format read",r)}return[]},write:function(e){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i],o=r.data;null==o&&(o={}),r.fid&&(o._id=r.fid);var s=r.geometry,a=r.layer.map.getProjectionObject();r.layer.projection&&a&&r.layer.projection.getCode()!=a.getCode()&&(s=s.clone()).transform(a,r.layer.projection),o.nunaliit_geom||(o.nunaliit_geom={nunaliit_type:"geometry"}),o.nunaliit_geom.wkt=s.toString();var l=s.getBounds();o.nunaliit_geom.bbox=[l.left,l.bottom,l.right,l.top],o.nunaliit_geom.simplified&&delete o.nunaliit_geom.simplified,t.push(o)}return t},CLASS_NAME:"OpenLayers.Format.Model"}),OpenLayers.Protocol.Model=OpenLayers.Class(OpenLayers.Protocol,{dispatchService:null,sourceModelId:null,modelObserver:null,onUpdateCallback:null,callback:null,scope:null,notifications:null,wildcarded:!1,readWasCalled:!1,loading:!1,initialize:function(t){var i=this;(t=t||{}).format||(t.format=new OpenLayers.Format.Model),t.projection=new OpenLayers.Projection("EPSG:4326"),OpenLayers.Protocol.prototype.initialize.apply(this,arguments),this.modelObserver=new e.model.DocumentModelObserver({dispatchService:this.dispatchService,sourceModelId:this.sourceModelId,updatedCallback:function(e){i.readWasCalled&&i._modelSourceUpdated(e)}})},destroy:function(){OpenLayers.Protocol.prototype.destroy.apply(this)},_modelSourceUpdated:function(e){if("function"==typeof this.onUpdateCallback){var t={added:[],updated:[],removed:[]};"boolean"==typeof e.loading&&(t.loading=e.loading,this._reportLoading(e.loading)),e.added&&(t.added=this.format.read(e.added)),e.updated&&(t.updated=this.format.read(e.updated)),e.removed&&(t.removed=this.format.read(e.removed)),this.onUpdateCallback(t)}},read:function(t){this.readWasCalled=!0;var i=t.object;OpenLayers.Protocol.prototype.read.apply(this,arguments),t=OpenLayers.Util.applyDefaults(t,this.options);var n=new OpenLayers.Protocol.Response({requestType:"read"});i&&i.map&&i.map.getProjectionObject().getCode();var r=this.modelObserver.isLoading();"boolean"==typeof r&&this._reportLoading(r);var o=this.modelObserver.getDocuments(),s=this._getFidMapFromFilter(t.filter);return s&&(o=o.filter(function(e){var t=e._id;return!!s[t]})),t.callback&&(n.features=this.format.read(o),e.olUtils.sortFeatures(n.features),n.code=OpenLayers.Protocol.Response.SUCCESS,t.callback.call(t.scope,n)),n},create:function(t,i){i=OpenLayers.Util.applyDefaults(i,this.options);var n=this.format.write(t);if(i.layerName)for(var r=0,o=n.length;r<o;++r){var s=n[r];s.nunaliit_layers||(s.nunaliit_layers=[]),jQuery.inArray(i.layerName,s.nunaliit_layers)<0&&s.nunaliit_layers.push(i.layerName)}var a=new OpenLayers.Protocol.Response({reqFeatures:t,requestType:"create"}),l=this;return this.db.bulkDocuments(n,{onSuccess:function(e){l.handleCreate(a,i,e)},onError:function(t){e.reportError(t)}}),a},handleCreate:function(t,i,n){var r=t.reqFeatures,o=[];if(r.length!=n.length)e.reportError(e.ERROR_NO_SUPRESS,"Invalid feature bulk create");else for(var s=0,a=n.length;s<a;++s){var l=r[s],c=n[s];c.error?c.reason?e.reportError(e.ERROR_NO_SUPRESS,c.error+" : "+c.reason):e.reportError(e.ERROR_NO_SUPRESS,c.error):(l.fid=c.id,l.data&&(l.data._id=c.id,l.data._rev=c.rev),l.attribute&&(l.attribute._id=c.id,l.attribute._rev=c.rev),o.push(l))}i.callback&&o.length>0&&(t.features=o,t.code=OpenLayers.Protocol.Response.SUCCESS,i.callback.call(i.scope,t))},update:function(t,i){i=i||{},i=OpenLayers.Util.applyDefaults(i,this.options);var n=this.format.write([t]),r=new OpenLayers.Protocol.Response({reqFeatures:t,requestType:"update"}),o=this;return this.db.updateDocument({data:n[0],onSuccess:function(e){o.handleUpdate(r,i,e)},onError:function(t){e.reportError(t)}}),r},handleUpdate:function(e,t,i){var n=e.reqFeatures;n.data&&(n.data._rev=i.rev),n.attribute&&(n.attribute._rev=i.rev),t.callback&&(e.features=[n],e.code=OpenLayers.Protocol.Response.SUCCESS,t.callback.call(t.scope,e))},delete:function(t,i){i=i||{},i=OpenLayers.Util.applyDefaults(i,this.options);var n=new OpenLayers.Protocol.Response({reqFeatures:t,requestType:"delete"}),r=this;return this.db.deleteDocument({data:t.data,onSuccess:function(e){r.handleDelete(n,i,e)},onError:function(t){e.reportError(t)}}),n},handleDelete:function(e,t){t.callback&&(e.code=OpenLayers.Protocol.Response.SUCCESS,t.callback.call(t.scope,e))},commit:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var i=[],n=0,r={};r[OpenLayers.State.INSERT]=[],r[OpenLayers.State.UPDATE]=[],r[OpenLayers.State.DELETE]=[];for(var o,s,a=[],l=0,c=e.length;l<c;++l)(s=r[(o=e[l]).state])&&(s.push(o),a.push(o));var d=(r[OpenLayers.State.INSERT].length>0?1:0)+r[OpenLayers.State.UPDATE].length+r[OpenLayers.State.DELETE].length,u=!0,h=new OpenLayers.Protocol.Response({reqFeatures:a});function p(e){this.callUserCallback(e,t),u=u&&e.success(),++n>=d&&t.callback&&(h.code=u?OpenLayers.Protocol.Response.SUCCESS:OpenLayers.Protocol.Response.FAILURE,t.callback.apply(t.scope,[h]))}var f=r[OpenLayers.State.INSERT];f.length>0&&i.push(this.create(f,OpenLayers.Util.applyDefaults({callback:function(e){for(var t=e.features?e.features.length:0,i=new Array(t),n=0;n<t;++n)i[n]=e.features[n].fid;h.insertIds=i,p.apply(this,[e])},scope:this},t.create)));for(l=(f=r[OpenLayers.State.UPDATE]).length-1;l>=0;--l)i.push(this.update(f[l],OpenLayers.Util.applyDefaults({callback:p,scope:this},t.update)));for(l=(f=r[OpenLayers.State.DELETE]).length-1;l>=0;--l)i.push(this.delete(f[l],OpenLayers.Util.applyDefaults({callback:p,scope:this},t.delete)));return i},abort:function(e){},callUserCallback:function(e,t){var i=t[e.requestType];i&&i.callback&&i.callback.call(i.scope,e)},getBboxFromFilter:function(e){if(!e)return null;if(e.type===OpenLayers.Filter.Spatial.BBOX)return[e.value.left,e.value.bottom,e.value.right,e.value.top];if(e.filters)for(var t=0,i=e.filters.length;t<i;++t){var n=this.getBboxFromFilter(e.filters[t]);if(n)return n}return null},_getFidMapFromFilter:function(e){if(!e)return null;if("OpenLayers.Filter.FeatureId"===e.CLASS_NAME){var t=null;return e.fids&&e.fids.forEach(function(e){null==t&&(t={}),t[e]=!0}),t}if(e.filters){t=null;for(var i=0,n=e.filters.length;i<n;++i){var r=this._getFidMapFromFilter(e.filters[i]);if(r)for(var o in r)null===t&&(t={}),t[o]=!0}return t}return null},_reportLoading:function(e){this.loading&&!e?(this.loading=!1,this.notifications&&"function"==typeof this.notifications.readEnd&&this.notifications.readEnd()):!this.loading&&e&&(this.loading=!0,this.notifications&&"function"==typeof this.notifications.readStart&&this.notifications.readStart())},CLASS_NAME:"OpenLayers.Protocol.Model"}))}(nunaliit2),"undefined"!=typeof OpenLayers&&OpenLayers.Map&&(OpenLayers.N2Map=OpenLayers.Class(OpenLayers.Map,{initialize:function(e,t){OpenLayers.Map.prototype.initialize.apply(this,arguments)},setBaseLayer:function(e){if(e!=this.baseLayer){var t=null,i=null;if(this.baseLayer&&(i=this.baseLayer.getExtent(),t=this.getProjectionObject()),-1!=OpenLayers.Util.indexOf(this.layers,e)){var n=this.getCachedCenter(),r=OpenLayers.Util.getResolutionFromScale(this.getScale(),e.units);null==this.baseLayer||this.allOverlays||this.baseLayer.setVisibility(!1),this.baseLayer=e,this.allOverlays&&!this.baseLayer.visibility||(this.baseLayer.setVisibility(!0),!1===this.baseLayer.inRange&&this.baseLayer.redraw());var o=n,s=null,a=this.getProjectionObject();if(t&&!t.equals(a)&&(o&&o.transform(t,a),i)){var l=this._reprojectExtent(i,t,a);s=this.getZoomForExtent(l,!0)}null!=o&&(s||(s=this.getZoomForResolution(r||this.resolution,!0)),this.setCenter(o,s,!1,!0)),this.events.triggerEvent("changebaselayer",{layer:this.baseLayer,oldProjection:t})}}},_reprojectExtent:function(e,t,i){var n={x:(e.right+e.left)/2,y:(e.top+e.bottom)/2},r={x:e.right,y:e.top},o={x:e.left,y:e.bottom},s=this._getAngle(n,r),a=OpenLayers.Projection.transform(n,t,i),l=OpenLayers.Projection.transform(r,t,i),c=OpenLayers.Projection.transform(o,t,i),d=s-this._getAngle(a,l),u=this._rotatePoint(a,l,d),h=this._rotatePoint(a,c,d);return new OpenLayers.Bounds(h.x,h.y,u.x,u.y)},_getAngle:function(e,t){return t.x===e.x?t.y>e.y?Math.PI/2:0-Math.PI/2:t.x<e.x?Math.PI+Math.atan((t.y-e.y)/(t.x-e.x)):Math.atan((t.y-e.y)/(t.x-e.x))},_rotatePoint:function(e,t,i){var n=t.x-e.x,r=t.y-e.y,o=n*Math.cos(i)-r*Math.sin(i),s=n*Math.sin(i)+r*Math.cos(i);return{x:o+e.x,y:s+e.y}}})),function(e,t){"undefined"!=typeof ol&&(ol.control.N2LayerSwitcher=t.Construct("N2LayerSwitcher",ol.control.Control,{constructor:function(e){var t=e||{},i=t.tipLabel?t.tipLabel:"Legend";this.mapListeners=[],this.hiddenClassName="ol-unselectable ol-control layer-switcher",ol.control.N2LayerSwitcher.isTouchDevice_()&&(this.hiddenClassName+=" touch"),this.shownClassName="shown";var n=document.createElement("div");n.className=this.hiddenClassName;var r=document.createElement("button");r.setAttribute("title",i),n.appendChild(r),this.panel=document.createElement("div"),this.panel.className="panel",n.appendChild(this.panel),ol.control.N2LayerSwitcher.enableTouchScroll_(this.panel);var o=this;r.onmouseover=function(e){o.showPanel()},r.onclick=function(e){e=e||window.event,o.showPanel(),e.preventDefault()},o.panel.onmouseout=function(e){e=e||window.event,o.panel.contains(e.toElement||e.relatedTarget)||o.hidePanel()},ol.control.Control.call(this,{element:n,target:t.target})},showPanel:function(){this.element.classList.contains(this.shownClassName)||(this.element.classList.add(this.shownClassName),this.renderPanel())},hidePanel:function(){this.element.classList.contains(this.shownClassName)&&this.element.classList.remove(this.shownClassName)},renderPanel:function(){for(this.ensureTopVisibleBaseLayerShown_();this.panel.firstChild;)this.panel.removeChild(this.panel.firstChild);var e=document.createElement("ul");this.panel.appendChild(e),this.renderLayers_(this.getMap(),e)},setMap:function(e){for(var t=0;t<this.mapListeners.length;t++)ol.Observable.unByKey(this.mapListeners[t]);if(this.mapListeners.length=0,ol.control.Control.prototype.setMap.call(this,e),e){var i=this;this.mapListeners.push(e.on("pointerdown",function(){i.hidePanel()})),this.renderPanel()}},ensureTopVisibleBaseLayerShown_:function(){var e;ol.control.N2LayerSwitcher.forEachRecursive(this.getMap(),function(t,i,n){"base"===t.get("type")&&t.getVisible()&&(e=t)}),e&&this.setVisible_(e,!0)},setVisible_:function(e,t){var i=this.getMap();e.setVisible(t),t&&"base"===e.get("type")&&ol.control.N2LayerSwitcher.forEachRecursive(i,function(t,i,n){t!=e&&"base"===t.get("type")&&t.setVisible(!1)})},renderLayer_:function(e,t){var i=this,n=document.createElement("li"),r=e.get("title"),o=ol.control.N2LayerSwitcher.uuid(),s=document.createElement("label");if(e.getLayers&&!e.get("combine")){n.className="group",s.innerHTML=r,n.appendChild(s);var a=document.createElement("ul");n.appendChild(a),this.renderLayers_(e,a)}else{n.className="layer";var l=document.createElement("input");"base"===e.get("type")?(l.type="radio",l.name="base"):l.type="checkbox",l.id=o,l.checked=e.get("visible"),l.onchange=function(t){i.setVisible_(e,t.target.checked)},n.appendChild(l),s.htmlFor=o,s.innerHTML=r;var c=this.getMap().getView().getResolution();(c>e.getMaxResolution()||c<e.getMinResolution())&&(s.className+=" disabled"),n.appendChild(s)}return n},renderLayers_:function(e,t){for(var i,n=e.getLayers().getArray().slice().reverse(),r=0;r<n.length;r++)(i=n[r]).get("title")&&t.appendChild(this.renderLayer_(i,r))}}),ol.control.N2LayerSwitcher.forEachRecursive=function(e,t){e.getLayers().forEach(function(e,i,n){t(e,i,n),e.getLayers&&ol.control.N2LayerSwitcher.forEachRecursive(e,t)})},ol.control.N2LayerSwitcher.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},ol.control.N2LayerSwitcher.enableTouchScroll_=function(e){if(ol.control.N2LayerSwitcher.isTouchDevice_()){var t=0;e.addEventListener("touchstart",function(e){t=this.scrollTop+e.touches[0].pageY},!1),e.addEventListener("touchmove",function(e){this.scrollTop=t-e.touches[0].pageY},!1)}},ol.control.N2LayerSwitcher.isTouchDevice_=function(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}})}(jQuery,nunaliit2),function(e,t){t.SLIDER_CONSTANTS={},t.SLIDER_CONSTANTS.NUMERIC="numeric",t.SLIDER_CONSTANTS.DATE="date",t.SLIDER_CONSTANTS.DURATION_DAY=864e5,t.SLIDER_CONSTANTS.DURATION_WEEK=7*t.SLIDER_CONSTANTS.DURATION_DAY,t.SLIDER_CONSTANTS.DURATION_YEAR=365*t.SLIDER_CONSTANTS.DURATION_DAY;var i={containerId:"",idBase:"",valueType:t.SLIDER_CONSTANTS.NUMERIC,min:null,max:null,step:null,initial:null,range:!1,format:"%d"},n=t.Class({options:null,initialize:function(t){this.options=e.extend({},t)},convertSliderValueToDomain:function(e){return this.options.min+(e-0)*this.options.step},convertDomainValueToSlider:function(e){return Math.floor((e-this.options.min)/this.options.step)},toString:function(t){var i=this.options.format.slice(0);return e.format(i,[t])},domainMaxToSliderMax:function(e){return this.convertDomainValueToSlider(e)},equals:function(e,t){return e==t}}),r=t.Class({options:null,initialize:function(t){this.options=e.extend({},t)},convertSliderValueToDomain:function(e){var t=new Date(this.options.min),i=(e-0)*this.options.step;return t.setMilliseconds(t.getMilliseconds()+i),t},convertDomainValueToSlider:function(e){return Math.floor((e-this.options.min)/this.options.step)},toString:function(t){var i=this.options.format.slice(0);return e.datepicker.formatDate(i,t)},domainMaxToSliderMax:function(e){return this.convertDomainValueToSlider(e)},equals:function(e,t){return e.valueOf()==t.valueOf()}}),o=t.Class({options:null,configuredValue:null,valueHandler:null,computedSliderProperties:null,initialize:function(){this.options=e.extend({},i);for(var o=0;o<arguments.length;o++){var s=arguments[o];t.isDefined(s)&&(this.options=e.extend(!0,this.options,s))}t.SLIDER_CONSTANTS.DATE==this.options.valueType?this.valueHandler=new r({min:this.options.min,max:this.options.max,step:this.options.step,format:this.options.format}):this.valueHandler=new n({min:this.options.min,max:this.options.max,step:this.options.step,format:this.options.format});var a={min:0,step:1};a.max=this.valueHandler.domainMaxToSliderMax(this.options.max),this.computedSliderProperties=a},changeFn:function(){},latestValue:function(){return t.isDefined(this.configuredValue)?this.configuredValue:this.options.initial},_computeCallOutLeftValue:function(e){return(e-this.computedSliderProperties.min)/(this.computedSliderProperties.max-this.computedSliderProperties.min)*100},_setText:function(t,i,n){var r,o=this.valueHandler.toString(n),s=Math.floor(o.length/2),a=new Array;s>0?(" "==(r=o.slice(0,s))[r.length-1]&&(r=r.slice(0,-1)+"&nbsp;"),a.push(r)):a.push("");o.length-s>0?(" "==(r=o.slice(s))[0]&&(r="&nbsp;"+r.slice(1)),a.push(r)):a.push(""),e(t).text(a[0]),e(i).text(a[1])},_callout_hideImmed:function(t,i){e(t).hide(),e(i).hide()},_callout_fadeIn:function(t,i){e(t).fadeIn("fast",function(){}),e(i).fadeIn("fast",function(){})},_callout_fadeOut:function(t,i,n){e(t).fadeOut("slow",function(){}),e(i).fadeOut("slow",n)},_createHtml:function(){var t=e("#"+this.options.containerId).empty(),i=e("<div>").addClass("slider_wrapper slider_wrapper_callout").appendTo(t),n=e("<div>").attr("id",this.options.idBase+"_callout").addClass("slider_callout").attr("style","width:0px;height:0px;padding:0px;margin:0px;border:none").appendTo(i);return e("<div>").attr("id",this.options.idBase).addClass("slider_bar").appendTo(i),e("<div>").attr("id",this.options.idBase+"_calloutTextLeft").addClass("slider_callout_text_left").attr("style","position:absolute;right:0px;bottom:0px;text-align:right;").appendTo(n),e("<div>").attr("id",this.options.idBase+"_calloutTextRight").addClass("slider_callout_text_right").attr("style","position:absolute;left:0px;bottom:0px;text-align:left;").appendTo(n),i},create:function(){var t=this,i=(this._createHtml(),"#"+this.options.idBase+"_callout"),n="#"+this.options.idBase+"_calloutTextLeft",r="#"+this.options.idBase+"_calloutTextRight",o=!1;this._callout_hideImmed(n,r);var s={min:this.computedSliderProperties.min,max:this.computedSliderProperties.max,step:this.computedSliderProperties.step,start:function(e,s){t._positionCalloutForUpdate(i,s)>=0&&(o=!0,t._callout_fadeIn(n,r))},slide:function(e,s){var a=t._positionCalloutUpdateText(i,n,r,s);0==o&&a>=0&&(o=!0,t._callout_fadeIn(n,r)),t._storeUpdateAndNotify(s)},change:function(e,s){var a=t._positionCalloutUpdateText(i,n,r,s);0==o&&a>=0&&(o=!0,t._callout_fadeIn(n,r)),1==o&&t._callout_fadeOut(n,r,function(){o=!1}),t._storeUpdateAndNotify(s)}};if(0==this.options.range)s.value=this.valueHandler.convertDomainValueToSlider(this.latestValue());else if("min"==this.options.range||"max"==this.options.range)s.range=this.options.range,s.value=this.valueHandler.convertDomainValueToSlider(this.latestValue());else if(1==this.options.range){s.range=!0;var a=this.latestValue();s.values=[this.valueHandler.convertDomainValueToSlider(a[0]),this.valueHandler.convertDomainValueToSlider(a[1])]}e("#"+this.options.idBase).slider(s)}});t.SingleHandleSliderWithCallout=t.Class(o,{setConfiguredValue:function(e){this.configuredValue=e},getCurrentValue:function(){return this.latestValue()},programmedUpdate:function(t){this.setConfiguredValue(t),e("#"+this.options.idBase).slider("value",this.valueHandler.convertDomainValueToSlider(this.latestValue()))},_positionCalloutForUpdate:function(t,i){return e(t).css("left",this._computeCallOutLeftValue(i.value)+"%"),0},_positionCalloutUpdateText:function(e,t,i,n){return this._positionCalloutForUpdate(e,n),this._setText(t,i,this.valueHandler.convertSliderValueToDomain(n.value)),0},_storeUpdateAndNotify:function(e){var t=this.valueHandler.convertSliderValueToDomain(e.value);t!=this.configuredValue&&(this.configuredValue=t,this.options.changeFn(t))}}),t.RangeSliderWithCallout=t.Class(o,{setConfiguredValue:function(e){this.configuredValue=e},getCurrentValue:function(){return this.latestValue()},programmedUpdate:function(t){this.setConfiguredValue(t);var i=this.valueHandler.convertDomainValueToSlider(t[0]),n=this.valueHandler.convertDomainValueToSlider(t[1]);e("#"+this.options.idBase).slider("values",[i,n])},_whichIsChanging:function(e){var t=this.latestValue(),i=[this.valueHandler.convertSliderValueToDomain(e.values[0]),this.valueHandler.convertSliderValueToDomain(e.values[1])];return this.valueHandler.equals(t[0],i[0])&&this.valueHandler.equals(t[1],i[1])?-1:this.valueHandler.equals(t[0],i[0])?1:0},_positionCalloutForUpdate:function(t,i){var n=this._whichIsChanging(i);return n>=0&&e(t).css("left",this._computeCallOutLeftValue(i.values[n])+"%"),n},_positionCalloutUpdateText:function(e,t,i,n){var r=this._positionCalloutForUpdate(e,n);return r>=0&&this._setText(t,i,this.valueHandler.convertSliderValueToDomain(n.values[r])),r},_storeUpdateAndNotify:function(e){var t=[this.valueHandler.convertSliderValueToDomain(e.values[0]),this.valueHandler.convertSliderValueToDomain(e.values[1])];isDefined(this.configuredValue)&&this.valueHandler.equals(t[0],this.configuredValue[0])&&this.valueHandler.equals(t[1],this.configuredValue[1])||(this.configuredValue=t,this.options.changeFn(t))}})}(jQuery,nunaliit2),function(e,t){var i=864e5;t.TIMELINE_DATE_MARKS_Durations_DAY=i,t.TIMELINE_DATE_MARKS_Durations_WEEK=7*i,t.TIMELINE_DATE_MARKS_Durations_YEAR=365*i;var n={containerId:"",idBase:"",min:null,max:null,base:t.TIMELINE_DATE_MARKS_Durations_WEEK,steps:null,format:"M d"};var r="yy-mm-dd";function o(t,i){var n=t.slice(0);return e.datepicker.formatDate(n,i)}function s(e,n,s,a){function l(e,t){return{date:e,labelled:t}}var c=function(e,t){return Math.floor((t-e)/i)}(e,n);0>=a&&t.log("$n2.TimelineDateMarks: invalid steps value: "+a),0>=s&&t.log("$n2.TimelineDateMarks: invalid base value: "+s),0>=c&&t.log("$n2.TimelineDateMarks: invalid date range: "+o(r,e)+" : "+o(r,n));var d,u,h=Math.floor(c*i/s),p=Math.floor(h/a);p<1?(d=s,u=1,h<1&&(d=i,u=Math.floor(c/a))):(d=s,u=p);var f=[];f.push(l(new Date(e),!0));for(var m=new Date(e),v=u;m<n;)if(m.setMilliseconds(m.getMilliseconds()+d),m<n){var g=!1;if(0==--v)if(u<=1)g=!0;else n-m>=Math.floor(.75*u)*d&&(g=!0);g?f.push(l(new Date(m),!0)):f.push(l(new Date(m),!1)),v<=0&&(v=u)}else f.push(l(new Date(n),!0));return f}function a(e,t,i){return(e-t)/(i-t)*100}function l(t,i,n,r){var o=e('<div class="TimelineDateMarks_label" style="width:0px;padding:0px;margin:0px;border:none"></div>');if(t.append(o),e(o).css("left",i+"%"),r){var s=function(e){var t,i=Math.floor(e.length/2),n=new Array;return i>0?(" "==(t=e.slice(0,i))[t.length-1]&&(t=t.slice(0,-1)+"&nbsp;"),n.push(t)):n.push(""),e.length-i>0?(" "==(t=e.slice(i))[0]&&(t="&nbsp;"+t.slice(1)),n.push(t)):n.push(""),n}(n);o.append('<div class="TimelineDateMarks_labelLeft" style="position:absolute;right:0px;bottom:0px;text-align:right;">'+s[0]+'</div><div class="TimelineDateMarks_labelRight" style="position:absolute;left:0px;bottom:0px;text-align:left;">'+s[1]+"</div>")}o.append('<div class="TimelineDateMarks_labelTick '+(r?"TimelineDateMarks_labelTick_large":"TimelineDateMarks_labelTick_small")+'" style="position:absolute;left:0px;bottom:0px;text-align:left;">|</div>')}t.TimelineDateMarks=t.Class({options:null,dates:null,initialize:function(){this.options=e.extend({},n);for(var i=0;i<arguments.length;i++){var r=arguments[i];t.isDefined(r)&&(this.options=e.extend(!0,this.options,r))}t.isDefined(this.options.min)&&t.isDefined(this.options.max)&&t.isDefined(this.options.base)&&t.isDefined(this.options.steps)&&(this.dates=s(this.options.min,this.options.max,this.options.base,this.options.steps))},setDateRangeParms:function(e,t,i,n){this.options.min=e,this.options.max=t,this.options.base=i,this.options.steps=n,this.dates=s(this.options.min,this.options.max,this.options.base,this.options.steps)},draw:function(){var t=e('<div class="TimelineDateMarks_wrapper"></div>');e("#"+this.options.containerId).empty().append(t);for(var i=0;i<this.dates.length;i++){var n=this.dates[i],r=a(n.date,this.options.min,this.options.max);n.labelled?l(t,r,o(this.options.format,n.date),!0):l(t,r,"",!1)}}})}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n=t.Class({options:null,progressKeyCache:null,initialize:function(e){this.options=e,this.progressKeyCache=[]},getKey:function(e){var t=this.progressKeyCache.shift();t?e(t):this.refresh(e)},refresh:function(n){var r=this;e.ajax({url:this.options.url+"getIds",type:"get",async:!0,data:{count:20},dataType:"json",success:function(e){if(e&&e.progressIds){for(var o;o=e.progressIds.shift();)r.progressKeyCache.push(o);var s=r.progressKeyCache.shift();s&&n(s)}else r.options.onError(i("Error occurred with progress service")),t.log("Progress service did not return any results")},error:function(e,n,o){r.options.onError(i("Error occurred with progress service")),t.log("Progress service returned error",n,o)}})}}),r=0,o={progressKey:null,onStart:function(e){},onUpdate:function(e){},onComplete:function(e){},onRemove:function(e){}},s=t.Class({options:null,id:null,progressServer:null,progressKey:null,startSent:!1,completedSent:!1,info:{count:0,total:0,completed:!1},initialize:function(e,t){this.progressServer=e,this.options=t,this.id="progressTracker"+r,++r},getId:function(){return this.id},getProgressKey:function(){return this.options.progressKey},cancel:function(){this.progressServer._unregisterProgressTracker(this)},getTotal:function(){return this.info.total},getCurrent:function(){return this.info.current},isCompleted:function(){return this.info.completed},_update:function(e){this.info=e,this.completedSent||(0==this.startSent&&(this.options.onStart(this),this.startSent=!0),this.options.onUpdate(this),e.completed&&(this.options.onComplete(this),this.completedSent=!0))}}),a={url:null,pollingIntervalInMs:750,onError:function(e){t.reportError(e)}},l=t.Class({options:null,progressKeyCache:null,progressTrackers:null,pollingInProgress:!1,initialize:function(e){this.options=t.extend({},a,e),this.progressKeyCache=new n(this.options),this.progressTrackers={}},requestProgressKey:function(e){this.progressKeyCache.getKey(e)},createProgressTracker:function(e){var i=t.extend({},o,e);if(!i.progressKey)return null;var n=new s(this,i);return this._registerProgressTracker(n),n},_registerProgressTracker:function(e){var t=e.getProgressKey(),i=e.getId(),n=this.progressTrackers[t];n||(n={},this.progressTrackers[t]=n),n[i]||(n[i]=e),this._initiatePolling()},_unregisterProgressTracker:function(e){var t=e.getProgressKey(),i=e.getId(),n=this.progressTrackers[t];if(n){n[i]&&delete n[i];var r=0;for(var o in n)++r;r<1&&delete this.progressTrackers[t]}},_initiatePolling:function(){if(!this.pollingInProgress){var n=[];for(var r in this.progressTrackers)n.push(r);if(!(n.length<1)){var o=this;e.ajax({url:this.options.url+"getProgresses",type:"get",async:!0,traditional:!0,data:{progressId:n},dataType:"json",success:function(e){o._processProgressResults(e)?setTimeout(function(){o._initiatePolling()},o.options.pollingIntervalInMs):o.pollingInProgress=!1},error:function(e,n,r){o.pollingInProgress=!1,o.options.onError(i("Error occurred with progress service")),t.log("Progress service returned error on getProgresses",n,r)}})}}},_processProgressResults:function(e){var t=!1;if(e&&e.results){for(var i=[],n={},r=0,o=e.results.length;r<o;++r){var s=e.results[r];if(n[c=s.id]=s,d=this.progressTrackers[c])for(var a in d){(l=d[a])&&(l._update(s),s.completed?i.push(l):t=!0)}}for(r=0,o=i.length;r<o;++r){var l=i[r];this._unregisterProgressTracker(l)}if(!t)for(var c in this.progressTrackers){var d;if(d=this.progressTrackers[c])for(var a in d)n[c]||(t=!0)}}return t}});t.progress={ProgressServer:l}}(jQuery,nunaliit2),function($){var uniqueId=0,polling=!1,progressKeyCache=[],trackedKeys={},trackerElements=[],getId=function(){var e="progress_id_"+uniqueId;return++uniqueId,e},refreshProgressKeyCache=function(callback){$.get("progress/getIds?count=5",function(data){var response;if(data)if(eval("response = "+data),response){if(response.progressIds)for(var key;key=response.progressIds.shift();)progressKeyCache.push(key);if(callback){var id=progressKeyCache.shift();id&&callback(id)}}else window.console&&window.console.log&&window.console.log("No response returned by progress service");else window.console&&window.console.log&&window.console.log("No data returned by progress service")})},onStartDefault=function(e,t){var i=t.id+"_"+e.key,n=$('<div id="progress_'+i+'"><div id="progressbar_'+i+'"></div><div><span class="progress-x" id="progressa_'+i+'">X</span>'+e.desc+'<span id="progresstext_'+i+'">Starting...</span></div></div>'),r=$("#"+t.trackerId);n.appendTo(r),$("#progressbar_"+i).progressbar(),$("#progressa_"+i).click(function(t){return $.progress.removeDisplayOn(e.key),!1})},onCompleteDefault=function(e,t){var i=t.id+"_"+e.key;$("#progressbar_"+i).progressbar("value",100),$("#progresstext_"+i).text("Done.")},onUpdateDefault=function(e,t){var i=t.id+"_"+e.key;$("#progressbar_"+i).progressbar("value",e.value),$("#progresstext_"+i).text(e.value+"%")},onRemoveDefault=function(e,t){e=t.id+"_"+e;$("#progress_"+e).remove()},createActivity=function(e,t){t.onStart&&t.onStart(e,t)},updateActivity=function(e,t){t.onUpdate&&t.onUpdate(e,t)},forEachTracker=function(e){var t;for(t=0;t<trackerElements.length;++t){e(trackerElements[t])}},forEachActivity=function(e){for(var t in trackedKeys){e(t,trackedKeys[t])}},pollProgress=function(){var params=null;for(var key in trackedKeys)params?params+="&progressId="+key:params="?progressId="+key;if(params){var trackerDisplayed=!1;forEachTracker(function(e){trackerDisplayed=!0}),trackerDisplayed?(polling=!0,$.get("progress/getProgresses"+params,function(data){if(!data)return window.console&&window.console.log&&window.console.log("No data"),void(polling=!1);var response;if(eval("response = "+data),!response)return window.console&&window.console.log&&window.console.log("Empty response"),void(polling=!1);for(var array=response.results;array.length>0;){var info=array.shift(),key=info.id,total=1*info.total,current=1*info.current,percentage=0;if(0!=total&&(percentage=Math.floor(100*current/total)),info.chained)for(var chainedInfos=info.chained,loop=0;loop<chainedInfos.length;++loop){var chainedInfo=chainedInfos[loop];trackedKeys[chainedInfo.id]||$.progress.startProgressTrackingOn(chainedInfo.id,chainedInfo.description)}var keyInfo=trackedKeys[key];keyInfo&&(keyInfo.value==percentage?keyInfo.duplicates=keyInfo.duplicates+1:keyInfo.duplicates=0,keyInfo.value=percentage,info.data&&(keyInfo.data=info.data),forEachTracker(function(e){updateActivity(keyInfo,e)}),info.completed?(keyInfo.completed=!0,$.progress.stopProgressTrackingOn(key)):keyInfo.duplicates>15&&$.progress.stopProgressTrackingOn(key))}setTimeout(pollProgress,750)})):polling=!1}else polling=!1};$.progress={getProgressKey:function(e){var t=progressKeyCache.shift();t?e(t):refreshProgressKeyCache(e)},startProgressTrackingOn:function(e,t){var i=trackedKeys[e]={value:0,key:e,desc:t,duplicates:0};forEachTracker(function(e){createActivity(i,e)}),polling||pollProgress()},stopProgressTrackingOn:function(e){var t=trackedKeys[e];t&&(forEachTracker(function(e){e.onComplete&&e.onComplete(t,e)}),delete trackedKeys[e])},removeDisplayOn:function(e){$.progress.stopProgressTrackingOn(e),forEachTracker(function(t){t.onRemove&&t.onRemove(e,t)})},progressTrackerDefaultOptions:{onStart:onStartDefault,onUpdate:onUpdateDefault,onComplete:onCompleteDefault,onRemove:onRemoveDefault},addProgressTracker:function(e){var t=$.extend({},$.progress.progressTrackerDefaultOptions,e);trackerElements.push(t),forEachActivity(function(e,i){createActivity(i,t),updateActivity(i,t)}),polling||pollProgress()}},$.fn.progressTracker=function(e){return this.each(function(){var t=getId();$('<div id="'+t+'"></div>').appendTo(this);e.trackerId=t,$.progress.addProgressTracker(e)})};var installButton=function(e,t,i,n){var r=$('<input type="button" value="'+n.message+'">');r.click(function(t){n.onClick(e,i),setTimeout(function(){$.progress.getProgressKey(function(t){installButton(e,r,t,n)})},0)}),t?(t.after(r),t.remove()):$(e).append(r)},keyedButtonDefaultOptions={onClick:function(){},message:"OK"};$.fn.keyedButton=function(e){return this.each(function(){var t=$.extend({},keyedButtonDefaultOptions,e),i=this;$.progress.getProgressKey(function(e){installButton(i,null,e,t)})})}}(jQuery),function(e){function t(t){var n=e("#"+t);n.animate({left:"0px",bottom:"0px"},function(){n.one("click",function(){i(t)}),n.attr("prog-slider-viewed",0),s(t)})}function i(i){var n=e("#"+i),r=e(window),o=r.width()/2,s=r.height()/2,a=(n.offset(),n.width()),l=n.height(),c=Math.floor(o-a/2),d=Math.floor(s-l/2);n.attr("prog-slider-viewed",1),n.animate({left:c+"px",bottom:d+"px"},function(){!function(i){e("#"+i).one("click",function(){!function(i){var n=e("#"+i+"_down");n.size()>0?n.slideUp(function(){t(i)}):t(i)}(i)}),e("#"+i+"_down").slideDown()}(i)})}function n(t,n){!function(){0===(t=e("#progress-slider")).size()&&(t=e('<div id="progress-slider" class="prog-holder"><div id="progress-slider-background" class="prog-background" style="position:absolute;top:0px;left:0px;width:100%;height:100%;"></div></div>'),e(document.body).append(t));var t=e("#progress-slider")}();var o=e('<div id="'+t+'" title="'+n+'" class="prog-moveBar" style="position:relative;left:0px;bottom:0px;"><div id="'+t+'_value" class="prog-moveBar-colour" style="width:0%"></div><div id="'+t+'_down" style="position:absolute;display:none;left:-200px;top:-2px;width:600px;margin:0px;background:#ffffff;border:1px solid #000000"><div id="'+t+'_value2" class="prog-moveBar-colour" style="width:0%"></div><table class="prog-description-table"><tr><th>Description:</th><td id="'+t+'_description">'+n+'</td></tr><tr><th>Progress:</th><td id="'+t+'_percent"></td></tr><tr><th></th><td><a id="'+t+'_cancel" href="#">Cancel Reporting</a></td></tr></table></div></div>');return e("#progress-slider-background").after(o),e("#"+t+"_cancel").click(function(e){return r(t),!1}),o.one("click",function(){i(t)}),o.attr("prog-slider-viewed",0),t}function r(t){var i=e("#"+t);i.slideUp(function(){i.remove()})}function o(t,i){i>100&&(i=100),i<0&&(i=0),e("#"+t+"_value").css({width:i+"%"}),e("#"+t+"_value2").css({width:i+"%"}),e("#"+t+"_percent").text(i+"%")}function s(t){var i=e("#"+t);if(i.size()>0){var n=1*i.attr("prog-slider-ready-remove"),o=1*i.attr("prog-slider-viewed");n&&!o&&r(t)}}if(e.progress&&e.progress.addProgressTracker){var a={onStart:function(e,t){n("prog-slider_"+e.key,e.desc)},onUpdate:function(t,i){var n="prog-slider_"+t.key;o(n,t.value),e("#"+n).attr("title",t.desc+" ("+t.value+"%)")},onComplete:function(t,i){var n="prog-slider_"+t.key;o(n,100),e("#"+n+"_percent").text("Done"),e("#"+n).attr("title",t.desc+". Done."),e("#"+n).attr("prog-slider-stopped",1).attr("prog-slider-ready-remove",0),setTimeout(function(){e("#"+n).attr("prog-slider-ready-remove",1),s(n)},5e3)},onRemove:function(e,t){r(e="prog-slider_"+e)}};e.progress.addProgressTracker(a)}}(jQuery),JSON||(JSON={}),function(){function f(e){return e<10?"0"+e:e}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(e){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var i,n,r,o,s,a=gap,l=t[e];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(e)),"function"==typeof rep&&(l=rep.call(t,e,l)),typeof l){case"string":return quote(l);case"number":return isFinite(l)?String(l):"null";case"boolean":case"null":return String(l);case"object":if(!l)return"null";if(gap+=indent,s=[],"[object Array]"===Object.prototype.toString.apply(l)){for(o=l.length,i=0;i<o;i+=1)s[i]=str(i,l)||"null";return r=0===s.length?"[]":gap?"[\n"+gap+s.join(",\n"+gap)+"\n"+a+"]":"["+s.join(",")+"]",gap=a,r}if(rep&&"object"==typeof rep)for(o=rep.length,i=0;i<o;i+=1)"string"==typeof(n=rep[i])&&(r=str(n,l))&&s.push(quote(n)+(gap?": ":":")+r);else for(n in l)Object.hasOwnProperty.call(l,n)&&(r=str(n,l))&&s.push(quote(n)+(gap?": ":":")+r);return r=0===s.length?"{}":gap?"{\n"+gap+s.join(",\n"+gap)+"\n"+a+"}":"{"+s.join(",")+"}",gap=a,r}}"function"!=typeof JSON.stringify&&(JSON.stringify=function(e,t,i){var n;if(gap="",indent="","number"==typeof i)for(n=0;n<i;n+=1)indent+=" ";else"string"==typeof i&&(indent=i);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return str("",{"":e})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){var j;function walk(e,t){var i,n,r=e[t];if(r&&"object"==typeof r)for(i in r)Object.hasOwnProperty.call(r,i)&&(void 0!==(n=walk(r,i))?r[i]=n:delete r[i]);return reviver.call(e,t,r)}if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),function($){$.Cometd=function(name){var _name=name||"default",_logPriorities={debug:1,info:2,warn:3,error:4},_logLevel="info",_url,_xd=!1,_transport,_status="disconnected",_messageId=0,_clientId=null,_batch=0,_messageQueue=[],_listeners={},_backoff=0,_backoffIncrement=1e3,_maxBackoff=6e4,_scheduledSend=null,_extensions=[],_advice={},_handshakeProps;function _configure(e){_debug("Initializing comet with url: {}",_url=e);var t=/(^https?:)?(\/\/(([^:\/\?#]+)(:(\d+))?))?([^\?#]*)/.exec(e);t[3]&&(_xd=t[3]!=location.host),_transport=_xd?newCallbackPollingTransport():newLongPollingTransport(),_debug("Initial transport is {}",_transport.getType())}function _resubscribe(){for(var e in _listeners){var t={channel:"/meta/subscribe",subscription:e};_send($.extend({},t))}}function _startBatch(){++_batch}function _endBatch(e){if(--_batch<0&&(_batch=0),e&&0==_batch&&!_isDisconnected()){var t=_messageQueue;_messageQueue=[],t.length>0&&_deliver(t,!1)}}function _nextMessageId(){return++_messageId}function _convertToMessages(response){if(void 0===response)return[];if(response instanceof Array)return response;if(response instanceof String||"string"==typeof response)return eval("("+response+")");if(response instanceof Object)return[response];throw"Conversion Error "+response+", typeof "+typeof response}function _setStatus(e){_debug("{} -> {}",_status,e),_status=e}function _isDisconnected(){return"disconnecting"==_status||"disconnected"==_status}function _handshake(e){_debug("Starting handshake"),_clientId=null,_batch=0,_startBatch(),_handshakeProps=$.extend(!0,{},e);var t={version:"1.0",minimumVersion:"0.9",channel:"/meta/handshake",supportedConnectionTypes:_xd?["callback-polling"]:["long-polling","callback-polling"]},i=$.extend({},e,t);_setStatus("handshaking"),_deliver([i],!1)}function _findTransport(e){var t=e.supportedConnectionTypes;if(_xd){if($.inArray("callback-polling",t)>=0)return _transport}else{if($.inArray("long-polling",t)>=0)return _transport;if($.inArray("callback-polling",t)>=0)return newCallbackPollingTransport()}return null}function _delayedHandshake(){_setStatus("handshaking"),_delayedSend(function(){_handshake(_handshakeProps)})}function _delayedConnect(){_setStatus("connecting"),_delayedSend(function(){_connect()})}function _delayedSend(e){_cancelDelayedSend();var t=_backoff;_debug("Delayed send: backoff {}, interval {}",_backoff,_advice.interval),_advice.interval&&_advice.interval>0&&(t+=_advice.interval),_scheduledSend=_setTimeout(e,t)}function _cancelDelayedSend(){null!==_scheduledSend&&clearTimeout(_scheduledSend),_scheduledSend=null}function _setTimeout(e,t){return setTimeout(function(){try{e()}catch(t){_debug("Exception during scheduled execution of function '{}': {}",e.name,t)}},t)}function _connect(){_debug("Starting connect");var e={channel:"/meta/connect",connectionType:_transport.getType()};_setStatus("connecting"),_deliver([e],!0),_setStatus("connected")}function _send(e){_batch>0?_messageQueue.push(e):_deliver([e],!1)}function _deliver(e,t){$.each(e,function(t,i){i.id=_nextMessageId(),_clientId&&(i.clientId=_clientId),e[t]=_applyOutgoingExtensions(i)});var i=this,n={url:_url,messages:e,onSuccess:function(e,n){try{_handleSuccess.call(i,e,n,t)}catch(e){_debug("Exception during execution of success callback: {}",e)}},onFailure:function(n,r,o){try{_handleFailure.call(i,n,e,r,o,t)}catch(e){_debug("Exception during execution of failure callback: {}",e)}}};_debug("Sending request to {}, message(s): {}",n.url,JSON.stringify(n.messages)),_transport.send(n,t)}function _applyIncomingExtensions(e){return $.each(_extensions,function(t,i){var n=i.extension.incoming;n&&"function"==typeof n&&(_debug("Calling incoming extension '{}', callback '{}'",i.name,n.name),e=_applyExtension(i.name,n,e)||e)}),e}function _applyOutgoingExtensions(e){return $.each(_extensions,function(t,i){var n=i.extension.outgoing;n&&"function"==typeof n&&(_debug("Calling outgoing extension '{}', callback '{}'",i.name,n.name),e=_applyExtension(i.name,n,e)||e)}),e}function _applyExtension(e,t,i){try{return t(i)}catch(t){return _debug("Exception during execution of extension '{}': {}",e,t),i}}function _handleSuccess(e,t,i){var n=_convertToMessages(t);_debug("Received response {}",JSON.stringify(n));var r=!0;$.each(n,function(e,t){(t=_applyIncomingExtensions(t)).advice&&(_advice=t.advice);var i=t.successful;switch(r=r&&(void 0===i||i),t.channel){case"/meta/handshake":_handshakeSuccess(t);break;case"/meta/connect":_connectSuccess(t);break;case"/meta/disconnect":_disconnectSuccess(t);break;case"/meta/subscribe":_subscribeSuccess(t);break;case"/meta/unsubscribe":_unsubscribeSuccess(t);break;default:_messageSuccess(t)}}),_transport.complete(e,r,i)}function _handleFailure(e,t,i,n,r){var o=e.xhr;_debug("Request failed, status: {}, reason: {}, exception: {}",o&&o.status,i,n),$.each(t,function(e,t){switch(t.channel){case"/meta/handshake":_handshakeFailure(o,t);break;case"/meta/connect":_connectFailure(o,t);break;case"/meta/disconnect":_disconnectFailure(o,t);break;case"/meta/subscribe":_subscribeFailure(o,t);break;case"/meta/unsubscribe":_unsubscribeFailure(o,t);break;default:_messageFailure(o,t)}}),_transport.complete(e,!1,r)}function _handshakeSuccess(e){if(e.successful){_debug("Handshake successful"),_clientId=e.clientId;var t=_findTransport(e);if(null===t)throw"Could not agree on transport with server";switch(_transport.getType()!=t.getType()&&(_debug("Changing transport from {} to {}",_transport.getType(),t.getType()),_transport=t),_notifyListeners("/meta/handshake",e),_advice.reconnect?_advice.reconnect:"retry"){case"retry":_delayedConnect()}}else{_debug("Handshake unsuccessful");var i=!_isDisconnected()&&"none"!=_advice.reconnect;i||_setStatus("disconnected"),_notifyListeners("/meta/handshake",e),_notifyListeners("/meta/unsuccessful",e),i&&(_increaseBackoff(),_debug("Handshake failure, backing off and retrying in {} ms",_backoff),_delayedHandshake())}}function _handshakeFailure(e,t){_debug("Handshake failure");var i={successful:!1,failure:!0,channel:"/meta/handshake",request:t,xhr:e,advice:{action:"retry",interval:_backoff}},n=!_isDisconnected()&&"none"!=_advice.reconnect;n||_setStatus("disconnected"),_notifyListeners("/meta/handshake",i),_notifyListeners("/meta/unsuccessful",i),n&&(_increaseBackoff(),_debug("Handshake failure, backing off and retrying in {} ms",_backoff),_delayedHandshake())}function _connectSuccess(e){var t=_isDisconnected()?"none":_advice.reconnect?_advice.reconnect:"retry";if(_isDisconnected()||_setStatus("retry"==t?"connecting":"disconnecting"),e.successful)switch(_debug("Connect successful"),_endBatch(!0),_notifyListeners("/meta/connect",e),t){case"retry":_resetBackoff(),_delayedConnect();break;default:_resetBackoff(),_setStatus("disconnected")}else switch(_debug("Connect unsuccessful"),_notifyListeners("/meta/connect",e),_notifyListeners("/meta/unsuccessful",e),t){case"retry":_increaseBackoff(),_delayedConnect();break;case"handshake":0==_batch&&_startBatch(),_resubscribe(),_endBatch(!1),_resetBackoff(),_delayedHandshake();break;case"none":_resetBackoff(),_setStatus("disconnected")}}function _connectFailure(e,t){_debug("Connect failure");var i={successful:!1,failure:!0,channel:"/meta/connect",request:t,xhr:e,advice:{action:"retry",interval:_backoff}};if(_notifyListeners("/meta/connect",i),_notifyListeners("/meta/unsuccessful",i),!_isDisconnected()){var n=_advice.reconnect?_advice.reconnect:"retry";switch(n){case"retry":_increaseBackoff(),_debug("Connect failure, backing off and retrying in {} ms",_backoff),_delayedConnect();break;case"handshake":_resetBackoff(),_delayedHandshake();break;case"none":_resetBackoff();break;default:_debug("Unrecognized reconnect value: {}",n)}}}function _disconnectSuccess(e){e.successful?(_debug("Disconnect successful"),_disconnect(!1),_notifyListeners("/meta/disconnect",e)):(_debug("Disconnect unsuccessful"),_disconnect(!0),_notifyListeners("/meta/disconnect",e),_notifyListeners("/meta/usuccessful",e))}function _disconnect(e){_cancelDelayedSend(),e&&_transport.abort(),_clientId=null,_setStatus("disconnected"),_batch=0,_messageQueue=[],_resetBackoff()}function _disconnectFailure(e,t){_debug("Disconnect failure"),_disconnect(!0);var i={successful:!1,failure:!0,channel:"/meta/disconnect",request:t,xhr:e,advice:{action:"none",interval:0}};_notifyListeners("/meta/disconnect",i),_notifyListeners("/meta/unsuccessful",i)}function _subscribeSuccess(e){e.successful?(_debug("Subscribe successful"),_notifyListeners("/meta/subscribe",e)):(_debug("Subscribe unsuccessful"),_notifyListeners("/meta/subscribe",e),_notifyListeners("/meta/unsuccessful",e))}function _subscribeFailure(e,t){_debug("Subscribe failure");var i={successful:!1,failure:!0,channel:"/meta/subscribe",request:t,xhr:e,advice:{action:"none",interval:0}};_notifyListeners("/meta/subscribe",i),_notifyListeners("/meta/unsuccessful",i)}function _unsubscribeSuccess(e){e.successful?(_debug("Unsubscribe successful"),_notifyListeners("/meta/unsubscribe",e)):(_debug("Unsubscribe unsuccessful"),_notifyListeners("/meta/unsubscribe",e),_notifyListeners("/meta/unsuccessful",e))}function _unsubscribeFailure(e,t){_debug("Unsubscribe failure");var i={successful:!1,failure:!0,channel:"/meta/unsubscribe",request:t,xhr:e,advice:{action:"none",interval:0}};_notifyListeners("/meta/unsubscribe",i),_notifyListeners("/meta/unsuccessful",i)}function _messageSuccess(e){void 0===e.successful?e.data?_notifyListeners(e.channel,e):_debug("Unknown message {}",JSON.stringify(e)):e.successful?(_debug("Publish successful"),_notifyListeners("/meta/publish",e)):(_debug("Publish unsuccessful"),_notifyListeners("/meta/publish",e),_notifyListeners("/meta/unsuccessful",e))}function _messageFailure(e,t){_debug("Publish failure");var i={successful:!1,failure:!0,channel:t.channel,request:t,xhr:e,advice:{action:"none",interval:0}};_notifyListeners("/meta/publish",i),_notifyListeners("/meta/unsuccessful",i)}function _notifyListeners(e,t){_notify(e,t);for(var i=e.split("/"),n=i.length-1,r=n;r>0;--r){var o=i.slice(0,r).join("/")+"/*";r==n&&_notify(o,t),_notify(o+="*",t)}}function _notify(e,t){var i=_listeners[e];i&&i.length>0&&$.each(i,function(i,n){if(n)try{_debug("Notifying subscription: channel '{}', callback '{}'",e,n.callback.name),n.callback.call(n.scope,t)}catch(i){_warn("Exception during execution of callback '{}' on channel '{}' for message {}, exception: {}",n.callback.name,e,JSON.stringify(t),i)}})}function _resetBackoff(){_backoff=0}function _increaseBackoff(){_backoff<_maxBackoff&&(_backoff+=_backoffIncrement)}this.getName=function(){return _name},this.configure=function(e){_configure(e)},this.init=function(e,t){_configure(e),_handshake(t)},this.handshake=function(e){_handshake(e)},this.disconnect=function(e){var t=$.extend({},e,{channel:"/meta/disconnect"});_setStatus("disconnecting"),_deliver([t],!1)},this.startBatch=function(){_startBatch()},this.endBatch=function(){_endBatch(!0)},this.subscribe=function(e,t,i,n){var r=this.addListener(e,t,i),o={channel:"/meta/subscribe",subscription:e};return _send($.extend({},n,o)),r},this.unsubscribe=function(e,t){this.removeListener(e);var i={channel:"/meta/unsubscribe",subscription:e[0]};_send($.extend({},t,i))},this.publish=function(e,t,i){var n={channel:e,data:t};_send($.extend({},i,n))},this.addListener=function(e,t,i){i||(i=t,t=void 0);var n={scope:t,callback:i},r=_listeners[e];r||(r=[],_listeners[e]=r);var o=r.push(n)-1;return _debug("Added listener: channel '{}', callback '{}', index {}",e,i.name,o),[e,o]},this.removeListener=function(e){var t=_listeners[e[0]];t&&(delete t[e[1]],_debug("Removed listener: channel '{}', index {}",e[0],e[1]))},this.clearListeners=function(){_listeners={}},this.getStatus=function(){return _status},this.setBackoffIncrement=function(e){_backoffIncrement=e},this.getBackoffIncrement=function(){return _backoffIncrement},this.getBackoffPeriod=function(){return _backoff},this.setLogLevel=function(e){_logLevel=e},this.registerExtension=function(e,t){var i=!1;return $.each(_extensions,function(t,n){if(n.name==e)return i=!0,!1}),i?(_info("Could not register extension with name '{}': another extension with the same name already exists"),!1):(_extensions.push({name:e,extension:t}),_debug("Registered extension '{}'",e),!0)},this.unregisterExtension=function(e){var t=!1;return $.each(_extensions,function(i,n){if(n.name==e)return _extensions.splice(i,1),t=!0,_debug("Unregistered extension '{}'",e),!1}),t};var _error=this._error=function(e,t){_log("error",_format.apply(this,arguments))},_warn=this._warn=function(e,t){_log("warn",_format.apply(this,arguments))},_info=this._info=function(e,t){_log("info",_format.apply(this,arguments))},_debug=this._debug=function(e,t){_log("debug",_format.apply(this,arguments))};function _log(e,t){var i=_logPriorities[e],n=_logPriorities[_logLevel];n||(n=_logPriorities.info),i>=n&&window.console&&window.console.log(t)}function _format(e){for(var t=/\{\}/g,i="",n=0,r=0;t.test(e);){i+=e.substr(n,t.lastIndex-n-2);var o=arguments[++r];i+=void 0!==o?o:"{}",n=t.lastIndex}return i+=e.substr(n,e.length-n)}function newLongPollingTransport(){return $.extend({},new Transport("long-polling"),new LongPollingTransport)}function newCallbackPollingTransport(){return $.extend({},new Transport("callback-polling"),new CallbackPollingTransport)}var Transport=function(e){var t=2,i=0,n=null,r=[],o=[];function s(e,n){var s=++i;_debug("Beginning request {}, {} other requests, {} queued requests",s,r.length,o.length);var a={id:s};r.length<t-1?(_debug("Delivering request {}",s),e.deliver(n,a),r.push(a)):(o.push([n,a]),_debug("Queued request {}, {} queued requests",s,o.length))}this.getType=function(){return e},this.send=function(e,t){t?function(e,t){if(null!==n)throw"Concurrent comet requests not allowed, request "+n.id+" not yet completed";var r=++i;_debug("Beginning comet request {}",r);var o={id:r};e.deliver(t,o),n=o}(this,e):s(this,e)},this.complete=function(e,t,i){i?function(e){var t=e.id;if(n!==e)throw"Comet request mismatch, completing request "+t;n=null,_debug("Ended comet request {}",t)}(e):function(e,t,i){var n=t.id,a=$.inArray(t,r);a>=0&&r.splice(a,1);if(_debug("Ended request {}, {} other requests, {} queued requests",n,r.length,o.length),o.length>0){var l=o.shift();i?(_debug("Dequeueing and sending request {}, {} queued requests",l[1].id,o.length),s(e,l[0])):(_debug("Dequeueing and failing request {}, {} queued requests",l[1].id,o.length),l[0].onFailure(l[1],"error"))}}(this,e,t)},this.abort=function(){$.each(r,function(e,t){_debug("Aborting request {}",t.id),t.xhr&&t.xhr.abort()}),n&&(_debug("Aborting comet request {}",n.id),n.xhr&&n.xhr.abort()),n=null,r=[],o=[]}},LongPollingTransport=function(){this.deliver=function(e,t){t.xhr=$.ajax({url:e.url,type:"POST",contentType:"text/json;charset=UTF-8",beforeSend:function(e){return!0},data:JSON.stringify(e.messages),success:function(i){e.onSuccess(t,i)},error:function(i,n,r){e.onFailure(t,n,r)}})}},CallbackPollingTransport=function(){this.deliver=function(e,t){var i=JSON.stringify(e.messages),n=e.url.length+encodeURI(i).length;if(_debug("URL length: {}",n),n>2e3){var r=e.messages.length>1?"Too many bayeux messages in the same batch resulting in message too big ("+n+" bytes, max is 2000) for transport "+this.getType():"Bayeux message too big ("+n+" bytes, max is 2000) for transport "+this.getType();_setTimeout(function(){e.onFailure(t,"error",r)},0)}else $.ajax({url:e.url,type:"GET",dataType:"jsonp",jsonp:"jsonp",beforeSend:function(e){return!0},data:{message:i},success:function(i){e.onSuccess(t,i)},error:function(i,n,r){e.onFailure(t,n,r)}})}}},$.cometd=new $.Cometd}(jQuery),function($,$n2){var _loc=function(e,t){return $n2.loc(e,"nunaliit2-couch",t)},loginFormSchema=new $n2.form.Schema({attributes:[{name:"user",label:_loc("E-mail"),type:"text"},{name:"password",label:_loc("Password"),type:"password"}],buttons:[{name:"ok",label:_loc("OK")},{name:"cancel",label:_loc("Cancel")}]}),loginFormSchemaWithGuest=new $n2.form.Schema({attributes:[{name:"user",label:_loc("E-mail"),type:"text"},{name:"password",label:_loc("Password"),type:"password"}],buttons:[{name:"ok",label:_loc("OK")},{name:"cancel",label:_loc("Cancel")},{name:"anonym",label:_loc("Guest Login")}]}),index=0,loginStateListeners=[],addListeners=function(e){var t=getCurrentUser();if("function"==typeof e)n(e);else if(e.constructor==Array)for(var i=0;i<e.length;++i){n(e[i])}function n(e){loginStateListeners.push(e);try{e(t)}catch(e){log("$.NUNALIIT_AUTH: EXCEPTION caught in listener (add): "+e)}}},notifyListeners=function(){for(var e=getCurrentUser(),t=0;t<loginStateListeners.length;++t){var i=loginStateListeners[t];if(i)try{i(e)}catch(e){log("$.NUNALIIT_AUTH: EXCEPTION caught in listener (notify): "+e)}}},_userLogin=function(e,t,i,n){function r(){$.ajax({type:"GET",url:e.url+"/login",dataType:"json",data:{name:i,password:n},async:!0,success:c,error:d})}var o=0,s=3;function a(){e.autoAnonymousLogin&&t||e.dialog.dialog("close")}function l(i){if(e.autoAnonymousLogin&&t&&(++o<=s&&(r(),!0)))return;var n={message:"Invalid e-mail and/or password"};null!=i&&(n.cause=i),a(),e.onError(n,e),notifyListeners()}function c(t){log("Login successful",t,e),t&&t.logged?(a(),e.onSuccess(t,e),notifyListeners()):l(null)}function d(e,t,i){log("Login error",e,t,i),l({message:t})}t&&(i=e.anonymousUser,n=e.anonymousPw),r()},defaultError=function(e,t){var i=[];if(e){i.push(""+e.message);for(var n=e.cause;n;)i.push("\n>"+n.message),n=n.cause}else i.push("<Unknown error>");alert(i.join(""))},initOptions={},defaultOptions={onSuccess:function(e,t){},onError:defaultError,anonymousLoginAllowed:!1,anonymousUser:"anonymous",anonymousPw:"anonymous",autoAnonymousLogin:!1,prompt:"Please login",url:"./auth"},init=function(e){(initOptions=$.extend({},defaultOptions,e)).listeners&&(addListeners(initOptions.listeners),delete initOptions.listeners);var t=initOptions.onSuccess;delete initOptions.onSuccess;var i=initOptions.onError;delete initOptions.onError;var n=$.extend({},initOptions,{onSuccess:t,onError:i});$.ajax({type:"GET",url:initOptions.url+"/adjust",dataType:"json",async:!0,success:function(e){$n2.log("Login(adjustCookies) successful",e,initOptions),0==e.logged&&initOptions.autoAnonymousLogin?_userLogin(n,!0):(t(e,n),notifyListeners())},error:function(e,t,r){if(log("Login(adjustCookies) error",e,t,r),initOptions.autoAnonymousLogin)_userLogin(n,!0);else{var o={message:"Problem initializing authentication library",cause:{message:t}};i(o,n),notifyListeners()}}})},autoAnonLogin=function(e){var t=$.extend({},defaultOptions,initOptions,e);_userLogin(t,!0)},showLoginForm=function(e){var t=$.extend({},defaultOptions,initOptions,e),i=index;++index,t.index=i;var n=$("<div></div>");t.dialog=n,$(document.body).append(n);var r={buttonPressed:function(e,i){if("ok"===i){var r=e.getInputFromName("user").getCurrentValue(),o=e.getInputFromName("password").getCurrentValue();_userLogin(t,!1,r,o)}else"cancel"===i?n.dialog("close"):"anonym"===i&&_userLogin(t,!0)}};if(t.anonymousLoginAllowed&&!t.autoAnonymousLogin)loginFormSchemaWithGuest.createForm(n,{},r);else loginFormSchema.createForm(n,{},r);var o={autoOpen:!0,modal:!0,width:"auto",close:function(e,t){var i=$(e.target);i.dialog("destroy"),i.remove()}};t.prompt&&(o.title=t.prompt),n.dialog(o)},logout=function(e){var t=$.extend({},defaultOptions,initOptions,e);$.ajax({type:"GET",url:t.url+"/logout",username:"_",password:"_",dataType:"json",data:{name:"_"},async:!0,success:function(e){if(log("Logout successful",e,t),e&&!e.logged)t.onSuccess(e,t),notifyListeners();else{t.onError({message:"Error on logout"},t),notifyListeners()}},error:function(e,i,n){log("Logout error",e,i,n);var r={message:"Error on logout",cause:{message:i}};t.onError(r,t),notifyListeners()}})},getCurrentUser=function(){var e=null,t=getAuthContext();return t&&t.logged&&(e=t.user),e},getAuthContext=function(){var context=null,cookie=$.cookie("nunaliit-auth");return cookie&&eval("context = "+cookie+";"),context||(context={logged:!1}),context};function isDeleteAllowed(){var e=getCurrentUser();return null!=e&&e.admin}function isUpdateAllowed(e){var t=!1,i=getCurrentUser();return null!=i&&(i.admin?t=!0:i.anonymous||""==e||i.display!=e||(t=!0)),t}var isLoggedIn=function(){var e=getAuthContext();return!(!e||!e.logged)},isUser=function(){return!!isLoggedIn()&&!getCurrentUser().anonymous},isAdmin=function(){return!!isLoggedIn()&&!!getCurrentUser().admin},isAnonymous=function(){return!!isLoggedIn()&&!!getCurrentUser().anonymous};function userLoggedInAndNotAnonymous(){var e=getCurrentUser();return null!=e&&!e.anonymous}function autoAnonymousBehaviour(){return isDefined(initOptions.autoAnonymousLogin)&&initOptions.autoAnonymousLogin}$.NUNALIIT_AUTH={getUser:getCurrentUser,getAuthContext:getAuthContext,init:init,login:showLoginForm,logout:logout,addListener:addListeners,isDeleteAllowed:isDeleteAllowed,isUpdateAllowed:isUpdateAllowed,isLoggedIn:isLoggedIn,isUser:isUser,isAdmin:isAdmin,isAnonymous:isAnonymous,userLoggedInAndNotAnonymous:userLoggedInAndNotAnonymous,autoAnonymousBehaviour:autoAnonymousBehaviour,autoAnonLogin:autoAnonLogin}}(jQuery,nunaliit2),function($){var convertXmlHttpRequestError=function(xmlHttpRequest,textStatus){try{var responseText=xmlHttpRequest.responseText,msg=null;if(eval("msg = "+responseText+";"),msg.error)return msg.error}catch(e){}return{message:"Server error: "+textStatus}},defaultOptions={url:"./dbWeb",onSuccess:function(e,t){},onError:function(e,t){}},addTable=function(e,t){e.table=t.tableName},addWhereClauses=function(e,t){if(t.whereClauses){e.where=[];for(var i=0;i<t.whereClauses.length;i++)e.where.push(t.whereClauses[i])}},addSelects=function(e,t){if(t.selects){e.select=[];for(var i=0;i<t.selects.length;i++)e.select.push(t.selects[i])}},addGrouping=function(e,t){if(t.groupBys){e.groupBy=[];for(var i=0;i<t.groupBys.length;i++)e.groupBy.push(t.groupBys[i])}},addOrder=function(e,t){t.orderBy&&(e.orderBy=t.orderBy)},addLimit=function(e,t){t.limit&&(e.limit=t.limit),t.offset&&(e.offset=t.offset)},addSetters=function(e,t){if(t.setters)for(var i in e.set=[],t.setters){var n=t.setters[i];e.set.push(i+","+n)}},configure=function(e){var t=$.extend({},defaultOptions,e);defaultOptions=t},getCapabilities=function(e){var t=$.extend({},defaultOptions,e);$.ajax({type:"GET",url:t.url+"/getCapabilities",data:{},dataType:"json",async:!0,success:function(e){e.error?t.onError(e.error,t):e.capabilities?t.onSuccess(e.capabilities,t):t.onError({message:"Capabilities not returned"},t)},error:function(e,i,n){var r=convertXmlHttpRequestError(e,i);t.onError(r,t)}})},getSchema=function(e){var t=$.extend({},defaultOptions,e),i={};addTable(i,t),$.ajax({type:"GET",url:t.url+"/getSchema",data:i,dataType:"json",async:!0,success:function(e){e.error?t.onError(e.error,t):t.onSuccess(e,t)},error:function(e,i,n){var r=convertXmlHttpRequestError(e,i);t.onError(r,t)}})},query=function(e){var t=$.extend({},defaultOptions,e),i={};addTable(i,t),addWhereClauses(i,t),addSelects(i,t),addGrouping(i,t),addOrder(i,t),addLimit(i,t),$.ajax({type:"POST",url:t.url+"/query",data:i,dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,traditional:!0,success:function(e){e.error?t.onError(e.error,t):e.queried?t.onSuccess(e.queried,t):t.onError({message:"Queried objects not returned"},t)},error:function(e,i,n){var r=convertXmlHttpRequestError(e,i);t.onError(r,t)}})},queries=function(e){var t=$.extend({},defaultOptions,e),i=t.queries;if(null!=i){for(var n={},r=0;r<i.length;++r){var o=i[r],s={};if(n["q"+r]=s,s.table=o.tableName,!s.table)return void t.onError({message:"Missing table name"},e);o.selects&&(s.select=o.selects),o.whereClauses&&(s.where=o.whereClauses),o.groupBys&&(s.groupBy=o.groupBys),o.orderBy&&(s.orderBy=o.orderBy),o.limit&&(s.limit=o.limit),o.offset&&(s.offset=o.offset)}var a={queries:JSON.stringify(n)};$.ajax({type:"POST",url:t.url+"/queries",data:a,dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(n){if(n.error)t.onError(n.error,e);else{for(var r=0;r<i.length;++r){var o=i[r],s="q"+r,a=n[s];null==a?o.error={message:"No Response"}:"object"==typeof a&&"number"==typeof a.length?o.results=a:"object"==typeof a&&"string"==typeof a.message?o.error=a:o.error={message:"Unrecognized response"}}t.onSuccess(i,e)}},error:function(e,i,n){var r=convertXmlHttpRequestError(e,i);t.onError(r,t)},traditional:!0})}else t.onError({message:'"queries" not specified'},e)},insert=function(e){var t=$.extend({},defaultOptions,e),i={};addTable(i,t),addSetters(i,t),$.ajax({type:"POST",url:t.url+"/insert",data:i,dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(e){e.error?t.onError(e.error,t):e.inserted?t.onSuccess(e.inserted,t):t.onError({message:"Inserted objects not returned"},t)},error:function(e,i,n){var r=convertXmlHttpRequestError(e,i);t.onError(r,t)},traditional:!0})},update=function(e){var t=$.extend({},defaultOptions,e),i={};addTable(i,t),addWhereClauses(i,t),addSetters(i,t),$.ajax({type:"POST",url:t.url+"/update",data:i,dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(e){e.error?t.onError(e.error,t):e.updated?t.onSuccess(e.updated,t):t.onError({message:"Updated objects not returned"},t)},error:function(e,i,n){var r=convertXmlHttpRequestError(e,i);t.onError(r,t)},traditional:!0})},remove=function(e){var t=$.extend({},defaultOptions,e),i={};addTable(i,t),addWhereClauses(i,t),$.ajax({type:"POST",url:t.url+"/delete",data:i,dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(e){e.error?t.onError(e.error,t):t.onSuccess(e,t)},error:function(e,i,n){var r=convertXmlHttpRequestError(e,i);t.onError(r,t)},traditional:!0})},whereComparison_eq="eq",whereComparison_ne="ne",whereComparison_ge="ge",whereComparison_le="le",whereComparison_gt="gt",whereComparison_lt="lt",whereStatus_null="null",whereStatus_notNull="notNull",orderByAscending="a",orderByDescending="d",formatWhereClause=function(e,t,i){return null==i?t+"("+e+")":t+"("+e+")"+i},formatSearchStringRecordSelector=function(e,t,i){for(var n="search(",r=1;r<arguments.length;++r)1!=r&&(n+=","),n+=arguments[r];return n+=")",n+=e},formatFieldSelectorColumn=function(e){return""+e},selectAggregator_min="min",selectAggregator_max="max",selectAggregator_sum="sum",formatFieldSelectorFunction=function(e,t){return null==t?e:t+"("+e+")"},formatFieldSelectorScoreSubstring=function(e){for(var t="score(",i=1;i<arguments.length;++i)1!=i&&(t+=","),t+=arguments[i];return t+=")",t+=e},formatFieldSelectorCentroid=function(e,t){return"centroid("+e+","+t+")"},formatOrderBy=function(e,t){return e+","+t};$.NUNALIIT_DBWEB={getCapabilities:getCapabilities,getSchema:getSchema,query:query,queries:queries,insert:insert,update:update,remove:remove,configure:configure,whereComparison_eq:whereComparison_eq,whereComparison_ne:whereComparison_ne,whereComparison_ge:whereComparison_ge,whereComparison_le:whereComparison_le,whereComparison_gt:whereComparison_gt,whereComparison_lt:whereComparison_lt,whereStatus_null:whereStatus_null,whereStatus_notNull:whereStatus_notNull,orderByAscending:orderByAscending,orderByDescending:orderByDescending,selectAggregator_min:selectAggregator_min,selectAggregator_max:selectAggregator_max,selectAggregator_sum:selectAggregator_sum,formatWhereClause:formatWhereClause,formatSearchStringRecordSelector:formatSearchStringRecordSelector,formatFieldSelectorColumn:formatFieldSelectorColumn,formatFieldSelectorFunction:formatFieldSelectorFunction,formatFieldSelectorScoreSubstring:formatFieldSelectorScoreSubstring,formatFieldSelectorCentroid:formatFieldSelectorCentroid,formatOrderBy:formatOrderBy},$.fn.dbWebForm=function(e){var t=this,i=$.extend({},defaultOptions,{installButtons:null,data:{},fieldOpts:{},onAlert:function(e){alert(e)},onError:function(e){var i=$(t.get(0)),n=[];n.push('<div class="dbweb-error">'),n.push("Error: "),n.push(e.message),n.push("</div>"),i.empty(),i.html(n.join(""))}},e),n=$.extend({},defaultOptions,e,{onSuccess:function(e){if(o.schema=e,!e.isQueryAllowed)return void s({message:"User does not have privilege to query this data"});if(i.whereClauses){if(!e.isUpdateAllowed)return void s({message:"User does not have privilege to update this data"})}else if(!e.isInsertAllowed)return void s({message:"User does not have privilege to insert new data"});a()},onError:function(e){error={message:"Error while retrieving schema",cause:e},i.onError(error,i)}});if(getSchema(n),i.whereClauses){var r=$.extend({},defaultOptions,e,{onSuccess:function(e){o.queriedObjects=e,a()},onError:function(e){error={message:"Error while querying for data",cause:e},i.onError(error,i)}});query(r)}var o={};function s(e){i.onError(e,i)}function a(){if(o.error)s(o.error);else if(o.schema){if(i.whereClauses){if(!o.queriedObjects)return;if(o.queriedObjects.length<1)return void s({message:"Data can not be edited by current user."});if(o.queriedObjects.length>1)return void s({message:"Multiple records were returned. Can not proceed with editing."});o.queryData=o.queriedObjects[0]}else o.queryData=i.data;var n=$(t.get(0));n.empty();var r=$('<div class="dbweb-form"></div>');n.append(r);var a=$("<form></form>");r.append(a);var l=$("<ul></ul>");a.append(l),o.form={};for(var p=o.schema.columns,f=0;f<p.length;++f){var m=p[f],v=m.column;if(m.write)if(i.fieldOpts[v]){var g=i.fieldOpts[v],y=g.hide;"function"==typeof y&&(y=y()),y||(g.choices?u(a,l,v,g):g.select?h(a,l,v,g):"DATE"==m.type?d(a,l,v,g):c(a,l,v,g))}else"DATE"==m.type?d(a,l,v,{}):c(a,l,v,{})}var _={};if(i.whereClauses?_.Save=function(t){!function(t,n){var r=$.extend({},defaultOptions,e,n),o=!1;for(var s in r.setters={},t){var a=t[s],l=a.val(),c=a.attr("_initialValue");l!=c&&(r.setters[s]=l,o=!0)}o?update(r):i.onAlert("Data left unchanged. No updating required.")}(o.form,t)}:_.Save=function(t){!function(t,i){var n=$.extend({},defaultOptions,e,i);for(var r in n.setters={},t){var o=t[r],s=o.val();n.setters[r]=s}insert(n)}(o.form,t)},o.schema.isDeleteAllowed&&i.whereClauses&&(_.Delete=function(t){!function(t,i){var n=$.extend({},defaultOptions,e,i);remove(n)}(o.form,t)}),i.installButtons)i.installButtons(_);else{var S,b=$('<div class="dbweb-buttons"></div>');if(r.append(b),_.Save)(S=$('<input type="button" value="'+(i.whereClauses?"Update":"Insert")+'"/>')).click(function(e){return _.Save(),!1}),b.append(S);if(_.Delete)(S=$('<input type="button" value="Delete"/>')).click(function(e){return _.Delete(),!1}),b.append(S)}}}function l(e){return"function"==typeof e.defaultValue?e.defaultValue():e.defaultValue}function c(e,t,i,n){var r="",s="";void 0!==o.queryData[i]?s=' value="'+(r=o.queryData[i])+'"':void 0!==n.defaultValue&&(s=' value="'+(r=l(n))+'"');var a=$("<li></li>");p(a,i);var c=$('<input class="dbWebFormInput" type="text" name="'+i+'"'+s+"/>");a.append(c),f(i,c,r),t.append(a)}function d(e,t,i,n){var r="",s="";isDefined(o.queryData[i])&&isDefined(o.queryData[i].formatted)?s=' value="'+(r=o.queryData[i].formatted)+'"':isDefined(n.defaultValue)&&(s=' value="'+(r=l(n))+'"');var a=$("<li></li>");p(a,i);var c=$('<input class="dbWebFormInput" type="text" name="'+i+'"'+s+"/>");c.datepicker({dateFormat:"yy-mm-dd",gotoCurrent:!0,changeYear:!0}),a.append(c),f(i,c,r),t.append(a)}function u(e,t,i,n){var r="";void 0!==o.queryData[i]?r=o.queryData[i]:void 0!==n.defaultValue&&(r=l(n));var s=$("<li></li>");p(s,i);for(var a=$('<select class="dbWebFormSelect"></select>'),c=0;c<n.choices.length;++c){var d=n.choices[c],u=[];u.push('<option value="'+d.value),r==d.value&&u.push('" selected="true'),u.push('">'),d.label?u.push(d.label):u.push(d.value),u.push("</option>"),a.append($(u.join("")))}s.append(a),f(i,a,r),t.append(s)}function h(e,t,i,n){var r="",s="";void 0!==o.queryData[i]?s=' value="'+(r=o.queryData[i])+'"':void 0!==n.defaultValue&&(s=' value="'+(r=l(n))+'"');var a=$("<li></li>");p(a,i);var c=$('<input class="dbWebFormInput" type="text" name="'+i+'"'+s+"/>");a.append(c);var d=$('<input class="dbWebFormSelectButton" type="button" value="..."/>');function u(e){c.val(e)}d.click(function(e){return n.select(u),!1}),a.append(d),f(i,c,r),t.append(a)}function p(e,t){var i=$("<label>"+t+":</label>");e.append(i)}function f(e,t,i){t.attr("_initialValue",i),o.form[e]=t}return{updateData:function(e,t){o&&o.form&&o.form[e]&&o.form[e].val(t)}}}}(jQuery),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.mapAndControls",r=t.Class({sourceModelId:null,dispatchService:null,mapControl:null,initialize:function(e){var i=t.extend({dispatchService:null,sourceModelId:null},e),r=this;if(this.sourceModelId=i.sourceModelId,this.dispatchService=i.dispatchService,this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};if(this.dispatchService.register(n,"modelStateUpdated",o),this.dispatchService.register(n,"reportModuleDisplay",o),this.dispatchService.register(n,"mapInitialized",o),this.dispatchService.register(n,"start",o),this.sourceModelId){var s={type:"modelGetState",modelId:this.sourceModelId};this.dispatchService.synchronousCall(n,s),s.state&&this._sourceModelUpdated(s.state)}}},_handle:function(e,t,i){"modelStateUpdated"===e.type?this.sourceModelId===e.modelId&&(this._sourceModelUpdated(e.state),this._updateMap()):"reportModuleDisplay"===e.type?e.moduleDisplay&&e.moduleDisplay.mapControl&&!this.mapControl&&(this.mapControl=e.moduleDisplay.mapControl,this._updateMap()):"mapInitialized"===e.type?e.mapControl&&!this.mapControl&&(this.mapControl=e.mapControl,this._updateMap()):"start"===e.type&&this._updateMap()},_sourceModelUpdated:function(e){throw"Subclasses must implement _sourceModelUpdated()"},_getVisibleDocumentIds:function(){throw new Error("Subclasses must implement _getVisibleDocumentIds()")},_updateMap:function(){var e=this._getMapControl();if(e&&e.infoLayers)for(var t=this._getVisibleDocumentIds(),i=0;i<e.infoLayers.length;++i){var n=e.infoLayers[i];n&&n.featureStrategy&&n.featureStrategy.setWhiteListDocumentIds(t)}},_getMapControl:function(){return this.mapControl}}),o=t.Class(r,{docStateById:null,initialize:function(e){t.extend({dispatchService:null,sourceModelId:null},e);this.docStateById={},r.prototype.initialize.apply(this,arguments),t.log("timeTransformToMapAndControlBridge",this)},_sourceModelUpdated:function(e){var t=this;if(e){if(e.added&&e.added.length)for(var i=0,n=e.added.length;i<n;++i){o(e.added[i])}if(e.updated&&e.updated.length)for(i=0,n=e.updated.length;i<n;++i){o(e.updated[i])}if(e.removed&&e.removed.length)for(i=0,n=e.removed.length;i<n;++i){var r=e.removed[i]._id;this.docStateById[r]&&delete this.docStateById[r]}}function o(e){var i=e._id;e._n2TimeTransform?(t.docStateById[i]||(t.docStateById[i]={}),e._n2TimeTransform.intervalSize<=0?t.docStateById[i].visible=!0:t.docStateById[i].visible=e._n2TimeTransform.intersects):t.docStateById[i]&&delete t.docStateById[i]}},_getVisibleDocumentIds:function(){var e=[];for(var t in this.docStateById)this.docStateById[t].visible&&e.push(t);return e}}),s=t.Class(r,{docStateById:null,initialize:function(e){t.extend({dispatchService:null,sourceModelId:null},e);this.docStateById={},r.prototype.initialize.apply(this,arguments),t.log("modelToMapAndControlBridge",this)},_sourceModelUpdated:function(e){if(e){if(e.added&&e.added.length)for(var t=0,i=e.added.length;t<i;++t){var n=e.added[t]._id;this.docStateById[n]=!0}if(e.updated&&e.updated.length)for(t=0,i=e.updated.length;t<i;++t){n=e.updated[t]._id;this.docStateById[n]=!0}if(e.removed&&e.removed.length)for(t=0,i=e.removed.length;t<i;++t){n=e.removed[t]._id;this.docStateById[n]&&delete this.docStateById[n]}}},_getVisibleDocumentIds:function(){var e=[];for(var t in this.docStateById)e.push(t);return e}});var a=t.Class({geoNamesService:null,inputId:null,initialize:function(e){this.geoNamesService=e},initiateCapture:function(n){var r=this,o=t.getUniqueId(),s=e("<div></div>").attr("id",o).addClass("n2MapAndControls_gazette_dialog");this.inputId=t.getUniqueId(),e('<div><input id="'+this.inputId+'" type="text"/></div>').appendTo(s),e('<div class="n2MapAndControls_gazette_results"></div>').appendTo(s);var a={autoOpen:!0,modal:!0,title:i("Create feature from name"),width:"auto",close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};s.dialog(a);var l=e("#"+this.inputId);this.geoNamesService.installAutoComplete({input:l});var c={mapControl:n,dialogId:o,val:null,location:null};l.keydown(function(t){var i=t.which,n=e("#"+r.inputId);if(13===i){var o=n.val();n.autocomplete&&(n.autocomplete("close"),n.autocomplete("option","disabled",!0)),c.name=o,r._searchForName(c)}else n.autocomplete&&n.autocomplete("option","disabled",!1);return!0}),this._findCurrentLocation(c)},_searchForName:function(i){var n=this,r=null;i.location&&i.location.countryCode&&(r=i.location.countryCode),e("#"+i.dialogId).find(".n2MapAndControls_gazette_results").empty(),this.geoNamesService.getName({name:i.name,featureClass:t.GeoNames.FeatureClass.PLACES,maxRows:25,countryBias:r,onSuccess:function(t){for(var r=e("#"+i.dialogId).find(".n2MapAndControls_gazette_results").empty(),o=0,s=t.length;o<s;++o){var a=t[o];if(a.geonameId){var l=e("<div></div>").addClass("n2MapAndControls_gazette_result").appendTo(r),c=a.name;if(a.adminName1&&(c+=", "+a.adminName1),a.countryName&&(c+=", "+a.countryName),e("<div></div>").addClass("n2MapAndControls_gazette_result_name").text(c).appendTo(l),n._installOnClick(i,l,a),a.lng&&a.lat){var d=a.lng+","+a.lat;e("<div></div>").addClass("n2MapAndControls_gazette_result_location").text(d).appendTo(l)}}}}})},_installOnClick:function(e,t,i){var n=this;t.click(function(){n._selectEntry(e,i)})},_selectEntry:function(t,i){e("#"+t.dialogId).dialog("close");var n=t.mapControl.editLayer,r=t.mapControl.map,o=new OpenLayers.Geometry.Point(1*i.lng,1*i.lat),s=r.getProjectionObject(),a=new OpenLayers.Projection("EPSG:4326");a.getCode()!=s.getCode()&&o.transform(a,s);var l=new OpenLayers.LonLat(o.x,o.y);r.setCenter(l);var c=new OpenLayers.Feature.Vector(o);for(var d in c.data.nunaliit_gazetteer={},i){var u=i[d];c.data.nunaliit_gazetteer[d]=u}n.addFeatures([c])},_findCurrentLocation:function(e){var t=e.mapControl.map,i=t.getCenter();if(i){var n=t.getProjectionObject(),r=new OpenLayers.Projection("EPSG:4326");r.getCode()!=n.getCode()&&i.transform(n,r),this.geoNamesService.findNearby({lng:i.lon,lat:i.lat,maxRows:1,onSuccess:function(t){if(t&&t.length){var i=t[0];e.location=i}},onError:function(e){}})}}});function l(e,i){if(e&&e.n2ConvertedBbox)return e.n2ConvertedBbox;var n=void 0;if(e.data&&e.data.nunaliit_geom&&e.data.nunaliit_geom.bbox&&e.n2GeomProj&&i){var r=e.data.nunaliit_geom.bbox;t.isArray(r)&&r.length>=4&&(n=new OpenLayers.Bounds(r[0],r[1],r[2],r[3]),i.getCode()!==e.n2GeomProj.getCode&&n.transform(e.n2GeomProj,i),e.n2ConvertedBbox=n)}return n}var c=t.Class({customService:null,id:null,type:null,options:null,sourceSrsName:null,sourceProjection:null,featurePrefix:null,featureType:null,featureNS:null,name:null,filter:null,featurePopupHtmlFn:null,featurePopupDelay:null,visibility:null,styleMapFn:null,styleMap:null,selectListener:null,clusterClickCallback:null,clustering:null,useHoverSound:null,initialize:function(e){var n,r=t.extend({customService:null,type:null,options:null,id:null,sourceSrsName:"EPSG:4326",featurePrefix:null,featureType:null,featureNS:null,name:null,filter:null,featurePopupHtmlFn:null,featurePopupDelay:0,visibility:!0,styleMapFn:null,styleMap:null,selectListener:function(e,t){},clusterClickCallback:null,clustering:null,useHoverSound:!1},e);(this.id=r.id,this.type=r.type,this.options=r.options,this.customService=r.customService,this.sourceSrsName=r.sourceSrsName,this.featurePrefix=r.featurePrefix,this.featureType=r.featureType,this.featureNS=r.featureNS,this.name=r.name,this.filter=r.filter,this.featurePopupHtmlFn=r.featurePopupHtmlFn,this.featurePopupDelay=r.featurePopupDelay,this.visibility=r.visibility,this.styleMapFn=r.styleMapFn,this.styleMap=r.styleMap,this.selectListener=r.selectListener,this.clusterClickCallback=r.clusterClickCallback,this.clustering=r.clustering,this.useHoverSound=r.useHoverSound,this.sourceSrsName&&(this.sourceProjection=new OpenLayers.Projection(this.sourceSrsName)),this.name&&(this.name=i(this.name)),this.featurePopupHtmlFn)||this.customService&&"function"==typeof(n=this.customService.getOption("mapFeaturePopupCallback"))&&(this.featurePopupHtmlFn=n);(this.featurePopupHtmlFn||(this.featurePopupHtmlFn=t.mapAndControls.DefaultPopupHtmlFunction),this.clusterClickCallback)||this.customService&&"function"==typeof(n=this.customService.getOption("mapClusterClickCallback"))&&(this.clusterClickCallback=n);this.clusterClickCallback||(this.clusterClickCallback=t.mapAndControls.ZoomInClusterClickCallback)},forEachFeature:function(e){if("function"==typeof e&&this.olLayer&&this.olLayer.features)for(var t=0,i=this.olLayer.features.length;t<i;++t){var n=this.olLayer.features[t];if(n.cluster)for(var r=0,o=n.cluster;r<o;++r){var s=n.cluster[r];e.call(this,s,n)}else e.call(this,n)}},accumulateMapStylesInUse:function(e){if(this.olLayer&&this.olLayer.features)for(var t=0,i=this.olLayer.features.length;t<i;++t){var n=this.olLayer.features[t];if(n._n2Style&&"string"==typeof n._n2Style.id){var r=n._n2Style,o=e[r.id];o||(o={style:r},e[r.id]=o);var s=n.n2_geometry;s&&!o[s]&&(o[s]=n)}}}}),d=t.Class({options:null,dbSearchEngine:null,contributionDb:null,mapId:null,map:null,editLayer:null,html:null,lastMapXy:null,mapMouseMoveListeners:null,olkitDisplayOptions:null,pendingMarkInfo:null,currentPopup:null,dhtmlSoundDivId:null,initialZoomBounds:null,selectFeatureControl:null,hoverInfo:null,clickedInfo:null,focusInfo:null,findFeatureInfo:null,modes:null,currentMode:null,navigationControls:null,editControls:null,editFeatureControls:null,editModeAddFeatureEnabled:null,editModeAddFeatureCallback:null,convertToMultiGeometry:null,editFeatureInfo:void 0,cometEnabled:null,fidChannel:null,contributionChannel:null,defaultStyleMap:null,styleFilterIndex:null,styleFilters:null,mapLayers:null,vectorLayers:null,infoLayers:null,layers:null,mapBusyCount:null,busyMapControl:null,initialize:function(r){var o=this;if(this.mapId="map_"+t.getUniqueId(),"undefined"==typeof OpenLayers)return t.reportError("OpenLayers is required."),null;this.options=e.extend(!0,{},{mapCoordinateSpecifications:{srsName:"EPSG:4326",maxExtent:[-180,-85.05,180,85.05],restrictedExtent:null,initialBounds:[-180,-90,180,90],useForMapControls:!0},mapDisplay:{srsName:"EPSG:900913",background:null,maxResolution:156543.0339,units:"m"},addPointsOnly:!1,showSRSAttribution:!1,scaleLine:{visible:!1},enableWheelZoom:!1,placeDisplay:{attribDisplayType:"attributes",attribTableHeading:"Place Data:",attribTableDiv:"side_attrib",attribTableClassBase:"attrib",attribHtmlFn:null,contribTableDiv:"side_contrib",contribTableClassBase:"contrib",contribTableShowAuthor:!0,contribTableShowCreateTS:!0,contribEmbedAudioDirectly:!1,contribShowLastEditInfo:!0,contribMediaDisplayVideoHeight:240,contribMediaDisplayVideoWidth:320,contribAdditionalFields:[],contribIndexingType:"default",contribInsertedReloadAddContrib:!0,contribInsertedReloadDataFn:null,contributionOptions:{anonymousAllowed:!0}},saveFeature:{},canvasName:null,sidePanelName:"side",filterPanelName:null,toggleClick:!0,uniqueIdentifier:"place_id",layerSwitcher:{suppress:!1,initiallyOpened:!1},directory:null,mapIdentifier:"map",mapInteractionDivName:"map_interaction_div",keepPopUpsOpen:!1,keepPopUpsStatic:!1},r),this.dbSearchEngine=t.dbSearchEngine(r?r.dbSearchEngine:null),this.contributionDb=t.contributionDb(r?r.contributionDb:null),this.map=null,this.editLayer=null,this.html="",this.lastMapXy=null,this.mapMouseMoveListeners=[],this.olkitDisplayOptions={},this.pendingMarkInfo=null,this.mapBusyCount=0,this.dhtmlSoundDivId=t.getUniqueId(),this.editFeatureInfo={original:{}},this.selectFeatureControl=null,this.hoverInfo={feature:null,endFn:[]},this.clickedInfo={features:[],endFn:[],fids:{},selectedId:null},this.focusInfo={fids:{},features:[]},this.findFeatureInfo={fid:null,features:[]};var s=i("Add or Edit a Map Feature"),l=i("Cancel Feature Editing"),c=this._getCustomService();if(c){var d=c.getOption("mapLabelEditFeature",null);d&&(s=d);var u=c.getOption("mapLabelCancelEdit",null);u&&(l=u)}this.modes={NAVIGATE:{name:"NAVIGATE",buttonValue:s,onStartHover:function(e,t){o._hoverFeature(e,t),o._hoverFeaturePopup(e,t)},onStartClick:function(e,t){o.initAndDisplayClickedPlaceInfo(e)},onEndClick:function(e){},featureAdded:function(e){}},ADD_OR_SELECT_FEATURE:{name:"ADD_OR_SELECT",buttonValue:l,onStartHover:function(e,t){o._hoverFeature(e,t),o._hoverFeaturePopup(e,t)},onStartClick:function(e,t){var n=!0;t.cluster&&t.cluster.length>1&&(alert(i("This feature is a cluster and can not be edited directly. Please, zoom in to see features within cluster.")),n=!1),n&&o._dispatch({type:"editInitiate",doc:e.data})},onEndClick:function(e){},featureAdded:function(e){o.editFeatureInfo.original={},o.editFeatureInfo.fid=void 0,o.editFeatureInfo.suppressZoom=!0;var t=e.layer.map.getProjectionObject();o._dispatch({type:"editCreateFromGeometry",geometry:e.geometry.clone(),projection:t,_origin:o})}},ADD_GEOMETRY:{name:"ADD_GEOMETRY",buttonValue:l,onStartHover:function(e,t){o._hoverFeature(e,t),o._hoverFeaturePopup(e,t)},featureAdded:function(e){var t=null;e&&e.layer&&e.layer.map&&(t=e.layer.map.getProjectionObject()),o._dispatch({type:"mapGeometryAdded",geometry:e.geometry,projection:t})}},EDIT_FEATURE:{name:"EDIT_FEATURE",buttonValue:l,featureAdded:function(e){}}},this.currentMode=this.modes.NAVIGATE,this.cometEnabled=!0,this.fidChannel="/fid",this.contributionChannel="/contribution",this._registerDispatch("documentVersion"),this._registerDispatch("documentDeleted"),this._registerDispatch("cacheRetrieveDocument"),this._registerDispatch("documentContentCreated"),this._registerDispatch("documentContentUpdated"),this._registerDispatch("addLayerToMap"),this._registerDispatch("selected"),this._registerDispatch("selectedSupplement"),this._registerDispatch("unselected"),this._registerDispatch("focusOn"),this._registerDispatch("focusOff"),this._registerDispatch("focusOnSupplement"),this._registerDispatch("findIsAvailable"),this._registerDispatch("find"),this._registerDispatch("searchInitiate"),this._registerDispatch("editInitiate"),this._registerDispatch("editClosed"),this._registerDispatch("editGeometryModified"),this._registerDispatch("editReportOriginalDocument"),this._registerDispatch("mapRedrawLayer"),this._registerDispatch("mapSetInitialExtent"),this._registerDispatch("mapSetExtent"),this._registerDispatch("mapResetExtent"),this._registerDispatch("mapGetLayers"),this._registerDispatch("setMapLayerVisibility"),this._registerDispatch("mapSwitchToEditMode"),this._registerDispatch("simplifiedGeometryReport"),this._registerDispatch("canvasGetStylesInUse"),this.infoLayers=[],"object"!=typeof this.options.layerInfo||t.isArray(this.options.layerInfo)||(this.options.layerInfo=[this.options.layerInfo]),this.defaultStyleMap={normal:{fillColor:"#ffffff",fillOpacity:.4,strokeColor:"#ee9999",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",pointRadius:6,pointerEvents:"visiblePainted"},clicked:{fillColor:"#ffffff",fillOpacity:.1,strokeColor:"#ff2200",strokeOpacity:1,strokeWidth:3,strokeLinecap:"round",strokeDashstyle:"solid",pointRadius:8,pointerEvents:"visiblePainted"},hovered:{fillColor:"#0000ff",fillOpacity:.4,strokeColor:"#0000ff",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",pointRadius:6,pointerEvents:"visiblePainted",cursor:"pointer"},hoveredClicked:{fillColor:"#0000ff",fillOpacity:.4,strokeColor:"#ff2200",strokeOpacity:1,strokeWidth:3,strokeLinecap:"round",strokeDashstyle:"solid",pointRadius:8,pointerEvents:"visiblePainted",cursor:"pointer"},filteredOut:{display:"none"}},this.styleFilterIndex=0,this.styleFilters={},this.createMapInteractionSwitch();var h=this._getAuthService();h&&h.addListeners(function(e){o.loginStateChanged(e)}),this.editModeAddFeatureEnabled=!0,this.editModeAddFeatureCallback=function(e){if(o.editModeAddFeatureEnabled){var t=e.feature,i=o.currentMode;o.switchToEditFeatureMode(t.fid,t),i.featureAdded(t)}},this.convertToMultiGeometry=function(e){for(var t=0;t<e.features.length;++t)e.features[t].geometry.CLASS_NAME===OpenLayers.Geometry.Point.prototype.CLASS_NAME?e.features[t].geometry=new OpenLayers.Geometry.MultiPoint([e.features[t].geometry]):e.features[t].geometry.CLASS_NAME===OpenLayers.Geometry.LineString.prototype.CLASS_NAME?e.features[t].geometry=new OpenLayers.Geometry.MultiLineString([e.features[t].geometry]):e.features[t].geometry.CLASS_NAME===OpenLayers.Geometry.Polygon.prototype.CLASS_NAME&&(e.features[t].geometry=new OpenLayers.Geometry.MultiPolygon([e.features[t].geometry]))};var p=new OpenLayers.Projection(this.options.mapDisplay.srsName),f=new OpenLayers.Projection(this.options.mapCoordinateSpecifications.srsName);this.initialZoomBounds=new OpenLayers.Bounds(this.options.mapCoordinateSpecifications.initialBounds[0],this.options.mapCoordinateSpecifications.initialBounds[1],this.options.mapCoordinateSpecifications.initialBounds[2],this.options.mapCoordinateSpecifications.initialBounds[3]),f.getCode()!=p.getCode()&&this.initialZoomBounds.transform(f,p);var m=new OpenLayers.Bounds(this.options.mapCoordinateSpecifications.maxExtent[0],this.options.mapCoordinateSpecifications.maxExtent[1],this.options.mapCoordinateSpecifications.maxExtent[2],this.options.mapCoordinateSpecifications.maxExtent[3]);f.getCode()!=p.getCode()&&m.transform(f,p);var v=null;if(this.options.mapCoordinateSpecifications.restrictedExtent&&(v=new OpenLayers.Bounds(this.options.mapCoordinateSpecifications.restrictedExtent[0],this.options.mapCoordinateSpecifications.restrictedExtent[1],this.options.mapCoordinateSpecifications.restrictedExtent[2],this.options.mapCoordinateSpecifications.restrictedExtent[3]),f.getCode()!=p.getCode()&&v.transform(f,p)),this.map=new OpenLayers.N2Map(this.options.mapIdentifier,{projection:p,displayProjection:this.options.mapCoordinateSpecifications.useForMapControls?f:p,units:this.options.mapDisplay.units,maxResolution:this.options.mapDisplay.maxResolution,maxExtent:m,restrictedExtent:v,theme:null,zoomMethod:null}),this.options.scaleLine&&this.options.scaleLine.visible){var g=new OpenLayers.Control.ScaleLine({bottomOutUnits:this.options.scaleLine.bottomOutUnits,bottomInUnits:this.options.scaleLine.bottomInUnits,topOutUnits:this.options.scaleLine.topOutUnits,topInUnits:this.options.scaleLine.topInUnits,maxWidth:this.options.scaleLine.maxWidth,geodesic:this.options.scaleLine.geodesic});this.map.addControl(g)}if(this.options.enableWheelZoom);else for(var y=this.map.getControlsByClass("OpenLayers.Control.Navigation"),_=0,S=y.length;_<S;++_)y[_].disableZoomWheel();if(this.map.div){var b=e(this.map.div);b.find(".olControlZoomIn").attr("title",i("Zoom In")),b.find(".olControlZoomOut").attr("title",i("Zoom Out"))}this.map.zoomToMaxExtent=function(){this.zoomToExtent(this.initialZoomBounds)},this.busyMapControl=new OpenLayers.Control.N2LoadingPanel,this.mapLayers=[],this.vectorLayers=[],this.infoLayers=[],this.map.events.register("changebaselayer",null,function(e){var t=e.oldProjection,i=o.map.getProjectionObject();if(o.options.showSRSAttribution&&o._updateSRSAttribution(),i&&t&&i.getCode()!==t.getCode())for(var n=0,r=o.vectorLayers.length;n<r;++n){var s=o.vectorLayers[n],a=s.features;s.removeAllFeatures({silent:!0});for(var l=0,c=a.length;l<c;++l){var d=a[l];if(d.geometry.transform(t,i),d.cluster&&d.cluster.length)for(var u=0,h=d.cluster.length;u<h;++u){d.cluster[u].geometry.transform(t,i)}}s.addFeatures(a,{silent:!0})}}),this._genBackgroundMapLayers(this.options);var I=this._createEffectiveStyleMap(null);this.editLayer=new OpenLayers.Layer.Vector("Edit",{styleMap:I,displayInLayerSwitcher:!1,projection:new OpenLayers.Projection("EPSG:4326"),renderers:["SVG","VML"]}),this.mapLayers.push(this.editLayer),this.vectorLayers.push(this.editLayer);var C=this._createFeatureModifiedHandler(this.editLayer);if(this.editLayer.events.register("featuremodified",null,C),this.layers={},this.options.layerInfo)for(var D=0;D<this.options.layerInfo.length;++D){var w=this.options.layerInfo[D],E=this.createLayerFromOptions(w);E&&E.olLayer&&this.mapLayers.push(E.olLayer)}if(this.options.overlays)for(D=0;D<this.options.overlays.length;++D){var x=this.options.overlays[D],T=this._createOLLayerFromDefinition(x,!1);T&&this.mapLayers.push(T)}var k=!0;for(_=0,S=this.infoLayers.length;_<S;++_){1==this.infoLayers[_].olLayer.visibility&&(k=!1)}this.map.addLayers(this.mapLayers);var L=5,M=this.options.mapCoordinateSpecifications.useForMapControls?f:p;this.options.mapCoordinateSpecifications.mousePositionSrsName&&(M=new OpenLayers.Projection(this.options.mapCoordinateSpecifications.mousePositionSrsName)),"m"===M.proj.units&&(L=0),this.map.addControl(new OpenLayers.Control.MousePosition({displayProjection:M,numDigits:L}));var O=!0;if(this.options.layerSwitcher&&this.options.layerSwitcher.suppress&&(O=!1),O){var A=null;A=OpenLayers.Control.NunaliitLayerSwitcher?new OpenLayers.Control.NunaliitLayerSwitcher:new OpenLayers.Control.LayerSwitcher,this.map.addControl(A),A&&A.div&&A.div.setAttribute("title",i("Layer Selector")),this.options.layerSwitcher&&this.options.layerSwitcher.initiallyOpened?A.maximizeControl():k&&A.maximizeControl()}if(this.map.zoomToExtent(this.initialZoomBounds),this.navigationControls={},this.editControls={},this.editFeatureControls={},this._installFeatureSelector(),this.options.addPointsOnly)this.editControls.addPoints=new OpenLayers.Control.DrawFeature(this.editLayer,OpenLayers.Handler.Point),this.map.addControl(this.editControls.addPoints);else{if(this.editControls.toolbar=new OpenLayers.Control.EditingToolbar(this.editLayer,{autoActivate:!1}),OpenLayers.Control.NunaliitGazetteer&&this.options.directory&&this.options.directory.geoNamesService){var F=this.options.directory.geoNamesService,R=new a(F),N=new OpenLayers.Control.NunaliitGazetteer({activateListener:function(){R.initiateCapture(o)}});this.editControls.toolbar.addControls([N])}this.map.addControl(this.editControls.toolbar),this.editControls.toolbar.deactivate(),this.editControls.toolbar.defaultControl=this.editControls.toolbar.controls[0]}this.map.addControl(this.busyMapControl),this.map.events.register("mousemove",null,function(e){o._handleMapMousePosition(e)}),this.map.events.register("zoomend",null,function(e){o._refreshSimplifiedGeometries(),o._updatedStylesInUse()}),this.map.events.register("move",null,function(e){o._mapMoved()}),this.initCometChannels();var P=this._getDispatchService();P&&P.send(n,{type:"mapInitialized",mapControl:this})},getCanvasName:function(){if(this.options)return this.options.canvasName},getNamedLayerInfo:function(e){for(var t=0,i=this.infoLayers.length;t<i;++t){var n=this.infoLayers[t];if(n.name===e)return n;if(n.id===e)return n}return null},insertSound:function(t){var i=e("#"+this.dhtmlSoundDivId);if(i.length<1&&(i=e("<div></div>").attr("id",this.dhtmlSoundDivId).appendTo(e("body"))),t){var n=this.dbSearchEngine.getRelMediaPath(t);i.html('<embed src="'+n+'" hidden="true" autostart="true" loop="false"/>')}else i.empty()},initAndDisplayClickedPlaceInfo:function(e){var t=this._getDispatchService();t&&t.send(n,{type:"userSelect",docId:e.data._id,doc:e.data,feature:e})},forEachVectorLayer:function(e){if(this.infoLayers&&"function"==typeof e)for(var t=0,i=this.infoLayers.length;t<i;++t){var n=this.infoLayers[t],r=n.olLayer;e.call(this,n,r)}},_updateSRSAttribution:function(){var e=this,t=this.map.getProjectionObject(),i=t.projCode,n=t.proj.defData.replace(/ /g,","),r=new OpenLayers.Layer("SRS",{attribution:"SRS: <span title="+n+">"+i+"</span>",visibility:!0,displayInLayerSwitcher:!1}),o=this.map.getLayersByName("SRS");o.length>0&&o.forEach(function(t){e.map.removeLayer(t)}),this.map.addLayers([r])},_getMapFeaturesIncludingFid:function(e){var t={};return t[e]=!0,this._getMapFeaturesIncludingFidMap(t)},_getMapFeaturesIncludingFids:function(e){for(var t={},i=0,n=e.length;i<n;++i){t[e[i]]=!0}return this._getMapFeaturesIncludingFidMap(t)},_getMapFeaturesIncludingFidMap:function(e){for(var t=[],i=0;i<this.infoLayers.length;++i){var n=this.infoLayers[i],r=this._getLayerFeatureIncludingFidMap(n.olLayer,e);r&&t.push(r)}return t},_getLayerFeatureIncludingFid:function(e,t){var i={};return i[t]=!0,this._getLayerFeatureIncludingFidMap(e,i)},_getLayerFeatureIncludingFidMap:function(e,t){if(e&&e.features){var i,n=e.features;for(i=0;i<n.length;++i){var r=n[i];if(r.fid&&t[r.fid])return r;if(r.cluster)for(var o=0,s=r.cluster.length;o<s;++o){var a=r.cluster[o];if(a.fid&&t[a.fid])return r}}}return null},_getLayerFeaturesFromFilter:function(e,t){var i=[];if(e&&e.features)for(var n=e.features,r=0,o=n.length;r<o;++r){var s=n[r];t.matches(s)&&i.push(s)}return i},_reloadFeature:function(e,t){for(var i=[],n=0;n<this.infoLayers.length;++n){var r=this.infoLayers[n];this._getLayerFeaturesFromFilter(r.olLayer,e).length>0&&i.push(r)}if(0==i.length)for(n=0;n<this.infoLayers.length;++n){r=this.infoLayers[n];i.push(r)}for(n=0;n<i.length;++n){r=i[n];this._loadFeatureOnLayer(r,e,t)}},_loadFeatureOnLayer:function(e,i,n){var r=this,o=t.extend({onReloaded:function(e){}},n),s=e.protocol,a=i.getOpenLayerFilter();s.read({filter:a,callback:function(e,t){return function(i){i.code!==OpenLayers.Protocol.Response.SUCCESS&&alert("Error while obtaining a new feature.\nMap might not display up-to-date information.\nYou might need to refresh your page.");var n=[];if(i.features)for(var o=0;o<i.features.length;++o){var s=i.features[o];null!=e.olFilter&&0==e.olFilter.evaluate(s.attributes)&&(s=null),null!=s&&n.push(s)}if(n.length>0){var a=e.olLayer.projection,l=e.olLayer.map.getProjectionObject();if(0==l.equals(a))for(var o=0;o<n.length;++o){var c=n[o].geometry;null!=c&&c.transform(a,l)}}for(var d=[],u=[],o=0;o<n.length;++o){var h=n[o];d.push(h);var s=r._getLayerFeatureIncludingFid(e.olLayer,h.fid);if(s){if(s.cluster)for(var p=0,f=s.cluster.length;p<f;++p){var m=s.cluster[p];m.fid!==h.fid&&d.push(m)}u.push(s)}}u.length>0&&e.olLayer.destroyFeatures(u),r.currentMode===r.modes.ADD_OR_SELECT_FEATURE||r.currentMode===r.modes.ADD_GEOMETRY?(r.editModeAddFeatureEnabled=!1,e.olLayer.addFeatures(d),r.editModeAddFeatureEnabled=!0):e.olLayer.addFeatures(d);for(var o=0;o<n.length;++o){var h=n[o];t.onReloaded(h)}r._updatedStylesInUse()}}(e,o)})},_removeFeature:function(e){for(var t=0;t<this.vectorLayers.length;++t){var i=this.vectorLayers[t],n=this._getLayerFeatureIncludingFid(i,e);if(n)if(n.fid===e)i.destroyFeatures(n);else if(n.cluster){for(var r=null,o=0,s=n.cluster.length;o<s;++o){var a=n.cluster[o];a.fid!==e&&(r||(r=[]),r.push(a))}i.destroyFeatures(n),r&&i.addFeatures(r)}}},_centerMapOnFeature:function(e){var t=e.geometry.getBounds(),i=(t.left+t.right)/2,n=(t.bottom+t.top)/2;this._centerMapOnXY(i,n,null)},_centerMapOnXY:function(e,t,i){var n=new OpenLayers.LonLat(e,t),r=this.map.getProjectionObject();if(i&&i!=r.getCode()){var o=new OpenLayers.Projection(i);n.transform(o,r)}var s=this.map.getZoom();this.map.setCenter(n,s,!1,!1)},_installGeometryEditor:function(e){this._removeGeometryEditor();var t=new OpenLayers.Control.ModifyFeature(this.editLayer,{displayClass:"olControlMoveFeature",standalone:!0,clickout:!1});t.mode=OpenLayers.Control.ModifyFeature.RESHAPE,this.map.addControl(t),t.activate(),this.editFeatureControls.modifyFeatureGeometry=t,e&&t.selectFeature(e)},_updateGeometryEditor:function(e,t){var i=this.map.getProjectionObject();e&&t&&i.getCode()!=t.getCode()?(e=e.clone()).transform(t,i):e&&(e=e.clone());var n=this.editFeatureControls.modifyFeatureGeometry,r=n.feature;r?(n.unselectFeature(r),r.layer.eraseFeatures([r]),r.geometry=e,r.layer.drawFeature(r),n.selectFeature(r)):((r=new OpenLayers.Feature.Vector(e)).fid=this.editFeatureInfo.fid,this.editModeAddFeatureEnabled=!1,this.editLayer.addFeatures([r]),this.editModeAddFeatureEnabled=!0,n.selectFeature(r))},_removeGeometryEditor:function(){var e=void 0;return this.editFeatureControls.modifyFeatureGeometry&&((e=this.editFeatureControls.modifyFeatureGeometry.feature)&&this.editFeatureControls.modifyFeatureGeometry.unselectFeature(e),this.editFeatureControls.modifyFeatureGeometry.deactivate(),this.map.removeControl(this.editFeatureControls.modifyFeatureGeometry),this.editFeatureControls.modifyFeatureGeometry.destroy(),this.editFeatureControls.modifyFeatureGeometry=null,e&&e.layer&&e.layer.destroyFeatures([e])),e},convertBoundsToMapProjection:function(e,t){var i=new OpenLayers.Projection(this.options.mapDisplay.srsName),n=new OpenLayers.Projection(t);n.getCode()!=i.getCode()&&e.transform(n,i)},redrawMap:function(){for(var e=this.map.layers,t=0;t<e.length;++t)e[t].isBaseLayer||e[t].redraw();this._updatedStylesInUse()},_createOverlayFromDefinition:function(i,n){var r=this,o=this._getCustomService(),s=e.extend({styleMapFn:function(e){return r._createStyleMapFromLayerInfo(e)}},i);s.customService=o;var a=new c(s),l={name:a.name,projection:a.sourceProjection,visibility:a.visibility,_layerInfo:a};if("couchdb"===i.type){var d=t.extend({},i.options,{notifications:{readStart:function(){r._mapBusyStatus(1)},readEnd:function(){r._mapBusyStatus(-1)}}});a.protocol=new OpenLayers.Protocol.Couch(d),l.protocol=a.protocol,a.cachingAllowed=!0}else if("model"===i.type){var u=t.extend({},i.options);u.dispatchService=this._getDispatchService(),u.onUpdateCallback=function(e){r._modelLayerUpdated(l,e)},u.notifications={readStart:function(){r._mapBusyStatus(1)},readEnd:function(){r._mapBusyStatus(-1)}},a.protocol=new OpenLayers.Protocol.Model(u),l.protocol=a.protocol}else if("wfs"===i.type){var h={url:null,featurePrefix:null,featureType:null,featureNS:null,version:"1.1.0",geometryName:"the_geom"};if(i.options)for(var p in i.options)"url"!==p&&"featurePrefix"!==p&&"featureType"!==p&&"featureNS"!==p&&"version"!==p&&"geometryName"!==p||(h[p]=i.options[p]);h.readFormat=new OpenLayers.Format.GeoJSON,h.outputFormat="json",a.typename=a.featurePrefix+":"+a.featureType,a.schema=h.url+"?service=WFS&version="+h.version+"&request=DescribeFeatureType&typeName="+a.typename,a.protocol=new OpenLayers.Protocol.WFS(h),l.protocol=a.protocol}else t.reportError("Unrecognized type ("+a.type+") for layer: "+a.name);var f=this._createEffectiveStyleMap(a);if(l.styleMap=f,a.olFilter=null,a.filter&&(a.olFilter=t.olFilter.CreateOpenLayersFilter(a.filter),null==a.olFilter?alert("Encountered invalid filter"):l.filter=a.olFilter),a.useFixedStrategy){var m=new OpenLayers.Bounds(options.mapCoordinateSpecifications.maxExtent[0],options.mapCoordinateSpecifications.maxExtent[1],options.mapCoordinateSpecifications.maxExtent[2],options.mapCoordinateSpecifications.maxExtent[3]);userCoordProjection.getCode()!=a.sourceProjection.getCode()&&m.transform(userCoordProjection,a.sourceProjection);var v=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,property:a.geometryName,value:m});if(null==l.filter)l.filter=v;else{var g=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[l.filter,v]});l.filter=g}l.protocol&&(l.strategies=[new OpenLayers.Strategy.Fixed])}else l.protocol&&("couchdb"===i.type?l.strategies=[new OpenLayers.Strategy.N2BBOX]:"model"===i.type?l.strategies=[new OpenLayers.Strategy.Fixed]:l.strategies=[new OpenLayers.Strategy.BBOX]);if(l.strategies||(l.strategies=[]),a.featureStrategy=new OpenLayers.Strategy.NunaliitFeatureStrategy,l.strategies.push(a.featureStrategy),"number"==typeof i.minimumLinePixelSize||"number"==typeof i.minimumPolygonPixelSize){var y={};"number"==typeof i.minimumLinePixelSize&&(y.minimumLinePixelSize=i.minimumLinePixelSize),"number"==typeof i.minimumPolygonPixelSize&&(y.minimumPolygonPixelSize=i.minimumPolygonPixelSize),a.featureStrategy.setMinimumSize(y)}if(a.clustering){var _={};for(var S in"number"==typeof i.minimumLinePixelSize&&(_.minimumLinePixelSize=i.minimumLinePixelSize),"number"==typeof i.minimumPolygonPixelSize&&(_.minimumPolygonPixelSize=i.minimumPolygonPixelSize),a.clustering){var b=a.clustering[S];"distance"!==S&&"threshold"!==S&&"disableDynamicClustering"!==S&&"minimumPolygonPixelSize"!==S&&"minimumLinePixelSize"!==S&&"clusterPointsOnly"!==S||(_[S]=b)}a.featureStrategy.setClustering(_)}return l.renderers=["SVG","VML"],a.olLayer=new OpenLayers.Layer.Vector(a.name,l),this._registerLayerForEvents(a),this.infoLayers.push(a),this.vectorLayers.push(a.olLayer),a.id?this.layers[a.id]=a.olLayer:this.layers[a.name]=a.olLayer,a.olLayer},_createOLLayerFromDefinition:function(e,n){var r=i(e.name);if("Bing"==e.type){if((g=e.options)&&g.key){var o=t.extend({name:r},g);return v=new OpenLayers.Layer.Bing(o)}return t.reportError("Bad configuration for layer: "+r),null}if("Google Maps"==e.type){if((g=e.options)&&"string"==typeof g.type){var s=null;if("undefined"!=typeof google&&google.maps&&google.maps.MapTypeId&&(s=google.maps.MapTypeId[g.type]),!s)return t.reportError("Attempting to load a Google Map background. A map API key must be configured"),t.logError("Unable to load Google Map type: "+g.type),null;g.type=s}return g&&g.type?v=new OpenLayers.Layer.Google(r,g):(t.reportError("Bad configuration for layer: "+r),null)}if("couchdb"===e.type||"model"===e.type||"wfs"===e.type){if(!n)return this._createOverlayFromDefinition(e,n);t.reportError("Layer type not suitable for background: "+e.type)}else{if("wms"===e.type){if(g=e.options){var a=null,l={},c={isBaseLayer:n};for(var d in"boolean"==typeof e.visibility&&(c.visibility=e.visibility),t.isDefined(e.gutter)&&(c.gutter=e.gutter),t.isDefined(e.displayInLayerSwitcher)&&(c.displayInLayerSwitcher=e.displayInLayerSwitcher),g)if("url"===d)a=g[d];else if("srsName"===d){var u=new OpenLayers.Projection(g[d]);c.projection=u}else"opacity"===d||"scales"===d||"resolutions"===d||"maxScale"===d||"minScale"===d||"maxResolution"===d||"minResolution"===d||"numZoomLevels"===d||"maxZoomLevel"===d?c[d]=g[d]:l[d]=g[d];return v=new OpenLayers.Layer.WMS(r,a,l,c)}return t.reportError("Bad configuration for layer: "+r),null}if("osm"===e.type){var h=null;c={isBaseLayer:n};if("boolean"==typeof e.visibility&&(c.visibility=e.visibility),g=e.options)for(var p in g){var f=g[p];"url"===p?h=f:c[p]=f}return v=new OpenLayers.Layer.OSM(r,h,c)}if("stamen"===e.type){var m=null;c={isBaseLayer:n};if("boolean"==typeof e.visibility&&(c.visibility=e.visibility),g=e.options)for(var p in g){f=g[p];"layerName"===p?m=f:c[p]=f}if(OpenLayers.Layer.Stamen){if(m){var v=new OpenLayers.Layer.Stamen(m,c);return r&&(v.name=r),v}t.reportError("Option layerName must be specified for a Stamen background.")}else t.log("Stamen layer can not be added since Javascript library is not included")}else if("image"===e.type){h=null;var g,y=null,_=null,S=null;c={isBaseLayer:n};if("boolean"==typeof e.visibility&&(c.visibility=e.visibility),g=e.options)for(var p in g){f=g[p];"url"===p?h=f:"height"===p?y=1*f:"width"===p?_=1*f:"extent"===p?S=f:c[p]=f}if(OpenLayers.Layer.Image){var b=null;if(S&&t.isArray(S)&&4==S.length&&(b=new OpenLayers.Bounds(S[0],S[1],S[2],S[3])),h)if(y)if(_){if(b){var I=new OpenLayers.Size(_,y);return v=new OpenLayers.Layer.Image(r,h,b,I,c)}t.reportError("Option extent must be specified as an array of four numbers for an Image background.")}else t.reportError("Option width must be specified for an Image background.");else t.reportError("Option height must be specified for an Image background.");else t.reportError("Option url must be specified for an Image background.")}else t.log("Image layer can not be added since OpenLayers does not support this type of background")}else t.reportError("Unknown layer type: "+e.type)}return null},_registerLayerForEvents:function(e){var t=this;e.olLayer.events.register("visibilitychanged",null,function(t){var i=t.object.visibility;e.selectListener(i,e)}),e.olLayer.events.register("beforefeaturesadded",null,function(e){var i=e.features;if(i)for(var n=0,r=i.length;n<r;++n){var o=i[n];if(t.clickedInfo.fids[o.fid]){var s=t.clickedInfo.fids[o.fid];t.clickedInfo.features.push(o),s.clicked&&(o.isClicked=!0),s.intent&&(o.n2SelectIntent=s.intent)}if(t.focusInfo.fids[o.fid]&&(t.focusInfo.features.push(o),o.isHovered=!0),t.findFeatureInfo.fid===o.fid&&(t.findFeatureInfo.features.push(o),o.n2Intent="find"),o.cluster)for(var a=0,l=o.cluster.length;a<l;++a){var c=o.cluster[a];if(t.clickedInfo.fids[c.fid]){s=t.clickedInfo.fids[c.fid];t.clickedInfo.features.push(o),s.clicked&&(o.isClicked=!0),s.intent&&(o.n2SelectIntent=s.intent)}t.focusInfo.fids[c.fid]&&(t.focusInfo.features.push(o),o.isHovered=!0),t.findFeatureInfo.fid===c.fid&&(t.findFeatureInfo.features.push(o),o.n2Intent="find")}}return!0}),e.olLayer.events.register("featuresadded",null,function(e){var i=null,n=null;e&&e.features&&e.features.length&&e.features[0]&&e.features[0].layer&&(i=e.features[0].layer),i&&(n=i._layerInfo),n&&t._clearValueCache(n),t._refreshSimplifiedGeometries(),t._updatedStylesInUse()}),e.olLayer.events.register("featuresremoved",null,function(e){var i=null,n=null;e&&e.features&&e.features.length&&e.features[0]&&e.features[0].layer&&(i=e.features[0].layer),i&&(n=i._layerInfo),n&&t._clearValueCache(n),t._updatedStylesInUse()})},_createFeatureModifiedHandler:function(e){var t=this;return function(i){var n=i.feature;t._dispatch({type:"editGeometryModified",docId:n.fid,geom:n.geometry,proj:e.map.getProjectionObject(),_origin:t})}},_genBackgroundMapLayers:function(e){var i=null;if(e&&e.mapDisplay&&e.mapDisplay.backgrounds)for(var n=0,r=e.mapDisplay.backgrounds.length;n<r;++n){var o=e.mapDisplay.backgrounds[n];(l=this._createOLLayerFromDefinition(o,!0))&&!i&&(i=[]),l&&(i[i.length]=l)}else if(e&&e.mapDisplay&&e.mapDisplay.background){var s=e.mapDisplay.background;if("function"==typeof s.callback)i=s.callback(s);else if("Bing"==s.type)if(s.key&&OpenLayers&&OpenLayers.Layer&&OpenLayers.Layer.Bing)if(s.layers&&t.isArray(s.layers)){i=[];for(n=0,r=s.layers.length;n<r;++n){var a=t.extend({key:s.key},s.layers[n]),l=new OpenLayers.Layer.Bing(a);i.push(l)}}else(i=[]).push(new OpenLayers.Layer.Bing({name:"Satellite",type:"Aerial",key:s.key})),i.push(new OpenLayers.Layer.Bing({name:"Road",type:"Road",key:s.key})),i.push(new OpenLayers.Layer.Bing({name:"Hybrid",type:"AerialWithLabels",key:s.key}));else t.reportError("Bad configuration for background type: "+s.type);else if("Google Maps"==s.type)if(OpenLayers&&OpenLayers.Layer&&OpenLayers.Layer.Google)if(this._checkGoogleMapAPI(),s.layers&&t.isArray(s.layers)){i=[];for(n=0,r=s.layers.length;n<r;++n){a=s.layers[n],l=new OpenLayers.Layer.Google(a.name,a);i.push(l)}}else i=d();else t.reportError("Bad configuration for background type: "+s.type);else t.reportError("Unknown background type: "+s.type)}else i=d();if(i)for(n=0,r=i.length;n<r;++n){var c=i[n];this.mapLayers.push(c)}return i;function d(){var e=null;return"function"==typeof GMap2?((e=[]).push(new OpenLayers.Layer.Google("Google Satellite",{type:G_SATELLITE_MAP,sphericalMercator:!0})),e.push(new OpenLayers.Layer.Google("Google Physical",{type:G_PHYSICAL_MAP,sphericalMercator:!0})),e.push(new OpenLayers.Layer.Google("Google Hybrid",{type:G_HYBRID_MAP,sphericalMercator:!0}))):"undefined"!=typeof google&&google.maps&&google.maps.MapTypeId&&(google.maps.Map&&(google.maps.Map.disableDefaultUI=!0),(e=[]).push(new OpenLayers.Layer.Google("Google Satellite",{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:20})),e.push(new OpenLayers.Layer.Google("Google Physical",{type:google.maps.MapTypeId.TERRAIN,numZoomLevels:20})),e.push(new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,numZoomLevels:20}))),e}},_checkGoogleMapAPI:function(){var e=!1;"object"==typeof window&&window.google&&window.google.maps&&(e=!0),e||t.logError("Google Map API is not loaded. Please, configure a Google Map API key")},getBaseLayers:function(){var e=[];if(this.map&&this.map.layers)for(var t=0,i=this.map.layers.length;t<i;++t){var n=this.map.layers[t];if(n.isBaseLayer){var r={id:n.id,projection:n.projection};e.push(r)}}return e},setBaseLayer:function(e){var t=null;if(this.map&&this.map.layers)for(var i=0,n=this.map.layers.length;i<n;++i){var r=this.map.layers[i];if(r.isBaseLayer&&r.id===e){t=r;break}}t&&this.map.setBaseLayer(t)},_startClicked:function(e,t){var i=e;i&&i.cluster&&1==i.cluster.length&&(i=i.cluster[0]);var n=!1;(t||(n=i&&i.fid&&this.clickedInfo.selectedId===i.fid),t||this.options.toggleClick||!n)&&(i.cluster?i.layer._layerInfo.clusterClickCallback(i,this):(this._endClicked(),!t&&this.options.toggleClick&&n?this._dispatch({type:"userUnselect",docId:i.fid}):i.fid&&(this.clickedInfo.features=[i],this.clickedInfo.fids={},this.clickedInfo.fids[i.fid]={clicked:!0},this.clickedInfo.selectedId=i.fid,i.isClicked=!0,i.layer&&i.layer.drawFeature(i),this.currentMode.onStartClick&&this.currentMode.onStartClick(i,e))))},_endClicked:function(){if(this._endFindFeature(),this.clickedInfo.features)for(var e=0,t=this.clickedInfo.features.length;e<t;++e){var i=this.clickedInfo.features[e];i.isClicked&&(i.isClicked=!1,i.n2SelectIntent=null,i.layer&&i.layer.drawFeature(i),this.currentMode.onEndClick&&this.currentMode.onEndClick(i))}if(this.clickedInfo.endFn)for(e=0,t=this.clickedInfo.endFn.length;e<t;++e)this.clickedInfo.endFn[e]();this.clickedInfo.endFn=[],this.clickedInfo.features=[],this.clickedInfo.fids={},this.clickedInfo.selectedId=null},_selectedFeatures:function(e,t){if(this.currentMode!==this.modes.NAVIGATE&&this._switchMapMode(this.modes.NAVIGATE),this._endClicked(),this.clickedInfo.fids={},t)for(var i=0,n=t.length;i<n;++i){var r=t[i];this.clickedInfo.fids[r]={clicked:!0},this.clickedInfo.selectedId||(this.clickedInfo.selectedId=r)}if(e)for(i=0,n=e.length;i<n;++i){var o=e[i];this.clickedInfo.features.push(o),o.isClicked=!0,o.layer&&o.layer.drawFeature(o)}},_selectedFeaturesSupplement:function(e){if(this.currentMode!==this.modes.NAVIGATE&&this._switchMapMode(this.modes.NAVIGATE),e.fid&&(this.clickedInfo.fids[e.fid]={clicked:!0},e.intent&&(this.clickedInfo.fids[e.fid].intent=e.intent)),e.features)for(var t=0,i=e.features.length;t<i;++t){var n=e.features[t];this.clickedInfo.features.push(n),n.isClicked=!0,e.intent&&(n.n2SelectIntent=e.intent),n.layer&&n.layer.drawFeature(n)}},_unselectFeature:function(){this.clickedInfo.selectedId&&this._dispatch({type:"userUnselect",docId:this.clickedInfo.selectedId}),this._endClicked()},_startHover:function(e){var t=e.layer;e&&e.cluster&&1==e.cluster.length&&(e=e.cluster[0]),this.hoverInfo.feature!==e&&(this._endHover(),this.hoverInfo.feature=e,this.currentMode.onStartHover&&this.currentMode.onStartHover(e,t))},_endHover:function(){for(var e=0,t=this.hoverInfo.endFn.length;e<t;++e)this.hoverInfo.endFn[e]();this.hoverInfo.feature=null,this.hoverInfo.endFn=[]},_registerEndHoverFn:function(e){this.hoverInfo.endFn.push(e)},_startFocus:function(e){this._endFocus(),this.focusInfo.origin={};for(var t=0,i=e.length;t<i;++t){var n=e[t];this.focusInfo.origin[n]=!0}this._addFocus({fids:e})},_addFocus:function(e){var i=t.extend({fids:null,intent:null},e);if(i.fids)for(var n=0,r=i.fids.length;n<r;++n){var o=i.fids[n];this.focusInfo.fids[o]=!0}var s=this._getMapFeaturesIncludingFidMap(this.focusInfo.fids);for(n=0,r=s.length;n<r;++n){var a=s[n];a&&!a.isHovered&&(a.isHovered=!0,i.intent&&(a.n2HoverIntent=i.intent),a.layer&&a.layer.drawFeature(a),this.focusInfo.features.push(a))}},_endFocus:function(){for(var e=0,t=this.focusInfo.features.length;e<t;++e){var i=this.focusInfo.features[e];i.isHovered&&(i.isHovered=!1,i.n2HoverIntent=null,i.layer&&i.layer.drawFeature(i))}this.focusInfo.features=[],this.focusInfo.fids={},this.focusInfo.origin=null},_startFindFeature:function(e,t){if(this._endFindFeature(),this.findFeatureInfo.fid=e,this.findFeatureInfo.features=t,t)for(var i=0,n=t.length;i<n;++i){var r=t[i];r&&(r.n2Intent="find",r.layer&&r.layer.drawFeature(r))}},_endFindFeature:function(){for(var e=0,t=this.findFeatureInfo.features.length;e<t;++e){var i=this.findFeatureInfo.features[e];i&&(i.n2Intent=null,i.layer&&i.layer.drawFeature(i))}this.findFeatureInfo.fid=null,this.findFeatureInfo.features=[]},activateSelectFeatureControl:function(){this.selectFeatureControl&&this.selectFeatureControl.activate()},deactivateSelectFeatureControl:function(){this.selectFeatureControl&&(this.selectFeatureControl.unselectAll(),this.selectFeatureControl.deactivate()),this._endHover(),this._endClicked()},_hoverFeature:function(e,t){if(e&&(t&&t._layerInfo)){var i=this._getDispatchService(),r=[],o=[];if(e.cluster)for(var s=0,a=e.cluster.length;s<a;++s){var l=e.cluster[s];r.push(l.fid),o.push(l.data)}else r.push(e.fid),o.push(e.data);this._registerEndHoverFn(function(){i.send(n,{type:"userFocusOff",docIds:r,docs:o,feature:e})}),r.length>1?i.send(n,{type:"userFocusOn",docIds:r,docs:o,feature:e}):r.length>0&&i.send(n,{type:"userFocusOn",docId:r[0],doc:o[0],feature:e})}},_hoverFeaturePopup:function(e,t){var i=this;if(null!=e&&null!=t){var n=t._layerInfo;if(null!=n){var r=n.featurePopupHtmlFn;if(null!=r){var o=0;"number"==typeof n.featurePopupDelay&&(o=Math.floor(n.featurePopupDelay)),o>0?window.setTimeout(function(){s()&&a()},o):a()}}}function s(){var t=null;return i.hoverInfo.feature&&(t=i.hoverInfo.feature.fid),t===e.fid}function a(){var t=!0;r({feature:e,layerInfo:n,onSuccess:function(e){t=!1,l(e)},onError:function(){}}),t&&l('<div class="olkit_wait"></div>')}function l(t){if(s()&&(c(),null!==t&&""!==t)){var n=function(){var t=null,n=i.lastMapXy;if(null!=n){var r=i.map.getLonLatFromPixel(n);r&&(t=r)}return t||(t=e.geometry.getBounds().getCenterLonLat()),t}(),r=new OpenLayers.Popup.Anchored(null,n,null,t,{size:new OpenLayers.Size(10,10),offset:new OpenLayers.Pixel(-5,-5)},!1,d);r.autoSize=!0,r.panMapIfOutOfView=!0,r.setOpacity("80");var o=i.map.getSize();o&&(r.maxSize=new OpenLayers.Size(Math.floor(o.w/3),Math.floor(o.h/3))),i.currentPopup=r,i.map.addPopup(r),i.options&&i.options.keepPopUpsOpen||i._registerEndHoverFn(c),i.options&&i.options.keepPopUpsStatic||i.addMapMousePositionListener(function(e){return!(i.currentPopup!==r||!i.lastMapXy)&&(i.currentPopup.lonlat=i.map.getLonLatFromPixel(i.lastMapXy),i.currentPopup.updatePosition(),!0)})}}function c(){var e=i.map,t=i.currentPopup;t&&(e.removePopup(t),t.destroy(),i.currentPopup=null)}function d(e){}},loginStateChanged:function(e){var t=!1;null==e&&(t=!0),t?(this.hideMapInteractionSwitch(),this._switchMapMode(this.modes.NAVIGATE)):this.showMapInteractionSwitch()},createMapInteractionSwitch:function(){var t=this,i=e('<input type="button" class="n2map_map_interaction_switch"/>').val(this.modes.NAVIGATE.buttonValue).click(function(e){t._clickedMapInteractionSwitch(e)});e("#"+this.options.mapInteractionDivName).empty().append(i)},_getMapInteractionSwitch:function(){return e("#"+this.options.mapInteractionDivName).find(".n2map_map_interaction_switch")},_clickedMapInteractionSwitch:function(e){return this.currentMode===this.modes.NAVIGATE?this.switchToEditMode():this.currentMode===this.modes.ADD_OR_SELECT_FEATURE?this._switchMapMode(this.modes.NAVIGATE):this.currentMode===this.modes.ADD_GEOMETRY?this._cancelEditFeatureMode():this.currentMode===this.modes.EDIT_FEATURE&&this._cancelEditFeatureMode(),!1},hideMapInteractionSwitch:function(){this._getMapInteractionSwitch().hide()},showMapInteractionSwitch:function(){this._getMapInteractionSwitch().show()},activateControl:function(e){e&&e.activate()},deactivateControl:function(e){e&&e.deactivate()},_switchMapMode:function(t,r){if(this.currentMode!==t){if(this.currentMode===this.modes.ADD_OR_SELECT_FEATURE?(this.deactivateControl(this.editControls.addPoints),this.deactivateControl(this.editControls.toolbar),this.deactivateControl(this.editControls.modifyFeature),this.editLayer.events.unregister("featureadded",null,this.editModeAddFeatureCallback),this.editLayer.events.unregister("beforefeaturesadded",null,this.convertToMultiGeometry),this.deactivateSelectFeatureControl()):this.currentMode===this.modes.ADD_GEOMETRY?(this.deactivateControl(this.editControls.addPoints),this.deactivateControl(this.editControls.toolbar),this.deactivateControl(this.editControls.modifyFeature),this.editLayer.events.unregister("featureadded",null,this.editModeAddFeatureCallback),this.editLayer.events.unregister("beforefeaturesadded",null,this.convertToMultiGeometry),this.deactivateSelectFeatureControl()):this.currentMode===this.modes.EDIT_FEATURE?this._removeGeometryEditor():this.currentMode===this.modes.NAVIGATE&&this.deactivateSelectFeatureControl(),this.currentMode=t,this._getMapInteractionSwitch().val(t.buttonValue),this.currentMode===this.modes.ADD_OR_SELECT_FEATURE){if(this.editLayer.events.register("featureadded",null,this.editModeAddFeatureCallback),this.editLayer.events.register("beforefeaturesadded",null,this.convertToMultiGeometry),this.activateControl(this.editControls.addPoints),this.activateControl(this.editControls.toolbar),this.activateControl(this.editControls.modifyFeature),this.activateSelectFeatureControl(),this.editControls.toolbar&&this.editControls.toolbar.div)(o=e(this.editControls.toolbar.div)).find(".olControlNavigationItemActive").attr("title",i("Scroll Map")),o.find(".olControlDrawFeaturePointItemInactive").attr("title",i("Add a point to the map")),o.find(".olControlDrawFeaturePathItemInactive").attr("title",i("Add a line to the map")),o.find(".olControlDrawFeaturePolygonItemInactive").attr("title",i("Add a polygon to the map")),o.find(".olControlNunaliitGazetteerItemInactive").attr("title",i("Add a feature to the map based on a gazetteer service"))}else if(this.currentMode===this.modes.ADD_GEOMETRY){var o;if(this.editLayer.events.register("featureadded",null,this.editModeAddFeatureCallback),this.editLayer.events.register("beforefeaturesadded",null,this.convertToMultiGeometry),this.activateControl(this.editControls.addPoints),this.activateControl(this.editControls.toolbar),this.activateControl(this.editControls.modifyFeature),this.editControls.toolbar&&this.editControls.toolbar.div)(o=e(this.editControls.toolbar.div)).find(".olControlNavigationItemActive").attr("title",i("Scroll Map")),o.find(".olControlDrawFeaturePointItemInactive").attr("title",i("Add a point to the map")),o.find(".olControlDrawFeaturePathItemInactive").attr("title",i("Add a line to the map")),o.find(".olControlDrawFeaturePolygonItemInactive").attr("title",i("Add a polygon to the map")),o.find(".olControlNunaliitGazetteerItemInactive").attr("title",i("Add a feature to the map based on a gazetteer service"))}else if(this.currentMode===this.modes.EDIT_FEATURE){var s=r.feature;this._installGeometryEditor(s)}else this.currentMode===this.modes.NAVIGATE&&this.activateSelectFeatureControl();var a=this._getDispatchService();a&&a.send(n,{type:"mapReportMode",mapControl:this,mode:this.currentMode.name})}},switchToEditMode:function(){var e=this,t=this._getAuthService();if(t){var i=!0;t.isLoggedIn()&&(i=!1),i?t.showLoginForm({prompt:"<p>You must log in as a registered user to add a point to the map.</p>",anonymousLoginAllowed:!1,onSuccess:function(){e.switchToEditMode()}}):this._switchMapMode(this.modes.ADD_OR_SELECT_FEATURE)}else alert("Authentication module not installed.")},switchToEditFeatureMode:function(e,t){this._switchMapMode(this.modes.EDIT_FEATURE,{fid:e,feature:t})},switchToAddGeometryMode:function(e){this._switchMapMode(this.modes.ADD_GEOMETRY,{fid:e})},_cancelEditFeatureMode:function(){this._dispatch({type:"editCancel"})},_geometryModified:function(e,t,i){e&&e!==this.editFeatureInfo.fid||!e&&this.editFeatureInfo.fid||(this.currentMode!==this.modes.EDIT_FEATURE||t?this.currentMode===this.modes.EDIT_FEATURE&&t?this._updateGeometryEditor(t,i):this.currentMode!==this.modes.EDIT_FEATURE&&t&&(this.switchToEditFeatureMode(e),this._updateGeometryEditor(t,i)):this.switchToAddGeometryMode(e))},onAttributeFormClosed:function(e){e&&e.state===OpenLayers.State.INSERT&&this.editLayer.destroyFeatures(e),this._switchMapMode(this.modes.NAVIGATE)},onAttributeFormCancelled:function(e){this._switchMapMode(this.modes.NAVIGATE)},onAttributeFormInserted:function(e,t){t&&t.layer&&t.layer.destroyFeatures([t]),this.fidAdded(e)},onAttributeFormUpdated:function(e,i){e=i.fid;this.fidUpdated(e);var n=t.olFilter.fromFid(e);this._reloadFeature(n)},onAttributeFormDeleted:function(e,t){this.fidDeleted(e);var i=t.layer;i&&i.destroyFeatures([t])},selectAudioMedia:function(t,n){var r=this,o=null;t&&t.attributes&&t.attributes.place_id&&(o=t.attributes.place_id);var s=null;if(o){this.insertSound(),s=e('<div class="selectMedia" style="z-index:3005"></div>');var a=e("<h1>Select a hover audio file</h2>");s.append(a);var l=e("<div></div>");s.append(l);var c=e('<input type="button" value="Cancel"/>');c.click(function(){s.dialog("close")}),s.append(c);var d={autoOpen:!0,modal:!0,title:i("Select a media"),width:"auto",close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};s.dialog(d),this.dbSearchEngine.getAudioMediaFromPlaceId(o,function(t){if(0==t.length)l.html("<span>There are no audio files available</span>");else{var i=e('<table class="mediaSelection"></table>');l.append(i);for(var n=0;n<t.length;++n){u(i,t[n])}}})}else alert("No media to select");function u(t,i){var o=e("<tr></tr>"),a=e("<td></td>");if(i.title){var l=e("<span>title: "+i.title+"</span>");a.append(l),a.append(e("<br/>"))}if(i.mimetype){l=e("<span>MIME type: "+i.mimetype+"</span>");a.append(l),a.append(e("<br/>"))}if(i.filename){l=e("<span>file: "+i.filename+"</span>");a.append(l),a.append(e("<br/>"))}o.hover(function(){var e=i.filename?i.filename:"";r.insertSound(e)},function(){r.insertSound()}),o.click(function(){var e=i.filename?i.filename:"";return r.insertSound(),n(e),s.dialog("close"),!1}),o.append(a),t.append(o)}},initCometChannels:function(){var t=this;this.cometEnabled&&e.cometd&&(e.cometd.init("./cometd"),e.cometd.subscribe(this.fidChannel,function(e){t.fidHandler(e)}))},fidHandler:function(e){if(e.data&&e.data.type&&e.data.fid)if(this._cacheInvalidateFeature(e.data.fid),"added"==e.data.type){var i=t.olFilter.fromFid(e.data.fid);this._reloadFeature(i)}else if("updated"==e.data.type){i=t.olFilter.fromFid(e.data.fid);this._reloadFeature(i)}else"deleted"==e.data.type&&this._removeFeature(e.data.fid)},fidAdded:function(t){if(this.cometEnabled&&e.cometd){var i={fid:t,type:"added"};e.cometd.publish(this.fidChannel,i)}},fidUpdated:function(t){if(this.cometEnabled&&e.cometd){var i={fid:t,type:"updated"};e.cometd.publish(this.fidChannel,i)}},fidDeleted:function(t){if(this.cometEnabled&&e.cometd){var i={fid:t,type:"deleted"};e.cometd.publish(this.fidChannel,i)}},adjustFilterProperties:function(e){for(var t in e.isFilteredIn=!1,e.isFilteredOut=!1,this.styleFilters){if(e.isFilteredIn=!0,!(0,this.styleFilters[t].matchFn)(e))return e.isFilteredIn=!1,e.isFilteredOut=!0,!0}return!1},_createStyleMap:function(t){var i=t?e.extend(!0,{},this.defaultStyleMap,t):this.defaultStyleMap,n={normal:new OpenLayers.Style(i.normal),clicked:new OpenLayers.Style(i.clicked),hovered:new OpenLayers.Style(i.hovered),hoveredClicked:new OpenLayers.Style(i.hoveredClicked),filteredOut:new OpenLayers.Style(i.filteredOut)};return new OpenLayers.StyleMapCallback(function(e,t){var i=null;null==i&&e.isFilteredOut&&(i="filteredOut"),null==i&&e.isHovered&&(i=e.isClicked?"hoveredClicked":"hovered"),null==i&&e.isClicked&&(i="clicked");var r=n[i];return null==r&&(r=n.normal),r.createSymbolizer(e)})},_createStyleMapFromLayerInfo:function(e){var t=null;return e&&e.styleMap&&(t=e.styleMap),this._createStyleMap(t)},_createEffectiveStyleMap:function(e){var t=this,i=null;i=e?e.styleMapFn(e):this._createStyleMap();var n=new OpenLayers.StyleMapCallback(function(e,n){return null==e?{fillColor:"#0000ff",fillOpacity:.4,strokeColor:"#0000ff",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",pointRadius:6,pointerEvents:"visiblePainted",cursor:"pointer"}:e._sketch?{fillColor:"#0000ff",fillOpacity:.4,strokeColor:"#0000ff",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",pointRadius:6,pointerEvents:"visiblePainted",cursor:"pointer"}:(t.adjustFilterProperties(e),i.createSymbolizer(e,n))});return n.styles||(n.styles={}),n.styles.temporary||(n.styles.temporary={fillColor:"#66cccc",fillOpacity:.2,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"#66cccc",strokeOpacity:1,strokeLinecap:"round",strokeWidth:2,strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit"}),n.styles.delete||(n.styles.delete={display:"none"}),n},turnOffStyleFilter:function(e){this.styleFilters[e]&&(delete this.styleFilters[e],this.redrawMap())},removeStyleFilter:function(t){var i=null;"string"==typeof t?i=t:"string"==typeof t&&(i=t.label),null!=i&&(turnOffStyleFilter(i),e("#_olkit_styleFilter_"+i).remove())},addStyleFilter:function(t){var i=this,n=e.extend({description:"Unknown Filter",refreshFunction:function(e){}},t),r=""+this.styleFilterIndex;++this.styleFilterIndex,n.label=r;var o=e('<span id="_olkit_styleFilter_'+r+'"></span>'),s=this.options.filterPanelName;if(null==s)return!1;e("#"+s).append(o);var a=e('<input type="checkbox"/>'),l=e("<span></span>"),c=e("<span>"+n.description+"</span>"),d=e('<input type="button" value="Delete"/>'),u=e("<br/>");function h(){l.text("!!!"),a.attr("checked",!1),m(o,!1),null!=r&&(this.removeStyleFilter(r),r=null)}function p(){l.empty(),m(o,!0),n.refreshFunction({onError:h,filterOnFids:f})}function f(e){for(var t={},r=0;r<e.length;++r)t[e[r]]=1;n.matchFn=function(e){return!!t[e.attributes.id]},styleFilters[n.label]=n,a.attr("checked",!0),m(o,!1),i.redrawMap()}function m(t,i){i?t.attr("disabled",!0).addClass("olkitDisabled"):t.removeAttr("disabled").removeClass("olkitDisabled"),t.children().each(function(t,n){m(e(n),i)})}return o.append(a),o.append(d),o.append(l),o.append(c),o.append(u),a.bind("change",function(){a.attr("checked")?p():(l.empty(),i.turnOffStyleFilter(r))}),d.click(function(){return null!=r&&(i.removeStyleFilter(r),r=null),!1}),p(),!1},createLayerFromOptions:function(i){var n=this,r=this._getCustomService(),o=e.extend({styleMapFn:function(e){return n._createStyleMapFromLayerInfo(e)}},i);o.customService=r;var s=new c(o);s.typename=s.featurePrefix+":"+s.featureType,s.schema=s.wfsUrl+"?service=WFS&version="+s.wfsVersion+"&request=DescribeFeatureType&typeName="+s.typename;var a={projection:s.sourceProjection,visibility:s.visibility,_layerInfo:s};if(s.couchDb){var l=t.extend({},i.couchDb,{notifications:{readStart:function(){n._mapBusyStatus(1)},readEnd:function(){n._mapBusyStatus(-1)}}});s.protocol=new OpenLayers.Protocol.Couch(l),a.protocol=s.protocol}else s.wfsUrl?(s.protocol=new OpenLayers.Protocol.WFS.v1_1_0({url:s.wfsUrl,featureType:s.featureType,featureNS:s.featureNS,featurePrefix:s.featurePrefix,geometryName:s.geometryName,readFormat:new OpenLayers.Format.GeoJSON,outputFormat:"json"}),a.protocol=s.protocol):t.reportError("Unrecognized layer: "+s.name);var d=this._createEffectiveStyleMap(s);if(a.styleMap=d,s.olFilter=null,s.filter&&(s.olFilter=t.olFilter.CreateOpenLayersFilter(s.filter),null==s.olFilter?alert("Encountered invalid filter"):a.filter=s.olFilter),s.useFixedStrategy){var u=new OpenLayers.Bounds(options.mapCoordinateSpecifications.maxExtent[0],options.mapCoordinateSpecifications.maxExtent[1],options.mapCoordinateSpecifications.maxExtent[2],options.mapCoordinateSpecifications.maxExtent[3]);userCoordProjection.getCode()!=s.sourceProjection.getCode()&&u.transform(userCoordProjection,s.sourceProjection);var h=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,property:s.geometryName,value:u});if(null==a.filter)a.filter=h;else{var p=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[a.filter,h]});a.filter=p}a.protocol&&(a.strategies=[new OpenLayers.Strategy.Fixed])}else a.protocol&&(s.couchDb?a.strategies=[new OpenLayers.Strategy.N2BBOX]:a.strategies=[new OpenLayers.Strategy.BBOX]);return a.strategies||(a.strategies=[]),a.strategies.push(new OpenLayers.Strategy.NunaliitLayerSorting),a.renderers=["SVG","VML"],s.olLayer=new OpenLayers.Layer.Vector(s.name,a),this._registerLayerForEvents(s),this.infoLayers.push(s),this.vectorLayers.push(s.olLayer),s.id?this.layers[s.id]=s.olLayer:this.layers[s.name]=s.olLayer,s},findLayerFromId:function(e){return this.layers[e]},addLayer:function(e,t){var i=this._createOLLayerFromDefinition(e,t);this.map.addLayer(i),this._installFeatureSelector()},_uninstallFeatureSelector:function(){this.selectFeatureControl&&(this.selectFeatureControl.deactivate(),this.map.removeControl(this.selectFeatureControl),this.selectFeatureControl=null)},_installFeatureSelector:function(){var e=this;this.selectFeatureControl&&this._uninstallFeatureSelector();this.selectFeatureControl=new OpenLayers.Control.SelectFeature(this.vectorLayers,{hover:!0,callbacks:{}}),this.selectFeatureControl.handlers.feature=new OpenLayers.Handler.NunaliitFeature({},this.selectFeatureControl.layer,{click:function(t){e._startClicked(t,!1)},clickout:function(t){e._unselectFeature()},over:function(t){e._startHover(t)},out:function(t){e._endHover()}},{geometryTypes:this.selectFeatureControl.geometryTypes}),this.map.addControl(this.selectFeatureControl),this.selectFeatureControl.activate()},_mapBusyStatus:function(e){var i=this.mapBusyCount;this.mapBusyCount+=e,i<1&&this.mapBusyCount>0&&t.log("Start map busy"),i>0&&this.mapBusyCount<1&&t.log("End map busy"),this.busyMapControl&&e<0?this.busyMapControl.decreaseCounter():this.busyMapControl&&e>0&&this.busyMapControl.increaseCounter()},_refreshSimplifiedGeometries:function(){for(var e=this,t=new OpenLayers.Projection("EPSG:4326"),i=this._getResolutionInProjection(t),n=this.map.getProjectionObject(),r={},o=this.map.getExtent(),s=this.map.layers,a=0,c=s.length;a<c;++a){var d=s[a];if(d.features)for(var u=0,h=d.features.length;u<h;++u){var p=d.features[u];p.cluster||T(p,i,r,o,n)}}var f=[],m=[];for(var v in r){var g=r[v],y=g.attName;if("__inline"===y){var _={id:v,attName:y,wkt:g.doc.nunaliit_geom.wkt,proj:g.feature.n2GeomProj};m[m.length]=_}else if(g.feature&&g.feature.n2SimplifiedGeoms&&g.feature.n2SimplifiedGeoms[y]){_=g.feature.n2SimplifiedGeoms[y];m[m.length]=_}else r[v].feature&&r[v].feature.n2FilteredOut||(f[f.length]=r[v])}if(m.length&&window.setTimeout(function(){e._updateSimplifiedGeometries(m)},0),f.length){var S=this.map.getCenter();if(S){n&&n.getCode()!==t.getCode&&S.transform(n,t);for(var b=0,I=f.length;b<I;++b){var C=f[b],D=(C.bbox[0]+C.bbox[2])/2,w=(C.bbox[1]+C.bbox[3])/2,E=D-S.lon,x=w-S.lat;C.d=E*E+x*x}f.sort(function(e,t){var i=!0,n=!0;return e.feature&&e.feature.n2FilteredOut&&(i=!1),t.feature&&t.feature.n2FilteredOut&&(n=!1),i&&!n?-1:n&&!i?1:e.d<t.d?-1:e.d>t.d?1:0})}this._dispatch({type:"simplifiedGeometryRequest",geometriesRequested:f,requester:this.mapId})}function T(e,t,i,n,r){if(n){var o=l(e,r);if(o&&o.intersectsBounds(n)&&e.data&&e.data.nunaliit_geom&&e.data.nunaliit_geom.simplified&&e.data.nunaliit_geom.simplified.resolutions){var s=void 0,a=void 0;for(var c in e.data.nunaliit_geom.simplified.resolutions){var d=1*e.data.nunaliit_geom.simplified.resolutions[c];d<t&&(void 0===a?(a=d,s=c):d>a&&(a=d,s=c))}if(void 0!==a&&e.data.nunaliit_geom.simplified.reported_resolution===a&&(s="__inline"),s||e.data.nunaliit_geom.simplified.original&&(s=e.data.nunaliit_geom.simplified.original),!s)return;var u=void 0;e.n2CurrentGeomAttName&&(u=e.n2CurrentGeomAttName),u!==s&&(i[e.fid]={id:e.fid,attName:s,doc:e.data,feature:e,bbox:e.data.nunaliit_geom.bbox},e.n2TargetGeomAttName=s)}}}this._dispatch({type:"waitReport",requester:this.mapId,name:"simplifiedGeometries",label:"Simplified Geometries",count:f.length})},_updateSimplifiedGeometries:function(e){for(var i=this,n=new OpenLayers.Format.WKT,r={},o=0,s=e.length;o<s;++o){var a=e[o];r[a.id]=a}for(var l={},c=this.map.layers,d=0,u=c.length;d<u;++d){if((y=c[d]).features)for(var h=0,p=y.features.length;h<p;++h){if((S=y.features[h]).cluster)for(var f=0,m=S.cluster.length;f<m;++f){b(y,S.cluster[f],r,l)}else b(y,S,r,l)}}var v=!1;for(var g in l){var y,_=[];for(h=0,p=(y=l[g]).features.length;h<p;++h){var S;if((S=y.features[h]).cluster)for(f=0,m=S.cluster.length;f<m;++f)_[_.length]=S.cluster[f];else _[_.length]=S}y.removeAllFeatures({silent:!0}),y.addFeatures(_),v=!0}function b(e,r,o,s){var a=o[r.fid];if(a&&(r.n2SimplifiedGeoms||(r.n2SimplifiedGeoms={}),r.n2SimplifiedGeoms[a.attName]=a,a.attName&&a.attName!==r.n2CurrentGeomAttName&&a.attName&&a.attName===r.n2TargetGeomAttName&&a.wkt)){var l=n.read(a.wkt),c=void 0;if(t.isArray(l)){for(var d=[],u=0,h=l.length;u<h;++u){var p=l[u];p.geometry&&d.push(p.geometry)}c=new OpenLayers.Geometry.Collection(d)}else l&&l.geometry&&(c=l.geometry);c&&(a.proj&&(c=i._reprojectGeometryForMap(c,a.proj)),r.geometry=c,r.n2CurrentGeomAttName=a.attName,s[e.id]=e)}}v||this._refreshSimplifiedGeometries(),v&&this._updatedStylesInUse()},_getResolutionInProjection:function(e){var t=this.map.resolution;if(this.map.projection.getCode()!==e.getCode()){var i=OpenLayers.Projection.transform({x:0,y:0},this.map.projection,e),n=OpenLayers.Projection.transform({x:0,y:1},this.map.projection,e),r=Math.sqrt((i.x-n.x)*(i.x-n.x)+(i.y-n.y)*(i.y-n.y));t=this.map.resolution*r}return t},_reprojectGeometryForMap:function(e,t){var i=e;return this.map.projection.getCode()!==t.getCode()&&e.transform(t,this.map.projection),i},_getMapStylesInUse:function(){var e={};for(var t in this.infoLayers){this.infoLayers[t].accumulateMapStylesInUse(e)}return e},_updatedStylesInUse:function(){var e=this._getMapStylesInUse();this._dispatch({type:"canvasReportStylesInUse",canvasName:this.getCanvasName(),stylesInUse:e})},redefineFeatureLayerStylesAndRules:function(e){var t=this.getNamedLayerInfo(e);null==t?alert("redefineFeatureLayerStylesAndRules: unknown layer name: "+e):t.olLayer.redraw()},recentreMap:function(e){var t=this.map.getZoom();this.map.setCenter(e,t,!1,!1)},getResolution:function(){return this.map.getResolution()},_mapMoved:function(){var e=this;this.mapWasMoved||(this.mapWasMoved=!0,setTimeout(function(){e.mapWasMoved=!1,e._refreshSimplifiedGeometries(),e._updatedStylesInUse()},200))},resetExtent:function(){this.initialZoomBounds&&this.map.zoomToExtent(this.initialZoomBounds)},setInitialExtent:function(e,t,i){var n=new OpenLayers.Bounds(e[0],e[1],e[2],e[3]);null!=t&&this.convertBoundsToMapProjection(n,t),this.initialZoomBounds=n,i&&this.resetExtent()},setNewExtent:function(e,t){var i=new OpenLayers.Bounds(e[0],e[1],e[2],e[3]);null!=t&&this.convertBoundsToMapProjection(i,t),this.map.zoomToExtent(i,!0)},getMediaPath:function(){return this.dbSearchEngine.getRelMediaPath()},getSidePanelName:function(){return this.options.sidePanelName},getFilterPanelName:function(){return this.options.filterPanelName},addMapMousePositionListener:function(e){"function"==typeof e&&this.mapMouseMoveListeners.push(e)},initiateEditFromGeometry:function(e){var i=t.extend({geometry:null,suppressCenter:!1},e);if(!i.geometry)throw"Geometry must be provided";this.currentMode===this.modes.ADD_OR_SELECT_FEATURE&&this._switchMapMode(this.modes.ADD_OR_SELECT_FEATURE),i.suppressCenter&&(this.editFeatureInfo.suppressCenter=!0);var n=this.editLayer,r=new OpenLayers.Feature.Vector(i.geometry);n.addFeatures([r])},_retrieveCachedValue:function(e){for(var i=0,n=this.infoLayers.length;i<n;++i){var r=this.infoLayers[i],o=this._getCachedValueMap(r);if(o&&o[e]&&!o[e].__n2_cache_invalid)return t.document.clone(o[e])}return null},_getCachedValueMap:function(e){var t=void 0;if(e.cachingAllowed)if(e.cachedValues)t=e.cachedValues;else{t={},e.cachedValues=t;for(var i=e.olLayer.features,n=0,r=i.length;n<r;++n){var o=i[n];if(o.fid&&(t[o.fid]=o.data),o.cluster)for(var s=0,a=o.cluster.length;s<a;++s){var l=o.cluster[s];l.fid&&(t[l.fid]=l.data)}}}return t},_clearValueCache:function(e){e.cachedValues=null},_cacheInvalidateFeature:function(e){for(var t=0,i=this.infoLayers.length;t<i;++t){var n=this.infoLayers[t],r=this._getCachedValueMap(n);r&&r[e]&&(r[e].__n2_cache_invalid=!0)}},_cacheUpdateDocumentVersion:function(e,t){for(var i=0,n=this.infoLayers.length;i<n;++i){var r=this.infoLayers[i],o=this._getCachedValueMap(r);o&&o[e]&&o[e]._rev!==t&&(o[e].__n2_cache_invalid=!0)}},_handleMapMousePosition:function(e){this.lastMapXy=null==e?null:this.map.events.getMousePosition(e);for(var t=[],i=0,n=this.mapMouseMoveListeners.length;i<n;++i){var r=this.mapMouseMoveListeners[i];try{r(e,this)&&t.push(r)}catch(n){}}this.mapMouseMoveListeners=t},_getAuthService:function(){var e=null;return this.options.directory&&(e=this.options.directory.authService),e},_getCustomService:function(){var e=null;return this.options.directory&&(e=this.options.directory.customService),e},_getDispatchService:function(){var e=null;return this.options.directory&&(e=this.options.directory.dispatchService),e},_dispatch:function(e){var t=this._getDispatchService();t&&t.send(n,e)},_registerDispatch:function(e,t){var i=this._getDispatchService();if(i){var r=this;t||(t=this._handleDispatch_),t||(t=function(e){r._handleDispatch(e)}),i.register(n,e,t)}},_handleDispatch:function(e){var i=e.type;if("documentVersion"===i)this._cacheUpdateDocumentVersion(e.docId,e.rev);else if("documentDeleted"===i)this._removeFeature(e.docId);else if("cacheRetrieveDocument"===i){(y=this._retrieveCachedValue(e.docId))&&(e.doc=y)}else if("documentContentCreated"===i){if((y=e.doc)&&y.nunaliit_geom){var n={};if(y.nunaliit_layers)for(var r=0,o=y.nunaliit_layers.length;r<o;++r)n[y.nunaliit_layers[r]]=!0;for(r=0,o=this.infoLayers.length;r<o;++r){if(n[g=(j=this.infoLayers[r]).id]){var s=!0;if((D=this._getLayerFeatureIncludingFid(j.olLayer,y._id))&&D.data&&D.data._rev===y._rev&&(s=!1),s){var a=t.olFilter.fromFid(e.docId);this._loadFeatureOnLayer(j,a)}}}}}else if("documentContentUpdated"===i){var l=!1;n={};if((y=e.doc)&&y.nunaliit_layers)for(r=0,o=y.nunaliit_layers.length;r<o;++r)n[y.nunaliit_layers[r]]=!0;for(r=0,o=this.infoLayers.length;r<o;++r){if(!n[g=(j=this.infoLayers[r]).id])if(D=this._getLayerFeatureIncludingFid(j.olLayer,y._id)){var c=null;if(D.cluster)for(var d=0,u=D.cluster.length;d<u;++d){(p=D.cluster[d]).fid!==y._id&&(c||(c=[]),c.push(p))}j.olLayer.destroyFeatures(D),c&&j.olLayer.addFeatures(c),l=!0}}for(r=0,o=this.infoLayers.length;r<o;++r){if(n[g=(j=this.infoLayers[r]).id]){var h=!0;if(y&&y._rev)if((D=this._getLayerFeatureIncludingFid(j.olLayer,y._id))&&D.fid===y._id&&D.data&&D.data._rev===y._rev)h=!1;else if(D&&D.cluster)for(d=0,u=D.cluster.length;d<u;++d){var p;(p=D.cluster[d])&&p.fid===y._id&&p.data&&p.data._rev===y._rev&&(h=!1)}if(h){a=t.olFilter.fromFid(e.docId);this._loadFeatureOnLayer(j,a)}}}l&&this._updatedStylesInUse()}else if("addLayerToMap"===i)this._handleAddLayerToMap(e);else if("selected"===i){if(e.docId){var f=this._getMapFeaturesIncludingFid(e.docId);this._selectedFeatures(f,[e.docId])}else if(e.docIds){f=this._getMapFeaturesIncludingFids(e.docIds);this._selectedFeatures(f,e.docIds)}}else if("selectedSupplement"===i){if(m=e.docId){f=this._getMapFeaturesIncludingFid(m);this._selectedFeaturesSupplement({fid:m,features:f,intent:e.intent})}}else if("unselected"===i)this._endClicked();else if("focusOn"===i)e.docId?this._startFocus([e.docId]):e.docIds&&this._startFocus(e.docIds);else if("focusOff"===i)this._endFocus();else if("focusOnSupplement"===i){var m=e.docId,v=!0;e.origin&&(v=!1,this.focusInfo&&this.focusInfo.origin&&this.focusInfo.origin[e.origin]&&(v=!0)),m&&v&&this._addFocus({fids:[m],intent:e.intent})}else if("findIsAvailable"===i){if((y=e.doc).nunaliit_geom&&y.nunaliit_layers)for(r=0,o=this.infoLayers.length;r<o;++r){var g=(j=this.infoLayers[r]).id;if(y.nunaliit_layers.indexOf(g)>=0){e.isAvailable=!0;break}}}else if("find"===i){var y;if((y=e.doc)&&y.nunaliit_geom){var _=(y.nunaliit_geom.bbox[0]+y.nunaliit_geom.bbox[2])/2,S=(y.nunaliit_geom.bbox[1]+y.nunaliit_geom.bbox[3])/2;this._centerMapOnXY(_,S,"EPSG:4326")}m=e.docId,f=this._getMapFeaturesIncludingFid(m);if(this._startFindFeature(m,f),y&&y.nunaliit_layers){var b=!1,I=null;for(r=0,o=this.infoLayers.length;r<o;++r){g=(j=this.infoLayers[r]).id;var C=j.olLayer;y.nunaliit_layers.indexOf(g)>=0&&C&&(C.visibility?b=!0:I=C)}!b&&I&&I.setVisibility(!0)}}else if("searchInitiate"===i)this._endClicked();else if("editInitiate"===i){m=void 0;e.doc&&(m=e.doc._id);var D=null,w=!0;if(m)if((f=this._getMapFeaturesIncludingFid(m)).length>0&&(D=f[0]),D)this._centerMapOnFeature(D),w=!1;else if(e.doc&&e.doc.nunaliit_geom&&e.doc.nunaliit_geom.bbox&&e.doc.nunaliit_geom.bbox.length>=4){var E=e.doc.nunaliit_geom.bbox;_=(E[0]+E[2])/2,S=(E[1]+E[3])/2;this._centerMapOnXY(_,S,"EPSG:4326"),w=!1}this.infoLayers.forEach(function(e){e.featureStrategy&&e.featureStrategy.setEditedFeatureIds([m])}),this.editFeatureInfo={},this.editFeatureInfo.fid=m,this.editFeatureInfo.original={data:t.document.clone(e.doc)};var x=null;if(D){var T=D.layer;if(m===D.fid)x=D;else if(D.cluster)for(r=0,o=D.cluster.length;r<o;++r)m===D.cluster[r].fid&&(x=D.cluster[r]);this.editFeatureInfo.original.layer=T,this.editFeatureInfo.original.feature=x}w?this.switchToAddGeometryMode(m):this.switchToEditFeatureMode(m)}else if("editClosed"===i){(m=this.editFeatureInfo.fid)||(m=e.docId);var k=!0;e.cancelled&&(k=!1);this._removeGeometryEditor();if(this._switchMapMode(this.modes.NAVIGATE),this.infoLayers.forEach(function(e){e.featureStrategy&&e.featureStrategy.setEditedFeatureIds(null)}),e.deleted&&m&&(k=!1,this.forEachVectorLayer(function(e,t){var i=!1,n=[];e.forEachFeature(function(e){e.fid===m?i=!0:n.push(e)}),i&&(t.removeAllFeatures({silent:!0}),t.addFeatures(n))})),this.editFeatureInfo={},this.editFeatureInfo.original={},k){a=t.olFilter.fromFid(m);this._reloadFeature(a)}}else if("editGeometryModified"===i)e._origin!==this&&this._geometryModified(e.docId,e.geom,e.proj);else if("editReportOriginalDocument"===i){if(e.geometry&&e.docId===this.editFeatureInfo.fid){this._geometryModified(e.docId,e.geometry,e.projection);var L=!0;if(this.editFeatureInfo.suppressZoom&&(L=!1),e.doc&&e.doc.nunaliit_geom&&e.doc.nunaliit_geom.bbox&&e.projection){var M=e.doc.nunaliit_geom.bbox[0],O=e.doc.nunaliit_geom.bbox[1],A=e.doc.nunaliit_geom.bbox[2],F=e.doc.nunaliit_geom.bbox[3],R=(A-M)/3,N=(F-O)/3;if(R<=0&&N<=0&&(L=!1),L)M-=R,A+=R,O-=N,F+=N,this.setNewExtent([M,O,A,F],e.projection.getCode());else if(!this.editFeatureInfo.suppressCenter){_=(M+A)/2,S=(O+F)/2;this._centerMapOnXY(_,S,e.projection.getCode())}}}}else if("mapRedrawLayer"===i){g=e.layerId;this.redefineFeatureLayerStylesAndRules(g)}else if("mapSetInitialExtent"===i){var P=e.extent,B=e.srsName,U=e.reset;this.setInitialExtent(P,B,U)}else if("mapSetExtent"===i){P=e.extent,B=e.srsName;this.setNewExtent(P,B)}else if("mapResetExtent"===i)this.resetExtent();else if("mapGetLayers"===i){e.layers||(e.layers={});for(r=0,o=this.infoLayers.length;r<o;++r){g=(j=this.infoLayers[r]).id,C=j.olLayer;var j,z=e.layers[g];z||(z={id:g},e.layers[g]=z),C&&C.visibility&&(z.visible=!0)}}else if("setMapLayerVisibility"===i){g=e.layerId,b=e.visible;this.layers[g]&&this.layers[g].setVisibility(b)}else"mapSwitchToEditMode"===i?this.switchToEditMode():"simplifiedGeometryReport"===i?this._updateSimplifiedGeometries(e.simplifiedGeometries):"canvasGetStylesInUse"===i&&this.getCanvasName()===e.canvasName&&(e.stylesInUse=this._getMapStylesInUse())},_modelLayerUpdated:function(e,t){var i=e._layerInfo,n=i.olLayer,r=!1,o=n.projection,s=i.olLayer.map.getProjectionObject();s&&0==s.equals(o)&&(r=!0);var a={};t.removed.forEach(function(e){a[e.fid]=!0}),t.updated.forEach(function(e){a[e.fid]=!0});var l=[],c=[];if(n&&n.features){var d,u=n.features;for(d=0;d<u.length;++d){var h=u[d];if(h.fid&&a[h.fid])l.push(h);else if(h.cluster){for(var p=!1,f=0,m=h.cluster.length;f<m;++f){(v=h.cluster[f]).fid&&a[v.fid]&&(p=!0)}if(p){l.push(h);for(f=0,m=h.cluster.length;f<m;++f){var v;(v=h.cluster[f]).fid&&!a[v.fid]&&c.push(v)}}}}}t.added.forEach(function(e){if(r){var t=e.geometry;t&&t.transform(o,s)}c.push(e)}),t.updated.forEach(function(e){if(r){var t=e.geometry;t&&t.transform(o,s)}c.push(e)}),l.length&&n.destroyFeatures(l),c.length>0&&(this.editModeAddFeatureEnabled=!1,n.addFeatures(c),this.editModeAddFeatureEnabled=!0),this._updatedStylesInUse()},_handleAddLayerToMap:function(e){var t=e.layer,i=!1;void 0!==e.isBaseLayer&&(i=e.isBaseLayer);var n=this.findLayerFromId(t.id);if(n||(this.addLayer(t,i),n=this.findLayerFromId(t.id)),n&&n.setVisibility(!0),e.options&&e.options.setExtent){var r=e.options.setExtent.bounds,o=e.options.setExtent.crs;this.setNewExtent(r,o)}}});t.mapAndControls=function(e){return new d(e)},t.mapAndControls.MapAndControls=d,t.mapAndControls.ComputeFeatureOriginalBboxForMapProjection=l,t.mapAndControls.DefaultPopupHtmlFunction=null,t.mapAndControls.SuppressPopupHtmlFunction=function(e){t.extend({feature:null,layerInfo:null,onSuccess:null,onError:null},e).onSuccess(null)},t.mapAndControls.ZoomInClusterClickCallback=function(e,t){var i=e.geometry,n=null;i&&(n=i.getBounds().getCenterLonLat()),n&&(t.map.setCenter(n,t.map.zoom+1),t._endHover())},t.mapAndControls.MultiSelectClusterClickCallback=function(e,t){var i=[];if(e.cluster)for(var n=0,r=e.cluster.length;n<r;++n){var o=e.cluster[n];o&&o.data&&o.data._id&&i.push(o.data._id)}i.length&&t._dispatch({type:"userSelect",docIds:i})},t.mapAndControls.TimeTransformMapBridge=o,t.mapAndControls.ModelMapBridge=s,t.mapAndControls.HandleWidgetAvailableRequests=function(e){"timeTransformToMapAndControlBridge"===e.widgetType?e.isAvailable=!0:"modelToMapAndControlBridge"===e.widgetType&&(e.isAvailable=!0)},t.mapAndControls.HandleWidgetDisplayRequests=function(e){if("timeTransformToMapAndControlBridge"===e.widgetType){var t={};if(e.widgetOptions)for(var i in e.widgetOptions)t[i]=e.widgetOptions[i];e.config&&e.config.directory&&(t.dispatchService=e.config.directory.dispatchService),new o(t)}else if("modelToMapAndControlBridge"===e.widgetType){if(t={},e.widgetOptions)for(var i in e.widgetOptions)t[i]=e.widgetOptions[i];e.config&&e.config.directory&&(t.dispatchService=e.config.directory.dispatchService),new s(t)}}}(jQuery,nunaliit2),function(e){var t={base:{normal:{fillColor:"#ffffff",strokeColor:"#ee9999",strokeWidth:2,fillOpacity:.4,strokeOpacity:1,strokeLinecap:"round",strokeDashstyle:"solid",pointRadius:6,pointerEvents:"visiblePainted"},clicked:{strokeColor:"#ff2200"},hovered:{fillColor:"#0000ff"},hoveredClicked:{fillColor:"#0000ff",strokeColor:"#ff2200"}},point:null,line:{hovered:{strokeColor:"#0000ff"},hoveredClicked:{strokeColor:"#0000ff"}},polygon:null,layers:null,schemas:null,intents:{cluster:{base:{normal:{fillColor:"#ffff33",pointRadius:8,graphicName:"square"}}},find:{base:{normal:{strokeColor:"#ffff00"}}}}},i=e.Class({activeStyles:null,initialize:function(e){var t=this._parseDefinition(e);this.activeStyles={};for(var i=0,n=t.length;i<n;++i){var r=t[i],o=[];o.push(r,this.activeStyles),r.layer&&o.push({category:"layers",name:r.layer}),r.schema&&o.push({category:"schemas",name:r.schema}),r.intent&&o.push({category:"intents",name:r.intent}),this._installDefinition.apply(this,o)}},_parseDefinition:function(i){var n=[],r={layer:null,schema:null,intent:null,priority:-1,styleSet:this._computeStyleSet(i)};return n.push(r),this._parseDefinition2(r,[],t,n),r=e.extend({},r,{priority:0}),this._parseDefinition2(r,[i],i,n),n},_parseDefinition2:function(i,n,r,o){if(r&&r.layers)for(var s in r.layers){var a=e.extend({},i,{layer:s,priority:i.priority+1}),l=r.layers[s],c=n.slice(0);t.layers&&t.layers[s]&&c.push(t.layers[s]),c.push(l),a.styleSet=this._computeStyleSet.apply(this,c),o.push(a),this._parseDefinition2(a,c,l,o)}if(r&&r.schemas)for(var d in r.schemas){var u=e.extend({},i,{schema:d,priority:i.priority+1}),h=r.schemas[d];c=n.slice(0);t.schemas&&t.schemas[d]&&c.push(t.schemas[d]),c.push(h),u.styleSet=this._computeStyleSet.apply(this,c),o.push(u),this._parseDefinition2(u,c,h,o)}if(r&&r.intents)for(var p in r.intents){var f=e.extend({},i,{intent:p,priority:i.priority+1}),m=r.intents[p];c=n.slice(0);t.intents&&t.intents[p]&&c.push(t.intents[p]),c.push(m),f.styleSet=this._computeStyleSet.apply(this,c),o.push(f),this._parseDefinition2(f,c,m,o)}},_installDefinition:function(e,t,i){if(i){var n=arguments[arguments.length-1],r=n.category,o=n.name;t[r]||(t[r]={}),t[r][o]||(t[r][o]={});for(var s=[e,t[r][o]],a=2,l=arguments.length-1;a<l;++a)s.push(arguments[a]);this._installDefinition.apply(this,s)}else t.descriptor&&t.descriptor.priority<=e.priority?t.descriptor=e:t.descriptor||(t.descriptor=e)},_retrieveStyleSet:function(e,t,i){var n=this.activeStyles,r=this.activeStyles.descriptor;return e&&n.intents&&n.intents[e]&&(n=n.intents[e]).descriptor&&r.priority<n.descriptor.priority&&(r=n.descriptor),t&&n.schemas&&n.schemas[t]&&(n=n.schemas[t]).descriptor&&r.priority<n.descriptor.priority&&(r=n.descriptor),i&&n.layers&&n.layers[i]&&(n=n.layers[i]).descriptor&&r.priority<n.descriptor.priority&&(r=n.descriptor),r.styleSet},_computeStyleSet:function(){var e={},i=[t.base],n=[t.base],r=[t.base];i.push(t.point),n.push(t.line),r.push(t.polygon);for(var o=0,s=arguments.length;o<s;++o){(a=arguments[o])&&(i.push(a.base),n.push(a.base),r.push(a.base))}for(o=0,s=arguments.length;o<s;++o){var a;(a=arguments[o])&&(i.push(a.point),n.push(a.line),r.push(a.polygon))}return e.point=this._computeStateStyles.apply(this,i),e.line=this._computeStateStyles.apply(this,n),e.polygon=this._computeStateStyles.apply(this,r),e},_mergeStateStyles:function(t){var i={};t||(t={}),i.normal=e.extend({},t.normal);for(var n=1,r=arguments.length;n<r;++n){(o=arguments[n])&&o.normal&&e.extend(i.normal,o.normal)}i.hovered=e.extend({},i.normal,t.hovered),i.clicked=e.extend({},i.normal,t.clicked),i.hoveredClicked=e.extend({},i.normal,t.hoveredClicked);for(n=1,r=arguments.length;n<r;++n){var o;(o=arguments[n])&&o.hovered&&e.extend(i.hovered,o.hovered),o&&o.clicked&&e.extend(i.clicked,o.clicked),o&&o.hoveredClicked&&e.extend(i.hoveredClicked,o.hoveredClicked)}return i},_computeStateStyles:function(e){var t=this._mergeStateStyles.apply(this,arguments);return{normal:new OpenLayers.Style(t.normal),hovered:new OpenLayers.Style(t.hovered),clicked:new OpenLayers.Style(t.clicked),hoveredClicked:new OpenLayers.Style(t.hoveredClicked),_merged:t}},getStyleMapForLayerInfo:function(e){var t=this;return new OpenLayers.StyleMapCallback(function(i,n){var r=null;null==r&&i.isHovered&&(r=i.isClicked?"hoveredClicked":"hovered"),null==r&&i.isClicked&&(r="clicked"),null==r&&(r="normal");var o=i.geometry._n2Type;o||(o=i.geometry.CLASS_NAME.indexOf("Line")>=0?i.geometry._n2Type="line":i.geometry.CLASS_NAME.indexOf("Polygon")>=0?i.geometry._n2Type="polygon":i.geometry._n2Type="point");var s=i.data;i&&i.cluster&&1===i.cluster.length&&(s=i.cluster[0].data);var a=i.n2HoverIntent;a||(a=i.n2SelectIntent),a||(a=i.n2Intent);var l=e.id,c=null;return s&&s.nunaliit_schema&&(c=s.nunaliit_schema),i&&i.cluster&&i.cluster.length>1&&(a="cluster"),t._retrieveStyleSet(a,c,l)[o][r].createSymbolizer(i)})}}),n={fill:"fillColor","fill-opacity":"fillOpacity",stroke:"strokeColor","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","stroke-linecap":"strokeLinecap","stroke-dasharray":"strokeDashstyle",r:"pointRadius","pointer-events":"pointEvents",color:"fontColor","font-family":"fontFamily","font-size":"fontSize","font-weight":"fontWeight"},r={label:!0},o={getDocuments:function(){var t=[];return e.isArray(this.cluster)?this.cluster.forEach(function(e){t.push(e.data)}):t.push(this.data),t}},s=e.Class({styleRules:null,dispatchService:null,initialize:function(t){var i=e.extend({ruleArray:null,dispatchService:null},t),n=[];n.push({condition:"true",normal:{fillColor:"#ffffff",strokeColor:"#ee9999",strokeWidth:2,fillOpacity:.4,strokeOpacity:1,strokeLinecap:"round",strokeDashstyle:"solid",pointRadius:6,pointerEvents:"visiblePainted"},selected:{strokeColor:"#ff2200"},hovered:{fillColor:"#0000ff"},found:{strokeColor:"#00ffff",fillColor:"#00ffff"}}),n.push({condition:"isLine()",normal:{fillColor:"none"},selected:{fillColor:"none"},hovered:{strokeColor:"#0000ff",fillColor:"none"},found:{strokeColor:"#00ffff",fillColor:"none"}}),e.isArray(i.ruleArray)&&i.ruleArray.forEach(function(e){n.push(e)}),this.styleRules=e.styleRule.loadRulesFromObject(n,{skipDefaults:!0}),this.dispatchService=i.dispatchService},getStyleMapForLayerInfo:function(e){var t=this;return new OpenLayers.StyleMapCallback(function(e,i){for(var s in o)e[s]=o[s];e.isHovered?e.n2_hovered=!0:e.n2_hovered=!1,e.isClicked?e.n2_selected=!0:e.n2_selected=!1,"find"===e.n2Intent?e.n2_found=!0:e.n2_found=!1;var a=e.geometry._n2Type;a||(a=e.geometry.CLASS_NAME.indexOf("Line")>=0?e.geometry._n2Type="line":e.geometry.CLASS_NAME.indexOf("Polygon")>=0?e.geometry._n2Type="polygon":e.geometry._n2Type="point"),e.n2_geometry=a;var l=e.data;e&&e.cluster&&1===e.cluster.length&&(l=e.cluster[0].data),e.n2_doc=l;var c=t.styleRules.getStyle(e);e._n2Style=c;var d=c.getSymbolizer(e),u={};return d.forEachSymbol(function(e,t){r[e=n[e]?n[e]:e]&&(null===t||"number"==typeof t&&(t=""+t)),u[e]=t},e),u})}});e.mapStyles={MapFeatureStyles:i,MapStylesAdaptor:s}}(nunaliit2),function(e){var t="n2.instance";if("undefined"!=typeof OpenLayers){var i=e.Class({documentSource:null,initialize:function(t){var i=e.extend({documentSource:null},t);this.documentSource=i.documentSource},computeInitialBounds:function(t){for(var i=e.extend({mapOptions:null,mapInfo:null,initialBounds:null,coordinateProjection:null,onSuccess:function(e){},onError:function(e){}},t),n=this,r=i.mapOptions,o=i.initialBounds,s=this.documentSource,a=i.coordinateProjection,l=null,c=0,d=0,u=r.overlays.length;d<u;++d){var h=r.overlays[d];if("couchdb"===h.type){++c;s=h.options.documentSource;var p=h.options.layerName;s.getGeographicBoundingBox({layerId:p,onSuccess:function(e){f(e)},onError:function(t){e.log("Error computing bounds for layer "+p+": "+t),f(null)}})}}function f(e){--c,null==e||0==n._isValidBounds(e)||(null==l?l=e:(l[0]>e[0]&&(l[0]=e[0]),l[1]>e[1]&&(l[1]=e[1]),l[2]<e[2]&&(l[2]=e[2]),l[3]<e[3]&&(l[3]=e[3]))),m()}function m(){if(!(c>0))if(null!=l){if(0==n._isValidBounds(l))return e.log("Invalid bounding box reported for layer in database.",l),void i.onSuccess(null);var t=new OpenLayers.Bounds(o[0],o[1],o[2],o[3]),r=new OpenLayers.Bounds(l[0],l[1],l[2],l[3]),s=new OpenLayers.Projection("EPSG:4326");if(r.transform(s,a),t.containsBounds(r))i.onSuccess(o);else if(r.getWidth()<t.getWidth()||r.getHeight()<t.getHeight()){if(r.getWidth()<t.getWidth()){var d=t.getWidth()/2,u=(r.left+r.right)/2;r.left=u-d,r.right=u+d}if(r.getHeight()<t.getHeight()){d=t.getHeight()/2,u=(r.bottom+r.top)/2;r.bottom=u-d,r.top=u+d}i.onSuccess([r.left,r.bottom,r.right,r.top])}else i.onSuccess([r.left,r.bottom,r.right,r.top])}else i.onSuccess(null)}m()},_isValidBounds:function(e){return!!e.length&&(!(e.length<4)&&(!(e[0]<-180||e[0]>180)&&(!(e[2]<-180||e[2]>180)&&(!(e[1]<-90||e[1]>90)&&!(e[3]<-90||e[3]>90)))))}}),n=e.Class({atlasDesign:null,layerIds:null,allLayers:null,initialize:function(t){var i=e.extend({atlasDesign:null,layers:null,allLayers:null},t),n=this;this.atlasDesign=i.atlasDesign,this.layerIds=[],e.isArray(i.layers)&&i.layers.forEach(function(e){"string"==typeof e&&n.layerIds.push(e)}),this.allLayers=!1,"boolean"==typeof i.allLayers&&(this.allLayers=i.allLayers)},computeInitialBounds:function(t){var i=e.extend({mapOptions:null,mapInfo:null,initialBounds:null,coordinateProjection:null,onSuccess:function(e){},onError:function(e){}},t),n=this,r=(i.mapOptions,i.initialBounds),o=(this.documentSource,i.coordinateProjection),s={viewName:"geom-layer-bbox",reduce:!0,onSuccess:function(t){var s=void 0;if(t.forEach(function(e){var t=e.value;t&&(0==n._isValidBounds(t)||(s?(s[0]>t[0]&&(s[0]=t[0]),s[1]>t[1]&&(s[1]=t[1]),s[2]<t[2]&&(s[2]=t[2]),s[3]<t[3]&&(s[3]=t[3])):s=t))}),!s)return void i.onSuccess(null);if(!n._isValidBounds(s))return e.log("Invalid bounding box reported for layer in database.",s),void i.onSuccess(null);var a=new OpenLayers.Bounds(r[0],r[1],r[2],r[3]),l=new OpenLayers.Bounds(s[0],s[1],s[2],s[3]),c=new OpenLayers.Projection("EPSG:4326");if(l.transform(c,o),a.containsBounds(l))i.onSuccess(r);else if(l.getWidth()<a.getWidth()||l.getHeight()<a.getHeight()){if(l.getWidth()<a.getWidth()){var d=a.getWidth()/2,u=(l.left+l.right)/2;l.left=u-d,l.right=u+d}if(l.getHeight()<a.getHeight()){var d=a.getHeight()/2,u=(l.bottom+l.top)/2;l.bottom=u-d,l.top=u+d}i.onSuccess([l.left,l.bottom,l.right,l.top])}else i.onSuccess([l.left,l.bottom,l.right,l.top])},onError:i.onError};this.allLayers||(s.keys=[],s.group=!0,this.layerIds.forEach(function(e){s.keys.push(e)})),this.atlasDesign.queryView(s)},_isValidBounds:function(e){return!!e.length&&(!(e.length<4)&&(!(e[0]<-180||e[0]>180)&&(!(e[2]<-180||e[2]>180)&&(!(e[1]<-90||e[1]>90)&&!(e[3]<-90||e[3]>90)))))}}),r=e.Class({adjustLatitude:null,adjustLongitude:null,initialize:function(t){var i=e.extend({adjustLatitude:!0,adjustLongitude:!0,_mapInfo:null},t);this.adjustLatitude=i.adjustLatitude,this.adjustLongitude=i.adjustLongitude},computeInitialBounds:function(t){var i=e.extend({mapOptions:null,mapInfo:null,initialBounds:null,coordinateProjection:null,onSuccess:function(e){},onError:function(e){}},t),n=this;e.isArray(i.initialBounds)&&i.initialBounds.length>=4||(e.logError("MapAutoInitialBoundsCentreOnUserPosition: Do not understand initial bounds",i.initialBounds),i.onSuccess(i.initialBounds)),"undefined"!=typeof navigator&&navigator.geolocation&&"function"==typeof navigator.geolocation.getCurrentPosition?navigator.geolocation.getCurrentPosition(function(t){var r;if(t&&t.coords){var o=t.coords.latitude,s=t.coords.longitude;"number"==typeof o&&"number"==typeof s&&(r=new OpenLayers.Geometry.Point(s,o))}r?function(e){var t=new OpenLayers.Projection("EPSG:4326");t.getCode()!==i.coordinateProjection.getCode()&&e.transform(t,i.coordinateProjection);var r=[i.initialBounds[0],i.initialBounds[1],i.initialBounds[2],i.initialBounds[3]];if(n.adjustLatitude){var o=(1*i.initialBounds[3]-1*i.initialBounds[1])/2;r[1]=e.y-o,r[3]=e.y+o}if(n.adjustLongitude){var s=(1*i.initialBounds[2]-1*i.initialBounds[0])/2;r[0]=e.x-s,r[2]=e.x+s}i.onSuccess(r)}(r):(e.logError("MapAutoInitialBoundsCentreOnUserPosition: error during getCurrentPosition(): do not understand",t),i.onSuccess(i.initialBounds))},function(t){e.logError("MapAutoInitialBoundsCentreOnUserPosition: error during getCurrentPosition()",t),i.onSuccess(i.initialBounds)},{}):i.onSuccess(i.initialBounds)}});e.mapInitialBounds={handleInstanceCreate:function(t,s,a){if("mapAutoInitialBoundsCouchDbOverlays"===t.instanceConfiguration.type){var l=o(a),c=e.extend({},t.instanceConfiguration);l&&(c.documentSource=l.documentSource),t.instance=new i(c)}else"mapAutoInitialBoundsCouchDbLayers"===t.instanceConfiguration.type?(l=o(a),c=e.extend({},t.instanceConfiguration),l&&(c.atlasDesign=l.atlasDesign),t.instance=new n(c)):"mapAutoInitialBoundsCentreOnUserPosition"===t.instanceConfiguration.type&&(c=e.extend({},t.instanceConfiguration),t.instance=new r(c))},MapAutoInitialBoundsCouchDbOverlays:i,MapAutoInitialBoundsCouchDbLayers:n}}function o(e){var i=void 0;if(e){var n={type:"configurationGetCurrentSettings"};e.synchronousCall(t,n),i=n.configuration}return i}}(nunaliit2),function(e){var t=e.Class("MapClusterClickToZoom",{customService:void 0,initialize:function(t){var i=e.extend({customService:void 0},t);this.customService=i.customService,this.customService&&this.customService.setOption("mapClusterClickCallback",e.mapAndControls.ZoomInClusterClickCallback),e.log(this._classname,this)}}),i=e.Class("MapClusterClickToMultiSelect",{customService:void 0,initialize:function(t){var i=e.extend({customService:void 0},t);this.customService=i.customService,this.customService&&this.customService.setOption("mapClusterClickCallback",e.mapAndControls.MultiSelectClusterClickCallback),e.log(this._classname,this)}}),n=e.Class("MapClusterClickHandler",{customService:void 0,minimumCountToZoom:void 0,minimumResolutionToZoom:void 0,initialize:function(t){var i=e.extend({customService:void 0,minimumCountToZoom:0,minimumResolutionToZoom:-1},t),n=this;if(this.customService=i.customService,"number"==typeof i.minimumCountToZoom?this.minimumCountToZoom=i.minimumCountToZoom:e.logError("MapClusterClickHandler: minimumCountToZoom must be a number"),"number"==typeof i.minimumResolutionToZoom?this.minimumResolutionToZoom=i.minimumResolutionToZoom:e.logError("MapClusterClickHandler: minimumResolutionToZoom must be a number"),this.customService){this.customService.setOption("mapClusterClickCallback",function(e,t){n._clusterClickCallback(e,t)})}e.log(this._classname,this)},_clusterClickCallback:function(t,i){var n=!1;(t.cluster&&t.cluster.length>=this.minimumCountToZoom&&(n=!0),this.minimumResolutionToZoom>0)&&(i.getResolution()<=this.minimumResolutionToZoom&&(n=!1));n?e.mapAndControls.ZoomInClusterClickCallback(t,i):e.mapAndControls.MultiSelectClusterClickCallback(t,i)}});e.mapUtilities={HandleUtilityCreateRequests:function(e,r,o){if("mapClusterClickToZoom"===e.utilityType){var s={};if("object"==typeof e.utilityOptions)for(var a in e.utilityOptions){var l=e.utilityOptions[a];s[a]=l}e.config&&e.config.directory&&(s.customService=e.config.directory.customService),new t(s),e.created=!0}else if("mapClusterClickToMultiSelect"===e.utilityType){if(s={},"object"==typeof e.utilityOptions)for(var a in e.utilityOptions)l=e.utilityOptions[a],s[a]=l;e.config&&e.config.directory&&(s.customService=e.config.directory.customService),new i(s),e.created=!0}else if("mapClusterClickHandler"===e.utilityType){if(s={},"object"==typeof e.utilityOptions)for(var a in e.utilityOptions)l=e.utilityOptions[a],s[a]=l;e.config&&e.config.directory&&(s.customService=e.config.directory.customService),new n(s),e.created=!0}},MapClusterClickToZoom:t,MapClusterClickToMultiSelect:i,MapClusterClickHandler:n}}(nunaliit2),function(){exports.computePatch=function e(t,i,n){var r={},o=!1,s=function(s){var a="string"==typeof s&&"_"==s.charAt(0)?"_"+s:s;if("number"==typeof a&&(a="_"+a),s in t&&typeof t[s]==typeof i[s]){if("object"==typeof i[s]&&t[s]instanceof Array==i[s]instanceof Array){var l=e(t[s],i[s],n);return void(null!==l&&(o=!0,r[a]=l))}if(t[s]===i[s])return}o=!0,r[a]=function e(t){if(null===t)return null;if("object"!=typeof t)return t;if(t instanceof Array){for(var i=new Array(t.length),n=0;n<i.length;++n)i[n]=e(t[n]);return i}for(var n in i={},t)i[n]=e(t[n]);return i}(i[s]),n&&(t[s]=r[a])};if(i instanceof Array){t.length!=i.length&&(n&&(t.length=i.length),o=!0,r._r=i.length);for(var a=i.length-1;a>=0;--a)s(a)}else{var l=[];for(var a in t)a in i||l.push(a);if(l.length>0&&(o=!0,r._r=1==l.length?l[0]:l,n))for(a=l.length-1;a>=0;--a)delete t[l[a]];for(var a in i)s(a)}return o?r:null},exports.applyPatch=function e(t,i){var n;if("_r"in i){if(t instanceof Array)t.length=i._r;else{var r=i._r;if(r instanceof Array)for(n=0;n<r.length;++n)delete t[r[n]];else delete t[r]}delete i._r}for(n in i){if("string"==typeof n&&n.length>1&&"_"==n.charAt(0)&&"_"==n.charAt(1))var o=n.substring(1);else o="string"==typeof n&&n.length>0&&"_"==n.charAt(0)?1*n.substring(1):n;if(typeof t[o]==typeof i[n]&&"object"==typeof i[n]&&null!=i[n]){if(t[o]instanceof Array==i[n]instanceof Array){e(t[o],i[n]);continue}if(t[o]instanceof Array&&0==i[n]instanceof Array){e(t[o],i[n]);continue}}t[o]=i[n]}}}(),function(e){function t(e,t,i){for(var n,r,o=[],s=0,a=e.length;s<a;s++)o[s]=(n=e[s],r=void 0,r=(Math.round(n/t)*t).toFixed(i),parseFloat(r));return o}var i={precision:1e-5,isLinearRing:!1,isPoint:!1,dropInnerRings:!1};function n(){return{original:{linestrings:0,positions:0},processed:{linestrings:0,positions:0}}}function r(e,t){e.original.positions+=t.original.positions,e.original.linestrings+=t.original.linestrings,e.processed.positions+=t.processed.positions,e.processed.linestrings+=t.processed.linestrings}function o(t,i,n){var r,o,s;s=i,e.isArray(s[0])?(r=i.length,o=e.isDefined(n)?n.length:0):(r=1,o=e.isDefined(n)?1:0),t.original.positions+=r,t.original.linestrings+=1,t.processed.positions+=o,o>0&&(t.processed.linestrings+=1)}e.GeoJsonCoordinatesCompressor=e.Class({options:null,significantDigits:null,initialize:function(){this.options=e.extend({},i);for(var t=0;t<arguments.length;t++){var n=arguments[t];e.isDefined(n)&&(this.options=e.extend(!0,this.options,n))}0===this.options.precision&&(this.options.precision=1e-5),this.significantDigits=function(e){var t=0;if(e<1)for(var i=e;i<1;i*=10,t++);return t}(this.options.precision)},compress:function(i){if(this.options.isPoint)return t(i,this.options.precision,this.significantDigits);if(!e.isArray(i[0]))return i;var n=[],r=t(i[0],this.options.precision,this.significantDigits);n.push(r);for(var o=1,s=i.length-1;o<s;o++){var a=t(i[o],this.options.precision,this.significantDigits);r[0]===a[0]&&r[1]===a[1]||(n.push(a),r=a)}return n.push(t(i[s],this.options.precision,this.significantDigits)),this.options.isLinearRing&&4>n.length?null:2>n.length?null:n}});var s={precision:1e-5};e.GeoJsonGeometryCompressor=e.Class({options:null,linestringCoordCompressor:null,pointCoordCompressor:null,linearRingCoordCompressor:null,coordinateProcessors:null,featureProcessor:null,initialize:function(){this.options=e.extend({},s);for(var t=0;t<arguments.length;t++){var i=arguments[t];e.isDefined(i)&&(this.options=e.extend(!0,this.options,i))}var a;0===this.options.precision&&(this.options.precision=1e-5),this.linestringCoordCompressor=new e.GeoJsonCoordinatesCompressor({precision:this.options.precision}),this.pointCoordCompressor=new e.GeoJsonCoordinatesCompressor({precision:this.options.precision,isPoint:!0}),this.linearRingCoordCompressor=new e.GeoJsonCoordinatesCompressor({precision:this.options.precision,isLinearRing:!0}),(a=this).coordinateProcessors={point:function(e,t){return a.pointCoordCompressor.compress(e)},multipoint:function(e,t){return a.pointCoordCompressor.compress(e)},linestring:function(e,t){return a.linestringCoordCompressor.compress(e)},multilinestring:function(e,t){return a.linestringCoordCompressor.compress(e)},polygon:function(e,t){return a.options.dropInnerRings&&0!==t[t.length-1]?null:a.linearRingCoordCompressor.compress(e)},multipolygon:function(e,t){return a.options.dropInnerRings&&0!==t[t.length-1]?null:a.linearRingCoordCompressor.compress(e)}},this.featureProcessor=new e.GeoJsonFeatureCoordinatesProcessor({coordinateProcessors:this.coordinateProcessors,initialStatus:n,computeStatus:o,accumulateStatus:r})},compressFeature:function(e){return this.featureProcessor.process.feature(e)}})}(nunaliit2),function(e){function t(e,t,i){return{data:null===t?null:{type:e,coordinates:t},status:i}}var i={coordinateProcessors:{point:function(e){return e},multipoint:function(e){return e},linestring:function(e){return e},multilinestring:function(e){return e},polygon:function(e){return e},multipolygon:function(e){return e}},initialStatus:function(){return null},computeStatus:function(e,t,i){},accumulateStatus:function(e,t){},initialContext:function(){return[]},adjustContext:function(e,t){var i;return"down"===t?(i=e.slice(0)).push(0):(e[e.length-1]+=1,i=e),i}};e.GeoJsonFeatureCoordinatesProcessor=e.Class({options:null,process:{},initialize:function(){this.options=e.extend({},i);for(var n=0;n<arguments.length;n++){var r=arguments[n];e.isDefined(r)&&(this.options=e.extend(!0,this.options,r))}var o=this;this.process.feature=function(t){if(null===t)return null;var i=o.options.initialContext(),n={data:{},status:null};for(var r in t)if(t.hasOwnProperty(r))if("geometry"==r){var s=t[r].type,a=o.process[s.toLowerCase()].apply(o,[t[r],o.options.adjustContext(i,"down")]);e.isDefined(a)&&e.isDefined(a.data)?n.data[r]=a.data:n.data=null,n.status=a.status}else e.isDefined(n.data)&&(n.data[r]=t[r]);return n},this.process.point=function(e,i){if(null===e)return null;var n={data:[],status:o.options.initialStatus()},r=o.options.coordinateProcessors.point(e.coordinates,i);return o.options.computeStatus(n.status,e.coordinates,r),t(e.type,r,n.status)},this.process.multipoint=function(i,n){if(null===i)return null;for(var r={data:[],status:o.options.initialStatus()},s=0,a=i.coordinates.length;s<a;++s){var l=o.options.coordinateProcessors.multipoint(i.coordinates[s],n);e.isDefined(l)&&r.data.push(l),o.options.computeStatus(r.status,i.coordinates[s],l),o.options.adjustContext(n,"lateral")}return 0===r.data.length&&(r.data=null),t(i.type,r.data,r.status)},this.process.linestring=function(e,i){if(null===e)return null;var n={data:[],status:o.options.initialStatus()},r=o.options.coordinateProcessors.linestring(e.coordinates,i);return o.options.computeStatus(n.status,e.coordinates,r),t(e.type,r,n.status)},this.process.multilinestring=function(i,n){if(null===i)return null;for(var r={data:[],status:o.options.initialStatus()},s=0,a=i.coordinates.length;s<a;++s){var l=o.options.coordinateProcessors.multilinestring(i.coordinates[s],n);e.isDefined(l)&&r.data.push(l),o.options.computeStatus(r.status,i.coordinates[s],l),o.options.adjustContext(n,"lateral")}return 0===r.data.length&&(r.data=null),t(i.type,r.data,r.status)},this.process.polygon=function(i,n){if(null===i)return null;for(var r={data:[],status:o.options.initialStatus()},s=0,a=i.coordinates.length;s<a;++s){var l=o.options.coordinateProcessors.polygon(i.coordinates[s],n);e.isDefined(l)&&r.data.push(l),o.options.computeStatus(r.status,i.coordinates[s],l),o.options.adjustContext(n,"lateral")}return 0===r.data.length&&(r.data=null),t(i.type,r.data,r.status)},this.process.multipolygon=function(i,n){if(null===i)return null;for(var r={data:[],status:o.options.initialStatus()},s=0,a=i.coordinates.length;s<a;++s){for(var l=[],c=o.options.adjustContext(n,"down"),d=0,u=i.coordinates[s].length;d<u;d++){var h=o.options.coordinateProcessors.multipolygon(i.coordinates[s][d],c);e.isDefined(h)&&l.push(h),o.options.computeStatus(r.status,i.coordinates[s][d],h),o.options.adjustContext(c,"lateral")}0!==l.length&&r.data.push(l),o.options.adjustContext(n,"lateral")}return 0===r.data.length&&(r.data=null),t(i.type,r.data,r.status)},this.process.geometrycollection=function(t,i){if(null===t)return null;for(var n={data:[],status:o.options.initialStatus()},r=0,s=t.geometries.length;r<s;r++){var a=t.geometries[r].type,l=o.process[a.toLowerCase()].apply(o,[t.geometries[r],o.options.adjustContext(i,"down")]);e.isDefined(l)&&e.isDefined(l.data)&&n.data.push(l.data),o.options.accumulateStatus(n.status,l.status),o.options.adjustContext(i,"lateral")}return{data:0===n.data.length?null:{type:t.type,geometries:n.data},status:n.status}}}})}(nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.languageSupport",r=[{code:"en",name:"English"},{code:"fr",name:"Français"}],o=void 0,s=t.Class({elemId:null,dispatcher:null,languages:null,languageService:null,initialize:function(i){var n=t.extend({elem:null,elemId:null,dispatcher:null,languages:null,languageService:null},i);if(this.elemId=n.elemId,n.elem){var r=e(n.elem),o=r.attr("id");o||(o=t.getUniqueId(),r.attr("id",o)),this.elemId=o}this.dispatcher=n.dispatcher,this.languages=n.languages,this.languageService=n.languageService,this._display()},_getLanguages:function(){return this.languageService?this.languageService.getLanguages():this.languages?this.languages:r},_getElem:function(){return e("#"+this.elemId)},_display:function(){var t=this,n=this._getElem();n.empty(),e("<a>").text(i("Language")).attr("href","#").appendTo(n).click(function(){return t._dialog(),!1})},_dialog:function(){for(var n=this,r=t.getUniqueId(),o=e('<div id="'+r+'" class="n2lang_langSelect_dialog"></div>'),s=e('<div class="n2lang_langSelect_list"></div>').appendTo(o),a=function(t){var i=e(this);if(i.is(":checked")){var o=i.attr("n2Code");n._selectLanguage(o),e("#"+r).dialog("close")}return!1},l=this._getLanguages(),c=0,d=l.length;c<d;++c){var u=l[c];p(s,u.name,u.code)}p(s,i("Default"),null);var h={autoOpen:!0,title:i("Select Language"),modal:!0,width:740,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};function p(i,n,r){var o=e("<div/>").appendTo(i),s=t.getUniqueId(),l=e('<input type="radio" name="languageSelect"/>').attr("id",s).appendTo(o).change(a);r&&l.attr("n2Code",r),t.l10n.getLocale().lang===r&&l.attr("checked","checked"),e("<label/>").attr("for",s).text(n).appendTo(o)}o.dialog(h)},_selectLanguage:function(e){this.dispatcher&&this.dispatcher.send(n,{type:"languageSelect",lang:e})}}),a=t.Class({elemId:null,dispatcher:null,languages:null,languageService:null,initialize:function(i){var n=t.extend({elem:null,elemId:null,dispatcher:null,languages:null,languageService:null},i);if(this.elemId=n.elemId,n.elem){var r=e(n.elem),o=r.attr("id");o||(o=t.getUniqueId(),r.attr("id",o)),this.elemId=o}this.dispatcher=n.dispatcher,this.languages=n.languages,this.languageService=n.languageService,this._display()},_getLanguages:function(){return this.languageService?this.languageService.getLanguages():this.languages?this.languages:r},_getElem:function(){return e("#"+this.elemId)},_display:function(){var t=this,i=this._getElem();i.empty();var n=this._pickLanguageToDisplay();n&&e("<a>").text(n.name).attr("href","#").appendTo(i).click(function(){return t._selectLanguage(n.code),!1})},_pickLanguageToDisplay:function(){var e=t.l10n.getLocale(),i=null;e&&(i=e.lang);for(var n=this._getLanguages(),r=0,o=n.length;r<o;++r){var s=n[r];if(s.code!==i)return s}return null},_selectLanguage:function(e){this.dispatcher&&this.dispatcher.send(n,{type:"languageSelect",lang:e})}}),l=t.Class({dispatcher:null,languages:null,useToggleWidget:null,initialize:function(e){var i=t.extend({directory:null,languages:null},e),s=this;o=this,i.directory&&(this.dispatcher=i.directory.dispatchService),this.languages=i.languages,this.languages||(this.languages=r.slice(0)),this.useToggleWidget=!1;var a=this.dispatcher;if(a){a.register(n,"languageSelect",function(e){s._handle(e)})}},getLanguages:function(){return this.languages},addLanguage:function(e){e.name&&e.code&&this.languages.push(e)},setUseToggleWidget:function(e){this.useToggleWidget=e},drawWidget:function(e){var i=t.extend({elem:null,elemId:null},e,{dispatcher:this.dispatcher,languageService:this});return this.useToggleWidget?new a(i):new s(i)},_send:function(e){var t=this.dispatcher;t&&t.send(n,e)},_handle:function(e){"languageSelect"===e.type&&(e.lang?this._selectLanguage(e.lang):this._resetLanguage())},_selectLanguage:function(e){t.cookie.setCookie({name:"nunaliit-l10n",value:e,path:"/"}),location.reload()},_resetLanguage:function(){t.cookie.deleteCookie("nunaliit-l10n"),location.reload()}});t.languageSupport={LanguageService:l,LanguageSwitcher:s,LanguageToggler:a,getLanguages:function(){return o?o.getLanguages():r}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n=t.Class({service:null,inputId:null,options:null,initialize:function(i){var n=t.extend({service:null,input:null,autocomplete:null},i),r=this;this.service=n.service;var o=null;if("string"==typeof n.input)o=e("#"+n.input),this.inputId=n.input;else{var s=(o=e(n.input)).attr("id");s||(s=t.getUniqueId(),o.attr("id",s)),this.inputId=s}for(var a in this.options={featureClass:t.GeoNames.FeatureClass.PLACES,maxRows:12},n)"service"===a||"input"===a||"autocomplete"===a||(this.options[a]=n[a]);var l=t.extend({minLength:3},n.autocomplete,{open:function(){e(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){e(this).removeClass("ui-corner-top").addClass("ui-corner-all")},source:function(e,t){r._autocompleteSource(e,t)}});(o=this.getInput()).autocomplete(l)},getInput:function(){return e("#"+this.inputId)},_autocompleteSource:function(e,i){if(e&&e.term&&e.term.length>2){var n=t.extend({},this.options);n.name=e.term,n.onSuccess=function(e){for(var t=[],n={},r=0,o=e.length;r<o;++r){var s=e[r],a=s.name;if(!n[a]){var l={label:s.name,value:s.name};t[t.length]=l,n[a]=!0}}i(t)},n.onError=function(e){t.log("Error encountered during GeoService lookup: "+e,e),i([])},this.service.getNameStartsWith(n)}}}),r=t.Class({options:null,initialize:function(e){this.options=t.extend({geoNamesUrl:"http://api.geonames.org/",username:"nunaliit"},e)},getName:function(e){var n=t.extend({name:null,featureClass:null,maxRows:null,country:null,countryBias:null,style:null,onSuccess:function(e){},onError:function(e){}},e),r={name:n.name};this._processGeoNamesSearchOptions(r,n),this._getGeoNames("searchJSON",r,function(e){e.geonames?n.onSuccess(e.geonames):(t.log("Invalid result returned by GeoNames",e),n.onError(i("Invalid result returned by GeoNames")))},n.onError)},getNameStartsWith:function(e){var n=t.extend({name:null,featureClass:null,maxRows:null,country:null,countryBias:null,style:null,onSuccess:function(e){},onError:function(e){}},e),r={name_startsWith:n.name};this._processGeoNamesSearchOptions(r,n),this._getGeoNames("searchJSON",r,function(e){e.geonames?n.onSuccess(e.geonames):(t.log("Invalid result returned by GeoNames",e),n.onError(i("Invalid result returned by GeoNames")))},n.onError)},findNearby:function(e){var n=t.extend({lng:null,lat:null,featureClass:null,featureCode:null,lang:null,radius:null,maxRows:null,style:null,localCountry:null,cities:null,onSuccess:function(e){},onError:function(e){}},e),r={lng:n.lng,lat:n.lat};n.maxRows&&(r.maxRows=n.maxRows),this._getGeoNames("findNearbyJSON",r,function(e){e.geonames?n.onSuccess(e.geonames):(t.log("Invalid result returned by GeoNames",e),n.onError(i("Invalid result returned by GeoNames")))},n.onError)},installAutoComplete:function(e){var i=t.extend({input:null},e);return i.service=this,new n(i)},_processGeoNamesSearchOptions:function(e,t){t.featureClass&&(e.featureClass=t.featureClass),"number"==typeof t.maxRows&&(e.maxRows=t.maxRows),t.country&&(e.country=t.country),t.countryBias&&(e.countryBias=t.countryBias),t.style&&(e.style=t.style)},_getGeoNames:function(t,i,n,r){var o={};for(var s in i)s&&i[s]&&(o[s]=i[s]);o.username=this.options.username,e.ajax({url:this.options.geoNamesUrl+t,dataType:"json",data:o,traditional:!0,success:n,error:function(e,t){r(t)}})}});t.GeoNames={Service:r,FeatureClass:{ADMIN:"A",HYDRO:"H",LANDMARKS:"L",PLACES:"P",ROADS:"R",SPOT:"S",MOUNTAINS:"T",UNDERSEA:"U"}}}(jQuery,nunaliit2),function(e){var t={};var i=e.Class("DocumentSource",{id:null,initialize:function(i){var n=e.extend({id:null},i);this.id=n.id,this.id||(this.id=e.getUniqueId()),this.id&&(t[this.id]=this)},getId:function(){return this.id},adoptDocument:function(e){throw new Error("Subclasses must implement adoptDocument(doc)")},createDocument:function(t){e.extend({doc:{},onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "createDocument" call.')},getDocument:function(t){e.extend({docId:null,rev:null,revs_info:!1,revisions:!1,conflicts:!1,deleted_conflicts:!1,onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "getDocument" call.')},getDocuments:function(t){e.extend({docIds:null,onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "getDocuments" call.')},getDocumentAttachments:function(e){throw new Error("Subclasses must implement getDocumentAttachments(doc)")},getDocumentAttachment:function(e,t){throw new Error("Subclasses must implement getDocumentAttachment(doc,attachmentName)")},getDocumentAttachmentUrl:function(e,t){throw new Error("Subclasses must implement getDocumentAttachmentUrl(doc,attachmentName)")},verifyDocumentExistence:function(t){e.extend({docIds:null,onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "verifyDocumentExistence" call.')},updateDocument:function(t){e.extend({doc:null,onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "updateDocument" call.')},deleteDocument:function(t){e.extend({doc:null,onSuccess:function(){},onError:function(e){}},t).onError('Data source does not support the "deleteDocument" call.')},getLayerDefinitions:function(t){e.extend({onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "getLayerDefinitions" call.')},getDocumentInfoFromIds:function(t){e.extend({docIds:null,onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "getDocumentInfoFromIds" call.')},getReferencesFromId:function(t){e.extend({docId:null,onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "getReferencesFromId" call.')},getProductFromId:function(t){e.extend({docId:null,onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "getProductFromId" call.')},getDocumentsFromGeographicFilter:function(t){e.extend({docIds:null,layerId:null,bbox:null,projectionCode:null,onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "getDocumentsFromGeographicFilter" call.')},getGeographicBoundingBox:function(t){e.extend({layerId:null,bbox:null,onSuccess:function(e){},onError:function(e){}},t).onError('Data source does not support the "getGeographicBoundingBox" call.')}});e.document={DocumentSource:i,getDocumentSourceFromDocument:function(t){var i=e.extend({doc:null,dispatchService:null,dispatchHandle:"n2.document"},t),n=i.doc,r=i.dispatchService;if(n&&r){var o={type:"documentSourceFromDocument",doc:i.doc};return i.dispatchService.synchronousCall(i.dispatchHandle,o),o.documentSource}},getDocumentSourceFromId:function(e){return t[e]},clone:function(t){var i={};for(var n in t)i[n]="__n2Source"===n?t[n]:e.deepCopy(t[n]);return i}}}(nunaliit2),function(e){function t(e){if(null===e)return"x";if("string"==typeof e){var t=[];t.push("s");for(var i=0,n=e.length;i<n;++i){var r=e[i];if(r>="a"&&r<="z")t.push(r);else if(r>="A"&&r<="Z")t.push(r);else if(r>="0"&&r<="9")t.push(r);else{var o=r.charCodeAt(0),s=48+(7&o),a=48+(o>>3&7),l=48+(o>>6&7);t.push("_"),t.push(String.fromCharCode(l)),t.push(String.fromCharCode(a)),t.push(String.fromCharCode(s))}}return t.join("")}return"number"==typeof e?e>=0?"p"+e:"n"+-1*e:"boolean"==typeof e?e?"t":"f":"u"}function i(e){if(e&&!(e.length<1)&&"u"!==e[0]){if("t"===e[0])return!0;if("f"===e[0])return!1;if("x"===e[0])return null;if("p"===e[0])return 1*e.substr(1);if("n"===e[0])return-1*e.substr(1);if("s"===e[0]){for(var t=[],i=1,n=e.length;i<n;++i){var r=e[i];if("_"===r){++i;var o=e.charCodeAt(i);++i;var s=e.charCodeAt(i);++i;var a=(o-48<<6)+(s-48<<3)+(e.charCodeAt(i)-48);t.push(String.fromCharCode(a))}else t.push(r)}return t.join("")}}}var n=e.Class({selectors:null,initialize:function(t){if(!e.isArray(t))throw new Error("Instances of ObjectSelector must be created using an array");this.selectors=t},getChildSelector:function(t){var i=null;if("string"==typeof t)i=t;else{if("number"!=typeof t){var r;if("object"==typeof t&&e.isArray(t))return(r=this.selectors.slice()).push.apply(r,t),new n(r);if("object"==typeof t&&"object"==typeof t.selectors&&e.isArray(t.selectors))return(r=this.selectors.slice()).push.apply(r,t.selectors),new n(r);throw new Error("A string or number must be provided when creating a child selector")}i=t}return(r=this.selectors.slice()).push(i),new n(r)},getValue:function(e){if(this.selectors.length<1)return e;if(void 0===e)return e;if(null!==e&&"object"==typeof e){for(var t=e,i=0,n=this.selectors.length;i<n;++i){var r=this.selectors[i];if(null===t)return;if(void 0===t[r])return;t=t[r]}return t}},setValue:function(e,t,i){if(void 0===t)return this.removeValue(e);var n=void 0!==i&&i;if("object"!=typeof e)return!1;if(this.selectors.length<1)return!1;for(var r=e,o=0,s=this.selectors.length-1;o<s;++o){var a=this.selectors[o];if(void 0===r[a]){if(!n)return!1;r[a]={}}else if("object"!=typeof r[a])return!1;r=r[a]}return r[this.selectors[this.selectors.length-1]]=t,!0},removeValue:function(e){if("object"!=typeof e)return!1;if(this.selectors.length<1)return!1;for(var t=e,i=0,n=this.selectors.length-1;i<n;++i){var r=this.selectors[i];if(void 0===t[r])return!1;if("object"!=typeof t[r])return!1;t=t[r]}var o=this.selectors[this.selectors.length-1];return void 0!==t[o]&&(delete t[o],!0)},getParentSelector:function(){if(this.selectors.length<1)return null;if(1===this.selectors.length)return new n([]);var e=this.selectors.slice(0,this.selectors.length-1);return new n(e)},getKey:function(){if(!(this.selectors.length<1))return this.selectors[this.selectors.length-1]},getSelectorString:function(){return this.selectors.join(".")},encodeForDomAttribute:function(){for(var e=[],i=0,n=this.selectors.length;i<n;++i){var r=t(this.selectors[i]);e.push(r)}return e.join("-")},traverse:function(e,t){if("object"!=typeof e)throw new Error("objectSelector.traverse() needs an object");if("function"!=typeof t)throw new Error("objectSelector.traverse() needs a callback function");var i=this.getValue(e);void 0!==i&&(t(i,this),function e(t,i,n){for(var r in t){var o=t[r],s=n.getChildSelector(r);i(o,s),"object"==typeof o&&null!==o&&e(o,i,s)}}(i,t,this))}});e.objectSelector={ObjectSelector:n,parseSelector:function(e){var t=e.split(".");return new n(t)},decodeFromDomAttribute:function(e){var t=[];if(e&&e.length>0)for(var r=e.split("-"),o=0,s=r.length;o<s;++o){var a=i(r[o]);t.push(a)}return new n(t)},findSelectors:function(e,t){if("object"!=typeof e)throw new Error("objectSelector.findSelectors() needs an object");if("function"!=typeof t)throw new Error("objectSelector.findSelectors() needs a test function");var i=[],r=new n([]);return t(e)&&i.push(r),function e(t,i,n,r){for(var o in t){var s=t[o];if(i(s)){var a=r.getChildSelector(o);n.push(a)}"object"==typeof s&&e(s,i,n,a=r.getChildSelector(o))}}(e,t,i,r),i}}}(nunaliit2),function(e){var t="n2.userIntentView",i=e.Class({dispatchService:null,listeners:null,hoverInfo:null,selectInfo:null,findInfo:null,nodesArrayById:null,initialize:function(i){var n=e.extend({dispatchService:null,suppressFindEvent:!1},i),r=this;if(this.dispatchService=n.dispatchService,this.listeners=[],this.nodesArrayById={},this.hoverInfo=null,this.selectInfo=null,this.findInfo=null,this.dispatchService){var o=function(e){r._handleDispatch(e)};this.dispatchService.register(t,"selected",o),this.dispatchService.register(t,"selectedSupplement",o),this.dispatchService.register(t,"unselected",o),this.dispatchService.register(t,"focusOn",o),this.dispatchService.register(t,"focusOnSupplement",o),this.dispatchService.register(t,"focusOff",o),this.dispatchService.register(t,"searchInitiate",o),n.suppressFindEvent||this.dispatchService.register(t,"find",o)}},addListener:function(e){this.listeners.push(e)},addNodes:function(e){for(var t=0,i=e.length;t<i;++t){var n=e[t],r=n.n2_id,o=this.nodesArrayById[r];o||(o=[],this.nodesArrayById[r]=o),o.indexOf(n)<0&&o.push(n),this._adjustIntentOnNode(n)}},removeNodes:function(e){for(var t=0,i=e.length;t<i;++t){var n=e[t],r=n.n2_id,o=this.nodesArrayById[r];if(o){var s=o.indexOf(n);s>=0&&(o.length<2?delete this.nodesArrayById[r]:this.nodesArrayById[r].splice(s,1))}}},_adjustIntentOnNode:function(e){var t=!1,i=e.n2_id,n=!1,r=null;this.selectInfo&&this.selectInfo.docIds&&((a=this.selectInfo.docIds[i])&&(n=!0,"string"==typeof a&&(r=a)));e.n2_selected!==n&&(e.n2_selected=n,t=!0),e.n2_selectedIntent!==r&&(e.n2_selectedIntent=r,t=!0);var o=!1,s=null;this.hoverInfo&&this.hoverInfo.docIds&&((a=this.hoverInfo.docIds[i])&&(o=!0,"string"==typeof a&&(s=a)));e.n2_hovered!==o&&(e.n2_hovered=o,t=!0),e.n2_hoveredIntent!==s&&(e.n2_hoveredIntent=s,t=!0);var a,l=!1;this.findInfo&&((a=this.findInfo[i])&&(l=!0));e.n2_found!==l&&(e.n2_found=l,t=!0);var c=s;return c||(c=r),e.n2_intent!==c&&(e.n2_intent=c,t=!0),t},_performUnselect:function(e){var t={};if(this.selectInfo&&this.selectInfo.docIds)for(var i in this.selectInfo.docIds)t[i]=!0;if(this.findInfo)for(var i in this.findInfo)t[i]=!0;for(var i in this.selectInfo=null,this.findInfo=null,t){var n=this.nodesArrayById[i];if(n)for(var r=0,o=n.length;r<o;++r){var s=n[r];this._adjustIntentOnNode(s)&&e.push(s)}}},_performFocusOff:function(e){if(this.hoverInfo&&this.hoverInfo.docIds){var t=this.hoverInfo.docIds;for(var i in this.hoverInfo=null,t){var n=this.nodesArrayById[i];if(n)for(var r=0,o=n.length;r<o;++r){var s=n[r];this._adjustIntentOnNode(s)&&e.push(s)}}}this.hoverInfo=null},_handleSelect:function(e){var t=[];this._performUnselect(t),this.selectInfo={docIds:{}};for(var i=0,n=e.length;i<n;++i){var r=e[i];this.selectInfo.docIds[r]=!0;var o=this.nodesArrayById[r];if(o)for(var s=0,a=o.length;s<a;++s){var l=o[s];this._adjustIntentOnNode(l)&&t.push(l)}}t.length>0&&this._reportChangedNodes(t)},_handleSelectSupplement:function(e,t){var i=[];if(this.selectInfo&&this.selectInfo.docIds){this.selectInfo.docIds[e]=t||!0;var n=this.nodesArrayById[e];if(n)for(var r=0,o=n.length;r<o;++r){var s=n[r];this._adjustIntentOnNode(s)&&i.push(s)}}i.length>0&&this._reportChangedNodes(i)},_handleUnselect:function(){var e=[];this._performUnselect(e),e.length>0&&this._reportChangedNodes(e)},_handleFind:function(e){var t=[],i=[];if(this.findInfo)for(var n in this.findInfo){var r=this.nodesArrayById[n];i.push.apply(i,r)}this.findInfo={},this.findInfo[e]=!0;for(var o=0,s=i.length;o<s;++o){var a=i[o];this._adjustIntentOnNode(a)&&t.push(a)}if(r=this.nodesArrayById[e])for(var l=0,c=r.length;l<c;++l){a=r[l];this._adjustIntentOnNode(a)&&t.push(a)}t.length>0&&this._reportChangedNodes(t)},_handleFocusOn:function(e){var t=[];if(this._performFocusOff(t),this.hoverInfo={originMap:{},docIds:{}},e)for(var i=0,n=e.length;i<n;++i){var r=e[i];this.hoverInfo.originMap[r]=!0,this.hoverInfo.docIds[r]=!0;var o=this.nodesArrayById[r];if(o)for(var s=0,a=o.length;s<a;++s){var l=o[s];this._adjustIntentOnNode(l)&&t.push(l)}}t.length>0&&this._reportChangedNodes(t)},_handleFocusOnSupplement:function(e,t){var i=[];if(this.hoverInfo&&this.hoverInfo.docIds){this.hoverInfo.docIds[e]=t||!0;var n=this.nodesArrayById[e];if(n)for(var r=0,o=n.length;r<o;++r){var s=n[r];this._adjustIntentOnNode(s)&&i.push(s)}}i.length>0&&this._reportChangedNodes(i)},_handleFocusOff:function(){var e=[];this._performFocusOff(e),e.length>0&&this._reportChangedNodes(e)},_handleDispatch:function(t){if("selected"===t.type)if(t.docId){var i=t.docId;this._handleSelect([i])}else if(t.docIds)this._handleSelect(t.docIds);else if(t.doc){i=t.doc._id;this._handleSelect([i])}else if(t.docs){for(var n=[],r=0,o=t.docs.length;r<o;++r){var s=t.docs[r];n.push(s._id)}this._handleSelect(n)}else e.log('UserIntentView unable to handle "selected" event',t);else if("selectedSupplement"===t.type){i=t.docId;var a=t.intent;this._handleSelectSupplement(i,a)}else if("unselected"===t.type)this._handleUnselect();else if("focusOn"===t.type)t.docId?this._handleFocusOn([t.docId]):t.docIds&&this._handleFocusOn(t.docIds);else if("focusOnSupplement"===t.type){i=t.docId,a=t.intent;var l=!0;t.origin&&(l=!1,this.hoverInfo&&this.hoverInfo.originMap&&this.hoverInfo.originMap[t.origin]&&(l=!0)),i&&l&&this._handleFocusOnSupplement(i,a)}else if("focusOff"===t.type)this._handleFocusOff();else if("searchInitiate"===t.type)this._handleUnselect();else if("find"===t.type){i=t.docId;this._handleFind(i)}},_reportChangedNodes:function(e){for(var t=0,i=this.listeners.length;t<i;++t){(0,this.listeners[t])(e)}}}),n=e.Class({dispatchService:null,hoverInfo:null,selectInfo:null,findInfo:null,nodesById:null,initialize:function(i){var n=e.extend({dispatchService:null,suppressFindEvent:!1},i),r=this;if(this.dispatchService=n.dispatchService,this.nodesById={},this.hoverInfo=null,this.selectInfo=null,this.findInfo=null,this.dispatchService){var o=function(e){r._handleDispatch(e)};this.dispatchService.register(t,"selected",o),this.dispatchService.register(t,"selectedSupplement",o),this.dispatchService.register(t,"unselected",o),this.dispatchService.register(t,"focusOn",o),this.dispatchService.register(t,"focusOnSupplement",o),this.dispatchService.register(t,"focusOff",o),this.dispatchService.register(t,"searchInitiate",o),n.suppressFindEvent||this.dispatchService.register(t,"find",o),this.dispatchService.register(t,"userIntentGetCurrent",o)}},_getNode:function(e){var t=this.nodesById[e];return t||(t={n2_id:e},this.nodesById[e]=t),t},_adjustIntentOnNode:function(e){var t=!1,i=e.n2_id,n=!0,r=!1,o=null;this.selectInfo&&this.selectInfo.docIds&&((l=this.selectInfo.docIds[i])&&(r=!0,n=!1,"string"==typeof l&&(o=l)));e.n2_selected!==r&&(e.n2_selected=r,t=!0),e.n2_selectedIntent!==o&&(e.n2_selectedIntent=o,t=!0);var s=!1,a=null;this.hoverInfo&&this.hoverInfo.docIds&&((l=this.hoverInfo.docIds[i])&&(s=!0,n=!1,"string"==typeof l&&(a=l)));e.n2_hovered!==s&&(e.n2_hovered=s,t=!0),e.n2_hoveredIntent!==a&&(e.n2_hoveredIntent=a,t=!0);var l,c=!1;this.findInfo&&((l=this.findInfo[i])&&(c=!0,n=!1));e.n2_found!==c&&(e.n2_found=c,t=!0);var d=a;return d||(d=o),e.n2_intent!==d&&(e.n2_intent=d,t=!0),n&&(e.n2_stale=n,t=!0),t},_performUnselect:function(e){var t={};if(this.selectInfo&&this.selectInfo.docIds)for(var i in this.selectInfo.docIds)t[i]=!0;if(this.findInfo)for(var i in this.findInfo)t[i]=!0;for(var i in this.selectInfo=null,this.findInfo=null,t){var n=this._getNode(i);this._adjustIntentOnNode(n)&&e.push(n)}},_performFocusOff:function(e){if(this.hoverInfo&&this.hoverInfo.docIds){var t=this.hoverInfo.docIds;for(var i in this.hoverInfo=null,t){var n=this._getNode(i);this._adjustIntentOnNode(n)&&e.push(n)}}this.hoverInfo=null},_handleSelect:function(e){var t=[];this._performUnselect(t),this.selectInfo={docIds:{}};for(var i=0,n=e.length;i<n;++i){var r=e[i];this.selectInfo.docIds[r]=!0;var o=this._getNode(r);this._adjustIntentOnNode(o)&&t.push(o)}t.length>0&&this._reportChangedNodes(t)},_handleSelectSupplement:function(e,t){var i=[];if(this.selectInfo&&this.selectInfo.docIds){this.selectInfo.docIds[e]=t||!0;var n=this._getNode(e);this._adjustIntentOnNode(n)&&i.push(n)}i.length>0&&this._reportChangedNodes(i)},_handleUnselect:function(){var e=[];this._performUnselect(e),e.length>0&&this._reportChangedNodes(e)},_handleFind:function(e){var t=[],i=[];if(this.findInfo)for(var n in this.findInfo){var r=this._getNode(n);i.push(r)}this.findInfo={},this.findInfo[e]=!0;for(var o=0,s=i.length;o<s;++o){r=i[o];this._adjustIntentOnNode(r)&&t.push(r)}r=this._getNode(e);this._adjustIntentOnNode(r)&&t.push(r),t.length>0&&this._reportChangedNodes(t)},_handleFocusOn:function(e){var t=[];if(this._performFocusOff(t),this.hoverInfo={originMap:{},docIds:{}},e)for(var i=0,n=e.length;i<n;++i){var r=e[i];this.hoverInfo.originMap[r]=!0,this.hoverInfo.docIds[r]=!0;var o=this._getNode(r);this._adjustIntentOnNode(o)&&t.push(o)}t.length>0&&this._reportChangedNodes(t)},_handleFocusOnSupplement:function(e,t){var i=[];if(this.hoverInfo&&this.hoverInfo.docIds){this.hoverInfo.docIds[e]=t||!0;var n=this._getNode(e);this._adjustIntentOnNode(n)&&i.push(n)}i.length>0&&this._reportChangedNodes(i)},_handleFocusOff:function(){var e=[];this._performFocusOff(e),e.length>0&&this._reportChangedNodes(e)},_handleDispatch:function(t){if("selected"===t.type)if(t.docId){var i=t.docId;this._handleSelect([i])}else if(t.docIds)this._handleSelect(t.docIds);else if(t.doc){i=t.doc._id;this._handleSelect([i])}else if(t.docs){for(var n=[],r=0,o=t.docs.length;r<o;++r){var s=t.docs[r];n.push(s._id)}this._handleSelect(n)}else e.log('UserIntentService unable to handle "selected" event',t);else if("selectedSupplement"===t.type){i=t.docId;var a=t.intent;this._handleSelectSupplement(i,a)}else if("unselected"===t.type)this._handleUnselect();else if("focusOn"===t.type)t.docId?this._handleFocusOn([t.docId]):t.docIds&&this._handleFocusOn(t.docIds);else if("focusOnSupplement"===t.type){i=t.docId,a=t.intent;var l=!0;t.origin&&(l=!1,this.hoverInfo&&this.hoverInfo.originMap&&this.hoverInfo.originMap[t.origin]&&(l=!0)),i&&l&&this._handleFocusOnSupplement(i,a)}else if("focusOff"===t.type)this._handleFocusOff();else if("searchInitiate"===t.type)this._handleUnselect();else if("find"===t.type){i=t.docId;this._handleFind(i)}else"userIntentGetCurrent"===t.type&&(t.intentMap=this.nodesById)},_reportChangedNodes:function(e){this.dispatchService.send(t,{type:"userIntentChanged",intentMap:this.nodesById,changes:e});for(var i=0,n=e.length;i<n;++i){var r=e[i];if(r.n2_stale){var o=r.n2_id;delete this.nodesById[o]}}}});e.userIntentView={IntentView:i,IntentService:n}}(nunaliit2),function(e){var t=function(){var e=function(e,t,i,n){for(i=i||{},n=e.length;n--;i[e[n]]=t);return i},t=[1,3],i=[1,4],n=[1,6],r=[1,7],o=[1,8],s=[1,9],a=[1,10],l=[1,12],c=[1,13],d=[1,14],u=[1,15],h=[1,16],p=[1,17],f=[1,18],m=[1,19],v=[1,20],g=[1,21],y=[1,22],_=[1,23],S=[1,24],b=[5,6,7,10,11,12,13,14,15,16,23,24,25,26,27,28,32],I=[5,6,7,9,10,11,12,13,14,15,16,23,24,25,26,27,28,29,31,32],C=[5,6,7,10,28,32],D=[5,6,7,10,11,12,13,14,15,16,28,32],w=[5,6,7,10,11,12,13,14,15,16,23,24,28,32],E={trace:function(){},yy:{},symbols_:{error:2,program:3,value:4,EOF:5,"&&":6,"||":7,"!":8,"(":9,")":10,"==":11,"!=":12,">=":13,"<=":14,">":15,"<":16,identifier:17,arguments:18,true:19,false:20,NUMBER:21,STRING:22,"+":23,"-":24,"*":25,"/":26,"%":27,",":28,".":29,VAR_NAME:30,"[":31,"]":32,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",6:"&&",7:"||",8:"!",9:"(",10:")",11:"==",12:"!=",13:">=",14:"<=",15:">",16:"<",19:"true",20:"false",21:"NUMBER",22:"STRING",23:"+",24:"-",25:"*",26:"/",27:"%",28:",",29:".",30:"VAR_NAME",31:"[",32:"]"},productions_:[0,[3,2],[4,3],[4,3],[4,2],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,4],[4,1],[4,1],[4,1],[4,1],[4,1],[4,3],[4,3],[4,3],[4,3],[4,3],[18,3],[18,1],[17,3],[17,4],[17,1]],performAction:function(e,t,i,n,r,o,s){var a=o.length-1;switch(r){case 1:return o[a-1];case 2:this.$=new L(o[a-2],"&&",o[a]);break;case 3:this.$=new L(o[a-2],"||",o[a]);break;case 4:this.$=new L(o[a],"!");break;case 5:this.$=o[a-1];break;case 6:this.$=new O(o[a-2],o[a],"==");break;case 7:this.$=new O(o[a-2],o[a],"!=");break;case 8:this.$=new O(o[a-2],o[a],">=");break;case 9:this.$=new O(o[a-2],o[a],"<=");break;case 10:this.$=new O(o[a-2],o[a],">");break;case 11:this.$=new O(o[a-2],o[a],"<");break;case 12:this.$=new T(o[a-2],null);break;case 13:this.$=new T(o[a-3],o[a-1]);break;case 14:this.$=o[a];break;case 15:this.$=new M(!0);break;case 16:this.$=new M(!1);break;case 17:this.$=new M(1*o[a]);break;case 18:this.$=new M(o[a]);break;case 19:this.$=new A(o[a-2],o[a],"+");break;case 20:this.$=new A(o[a-2],o[a],"-");break;case 21:this.$=new A(o[a-2],o[a],"*");break;case 22:this.$=new A(o[a-2],o[a],"/");break;case 23:this.$=new A(o[a-2],o[a],"%");break;case 24:this.$=new k(o[a-2],o[a]);break;case 25:this.$=new k(o[a]);break;case 26:var l=new M(o[a]);this.$=new F(l,o[a-2]);break;case 27:this.$=new F(o[a-1],o[a-3]);break;case 28:this.$=new R(o[a])}},table:[{3:1,4:2,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{1:[3]},{5:[1,11],6:l,7:c,11:d,12:u,13:h,14:p,15:f,16:m,23:v,24:g,25:y,26:_,27:S},{4:25,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:26,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},e(b,[2,14],{9:[1,27],29:[1,28],31:[1,29]}),e(b,[2,15]),e(b,[2,16]),e(b,[2,17]),e(b,[2,18]),e(I,[2,28]),{1:[2,1]},{4:30,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:31,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:32,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:33,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:34,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:35,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:36,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:37,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:38,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:39,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:40,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:41,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},{4:42,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},e(b,[2,4]),{6:l,7:c,10:[1,43],11:d,12:u,13:h,14:p,15:f,16:m,23:v,24:g,25:y,26:_,27:S},{4:46,8:t,9:i,10:[1,44],17:5,18:45,19:n,20:r,21:o,22:s,30:a},{30:[1,47]},{4:48,8:t,9:i,17:5,19:n,20:r,21:o,22:s,30:a},e(C,[2,2],{11:d,12:u,13:h,14:p,15:f,16:m,23:v,24:g,25:y,26:_,27:S}),e(C,[2,3],{11:d,12:u,13:h,14:p,15:f,16:m,23:v,24:g,25:y,26:_,27:S}),e(D,[2,6],{23:v,24:g,25:y,26:_,27:S}),e(D,[2,7],{23:v,24:g,25:y,26:_,27:S}),e(D,[2,8],{23:v,24:g,25:y,26:_,27:S}),e(D,[2,9],{23:v,24:g,25:y,26:_,27:S}),e(D,[2,10],{23:v,24:g,25:y,26:_,27:S}),e(D,[2,11],{23:v,24:g,25:y,26:_,27:S}),e(w,[2,19],{25:y,26:_,27:S}),e(w,[2,20],{25:y,26:_,27:S}),e(b,[2,21]),e(b,[2,22]),e(b,[2,23]),e(b,[2,5]),e(b,[2,12]),{10:[1,49]},{6:l,7:c,10:[2,25],11:d,12:u,13:h,14:p,15:f,16:m,23:v,24:g,25:y,26:_,27:S,28:[1,50]},e(I,[2,26]),{6:l,7:c,11:d,12:u,13:h,14:p,15:f,16:m,23:v,24:g,25:y,26:_,27:S,32:[1,51]},e(b,[2,13]),{4:46,8:t,9:i,17:5,18:52,19:n,20:r,21:o,22:s,30:a},e(I,[2,27]),{10:[2,24]}],defaultActions:{11:[2,1],52:[2,24]},parseError:function(e,t){function i(e,t){this.message=e,this.hash=t}if(i.prototype=Error,!t.recoverable)throw new i(e,t);this.trace(e)},parse:function(e){var t=this,i=[0],n=[null],r=[],o=this.table,s="",a=0,l=0,c=0,d=r.slice.call(arguments,1),u=Object.create(this.lexer),h={yy:{}};for(var p in this.yy)Object.prototype.hasOwnProperty.call(this.yy,p)&&(h.yy[p]=this.yy[p]);u.setInput(e,h.yy),h.yy.lexer=u,h.yy.parser=this,void 0===u.yylloc&&(u.yylloc={});var f=u.yylloc;r.push(f);var m=u.options&&u.options.ranges;"function"==typeof h.yy.parseError?this.parseError=h.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var v,g,y,_,S,b,I,C,D,w=function(){var e;return"number"!=typeof(e=u.lex()||1)&&(e=t.symbols_[e]||e),e},E={};;){if(y=i[i.length-1],this.defaultActions[y]?_=this.defaultActions[y]:(null==v&&(v=w()),_=o[y]&&o[y][v]),void 0===_||!_.length||!_[0]){var x="";for(b in D=[],o[y])this.terminals_[b]&&b>2&&D.push("'"+this.terminals_[b]+"'");x=u.showPosition?"Parse error on line "+(a+1)+":\n"+u.showPosition()+"\nExpecting "+D.join(", ")+", got '"+(this.terminals_[v]||v)+"'":"Parse error on line "+(a+1)+": Unexpected "+(1==v?"end of input":"'"+(this.terminals_[v]||v)+"'"),this.parseError(x,{text:u.match,token:this.terminals_[v]||v,line:u.yylineno,loc:f,expected:D})}if(_[0]instanceof Array&&_.length>1)throw new Error("Parse Error: multiple actions possible at state: "+y+", token: "+v);switch(_[0]){case 1:i.push(v),n.push(u.yytext),r.push(u.yylloc),i.push(_[1]),v=null,g?(v=g,g=null):(l=u.yyleng,s=u.yytext,a=u.yylineno,f=u.yylloc,c>0&&c--);break;case 2:if(I=this.productions_[_[1]][1],E.$=n[n.length-I],E._$={first_line:r[r.length-(I||1)].first_line,last_line:r[r.length-1].last_line,first_column:r[r.length-(I||1)].first_column,last_column:r[r.length-1].last_column},m&&(E._$.range=[r[r.length-(I||1)].range[0],r[r.length-1].range[1]]),void 0!==(S=this.performAction.apply(E,[s,l,a,h.yy,_[1],n,r].concat(d))))return S;I&&(i=i.slice(0,-1*I*2),n=n.slice(0,-1*I),r=r.slice(0,-1*I)),i.push(this.productions_[_[1]][0]),n.push(E.$),r.push(E._$),C=o[i[i.length-2]][i[i.length-1]],i.push(C);break;case 3:return!0}}}};var x={isSelected:function(){return this.n2_selected},isHovered:function(){return this.n2_hovered},isFound:function(){return this.n2_found},isPoint:function(){return"point"===this.n2_geometry},isLine:function(){return"line"===this.n2_geometry},isPolygon:function(){return"polygon"===this.n2_geometry},isSchema:function(e){return!(!e||!this.n2_doc)&&e===this.n2_doc.nunaliit_schema},onLayer:function(e){return!!(e&&this.n2_doc&&this.n2_doc.nunaliit_layers)&&this.n2_doc.nunaliit_layers.indexOf(e)>=0},hasClass:function(e){if(e&&this.n2_elem){var t=(n=this.n2_elem,r=void 0,(o=n.getAttribute("class"))&&(r=o.split(" ").filter(function(e){return e.length>0})),r),i=-1;return t&&(i=t.indexOf(e)),i>=0}var n,r,o;return!1},Math:Math};E.global=x;var T=function(e,t){this.value=e,this.args=t};T.prototype.getValue=function(e){var t=this.value.getValue(e);if("function"==typeof t){var i=[];return this.args&&this.args.pushOnArray(e,i),t.apply(e,i)}return!1};var k=function(e,t){this.valueNode=e,this.nextArgument=t||null};k.prototype.getCount=function(){return this.nextArgument?1+this.nextArgument.getCount():1},k.prototype.getArgument=function(e,t){if(t<1)return this.valueNode.getValue(e);this.nextArgument&&this.nextArgument.getArgument(e,t-1)},k.prototype.pushOnArray=function(e,t){var i=this.valueNode.getValue(e);t.push(i),this.nextArgument&&this.nextArgument.pushOnArray(e,t)};var L=function(e,t,i){this.n1=e,this.n2=i,this.op=t};L.prototype.getValue=function(e){var t=this.n1.getValue(e),i=void 0;return this.n2&&(i=this.n2.getValue(e)),"!"===this.op?!t:"&&"===this.op?t&&i:"||"===this.op&&(t||i)};var M=function(e){this.value=e};M.prototype.getValue=function(e){return this.value};var O=function(e,t,i){this.leftNode=e,this.rightNode=t,this.op=i};O.prototype.getValue=function(e){var t=this.leftNode.getValue(e),i=this.rightNode.getValue(e);return"=="===this.op?t==i:"!="===this.op?t!=i:">="===this.op?t>=i:"<="===this.op?t<=i:">"===this.op?t>i:"<"===this.op&&t<i};var A=function(e,t,i){this.leftNode=e,this.rightNode=t,this.op=i};A.prototype.getValue=function(e){var t=this.leftNode.getValue(e),i=this.rightNode.getValue(e);return"+"===this.op?t+i:"-"===this.op?t-i:"*"===this.op?t*i:"/"===this.op?t/i:"%"===this.op?t%i:0};var F=function(e,t){this.idNode=e,this.previousSelector=t};F.prototype.getValue=function(e){var t=this.previousSelector.getValue(e);if("object"==typeof t){var i=this.idNode.getValue(e);if(void 0===i)return;return t[i]}};var R=function(e){this.variableName=e};R.prototype.getValue=function(e){var t=void 0;return e&&"doc"===this.variableName?t=e.n2_doc:e&&e[this.variableName]?t=e[this.variableName]:x&&x[this.variableName]&&(t=x[this.variableName]),t};var N={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,i=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),i.length-1&&(this.yylineno-=i.length-1);var r=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:i?(i.length===n.length?this.yylloc.first_column:0)+n[n.length-i.length].length-i[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[r[0],r[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var i,n,r;if(this.options.backtrack_lexer&&(r={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(r.yylloc.range=this.yylloc.range.slice(0))),(n=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],i=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),i)return i;if(this._backtrack){for(var o in r)this[o]=r[o];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,i,n;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var r=this._currentRules(),o=0;o<r.length;o++)if((i=this._input.match(this.rules[r[o]]))&&(!t||i[0].length>t[0].length)){if(t=i,n=o,this.options.backtrack_lexer){if(!1!==(e=this.test_match(i,r[o])))return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?!1!==(e=this.test_match(t,r[n]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return(e=this.conditionStack.length-1-Math.abs(e||0))>=0?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(e,t,i,n){switch(i){case 0:break;case 1:return 19;case 2:return 20;case 3:return 21;case 4:return 30;case 5:return t.yytext=t.yytext.substr(1,t.yytext.length-2),22;case 6:return 11;case 7:return 12;case 8:return 13;case 9:return 14;case 10:return 15;case 11:return 16;case 12:return 9;case 13:return 10;case 14:return"{";case 15:return"}";case 16:return 31;case 17:return 32;case 18:return 28;case 19:return 29;case 20:return 8;case 21:return 23;case 22:return 24;case 23:return 25;case 24:return 26;case 25:return 27;case 26:return 6;case 27:return 7;case 28:return 5;case 29:return"INVALID"}},rules:[/^(?:\s+)/,/^(?:true\b)/,/^(?:false\b)/,/^(?:[0-9]+(\.[0-9]+)?\b)/,/^(?:[_a-zA-Z][_a-zA-Z0-9]*)/,/^(?:'(\\'|[^'])*')/,/^(?:==)/,/^(?:!=)/,/^(?:>=)/,/^(?:<=)/,/^(?:>)/,/^(?:<)/,/^(?:\()/,/^(?:\))/,/^(?:\{)/,/^(?:\})/,/^(?:\[)/,/^(?:\])/,/^(?:,)/,/^(?:\.)/,/^(?:!)/,/^(?:\+)/,/^(?:-)/,/^(?:\*)/,/^(?:\/)/,/^(?:%)/,/^(?:&&)/,/^(?:\|\|)/,/^(?:$)/,/^(?:.)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29],inclusive:!0}}};function P(){this.yy={}}return E.lexer=N,P.prototype=E,E.Parser=P,new P}();exports.parser=t,exports.Parser=t.Parser,exports.parse=function(){return t.parse.apply(t,arguments)},exports.main=function(e){e[1]||(console.log("Usage: "+e[0]+" FILE"),process.exit(1));var t=__webpack_require__(0).readFileSync(__webpack_require__(1).normalize(e[1]),"utf8");return exports.parser.parse(t)},__webpack_require__.c[__webpack_require__.s]===module&&exports.main(process.argv.slice(1)),e.styleRuleParser={parse:function(){return t.parse.apply(t,arguments)},getGlobalContext:function(){return t.global}}}(nunaliit2),function(e){var t=function(t,i){return e.loc(t,"nunaliit2",i)},i=new(e.Class({initialize:function(){},getValue:function(e){return!0}})),n={fill:{applies:{circle:!0,line:!1,path:!0,text:!0,g:!0}},"fill-opacity":{applies:{circle:!0,line:!1,path:!0,text:!0,g:!0}},stroke:{applies:{circle:!0,line:!0,path:!0,text:!0,g:!0}},"stroke-width":{applies:{circle:!0,line:!0,path:!0,text:!0,g:!0}},"stroke-opacity":{applies:{circle:!0,line:!0,path:!0,text:!0,g:!0}},"stroke-linecap":{applies:{circle:!0,line:!0,path:!0,text:!1,g:!0}},"stroke-dasharray":{applies:{circle:!0,line:!0,path:!0,text:!1,g:!0}},r:{applies:{circle:!0,line:!1,path:!1,text:!1,g:!0}},"pointer-events":{applies:{circle:!0,line:!0,path:!0,text:!0,g:!0}},cursor:{applies:{circle:!0,line:!0,path:!0,text:!0,g:!0}},label:{applies:{circle:!1,line:!1,path:!1,text:!0,g:!0}},"font-family":{applies:{circle:!1,line:!1,path:!1,text:!0,g:!0}},"font-size":{applies:{circle:!1,line:!1,path:!1,text:!0,g:!0}},"font-style":{applies:{circle:!1,line:!1,path:!1,text:!0,g:!0}},"font-weight":{applies:{circle:!1,line:!1,path:!1,text:!0,g:!0}},"text-anchor":{applies:{circle:!1,line:!1,path:!1,text:!0,g:!0}},"marker-start":{applies:{circle:!1,line:!1,path:!0,text:!1,g:!0}},"marker-end":{applies:{circle:!1,line:!1,path:!0,text:!1,g:!0}},"marker-mid":{applies:{circle:!1,line:!1,path:!0,text:!1,g:!0}}},r={fillColor:"fill",fillOpacity:"fill-opacity",strokeColor:"stroke",strokeWidth:"stroke-width",strokeOpacity:"stroke-opacity",strokeLinecap:"stroke-linecap",strokeDashstyle:"stroke-dasharray",pointRadius:"r",pointEvents:"pointer-events",fontColor:"color","font-color":"color",fontFamily:"font-family",fontSize:"font-size",fontWeight:"font-weight"},o=e.Class({symbols:null,initialize:function(){this.symbols={},this.id=null,this._n2Symbolizer=!0;for(var e=0,t=arguments.length;e<t;++e){var i=arguments[e];this.extendWith(i)}},extendWith:function(t){if(t)if(t._n2Symbolizer){var i=t.symbols;for(var n in i){var o=i[n];this.symbols[n]=o}}else for(var n in t){var s=t[n];if(r[n]&&(n=r[n]),s&&s.length>0&&"="===s[0])try{s=e.styleRuleParser.parse(s.substr(1))}catch(e){s=e}"opacity"===n?(this.symbols["fill-opacity"]=s,this.symbols["stroke-opacity"]=s):this.symbols[n]=s}},getSymbolValue:function(e,i){var n=this.symbols[e];return"object"==typeof n&&"function"==typeof n.getValue?n=n.getValue(i):"object"==typeof n&&"localized"===n.nunaliit_type&&(n=t(n)),n},forEachSymbol:function(e,t){if("function"==typeof e)for(var i in this.symbols){e(i,this.getSymbolValue(i,t))}},adjustSvgElement:function(e,i){var r=e.nodeName.toLowerCase();for(var o in n){if(n[o].applies[r]){var s=this.getSymbolValue(o,i);if("label"===o){for(null===s||("object"==typeof s&&"localized"===s.nunaliit_type?s=t(s):void 0===s||"string"!=typeof s&&(s=""+s));e.firstChild;)e.removeChild(e.firstChild);if(s){var a=e.ownerDocument.createTextNode(s);e.appendChild(a)}}else void 0!==s&&e.setAttributeNS(null,o,s)}}"none"===(s=this.getSymbolValue("display",i))?e.setAttributeNS(null,"display","none"):e.setAttributeNS(null,"display","inherit")},adjustHtmlElement:function(e,t){var i=[];this.forEachSymbol(function(e,t){"display"===e?"none"===t&&i.push("display:none"):i.push(e+":"+t)},t);var n=i.join(";");e.setAttribute("style",n)}}),s=e.Class({symbolizersByLabel:null,id:null,label:null,initialize:function(t){var i=e.extend({id:void 0,basicStyle:void 0,extendWithRule:void 0},t);this.symbolizersByLabel={},this.id=i.id,this.label=null,i.extendWithRule&&(this.label=i.extendWithRule.label),i.basicStyle&&i.extendWithRule?(this.symbolizersByLabel.normal=new o(i.basicStyle.symbolizersByLabel.normal,i.extendWithRule.normal),this.symbolizersByLabel.selected=new o(i.basicStyle.symbolizersByLabel.selected,i.extendWithRule.selected),this.symbolizersByLabel.hovered=new o(i.basicStyle.symbolizersByLabel.hovered,i.extendWithRule.hovered),this.symbolizersByLabel.found=new o(i.basicStyle.symbolizersByLabel.found,i.extendWithRule.found)):i.basicStyle?(this.symbolizersByLabel.normal=i.basicStyle.symbolizersByLabel.normal,this.symbolizersByLabel.selected=i.basicStyle.symbolizersByLabel.selected,this.symbolizersByLabel.hovered=i.basicStyle.symbolizersByLabel.hovered,this.symbolizersByLabel.found=i.basicStyle.symbolizersByLabel.found):i.extendWithRule?(this.symbolizersByLabel.normal=i.extendWithRule.normal,this.symbolizersByLabel.selected=i.extendWithRule.selected,this.symbolizersByLabel.hovered=i.extendWithRule.hovered,this.symbolizersByLabel.found=i.extendWithRule.found):(this.symbolizersByLabel.normal=new o,this.symbolizersByLabel.selected=new o,this.symbolizersByLabel.hovered=new o,this.symbolizersByLabel.found=new o)},getSymbolizer:function(e){var t="normal";return e.n2_selected||e.n2_derived_selected?(t="$selected",e.n2_found?(t="$selectedFound",(e.n2_hovered||e.n2_derived_hovered)&&(t="$selectedFoundHovered")):(e.n2_hovered||e.n2_derived_hovered)&&(t="$selectedHovered")):e.n2_found?(t="$found",(e.n2_hovered||e.n2_derived_hovered)&&(t="$foundHovered")):(e.n2_hovered||e.n2_derived_hovered)&&(t="$hovered"),this._getSymbolizerFromLabel(t)},_getSymbolizerFromLabel:function(e){var t=this.symbolizersByLabel[e];if(!t){if("normal"===e)t=new o;else if("$hovered"===e){var i=this._getSymbolizerFromLabel("normal");t=new o(i,this.symbolizersByLabel.hovered)}else if("$found"===e){i=this._getSymbolizerFromLabel("normal");t=new o(i,this.symbolizersByLabel.found)}else if("$selected"===e){i=this._getSymbolizerFromLabel("normal");t=new o(i,this.symbolizersByLabel.selected)}else if("$selectedFound"===e){i=this._getSymbolizerFromLabel("$selected");t=new o(i,this.symbolizersByLabel.found)}else if("$selectedHovered"===e){i=this._getSymbolizerFromLabel("$selected");t=new o(i,this.symbolizersByLabel.hovered)}else if("$foundHovered"===e){i=this._getSymbolizerFromLabel("$found");t=new o(i,this.symbolizersByLabel.hovered)}else if("$selectedFoundHovered"===e){i=this._getSymbolizerFromLabel("$selectedFound");t=new o(i,this.symbolizersByLabel.hovered)}t&&(this.symbolizersByLabel[e]=t)}return t}}),a=e.Class({condition:null,label:null,source:null,normal:null,selected:null,found:null,hovered:null,initialize:function(t){var i=e.extend({condition:null,label:null,source:null,normal:null,selected:null,found:null,hovered:null},t);this.condition=i.condition,this.label=i.label,this.source=i.source,this.normal=new o(i.normal),this.selected=new o(i.selected),this.found=new o(i.found),this.hovered=new o(i.hovered)},isValidForContext:function(e){if(!this.condition)return!1;try{return this.condition.getValue(e)}catch(e){return!1}}}),l=e.Class({rules:null,cache:null,initialize:function(t){var i=e.extend({skipDefaults:!1},t);if(this.rules=[],this.cache={style:new s({id:""})},!i.skipDefaults){var n=c({condition:"true",normal:{fillColor:"#ffffff",strokeColor:"#ee9999",strokeWidth:2,fillOpacity:1,strokeOpacity:1,strokeLinecap:"round",pointRadius:6,pointerEvents:"visiblePainted"},selected:{strokeColor:"#ff2200"},found:{strokeColor:"#00ffff",fillColor:"#00ffff"},hovered:{fillColor:"#0000ff"}});this.addRule(n);n=c({condition:"isLine()",normal:{fillColor:"none"},selected:{fillColor:"none"},hovered:{strokeColor:"#0000ff",fillColor:"none"},found:{strokeColor:"#00ffff",fillColor:"none"}});this.addRule(n)}},addRule:function(t){t.id=e.getUniqueId(),this.rules.push(t)},getSymbolizer:function(e){return this.getStyle(e).getSymbolizer(e)},getStyle:function(e){for(var t=[],i=this.cache,n=0,r=this.rules.length;n<r;++n){var o=this.rules[n];if(o.isValidForContext(e)){if(t.push(""+n),!i[n]){var a=new s({id:t.join("+"),basicStyle:i.style,extendWithRule:o});i[n]={},i[n].style=a}i=i[n]}}return i.style}});function c(t){var n=i;return t.condition&&(n=e.styleRuleParser.parse(t.condition)),new a({condition:n,label:t.label,source:t.condition,normal:t.normal?t.normal:{},selected:t.selected?t.selected:{},found:t.found?t.found:{},hovered:t.hovered?t.hovered:{}})}e.styleRule={loadRulesFromObject:function(t,i){var n=[];if(t)for(var r=0,o=t.length;r<o;++r){var s=t[r];try{var a=c(s);n.push(a)}catch(o){e.log("Error trying to load style rule: "+o)}}var d=new l(i);for(r=0,o=n.length;r<o;++r)a=n[r],d.addRule(a);return d}}}(nunaliit2),function(e){var t={star:[350,75,379,161,469,161,397,215,423,301,350,250,277,301,303,215,231,161,321,161,350,75],cross:[4,0,6,0,6,4,10,4,10,6,6,6,6,10,4,10,4,6,0,6,0,4,4,4,4,0],x:[0,0,25,0,50,35,75,0,100,0,65,50,100,100,75,100,50,65,25,100,0,100,35,50,0,0],square:[0,0,0,1,1,1,1,0,0,0],triangle:[0,10,10,10,5,0,0,10]},i={endArrow:{attributes:{viewBox:"0 0 10 10",refX:"1",refY:"5",markerWidth:"6",markerHeight:"6",orient:"auto"},path:"M 0 0 L 10 5 L 0 10 z"}},n=e.Class({svgElemId:null,initialize:function(t){var i=e.extend({svgElem:null,svgElemId:null},t);if(this.svgElemId=i.svgElemId,!this.svgElemId&&i.svgElem&&(this.svgElemId=e.utils.getElementIdentifier(i.svgElem)),!this.svgElemId)throw"SVG element must be provided"},_getSvgElem:function(){return document.getElementById(this.svgElemId)},_getDefsElem:function(){for(var e=null,t=this._getSvgElem(),i=t.childNodes,n=0,r=i.length;n<r;++n){var o=i.item(n);"defs"===o.localName.toLowerCase()&&(e=o)}return null===e&&(e=this._createNode("defs"),t.appendChild(e)),e},_importGraphic:function(e){var i=this._getDefsElem(),n=this.svgElemId+"-graphic-"+e;if(!(o=document.getElementById(n))){var r=t[e];if(!r)throw e+" is not a valid graphic name";var o=this._createNode("symbol",n),s=this._createNode("polygon");o.appendChild(s);for(var a,l,c=null,d=null,u=null,h=null,p=[],f=0;f<r.length;f+=2)a=r[f],l=r[f+1],d=null==d?a:Math.min(d,a),c=null==c?a:Math.max(c,a),h=null==h?l:Math.min(h,l),u=null==u?l:Math.max(u,l);var m=c-d,v=u-h,g=2/(m>v?m:v),y=(d+c)/2,_=(h+u)/2;for(f=0;f<r.length;f+=2)a=(r[f]-y)*g,l=(r[f+1]-_)*g,0!=f&&p.push(" "),p.push(a,",",l);s.setAttributeNS(null,"points",p.join("")),o.setAttributeNS(null,"viewBox","-3 -3 6 6"),i.appendChild(o)}return o},_importMarker:function(e){var t=this._getDefsElem(),n=this.svgElemId+"-marker-"+e;if(!(o=document.getElementById(n))){var r=i[e];if(!r)throw e+" is not a valid marker name";var o=this._createNode("marker",n);if(r.attributes)for(var s in r.attributes){var a=r.attributes[s];o.setAttributeNS(null,s,a)}if(r.path){var l=this._createNode("path");l.setAttributeNS(null,"d",r.path),o.appendChild(l)}t.appendChild(o)}return o},_createNode:function(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg",e);return t&&i.setAttributeNS(null,"id",t),i}}),r="http://www.w3.org/2000/svg";e.svg={Renderer:n,svgNs:r,xlinkNs:"http://www.w3.org/1999/xlink",createSVGNode:function(e,t){var i=null;return document.createElementNS&&(i=document.createElementNS(r,e),t&&i.setAttributeNS(null,"id",t)),i},setAttr:function(e,t,i){e.setAttributeNS(null,t,i)},setAttrNS:function(e,t,i,n){e.setAttributeNS(t,i,n)},addClass:function(e,t){var i=[];e.className&&(i=(""+e.className).split(" ")),i.push(t),e.className=i.join(" ")},presentationAttributeMap:{"alignment-baseline":!0,"baseline-shift":!0,clip:!0,"clip-path":!0,"clip-rule":!0,color:!0,"color-interpolation":!0,"color-interpolation-filters":!0,"color-profile":!0,"color-rendering":!0,cursor:!0,direction:!0,display:!0,"dominant-baseline":!0,"enable-background":!0,fill:!0,"fill-opacity":!0,"fill-rule":!0,filter:!0,"flood-color":!0,"flood-opacity":!0,"font-family":!0,"font-size":!0,"font-size-adjust":!0,"font-stretch":!0,"font-style":!0,"font-variant":!0,"font-weight":!0,"glyph-orientation-horizontal":!0,"glyph-orientation-vertical":!0,"image-rendering":!0,kerning:!0,"letter-spacing":!0,"lighting-color":!0,"marker-end":!0,"marker-mid":!0,"marker-start":!0,mask:!0,opacity:!0,overflow:!0,"pointer-events":!0,"shape-rendering":!0,"stop-color":!0,"stop-opacity":!0,stroke:!0,"stroke-dasharray":!0,"stroke-dashoffset":!0,"stroke-linecap":!0,"stroke-linejoin":!0,"stroke-miterlimit":!0,"stroke-opacity":!0,"stroke-width":!0,"text-anchor":!0,"text-decoration":!0,"text-rendering":!0,"unicode-bidi":!0,visibility:!0,"word-spacing":!0,"writing-mode":!0}}}(nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.mail",r=t.Class({url:null,dispatchService:null,customService:null,welcome:null,initialize:function(e){var i=t.extend({url:null,dispatchService:null,customService:null},e),r=this;if(this.url=i.url,this.dispatchService=i.dispatchService,this.customService=i.customService,this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(n,"mailShowMailForm",o),this.dispatchService.register(n,"showPreprocessElement",o)}this.getWelcome({onSuccess:function(e){t.log("mail service",e)}})},getWelcome:function(i){var n=t.extend({onSuccess:function(e){},onError:function(e){}},i),r=this;this.welcome?n.onSuccess(this.welcome):e.ajax({url:this.url,type:"get",async:!0,dataType:"json",success:function(e){e.ok?(r.welcome=e,n.onSuccess(e)):n.onError("Malformed welcome reported")},error:function(e,i,r){var o=t.utils.parseHttpJsonError(e,i);n.onError("Error obtaining welcome: "+o)}})},formEmailAvailable:function(e){var i=t.extend({onSuccess:function(e){},onError:function(e){}},e);this.getWelcome({onSuccess:function(e){var t=!1;e.ok&&e.configured&&e.defaultRecipientCount>0&&(t=!0),i.onSuccess(t)},onError:i.onError})},sendFormEmail:function(n){var r=t.extend({destination:null,subject:null,contact:null,message:null,onSuccess:function(){},onError:function(e){}},n),o={};r.destination&&(o.destination=r.destination),r.contact&&(o.contact=r.contact),r.message&&(o.body=r.message),r.subject&&(o.subject=r.subject),!o.contact||"string"==typeof o.contact&&o.contact.length<1?r.onError(i("You must provide contact information")):!o.body||"string"==typeof o.body&&o.body.length<1?r.onError(i("You must provide a message")):o.subject&&"string"!=typeof o.subject?r.onError(i("The mail subject, if specified, must be a string")):e.ajax({url:this.url+"sendFormMail",type:"post",async:!0,dataType:"json",data:o,success:function(e){e.ok?r.onSuccess(e):r.onError("Problem: "+e.error)},error:function(e,i,n){var o=t.utils.parseHttpJsonError(e,i);"object"==typeof o&&o.error&&(o=o.error),r.onError("Error sending form e-mail: "+o)}})},_getMailFormContactFields:function(){var e=null;return this.customService&&(e=this.customService.getOption("mailFormContactFields")),t.isArray(e)||(e=[{name:"contact_info",label:i("Contact Information"),placeholder:i("Information to contact you"),required:!0,textarea:!0}]),e},showMailForm:function(){var n=this,r=void 0;this.customService&&(r=this.customService.getOption("mailFormSubject",void 0));var o=this._getMailFormContactFields(),s=t.getUniqueId(),a=e("<div>").addClass("n2mailForm_dialog").attr("id",s).appendTo(e("body")),l=e("<div>").addClass("n2mailForm_content").appendTo(a);if(o)for(var c=0,d=o.length;c<d;++c){var u=o[c];if(u.name){var h=u.label;h||(h=u.name);var p="n2mailForm_label_"+t.utils.stringToHtmlId(u.name),f="n2mailForm_input_"+t.utils.stringToHtmlId(u.name);e("<div>").addClass("n2mailForm_label "+p).text(h).appendTo(l);var m=null;(m=u.textarea?e("<textarea>").attr("placeholder",i("Information to contact you")).appendTo(l):e("<input>").attr("type","text").appendTo(l)).addClass("n2mailForm_input n2mailForm_processing_element "+f).attr("name",u.name),u.placeholder&&m.attr("placeholder",u.placeholder)}}e("<div>").addClass("n2mailForm_label").text(i("Message")).appendTo(l),e("<textarea>").addClass("n2mailForm_input n2mailForm_processing_element n2mailForm_input_message").appendTo(l);var v=e("<div>").addClass("n2mailForm_buttons").appendTo(a);e("<a>").addClass("n2mailForm_button n2mailForm_button_cancel").text(i("Cancel")).attr("href","#").appendTo(v).click(function(){return e("#"+s).dialog("close"),!1}),e("<a>").addClass("n2mailForm_button n2mailForm_button_send").text(i("Send")).attr("href","#").appendTo(v).click(function(){var a=e("#"+s);a.find(".n2mailForm_processing_element").attr("disabled","disabled"),a.find(".n2mailForm_button").addClass("n2mailForm_button_disabled");var l=[];if(o)for(var c=0,d=o.length;c<d;++c){var u=o[c];if(u.name){var h=u.label;h||(h=u.name);var p="n2mailForm_input_"+t.utils.stringToHtmlId(u.name),f=a.find("."+p).val();if(u.required&&(!f||""===f))return alert(i("You must provide field: {label}",{label:h})),a.find(".n2mailForm_processing_element").removeAttr("disabled"),void a.find(".n2mailForm_button").removeClass("n2mailForm_button_disabled");l.push({name:u.name,value:f})}}var m=a.find(".n2mailForm_input_message").val();return n.sendFormEmail({destination:null,subject:r,contact:JSON.stringify(l),message:m,onSuccess:function(){var t=e("#"+s);t.find(".n2mailForm_content").empty().text(i("Your message was sent"));var n=t.find(".n2mailForm_buttons").empty();e("<a>").addClass("n2mailForm_button n2mailForm_button_close").text(i("Close")).attr("href","#").appendTo(n).click(function(){e("#"+s).dialog("close")})},onError:function(t){alert(i("Unable to send e-mail: {err}",{err:t}));var n=e("#"+s);n.find(".n2mailForm_processing_element").removeAttr("disabled"),n.find(".n2mailForm_button").removeClass("n2mailForm_button_disabled")}}),!1});var g=null;this.customService&&(g=this.customService.getOption("mailFormTitle",null)),"string"!=typeof g&&(g=i("E-mail Form")),a.dialog({autoOpen:!0,title:g,modal:!0,width:"auto",close:function(t,i){e("#"+s).remove()}})},_insertMailFormButton:function(r){var o=this;r.empty();var s=t.utils.getElementIdentifier(r),a=r.attr("nunaliit-label");a||(a=i("Send us information")),this.formEmailAvailable({onSuccess:function(t){if(t&&o.dispatchService){var i=e("#"+s);e("<a>").addClass("n2mailFormButton").attr("href","#").text(a).appendTo(i).click(function(){return o.dispatchService.send(n,{type:"mailShowMailForm"}),!1})}},onError:function(e){}})},_showPreprocessElement:function(t){var i=this;t.find("*").addBack().filter(".n2s_insertMailFormButton").each(function(){var t=e(this);i._insertMailFormButton(t),t.removeClass("n2s_insertMailFormButton").addClass("n2s_insertedMailFormButton")})},_handle:function(e,t,i){if("mailShowMailForm"===e.type)this.showMailForm();else if("showPreprocessElement"===e.type){var n=e.elem;this._showPreprocessElement(n)}}});t.mail={MailService:r}}(jQuery,nunaliit2),function(e){var t=e.Class({dispatchService:null,initialize:function(t){var i=e.extend({dispatchService:null},t),n=this;if(this.dispatchService=i.dispatchService,this.dispatchService){this.dispatchService.register("n2.instance","instanceCreate",function(e,t,i){n._handle(e,t,i)})}},_handle:function(t,i,n){if("instanceCreate"===t.type){if("object"!=typeof t.instanceConfiguration)return void e.log("instanceConfiguration must be provided when creating an instance");if("string"!=typeof t.instanceConfiguration.type)return void e.log("instanceConfiguration.type must be a string when creating an instance");e.mapInitialBounds&&"function"==typeof e.mapInitialBounds.handleInstanceCreate&&e.mapInitialBounds.handleInstanceCreate(t,i,n),e.utilitiesModel&&"function"==typeof e.utilitiesModel.handleInstanceCreate&&e.utilitiesModel.handleInstanceCreate(t,i,n)}}});e.instance={Service:t}}(nunaliit2),function(e,t){var i="n2.model",n=t.Class({model:null,parameterId:null,type:null,name:null,label:null,setFn:null,getFn:null,dispatchService:null,eventNameSet:null,eventNameGet:null,eventNameChange:null,initialize:function(e){var n=t.extend({model:null,modelId:null,type:null,name:null,label:null,setFn:null,getFn:null,dispatchService:null},e),r=this;this.model=n.model,this.type=n.type,this.name=n.name,this.label=n.label,this.setFn=n.setFn,this.getFn=n.getFn,this.dispatchService=n.dispatchService;var o=n.modelId;if(o||(o=t.getUniqueId("parameter_")),this.label||(this.label=this.name),this.parameterId=o+"_"+this.name,this.eventNameSet=this.parameterId+"_set",this.eventNameGet=this.parameterId+"_get",this.eventNameChange=this.parameterId+"_change",this.dispatchService){var s=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(i,this.eventNameSet,s),this.dispatchService.register(i,this.eventNameGet,s)}},getInfo:function(){var e={parameterId:this.parameterId,type:this.type,name:this.name,label:this.label,setEvent:this.eventNameSet,getEvent:this.eventNameGet,changeEvent:this.eventNameChange},t=this._getValue();return e.value=t,e},sendUpdate:function(){var e=this._getValue();this.dispatchService.send(i,{type:this.eventNameChange,parameterId:this.parameterId,value:e})},_getValue:function(){return this.getFn?this.getFn.call(this.model):this.model[this.name]},_setValue:function(e){this.setFn?this.setFn.call(this.model,e):(this.model[this.name]=e,this.sendUpdate())},_handle:function(e,t,i){if(e.type===this.eventNameSet){var n=e.value;this._setValue(n)}else if(e.type===this.eventNameGet){var r=this._getValue();e.value=r}}}),r=t.Class({dispatchService:null,onChangeFn:null,parameterId:null,type:null,name:null,label:null,setEvent:null,getEvent:null,changeEvent:null,lastValue:null,initialize:function(e){var n=t.extend({parameterInfo:null,dispatchService:null,onChangeFn:null},e),r=this;if(this.onChangeFn=n.onChangeFn,this.dispatchService=n.dispatchService,this.lastValue=void 0,!n.parameterInfo||"object"!=typeof n.parameterInfo)throw new Error("parameterInfo must be provided");if(this.parameterId=n.parameterInfo.parameterId,this.type=n.parameterInfo.type,this.name=n.parameterInfo.name,this.label=n.parameterInfo.label,this.setEvent=n.parameterInfo.setEvent,this.getEvent=n.parameterInfo.getEvent,this.changeEvent=n.parameterInfo.changeEvent,this.lastValue=n.parameterInfo.value,this.dispatchService){this.dispatchService.register(i,this.changeEvent,function(e,t,i){r._handle(e,t,i)})}},getValue:function(){return this.lastValue},setValue:function(e){this.lastValue=e,this.dispatchService.send(i,{type:this.setEvent,value:e})},_handle:function(e,t,i){if(e.type===this.changeEvent&&e.parameterId===this.parameterId){var n=e.value;if(this.lastValue!==n){var r=this.lastValue;this.lastValue=n,"function"==typeof this.onChangeFn&&this.onChangeFn(this.lastValue,r)}}}});var o=t.Class("DocumentModel",{dispatchService:null,modelId:null,modelType:null,initialize:function(e){var n=t.extend({dispatchService:null,modelId:null,modelType:null},e),r=this;if(this.dispatchService=n.dispatchService,this.modelId=n.modelId,this.modelType=n.modelType,"string"!=typeof this.modelId)throw new Error("modelId must be specified and it must be a string");this.dispatchService&&(this.dispatchService.register(i,"modelGetInfo",function(e,t,i){e.modelId===r.modelId&&(e.modelInfo=r._getModelInfo())}),this.dispatchService.register(i,"modelGetState",function(e,t,i){if(e.modelId===r.modelId){var n=r._getCurrentDocuments();e.state={added:n,updated:[],removed:[],loading:r._isLoading()}}}))},_getModelInfo:function(){var e={modelId:this.modelId,modelType:this.modelType,parameters:{}};return this._addModelInfoParameters(e),e},_addModelInfoParameters:function(e){},_reportStateUpdate:function(e,t,n){var r={added:e,updated:t,removed:n,loading:this._isLoading()};this.dispatchService&&this.dispatchService.send(i,{type:"modelStateUpdated",modelId:this.modelId,state:r})},_getCurrentDocuments:function(){throw new Error("Subclasses must implement the method _getCurrentDocuments()")},_isLoading:function(){throw new Error("Subclasses must implement the method _isLoading()")}}),s=t.Class("DocumentModelObserver",{dispatchService:null,sourceModelId:null,modelIsLoading:null,docsById:null,updatedCallback:null,initialize:function(e){var n=t.extend({dispatchService:null,sourceModelId:null,updatedCallback:null},e),r=this;if(this.docsById={},this.modelIsLoading=!1,this.dispatchService=n.dispatchService,this.sourceModelId=n.sourceModelId,this.updatedCallback=n.updatedCallback,"string"!=typeof this.sourceModelId)throw new Error("sourceModelId must be specified and it must be a string");if(this.dispatchService){this.dispatchService.register(i,"modelStateUpdated",function(e,t,i){r.sourceModelId===e.modelId&&r._sourceModelUpdated(e.state)});var o=t.model.getModelState({dispatchService:this.dispatchService,modelId:this.sourceModelId});o&&this._sourceModelUpdated(o)}},getDocuments:function(){var e=[];for(var t in this.docsById){var i=this.docsById[t];e[e.length]=i}return e},_sourceModelUpdated:function(e){var i=this;"boolean"==typeof e.loading&&this.modelIsLoading!==e.loading&&(this.modelIsLoading=e.loading),t.isArray(e.added)&&e.added.forEach(function(e){var t=e._id;i.docsById[t]=e}),t.isArray(e.updated)&&e.updated.forEach(function(e){var t=e._id;i.docsById[t]=e}),t.isArray(e.removed)&&e.removed.forEach(function(e){var t=e._id;delete i.docsById[t]}),this._documentUpdated(e)},isLoading:function(){return this.modelIsLoading},_documentUpdated:function(e){"function"==typeof this.updatedCallback&&this.updatedCallback(e,this.sourceModelId)}}),a=t.Class({dispatchService:null,modelIdMap:null,modelIds:null,initialize:function(e){var n=t.extend({dispatchService:null},e),r=this;if(this.dispatchService=n.dispatchService,this.modelIdMap={},this.modelIds=[],this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(i,"modelCreate",o),this.dispatchService.register(i,"modelStateUpdated",o),this.dispatchService.register(i,"modelGetList",o),this.dispatchService.register(i,"modelGetState",o)}},_handle:function(e,n,r){if("modelCreate"===e.type){if(!e.modelType)return void t.log("modelType must be provided when creating a model");if(!e.modelId)return void t.log("modelId must be provided when creating a model: "+e.modelType);this.modelIdMap[e.modelId]||(this.modelIdMap[e.modelId]="__suspected__"),t.modelFilter&&"function"==typeof t.modelFilter.handleModelCreate&&t.modelFilter.handleModelCreate(e,n,r),t.modelUtils&&"function"==typeof t.modelUtils.handleModelCreate&&t.modelUtils.handleModelCreate(e,n,r),t.modelTime&&"function"==typeof t.modelTime.handleModelCreate&&t.modelTime.handleModelCreate(e,n,r),t.modelLayer&&"function"==typeof t.modelLayer.handleModelCreate&&t.modelLayer.handleModelCreate(e,n,r),t.couchDbPerspective&&"function"==typeof t.couchDbPerspective.handleModelCreate&&t.couchDbPerspective.handleModelCreate(e,n,r),t.modelFilterSimultaneous&&"function"==typeof t.modelFilterSimultaneous.handleModelCreate&&t.modelFilterSimultaneous.handleModelCreate(e,n,r)}else if("modelGetState"===e.type){var o=e.modelId;this.modelIdMap[e.modelId]||(this.modelIdMap[e.modelId]="__suspected__")}else if("modelStateUpdated"===e.type){(o=e.modelId)&&"__confirmed__"!==this.modelIdMap[o]&&(this.modelIdMap[o]="__confirmed__",this.modelIds.push(o))}else if("modelGetList"===e.type){for(var o in e.modelIds||(e.modelIds=[]),this.modelIdMap){if("__suspected__"===this.modelIdMap[o]){var s={type:"modelGetInfo",modelId:o};this.dispatchService.synchronousCall(i,s),s.modelInfo&&(this.modelIdMap[o]="__confirmed__",this.modelIds.push(o))}}this.modelIds.forEach(function(t){e.modelIds.push(t)})}}});t.model={Service:a,DocumentModel:o,DocumentModelObserver:s,ModelParameter:n,ModelParameterObserver:r,getModelInfo:function(e){var n=t.extend({dispatchService:null,modelId:null},e),r=n.dispatchService,o=n.modelId;if(!r)throw new Error("dispatchService must be specified");if("string"!=typeof o)throw new Error("modelId must be specified");var s={type:"modelGetInfo",modelId:o};return r.synchronousCall(i,s),s.modelInfo},getModelState:function(e){var n=t.extend({dispatchService:null,modelId:null},e),r=n.dispatchService,o=n.modelId;if(!r)throw new Error("dispatchService must be specified");if("string"!=typeof o)throw new Error("modelId must be specified");var s={type:"modelGetState",modelId:o};return r.synchronousCall(i,s),s.state}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.modelFilter";var r=t.Class("ModelFilter",{dispatchService:null,modelId:null,sourceModelId:null,docInfosByDocId:null,modelIsLoading:null,filterFn:null,initialize:function(e){var i=t.extend({dispatchService:null,filterName:null,filterFn:null,modelId:null,sourceModelId:null},e),r=this;if(this.dispatchService=i.dispatchService,this.modelId=i.modelId,this.sourceModelId=i.sourceModelId,this.filterFn=i.filterFn,this.filterName=i.filterName,this.filterName||(this.filterName=this._classname),this.docInfosByDocId={},this.modelIsLoading=!1,this.dispatchService){var o=function(e,t,i){r._handleModelFilterEvents(e,t,i)};if(this.dispatchService.register(n,"modelGetInfo",o),this.dispatchService.register(n,"modelGetState",o),this.dispatchService.register(n,"modelStateUpdated",o),this.sourceModelId){var s=t.model.getModelState({dispatchService:this.dispatchService,modelId:this.sourceModelId});s&&this._sourceModelUpdated(s)}}t.log(this.filterName,this)},_handleModelFilterEvents:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo(),e.modelInstance=this);else if("modelGetState"===e.type){if(this.modelId===e.modelId){var n=[];for(var r in this.docInfosByDocId){var o=this.docInfosByDocId[r];if(o.visible){var s=o.doc;n.push(s)}}e.state={added:n,updated:[],removed:[],loading:this.modelIsLoading}}}else"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){var e={modelId:this.modelId,modelType:"filter",parameters:{}};return this._addModelInfoParameters(e),e},_addModelInfoParameters:function(e){},_sourceModelUpdated:function(e){var t=[],i=[],n=[];if("boolean"==typeof e.loading&&this.modelIsLoading!==e.loading&&(this.modelIsLoading=e.loading),e.added)for(var r=0,o=e.added.length;r<o;++r){var s=(l=e.added[r])._id;(c=this.docInfosByDocId[s])||(c={id:s,doc:l,visible:!1},this.docInfosByDocId[s]=c),(a=this._computeVisibility(l))&&(c.visible=a,t.push(l))}if(e.updated)for(r=0,o=e.updated.length;r<o;++r){var a;s=(l=e.updated[r])._id;(c=this.docInfosByDocId[s])||(c={id:s,doc:l,visible:!1},this.docInfosByDocId[s]=c),c.doc=l,(a=this._computeVisibility(l))?c.visible?i.push(l):t.push(l):c.visible&&n.push(l),c.visible=a}if(e.removed)for(r=0,o=e.removed.length;r<o;++r){var l,c;s=(l=e.removed[r])._id;(c=this.docInfosByDocId[s])&&(delete this.docInfosByDocId[s],c.visible&&n.push(l))}this._reportStateUpdate(t,i,n)},_filterChanged:function(){var e=[],t=[];for(var i in this.docInfosByDocId){var n=this.docInfosByDocId[i],r=n.doc,o=this._computeVisibility(r);o?n.visible||e.push(r):n.visible&&t.push(r),n.visible=o}this._reportStateUpdate(e,[],t)},_reportStateUpdate:function(e,t,i){var r={added:e,updated:t,removed:i,loading:this.modelIsLoading};this.dispatchService&&this.dispatchService.send(n,{type:"modelStateUpdated",modelId:this.modelId,state:r})},_computeVisibility:function(e){var t=!1;return this.filterFn&&this.filterFn(e)&&(t=!0),t}}),o=t.Class("SchemaFilterLegacy",r,{schemaNameMap:null,initialize:function(e){var i=t.extend({dispatchService:null,modelId:null,sourceModelId:null,schemaName:null,schemaNames:null},e),n=this;if(this.schemaNameMap={},"string"==typeof i.schemaName&&(this.schemaNameMap[i.schemaName]=!0),t.isArray(i.schemaNames))for(var o=0,s=i.schemaNames.length;o<s;++o){var a=i.schemaNames[o];"string"==typeof a&&(this.schemaNameMap[a]=!0)}i.filterFn=function(e){return n._isDocVisible(e)},i.filterName="SchemaFilterLegacy",r.prototype.initialize.call(this,i)},_isDocVisible:function(e){return!!(e&&e.nunaliit_schema&&this.schemaNameMap[e.nunaliit_schema])}}),s=t.Class(r,{referenceMap:null,initialize:function(e){var i=t.extend({dispatchService:null,modelId:null,sourceModelId:null,reference:null,references:null},e),n=this;if(this.referenceMap={},"string"==typeof i.reference&&(this.referenceMap[i.reference]=!0),t.isArray(i.references))for(var o=0,s=i.references.length;o<s;++o){var a=i.references[o];"string"==typeof a&&(this.referenceMap[a]=!0)}i.filterFn=function(e){return n._isDocVisible(e)},i.filterName="ReferenceFilter",r.prototype.initialize.call(this,i)},getReferences:function(){var e=[];for(var t in this.referenceMap)e.push(t);return e},setReferences:function(e){this.referenceMap={};for(var t=0,i=e.length;t<i;++t){var n=e[t];this.referenceMap[n]=!0}this._filterChanged()},_isDocVisible:function(e){if(e){var i=[];t.couchUtils.extractLinks(e,i);for(var n=0,r=i.length;n<r;++n){var o=i[n].doc;if(this.referenceMap[o])return!0}}return!1}}),a=t.Class(r,{selectedDocParameter:null,selectedDocId:null,initialize:function(e){var i=t.extend({dispatchService:null,modelId:null,sourceModelId:null,selectedDocId:null},e),n=this;this.selectedDocId=i.selectedDocId,this.selectedDocParameter=new t.model.ModelParameter({model:this,type:"string",name:"selectedDocumentId",label:"Selected Document Id",setFn:function(e){n._setSelectedDocId(e)},getFn:function(){return n._getSelectedDocId()},dispatchService:i.dispatchService}),i.filterFn=function(e){return n._isDocVisible(e)},i.filterName="SingleDocumentFilter",r.prototype.initialize.call(this,i)},_getSelectedDocId:function(){return this.selectedDocId},_setSelectedDocId:function(e){this.selectedDocId=e,this._filterChanged()},_addModelInfoParameters:function(e){e.parameters.selectedDocumentId=this.selectedDocParameter.getInfo()},_isDocVisible:function(e){return!(!e||e._id!==this.selectedDocId)}}),l=t.Class("SelectableDocumentFilter",{dispatchService:void 0,modelId:void 0,sourceModelId:void 0,saveSelection:void 0,saveSelectionName:void 0,docInfosByDocId:void 0,selectedChoicesParameter:void 0,allSelectedParameter:void 0,availableChoicesParameter:void 0,selectedChoiceIdMap:void 0,allSelected:void 0,availableChoices:void 0,modelIsLoading:void 0,initialize:function(e){var r=t.extend({dispatchService:null,modelId:null,sourceModelId:null,initialSelection:null,saveSelection:null},e),o=this;this.dispatchService=r.dispatchService,this.modelId=r.modelId,this.sourceModelId=r.sourceModelId,this.saveSelection=!1,this.saveSelectionName=this.modelId,"string"==typeof r.saveSelection?(this.saveSelection=!0,this.saveSelectionName=r.saveSelection):"boolean"==typeof r.saveSelection?r.saveSelection&&(this.saveSelection=!0):null===r.saveSelection||"object"==typeof r.saveSelection&&r.saveSelection.enabled&&(this.saveSelection=!0,"string"==typeof r.saveSelection.name&&(this.saveSelectionName=r.saveSelection.name)),this.docInfosByDocId={},this.selectedChoiceIdMap={},this.allSelected=!0,this.availableChoices=[],this.modelIsLoading=!1;var s,a=!1;if(this.saveSelection){var l=t.storage.getLocalStorage().getItem(this.saveSelectionName);if("__ALL__"===l)a=!0,this.allSelected=!0,s=[];else if(l)try{var c=JSON.parse(l);t.isArray(c)?(a=!0,this.allSelected=!1,s=c):t.logError("Unexpected initial selection loaded",c)}catch(e){t.logError("Error while parsing JSON selection "+this.saveSelectionName,e)}}if(!a&&t.isArray(r.initialSelection)&&(a=!0,this.allSelected=!1,s=[],r.initialSelection.forEach(function(e){"string"==typeof e?s.push(e):t.log("Error: SelectableDocumentFilter initialized with initial selection: "+e)})),a||(a=!0,this.allSelected=!0,s=[]),s.forEach(function(e){"string"==typeof e&&("__ALL_CHOICES__"===e?o.allSelected=!0:(o.selectedChoiceIdMap[e]=!0,o.availableChoices.push({id:e,label:e})))}),this.selectedChoicesParameter=new t.model.ModelParameter({model:this,modelId:this.modelId,type:"strings",name:"selectedChoices",label:i("Choices"),setFn:this._setSelectedChoices,getFn:this.getSelectedChoices,dispatchService:this.dispatchService}),this.allSelectedParameter=new t.model.ModelParameter({model:this,modelId:this.modelId,type:"boolean",name:"allSelected",label:i("All Selected"),setFn:this._setAllSelected,getFn:this.getAllSelected,dispatchService:this.dispatchService}),this.availableChoicesParameter=new t.model.ModelParameter({model:this,modelId:this.modelId,type:"objects",name:"availableChoices",label:i("Available Choices"),setFn:this._setAvailableChoices,getFn:this.getAvailableChoices,dispatchService:this.dispatchService}),this.dispatchService){var d=function(e,t,i){o._handleSelectableDocumentFilterEvents(e,t,i)};if(this.dispatchService.register(n,"modelGetInfo",d),this.dispatchService.register(n,"modelGetState",d),this.dispatchService.register(n,"modelStateUpdated",d),this.sourceModelId){var u=t.model.getModelState({dispatchService:this.dispatchService,modelId:this.sourceModelId});u&&this._sourceModelUpdated(u)}}t.log(this._classname,this)},getSelectedChoices:function(){var e=[];for(var t in this.selectedChoiceIdMap)e.push(t);return e.sort(),e},_setSelectedChoices:function(e){var i=this;if(!t.isArray(e))throw new Error("SelectableDocumentFilter._setSelectedChoices() should be an array of strings");if(this.allSelected=!1,this.selectedChoiceIdMap={},e.forEach(function(e){if("string"!=typeof e)throw new Error("SelectableDocumentFilter._setSelectedChoices() should be an array of strings");i.selectedChoiceIdMap[e]=!0}),this.saveSelection){var n=JSON.stringify(e);t.storage.getLocalStorage().setItem(this.saveSelectionName,n)}this._selectionChanged(this.selectedChoiceIdMap,this.allSelected),this._filterChanged(),this.allSelectedParameter.sendUpdate(),this.selectedChoicesParameter.sendUpdate()},getAllSelected:function(){return this.allSelected},_setAllSelected:function(e){var i=this;if("boolean"!=typeof e)throw new Error("SelectableDocumentFilter._setAllSelected() should be a boolean");if(this.allSelected=e,this.allSelected&&this.availableChoices.forEach(function(e){i.selectedChoiceIdMap[e.id]=!0}),this.saveSelection){var n=null;if(this.allSelected&&(n="__ALL__"),n)t.storage.getLocalStorage().setItem(this.saveSelectionName,n)}this._selectionChanged(this.selectedChoiceIdMap,this.allSelected),this._filterChanged(),this.allSelectedParameter.sendUpdate(),this.selectedChoicesParameter.sendUpdate()},getAvailableChoices:function(){return this.availableChoices},_setAvailableChoices:function(){throw new Error("SelectableDocumentFilter._setAvailableChoices() should never be called")},_updateAvailableChoices:function(e){var i=this;if(!t.isArray(e))throw new Error("SelectableDocumentFilter._updateAvailableChoices() should be an array of choices");e.forEach(function(e){if("object"!=typeof e)throw new Error("SelectableDocumentFilter._updateAvailableChoices(): choice must be an object");if("string"!=typeof e.id)throw new Error("SelectableDocumentFilter._updateAvailableChoices(): choice.id must be a string")}),this.availableChoices=e,this.availableChoicesParameter.sendUpdate(),this.allSelected&&(this.selectedChoiceIdMap={},this.availableChoices.forEach(function(e){i.selectedChoiceIdMap[e.id]=!0}),this._selectionChanged(this.selectedChoiceIdMap,this.allSelected),this._filterChanged(),this.selectedChoicesParameter.sendUpdate())},_handleSelectableDocumentFilterEvents:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo(),e.modelInstance=this);else if("modelGetState"===e.type){if(this.modelId===e.modelId){var n=[];for(var r in this.docInfosByDocId){var o=this.docInfosByDocId[r];if(o.visible){var s=o.doc;n.push(s)}}e.state={added:n,updated:[],removed:[],loading:this.modelIsLoading}}}else"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){var e={modelId:this.modelId,modelType:"filter",parameters:{}};return this._addModelInfoParameters(e),e},_addModelInfoParameters:function(e){e.parameters.selectedChoices=this.selectedChoicesParameter.getInfo(),e.parameters.allSelected=this.allSelectedParameter.getInfo(),e.parameters.availableChoices=this.availableChoicesParameter.getInfo()},_sourceModelUpdated:function(e){var i=this,n=[],r=[],o=[];if("boolean"==typeof e.loading&&this.modelIsLoading!==e.loading&&(this.modelIsLoading=e.loading),e.added)for(var s=0,a=e.added.length;s<a;++s){var l=(h=e.added[s])._id;(u=this.docInfosByDocId[l])||(u={id:l,doc:h,visible:!1},this.docInfosByDocId[l]=u),(c=this._computeVisibility(h))&&(u.visible=c,n.push(h))}if(e.updated)for(s=0,a=e.updated.length;s<a;++s){var c;l=(h=e.updated[s])._id;(u=this.docInfosByDocId[l])||(u={id:l,doc:h,visible:!1},this.docInfosByDocId[l]=u),u.doc=h,(c=this._computeVisibility(h))?u.visible?r.push(h):n.push(h):u.visible&&o.push(h),u.visible=c}if(e.removed)for(s=0,a=e.removed.length;s<a;++s){l=(h=e.removed[s])._id;(u=this.docInfosByDocId[l])&&(delete this.docInfosByDocId[l],u.visible&&o.push(h))}this._reportStateUpdate(n,r,o);var d=[];for(var l in this.docInfosByDocId){var u,h=(u=this.docInfosByDocId[l]).doc;d.push(h)}var p=t.getUniqueId();this.currentChoiceGeneration=p;var f=this._computeAvailableChoicesFromDocs(d,m);function m(e){i.currentChoiceGeneration===p&&i._updateAvailableChoices(e)}f&&m(f)},_computeAvailableChoicesFromDocs:function(e,t){throw new Error("Subclasses to SelectableDocumentFilter must implement _computeAvailableChoicesFromDocs()")},_filterChanged:function(){var e=[],t=[];for(var i in this.docInfosByDocId){var n=this.docInfosByDocId[i],r=n.doc,o=this._computeVisibility(r);o?n.visible||e.push(r):n.visible&&t.push(r),n.visible=o}this._reportStateUpdate(e,[],t)},_reportStateUpdate:function(e,t,i){var r={added:e,updated:t,removed:i,loading:this.modelIsLoading};this.dispatchService&&this.dispatchService.send(n,{type:"modelStateUpdated",modelId:this.modelId,state:r})},_computeVisibility:function(e){return this._isDocVisible(e,this.selectedChoiceIdMap,this.allSelected)},_isDocVisible:function(e,t,i){throw new Error("Subclasses to SelectableDocumentFilter must implement _isDocVisible()")},_selectionChanged:function(e,t){}}),c=t.Class("DocumentFilterByCreator",l,{userInfoByName:null,currentChoices:null,currentCallback:null,initialize:function(e){var i=t.extend({modelId:null,sourceModelId:null,dispatchService:null},e),r=this;if(t.modelFilter.SelectableDocumentFilter.prototype.initialize.call(this,i),this.userInfoByName={},this.currentChoices=[],this.currentCallback=null,this.dispatchService){this.dispatchService.register(n,"userInfo",function(e,t,i){r._handleFilterByCreatorEvents(e,t,i)})}},_handleFilterByCreatorEvents:function(e,t,i){if("userInfo"===e.type){var n=e.userInfo,r=n.name;this.userInfoByName[r]=n,this._recomuteAvailableChoices()}},_recomuteAvailableChoices:function(){var e=this;if(this.currentChoices){var t=!1;this.currentChoices.forEach(function(i){var n,r=e.userInfoByName[i.id];r&&(n=r.display),n||(n=i.id),n!==i.label&&(i.label=n,t=!0)}),t&&(this.currentChoices.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),"function"==typeof this.currentCallback&&this.currentCallback(this.currentChoices))}},_computeAvailableChoicesFromDocs:function(e,t){var i=this,r={},o=[];e.forEach(function(e){if(e&&e.nunaliit_created){var t=e.nunaliit_created.name;i.userInfoByName[t]||o.push(t),t&&!r[t]&&(r[t]=t)}});var s=[];for(var a in r){var l=r[a];s.push({id:a,label:l})}return s.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),this.currentChoices=s,this.currentCallback=t,t(s),o.length>0&&o.forEach(function(e){i.dispatchService.send(n,{type:"requestUserDocument",userId:e})}),null},_isDocVisible:function(e,t){return!!(e&&e.nunaliit_created&&t[e.nunaliit_created.name])}}),d=t.Class("LayerFilter2",l,{layerDefinitionByLayerId:null,layerIdByDocId:null,currentChoices:null,currentCallback:null,initialize:function(e){var i=t.extend({modelId:null,sourceModelId:null,dispatchService:null},e),r=this;if(t.modelFilter.SelectableDocumentFilter.prototype.initialize.call(this,i),this.layerDefinitionByLayerId={},this.layerIdByDocId={},this.currentChoices=[],this.currentCallback=null,this.dispatchService){var o=function(e,t,i){r._handleLayerFilterEvents(e,t,i)};this.dispatchService.register(n,"documentContent",o),this.dispatchService.register(n,"documentContentCreated",o),this.dispatchService.register(n,"documentContentUpdated",o),this.dispatchService.register(n,"documentDeleted",o)}},_handleLayerFilterEvents:function(e,t,i){if("documentContent"===e.type||"documentContentCreated"===e.type||"documentContentUpdated"===e.type){if(e.doc)if(e.doc.nunaliit_layer_definition)(n=e.doc.nunaliit_layer_definition.id)||(n=e.doc._id),this.layerIdByDocId[e.doc._id]=n,this.layerDefinitionByLayerId[n]=e.doc,this._recomuteAvailableChoices();else if(this.layerIdByDocId[e.doc._id]){var n=this.layerIdByDocId[e.doc._id];delete this.layerIdByDocId[e.doc._id],delete this.layerDefinitionByLayerId[n],this._recomuteAvailableChoices()}}else if("documentDeleted"===e.type&&this.layerIdByDocId[e.docId]){n=this.layerIdByDocId[e.docId];delete this.layerIdByDocId[e.docId],delete this.layerDefinitionByLayerId[n],this._recomuteAvailableChoices()}},_recomuteAvailableChoices:function(){var e=this;if(this.currentChoices){var t=!1;this.currentChoices.forEach(function(n){var r,o=e.layerDefinitionByLayerId[n.id];o&&o.nunaliit_layer_definition&&o.nunaliit_layer_definition.name&&(r=i(o.nunaliit_layer_definition.name)),r||(r=n.id),r!==n.label&&(n.label=r,t=!0)}),t&&(this.currentChoices.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),"function"==typeof this.currentCallback&&this.currentCallback(this.currentChoices))}},_computeAvailableChoicesFromDocs:function(e,r){var o=this,s={},a=[];e.forEach(function(e){e&&t.isArray(e.nunaliit_layers)&&e.nunaliit_layers.forEach(function(e){var t=o.layerDefinitionByLayerId[e];t||a.push(e),e&&!s[e]&&(t&&t.nunaliit_layer_definition&&t.nunaliit_layer_definition.name?s[e]=i(t.nunaliit_layer_definition.name):s[e]=e)})});var l=[];for(var c in s){var d=s[c];l.push({id:c,label:d})}return l.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),this.currentChoices=l,this.currentCallback=r,r(l),a.length>0&&this.dispatchService.send(n,{type:"requestLayerDefinitions",layerIds:a}),null},_isDocVisible:function(e,i){if(e&&t.isArray(e.nunaliit_layers))for(var n in e.nunaliit_layers){if(i[e.nunaliit_layers[n]])return!0}return!1}}),u=t.Class("SchemaFilter",l,{schemaRepository:null,schemasByName:null,currentChoices:null,currentCallback:null,initialize:function(e){var i=t.extend({modelId:void 0,sourceModelId:void 0,dispatchService:void 0,schemaRepository:void 0,initialSelection:void 0,schemaName:void 0,schemaNames:void 0},e);"string"==typeof i.schemaName&&(i.initialSelection||(i.initialSelection=[]),i.initialSelection.push(i.schemaName)),t.isArray(i.schemaNames)&&(i.initialSelection||(i.initialSelection=[]),i.schemaNames.forEach(function(e){"string"==typeof e&&i.initialSelection.push(e)})),t.modelFilter.SelectableDocumentFilter.prototype.initialize.call(this,i),this.schemaRepository=i.schemaRepository,this.schemasByName={},this.currentChoices=[],this.currentCallback=null},_recomuteAvailableChoices:function(){var e=this;if(this.currentChoices){var t=!1;this.currentChoices.forEach(function(i){var n,r=e.schemasByName[i.id];r&&(n=r.getLabel()),n||(n=i.id),n!==i.label&&(i.label=n,t=!0)}),t&&(this.currentChoices.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),"function"==typeof this.currentCallback&&this.currentCallback(this.currentChoices))}},_computeAvailableChoicesFromDocs:function(e,i){var n=this,r={},o={};e.forEach(function(e){if(e&&"string"==typeof e.nunaliit_schema){var t=e.nunaliit_schema,i=n.schemasByName[t];i||(o[t]=!0),t&&!r[t]&&(r[t]=i?i.getLabel():t)}});var s=[];for(var a in r){var l=r[a];s.push({id:a,label:l})}s.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),this.currentChoices=s,this.currentCallback=i,i(s);var c=t.utils.keys(o);return c.length>0&&this.schemaRepository&&this.schemaRepository.getSchemas({names:c,onSuccess:function(e){e.forEach(function(e){var t=e.name;n.schemasByName[t]=e}),n._recomuteAvailableChoices()},onError:function(e){}}),null},_isDocVisible:function(e,t){return!e||"string"!=typeof e.nunaliit_schema||!!t[e.nunaliit_schema]}});t.modelFilter={ModelFilter:r,FilterFunctionFromModelConfiguration:function(e){if("filter"===e.modelType){if(e.condition){var i=t.styleRuleParser.parse(e.condition),n={n2_doc:null,n2_selected:!1,n2_hovered:!1,n2_found:!1,n2_intent:null},r=function(e){n.n2_doc=e;var t=i.getValue(n);return n.n2_doc=null,t};return r.NAME="filterOnCondition("+e.condition+")",r}if("all"===e.useBuiltInFunction){var o=function(e){return!0};return o.NAME="allDocuments",o}if("none"===e.useBuiltInFunction){var s=function(e){return!1};return s.NAME="noDocument",s}if("withDates"===e.useBuiltInFunction){var a=function(e){var i=[];return t.couchUtils.extractSpecificType(e,"date",i),i.length>0};return a.NAME="withDates",a}if("withoutDates"===e.useBuiltInFunction){var l=function(e){var i=[];return t.couchUtils.extractSpecificType(e,"date",i),i.length<1};return l.NAME="withoutDates",l}if("withoutGeometry"===e.useBuiltInFunction){var c=function(e){return!(!e||e.nunaliit_geom)};return c.NAME="withoutGeometry",c}}return null},SchemaFilterLegacy:o,ReferenceFilter:s,SelectableDocumentFilter:l,LayerFilter2:d,SchemaFilter:u,handleModelCreate:function(e,i,n){if("filter"===e.modelType){var l={};e&&e.modelOptions&&e.modelOptions.sourceModelId&&(l.sourceModelId=e.modelOptions.sourceModelId),l.modelId=e.modelId,l.modelType=e.modelType,e&&e.config&&e.config.directory&&(l.dispatchService=e.config.directory.dispatchService);var h=null;if(t.modelUtils.FilterFunctionFromModelConfiguration&&(h=t.modelUtils.FilterFunctionFromModelConfiguration(e.modelOptions)).NAME&&(l.filterName="FilterModel - "+h.NAME),!h)throw"Unable to find function for filter model";l.filterFn=h,e.model=new r(l),e.created=!0}else if("schemaFilterLegacy"===e.modelType){if(l={},e&&e.modelOptions)for(var p in e.modelOptions)l[p]=e.modelOptions[p];l.modelId=e.modelId,l.modelType=e.modelType,e&&e.config&&e.config.directory&&(l.dispatchService=e.config.directory.dispatchService),e.model=new o(l),e.created=!0}else if("referenceFilter"===e.modelType){if(l={},e&&e.modelOptions)for(var p in e.modelOptions)l[p]=e.modelOptions[p];l.modelId=e.modelId,l.modelType=e.modelType,e&&e.config&&e.config.directory&&(l.dispatchService=e.config.directory.dispatchService),e.model=new s(l),e.created=!0}else if("singleDocumentFilter"===e.modelType){if(l={},e&&e.modelOptions)for(var p in e.modelOptions)l[p]=e.modelOptions[p];l.modelId=e.modelId,l.modelType=e.modelType,e&&e.config&&e.config.directory&&(l.dispatchService=e.config.directory.dispatchService),e.model=new a(l),e.created=!0}else if("documentFilterByCreator"===e.modelType){if(l={},e&&e.modelOptions)for(var p in e.modelOptions)l[p]=e.modelOptions[p];l.modelId=e.modelId,l.modelType=e.modelType,e&&e.config&&e.config.directory&&(l.dispatchService=e.config.directory.dispatchService),e.model=new c(l),e.created=!0}else if("layerFilter2"===e.modelType){if(l={},e&&e.modelOptions)for(var p in e.modelOptions)l[p]=e.modelOptions[p];l.modelId=e.modelId,l.modelType=e.modelType,e&&e.config&&e.config.directory&&(l.dispatchService=e.config.directory.dispatchService),e.model=new d(l),e.created=!0}else if("schemaFilter"===e.modelType){if(l={},e&&e.modelOptions)for(var p in e.modelOptions)l[p]=e.modelOptions[p];l.modelId=e.modelId,l.modelType=e.modelType,e&&e.config&&e.config.directory&&(l.dispatchService=e.config.directory.dispatchService,l.schemaRepository=e.config.directory.schemaRepository),e.model=new u(l),e.created=!0}}}}(jQuery,nunaliit2),function(e,t){var i="n2.modelFilterSimultaneous",n=t.Class({dispatchService:null,wrappingModelId:null,docModelId:null,filterModel:null,modelParameter:null,currentChoices:null,initialize:function(e){var n=t.extend({dispatchService:void 0,wrappingModelId:void 0,docModelId:void 0,filterModel:void 0},e);this.dispatchService=n.dispatchService,this.wrappingModelId=n.wrappingModelId,this.docModelId=n.docModelId,this.filterModel=n.filterModel;var r,o,s=this;if(!this.dispatchService)throw new Error("AvailableChoicesWrapper requires dispatchService");if(!this.filterModel)throw new Error('Option "filterModel" must be provided');if("function"!=typeof this.filterModel._computeAvailableChoicesFromDocs)throw new Error('The instance of "filterModel" must support _computeAvailableChoicesFromDocs(): '+this.filterModel._classname);if(this.currentChoices=[],this.modelParameter=new t.model.ModelParameter({model:this,modelId:this.wrappingModelId,type:"objects",name:"availableChoices",label:(r="Available Choices",t.loc(r,"nunaliit2",o)),setFn:this._setAvailableChoices,getFn:this._getAvailableChoices,dispatchService:this.dispatchService}),this.dispatchService){this.dispatchService.register(i,"modelStateUpdated",function(e,t,i){s._handle(e,t,i)}),this._sourceModelUpdated()}},getInfo:function(){return this.modelParameter.getInfo()},_handle:function(e,t,i){"modelStateUpdated"===e.type&&this.sourceModelId===e.docModelId&&this._sourceModelUpdated()},_sourceModelUpdated:function(){var e=this,i=t.model.getModelState({dispatchService:this.dispatchService,modelId:this.docModelId});i&&i.added&&this.filterModel._computeAvailableChoicesFromDocs(i.added,function(t){e._choicesUpdated(t)})},_choicesUpdated:function(e){this.currentChoices=e,this.modelParameter.sendUpdate()},_setAvailableChoices:function(){throw new Error("This function should never be called")},_getAvailableChoices:function(){return this.currentChoices}}),r=t.Class("SimultaneousFilters",{config:null,dispatchService:null,modelId:null,sourceModelId:null,filterInfosByModelId:null,intersectionModel:null,initialize:function(e){var r=t.extend({config:void 0,dispatchService:void 0,modelId:void 0,sourceModelId:void 0,filters:void 0},e),o=this;if(this.config=r.config,this.dispatchService=r.dispatchService,this.modelId=r.modelId,this.sourceModelId=r.sourceModelId,!this.dispatchService)throw new Error("Dispatch Service required for SimultaneousFilters");this.filterInfosByModelId={};var s=0;if(r.filters&&t.isArray(r.filters)&&r.filters.forEach(function(e,n){if("object"!=typeof e)throw new Error("Filter definitions must be objects");var r=void 0,a=void 0,l={};for(var c in e){var d=e[c];"sourceModelId"===c?t.log('Attribute "sourceModelId" should not be specified in a filter definition within "simultaneousFilters"'):"modelId"===c?r=d:"modelType"===c?(a=d,l[c]=d):l[c]=d}if(!r)throw new Error('Attribute "modelId" must be provided for filter definitions within "simultaneousFilters"');if(!a)throw new Error('Attribute "modelType" must be provided for filter definitions within "simultaneousFilters"');var u=o.modelId+"_filter_"+r;l.sourceModelId=o.sourceModelId,l.modelId=u;var h={type:"modelCreate",modelId:u,modelType:a,modelOptions:l,config:o.config};if(o.dispatchService.synchronousCall(i,h),!h.created)throw new Error("Unknown modelType: "+a);if(!h.model)throw new Error("Invalid modelType: "+a);var p={declaredModelId:r,effectiveModelId:u,modelType:a,model:h.model};o.filterInfosByModelId[r]=p,++s}),s<=1)throw new Error("Requires at least two filters");var a=[];for(var l in this.filterInfosByModelId){var c=this.filterInfosByModelId[l];a.push(c.effectiveModelId)}for(var d in this.intersectionModel=new t.modelUtils.ModelIntersect({dispatchService:this.dispatchService,modelId:this.modelId,sourceModelIds:a}),this.filterInfosByModelId){c=this.filterInfosByModelId[d];var u=[];for(var h in this.filterInfosByModelId)if(h!==d){var p=this.filterInfosByModelId[h];u.push(p.effectiveModelId)}var f=this.modelId+"_inter_"+c.declaredModelId;c.availableChoicesModel=new t.modelUtils.ModelIntersect({dispatchService:this.dispatchService,modelId:f,sourceModelIds:u});var m=new n({dispatchService:this.dispatchService,wrappingModelId:d,docModelId:f,filterModel:c.model});c.availableChoicesParameter=m}if(this.dispatchService){var v=function(e,t,i){o._handle(e,t,i)};this.dispatchService.register(i,"modelGetInfo",v),this.dispatchService.register(i,"modelGetState",v)}t.log(this._classname,this)},_handle:function(e,i,n){if("modelGetInfo"===e.type){if(o=this.filterInfosByModelId[e.modelId]){var r=t.model.getModelInfo({dispatchService:this.dispatchService,modelId:o.effectiveModelId});r&&(r.parameters&&r.parameters.availableChoices?r.parameters.availableChoices=o.availableChoicesParameter.getInfo():t.logError('Underlying filter model is supposed to report "availableChoices" parameter: '+e.modelId),e.modelInfo=r)}}else if("modelGetState"===e.type){var o;if(o=this.filterInfosByModelId[e.modelId]){var s=t.model.getModelState({dispatchService:this.dispatchService,modelId:o.effectiveModelId});s&&(e.state=s)}}}});t.modelFilterSimultaneous={SimultaneousFilters:r,handleModelCreate:function(e,i,n){if("simultaneousFilters"===e.modelType)try{var o={};if(e&&e.modelOptions)for(var s in e.modelOptions){var a=e.modelOptions[s];o[s]=a}o.modelId=e.modelId,o.modelType=e.modelType,e&&e.config&&(o.config=e.config,e.config.directory&&(o.dispatchService=e.config.directory.dispatchService)),e.model=new r(o),e.created=!0}catch(e){t.logError("Error while creating SimultaneousFilters",e)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.modelUtils",n=t.Class({dispatchService:null,modelId:null,sourceModelIds:null,docInfosByDocId:null,loadingMap:null,initialize:function(e){var n=t.extend({dispatchService:null,modelId:null,sourceModelIds:null},e),r=this;if(this.dispatchService=n.dispatchService,this.modelId=n.modelId,this.sourceModelIds={},n.sourceModelIds)for(var o=0,s=n.sourceModelIds.length;o<s;++o){var a=n.sourceModelIds[o];this.sourceModelIds[a]={}}if(this.docInfosByDocId={},this.loadingMap={},this.dispatchService){var l=function(e,t,i){r._handle(e,t,i)};for(var a in this.dispatchService.register(i,"modelGetInfo",l),this.dispatchService.register(i,"modelGetState",l),this.dispatchService.register(i,"modelStateUpdated",l),this.sourceModelIds){var c=t.model.getModelState({dispatchService:this.dispatchService,modelId:a});c&&this._sourceModelUpdated(a,c)}}t.log("UnionModel",this)},isLoading:function(){for(var e in this.loadingMap){if(this.loadingMap[e])return!0}return!1},_handle:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo());else if("modelGetState"===e.type){if(this.modelId===e.modelId){var n=[];for(var r in this.docInfosByDocId){var o=this.docInfosByDocId[r].doc;n.push(o)}e.state={added:n,updated:[],removed:[],loading:this.isLoading()}}}else"modelStateUpdated"===e.type&&this.sourceModelIds[e.modelId]&&this._sourceModelUpdated(e.modelId,e.state)},_getModelInfo:function(){return{modelId:this.modelId,modelType:"union",parameters:{}}},_sourceModelUpdated:function(e,t){if(this.sourceModelIds[e]){var i=[],n=[],r=[];"boolean"==typeof t.loading&&(this.loadingMap[e]=t.loading);var o=t.added?t.added.slice(0):[];t.updated&&o.push.apply(o,t.updated);for(var s=0,a=o.length;s<a;++s){var l=(c=o[s])._id;(d=this.docInfosByDocId[l])||(d={id:l,doc:c,rev:c._rev,sources:{}},this.docInfosByDocId[l]=d,i.push(c)),d.sources[e]=!0,d.rev!==c._rev&&(d.doc=c,d.rev=c._rev,n.push(c))}if(t.removed)for(s=0,a=t.removed.length;s<a;++s){var c,d;l=(c=t.removed[s])._id;if(d=this.docInfosByDocId[l]){d.sources[e]=!1;var u=!0;for(var h in d.sources)d.sources[h]&&(u=!1);u&&(delete this.docInfosByDocId[l],r.push(c))}}this._reportStateUpdate(i,n,r)}},_reportStateUpdate:function(e,t,n){var r={added:e,updated:t,removed:n,loading:this.isLoading()};this.dispatchService&&this.dispatchService.send(i,{type:"modelStateUpdated",modelId:this.modelId,state:r})}}),r=t.Class({dispatchService:null,modelId:null,sourceModelIds:null,docInfosByDocId:null,loadingMap:null,initialize:function(e){var n=t.extend({dispatchService:null,modelId:null,sourceModelIds:null},e),r=this;if(this.dispatchService=n.dispatchService,this.modelId=n.modelId,this.sourceModelIds={},n.sourceModelIds)for(var o=0,s=n.sourceModelIds.length;o<s;++o){var a=n.sourceModelIds[o];this.sourceModelIds[a]={}}if(this.docInfosByDocId={},this.loadingMap={},this.dispatchService){var l=function(e,t,i){r._handle(e,t,i)};for(var a in this.dispatchService.register(i,"modelGetInfo",l),this.dispatchService.register(i,"modelGetState",l),this.dispatchService.register(i,"modelStateUpdated",l),this.sourceModelIds){var c=t.model.getModelState({dispatchService:this.dispatchService,modelId:a});c&&this._sourceModelUpdated(a,c)}}t.log("IntersectModel",this)},isLoading:function(){for(var e in this.loadingMap){if(this.loadingMap[e])return!0}return!1},_handle:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo());else if("modelGetState"===e.type){if(this.modelId===e.modelId){var n=[];for(var r in this.docInfosByDocId){var o=this.docInfosByDocId[r];if(o.visible){var s=o.doc;n.push(s)}}e.state={added:n,updated:[],removed:[],loading:this.isLoading()}}}else"modelStateUpdated"===e.type&&this.sourceModelIds[e.modelId]&&this._sourceModelUpdated(e.modelId,e.state)},_getModelInfo:function(){return{modelId:this.modelId,modelType:"intersect",parameters:{}}},_sourceModelUpdated:function(e,t){if(this.sourceModelIds[e]){var i=[],n=[],r=[];"boolean"==typeof t.loading&&(this.loadingMap[e]=t.loading);var o=t.added?t.added.slice(0):[];t.updated&&o.push.apply(o,t.updated);for(var s=0,a=o.length;s<a;++s){var l=(u=o[s])._id;(h=this.docInfosByDocId[l])||(h={id:l,visible:!1,doc:u,rev:u._rev,sources:{}},this.docInfosByDocId[l]=h),h.sources[e]=!0;var c=!1;h.rev!==u._rev&&(h.doc=u,h.rev=u._rev,c=!0);var d=this._isDocVisible(u);d&&!h.visible?i.push(u):!d&&h.visible?r.push(u):d&&h.visible&&c&&n.push(u),h.visible=d}if(t.removed)for(s=0,a=t.removed.length;s<a;++s){var u,h;l=(u=t.removed[s])._id;if(h=this.docInfosByDocId[l]){h.sources[e]=!1,h.visible&&(h.visible=!1,r.push(u));var p=!0;for(var f in h.sources)h.sources[f]&&(p=!1);p&&delete this.docInfosByDocId[l]}}this._reportStateUpdate(i,n,r)}},_reportStateUpdate:function(e,t,n){var r={added:e,updated:t,removed:n,loading:this.isLoading()};this.dispatchService&&this.dispatchService.send(i,{type:"modelStateUpdated",modelId:this.modelId,state:r})},_isDocVisible:function(e){var t=e._id,i=this.docInfosByDocId[t];for(var n in this.sourceModelIds)if(!i.sources[n])return!1;return!0}}),o=t.Class("StaticDocumentSource",t.model.DocumentModel,{docsById:null,initialize:function(e){var i=t.extend({dispatchService:null,modelId:null,modelType:null,docs:null},e);t.model.DocumentModel.prototype.initialize.call(this,i),this.docsById={},t.log("StaticDocumentSource",this),t.isArray(i.docs)&&this.setDocuments(i.docs)},setDocuments:function(e){var t=this,i=[],n=[],r=[],o={};for(var s in e.forEach(function(e){if(e&&e._id){var r=e._id;o[r]=e,t.docsById?n.push(e):i.push(e)}}),this.docsById){var a=this.docsById[s];o[s]||r.push(a)}this.docsById=o,this._reportStateUpdate(i,n,r)},_getCurrentDocuments:function(){var e=[];for(var t in this.docsById){var i=this.docsById[t];e[e.length]=i}return e},_isLoading:function(){return!1}});t.modelUtils={ModelUnion:n,ModelIntersect:r,StaticDocumentSource:o,handleModelCreate:function(e,t,i){if("union"===e.modelType){var s={};e&&e.modelOptions&&e.modelOptions.sourceModelIds&&e.modelOptions.sourceModelIds.length&&(s.sourceModelIds=e.modelOptions.sourceModelIds),s.modelId=e.modelId,s.modelType=e.modelType,e&&e.config&&e.config.directory&&(s.dispatchService=e.config.directory.dispatchService),e.model=new n(s),e.created=!0}else if("intersect"===e.modelType)s={},e&&e.modelOptions&&e.modelOptions.sourceModelIds&&e.modelOptions.sourceModelIds.length&&(s.sourceModelIds=e.modelOptions.sourceModelIds),s.modelId=e.modelId,s.modelType=e.modelType,e&&e.config&&e.config.directory&&(s.dispatchService=e.config.directory.dispatchService),e.model=new r(s),e.created=!0;else if("staticDocumentSource"===e.modelType){if(s={},e&&e.modelOptions)for(var a in e.modelOptions)s[a]=e.modelOptions[a];s.modelId=e.modelId,s.modelType=e.modelType,e&&e.config&&e.config.directory&&(s.dispatchService=e.config.directory.dispatchService),e.model=new o(s),e.created=!0}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.modelTime",r=t.Class({dispatchService:null,modelId:null,autoRange:null,range:null,rangeParameter:null,interval:null,intervalParameter:null,now:null,initialize:function(e){var n=t.extend({dispatchService:null,modelId:null,range:null},e);this.docInfosByDocId={},this.now=Date.now(),this.dispatchService=n.dispatchService,this.modelId=n.modelId,this.autoRange=!0,n.range&&(this.range=t.date.parseUserDate(n.range),this.range&&this.range.ongoing&&(this.range.ongoing=!1,this.range.max=this.now),this.interval=this.range,this.autoRange=!1),this.rangeParameter=new t.model.ModelParameter({model:this,modelId:this.modelId,type:"dateInterval",name:"range",label:i("Range"),setFn:this._setRange,getFn:this.getRange,dispatchService:this.dispatchService}),this.intervalParameter=new t.model.ModelParameter({model:this,modelId:this.modelId,type:"dateInterval",name:"interval",label:i("Interval"),setFn:this._setInterval,getFn:this.getInterval,dispatchService:this.dispatchService})},getRange:function(){return this.range},_setRange:function(e){var t=this.getRange();this.range=e,this.range&&this.range.ongoing&&(this.range.max=this.now,this.range.ongoing=!1);var i=this.getRange();if(i===t);else if(t&&t.equals(i));else if(this.rangeParameter.sendUpdate(),this.interval)if(this.range){if(this.interval.min<this.range.min||this.interval.max>this.range.max){var n=this.range.intersection(this.interval);this._setInterval(n)}}else this._setInterval(null);else this.intervalParameter.sendUpdate(),this._intervalUpdated()},getInterval:function(){return this.interval?this.interval:this.range},_setInterval:function(e){var t=this.getInterval();this.interval=e,this.interval&&this.interval.ongoing&&(this.interval.max=this.now);var i=this.getInterval();t===i||t&&t.equals(i)||(this.intervalParameter.sendUpdate(),this._intervalUpdated())},_addModelInfoParameters:function(e){e.parameters||(e.parameters={}),e.parameters.range=this.rangeParameter.getInfo(),e.parameters.interval=this.intervalParameter.getInfo()},_intervalUpdated:function(){throw new Error("Subclasses to TimeIntervalModel must implement _intervalUpdated()")}}),o=t.Class("TimeFilter",r,{sourceModelId:null,selectors:null,allowNoDate:null,docInfosByDocId:null,modelIsLoading:null,initialize:function(e){var i=t.extend({sourceModelId:null,selectors:null,allowNoDate:!1},e);r.prototype.initialize.apply(this,arguments);var o=this;if(this.sourceModelId=i.sourceModelId,this.allowNoDate=i.allowNoDate,t.isArray(i.selectors)){this.selectors=[];for(var s=0,a=i.selectors.length;s<a;++s){var l=i.selectors[s];"string"==typeof l&&(l=t.objectSelector.parseSelector(l)),l&&this.selectors.push(l)}}else this.selectors=[new t.objectSelector.ObjectSelector([])];if(this.docInfosByDocId={},this.modelIsLoading=!1,this.dispatchService){var c=function(e,t,i){o._handle(e,t,i)};this.dispatchService.register(n,"modelGetInfo",c),this.dispatchService.register(n,"modelGetState",c),this.dispatchService.register(n,"modelStateUpdated",c);var d={type:"modelGetState",modelId:this.sourceModelId};this.dispatchService.synchronousCall(n,d),d.state&&this._sourceModelUpdated(d.state)}t.log("TimeFilter",this)},_handle:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo());else if("modelGetState"===e.type){if(this.modelId===e.modelId){var n=[];for(var r in this.docInfosByDocId){var o=this.docInfosByDocId[r],s=o.doc;o.visible&&n.push(s)}e.state={added:n,updated:[],removed:[],loading:this.modelIsLoading}}}else"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){var e={modelId:this.modelId,modelType:"timeFilter",parameters:{}};return this._addModelInfoParameters(e),e},_sourceModelUpdated:function(e){var i=[],n=[],r=[],o=Date.now();if("boolean"==typeof e.loading&&this.modelIsLoading!==e.loading&&(this.modelIsLoading=e.loading),e.added)for(var s=0,a=e.added.length;s<a;++s){var l={id:d=(p=e.added[s])._id,doc:p,intervals:u=this._getTimeIntervalsFromDoc(p),visible:!1},c=this._computeVisibility(l,o);l.visible=c,this.docInfosByDocId[d]=l,l.visible&&i.push(p)}if(e.updated)for(s=0,a=e.updated.length;s<a;++s){var d=(p=e.updated[s])._id,u=(l=this.docInfosByDocId[d],this._getTimeIntervalsFromDoc(p));l||(l={id:d,doc:p,visible:!1},this.docInfosByDocId[d]=l),l.doc=p,l.intervals=u;var h=(c=this._computeVisibility(l,o))!==l.visible;l.visible=c,h?l.visible?i.push(p):r.push(p):l.visible&&n.push(p)}if(e.removed)for(s=0,a=e.removed.length;s<a;++s){var p;d=(p=e.removed[s])._id;(l=this.docInfosByDocId[d])&&(delete this.docInfosByDocId[d],l.visible&&r.push(p))}if(this._reportStateUpdate(i,n,r),this.autoRange){var f=null;for(var d in this.docInfosByDocId){if((l=this.docInfosByDocId[d])&&l.intervals)for(s=0,a=l.intervals.length;s<a;++s){var m=l.intervals[s];f=f?f.extendTo(m,o):m}}if(f){var v=f.getMin(),g=f.getMax(o);this.range&&v==this.range.getMin()&&g==this.range.getMax(o)||(f=new t.date.DateInterval({min:v,max:g,ongoing:!1}),this._setRange(f))}else this._setRange(null)}},_intervalUpdated:function(){var e=[],t=[],i=Date.now();for(var n in this.docInfosByDocId){var r=this.docInfosByDocId[n],o=r.doc,s=this._computeVisibility(r,i),a=s!==r.visible;r.visible=s,a&&(r.visible?e.push(o):t.push(o))}this._reportStateUpdate(e,[],t)},_reportStateUpdate:function(e,t,i){var r={added:e,updated:t,removed:i,loading:this.modelIsLoading};this.dispatchService&&this.dispatchService.send(n,{type:"modelStateUpdated",modelId:this.modelId,state:r})},_computeVisibility:function(e,t){var i=this.getInterval();if(e&&e.intervals)if(e.intervals.length>0&&i)for(var n=0,r=e.intervals.length;n<r;++n){if(e.intervals[n].intersectsWith(i,t))return!0}else if(e.intervals.length<1&&this.allowNoDate)return!0;return!1},_getTimeIntervalsFromDoc:function(e){for(var i=[],n=0,r=this.selectors.length;n<r;++n){this.selectors[n].traverse(e,function(e,n){if("object"==typeof e&&null!==e&&"date"===e.nunaliit_type&&"string"==typeof e.date){var r=t.date.parseDateStructure(e);r&&i.push(r)}})}return i}}),s=t.Class("TimeTransform",r,{sourceModelId:null,docInfosByDocId:null,modelIsLoading:null,initialize:function(e){var i=t.extend({sourceModelId:null},e);r.prototype.initialize.apply(this,arguments);var o=this;if(this.sourceModelId=i.sourceModelId,this.docInfosByDocId={},this.modelIsLoading=!1,this.now=Date.now(),this.dispatchService){var s=function(e,t,i){o._handle(e,t,i)};this.dispatchService.register(n,"modelGetInfo",s),this.dispatchService.register(n,"modelGetState",s),this.dispatchService.register(n,"modelStateUpdated",s);var a={type:"modelGetState",modelId:this.sourceModelId};this.dispatchService.synchronousCall(n,a),a.state&&this._sourceModelUpdated(a.state)}t.log("TimeTransform",this)},_handle:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo());else if("modelGetState"===e.type){if(this.modelId===e.modelId){var n=[];for(var r in this.docInfosByDocId){var o=this.docInfosByDocId[r].doc;n.push(o)}e.state={added:n,updated:[],removed:[],loading:this.modelIsLoading}}}else"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){var e={modelId:this.modelId,modelType:"timeTransform",parameters:{}};return this._addModelInfoParameters(e),e},_sourceModelUpdated:function(e){var i=[],n=[],r=[],o=this;if("boolean"==typeof e.loading&&this.modelIsLoading!==e.loading&&(this.modelIsLoading=e.loading),e.added)for(var s=0,a=e.added.length;s<a;++s){var l=(p=e.added[s])._id,c=y(p);this.docInfosByDocId[l]=c,i.push(c.doc)}if(e.updated)for(s=0,a=e.updated.length;s<a;++s){l=(p=e.updated[s])._id;if(c=this.docInfosByDocId[l]){var d=this._getTimeIntervalsFromDoc(p),u={_n2TimeTransform:this._computeTransform(d,this.now)};for(var h in p)u[h]=p[h];c.doc=u,c.intervals=d,n.push(c.doc)}else{c=y(p);this.docInfosByDocId[l]=c,i.push(c.doc)}}if(e.removed)for(s=0,a=e.removed.length;s<a;++s){var p;l=(p=e.removed[s])._id;(c=this.docInfosByDocId[l])&&(delete this.docInfosByDocId[l],r.push(p))}if(this._reportStateUpdate(i,n,r),this.autoRange){var f=null;for(var l in this.docInfosByDocId){if((c=this.docInfosByDocId[l])&&c.intervals)for(s=0,a=c.intervals.length;s<a;++s){var m=c.intervals[s];f=f?f.extendTo(m,this.now):m}}if(f){var v=f.getMin(),g=f.getMax(this.now);this.range&&v==this.range.getMin()&&g==this.range.getMax(this.now)||(f=new t.date.DateInterval({min:v,max:g,ongoing:!1}),this._setRange(f))}else this._setRange(null)}function y(e){var t=e._id,i=o._getTimeIntervalsFromDoc(e),n={_n2TimeTransform:o._computeTransform(i,o.now)};for(var r in e)n[r]=e[r];return{id:t,doc:n,intervals:i}}},_intervalUpdated:function(){var e=[];for(var t in this.docInfosByDocId){var i=this.docInfosByDocId[t],n=i.doc,r=i.intervals,o=this._computeTransform(r,this.now);this._areTransformsEqual(o,n._n2TimeTransform)||(n._n2TimeTransform=o,e.push(n))}this._reportStateUpdate([],e,[])},_reportStateUpdate:function(e,t,i){var r={added:e,updated:t,removed:i,loading:this.modelIsLoading};this.dispatchService&&this.dispatchService.send(n,{type:"modelStateUpdated",modelId:this.modelId,state:r})},_computeTransform:function(e,t){var i=this.getInterval(),n=!1,r=0,o=0,s=0;if(i&&(s=i.size(t),e))for(var a=0,l=e.length;a<l;++a){var c=e[a];r+=c.size(t);var d=c.intersection(i,t);d&&(n=!0,o+=d.size(t))}return n||(s=0),{intersects:n,intervalSize:r,intersectionSize:o,filterIntervalSize:s}},_areTransformsEqual:function(e,t){return e===t||!!e&&(!!t&&(e.intersects===t.intersects&&(e.intervalSize===t.intervalSize&&(e.intersectionSize===t.intersectionSize&&e.filterIntervalSize===t.filterIntervalSize))))},_getTimeIntervalsFromDoc:function(e){var i=[];t.couchUtils.extractSpecificType(e,"date",i);for(var n=[],r=0,o=i.length;r<o;++r){var s=i[r],a=t.date.parseDateStructure(s);a&&n.push(a)}return n}}),a=t.Class("DatedReferenceTransform",r,{sourceModelId:null,docInfosByDocId:null,modelIsLoading:null,initialize:function(e){var i=t.extend({sourceModelId:null},e);r.prototype.initialize.apply(this,arguments);var o=this;if(this.docInfosByDocId={},this.modelIsLoading=!1,this.sourceModelId=i.sourceModelId,this.dispatchService){var s=function(e,t,i){o._handle(e,t,i)};this.dispatchService.register(n,"modelGetInfo",s),this.dispatchService.register(n,"modelGetState",s),this.dispatchService.register(n,"modelStateUpdated",s);var a={type:"modelGetState",modelId:this.sourceModelId};this.dispatchService.synchronousCall(n,a),a.state&&this._sourceModelUpdated(a.state)}t.log("DatedReferenceTransform",this)},_handle:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo());else if("modelGetState"===e.type){if(this.modelId===e.modelId){var n=[];for(var r in this.docInfosByDocId){var o=this.docInfosByDocId[r].doc;n.push(o)}e.state={added:n,updated:[],removed:[],loading:this.modelIsLoading}}}else"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){var e={modelId:this.modelId,modelType:"datedReferenceTransform",parameters:{}};return this._addModelInfoParameters(e),e},_sourceModelUpdated:function(e){var i=[],n=[],r=[],o=this;if("boolean"==typeof e.loading&&this.modelIsLoading!==e.loading&&(this.modelIsLoading=e.loading),e.added)for(var s=0,a=e.added.length;s<a;++s){var l=(h=e.added[s])._id,c=g(h);this.docInfosByDocId[l]=c,i.push(c.doc)}if(e.updated)for(s=0,a=e.updated.length;s<a;++s){l=(h=e.updated[s])._id;if(c=this.docInfosByDocId[l]){var d=this._getIntervalInfosFromDoc(h),u=this._computeTransform(h,d);c.sourceDoc=h,c.doc=u,c.intervalInfos=d,n.push(c.doc)}else{c=g(h);this.docInfosByDocId[l]=c,i.push(c.doc)}}if(e.removed)for(s=0,a=e.removed.length;s<a;++s){var h;l=(h=e.removed[s])._id;(c=this.docInfosByDocId[l])&&(delete this.docInfosByDocId[l],r.push(h))}if(this._reportStateUpdate(i,n,r),this.autoRange){var p=null;for(var l in this.docInfosByDocId){if((c=this.docInfosByDocId[l])&&c.intervalInfos)for(s=0,a=c.intervalInfos.length;s<a;++s){var f=c.intervalInfos[s].interval;p=p?p.extendTo(f,this.now):f}}if(p){var m=p.getMin(),v=p.getMax(this.now);this.range&&m==this.range.getMin()&&v==this.range.getMax(this.now)||(p=new t.date.DateInterval({min:m,max:v,ongoing:!1}),this._setRange(p))}else this._setRange(null)}function g(e){var t=h._id,i=o._getIntervalInfosFromDoc(e);return{id:t,doc:o._computeTransform(e,i),sourceDoc:e,intervalInfos:i}}},_intervalUpdated:function(){var e=[],t=this.getInterval();for(var i in this.docInfosByDocId){for(var n=this.docInfosByDocId[i],r=(n.doc,!1),o=n.intervalInfos,s=0,a=o.length;s<a;++s){var l=o[s],c=l.interval,d=!1;t&&t.intersectsWith(c,this.now)&&(d=!0),l.visible!==d&&(r=!0,l.visible=d)}if(r){var u=this._computeTransform(n.sourceDoc,o);n.doc=u,e.push(u)}}this._reportStateUpdate([],e,[])},_reportStateUpdate:function(e,t,i){var r={added:e,updated:t,removed:i,loading:this.modelIsLoading};this.dispatchService&&this.dispatchService.send(n,{type:"modelStateUpdated",modelId:this.modelId,state:r})},_computeTransform:function(e,i){for(var n=t.extend(!0,{},e),r=0,o=i.length;r<o;++r){var s=i[r];s.visible||s.selector.setValue(n,null)}return n},_getIntervalInfosFromDoc:function(e){for(var i=this.getInterval(),n=t.objectSelector.findSelectors(e,function(e){return!(null===e||"object"!=typeof e||"reference"!==e.nunaliit_type||!e.date||"date"!==e.date.nunaliit_type)}),r=[],o=0,s=n.length;o<s;++o){var a=n[o],l=a.getValue(e).date,c=t.date.parseDateStructure(l);if(c){var d={interval:c,selector:a,visible:!1};i&&i.intersectsWith(c,this.now)&&(d.visible=!0),r.push(d)}}return r}}),l=t.Class({dispatchService:null,modelId:null,sourceModelId:null,docInfosByDocId:null,modelIsLoading:null,initialize:function(e){var i=t.extend({dispatchService:null,modelId:null,sourceModelId:null},e),r=this;if(this.dispatchService=i.dispatchService,this.modelId=i.modelId,this.sourceModelId=i.sourceModelId,this.docInfosByDocId={},this.modelIsLoading=!1,this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(n,"modelGetInfo",o),this.dispatchService.register(n,"modelGetState",o),this.dispatchService.register(n,"modelStateUpdated",o);var s={type:"modelGetState",modelId:this.sourceModelId};this.dispatchService.synchronousCall(n,s),s.state&&this._sourceModelUpdated(s.state)}t.log("NoTimeFilter",this)},_handle:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo());else if("modelGetState"===e.type){if(this.modelId===e.modelId){var n=[];for(var r in this.docInfosByDocId){var o=this.docInfosByDocId[r],s=o.doc;o.visible&&n.push(s)}e.state={added:n,updated:[],removed:[],loading:this.modelIsLoading}}}else"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){return{modelId:this.modelId,modelType:"noTimeFilter",parameters:{}}},_sourceModelUpdated:function(e){var t=[],i=[],n=[];if("boolean"==typeof e.loading&&this.modelIsLoading!==e.loading&&(this.modelIsLoading=e.loading),e.added)for(var r=0,o=e.added.length;r<o;++r){var s={id:l=(u=e.added[r])._id,doc:u,intervals:c=this._getTimeIntervalsFromDoc(u),visible:!1},a=this._computeVisibility(s);s.visible=a,this.docInfosByDocId[l]=s,s.visible&&t.push(u)}if(e.updated)for(r=0,o=e.updated.length;r<o;++r){var l=(u=e.updated[r])._id,c=(s=this.docInfosByDocId[l],this._getTimeIntervalsFromDoc(u));s||(s={id:l,doc:u,visible:!1},this.docInfosByDocId[l]=s),s.doc=u,s.intervals=c;var d=(a=this._computeVisibility(s))!==s.visible;s.visible=a,d?s.visible?t.push(u):n.push(u):s.visible&&i.push(u)}if(e.removed)for(r=0,o=e.removed.length;r<o;++r){var u;l=(u=e.removed[r])._id;(s=this.docInfosByDocId[l])&&(delete this.docInfosByDocId[l],s.visible&&n.push(u))}this._reportStateUpdate(t,i,n)},_reportStateUpdate:function(e,t,i){var r={added:e,updated:t,removed:i,loading:this.modelIsLoading};this.dispatchService&&this.dispatchService.send(n,{type:"modelStateUpdated",modelId:this.modelId,state:r})},_computeVisibility:function(e){return!(e&&e.intervals&&e.intervals.length>0)},_getTimeIntervalsFromDoc:function(e){var i=[];t.couchUtils.extractSpecificType(e,"date",i);for(var n=[],r=0,o=i.length;r<o;++r){var s=i[r],a=t.date.parseDateStructure(s);a&&n.push(a)}return n}}),c=t.Class("TimeSynchronize",{dispatchService:null,modelId:null,rangeChangeEvent:null,rangeSetEvent:null,rangeGetEvent:null,currentRange:null,intervalChangeEvent:null,intervalSetEvent:null,intervalGetEvent:null,currentInterval:null,sourceModelsById:null,now:null,initialize:function(e){var i=t.extend({dispatchService:null,modelId:null,sourceModelIds:null},e),r=this;if(this.sourceModelsById={},this.dispatchService=i.dispatchService,this.modelId=i.modelId,this.now=Date.now(),this.rangeChangeEvent=this.modelId+"_range_change_event",this.rangeSetEvent=this.modelId+"_range_set_event",this.rangeGetEvent=this.modelId+"_range_get_event",this.intervalChangeEvent=this.modelId+"_interval_change_event",this.intervalSetEvent=this.modelId+"_interval_set_event",this.intervalGetEvent=this.modelId+"_interval_get_event",this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};if(this.dispatchService.register(n,"modelGetInfo",o),this.dispatchService.register(n,this.rangeGetEvent,o),this.dispatchService.register(n,this.intervalSetEvent,o),this.dispatchService.register(n,this.intervalGetEvent,o),t.isArray(i.sourceModelIds))for(var s=0,a=i.sourceModelIds.length;s<a;++s){var l=i.sourceModelIds[s];if(l&&"string"==typeof l){var c={id:l};this.sourceModelsById[l]=c;var d={type:"modelGetInfo",modelId:l,modelInfo:null};this.dispatchService.synchronousCall(n,d);var u=d.modelInfo;if(u&&u.parameters&&u.parameters.range){var h=u.parameters.range;c.rangeChangeEventName=h.changeEvent,c.rangeGetEventName=h.getEvent,c.rangeSetEventName=h.setEvent,(p=h.parameterId)&&(this.sourceModelsById[p]=c),h.value&&(c.range=h.value)}if(u&&u.parameters&&u.parameters.interval){var p;h=u.parameters.interval;c.intervalChangeEventName=h.changeEvent,c.intervalGetEventName=h.getEvent,c.intervalSetEventName=h.setEvent,(p=h.parameterId)&&(this.sourceModelsById[p]=c),h.value&&(c.interval=h.value)}c.rangeChangeEventName&&this.dispatchService.register(n,c.rangeChangeEventName,o),c.intervalChangeEventName&&this.dispatchService.register(n,c.intervalChangeEventName,o)}}}this._recomputeRange(),t.log("TimeSynchronize",this)},_handle:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo());else if(this.rangeGetEvent===e.type)e.value=this.currentRange;else if(this.intervalGetEvent===e.type)e.value=this.currentInterval;else if(this.intervalSetEvent===e.type){var n=e.value;this._setInterval(n)}else if(e.parameterId&&this.sourceModelsById[e.parameterId]){var r=this.sourceModelsById[e.parameterId];e.type===r.intervalChangeEventName||e.type===r.rangeChangeEventName&&(r.range=e.value,this._recomputeRange())}},_getModelInfo:function(){var e={modelId:this.modelId,modelType:"timeSynchronize",parameters:{}};return e.parameters.range={parameterId:this.modelId+"_range",type:"dateInterval",name:"range",label:i("Range"),setEvent:this.rangeSetEvent,getEvent:this.rangeGetEvent,changeEvent:this.rangeChangeEvent,value:this.currentRange},e.parameters.interval={parameterId:this.modelId+"_interval",type:"dateInterval",name:"interval",label:i("Interval"),setEvent:this.intervalSetEvent,getEvent:this.intervalGetEvent,changeEvent:this.intervalChangeEvent,value:this.getInterval()},e},_recomputeRange:function(){var e=void 0,t=this.getInterval();for(var i in this.sourceModelsById){var n=this.sourceModelsById[i];n.range&&(e?e.extendTo(n.range,this.now):e=n.range)}var r=!1;if(this.currentRange&&!e?(this.currentRange=e,r=!0):!this.currentRange&&e?(this.currentRange=e,r=!0):this.currentRange&&e&&(this.currentRange.equals(e)||(this.currentRange=e,r=!0)),r){this._contrainIntervalToRange();var o=this.getInterval();o===t||o&&o.equals(t)||this._reportChangedInterval(),this._reportChangedRange()}},_reportChangedRange:function(){this.dispatchService.send(n,{type:this.rangeChangeEvent,parameterId:this.modelId+"_range",value:this.currentRange})},getInterval:function(){return this.currentInterval?this.currentInterval:this.currentRange},_contrainIntervalToRange:function(){this.currentInterval&&this.currentRange?this.currentInterval=this.currentInterval.intersection(this.currentRange,this.now):this.currentRange||(this.currentInterval=null),this.currentInterval&&this.currentInterval.ongoing&&(this.currentInterval.max=this.now)},_setInterval:function(e){var t=this.getInterval();this.currentInterval=e,this._contrainIntervalToRange();var i=this.getInterval();t===i||t&&t.equals(i)||this._reportChangedInterval()},_reportChangedInterval:function(){var e=this.getInterval();for(var t in this.sourceModelsById){var i=this.sourceModelsById[t];i.intervalSetEventName&&this.dispatchService.send(n,{type:i.intervalSetEventName,parameterId:i.parameterId,value:e})}this.dispatchService.send(n,{type:this.intervalChangeEvent,parameterId:this.modelId+"_interval",value:e})}});t.modelTime={TimeFilter:o,TimeTransform:s,DatedReferenceTransform:a,NoTimeFilter:l,TimeSynchronize:c,handleModelCreate:function(e,t,i){if("timeFilter"===e.modelType){var n={};if(e&&e.modelOptions)for(var r in e.modelOptions){var d=e.modelOptions[r];n[r]=d}n.modelId=e.modelId,n.modelType=e.modelType,e&&e.config&&e.config.directory&&(n.dispatchService=e.config.directory.dispatchService),e.model=new o(n),e.created=!0}else if("noTimeFilter"===e.modelType){if(n={},e&&e.modelOptions)for(var r in e.modelOptions)d=e.modelOptions[r],n[r]=d;n.modelId=e.modelId,n.modelType=e.modelType,e&&e.config&&e.config.directory&&(n.dispatchService=e.config.directory.dispatchService),e.model=new l(n),e.created=!0}else if("timeTransform"===e.modelType){if(n={},e&&e.modelOptions)for(var r in e.modelOptions)d=e.modelOptions[r],n[r]=d;n.modelId=e.modelId,n.modelType=e.modelType,e&&e.config&&e.config.directory&&(n.dispatchService=e.config.directory.dispatchService),e.model=new s(n),e.created=!0}else if("datedReferenceTransform"===e.modelType){if(n={},e&&e.modelOptions)for(var r in e.modelOptions)d=e.modelOptions[r],n[r]=d;n.modelId=e.modelId,n.modelType=e.modelType,e.config&&e.config.directory&&(n.dispatchService=e.config.directory.dispatchService),e.model=new a(n),e.created=!0}else if("timeSynchronize"===e.modelType){if(n={},e&&e.modelOptions)for(var r in e.modelOptions)d=e.modelOptions[r],n[r]=d;n.modelId=e.modelId,n.modelType=e.modelType,e.config&&e.config.directory&&(n.dispatchService=e.config.directory.dispatchService),e.model=new c(n),e.created=!0}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.modelLayer",r=t.Class({dispatchService:null,modelId:null,sourceModelId:null,selectedLayers:null,selectedLayersParameter:null,availableLayers:null,availableLayersParameter:null,docInfosByDocId:null,modelIsLoading:null,initialize:function(e){var r=t.extend({dispatchService:null,modelId:null,sourceModelId:null},e),o=this;if(this.docInfosByDocId={},this.selectedLayers={},this.availableLayers={},this.modelIsLoading=!1,this.dispatchService=r.dispatchService,this.modelId=r.modelId,this.sourceModelId=r.sourceModelId,this.selectedLayersParameter=new t.model.ModelParameter({model:this,modelId:this.modelId,type:"layerIds",name:"selectedLayers",label:i("Layers"),setFn:this._setLayers,getFn:this.getLayers,dispatchService:this.dispatchService}),this.availableLayersParameter=new t.model.ModelParameter({model:this,modelId:this.modelId,type:"layerIds",name:"availableLayers",label:i("Available Layers"),setFn:this._setAvailableLayers,getFn:this.getAvailableLayers,dispatchService:this.dispatchService}),this.dispatchService){var s=function(e,t,i){o._handle(e,t,i)};this.dispatchService.register(n,"modelGetInfo",s),this.dispatchService.register(n,"modelGetState",s),this.dispatchService.register(n,"modelStateUpdated",s);var a={type:"modelGetState",modelId:this.sourceModelId};this.dispatchService.synchronousCall(n,a),a.state&&this._sourceModelUpdated(a.state)}t.log("LayerFilter",this)},getLayers:function(){var e=[];for(var t in this.selectedLayers)e[e.length]=t;return e},_setLayers:function(e){var t={};e&&e.forEach(function(e){t[e]=!0});var i=!1;for(var n in t)this.selectedLayers[n]||(i=!0);if(!i)for(var n in this.selectedLayers)t[n]||(i=!0);i&&(this.selectedLayers=t,this.selectedLayersParameter.sendUpdate(),this._selectedLayersUpdated())},getAvailableLayers:function(){var e=[];for(var t in this.availableLayers)e[e.length]=t;return e},_setAvailableLayers:function(e){var t={};e&&e.forEach(function(e){t[e]=!0}),this._setAvailableLayersMap(t)},_setAvailableLayersMap:function(e){var t=!1;for(var i in e)this.availableLayers[i]||(t=!0);if(!t)for(var i in this.availableLayers)e[i]||(t=!0);t&&(this.availableLayers=e,this.availableLayersParameter.sendUpdate())},_handle:function(e,t,i){if("modelGetInfo"===e.type)this.modelId===e.modelId&&(e.modelInfo=this._getModelInfo());else if("modelGetState"===e.type){if(this.modelId===e.modelId){var n=[];for(var r in this.docInfosByDocId){var o=this.docInfosByDocId[r],s=o.doc;o.visible&&n.push(s)}e.state={added:n,updated:[],removed:[],loading:this.modelIsLoading}}}else"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){var e={modelId:this.modelId,modelType:"layerFilter",parameters:{}};return e.parameters.selectedLayers=this.selectedLayersParameter.getInfo(),e.parameters.availableLayers=this.availableLayersParameter.getInfo(),e},_sourceModelUpdated:function(e){var t=[],i=[],n=[];if("boolean"==typeof e.loading&&this.modelIsLoading!==e.loading&&(this.modelIsLoading=e.loading),e.added)for(var r=0,o=e.added.length;r<o;++r){var s={id:l=(u=e.added[r])._id,doc:u,layerMap:c=this._getLayerMapFromDoc(u),visible:!1},a=this._computeVisibility(s);s.visible=a,this.docInfosByDocId[l]=s,s.visible&&t.push(u)}if(e.updated)for(r=0,o=e.updated.length;r<o;++r){var l=(u=e.updated[r])._id,c=(s=this.docInfosByDocId[l],this._getLayerMapFromDoc(u));s||(s={id:l,doc:u,visible:!1},this.docInfosByDocId[l]=s),s.doc=u,s.layerMap=c;var d=(a=this._computeVisibility(s))!==s.visible;s.visible=a,d?s.visible?t.push(u):n.push(u):s.visible&&i.push(u)}if(e.removed)for(r=0,o=e.removed.length;r<o;++r){var u;l=(u=e.removed[r])._id;(s=this.docInfosByDocId[l])&&(delete this.docInfosByDocId[l],s.visible&&n.push(u))}this._reportStateUpdate(t,i,n);var h={};for(var l in this.docInfosByDocId){s=this.docInfosByDocId[l];for(var p in s.layerMap)h[p]=!0}this._setAvailableLayersMap(h)},_selectedLayersUpdated:function(){var e=[],t=[];for(var i in this.docInfosByDocId){var n=this.docInfosByDocId[i],r=n.doc,o=this._computeVisibility(n),s=o!==n.visible;n.visible=o,s&&(n.visible?e.push(r):t.push(r))}this._reportStateUpdate(e,[],t)},_reportStateUpdate:function(e,t,i){var r={added:e,updated:t,removed:i,loading:this.modelIsLoading};this.dispatchService&&this.dispatchService.send(n,{type:"modelStateUpdated",modelId:this.modelId,state:r})},_computeVisibility:function(e){if(e&&e.layerMap)for(var t in e.layerMap)if(this.selectedLayers[t])return!0;return!1},_getLayerMapFromDoc:function(e){var t={};return e.nunaliit_layers&&e.nunaliit_layers.forEach(function(e){t[e]=!0}),t}});t.modelLayer={LayerFilter:r,handleModelCreate:function(e,t,i){if("layerFilter"===e.modelType){var n={};if(e&&e.modelOptions)for(var o in e.modelOptions){var s=e.modelOptions[o];n[o]=s}n.modelId=e.modelId,n.modelType=e.modelType,e&&e.config&&e.config.directory&&(n.dispatchService=e.config.directory.dispatchService),e.model=new r(n),e.created=!0}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.widgetService";function r(e,t){if("object"!=typeof t)throw new Error("Unable to create an instance of Action since definition is not provided");var i={type:"instanceCreate",instanceConfiguration:t,instance:void 0};e.synchronousCall(n,i);var r=i.instance;if(!r)throw new Error("Unable to create an instance of type: "+t.type);if("object"!=typeof r)throw new Error("Instance of type: "+t.type+" is not an object");if("function"!=typeof r.execute)throw new Error("Instance of type: "+t.type+" must implement execute() method");return r}var o=t.Class({contentId:null,dispatchService:null,authService:null,showAsLink:null,containerId:null,elemId:null,initialize:function(e){var i=t.extend({contentId:null,containerId:null,dispatchService:null,authService:null,showAsLink:!1},e);if(this.contentId=i.contentId,this.containerId=i.containerId,this.dispatchService=i.dispatchService,this.authService=i.authService,this.showAsLink=i.showAsLink,!this.containerId)throw new Error("containerId must be specified");this._display()},_display:function(){var n=this;if(window.cordova){var r=document.getElementsByClassName("nunaliit_header");r.length&&(e(r[0]).hide(),e("<style type='text/css'> .nunaliit_content { top: 0 } </style>").appendTo("head")),document.addEventListener("deviceready",function(){window.nunaliit2.cordovaPlugin.registerCallback("onCreateDocument",function(){window.onCreateDocument=function(){n._startEdit()}},function(e){console.error("Error on cordova callback invocation: ",e)})})}else{this.elemId=t.getUniqueId();var o=this.containerId,s=e("<div>").attr("id",this.elemId).addClass("n2widget_createDocument").appendTo(e("#"+o));this.showAsLink?(s.addClass("n2widget_createDocument_asLink"),e("<a>").attr("href","#").text(i("Create Document")).appendTo(s).click(function(){return n._startEdit(),!1})):e("<button>").text(i("Create Document")).appendTo(s).click(function(){return n._startEdit(),!1})}},_startEdit:function(){var e=this;this.authService&&0==this.authService.isLoggedIn()?this.authService.showLoginForm({prompt:i("You must first log in to create a new document."),anonymousLoginAllowed:!1,onSuccess:function(){e._startEdit()}}):this.dispatchService.send(n,{type:"editInitiate",doc:{}})}});var s=t.Class({elemId:null,dispatchService:null,authService:null,schemaRepository:null,schemaName:null,label:null,showAsLink:null,schema:null,initialize:function(i){var n=t.extend({containerId:null,dispatchService:null,authService:null,schemaRepository:null,schemaName:null,label:null,showAsLink:null},i),r=this;this.dispatchService=n.dispatchService,this.authService=n.authService,this.schemaRepository=n.schemaRepository,this.atlasDesign=n.atlasDesign,this.schemaName=n.schemaName,this.label=n.label,this.showAsLink=n.showAsLink,this.schema=null;var o=e("#"+n.containerId),s=e("<div>").addClass("n2widget_createDocumentFromSchema").appendTo(o);if(this.elemId=t.utils.getElementIdentifier(s),this.dispatchService);this.schemaRepository&&this.schemaName?this.schemaRepository.getSchema({name:this.schemaName,onSuccess:function(e){r.schema=e,r._refresh()},onError:function(){t.log("Schema not found: "+this.schemaName)}}):t.log("Schema repository or schema name not specified")},_getElem:function(){return e("#"+this.elemId)},_refresh:function(){var t=this,n=this._getElem(),r=this.schema.name;this.schema.label&&(r=i(this.schema.label));var o=i("Create {label}",{label:r});this.label&&(o=i(this.label)),this.showAsLink?e("<a>").attr("href","#").text(o).appendTo(n).click(function(){return t._startEdit(),!1}):e("<button>").text(o).appendTo(n).click(function(){return t._startEdit(),!1})},_startEdit:function(){var e=this;this.authService&&0==this.authService.isLoggedIn()?this.authService.showLoginForm({prompt:i("You must first log in to create a new document."),anonymousLoginAllowed:!1,onSuccess:function(){e._startEdit()}}):this.dispatchService.send(n,{type:"editInitiate",doc:{nunaliit_schema:this.schema.name}})},_handle:function(e,t,i){}});var a=t.Class({elemId:null,dispatchService:null,showService:null,filterModelId:null,filterParameterId:null,listModelId:null,listLabelSelectors:null,selectedDocumentIdObserver:null,listDocumentMap:null,label:null,initialize:function(i){var r=t.extend({containerId:null,dispatchService:null,showService:null,filterModelId:null,filterParameterId:"selectedDocumentId",listModelId:null,listLabelSelectors:null,label:null},i),o=this;this.dispatchService=r.dispatchService,this.showService=r.showService,this.filterModelId=r.filterModelId,this.filterParameterId=r.filterParameterId,this.listModelId=r.listModelId,this.label=r.label,this.listDocumentMap={},this.listLabelSelectors=[],t.isArray(r.listLabelSelectors)&&r.listLabelSelectors.forEach(function(e){if("string"==typeof e){var i=t.objectSelector.parseSelector(e);o.listLabelSelectors.push(i)}});var s=e("#"+r.containerId),a=e("<div>").addClass("n2widget_documentSelector").appendTo(s);if(this.elemId=t.utils.getElementIdentifier(a),this.dispatchService){if(this.dispatchService.register(n,"modelStateUpdated",function(e,t,i){o._handle(e,t,i)}),this.filterModelId){var l=t.model.getModelInfo({dispatchService:this.dispatchService,modelId:this.filterModelId});if(l&&l.parameters&&l.parameters[this.filterParameterId]){var c=l.parameters[this.filterParameterId];this.selectedDocumentIdObserver=new t.model.ModelParameterObserver({parameterInfo:c,dispatchService:this.dispatchService,onChangeFn:function(e){o._selectedDocIdChanged(e)}})}}if(this.listModelId){var d=t.model.getModelState({dispatchService:this.dispatchService,modelId:this.listModelId});d&&this._listModelStateUpdated(d)}}t.log("DocumentSelectorWidget",this),this._refresh()},_getElem:function(){return e("#"+this.elemId)},_listModelStateUpdated:function(e){if(e.added)for(var t=0,i=e.added.length;t<i;++t){var n=(r=e.added[t])._id;this.listDocumentMap[n]=r}if(e.updated)for(t=0,i=e.updated.length;t<i;++t){n=(r=e.updated[t])._id;this.listDocumentMap[n]=r}if(e.removed)for(t=0,i=e.removed.length;t<i;++t){var r;n=(r=e.removed[t])._id;delete this.listDocumentMap[n]}},_selectedDocIdChanged:function(e){this._refresh()},_getDisplayValueFromDoc:function(t){var n=void 0;if(this.listLabelSelectors.forEach(function(e){void 0===n&&(n=e.getValue(t))&&"localized"===n.nunaliit_type&&(n=i(n))}),void 0===n&&this.showService){var r=e("<div>");this.showService.displayBriefDescription(r,{},t),n=r.text()}return void 0===n&&(n=t._id),n},_refresh:function(){var t=this,n=[];for(var r in this.listDocumentMap){var o=this.listDocumentMap[r],s={docId:r,doc:o,display:this._getDisplayValueFromDoc(o)};n.push(s)}n.sort(function(e,t){return e.display<t.display?-1:e.display>t.display?1:0});var a=this._getElem().empty(),l=e("<select>").appendTo(a).change(function(){var i=e(this);t._selectionChanged(i)}),c="--";this.label&&(c=i(this.label));e("<option>").val("__NO_SELECTION__").text(c).appendTo(l);var d=!1,u=void 0;this.selectedDocumentIdObserver&&(u=this.selectedDocumentIdObserver.getValue()),n.forEach(function(t){var i=t.docId;t.doc;i===u&&(d=!0);e("<option>").val(i).text(t.display).appendTo(l)}),d?l.val(u):l.val("__NO_SELECTION__")},_selectionChanged:function(e){var t=e.val();this.selectedDocumentIdObserver&&(t?"__NO_SELECTION__"===t?this.selectedDocumentIdObserver.setValue(null):this.selectedDocumentIdObserver.setValue(t):this.selectedDocumentIdObserver.setValue(null))},_handle:function(e,t,i){"modelStateUpdated"===e.type&&e.modelId===this.listModelId&&e.state&&(this._listModelStateUpdated(e.state),this._refresh())}});var l=t.Class("ButtonWidget",{dispatchService:null,containerId:null,elemId:null,buttonLabel:null,actions:null,initialize:function(e){var i=t.extend({containerId:null,dispatchService:null,buttonLabel:null,action:void 0,actions:void 0},e),n=this;if(this.containerId=i.containerId,this.dispatchService=i.dispatchService,this.buttonLabel=i.buttonLabel,this.actions=[],!this.containerId)throw new Error("containerId must be specified");if(this.buttonLabel||(this.buttonLabel="Button"),"object"==typeof i.action){var o=r(this.dispatchService,i.action);this.actions.push(o)}if(void 0===i.actions);else{if(!t.isArray(i.actions))throw new Error('If parameter "actions" is specified, it must be an array of action definitions.');i.actions.forEach(function(e){if("object"!=typeof e)throw new Error('If parameter "actions" is specified, it must be an array of action definitions.');var t=r(n.dispatchService,e);n.actions.push(t)})}this._display(),t.log(this._classname,this)},_display:function(){var n=this;this.elemId=t.getUniqueId();var r=this.containerId,o=e("<a>").attr("id",this.elemId).attr("href","#").addClass("n2widget_button").appendTo(e("#"+r)).click(function(){return n._buttonClicked(),!1});e("<span>").text(i(this.buttonLabel)).appendTo(o)},_buttonClicked:function(){this.actions.forEach(function(e){e.execute()})}});var c=t.Class({config:null,dispatchService:null,initialize:function(e){var i=t.extend({config:null},e),r=this;if(this.config=i.config,this.config&&this.config.directory&&(this.dispatchService=this.config.directory.dispatchService),this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(n,"widgetIsTypeAvailable",o),this.dispatchService.register(n,"widgetDisplay",o),this.dispatchService.register(n,"showPreprocessElement",o)}},_showServicePreprocess:function(t){var i=this;t.find("*").addBack().filter(".n2s_insertWidget").each(function(){var t=e(this);i._insertWidget(t),t.removeClass("n2s_insertWidget").addClass("n2s_insertedWidget")})},_insertWidget:function(e){var i=e.attr("nunaliit-widget"),r=t.utils.getElementIdentifier(e),o=void 0;try{var s=e.text();o=JSON.parse(s)}catch(e){}o||(o={}),e.empty();var a={type:"widgetIsTypeAvailable",widgetType:i,widgetOptions:o,isAvailable:!1},l=this.dispatchService;l&&l.synchronousCall(n,a),a.isAvailable?l&&l.send(n,{type:"widgetDisplay",widgetType:i,widgetOptions:o,containerId:r,config:this.config}):e.attr("nunaliit-error","widget type not available")},_handle:function(e,i,n){if("widgetIsTypeAvailable"===e.type)"createDocument"===e.widgetType?e.isAvailable=!0:"createDocumentFromSchema"===e.widgetType?e.isAvailable=!0:"documentSelector"===e.widgetType?e.isAvailable=!0:"button"===e.widgetType?e.isAvailable=!0:(t.couchDbPerspective&&t.couchDbPerspective.HandleWidgetAvailableRequests&&t.couchDbPerspective.HandleWidgetAvailableRequests(e),t.widgetTime&&t.widgetTime.HandleWidgetAvailableRequests&&t.widgetTime.HandleWidgetAvailableRequests(e),t.widgetPolarStereographicProjectionSelector&&t.widgetPolarStereographicProjectionSelector.HandleWidgetAvailableRequests&&t.widgetPolarStereographicProjectionSelector.HandleWidgetAvailableRequests(e),t.widgetWait&&t.widgetWait.HandleWidgetAvailableRequests&&t.widgetWait.HandleWidgetAvailableRequests(e),t.mapAndControls&&t.mapAndControls.HandleWidgetAvailableRequests&&t.mapAndControls.HandleWidgetAvailableRequests(e),t.widgetBookBrowser&&t.widgetBookBrowser.HandleWidgetAvailableRequests&&t.widgetBookBrowser.HandleWidgetAvailableRequests(e),t.widgetNavigation&&t.widgetNavigation.HandleWidgetAvailableRequests&&t.widgetNavigation.HandleWidgetAvailableRequests(e),t.widgetSplash&&t.widgetSplash.HandleWidgetAvailableRequests&&t.widgetSplash.HandleWidgetAvailableRequests(e),t.widgetLayer&&t.widgetLayer.HandleWidgetAvailableRequests&&t.widgetLayer.HandleWidgetAvailableRequests(e),t.widgetExport&&t.widgetExport.HandleWidgetAvailableRequests&&t.widgetExport.HandleWidgetAvailableRequests(e),t.widgetModelBrowser&&t.widgetModelBrowser.HandleWidgetAvailableRequests&&t.widgetModelBrowser.HandleWidgetAvailableRequests(e),t.widgetSelectableFilter&&t.widgetSelectableFilter.HandleWidgetAvailableRequests&&t.widgetSelectableFilter.HandleWidgetAvailableRequests(e),t.widgetLegend&&t.widgetLegend.HandleWidgetAvailableRequests&&t.widgetLegend.HandleWidgetAvailableRequests(e),t.widgetCollapsibleContainer&&t.widgetCollapsibleContainer.HandleWidgetAvailableRequests&&t.widgetCollapsibleContainer.HandleWidgetAvailableRequests(e),t.widgetResizingContainer&&t.widgetResizingContainer.HandleWidgetAvailableRequests&&t.widgetResizingContainer.HandleWidgetAvailableRequests(e),t.widgetDuplicate&&t.widgetDuplicate.HandleWidgetAvailableRequests&&t.widgetDuplicate.HandleWidgetAvailableRequests(e),t.widgetTranscript&&t.widgetTranscript.HandleWidgetAvailableRequests&&t.widgetTranscript.HandleWidgetAvailableRequests(e));else if("widgetDisplay"===e.type)"createDocument"===e.widgetType?function(e){var t=e.widgetOptions,i=e.contentId,n=e.containerId,r=e.config,s={};if(t)for(var a in t){var l=t[a];s[a]=l}s.contentId=i,s.containerId=n,r&&r.directory&&(s.dispatchService=r.directory.dispatchService,s.authService=r.directory.authService),new o(s)}(e):"createDocumentFromSchema"===e.widgetType?function(e){var t=e.widgetOptions,i=(e.contentId,e.containerId),n=e.config,r={};if(t)for(var o in t)r[o]=t[o];r.containerId=i,n&&n.directory&&(r.dispatchService=n.directory.dispatchService,r.authService=n.directory.authService,r.schemaRepository=n.directory.schemaRepository),new s(r)}(e):"documentSelector"===e.widgetType?function(e){var t=e.widgetOptions,i=e.config,n={};if(t)for(var r in t)n[r]=t[r];n.containerId=e.containerId,i&&i.directory&&(n.dispatchService=i.directory.dispatchService,n.showService=i.directory.showService),new a(n)}(e):"button"===e.widgetType?function(e){var t=e.widgetOptions,i=e.containerId,n=e.config,r={};if(t)for(var o in t){var s=t[o];r[o]=s}r.containerId=i,n&&n.directory&&(r.dispatchService=n.directory.dispatchService),new l(r)}(e):(t.couchDbPerspective&&t.couchDbPerspective.HandleWidgetDisplayRequests&&t.couchDbPerspective.HandleWidgetDisplayRequests(e),t.widgetTime&&t.widgetTime.HandleWidgetDisplayRequests&&t.widgetTime.HandleWidgetDisplayRequests(e),t.widgetPolarStereographicProjectionSelector&&t.widgetPolarStereographicProjectionSelector.HandleWidgetDisplayRequests&&t.widgetPolarStereographicProjectionSelector.HandleWidgetDisplayRequests(e),t.widgetWait&&t.widgetWait.HandleWidgetDisplayRequests&&t.widgetWait.HandleWidgetDisplayRequests(e),t.mapAndControls&&t.mapAndControls.HandleWidgetDisplayRequests&&t.mapAndControls.HandleWidgetDisplayRequests(e),t.widgetBookBrowser&&t.widgetBookBrowser.HandleWidgetDisplayRequests&&t.widgetBookBrowser.HandleWidgetDisplayRequests(e),t.widgetNavigation&&t.widgetNavigation.HandleWidgetDisplayRequests&&t.widgetNavigation.HandleWidgetDisplayRequests(e),t.widgetSplash&&t.widgetSplash.HandleWidgetDisplayRequests&&t.widgetSplash.HandleWidgetDisplayRequests(e),t.widgetLayer&&t.widgetLayer.HandleWidgetDisplayRequests&&t.widgetLayer.HandleWidgetDisplayRequests(e),t.widgetExport&&t.widgetExport.HandleWidgetDisplayRequests&&t.widgetExport.HandleWidgetDisplayRequests(e),t.widgetModelBrowser&&t.widgetModelBrowser.HandleWidgetDisplayRequests&&t.widgetModelBrowser.HandleWidgetDisplayRequests(e),t.widgetSelectableFilter&&t.widgetSelectableFilter.HandleWidgetDisplayRequests&&t.widgetSelectableFilter.HandleWidgetDisplayRequests(e),t.widgetLegend&&t.widgetLegend.HandleWidgetDisplayRequests&&t.widgetLegend.HandleWidgetDisplayRequests(e),t.widgetCollapsibleContainer&&t.widgetCollapsibleContainer.HandleWidgetDisplayRequests&&t.widgetCollapsibleContainer.HandleWidgetDisplayRequests(e),t.widgetResizingContainer&&t.widgetResizingContainer.HandleWidgetDisplayRequests&&t.widgetResizingContainer.HandleWidgetDisplayRequests(e),t.widgetDuplicate&&t.widgetDuplicate.HandleWidgetDisplayRequests&&t.widgetDuplicate.HandleWidgetDisplayRequests(e),t.widgetTranscript&&t.widgetTranscript.HandleWidgetDisplayRequests&&t.widgetTranscript.HandleWidgetDisplayRequests(e));else if("showPreprocessElement"===e.type){var r=e.elem;this._showServicePreprocess(r)}}});t.widgetBasic={Service:c,CreateDocumentWidget:o,CreateDocumentFromSchemaWidget:s,ButtonWidget:l}}(jQuery,nunaliit2),function(e,t){var i=t.Class({dispatchService:null,elemId:null,waitingByRequesterId:null,showNames:null,refreshIntervalInMs:null,logging:null,initialize:function(i){var n=t.extend({containerId:null,dispatchService:null,showNames:null,refreshIntervalInMs:null,logging:!1},i),r=this;if(this.waitingByRequesterId={},this.showNames=!1,"boolean"==typeof n.showNames&&(this.showNames=n.showNames),"number"==typeof n.refreshIntervalInMs?this.refreshIntervalInMs=n.refreshIntervalInMs:this.refreshIntervalInMs=300,"boolean"==typeof n.logging&&(this.logging=n.logging),this.dispatchService=n.dispatchService,this.dispatchService){this.dispatchService.register("n2.widgetMapWait","waitReport",function(e,t,i){r._handle(e,t,i)})}var o=n.containerId;if(!o)throw new Error("containerId must be specified");var s=e("#"+o);this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2wait").appendTo(s),this._display(),t.log("WaitWidget",this)},_getElem:function(){return e("#"+this.elemId)},getCount:function(){var e=0;for(var t in this.waitingByRequesterId){var i=this.waitingByRequesterId[t];for(var n in i){e+=i[n].count}}return e},_displayNames:function(i){var n={};for(var r in this.waitingByRequesterId){var o=this.waitingByRequesterId[r];for(var s in o){var a=o[s];if(a.count>0)(p=n[s])||(p={name:s,label:a.label,count:0},n[s]=p),p.count+=a.count}}var l,c,d=[];for(var s in n)d.push(n[s]);d.sort(function(e,t){return e.label===t.label?0:e.label<t.label?-1:e.label>t.label?1:0});for(var u=0,h=d.length;u<h;++u){var p=d[u],f=e("<div>").addClass("n2_wait_name").appendTo(i);e("<span>").addClass("n2_wait_name_label").text((l=p.label,c=void 0,t.loc(l,"nunaliit2",c))).appendTo(f),e("<span>").addClass("n2_wait_name_count").text(""+p.count).appendTo(f)}},_display:function(){var t=this;this._getElem().hasClass("n2wait_showing")||function i(){var n=t._getElem().empty();var r=t.getCount();if(r>0){if(n.show().addClass("n2wait_showing"),t.showNames){var o=e("<div>").addClass("n2wait_names").appendTo(n);t._displayNames(o)}e("<div>").addClass("olkit_wait").appendTo(n),setTimeout(i,t.refreshIntervalInMs)}else n.hide().removeClass("n2wait_showing")}()},_handle:function(e,i,n){if("waitReport"===e.type){var r=e.requester,o=e.name,s=e.count,a=e.label;if(a||(a=o),"string"==typeof r&&"string"==typeof o&&"number"==typeof s){var l=this.waitingByRequesterId[r];l||(l={},this.waitingByRequesterId[r]=l);var c=l[o];if(c||(c={name:o,label:a,count:0},l[o]=c),this.logging)if(c.count<1&&s>0)c.start=Date.now(),t.log("wait "+r+"/"+o+" start "+c.start);else if(c.count>0&&s<1){var d=Date.now(),u=d-c.start;t.log("wait "+r+"/"+o+" end "+d+" elapsed "+u)}c.count=s,this._display()}}}});t.widgetWait={WaitWidget:i,HandleWidgetAvailableRequests:function(t){"wait"===t.widgetType&&e.fn.slider&&(t.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("wait"===e.widgetType){var t=e.widgetOptions,n=e.containerId,r=e.config,o={};if(t)for(var s in t)o[s]=t[s];o.containerId=n,r&&r.directory&&(o.dispatchService=r.directory.dispatchService),new i(o)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.widgetSplash",r=t.Class({dispatchService:null,showService:null,interactionSeen:null,dialogId:null,pages:null,title:null,dialogWidth:null,pageIndex:null,showSplashPage:null,version:null,cookieName:null,initialize:function(i){var r=t.extend({dispatchService:null,showService:null,pages:null,title:null,dialogWidth:800,version:1,cookieName:"NunaliitSplashDontShow"},i),o=this;if(this.interactionSeen=!1,this.showSplashPage=!1,this.dialogId=void 0,this.pages=void 0,this.pageIndex=0,this.title=r.title,this.dialogWidth=r.dialogWidth,this.dispatchService=r.dispatchService,this.showService=r.showService,this.version=r.version,this.cookieName=r.cookieName,r.pages&&t.isArray(r.pages)&&(this.pages=r.pages),this.dispatchService){this.dispatchService.register(n,"start",function(){window.setTimeout(function(){o.interactionSeen||(o.showSplashPage=!0,o._showInitialSplash())},0)});var s=function(e,t,i){o._handle(e,t,i)};this.dispatchService.register(n,"searchInitiate",s),this.dispatchService.register(n,"selected",s),this.dispatchService.register(n,"splashWidgetSetPages",s),this.dispatchService.register(n,"showPreprocessElement",s),this.dispatchService.register(n,"splashShowSplashPage",s)}this._showInitialSplash(),this._handleShowPreprocessElement(e("body")),t.log("SplashPageWidget",this)},_showInitialSplash:function(){if(this.showSplashPage){if(t.cookie&&t.cookie.getCookie)if(1*t.cookie.getCookie(this.cookieName)>=this.version)return;this._showSplash(!0)}},_showSplash:function(n){if(this.pages){var r=e("<div>").addClass("n2Splash_dialog").appendTo(e("body"));this.dialogId=t.utils.getElementIdentifier(r);e("<div>").addClass("n2Splash_container n2Splash_updatePageIndex").appendTo(r);var o=e("<div>").addClass("n2Splash_buttons n2Splash_updatePageIndex").appendTo(r);e("<span>").addClass("n2Splash_insertPreviousButton").appendTo(o),e("<span>").addClass("n2Splash_insertIndex").appendTo(o),e("<span>").addClass("n2Splash_insertRibbon").appendTo(o),e("<span>").addClass("n2Splash_insertNextButton").appendTo(o),n&&e("<span>").addClass("n2Splash_insertDontShow").appendTo(o),e("<span>").addClass("n2Splash_insertCloseButton").appendTo(o),this._showCurrentPage();var s=void 0;this.title&&(s=i(this.title)),s||(s=i("Welcome"));var a={autoOpen:!0,title:s,modal:!0,width:this.dialogWidth,dialogClass:"n2Splash_dialog_container",close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};r.dialog(a)}},_showCurrentPage:function(){var t=this.pages[this.pageIndex],n=e("#"+this.dialogId),r=n.find(".n2Splash_container").empty();if(t.html){var o=t.html;"object"==typeof o&&"localized"===o.nunaliit_type&&(o=i(o)),r.html(o)}else t.text&&r.text(t.text);this._fixElements(n),this.showService&&this.showService.fixElementAndChildren(n,{},t.doc)},_fixElements:function(n){var r=this;n.find(".n2Splash_insertPreviousButton").each(function(){var t=e(this),n=t.attr("nunaliit-label");n||(n=i("Previous")),e("<a>").addClass("n2Splash_button n2Splash_button_previous n2Splash_button_disabled").text(n).attr("href","#").appendTo(t).click(function(){var e=r.pageIndex;return r._goToPage(e-1),!1}),t.removeClass("n2Splash_insertPreviousButton").addClass("n2Splash_insertedPreviousButton")}),n.find(".n2Splash_insertNextButton").each(function(){var t=e(this),n=t.attr("nunaliit-label");n||(n=i("Next")),e("<a>").addClass("n2Splash_button n2Splash_button_next n2Splash_button_disabled").text(n).attr("href","#").appendTo(t).click(function(){var e=r.pageIndex;return r._goToPage(e+1),!1}),t.removeClass("n2Splash_insertNextButton").addClass("n2Splash_insertedNextButton")}),n.find(".n2Splash_insertCloseButton").each(function(){var t=e(this),n=t.attr("nunaliit-label");n||(n=i("Close")),e("<a>").addClass("n2Splash_button n2Splash_button_close n2Splash_button_enabled").text(n).attr("href","#").appendTo(t).click(function(){return e("#"+r.dialogId).dialog("close"),!1}),t.removeClass("n2Splash_insertCloseButton").addClass("n2Splash_insertedCloseButton")}),n.find(".n2Splash_insertIndex").each(function(){var t=e(this);t.addClass("n2Splash_index"),t.removeClass("n2Splash_insertIndex").addClass("n2Splash_insertedIndex")}),n.find(".n2Splash_insertRibbon").each(function(){var t=e(this);t.empty().attr("nunaliit-page-count",r.pages.length);for(var i=0,n=r.pages.length;i<n;++i){var o=i+1,s=e("<span>").addClass("n2Splash_ribbon_page").attr("nunaliit-page-index",i).appendTo(t);e("<a>").attr("href","#").text(o).appendTo(s).click(function(){var t=1*e(this).parent().attr("nunaliit-page-index");return r._goToPage(t),!1})}t.removeClass("n2Splash_insertRibbon").addClass("n2Splash_insertedRibbon")}),n.find(".n2Splash_insertDontShow").each(function(){var n=e(this),o=n.attr("nunaliit-label");o||(o=i("Do not show again"));var s=t.getUniqueId();e("<label>").addClass("n2Splash_label n2Splash_label_dontshow").attr("for",s).text(o).appendTo(n),e("<input>").addClass("n2Splash_button n2Splash_button_dontshow").attr("type","checkbox").attr("id",s).appendTo(n).click(function(){var t=e(this).is(":checked");return r._doNotShowAgain(t),!0}),n.removeClass("n2Splash_insertDontShow").addClass("n2Splash_insertedDontShow")}),n.find(".n2Splash_updatePageIndex").each(function(){var t=e(this),i=r.pageIndex;t.attr("nunaliit-page-index",i),0===i?t.addClass("n2Splash_currentIsFirstPage"):t.removeClass("n2Splash_currentIsFirstPage"),i>=r.pages.length-1?t.addClass("n2Splash_currentIsLastPage"):t.removeClass("n2Splash_currentIsLastPage")});var o=n.find(".n2Splash_index").empty();if(this.pages.length>1){var s="("+(this.pageIndex+1)+"/"+this.pages.length+")";o.text(s)}n.find(".n2Splash_ribbon_page").each(function(){var t=e(this);1*t.attr("nunaliit-page-index")===r.pageIndex?t.addClass("n2Splash_ribbon_page_current"):t.removeClass("n2Splash_ribbon_page_current")});var a=n.find(".n2Splash_button_previous");0==this.pageIndex?(a.removeClass("n2Splash_button_enabled"),a.addClass("n2Splash_button_disabled")):(a.addClass("n2Splash_button_enabled"),a.removeClass("n2Splash_button_disabled"));var l=n.find(".n2Splash_button_next");this.pageIndex>=this.pages.length-1?(l.removeClass("n2Splash_button_enabled"),l.addClass("n2Splash_button_disabled")):(l.addClass("n2Splash_button_enabled"),l.removeClass("n2Splash_button_disabled"))},_changeCurrentPage:function(e){e<0?(--this.pageIndex,this.pageIndex<0&&(this.pageIndex=0)):e>0&&(++this.pageIndex,this.pageIndex>=this.pages.length&&(this.pageIndex=this.pages.length-1)),this._showCurrentPage()},_goToPage:function(e){e<0?e=0:e>=this.pages.length&&(e=this.pages.length-1),this.pageIndex!==e&&(this.pageIndex=e,this._showCurrentPage())},_doNotShowAgain:function(e){if(e){var i=new Date,n=new Date(i.getTime()+3456e7);t.cookie.setCookie({name:this.cookieName,value:""+this.version,end:""+n,path:"/"})}else t.cookie.deleteCookie(this.cookieName)},_insertShowSplashPageButton:function(r){var o=this;r.empty();var s=t.utils.getElementIdentifier(r),a=r.attr("nunaliit-label");if(a||(a=i("Help")),this.dispatchService){r=e("#"+s);e("<a>").addClass("n2splash_showSplashButton").attr("href","#").text(a).appendTo(r).click(function(){return o.dispatchService.send(n,{type:"splashShowSplashPage"}),!1})}},_handleShowPreprocessElement:function(t){var i=this;t.find("*").addBack().filter(".n2s_insertShowSplashPageButton").each(function(){var t=e(this);i._insertShowSplashPageButton(t),t.removeClass("n2s_insertShowSplashPageButton").addClass("n2s_insertedShowSplashPageButton")})},_handle:function(e,i,n){if("searchInitiate"===e.type||"selected"===e.type)this.interactionSeen=!0;else if("splashWidgetSetPages"===e.type)t.isArray(e.pages)&&(this.pages=e.pages,"number"==typeof e.version&&(this.version=e.version),"string"==typeof e.cookieName&&(this.cookieName=e.cookieName),this.pageIndex=0,this._showInitialSplash());else if("showPreprocessElement"===e.type){var r=e.elem;this._handleShowPreprocessElement(r)}else"splashShowSplashPage"===e.type&&this._showSplash(!1)}});t.widgetSplash={SplashPageWidget:r,HandleWidgetAvailableRequests:function(e){"splashPage"===e.widgetType&&(e.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("splashPage"===e.widgetType){var t=e.widgetOptions,i=e.config,n={};if(t)for(var o in t)n[o]=t[o];i&&i.directory&&(n.dispatchService=i.directory.dispatchService,n.showService=i.directory.showService),new r(n)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.widgetTime";function n(e){return e<10?"0"+e:""+e}function r(e,t){var i=[];return t.indexOf("Y")>=0&&i.push(e.getUTCFullYear()),t.indexOf("M")>=0&&(i.length>0&&i.push("-"),i.push(n(e.getUTCMonth()+1))),t.indexOf("D")>=0&&(i.length>0&&i.push("-"),i.push(n(e.getUTCDate()))),t.indexOf("T")>=0&&(i.length>0&&i.push(" "),i.push(n(e.getUTCHours())),i.push(":"),i.push(n(e.getUTCMinutes()))),i.join("")}var o=t.Class({dispatchService:null,sourceModelId:null,elemId:null,rangeChangeEventName:null,rangeGetEventName:null,rangeSetEventName:null,intervalChangeEventName:null,intervalGetEventName:null,intervalSetEventName:null,rangeMin:null,rangeMax:null,intervalMin:null,intervalMax:null,initialize:function(n){var r=t.extend({containerId:null,dispatchService:null,sourceModelId:null},n),o=this;if(this.dispatchService=r.dispatchService,this.sourceModelId=r.sourceModelId,this.rangeMin=null,this.rangeMax=null,this.intervalMin=null,this.intervalMax=null,this.dispatchService){var s={type:"modelGetInfo",modelId:this.sourceModelId,modelInfo:null};this.dispatchService.synchronousCall(i,s);var a=s.modelInfo;if(a&&a.parameters&&a.parameters.range){var l=a.parameters.range;this.rangeChangeEventName=l.changeEvent,this.rangeGetEventName=l.getEvent,this.rangeSetEventName=l.setEvent,l.value&&(this.rangeMin=l.value.min,this.rangeMax=l.value.max)}if(a&&a.parameters&&a.parameters.interval){l=a.parameters.interval;this.intervalChangeEventName=l.changeEvent,this.intervalGetEventName=l.getEvent,this.intervalSetEventName=l.setEvent,l.value&&(this.intervalMin=l.value.min,this.intervalMax=l.value.max)}var c=function(e,t,i){o._handle(e,t,i)};this.rangeChangeEventName&&this.dispatchService.register(i,this.rangeChangeEventName,c),this.intervalChangeEventName&&this.dispatchService.register(i,this.intervalChangeEventName,c)}var d=r.containerId;if(!d)throw new Error("containerId must be specified");var u=e("#"+d);this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2timeline").appendTo(u),this._display(),t.log("TimelineWidget",this)},_getElem:function(){return e("#"+this.elemId)},_getSlider:function(){var t=this,i=e("#"+this.elemId).find(".n2timeline_slider");if(i.length<1&&"number"==typeof this.rangeMin&&"number"==typeof this.rangeMax&&"number"==typeof this.intervalMin&&"number"==typeof this.intervalMax){var n=e("#"+this.elemId).find(".n2timeline_slider_wrapper");(i=e("<div>").addClass("n2timeline_slider").appendTo(n)).slider({range:!0,min:this.rangeMin,max:this.rangeMax,values:[this.intervalMin,this.intervalMax],slide:function(e,i){t._barUpdated(i)}})}return i},_removeSlider:function(){e("#"+this.elemId).find(".n2timeline_slider_wrapper").empty()},_display:function(){var t=this._getElem().empty(),i=e("<div>").addClass("n2timeline_container").appendTo(t);e("<div>").addClass("n2timeline_range").appendTo(i);e("<div>").addClass("n2timeline_slider_wrapper").appendTo(i);e("<div>").addClass("n2timeline_interval").appendTo(i),this._getSlider(),this._displayRange(),this._displayInterval()},_displayRange:function(){var e=this._getElem().find(".n2timeline_range").empty();if("number"==typeof this.rangeMin&&"number"==typeof this.rangeMax){var t=new Date(this.rangeMin),i=new Date(this.rangeMax),n=r(t,"YMD")+" / "+r(i,"YMD");e.text(n)}},_displayInterval:function(){var e=this._getElem().find(".n2timeline_interval").empty();if("number"==typeof this.intervalMin&&"number"==typeof this.intervalMax){var t=new Date(this.intervalMin),i=new Date(this.intervalMax),n=r(t,"YMD")+" / "+r(i,"YMD");e.text(n)}},_barUpdated:function(e){var n=e.values[0],r=e.values[1];if(this.dispatchService){var o=new t.date.DateInterval({min:n,max:r,ongoing:!1});this.dispatchService.send(i,{type:this.intervalSetEventName,value:o})}},_handle:function(e,t,i){if(this.rangeChangeEventName===e.type){if(e.value)this.rangeMin=e.value.min,this.rangeMax=e.value.max,(n=this._getSlider()).slider({min:this.rangeMin,max:this.rangeMax}),"number"==typeof this.intervalMin&&"number"==typeof this.intervalMax&&n.slider({values:[this.intervalMin,this.intervalMax]});else this.rangeMin=null,this.rangeMax=null,this._removeSlider();this._displayRange()}else if(this.intervalChangeEventName===e.type){var n;if(e.value)this.intervalMin=e.value.min,this.intervalMax=e.value.max,(n=this._getSlider()).slider({values:[this.intervalMin,this.intervalMax]});else this.intervalMin=null,this.intervalMax=null,this._removeSlider();this._displayInterval()}}});t.widgetTime={TimelineWidget:o,HandleWidgetAvailableRequests:function(t){"timeline"===t.widgetType&&e.fn.slider&&(t.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("timeline"===e.widgetType){var t=e.widgetOptions,i=e.containerId,n=e.config,r={};if(t)for(var s in t){var a=t[s];r[s]=a}r.containerId=i,n&&n.directory&&(r.dispatchService=n.directory.dispatchService),new o(r)}}}}(jQuery,nunaliit2),function(e,t){var i=null;window&&(i=window.d3);var n=t.Class({dispatchService:null,elemId:null,mapControl:null,width:null,height:null,imageLocation:null,imageRotation:null,selectionMap:null,currentLng:null,svgCTM:null,initialize:function(i){var n=t.extend({containerId:null,dispatchService:null,rootPath:"./",moduleDisplay:null,width:100,height:100,imageLocation:null,imageRotation:0},i),r=this;this.dispatchService=n.dispatchService,this.rootPath=n.rootPath,this.width=1*n.width,this.height=1*n.height,n.moduleDisplay&&this._setMapControl(n.moduleDisplay.mapControl),n.imageLocation?(this.imageLocation=this.rootPath+n.imageLocation,this.imageRotation=n.imageRotation):(this.imageLocation=this.rootPath+"nunaliit2/images/arctic.png",this.imageRotation=0),this.dispatchService&&!this.mapControl&&this.dispatchService.register("n2.widgetPolarStereographicProjectionSelector","reportModuleDisplay",function(e){e.moduleDisplay&&e.moduleDisplay.mapControl&&(r._setMapControl(e.moduleDisplay.mapControl),r._display())});var o=n.containerId;if(!o)throw new Error("containerId must be specified");var s=e("#"+o);this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2polarStereographicProjectionSelector").appendTo(s),this._display(),t.log("ProjectionSelector",this)},_setMapControl:function(e){var t=this;this.mapControl=e,this.mapControl&&this.mapControl.map&&this.mapControl.map.events&&this.mapControl.map.events.register("changebaselayer",null,function(e){t._updateFromMap()})},_getElem:function(){return e("#"+this.elemId)},_getBaseLayers:function(e){var t=[];if(e&&e.map&&e.map.layers)for(var i=0,n=e.map.layers.length;i<n;++i){var r=e.map.layers[i];r.isBaseLayer&&t.push(r)}return t},_selectPolarStereographicLayers:function(e){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i],o=r.projection;o&&o.proj&&"laea"===o.proj.projName&&"number"==typeof o.proj.long0&&t.push(r)}return t},_createSelectionMap:function(e){for(var t={},i=0,n=e.length;i<n;++i){var r=e[i],o=r.projection.proj,s=180*o.long0/Math.PI,a=r.id,l=360-s;l>180&&(l-=360),t[a]={id:a,angle:l,lng:s,srsCode:o.srsCode}}return t},_display:function(){var e=this;if(this._getElem().empty(),this.mapControl){var n=this._getBaseLayers(this.mapControl),r=this._selectPolarStereographicLayers(n);if(n.length<1)t.log("ProjectionSelector: no base layer");else if(n.length==r.length){this.selectionMap=this._createSelectionMap(r);var o=null,s=null;this.width>this.height?(o=Math.floor(this.height/2-10),s=Math.floor(this.height/2)):(o=Math.floor(this.width/2-10),s=Math.floor(this.width/2));var a=i.select("#"+this.elemId).append("svg").attr("width",this.width).attr("height",this.height);a.each(function(){try{var i=this.getScreenCTM().inverse();e.svgCTM=i}catch(e){t.log("Unable to obtain SVG CTM: "+e)}});var l=a.append("g").attr("class","centerGroup").attr("transform","translate("+Math.floor(this.width/2)+","+Math.floor(this.height/2)+")");l.append("circle").attr("r",Math.floor(this.width/2)-Math.floor(5)).attr("fill","none").attr("stroke","#aaaaaa").attr("stroke-width",Math.floor(5)),l.append("path").attr("d","M 0 0 L -4 -8 L 4 -8 Z").attr("transform","translate(0,"+o+") rotate(180)").attr("fill","#ff0000").attr("stroke","#ffffff").attr("stroke-width",1);var c=l.append("g").attr("class","rotateGroup").attr("transform","rotate(0)");l.append("circle").attr("r",s).attr("fill","#000000").attr("fill-opacity",0).attr("stroke","none").on("mouseover",function(t){var n=i.event;e._initiateMouseOver(t,n)}).on("mousemove",function(t){var n=i.event;e._initiateMouseMove(t,n)}).on("mouseout",function(t){var n=i.event;e._initiateMouseOut(t,n)}).on("click",function(t){var n=i.event;e._initiateMouseClick(t,n)}),c.append("image").attr("transform","rotate("+this.imageRotation+")").attr("x",0-o).attr("y",0-o).attr("width",2*o).attr("height",2*o).attr("xlink:href",this.imageLocation);var d=c.append("g").attr("class","projArrows"),u=[];for(var h in this.selectionMap){var p=this.selectionMap[h];u.push(p)}d.selectAll(".projArrow").data(u,function(e){return e.id}).enter().append("path").attr("class","projArrow").attr("transform",function(e){return"rotate("+e.angle+") translate(0,"+o+")"}).attr("d","M 0 0 L -4 -8 L 4 -8 Z").attr("fill","#000000").attr("stroke","#ffffff").attr("stroke-width",1),this._updateFromMap()}else t.log("ProjectionSelector: not all base layers are polar stereographic")}},_rotateTo:function(e){this.currentLng=e,i.select("#"+this.elemId).select("g.rotateGroup").transition().attr("transform","rotate("+e+")")},_updateFromMap:function(){if(this.mapControl&&this.mapControl.map&&this.mapControl.map.baseLayer){var e=this.mapControl.map.baseLayer.id,t=null;if(this.selectionMap)for(var i in this.selectionMap){var n=this.selectionMap[i];n.selected=!1,i===e&&(n.selected=!0,t=n.lng)}"number"==typeof t&&this._rotateTo(t)}this._updateArrowStyles()},_updateArrowStyles:function(){if(this.selectionMap){var e=i.select("#"+this.elemId).select("g.projArrows"),t=[];for(var n in this.selectionMap){var r=this.selectionMap[n];t.push(r)}e.selectAll(".projArrow").data(t,function(e){return e.id}).attr("fill",function(e){return e.hovered?"#0000ff":e.selected?"#ff0000":"#000000"})}},_angleFromMouseHover:function(e,t){var i=null,n=e-Math.floor(this.width/2),r=t-Math.floor(this.height/2);return 0==n&&0==r?null:(0==r?i=n<0?-90:90:(i=180*Math.atan(n/r)/Math.PI,r<0&&(i+=180),i>180&&(i-=360)),i)},_getSelectionFromAngle:function(e){var t=null,i=null;for(var n in this.selectionMap){var r=this.selectionMap[n],o=r.lng-e;(o=Math.abs(o))>180&&(o=360-o),t?o<i&&(t=r,i=o):(t=r,i=o)}return t},_userMouseHover:function(e,t){var i=this._angleFromMouseHover(e,t);if("number"==typeof i&&"number"==typeof this.currentLng){var n=i+this.currentLng;n>180&&(n-=360),n<-180&&(n+=360);var r=this._getSelectionFromAngle(n);for(var o in this.selectionMap){var s=this.selectionMap[o];s.hovered=r===s}this._updateArrowStyles()}},_getLocationFromEvent:function(e){var t=null;if("number"==typeof e.offsetX)t={x:e.offsetX,y:e.offsetY};else if(this.svgCTM){var i=this.svgCTM;t={x:e.clientX*i.a+e.clientY*i.c+i.e,y:e.clientX*i.b+e.clientY*i.d+i.f}}return t},_initiateMouseOver:function(e,t){var i=this._getLocationFromEvent(t);i&&this._userMouseHover(i.x,i.y)},_initiateMouseMove:function(e,t){var i=this._getLocationFromEvent(t);i&&this._userMouseHover(i.x,i.y)},_initiateMouseOut:function(e,t){for(var i in this.selectionMap){this.selectionMap[i].hovered=!1}this._updateArrowStyles()},_initiateMouseClick:function(e,t){var i=this._getLocationFromEvent(t);if(i){var n=this._angleFromMouseHover(i.x,i.y);if("number"==typeof n&&"number"==typeof this.currentLng){var r=n+this.currentLng;r>180&&(r-=360),r<-180&&(r+=360);var o=this._getSelectionFromAngle(r);for(var s in this.selectionMap){var a=this.selectionMap[s];o===a&&this.mapControl&&this.mapControl.setBaseLayer&&this.mapControl.setBaseLayer(a.id)}}}}});t.widgetPolarStereographicProjectionSelector={ProjectionSelector:n,HandleWidgetAvailableRequests:function(e){!i&&window&&(i=window.d3),"polarStereographicProjectionSelector"===e.widgetType&&(i?e.isAvailable=!0:t.log("Widget polarStereographicProjectionSelector requires d3 library"))},HandleWidgetDisplayRequests:function(e){if("polarStereographicProjectionSelector"===e.widgetType){var t=e.widgetOptions,i=e.containerId,r=e.moduleDisplay,o=e.config,s={};if(t)for(var a in t){var l=t[a];s[a]=l}s.containerId=i,s.moduleDisplay=r,o&&o.directory&&(s.rootPath=o.rootPath,o.directory&&(s.dispatchService=o.directory.dispatchService)),new n(s)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.widgetBookBrowser",n=t.Class({imageUrl:null,docId:null,index:null,initialize:function(e){var i=t.extend({imageUrl:null,docId:null,index:null},e);this.imageUrl=i.imageUrl,this.docId=i.docId,this.index=i.index},getImageUrl:function(){return this.imageUrl},getDocId:function(){return this.docId},getIndex:function(){return this.index}}),r=t.Class({pages:null,initialize:function(e){t.extend({},e);this.pages=null},getPages:function(){return this.pages},loadPages:function(e){t.extend({onSuccess:function(e,t){},onError:function(e){}},e);throw"Subclasses of book must implement loadPages()"}}),o=t.Class({dispatchService:null,pagePadding:null,pageResizing:null,book:null,elemId:null,focusDocId:null,lastScrollTop:null,lastPreviewTitle:null,initialize:function(n){var r=t.extend({containerId:null,dispatchService:null,pagePadding:2,pageResizing:!0,book:null},n),o=this;if(this.pagePadding=r.pagePadding,this.pageResizing=r.pageResizing,this.book=r.book,this.focusDocId=void 0,this.lastScrollTop=void 0,this.lastPreviewTitle=void 0,this.dispatchService=r.dispatchService,this.dispatchService){this.dispatchService.register(i,"selected",function(e,t,i){o._handle(e,t,i)})}var s=r.containerId;if(!s)throw new Error("containerId must be specified");var a=e("#"+s);this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2BookBrowser_container").appendTo(a),this._display(),t.log("BookBrowser",this),this.book&&this.book.loadPages({onSuccess:function(e,t){o._pagesChanged()},onError:function(e){}})},_getElem:function(){return e("#"+this.elemId)},_display:function(){var i=this,n=this.pagePadding,r=this._getElem().empty(),o=e("<div>").addClass("n2BookBrowser_content").appendTo(r),s=e("<div>").addClass("n2BookBrowser_pagesOuter").appendTo(o).scroll(function(){return i._scrollChanged(e(this)),!1}),a=e("<div>").addClass("n2BookBrowser_pagesInner").appendTo(s),l=this.book.getPages();if(l)for(var c=n,d=0,u=l.length;d<u;++d){var h=l[d];h._bookBrowser||(h._bookBrowser={});var p=e("<div>").addClass("n2BookBrowser_page").css("position","relative").appendTo(a),f=t.utils.getElementIdentifier(p);if(h._bookBrowser.offset=c,h._bookBrowser.pageId=f,h.imageHeight){p.css("height",h.imageHeight);p.height();c+=h.imageHeight}if(c+=2*n,h.title){var m=e("<div>").addClass("n2BookBrowser_pageTitleContainer").appendTo(p);e("<div>").addClass("n2BookBrowser_pageTitleContent").text(h.title).appendTo(m)}e("<div>").addClass("n2BookBrowser_pageImageContainer").appendTo(p)}e("<div>").addClass("n2BookBrowser_preview").appendTo(o);this._loadImages()},_pagesChanged:function(){this._display(),this.focusDocId&&this._selectDocId(this.focusDocId)},_scrollChanged:function(t){var i=this,n=t.scrollTop(),r=this._getElem(),o=0,s=r.find(".n2BookBrowser_pagesOuter");s.length>0&&(o=s.height()/2);var a=n+o,l=this._getPageFromOffset(a),c=r.find(".n2BookBrowser_preview");l&&(l.title&&this.lastPreviewTitle!==l.title&&(this.lastPreviewTitle=l.title,c.empty(),e("<div>").addClass("n2BookBrowser_previewContent").text(l.title).appendTo(c).delay(500).fadeOut(300,function(){i._getElem().find(".n2BookBrowser_preview").empty()})),this._pageInFocus(l)),this.lastScrollTop=n,window.setTimeout(function(){i.lastScrollTop===n&&i._loadImages()},500)},_pageInFocus:function(e){var t=this,n=e.docId;this.focusDocId!==n&&(this.focusDocId=n,window.setTimeout(function(){t.focusDocId===n&&t.dispatchService&&t.dispatchService.send(i,{type:"userSelect",docId:n})},800))},_getPageFromOffset:function(e){var t=void 0,i=this.book.getPages();if(i)for(var n=0,r=i.length;n<r;++n){if((t=i[n])._bookBrowser){var o=t._bookBrowser.offset,s=o+t.imageHeight;if(o<=e&&e<=s)return t}}return t},_getPageFromPageId:function(e){var t=this.book.getPages();if(t)for(var i=0,n=t.length;i<n;++i){var r=t[i];if(r._bookBrowser)if(e===r._bookBrowser.pageId)return r}},_getViewportMiddleOffset:function(){var e=this._getElem(),t=e.find(".n2BookBrowser_pagesOuter").scrollTop(),i=0,n=e.find(".n2BookBrowser_pagesOuter");return n.length>0&&(i=n.height()/2),t+i},_selectDocId:function(e){var t=this._getViewportMiddleOffset(),i=this._getPageFromOffset(t);if(i&&i.getDocId()===e)return;var n=this.book.getPages();if(n)for(var r=0,o=n.length;r<o;++r){var s=n[r];if(s.docId===e)if(s._bookBrowser&&"number"==typeof s._bookBrowser.offset)this._getElem().find(".n2BookBrowser_pagesOuter").scrollTop(s._bookBrowser.offset)}},_loadImages:function(){var t=this,i=this.book.getPages();if(i){for(var n=this._getElem().find(".n2BookBrowser_pagesOuter"),r=n.scrollTop(),o=r+n.height(),s={},a={},l=0,c=i.length;l<c;++l){if((g=i[l])._bookBrowser&&"number"==typeof g._bookBrowser.offset){var d=g._bookBrowser.pageId,u=g._bookBrowser.offset,h=u+g.imageHeight;if(u>o||h<r)s[d]=g;else{a[d]=g;var p=l+1;if(p<i.length){var f=i[p];if(f._bookBrowser&&f._bookBrowser.pageId)a[f._bookBrowser.pageId]=f}var m=l-1;if(m>=0){var v=i[m];if(v._bookBrowser&&v._bookBrowser.pageId)a[v._bookBrowser.pageId]=v}}}}for(var d in a){var g=a[d],y=e("#"+d);s[d]&&delete s[d];var _=g.getImageUrl();if(_)(S=y.find(".n2BookBrowser_pageImageContainer")).find("img").length<1&&e("<img>").addClass("n2BookBrowser_pageImage").attr("n2PageId",d).load(function(){var i=e(this),n=i.height(),r=i.attr("n2PageId");return t._setPageHeight(r,n),!0}).attr("src",_).appendTo(S)}for(var d in s){var S;g=a[d];(S=(y=e("#"+d)).find(".n2BookBrowser_pageImageContainer")).find("img").remove()}}},_setPageHeight:function(t,i){if(this.pageResizing&&((u=this._getPageFromPageId(t))&&u.imageHeight!==i)){var n=this._getViewportMiddleOffset(),r=this._getPageFromOffset(n),o=void 0;r&&r._bookBrowser&&"number"==typeof r._bookBrowser.offset&&"number"==typeof r.imageHeight&&r.imageHeight>0&&((o=(n-r._bookBrowser.offset)/r.imageHeight)<0&&(o=0),o>1&&(o=1)),u.imageHeight=i,e("#"+t).css("height",u.imageHeight);var s=this.pagePadding,a=this.book.getPages();if(a)for(var l=s,c=0,d=a.length;c<d;++c){var u;(u=a[c])._bookBrowser||(u._bookBrowser={}),u._bookBrowser.offset=l,u.imageHeight&&(l+=u.imageHeight),l+=2*s}if("number"==typeof o){var h=r._bookBrowser.offset+o*r.imageHeight,p=this._getElem(),f=0,m=p.find(".n2BookBrowser_pagesOuter");m.length>0&&(f=m.height()/2);var v=h-f;v<0&&(v=0),p.find(".n2BookBrowser_pagesOuter").scrollTop(v)}}},_handle:function(e,t,i){if("selected"===e.type){var n=e.docId;this.focusDocId=n,this._selectDocId(n)}}});t.widgetBookBrowser={BookBrowser:o,HandleWidgetAvailableRequests:function(e){"bookBrowser"===e.widgetType&&(e.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("bookBrowser"===e.widgetType){var t=e.widgetOptions,i=e.contentId,n=e.containerId,r=e.config,s={};if(t)for(var a in t)s[a]=t[a];s.contentId=i,s.containerId=n,r&&r.directory&&(s.dispatchService=r.directory.dispatchService),new o(s)}},Book:r,Page:n}}(jQuery,nunaliit2),function(e,t){var i="n2.widgetNavigation",n=t.Class({elemId:null,dispatchService:null,initialize:function(n){var r=t.extend({elem:null,dispatchService:null},n),o=this;this.dispatchService=r.dispatchService;var s=e(r.elem);if(this.elemId=t.utils.getElementIdentifier(s),this.dispatchService){this.dispatchService.register(i,"historyReportState",function(e,t,i){o._handle(e,t,i)})}if(this._display(),this.dispatchService){var a={type:"historyGetState"};this.dispatchService.synchronousCall(i,a),a.state&&this._handleHistoryState(a.state)}},_display:function(){var t=this,n=this._getElem();n.empty().addClass("n2NavigationWidget_buttons"),e("<div>").addClass("n2NavigationWidget_button n2NavigationWidget_button_forward").appendTo(n).click(function(){return e(this).hasClass("n2NavigationWidget_button_enabled")&&t.dispatchService&&t.dispatchService.send(i,{type:"historyForward"}),!1}),e("<div>").addClass("n2NavigationWidget_button n2NavigationWidget_button_home n2NavigationWidget_button_enabled").appendTo(n).click(function(){return t.dispatchService&&t.dispatchService.send(i,{type:"userUnselect"}),!1}),e("<div>").addClass("n2NavigationWidget_button n2NavigationWidget_button_back").appendTo(n).click(function(){return e(this).hasClass("n2NavigationWidget_button_enabled")&&t.dispatchService&&t.dispatchService.send(i,{type:"historyBack"}),!1})},_getElem:function(){return e("#"+this.elemId)},_handleHistoryState:function(e){if(e){var t=this._getElem();e.backIsAvailable?(t.addClass("n2NavigationWidget_button_enabled_back"),t.find(".n2NavigationWidget_button_back").addClass("n2NavigationWidget_button_enabled").removeClass("n2NavigationWidget_button_disabled")):(t.removeClass("n2NavigationWidget_button_enabled_back"),t.find(".n2NavigationWidget_button_back").addClass("n2NavigationWidget_button_disabled").removeClass("n2NavigationWidget_button_enabled")),e.forwardIsAvailable?(t.addClass("n2NavigationWidget_button_enabled_forward"),t.find(".n2NavigationWidget_button_forward").addClass("n2NavigationWidget_button_enabled").removeClass("n2NavigationWidget_button_disabled")):(t.removeClass("n2NavigationWidget_button_enabled_forward"),t.find(".n2NavigationWidget_button_forward").addClass("n2NavigationWidget_button_disabled").removeClass("n2NavigationWidget_button_enabled"))}},_handle:function(e,t,i){if(this._getElem().length<1)i.deregister(t);else if("historyReportState"===e.type){var n=e.state;this._handleHistoryState(n)}}});t.widgetNavigation={NavigationWidget:n,HandleWidgetAvailableRequests:function(t){"navigation"===t.widgetType&&e.fn.slider&&(t.isAvailable=!0)},HandleWidgetDisplayRequests:function(t){if("navigation"===t.widgetType){var i,r=t.widgetOptions,o=t.containerId,s=t.config;if(!o)throw new Error("containerId must be specified");i=e("#"+o);var a={};if(r)for(var l in r){var c=r[l];a[l]=c}a.elem=i,s&&s.directory&&(a.dispatchService=s.directory.dispatchService),new n(a)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.widgetLayer",r="__ALL_LAYERS__",o=t.Class({dispatchService:null,showService:null,sourceModelId:null,elemId:null,selectedLayersChangeEventName:null,selectedLayersSetEventName:null,availableLayersChangeEventName:null,availableLayers:null,lastSelectedLayerId:null,allLayersLabel:null,initialize:function(i){var o=t.extend({containerId:null,dispatchService:null,showService:null,sourceModelId:null,allLayersLabel:null},i),s=this;if(this.dispatchService=o.dispatchService,this.showService=o.showService,this.sourceModelId=o.sourceModelId,this.allLayersLabel=o.allLayersLabel,this.availableLayers=[],this.lastSelectedLayerId=r,this.dispatchService){var a={type:"modelGetInfo",modelId:this.sourceModelId,modelInfo:null};this.dispatchService.synchronousCall(n,a);var l=a.modelInfo;if(l&&l.parameters&&l.parameters.availableLayers){var c=l.parameters.availableLayers;this.availableLayersChangeEventName=c.changeEvent,c.value&&(this.availableLayers=c.value)}if(l&&l.parameters&&l.parameters.selectedLayers){c=l.parameters.selectedLayers;this.selectedLayersChangeEventName=c.changeEvent,this.selectedLayersSetEventName=c.setEvent,c.value&&(this.selectedLayers=c.value)}var d=function(e,t,i){s._handle(e,t,i)};this.availableLayersChangeEventName&&this.dispatchService.register(n,this.availableLayersChangeEventName,d),this.selectedLayersChangeEventName&&this.dispatchService.register(n,this.selectedLayersChangeEventName,d)}var u=o.containerId;if(!u)throw new Error("containerId must be specified");var h=e("#"+u);this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2layerSelectionWidget").appendTo(h),this._availableLayersUpdated(),t.log("LayerSelectionWidget",this)},_getElem:function(){return e("#"+this.elemId)},_availableLayersUpdated:function(){var t=this,n=this._getElem();n.empty();var o=e("<select>").appendTo(n).change(function(){t._selectionChanged()}),s=i("All Layers");this.allLayersLabel&&(s=i(this.allLayersLabel)),e("<option>").text(s).val(r).appendTo(o);var a=null,l=[];this.availableLayers.sort();for(var c=0,d=this.availableLayers.length;c<d;++c){var u=this.availableLayers[c],h=e("<option>").text(u).val(u).appendTo(o);l.push(h),u===this.lastSelectedLayerId&&(a=u),this.showService&&this.showService.printLayerName(h,u)}a?o.val(a):o.val(r),this._selectionChanged()},_selectionChanged:function(){var e=this._getElem().find("select").val();if(r===e){var t=[];this.availableLayers.forEach(function(e){t.push(e)}),this.dispatchService.send(n,{type:this.selectedLayersSetEventName,value:t})}else{(t=[]).push(e),this.dispatchService.send(n,{type:this.selectedLayersSetEventName,value:t})}},_selectedLayersUpdated:function(){this._getElem().find("select").val(this.lastSelectedLayerId)},_handle:function(e,t,i){if(this.availableLayersChangeEventName===e.type)e.value&&(this.availableLayers=e.value,this._availableLayersUpdated());else if(this.selectedLayersChangeEventName===e.type&&e.value){var n={},o=void 0;e.value.forEach(function(e){n[e]=!0,o=e});var s=!0;this.availableLayers.forEach(function(e){n[e]||(s=!1)}),this.lastSelectedLayerId=s?r:o,this._selectedLayersUpdated()}}});t.widgetLayer={LayerSelectionWidget:o,HandleWidgetAvailableRequests:function(t){"layerSelectionWidget"===t.widgetType&&e.fn.slider&&(t.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("layerSelectionWidget"===e.widgetType){var t=e.widgetOptions,i=e.containerId,n=e.config,r={};if(t)for(var s in t){var a=t[s];r[s]=a}r.containerId=i,n&&n.directory&&(r.dispatchService=n.directory.dispatchService,r.showService=n.directory.showService),new o(r)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.widgetSelectableFilter",r="__ALL_CHOICES__",o="__NO_CHOICE_SELECTED__",s=t.Class("SingleFilterSelectionWidget",{dispatchService:null,showService:null,sourceModelId:null,elemId:null,selectedChoicesChangeEventName:null,selectedChoicesSetEventName:null,allSelectedChangeEventName:null,allSelectedSetEventName:null,availableChoicesChangeEventName:null,availableChoices:null,selectedChoices:null,selectedChoiceIdMap:null,allSelected:null,allChoicesLabel:null,noChoiceLabel:null,suppressAllChoices:null,suppressNoChoice:null,suppressedChoicesMap:null,_throttledAvailableChoicesUpdated:null,initialize:function(i){var r=t.extend({containerId:null,dispatchService:null,showService:null,sourceModelId:null,allChoicesLabel:null,noChoiceLabel:null,suppressAllChoices:!1,suppressNoChoice:!1,suppressChoices:void 0},i),o=this;if(this.dispatchService=r.dispatchService,this.showService=r.showService,this.sourceModelId=r.sourceModelId,this.allChoicesLabel=r.allChoicesLabel,this.noChoiceLabel=r.noChoiceLabel,this.suppressAllChoices=r.suppressAllChoices,this.suppressNoChoice=r.suppressNoChoice,this.availableChoices=[],this.selectedChoices=[],this.selectedChoiceIdMap={},this.allSelected=!1,this.suppressedChoicesMap=[],this._throttledAvailableChoicesUpdated=t.utils.throttle(this._availableChoicesUpdated,1500),r.suppressChoices&&(t.isArray(r.suppressChoices)?r.suppressChoices.forEach(function(e){"string"==typeof e?o.suppressedChoicesMap[e]=!0:t.logError("SingleFilterSelectionWidget: suppressChoices must be an array of strings")}):t.logError("SingleFilterSelectionWidget: suppressChoices must be an array")),this.dispatchService){var s={type:"modelGetInfo",modelId:this.sourceModelId,modelInfo:null};this.dispatchService.synchronousCall(n,s);var a=s.modelInfo;if(a&&a.parameters&&a.parameters.availableChoices){var l=a.parameters.availableChoices;this.availableChoicesChangeEventName=l.changeEvent,l.value&&this._setAvailableChoices(l.value)}if(a&&a.parameters){if(a.parameters.selectedChoices){l=a.parameters.selectedChoices;this.selectedChoicesChangeEventName=l.changeEvent,this.selectedChoicesSetEventName=l.setEvent,l.value&&(this.selectedChoices=l.value,this.selectedChoiceIdMap={},this.selectedChoices.forEach(function(e){o.selectedChoiceIdMap[e]=!0}))}if(a.parameters.allSelected){l=a.parameters.allSelected;this.allSelectedChangeEventName=l.changeEvent,this.allSelectedSetEventName=l.setEvent,"boolean"==typeof l.value&&(this.allSelected=l.value)}}var c=function(e,t,i){o._handle(e,t,i)};this.availableChoicesChangeEventName&&this.dispatchService.register(n,this.availableChoicesChangeEventName,c),this.selectedChoicesChangeEventName&&this.dispatchService.register(n,this.selectedChoicesChangeEventName,c),this.allSelectedChangeEventName&&this.dispatchService.register(n,this.allSelectedChangeEventName,c)}var d=r.containerId;if(!d)throw new Error("containerId must be specified");var u=e("#"+d);this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2widget_singleFilterSelection").appendTo(u),this._availableChoicesUpdated(),t.log("SingleFilterSelectionWidget",this)},_getElem:function(){return e("#"+this.elemId)},_availableChoicesUpdated:function(){var t=this,n=this._getElem();n.empty();var s=e("<select>").appendTo(n).change(function(){t._selectionChanged()});if(!this.suppressNoChoice){var a=i("--");this.noChoiceLabel&&(a=i(this.noChoiceLabel)),e("<option>").addClass("n2widget_singleFilterSelection_optionNoChoice").text(a).val(o).appendTo(s)}if(!this.suppressAllChoices){var l=i("All");this.allChoicesLabel&&(l=i(this.allChoicesLabel)),e("<option>").addClass("n2widget_singleFilterSelection_optionAllChoices").text(l).val(r).appendTo(s)}for(var c=0,d=this.availableChoices.length;c<d;++c){var u=this.availableChoices[c],h=u.label;h||(h=u.id);e("<option>").text(h).val(u.id).appendTo(s)}this.availableChoices.length>0?n.removeClass("n2widget_singleFilterSelection_noChoiceAvailable").addClass("n2widget_singleFilterSelection_atLeastOneChoiceAvailable"):n.removeClass("n2widget_singleFilterSelection_atLeastOneChoiceAvailable").addClass("n2widget_singleFilterSelection_noChoiceAvailable"),this._adjustSelectedItem()},_adjustSelectedItem:function(){var t;this.allSelected?this.suppressAllChoices||(t=r):this.selectedChoices.length<1?this.suppressNoChoice||(t=o):t=this.selectedChoices.length>1?void 0:this.selectedChoices[0];var i=this._getElem().find("select");t?(i.val(t),i.find("option.n2widget_singleFilterSelection_optionUnknown").remove()):(i.find("option.n2widget_singleFilterSelection_optionUnknown").length<1&&e("<option>").addClass("n2widget_singleFilterSelection_optionUnknown").text("").val("__UNKNOWN_CHOICE_SELECTED__").prependTo(i),i.val("__UNKNOWN_CHOICE_SELECTED__"))},_selectionChanged:function(){var e=this._getElem().find("select").val();if(r===e)this.dispatchService.send(n,{type:this.allSelectedSetEventName,value:!0});else if(o===e){var t=[];this.dispatchService.send(n,{type:this.selectedChoicesSetEventName,value:t})}else if("__UNKNOWN_CHOICE_SELECTED__"===e);else{(t=[]).push(e),this.dispatchService.send(n,{type:this.selectedChoicesSetEventName,value:t})}},_setAvailableChoices:function(e){var i=this;this.availableChoices=[],t.isArray(e)&&e.forEach(function(e){i.suppressedChoicesMap[e.id]||i.availableChoices.push(e)})},_handle:function(e,t,i){var n=this;this.availableChoicesChangeEventName===e.type?e.value&&(this._setAvailableChoices(e.value),this._throttledAvailableChoicesUpdated()):this.selectedChoicesChangeEventName===e.type?e.value&&(this.selectedChoices=e.value,this.selectedChoiceIdMap={},this.selectedChoices.forEach(function(e){n.selectedChoiceIdMap[e]=!0}),this._adjustSelectedItem()):this.allSelectedChangeEventName===e.type&&"boolean"==typeof e.value&&(this.allSelected=e.value,this._adjustSelectedItem())}}),a=t.Class("MultiFilterSelectionWidget",{dispatchService:null,showService:null,sourceModelId:null,elemId:null,selectedChoicesChangeEventName:null,selectedChoicesSetEventName:null,allSelectedChangeEventName:null,allSelectedSetEventName:null,availableChoicesChangeEventName:null,availableChoices:null,selectedChoices:null,selectedChoiceIdMap:null,allSelected:null,allChoicesLabel:null,_throttledAvailableChoicesUpdated:null,initialize:function(i){var r=t.extend({containerId:null,dispatchService:null,showService:null,sourceModelId:null,allChoicesLabel:null},i),o=this;if(this.dispatchService=r.dispatchService,this.showService=r.showService,this.sourceModelId=r.sourceModelId,this.allChoicesLabel=r.allChoicesLabel,this.availableChoices=[],this.selectedChoices=[],this.selectedChoiceIdMap={},this.allSelected=!1,this._throttledAvailableChoicesUpdated=t.utils.throttle(this._availableChoicesUpdated,1500),this.dispatchService){var s={type:"modelGetInfo",modelId:this.sourceModelId,modelInfo:null};this.dispatchService.synchronousCall(n,s);var a=s.modelInfo;if(a&&a.parameters&&a.parameters.availableChoices){var l=a.parameters.availableChoices;this.availableChoicesChangeEventName=l.changeEvent,l.value&&(this.availableChoices=l.value)}if(a&&a.parameters){if(a.parameters.selectedChoices){l=a.parameters.selectedChoices;this.selectedChoicesChangeEventName=l.changeEvent,this.selectedChoicesSetEventName=l.setEvent,l.value&&(this.selectedChoices=l.value,this.selectedChoiceIdMap={},this.selectedChoices.forEach(function(e){o.selectedChoiceIdMap[e]=!0}))}if(a.parameters.allSelected){l=a.parameters.allSelected;this.allSelectedChangeEventName=l.changeEvent,this.allSelectedSetEventName=l.setEvent,"boolean"==typeof l.value&&(this.allSelected=l.value)}}var c=function(e,t,i){o._handle(e,t,i)};this.availableChoicesChangeEventName&&this.dispatchService.register(n,this.availableChoicesChangeEventName,c),this.selectedChoicesChangeEventName&&this.dispatchService.register(n,this.selectedChoicesChangeEventName,c),this.allSelectedChangeEventName&&this.dispatchService.register(n,this.allSelectedChangeEventName,c)}var d=r.containerId;if(!d)throw new Error("containerId must be specified");var u=e("#"+d);this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2widget_multiFilterSelection").appendTo(u),this._throttledAvailableChoicesUpdated(),t.log(this._classname,this)},_getElem:function(){return e("#"+this.elemId)},_availableChoicesUpdated:function(){var t=this,n=this._getElem();n.empty();var o=i("All");this.allChoicesLabel&&(o=i(this.allChoicesLabel));var s=e("<a>").addClass("n2widget_multiFilterSelection_optionAllChoices n2widget_multiFilterSelection_option").attr("href","#").attr("n2-choice-id",r).appendTo(n).click(function(){var i=e(this),n=i.attr("n2-choice-id");return t._selectionClicked(n,i),!1});e("<span>").text(o).appendTo(s);for(var a=0,l=this.availableChoices.length;a<l;++a){var c=this.availableChoices[a],d=c.label;d||(d=c.id);s=e("<a>").addClass("n2widget_multiFilterSelection_option").attr("href",c.id).attr("n2-choice-id",c.id).appendTo(n).click(function(){var i=e(this),n=i.attr("n2-choice-id");return t._selectionClicked(n,i),!1});e("<span>").text(d).appendTo(s)}this._adjustSelectedItem()},_adjustSelectedItem:function(){var t=this;this._getElem().find(".n2widget_multiFilterSelection_option").each(function(){var i=e(this),n=i.attr("n2-choice-id"),o=!1;r===n?t.allSelected&&(o=!0):t.selectedChoiceIdMap[n]&&(o=!0),o?(i.removeClass("n2widget_multiFilterSelection_notSelected"),i.addClass("n2widget_multiFilterSelection_selected")):(i.removeClass("n2widget_multiFilterSelection_selected"),i.addClass("n2widget_multiFilterSelection_notSelected"))})},_selectionClicked:function(e,t){if(r===e)this.allSelected?this.dispatchService.send(n,{type:this.selectedChoicesSetEventName,value:[]}):this.dispatchService.send(n,{type:this.allSelectedSetEventName,value:!0});else{var i=[],o=!1;this.selectedChoices.forEach(function(t){t===e?o=!0:i.push(t)}),o||i.push(e),this.dispatchService.send(n,{type:this.selectedChoicesSetEventName,value:i})}},_handle:function(e,t,i){var n=this;this.availableChoicesChangeEventName===e.type?e.value&&(this.availableChoices=e.value,this._throttledAvailableChoicesUpdated()):this.selectedChoicesChangeEventName===e.type?e.value&&(this.selectedChoices=e.value,this.selectedChoiceIdMap={},this.selectedChoices.forEach(function(e){n.selectedChoiceIdMap[e]=!0}),this._adjustSelectedItem()):this.allSelectedChangeEventName===e.type&&"boolean"==typeof e.value&&(this.allSelected=e.value,this._adjustSelectedItem())}}),l=t.Class("MultiFilterSelectionDropDownWidget",{dispatchService:null,showService:null,sourceModelId:null,elemId:null,selectedChoicesChangeEventName:null,selectedChoicesSetEventName:null,allSelectedChangeEventName:null,allSelectedSetEventName:null,availableChoicesChangeEventName:null,availableChoices:null,selectedChoices:null,selectedChoiceIdMap:null,allSelected:null,allChoicesLabel:null,noChoiceLabel:null,label:null,showAsLink:null,_throttledAvailableChoicesUpdated:null,initialize:function(r){var o=t.extend({containerId:null,dispatchService:null,showService:null,sourceModelId:null,allChoicesLabel:null,noChoiceLabel:null,label:null,showAsLink:!1},r),s=this;if(this.dispatchService=o.dispatchService,this.showService=o.showService,this.sourceModelId=o.sourceModelId,this.allChoicesLabel=o.allChoicesLabel,this.noChoiceLabel=o.noChoiceLabel,this.label=o.label,this.showAsLink=o.showAsLink,this.availableChoices=[],this.selectedChoices=[],this.selectedChoiceIdMap={},this._throttledAvailableChoicesUpdated=t.utils.throttle(this._availableChoicesUpdated,1500),this.dispatchService){var a={type:"modelGetInfo",modelId:this.sourceModelId,modelInfo:null};this.dispatchService.synchronousCall(n,a);var l=a.modelInfo;if(l&&l.parameters&&l.parameters.availableChoices){var c=l.parameters.availableChoices;this.availableChoicesChangeEventName=c.changeEvent,c.value&&(this.availableChoices=c.value)}if(l&&l.parameters&&l.parameters.selectedChoices){c=l.parameters.selectedChoices;this.selectedChoicesChangeEventName=c.changeEvent,this.selectedChoicesSetEventName=c.setEvent,c.value&&(this.selectedChoices=c.value,this.selectedChoiceIdMap={},this.selectedChoices.forEach(function(e){s.selectedChoiceIdMap[e]=!0}))}if(l&&l.parameters&&l.parameters.allSelected){c=l.parameters.allSelected;this.allSelectedChangeEventName=c.changeEvent,this.allSelectedSetEventName=c.setEvent,"boolean"==typeof c.value&&(this.allSelected=c.value)}var d=function(e,t,i){s._handle(e,t,i)};this.availableChoicesChangeEventName&&this.dispatchService.register(n,this.availableChoicesChangeEventName,d),this.selectedChoicesChangeEventName&&this.dispatchService.register(n,this.selectedChoicesChangeEventName,d),this.allSelectedChangeEventName&&this.dispatchService.register(n,this.allSelectedChangeEventName,d)}var u=o.containerId;if(!u)throw new Error("containerId must be specified");var h=e("#"+u);this.elemId=t.getUniqueId();var p=e("<div>").attr("id",this.elemId).addClass("n2widget_multiDropDownFilterSelection n2widget_multiDropDownFilterSelection_selection_hidden").appendTo(h);this.showAsLink&&p.addClass("n2widget_multiDropDownFilterSelection_asLink");var f=e("<div>").css({position:"relative"}).appendTo(p),m=void 0;if(this.label&&(m=i(this.label)),m||(m=i("Multi-Selection")),this.showAsLink)e("<a>").attr("href",m).text(m).appendTo(f).click(function(){return s._buttonClicked(),!1});else e("<button>").appendTo(f).text(m).click(function(){s._buttonClicked()});e("<div>").addClass("n2widget_multiDropDownFilterSelection_position").appendTo(f);this._throttledAvailableChoicesUpdated(),t.log(this._classname,this)},_getElem:function(){return e("#"+this.elemId)},_availableChoicesUpdated:function(){var t=this,n=this._getElem().find(".n2widget_multiDropDownFilterSelection_position");n.empty();var o=e("<div>").appendTo(n).addClass("n2widget_multiDropDownFilterSelection_select"),s=i("All");this.allChoicesLabel&&(s=i(this.allChoicesLabel)),u(o,r,s);for(var a=0,l=this.availableChoices.length;a<l;++a){var c=this.availableChoices[a],d=c.label;d||(d=c.id),u(o,c.id,d)}function u(i,n,r){var o=e("<div>").addClass("n2widget_multiDropDownFilterSelection_option").attr("data-n2-choiceId",n).appendTo(i);e("<a>").text(r).attr("data-n2-choiceId",n).appendTo(o).click(function(){var i=e(this).attr("data-n2-choiceId");return t._selectionChanged(i),!1})}this._adjustSelectedItem()},_adjustSelectedItem:function(){var t=this.allSelected,i={};this.selectedChoices.forEach(function(e){i[e]=!0}),this._getElem().find(".n2widget_multiDropDownFilterSelection_option").each(function(){var n=e(this),r=n.attr("data-n2-choiceId");t||i[r]?n.removeClass("n2widget_multiDropDownFilterSelection_optionUnselected").addClass("n2widget_multiDropDownFilterSelection_optionSelected"):n.removeClass("n2widget_multiDropDownFilterSelection_optionSelected").addClass("n2widget_multiDropDownFilterSelection_optionUnselected")})},_selectionChanged:function(e){if(r===e)this.allSelected?this.dispatchService.send(n,{type:this.selectedChoicesSetEventName,value:[]}):this.dispatchService.send(n,{type:this.allSelectedSetEventName,value:!0});else{var t=[],i=!1;this.selectedChoices.forEach(function(n){n===e?i=!0:t.push(n)}),i||t.push(e),this.dispatchService.send(n,{type:this.selectedChoicesSetEventName,value:t})}},_buttonClicked:function(){var e=this._getElem();e.hasClass("n2widget_multiDropDownFilterSelection_selection_shown")?e.removeClass("n2widget_multiDropDownFilterSelection_selection_shown").addClass("n2widget_multiDropDownFilterSelection_selection_hidden"):e.removeClass("n2widget_multiDropDownFilterSelection_selection_hidden").addClass("n2widget_multiDropDownFilterSelection_selection_shown")},_handle:function(e,t,i){var n=this;this.availableChoicesChangeEventName===e.type?e.value&&(this.availableChoices=e.value,this._throttledAvailableChoicesUpdated()):this.selectedChoicesChangeEventName===e.type?e.value&&(this.selectedChoices=e.value,this.selectedChoiceIdMap={},this.selectedChoices.forEach(function(e){n.selectedChoiceIdMap[e]=!0}),this._adjustSelectedItem()):this.allSelectedChangeEventName===e.type&&"boolean"==typeof e.value&&(this.allSelected=e.value,this._adjustSelectedItem())}});t.widgetSelectableFilter={SingleFilterSelectionWidget:s,MultiFilterSelectionDropDownWidget:l,HandleWidgetAvailableRequests:function(e){"singleFilterSelectionWidget"===e.widgetType?e.isAvailable=!0:"multiFilterSelectionWidget"===e.widgetType?e.isAvailable=!0:"multiFilterSelectionDropDownWidget"===e.widgetType&&(e.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("singleFilterSelectionWidget"===e.widgetType){var t=e.widgetOptions,i=e.containerId,n=e.config,r={};if(t)for(var o in t){var c=t[o];r[o]=c}r.containerId=i,n&&n.directory&&(r.dispatchService=n.directory.dispatchService,r.showService=n.directory.showService),new s(r)}else if("multiFilterSelectionWidget"===e.widgetType){if(t=e.widgetOptions,i=e.containerId,n=e.config,r={},t)for(var o in t)c=t[o],r[o]=c;r.containerId=i,n&&n.directory&&(r.dispatchService=n.directory.dispatchService,r.showService=n.directory.showService),new a(r)}else if("multiFilterSelectionDropDownWidget"===e.widgetType){if(t=e.widgetOptions,i=e.containerId,n=e.config,r={},t)for(var o in t)c=t[o],r[o]=c;r.containerId=i,n&&n.directory&&(r.dispatchService=n.directory.dispatchService,r.showService=n.directory.showService),new l(r)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.widgetExport",n=t.Class({dispatchService:null,exportService:null,sourceModelId:null,label:null,elemId:null,modelDocsById:null,initialize:function(n){var r,o,s=t.extend({containerId:null,dispatchService:null,exportService:null,sourceModelId:null,label:(r="Export",t.loc(r,"nunaliit2",o))},n),a=this;if(this.dispatchService=s.dispatchService,this.exportService=s.exportService,this.sourceModelId=s.sourceModelId,this.label=s.label,this.modelDocsById={},!this.exportService)throw new Error("ExportWidget requires export service");var l=s.containerId;if(!l)throw new Error("containerId must be specified");var c=e("#"+l);if(this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2widget_export").appendTo(c),this.dispatchService){this.dispatchService.register(i,"modelStateUpdated",function(e,t,i){a._handle(e,t,i)});var d={type:"modelGetState",modelId:this.sourceModelId};this.dispatchService.synchronousCall(i,d),d.state&&this._sourceModelUpdated(d.state)}t.log("ExportWidget",this)},_getElem:function(){return e("#"+this.elemId)},_sourceModelUpdated:function(i){var n=this;if(i.added)for(var r=0,o=i.added.length;r<o;++r){var s=i.added[r];this.modelDocsById[s._id]=s}if(i.updated)for(r=0,o=i.updated.length;r<o;++r){s=i.updated[r];this.modelDocsById[s._id]=s}if(i.removed)for(r=0,o=i.removed.length;r<o;++r){s=i.removed[r];delete this.modelDocsById[s._id]}var a=this._getElem();a.empty(),this._atLeastOneDocumentAvailable()&&e("<a>").attr("href","Export Documents").text(this.label).appendTo(a).click(function(){try{n._performExport()}catch(e){t.log("Error during export: "+e)}return!1})},_atLeastOneDocumentAvailable:function(){for(var e in this.modelDocsById)return!0;return!1},_performExport:function(){var e=[];for(var i in this.modelDocsById){var n=this.modelDocsById[i];e.push(n)}this.exportService.createExportApplication({docs:e,logger:new t.logger.CustomLogger({logFn:function(){},reportErrorFn:function(e){t.log("Export error: "+e)}})})},_handle:function(e,t,i){"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&this._sourceModelUpdated(e.state)}});t.widgetExport={ExportWidget:n,HandleWidgetAvailableRequests:function(t){"exportWidget"===t.widgetType&&e.fn.slider&&(t.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("exportWidget"===e.widgetType){var t=e.widgetOptions,i=e.containerId,r=e.config,o={};if(t)for(var s in t){var a=t[s];o[s]=a}o.containerId=i,r&&r.directory&&(o.dispatchService=r.directory.dispatchService,o.exportService=r.directory.exportService),new n(o)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n=t.Class({dispatchService:null,showService:null,sourceModelIds:null,elemId:null,browserId:null,selectedModelId:null,selectedDocId:null,initialize:function(i){var n=t.extend({containerId:null,dispatchService:null,showService:null,sourceModelIds:null},i);this.dispatchService=n.dispatchService,this.showService=n.showService,this.sourceModelIds=n.sourceModelIds,this.selectedModelId=null,this.selectedDocId=null;var r=n.containerId;if(!r)throw new Error("containerId must be specified");var o=e("#"+r);if(this.elemId=t.getUniqueId(),this.browserId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2widget_modelBrowser").appendTo(o),this.dispatchService);t.log("ModelBrowserWidget",this),this._display()},_handle:function(e,t,i){},_getElem:function(){return e("#"+this.elemId)},_display:function(){var t=this,n=this._getElem();n.empty(),e("<a>").addClass("n2widget_modelBrowser_button").attr("href","#").text(i("Models")).appendTo(n).click(function(){var i=e("#"+t.browserId);return i.length>0?i.dialog("close"):t._showBrowser(),!1})},_showBrowser:function(){var t=e("<div>").addClass("n2widget_modelBrowser_window").attr("id",this.browserId).appendTo(e("body"));e("<div>").addClass("n2widget_modelBrowser_models").appendTo(t),e("<div>").addClass("n2widget_modelBrowser_list").appendTo(t),e("<div>").addClass("n2widget_modelBrowser_document").appendTo(t),this._refreshModels();var n={autoOpen:!0,title:i("Model Browser"),modal:!1,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};t.dialog(n)},_refreshModels:function(){var t=this,i=e("#"+this.browserId).find(".n2widget_modelBrowser_models").empty(),n=this.sourceModelIds;if(!n){var r={type:"modelGetList",modelIds:[]};this.dispatchService.synchronousCall("n2.widgetModelBrowser",r),n=r.modelIds}for(var o={},s=0,a=n.length;s<a;++s){var l=n[s];o[l]=!0;var c=e("<a>").addClass("n2widget_modelBrowser_model").attr("href","#").attr("nunaliit-source-model-id",l).text(l).appendTo(i).click(function(){var i=e(this).attr("nunaliit-source-model-id");return t.selectedModelId=i,t._refreshModels(),!1});l===this.selectedModelId&&c.addClass("n2widget_modelBrowser_model_selected")}o[this.selectedModelId]||(this.selectedModelId=null),t._refreshList()},_refreshList:function(){var n=this,r=e("#"+this.browserId).find(".n2widget_modelBrowser_list").empty();if(this.selectedModelId){var o=t.model.getModelState({dispatchService:this.dispatchService,modelId:this.selectedModelId}),s={},a=[];if(o.added)for(var l=0,c=o.added.length;l<c;++l){var d=o.added[l]._id;s[d]||(s[d]=!0,a.push(d))}a.sort(),s[this.selectedDocId]||(this.selectedDocId=null);e("<div>").addClass("n2widget_modelBrowser_list_count").text(i("Number of documents: {count}",{count:a.length})).appendTo(r);var u=e("<div>").addClass("n2widget_modelBrowser_list_docIds").appendTo(r);a.forEach(function(t){var i=e("<a>").addClass("n2widget_modelBrowser_list_docId").addClass("n2widget_modelBrowser_list_docId_raw").attr("href","#").attr("nunaliit-document-id",t).appendTo(u).text(t).click(function(){var t=e(this).attr("nunaliit-document-id");return n.selectedDocId=t,n._refreshList(),!1}).mouseover(function(){var t=e(this);if(t.hasClass("n2widget_modelBrowser_list_docId_raw")){var i=t.attr("nunaliit-document-id");n.showService&&(n.showService.printBriefDescription(t,i),t.removeClass("n2widget_modelBrowser_list_docId_raw"))}});n.selectedDocId===t&&(i.addClass("n2widget_modelBrowser_list_docId_selected"),n.showService&&(n.showService.printBriefDescription(i,t),i.removeClass("n2widget_modelBrowser_list_docId_raw")))})}this._refreshDocument()},_refreshDocument:function(){var n=e("#"+this.browserId).find(".n2widget_modelBrowser_document").empty();if(this.selectedDocId){e("<div>").addClass("n2widget_modelBrowser_document_id").text(i("Document: {id}",{id:this.selectedDocId})).appendTo(n);var r=e("<div>").addClass("n2widget_modelBrowser_document_tree").attr("nunaliit-document",this.selectedDocId).appendTo(n),o=this._getDocumentFromSelectedModel(this.selectedDocId);new t.tree.ObjectTree(r,o)}},_getDocumentFromSelectedModel:function(e){var i=t.model.getModelState({dispatchService:this.dispatchService,modelId:this.selectedModelId});if(i.added)for(var n=0,r=i.added.length;n<r;++n){var o=i.added[n];if(e===o._id)return o}}});t.widgetModelBrowser={ModelBrowserWidget:n,HandleWidgetAvailableRequests:function(e){"modelBrowserWidget"===e.widgetType&&(e.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("modelBrowserWidget"===e.widgetType){var i=e.widgetOptions,r=e.containerId,o=e.config,s={};if(i){var a=void 0;for(var l in i){var c=i[l];if("sourceModelId"===l){if("string"!=typeof c)throw new Error("In modelBrowserWidget configuration, sourceModelId must be a string");a||(a=[]),a.push(c)}else if("sourceModelIds"===l){if(!t.isArray(c))throw new Error("In modelBrowserWidget configuration, sourceModelIds must be an array of strings");c.forEach(function(e){if("string"!=typeof e)throw new Error("In modelBrowserWidget configuration, sourceModelIds must be an array of strings");a||(a=[]),a.push(e)})}else s[l]=c}s.sourceModelIds=a}s.containerId=r,o&&o.directory&&(s.dispatchService=o.directory.dispatchService,s.showService=o.directory.showService),new n(s)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.widgetLegend",r=t.Class("LegendWidget",{dispatchService:null,sourceCanvasName:null,labels:null,elemId:null,stylesInUse:null,cachedSymbols:null,_throttledRefresh:null,initialize:function(i){var r=t.extend({containerId:null,dispatchService:null,sourceCanvasName:null,labels:null},i),o=this;if(this.dispatchService=r.dispatchService,this.sourceCanvasName=r.sourceCanvasName,this.labels=r.labels,this.stylesInUse=null,this.cachedSymbols={},this._throttledRefresh=t.utils.throttle(this._refresh,2e3),"string"!=typeof this.sourceCanvasName)throw new Error("sourceCanvasName must be specified");if(this.labels&&!t.isArray(this.labels))throw new Error("labels must be an array");if(this.dispatchService){this.dispatchService.register(n,"canvasReportStylesInUse",function(e,t,i){o._handle(e,t,i)});var s={type:"canvasGetStylesInUse",canvasName:this.sourceCanvasName};this.dispatchService.synchronousCall(n,s),this.stylesInUse=s.stylesInUse}var a=r.containerId;if(!a)throw new Error("containerId must be specified");var l=e("#"+a);this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2widgetLegend").appendTo(l),t.log(this._classname,this),this._throttledRefresh()},_getElem:function(){return e("#"+this.elemId)},_handle:function(e,t,i){"canvasReportStylesInUse"===e.type&&e.canvasName===this.sourceCanvasName&&(this.stylesInUse=e.stylesInUse,this._throttledRefresh())},_refresh:function(){var t=this,n=this._getElem();n.empty(),this.refreshCount=this.refreshCount?this.refreshCount+1:1;var r={},o=!1;for(var s in this.stylesInUse){var a=t.stylesInUse[s],l=a.style;if(l.label){var c=i(l.label),d=r[c];d||(d={},r[c]=d),d[s]=a,o=!0}}if(o){var u=e("<div>").addClass("n2widgetLegend_outer").appendTo(n),h=[];if(this.labels)this.labels.forEach(function(e){var t=i(e);r[t]&&h.push(t)});else{for(var p in r)h.push(p);h.sort()}h.forEach(function(i){var n=r[i],o=e("<div>").addClass("n2widgetLegend_legendEntry").appendTo(u),s=e("<div>").addClass("n2widgetLegend_symbolColumn").appendTo(o),a=e("<div>").addClass("n2widgetLegend_symbolColumn_point").appendTo(s),l=e("<div>").addClass("n2widgetLegend_symbolColumn_line").appendTo(s),c=e("<div>").addClass("n2widgetLegend_symbolColumn_polygon").appendTo(s),d=e("<div>").addClass("n2widgetLegend_symbolColumn_cluster").appendTo(s),h=e("<div>").addClass("n2widgetLegend_labelColumn").appendTo(o);e("<div>").addClass("n2widgetLegend_labelEntry").text(i).appendTo(h);var p=[];for(var f in n)p.push(f);p.sort(),p.forEach(function(i){var r=n[i],o=r.style;if(r.point&&r.point.cluster&&r.point.cluster.length>1){var s=e("<div>").addClass("n2widgetLegend_preview n2widgetLegend_previewCluster").attr("n2-style-id",o.id).appendTo(d);t._insertSvgPreviewPoint(s,o,r.point)}else if(r.point){s=e("<div>").addClass("n2widgetLegend_preview n2widgetLegend_previewPoint").attr("n2-style-id",o.id).appendTo(a);t._insertSvgPreviewPoint(s,o,r.point)}if(r.line){s=e("<div>").addClass("n2widgetLegend_preview n2widgetLegend_previewLine").attr("n2-style-id",o.id).appendTo(l);t._insertSvgPreviewLine(s,o,r.line)}if(r.polygon){s=e("<div>").addClass("n2widgetLegend_preview n2widgetLegend_previewPolygon").attr("n2-style-id",o.id).appendTo(c);t._insertSvgPreviewPolygon(s,o,r.polygon)}})})}},_insertSvgPreviewPoint:function(t,i,n){var r=this,o={};for(var s in n){var a=n[s];o[s]="n2_hovered"!==s&&("n2_selected"!==s&&("n2_found"!==s&&a))}var l=i.getSymbolizer(o),c=this._createSVGNode("svg");if(c){this._setAttr(c,"version","1.1"),this._setAttr(c,"viewBox","-7 -7 14 14"),this._addClass(c,"n2widgetLegend_svg");var d=e(c),u=l.getSymbolValue("graphicName",o),h=null;if(u&&this.cachedSymbols[u])h=this._createSVGNode("path"),this._setAttr(h,"d",this.cachedSymbols[u]);else if(u&&OpenLayers.Renderer.symbol[u]){var p=this._computePathFromSymbol(OpenLayers.Renderer.symbol[u]);this.cachedSymbols[u]=p,h=this._createSVGNode("path"),this._setAttr(h,"d",this.cachedSymbols[u])}else h=this._createSVGNode("circle"),this._setAttr(h,"r",5);h&&(l.forEachSymbol(function(e,t){if("r"===e);else if("fill-opacity"===e){var i=.5*t+.5;r._setAttr(h,e,i)}else r._setAttr(h,e,t)},o),c.appendChild(h)),t.append(d)}},_insertSvgPreviewLine:function(t,i,n){var r=this,o={};for(var s in n){var a=n[s];o[s]="n2_hovered"!==s&&("n2_selected"!==s&&("n2_found"!==s&&a))}var l=i.getSymbolizer(o),c=this._createSVGNode("svg");if(c){this._setAttr(c,"version","1.1"),this._setAttr(c,"viewBox","-7 -7 14 14"),this._addClass(c,"n2widgetLegend_svg");var d=e(c),u=this._createSVGNode("line");this._setAttr(u,"x1",-5),this._setAttr(u,"y1",0),this._setAttr(u,"x2",5),this._setAttr(u,"y2",0),u&&(l.forEachSymbol(function(e,t){r._setAttr(u,e,t)},o),c.appendChild(u)),t.append(d)}},_insertSvgPreviewPolygon:function(t,i,n){var r=this,o={};for(var s in n){var a=n[s];o[s]="n2_hovered"!==s&&("n2_selected"!==s&&("n2_found"!==s&&a))}var l=i.getSymbolizer(o),c=this._createSVGNode("svg");if(c){this._setAttr(c,"version","1.1"),this._setAttr(c,"viewBox","-7 -7 14 14"),this._addClass(c,"n2widgetLegend_svg");var d=e(c),u=this._createSVGNode("path");this._setAttr(u,"d","M -5 -5 L -2.5 5 L 5 5 L 2.5 -5 Z"),u&&(l.forEachSymbol(function(e,t){if("fill-opacity"===e){var i=.5*t+.5;r._setAttr(u,e,i)}else r._setAttr(u,e,t)},o),c.appendChild(u)),t.append(d)}},_createSVGNode:function(e,t){var i=null;return document.createElementNS&&(i=document.createElementNS("http://www.w3.org/2000/svg",e),t&&i.setAttributeNS(null,"id",t)),i},_setAttr:function(e,t,i){e.setAttributeNS(null,t,i)},_addClass:function(e,t){var i=[],n=e.getAttribute("class")||"";n&&(i=n.split(" ")),i.indexOf(t)<0&&i.push(t),e.setAttribute("class",i.join(" "))},_computePathFromSymbol:function(e){for(var t=void 0,i=void 0,n=void 0,r=void 0,o=0,s=e.length;o<s;o+=2){var a=e[o],l=e[o+1];void 0===t?t=a:t>a&&(t=a),void 0===i?i=a:i<a&&(i=a),void 0===n?n=l:n>l&&(n=l),void 0===r?r=l:r<l&&(r=l)}var c=[],d=(t+i)/2,u=(n+r)/2,h=i-t,p=r-n,f=h>p?h/10:p/10;f<=0&&(f=1);for(o=0,s=e.length;o<s;o+=2){var m=((a=e[o])-d)/f,v=((l=e[o+1])-u)/f;m=Math.floor(100*m)/100,v=Math.floor(100*v)/100,0===o?c.push("M "):c.push("L "),c.push(""+m),c.push(" "+v+" ")}return c.push("Z"),c.join("")}});t.widgetLegend={LegendWidget:r,HandleWidgetAvailableRequests:function(t){"legendWidget"===t.widgetType&&e.fn.slider&&(t.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("legendWidget"===e.widgetType){var t=e.widgetOptions,i=e.containerId,n=e.config,o={};if(t)for(var s in t){var a=t[s];o[s]=a}o.containerId=i,n&&n.directory&&(o.dispatchService=n.directory.dispatchService),new r(o)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.widgetCollapsibleContainer",n=t.Class("CollapsibleWidgetContainer",{dispatchService:null,config:null,elemId:null,initialize:function(n){var r=t.extend({containerId:null,dispatchService:null,config:null,widgets:null,addClasses:null,initiallyOpened:!1},n),o=this;this.dispatchService=r.dispatchService,this.config=r.config;var s=[];if(t.isArray(r.widgets)&&this.dispatchService&&r.widgets.forEach(function(e){var n=!1;if(e&&e.widgetType){var r={type:"widgetIsTypeAvailable",widgetType:e.widgetType,widgetOptions:e,isAvailable:!1};o.dispatchService.synchronousCall(i,r),r.isAvailable&&(n=!0)}e&&!n?t.log("Widget handler not found for type: "+e.widgetType):s.push(e)}),s.length>0){var a=r.containerId;if(!a)throw new Error("containerId must be specified");var l=e("#"+a);this.elemId=t.getUniqueId();var c=e("<div>").attr("id",this.elemId).addClass("n2widgetCollapsibleContainer").appendTo(l);"string"==typeof r.addClasses?c.addClass(r.addClasses):t.isArray(r.addClasses)&&r.addClasses.forEach(function(e){"string"==typeof e&&c.addClass(e)}),r.initiallyOpened&&c.addClass("n2widgetCollapsibleContainer_opened");e("<div>").addClass("n2widgetCollapsibleContainer_button").appendTo(c).click(function(){return o._buttonClicked(),!1});var d=t.getUniqueId();e("<div>").attr("id",d).addClass("n2widgetCollapsibleContainer_widgetContainer n2widgetContainer").appendTo(c);s.forEach(function(e){o.dispatchService.send(i,{type:"widgetDisplay",widgetType:e.widgetType,widgetOptions:e,containerId:d,config:o.config})}),t.log(this._classname,this)}else t.log(this._classname+": Not drawing because container is empty")},_getElem:function(){return e("#"+this.elemId)},_buttonClicked:function(){var e=this._getElem();e.hasClass("n2widgetCollapsibleContainer_opened")?e.removeClass("n2widgetCollapsibleContainer_opened"):e.addClass("n2widgetCollapsibleContainer_opened")}});t.widgetCollapsibleContainer={CollapsibleWidgetContainer:n,HandleWidgetAvailableRequests:function(t){"collapsibleWidgetContainer"===t.widgetType&&e.fn.slider&&(t.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("collapsibleWidgetContainer"===e.widgetType){var t=e.widgetOptions,i=e.containerId,r=e.config,o={};if(t)for(var s in t){var a=t[s];o[s]=a}o.containerId=i,r&&(o.config=r,r.directory&&(o.dispatchService=r.directory.dispatchService)),new n(o)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.widgetResizingContainer",n=t.Class("ResizingWidgetContainer",{dispatchService:null,config:null,elemId:null,anchor:null,resizeClasses:null,intervalId:null,lastDimensionValue:null,initialize:function(n){var r=t.extend({containerId:null,dispatchService:null,config:null,widgets:null,addClasses:null,anchor:"bottom",resizeClasses:null},n),o=this;this.dispatchService=r.dispatchService,this.config=r.config,this.anchor=r.anchor,t.isArray(r.resizeClasses)&&(this.resizeClasses=[],r.resizeClasses.forEach(function(e){"string"==typeof e&&o.resizeClasses.push(e)})),this.lastDimensionValue=-1;var s=[];if(t.isArray(r.widgets)&&this.dispatchService&&r.widgets.forEach(function(e){var n=!1;if(e&&e.widgetType){var r={type:"widgetIsTypeAvailable",widgetType:e.widgetType,widgetOptions:e,isAvailable:!1};o.dispatchService.synchronousCall(i,r),r.isAvailable&&(n=!0)}e&&!n?t.log("Widget handler not found for type: "+e.widgetType):s.push(e)}),s.length>0){var a=r.containerId;if(!a)throw new Error("containerId must be specified");var l=e("#"+a);this.elemId=t.getUniqueId();var c=e("<div>").attr("id",this.elemId).addClass("n2widgetResizingContainer n2widgetContainer").css({position:"absolute",border:"none",margin:"0",padding:"0"}).appendTo(l);if("bottom"===this.anchor)c.css({bottom:"0"});else if("top"===this.anchor)c.css({top:"0"});else if("left"===this.anchor)c.css({left:"0"});else{if("right"!==this.anchor)throw new Error("Unknown anchor: "+this.anchor);c.css({right:"0"})}"string"==typeof r.addClasses?c.addClass(r.addClasses):t.isArray(r.addClasses)&&r.addClasses.forEach(function(e){"string"==typeof e&&c.addClass(e)}),s.forEach(function(e){o.dispatchService.send(i,{type:"widgetDisplay",widgetType:e.widgetType,widgetOptions:e,containerId:o.elemId,config:o.config})}),this.intervalId=window.setInterval(function(){o._refreshSize()},300),t.log(this._classname,this)}else t.log(this._classname+": Not drawing because container is empty")},_getElem:function(){return e("#"+this.elemId)},_refreshSize:function(){var i,n=this,r=this._getElem();r.length<1?window.clearInterval(this.intervalId):("bottom"===this.anchor?i=r.height():"top"===this.anchor?i=r.height():"left"===this.anchor?i=r.width():"right"===this.anchor&&(i=r.width()),i!==this.lastDimensionValue&&(this.lastDimensionValue=i,t.isArray(this.resizeClasses)&&this.resizeClasses.forEach(function(t){"bottom"===n.anchor?e("."+t).css("bottom",i+"px"):"top"===n.anchor?e("."+t).css("top",i+"px"):"left"===n.anchor?e("."+t).css("left",i+"px"):"right"===n.anchor&&e("."+t).css("right",i+"px")})))}});t.widgetResizingContainer={ResizingWidgetContainer:n,HandleWidgetAvailableRequests:function(t){"resizingWidgetContainer"===t.widgetType&&e.fn.slider&&(t.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("resizingWidgetContainer"===e.widgetType){var t=e.widgetOptions,i=e.containerId,r=e.config,o={};if(t)for(var s in t){var a=t[s];o[s]=a}o.containerId=i,r&&(o.config=r,r.directory&&(o.dispatchService=r.directory.dispatchService)),new n(o)}}}}(jQuery,nunaliit2),function(t,i){var n=function(e,t){return i.loc(e,"nunaliit2",t)},r="n2.widgetDuplicate",o=i.Class("DuplicateWidget",{dispatchService:null,label:null,elemId:null,selectedDocId:null,docForDuplicate:null,showAsLink:!1,duplicateAllDocs:!1,duplicateOnSchemas:null,initialize:function(e){var o=i.extend({containerId:null,dispatchService:null,label:n("Duplicate"),showAsLink:!1,duplicateAllDocs:void 0,duplicateOnSchemas:void 0},e),s=this;if(this.dispatchService=o.dispatchService,this.label=o.label,this.showAsLink=o.showAsLink,this.selectedDocId=null,this.docForDuplicate=null,this.duplicateAllDocs=void 0,o.duplicateAllDocs){var a=this._parseSelectors(o.duplicateAllDocs,"duplicateAllDocs");this.duplicateAllDocs=a}if(this.duplicateOnSchemas={},o.duplicateOnSchemas)for(var l in o.duplicateOnSchemas){var c=o.duplicateOnSchemas[l];a=this._parseSelectors(c,"duplicateOnSchemas["+l+"]");this.duplicateOnSchemas[l]=a}var d=o.containerId;if(!d)throw new Error("containerId must be specified");var u=t("#"+d);if(this.elemId=i.getUniqueId(),t("<div>").attr("id",this.elemId).addClass("n2widget_duplicate").appendTo(u),this.dispatchService){var h=function(e,t,i){s._handle(e,t,i)};this.dispatchService.register(r,"selected",h),this.dispatchService.register(r,"unselected",h),this.dispatchService.register(r,"documentContent",h)}this._redraw(),i.log(this._classname,this)},_getElem:function(){return t("#"+this.elemId)},_parseSelectors:function(t,n){if("ALL_ATTRIBUTES"===t)return!0;if("boolean"==typeof t&&!t)return!1;if(i.isArray(t)){var r=[];return t.forEach(function(t){if("string"==typeof t)try{var o=i.objectSelector.parseSelector(t);r.push(o)}catch(e){i.logError(this._classname+": Error while parsing object selector for "+n+": "+t,e)}else i.logError(this._classname+": Unknown copy scheme for schema "+n+": "+t,e)}),r}i.logError(this._classname+": Unrecognized selectors for "+n)},_handle:function(e,t,i){if("selected"===e.type){if(this.selectedDocId=null,this.docForDuplicate=null,e.doc)this.selectedDocId=e.doc._id,this._isDocumentEligibleForDuplicate(e.doc)&&(this.docForDuplicate=e.doc);else if(e.docId){this.selectedDocId=e.docId;e={type:"requestDocument",docId:e.docId};i.send(r,e)}this._redraw()}else if("unselected"===e.type)this.selectedDocId=null,this.docForDuplicate=null,this._redraw();else if("documentContent"===e.type){var n=e.doc;n&&this.selectedDocId===n._id&&!this.docForDuplicate&&this._isDocumentEligibleForDuplicate(n)&&(this.docForDuplicate=n,this._redraw())}},_isDocumentEligibleForDuplicate:function(e){if(!e)return!1;if(this.duplicateAllDocs)return!0;var t=e.nunaliit_schema;return!!this.duplicateOnSchemas[t]},_redraw:function(){var e=this,r=this._getElem();r.empty(),this.docForDuplicate&&(this.showAsLink?(r.addClass("n2widget_duplicate_asLink"),t("<a>").attr("href",n("Duplicate")).text(this.label).appendTo(r).click(function(){try{e._performDuplicate()}catch(e){i.log("Error during duplicate: "+e)}return!1})):(r.removeClass("n2widget_duplicate_asLink"),t("<button>").text(n("Duplicate")).appendTo(r).click(function(){return e._performDuplicate(),!1})))},_performDuplicate:function(){if(this.docForDuplicate){var e={nunaliit_schema:this.docForDuplicate.nunaliit_schema},t=e.nunaliit_schema;this.duplicateOnSchemas[t]?this._copyOnSelectors(e,this.docForDuplicate,this.duplicateOnSchemas[t]):this.duplicateAllDocs&&this._copyOnSelectors(e,this.docForDuplicate,this.duplicateAllDocs),this.dispatchService.send(r,{type:"editInitiate",doc:e})}else i.logError("DuplicateWidget: no document selected for duplicate")},_copyOnSelectors:function(e,t,n){if("ALL_ATTRIBUTES"===n)for(var r in t)if("string"==typeof r&&r.length>0&&"_"===r[0]);else if("nunaliit_import"===r||"nunaliit_attachments"===r||"nunaliit_created"===r||"nunaliit_last_updated"===r||"nunaliit_geom"===r);else{var o=t[r];e[r]=i.deepCopy(o)}else{if(!i.isArray(n))throw new Error(this._classname+" Unknown copy selector",n);n.forEach(function(n){var r=n.getValue(t);if(void 0===r)n.removeValue(e);else{var o=i.deepCopy(r);n.setValue(e,o,!0)}})}}});i.widgetDuplicate={DuplicateWidget:o,HandleWidgetAvailableRequests:function(e){"duplicateDocument"===e.widgetType&&t.fn.slider&&(e.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("duplicateDocument"===e.widgetType){var t=e.widgetOptions,i=e.containerId,n=e.config,r={};if(t)for(var s in t){var a=t[s];r[s]=a}r.containerId=i,n&&n.directory&&(r.dispatchService=n.directory.dispatchService),new o(r)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.widgetTranscript",n=t.Class("TranscriptWidget",{dispatchService:null,attachmentService:null,elemId:null,videoId:null,transcriptId:null,name:null,docId:null,videoAttName:null,srtAttName:null,doc:null,srtData:null,transcript_array:null,sourceModelId:null,intervalChangeEventName:null,intervalGetEventName:null,intervalSetEventName:null,intervalMin:null,intervalMax:null,timeTable:null,transcriptConvertor:null,initialize:function(n){var o=t.extend({containerId:void 0,dispatchService:void 0,attachmentService:void 0,name:void 0,docId:void 0,doc:void 0,sourceModelId:void 0},n),s=this;this.dispatchService=o.dispatchService,this.attachmentService=o.attachmentService,this.name=o.name,this.docId=o.docId,this.sourceModelId=o.sourceModelId,o.doc&&(this.doc=o.doc,this.docId=this.doc._id),this.name||(this.name=t.getUniqueId()),this.transcriptConvertor=new r,this.transcript_array=[];var a=o.containerId;if(!a)throw new Error("containerId must be specified");var l=e("#"+a);if(this.elemId=t.getUniqueId(),e("<div>").attr("id",this.elemId).addClass("n2widgetTranscript").appendTo(l),this.dispatchService){if(this.sourceModelId){var c={type:"modelGetInfo",modelId:this.sourceModelId,modelInfo:null};this.dispatchService.synchronousCall(i,c);var d=c.modelInfo;if(d&&d.parameters&&d.parameters.interval){var u=d.parameters.interval;this.intervalChangeEventName=u.changeEvent,this.intervalGetEventName=u.getEvent,this.intervalSetEventName=u.setEvent,u.value&&(this.intervalMin=u.value.min,this.intervalMax=u.value.max)}}var h=function(e,t,i){s._handle(e,t,i)};this.dispatchService.register(i,"mediaTimeChanged",h),this.dispatchService.register(i,"documentContent",h),this.intervalChangeEventName&&this.dispatchService.register(i,this.intervalChangeEventName,h),this.docId||this.dispatchService.register(i,"selected",h)}t.log(this._classname,this),this._documentChanged()},_getElem:function(){return e("#"+this.elemId)},_handle:function(e,t,i){if("mediaTimeChanged"===e.type)e.name==this.name&&this._timeChanged(e.currentTime,e.origin);else if("documentContent"===e.type)e.docId==this.docId&&(this.doc?this.doc._rev!=e.doc._rev&&(this.doc=e.doc,this._documentChanged()):(this.doc=e.doc,this._documentChanged()));else if(this.intervalChangeEventName===e.type){if(e.value){this.intervalMin=e.value.min,this.intervalMax=e.value.max;var n=this._convertTimeToVideoTime(this.intervalMin);"number"==typeof n&&this._timeChanged(n,"model")}}else"selected"===e.type&&e.docId!=this.docId&&(this.docId=e.docId,this.doc=e.doc,this.timeTable=[],this._documentChanged())},_convertTimeToVideoTime:function(e){var t=void 0;return this.timeTable&&this.timeTable.forEach(function(i){if(i.timeStart<e&&e<i.timeEnd){var n=(e-i.timeStart)/(i.timeEnd-i.timeStart);t=i.videoStart+n*(i.videoEnd-i.videoStart)}}),t},_convertVideoTimeToTime:function(e){var t=void 0;return this.timeTable&&this.timeTable.forEach(function(i){if(i.videoStart<e&&e<i.videoEnd){var n=(e-i.videoStart)/(i.videoEnd-i.videoStart);t=i.timeStart+n*(i.timeEnd-i.timeStart),t=Math.floor(t)}}),t},_documentChanged:function(){var n=this;if(this.doc)if(this.transcript)if(this.srtData)this.transcript.timeTable&&(t.isArray(this.transcript.timeTable)?(this.timeTable=[],this.transcript.timeTable.forEach(function(e){if("object"!=typeof e)throw new Error("Entries in timeTable must be objects");if(null===e)throw new Error("Entries in timeTable can not be null");var i=e.videoStart,r=e.videoEnd,o=e.timeStart,s=e.timeEnd;if("number"!=typeof i)throw new Error("videoStart in timeTable must be a number");if("number"!=typeof r)throw new Error("videoEnd in timeTable must be a number");var a=t.date.parseUserDate(o),l=t.date.parseUserDate(s),c={intervalStart:a,intervalEnd:l,timeStart:a.min,timeEnd:l.min,videoStart:i,videoEnd:r};n.timeTable.push(c)})):n._renderError("timeTable must be an array"));else{var r=void 0;this.attachmentService&&this.transcript&&this.transcript.srtAttName&&(r=this.attachmentService.getAttachment(this.doc,this.transcript.srtAttName));var o=void 0;r&&(o=r.computeUrl()),o?e.ajax({url:o,type:"GET",async:!0,traditional:!0,data:{},dataType:"text",success:function(e){n.srtData=e,n.transcript_array=n.transcriptConvertor.execute(e),n._documentChanged()},error:function(e,t,i){n._documentChanged()}}):n._renderError("Can not compute URL for SRT")}else this._loadTranscript(this.doc);else this.dispatchService.send(i,{type:"requestDocument",docId:this.docId});this._refresh()},_refresh:function(){var i=this,n=this._getElem();if(n.empty(),this.docId&&this.transcript){var r=void 0;this.transcript&&(r=this.transcript.videoAttName);var o=null,s=this.doc;s&&s.nunaliit_attachments&&s.nunaliit_attachments.files&&r&&(o=s.nunaliit_attachments.files[r])&&"video"!==o.fileClass&&(o=void 0);var a=null;if(o&&o.thumbnail){var l=this.attachmentService.getAttachment(this.doc,o.thumbnail);l&&(a=l.computeUrl())}var c=void 0;if(o&&"attached"===o.status){var d=this.attachmentService.getAttachment(this.doc,r);d&&(c=d.computeUrl())}if(c){var u=t.getUniqueId();this.videoId=t.getUniqueId(),this.transcriptId=t.getUniqueId();var h=e("<div>").attr("id",u).appendTo(n),p=e("<video>").attr("id",this.videoId).attr("controls","controls").attr("width","100%").attr("height","360px").appendTo(h),f=e("<source>").attr("src",c).appendTo(p);o.mimeType&&f.attr("type",o.mimeType),p.mediaelementplayer({poster:a,features:["playpause","progress","volume","sourcechooser","fullscreen"]}),!function(n,r){for(var o=0;o<r.length;o++){var s=r[o],a=t.getUniqueId();s.id=a,e("<span/>").attr("id",a).attr("data-start",s.start).text(s.text+" ").appendTo(n).click(function(t){var n=e(this),r=n.attr("data-start");i._updateCurrentTime(r,"text")})}}(e("<div>").attr("id",this.transcriptId).addClass("n2widgetTranscript_transcript").appendTo(h),this.transcript_array),p.bind("timeupdate",function(){var e=this.currentTime;i._updateCurrentTime(e,"video")})}else i._renderError("Can not compute URL for video")}},_loadTranscript:function(t){if(t&&t.nunaliit_transcript)this.transcript=t.nunaliit_transcript,this._documentChanged();else{var i=this._findTranscriptAttachmentName(this.doc);if(i){var n=void 0;this.attachmentService&&(n=this.attachmentService.getAttachment(this.doc,i));var r=void 0;n&&(r=n.computeUrl()),r?e.ajax({url:r,type:"GET",async:!0,traditional:!0,data:{},dataType:"json",success:function(e){_this.transcript=e,_this._documentChanged()},error:function(e,t,i){_this._renderError("Error fetching transcript")}}):_this._renderError("Can not compute URL for transcript")}else _this._renderError("Transcript attachment name not found for "+this.doc._id)}},_findTranscriptAttachmentName:function(e){if(e&&e.nunaliit_attachments&&e.nunaliit_attachments.files)for(var t in e.nunaliit_attachments.files){e.nunaliit_attachments.files[t];if("transcript.json"===t)return t}},_updateCurrentTime:function(e,n){if(this.dispatchService.send(i,{type:"mediaTimeChanged",name:this.name,currentTime:e,origin:n}),this.intervalSetEventName){var r=this._convertVideoTimeToTime(e);if("number"==typeof r){var o=new t.date.DateInterval({min:r,max:this.intervalMax,ongoing:!1});this.dispatchService.send(i,{type:this.intervalSetEventName,value:o})}}},_timeChanged:function(t,i){for(var n=0;n<this.transcript_array.length;n++){var r=this.transcript_array[n],o=e("#"+r.id);o.removeClass("highlight"),t>=r.start&&t<=r.fin&&o.addClass("highlight")}if("model"===i){var s=(a=e("#"+this.videoId))[0].currentTime;Math.abs(s-t)<.5||(a[0].currentTime=t)}else if("text"===i){var a;(a=e("#"+this.videoId))[0].currentTime=t,a[0].play()}},_renderError:function(i){var n=this._getElem();n.empty();var r,o,s=(r="Unable to display tether content({docId})",o={docId:this.docId},t.loc(r,"nunaliit2",o));e("<span>").addClass("n2widgetTranscript_error").text(s).appendTo(n),t.logError("Unable to display tether content({docId}): "+i)}}),r=t.Class("SrtToJsonConvertor",{execute:function(e){var i=[],n=e.split("\n");if(!t.isArray(n))throw new Error("srtFile data processing error");for(var r=-1,o=n.length,s="";++r<o;)if(""!==n[r].replace(/^\s+|\s+$/g,"")){var a=n[r].replace(/^\s+|\s+$/g,""),l=n[++r].replace(/^\s+|\s+$/g,"");if(-1!==a.search(/[0-9]+/i)&&-1!==l.search(/[0-9][0-9]:[0-9][0-9]:[0-9][0-9]\,[0-9][0-9][0-9] --> [0-9][0-9]:[0-9][0-9]:[0-9][0-9]\,[0-9][0-9][0-9]/i)){var c={start:null,fin:null,text:""};for(c.start=3600*l.substring(0,2)+60*l.substring(3,5)+l.substring(6,8),c.fin=3600*l.substring(17,19)+60*l.substring(20,22)+l.substring(23,25);""!==(s=n[++r]);)c.text+=s;i.push(c)}}return i}});t.widgetTranscript={TranscriptWidget:n,SrtToJsonConvertor:r,HandleWidgetAvailableRequests:function(e){"transcriptWidget"===e.widgetType&&(e.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("transcriptWidget"===e.widgetType){var t=e.widgetOptions,i=e.containerId,r=e.config,o={};if(t)for(var s in t){var a=t[s];o[s]=a}o.containerId=i,r&&r.directory&&(o.dispatchService=r.directory.dispatchService,o.attachmentService=r.directory.attachmentService),new n(o)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.canvas",n=t.Class({dispatchService:null,initialize:function(e){var n=t.extend({dispatchService:null},e),r=this;if(this.dispatchService=n.dispatchService,this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(i,"canvasIsTypeAvailable",o),this.dispatchService.register(i,"canvasDisplay",o)}},_handle:function(e,i,n){"canvasIsTypeAvailable"===e.type?(t.canvasForceGraph&&t.canvasForceGraph.HandleCanvasAvailableRequest&&t.canvasForceGraph.HandleCanvasAvailableRequest(e),t.canvasRadial&&t.canvasRadial.HandleCanvasAvailableRequest&&t.canvasRadial.HandleCanvasAvailableRequest(e),t.canvasRadialTree&&t.canvasRadialTree.HandleCanvasAvailableRequest&&t.canvasRadialTree.HandleCanvasAvailableRequest(e),t.canvasCollapsibleRadialTree&&t.canvasCollapsibleRadialTree.HandleCanvasAvailableRequest&&t.canvasCollapsibleRadialTree.HandleCanvasAvailableRequest(e),t.canvasGrid&&t.canvasGrid.HandleCanvasAvailableRequest&&t.canvasGrid.HandleCanvasAvailableRequest(e),t.canvasPack&&t.canvasPack.HandleCanvasAvailableRequest&&t.canvasPack.HandleCanvasAvailableRequest(e),t.canvasTree&&t.canvasTree.HandleCanvasAvailableRequest&&t.canvasTree.HandleCanvasAvailableRequest(e),t.canvasCustomSvg&&t.canvasCustomSvg.HandleCanvasAvailableRequest&&t.canvasCustomSvg.HandleCanvasAvailableRequest(e),t.canvasCustomHtml&&t.canvasCustomHtml.HandleCanvasAvailableRequest&&t.canvasCustomHtml.HandleCanvasAvailableRequest(e),t.canvasReferenceBrowser&&t.canvasReferenceBrowser.HandleCanvasAvailableRequest&&t.canvasReferenceBrowser.HandleCanvasAvailableRequest(e),t.canvasTable&&t.canvasTable.HandleCanvasAvailableRequest&&t.canvasTable.HandleCanvasAvailableRequest(e),t.canvasMap&&t.canvasMap.HandleCanvasAvailableRequest&&t.canvasMap.HandleCanvasAvailableRequest(e)):"canvasDisplay"===e.type&&(t.canvasForceGraph&&t.canvasForceGraph.HandleCanvasDisplayRequest&&t.canvasForceGraph.HandleCanvasDisplayRequest(e),t.canvasRadial&&t.canvasRadial.HandleCanvasDisplayRequest&&t.canvasRadial.HandleCanvasDisplayRequest(e),t.canvasRadialTree&&t.canvasRadialTree.HandleCanvasDisplayRequest&&t.canvasRadialTree.HandleCanvasDisplayRequest(e),t.canvasCollapsibleRadialTree&&t.canvasCollapsibleRadialTree.HandleCanvasDisplayRequest&&t.canvasCollapsibleRadialTree.HandleCanvasDisplayRequest(e),t.canvasGrid&&t.canvasGrid.HandleCanvasDisplayRequest&&t.canvasGrid.HandleCanvasDisplayRequest(e),t.canvasPack&&t.canvasPack.HandleCanvasDisplayRequest&&t.canvasPack.HandleCanvasDisplayRequest(e),t.canvasTree&&t.canvasTree.HandleCanvasDisplayRequest&&t.canvasTree.HandleCanvasDisplayRequest(e),t.canvasCustomSvg&&t.canvasCustomSvg.HandleCanvasDisplayRequest&&t.canvasCustomSvg.HandleCanvasDisplayRequest(e),t.canvasCustomHtml&&t.canvasCustomHtml.HandleCanvasDisplayRequest&&t.canvasCustomHtml.HandleCanvasDisplayRequest(e),t.canvasReferenceBrowser&&t.canvasReferenceBrowser.HandleCanvasDisplayRequest&&t.canvasReferenceBrowser.HandleCanvasDisplayRequest(e),t.canvasTable&&t.canvasTable.HandleCanvasDisplayRequest&&t.canvasTable.HandleCanvasDisplayRequest(e),t.canvasMap&&t.canvasMap.HandleCanvasDisplayRequest&&t.canvasMap.HandleCanvasDisplayRequest(e))}});t.canvas={Service:n}}(jQuery,nunaliit2),function(e,t){var i="n2.canvasElementGenerator",n=t.Class("ElementGenerator",{elementsChanged:null,intentChanged:null,contextByDocId:null,fragmentById:null,elementById:null,dispatchService:null,userIntentView:null,eventSource:null,initialize:function(e){var i=t.extend({dispatchService:null,eventSource:null,elementsChanged:function(e,t,i){},intentChanged:function(e){}},e),n=this;this.elementsChanged=i.elementsChanged,this.intentChanged=i.intentChanged,this.contextByDocId={},this.fragmentById={},this.elementById={},this.eventSource=void 0,i.eventSource&&(this.eventSource=i.eventSource),this.dispatchService=i.dispatchService,this.userIntentView=new t.userIntentView.IntentView({dispatchService:i.dispatchService}),this.userIntentView.addListener(function(e){n._intentChangedContexts(e)})},setElementsChangedListener:function(e){this.elementsChanged=e},setIntentChangedListener:function(e){this.intentChanged=e},setEventSource:function(e){this.eventSource=e},sourceModelUpdated:function(e){var i=t.extend({added:null,updated:null,removed:null},e),n=[],r=[],o=[];if(i.added)for(var s=0,a=i.added.length;s<a;++s){var l={n2_id:(c=i.added[s])._id,n2_doc:c,fragments:[]};n.push(l),this.contextByDocId[c._id]=l}if(i.updated)for(s=0,a=i.updated.length;s<a;++s){var c=i.updated[s];if(l=this.contextByDocId[c._id])l.n2_doc=c,r.push(l);else{l={n2_id:c._id,n2_doc:c,fragments:[]};n.push(l),this.contextByDocId[c._id]=l}}if(i.removed)for(s=0,a=i.removed.length;s<a;++s){c=i.removed[s];(l=this.contextByDocId[c._id])&&(delete this.contextByDocId[c._id],o.push(l))}o&&o.length&&this.userIntentView.removeNodes(o),n&&n.length&&this.userIntentView.addNodes(n),(n.length>0||r.length>0||o.length>0)&&this._contextsUpdated(n,r,o)},selectOn:function(e){if(e){var t=this._docsFromElement(e),n=[],r=[];for(var o in t){var s=t[o];n.push(o),r.push(s)}n.length<1?this.dispatchService.send(i,{type:"userUnselect",_source:this.eventSource}):1==n.length?this.dispatchService.send(i,{type:"userSelect",docId:n[0],doc:r[0],_source:this.eventSource}):n.length>1&&this.dispatchService.send(i,{type:"userSelect",docIds:n,docs:r,_source:this.eventSource})}},selectOff:function(e){if(e){var t=this._docsFromElement(e);for(var n in t){var r=t[n];this.dispatchService.send(i,{type:"userUnselect",docId:n,doc:r,_source:this.eventSource})}}},focusOn:function(e){if(e){var t=this._docsFromElement(e),n=[],r=[];for(var o in t){var s=t[o];n.push(o),r.push(s)}n.length>1?this.dispatchService.send(i,{type:"userFocusOn",docIds:n,docs:r,_source:this.eventSource}):n.length>0&&this.dispatchService.send(i,{type:"userFocusOn",docId:n[0],doc:r[0],_source:this.eventSource})}},focusOff:function(e){if(e){var t=this._docsFromElement(e);for(var n in t){var r=t[n];this.dispatchService.send(i,{type:"userFocusOff",docId:n,doc:r,_source:this.eventSource})}}},_contextsUpdated:function(e,t,i){var n=[],r=[];if(e||t){var o=[];e&&o.push.apply(o,e),t&&o.push.apply(o,t);for(var s=0,a=o.length;s<a;++s){for(var l=(u=o[s]).fragments,c=0;c<l.length;++c){var d=l[c];r.push(d)}u.fragments=this._createFragmentsFromDoc(u.n2_doc);for(c=0;c<u.fragments.length;++c){(d=u.fragments[c]).context=u,n.push(d)}}}if(i)for(s=0,a=i.length;s<a;++s){var u;for(l=(u=i[s]).fragments,c=0;c<l.length;++c){d=l[c];r.push(d)}}for(c=0;c<r.length;++c){(d=r[c]).context=null}(n.length>0||r.length>0)&&this._fragmentsUpdated(n,r)},_createFragmentsFromDoc:function(e){throw new Error("Sub-classes to ElementGenerator must implement _createFragmentsFromDoc()")},_fragmentsUpdated:function(e,i){for(var n=0;n<i.length;++n){var r=(c=i[n]).id;c.elements={},this.fragmentById[r]&&delete this.fragmentById[r]}for(n=0;n<e.length;++n){r=(c=e[n]).id;this.fragmentById[r]=c}for(var r in this.fragmentById){(c=this.fragmentById[r]).elements={}}var o={};for(var s in this.elementById){var a=this.elementById[s];o[s]=a,a.fragments={}}var l=this._updateElements(this.fragmentById,o);for(var s in l){a=l[s];for(var r in a.fragments){var c;void 0===(c=a.fragments[r]).elements&&t.log("Undefined elements"),c.elements[s]=a}}var d=[],u=[],h=[];for(var s in this.elementById)void 0===l[s]&&h.push(this.elementById[s]);for(var s in l)void 0===this.elementById[s]?d.push(l[s]):u.push(l[s]);for(var s in this.elementById=l,this.elementById){a=this.elementById[s];this._adjustElementIntent(a)}this.elementsChanged(d,u,h)},_updateElements:function(e,i){if("function"==typeof this._createClusters)return t.log("ElementGenerator._createClusters() is deprecated. Use _updateElements()."),this.clusterById=i,this._createClusters(e);throw new Error("Subclasses of ElementGenerator should implement _updateElements()")},_adjustElementIntent:function(e){if(e.n2_selected=!1,e.n2_selectedIntent=void 0,e.n2_hovered=!1,e.n2_hoveredIntent=void 0,e.n2_found=!1,e.n2_intent=void 0,e.fragments)for(var t in e.fragments){var i=e.fragments[t].context;i&&(i.n2_selected&&(e.n2_selected=!0),i.n2_hovered&&(e.n2_hovered=!0),i.n2_found&&(e.n2_found=!0),i.n2_selectedIntent&&(null===e.n2_selectedIntent||(void 0===e.n2_selectedIntent?e.n2_selectedIntent=i.n2_selectedIntent:e.n2_selectedIntent=null)),i.n2_hoveredIntent&&(null===e.n2_hoveredIntent||(void 0===e.n2_hoveredIntent?e.n2_hoveredIntent=i.n2_hoveredIntent:e.n2_hoveredIntent=null)),i.n2_intent&&(null===e.n2_intent||(void 0===e.n2_intent?e.n2_intent=i.n2_intent:e.n2_intent=null)))}},_intentChangedContexts:function(e){for(var t={},i=0,n=e.length;i<n;++i)for(var r=e[i],o=0,s=r.fragments.length;o<s;++o){var a=r.fragments[o];if(a.elements)for(var l in a.elements){var c=a.elements[l];t[l]=c}}var d=[];for(var l in t){c=t[l];this._adjustElementIntent(c),d.push(c)}d.length&&this.intentChanged(d)},_docsFromElement:function(e){var t=e;"string"==typeof t&&(t=this.elementById[t]);var i={};if(t&&t.fragments)for(var n in t.fragments){var r=t.fragments[n].context,o=null;r&&(o=r.n2_doc);var s=null;o&&(s=o._id),s&&(i[s]=o)}return i}}),r=t.Class("GenericElementGenerator",n,{initialize:function(e){n.prototype.initialize.call(this,e)},_createFragmentsFromDoc:function(e){var i=[],n={isNode:!0,id:"node_"+e._id,n2_id:e._id,n2_doc:e,n2_geometry:"point"};i.push(n);var r={},o=[];t.couchUtils.extractLinks(e,o);for(var s=0,a=o.length;s<a;++s){var l=o[s];l.doc&&(r[l.doc]=!0)}for(var c in r){var d={isLink:!0,id:"link_"+e._id+"_"+c,n2_id:e._id,n2_doc:e,n2_geometry:"line"},u=e._id,h=c;d.sourceId=u,d.targetId=h,i.push(d)}return i},_updateElements:function(e,t){var i={},n={};for(var r in e){if((o=e[r]).isNode)(s=t[o.id])||(s={id:r,fragments:{}}),s.fragments[r]=o,s.n2_id=o.context.n2_id,s.n2_doc=o.context.n2_doc,s.n2_geometry="point",s.isLink=!1,s.isNode=o.isNode,i[s.id]=s,n[o.context.n2_id]=s}for(var r in e){var o;if((o=e[r]).isLink&&n[o.sourceId]&&n[o.targetId]){var s,a=r;(s=t[a])||(s={id:a,fragments:{}}),s.fragments[o.id]=o,s.n2_id=o.context.n2_id,s.n2_doc=o.context.n2_doc,s.n2_geometry="line",s.isLink=o.isLink,s.isNode=!1,s.source=n[o.sourceId],s.target=n[o.targetId],i[s.id]=s}}return i}}),o=t.Class("GroupLinks",r,{initialize:function(e){r.prototype.initialize.call(this,e)},_updateElements:function(e,t){var i={},n={},r={};for(var o in e){if((a=e[o]).isNode)(l=t[a.id])||(l={id:o,fragments:{}}),l.fragments[o]=a,l.n2_id=a.context.n2_id,l.n2_doc=a.context.n2_doc,l.n2_geometry="point",l.isLink=a.isLink,l.isNode=a.isNode,i[l.id]=l,n[a.context.n2_id]=l,r[a.context.n2_id]=a}var s={};for(var o in e){var a;if((a=e[o]).isLink&&n[a.sourceId]&&n[a.targetId]){var l,c=[a.sourceId,a.targetId].sort().join("|");(l=s[c])||(l=t[c]),l||(l={id:c,fragments:{},count:0}),i[c]=l,s[c]=l,l.fragments[a.id]=a,l.n2_id=a.context.n2_id,l.n2_doc=a.context.n2_doc,l.n2_geometry="line",l.isLink=a.isLink,l.isNode=a.isNode,l.count=l.count+1,l.source=n[a.sourceId],l.target=n[a.targetId];var d=r[a.sourceId];l.fragments[d.id]=d;d=r[a.targetId];l.fragments[d.id]=d}}return i}}),s={};t.canvasElementGenerator={CreateElementGenerator:function(e){var i=t.extend({type:null,options:null,config:null},e),n=i.type,a=i.options,l=i.config,c=null;return"default"===n&&l&&l.directory&&l.directory.dispatchService&&(c=new r({dispatchService:l.directory.dispatchService,options:a})),!c&&"GroupLinks"===n&&l&&l.directory&&l.directory.dispatchService&&(c=new o({dispatchService:l.directory.dispatchService,options:a})),!c&&s[n]&&l&&(c=(0,s[n])({type:n,options:a,config:l})),!c&&l&&l.directory&&l.directory.dispatchService&&(t.log("Type of ElementGenerator not recognized: "+n),c=new r({dispatchService:l.directory.dispatchService,options:a})),c},AddElementGeneratorFactory:function(e){var i=t.extend({type:null,factoryFn:null},e),n=i.type,r=i.factoryFn;"string"==typeof n&&"function"==typeof r?s[n]=r:t.log("Unable to register ElementGenerator factory: "+i.type)},ElementGenerator:n,GenericElementGenerator:r,GroupLinks:o}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.forceGraph",r=window.d3;if(r){var o=t.Class({showService:null,delay:null,initialize:function(i){var n=t.extend({showService:null,delay:null},i);if(this.showService=n.showService,this.delay=n.delay,!e.fn.qtip)throw"qTip2 library is not available"},installPopup:function(t,i){var n=this,r=e(t),o={content:{text:function(e,t){var r=null;return n._generateHtml(i,function(e){r&&t.set("content.text",e),r=e}),r||(r='<div class="olkit_wait"></div>'),r}}};this.delay&&(o.content.delay=this.delay),r.qtip(o)},_generateHtml:function(t,i){var n=e("<div>"),r=e('<span class="n2_popup">').appendTo(n);this.showService.displayBriefDescription(r,{},t),i(n.html())}}),s=t.Class({elemId:null,modelId:null,dispatchService:null,parameters:null,parametersByEventId:null,addresses:null,initialize:function(i){var r=t.extend({modelId:null,dispatchService:null,elemId:null,style:null},i),o=this;this.modelId=r.modelId,this.dispatchService=r.dispatchService,this.parameters=[],this.parametersByEventId={},this.addresses=[];var s=null;if(this.dispatchService){var a={type:"modelGetInfo",modelId:this.modelId,modelInfo:null};this.dispatchService.synchronousCall(n,a),s=a.modelInfo}var l=function(e,t,i){o._handle(e,t,i)};if(s&&s.parameters)for(var c in s.parameters){var d=s.parameters[c];if(this.parameters.push(d),d.setEvent&&(this.parametersByEventId[d.setEvent]=d),d.changeEvent){this.parametersByEventId[d.changeEvent]=d;var u=this.dispatchService.register(n,d.changeEvent,l);this.addresses.push(u)}d.getEvent&&(this.parametersByEventId[d.getEvent]=d)}if(this.parameters.length>0){this.elemId=t.getUniqueId();var h=e("<div>").attr("id",this.elemId).addClass("n2ForceGraph_settings").appendTo(e("#"+r.elemId));if(r.style)for(var p in r.style){var f=r.style[p];f&&h.css(p,f)}e("<div>").addClass("n2ForceGraph_settings_button").appendTo(h).click(function(){o._togglePanel()}),e("<div>").addClass("n2ForceGraph_settings_panel").appendTo(h),this._hidePanel(),this._refresh()}},_refresh:function(){var e=this._getElem().find(".n2ForceGraph_settings_panel");e.empty();for(var t=0,i=this.parameters.length;t<i;++t){var n=this.parameters[t];this._addParameter(e,n)}},_addParameter:function(r,o){var s=this,a=t.getUniqueId(),l=e("<div>").addClass("n2ForceGraph_settings_line").appendTo(r),c={type:o.getEvent,parameterId:o.id};this.dispatchService.synchronousCall(n,c);var d=c.value;if("boolean"===o.type){var u=e("<div>").addClass("n2ForceGraph_settings_line_input").appendTo(l),h=e("<input>").attr("type","checkbox").attr("id",a).appendTo(u).change(function(){var t=e("#"+a).is(":checked"),i={type:o.setEvent,parameterId:o.id,value:t};s.dispatchService.send(n,i)});d&&h.attr("checked","checked")}var p=i(o.label),f=e("<div>").addClass("n2ForceGraph_settings_line_label").appendTo(l);e("<label>").attr("for",a).text(p).appendTo(f)},_togglePanel:function(){this._getElem().find(".n2ForceGraph_settings_panel").hasClass("n2ForceGraph_settings_panel_on")?this._hidePanel():this._showPanel()},_showPanel:function(){var e=this._getElem().find(".n2ForceGraph_settings_panel");e.removeClass("n2ForceGraph_settings_panel_off"),e.addClass("n2ForceGraph_settings_panel_on")},_hidePanel:function(){var e=this._getElem().find(".n2ForceGraph_settings_panel");e.removeClass("n2ForceGraph_settings_panel_on"),e.addClass("n2ForceGraph_settings_panel_off")},_getElem:function(){return e("#"+this.elemId)},_handle:function(e,t,i){if(this._getElem().length<1){for(var n=0,r=this.addresses.length;n<r;++n){var o=this.addresses[n];i.deregister(o)}this.addresses=[]}else this._refresh()}}),a=t.Class({model:null,modelId:null,parameterId:null,name:null,label:null,updateFn:null,dispatchService:null,eventNameSet:null,eventNameGet:null,eventNameChange:null,initialize:function(e){var i=t.extend({model:null,modelId:null,name:null,label:null,updateFn:null,dispatchService:null},e),r=this;if(this.model=i.model,this.modelId=i.modelId,this.name=i.name,this.label=i.label,this.updateFn=i.updateFn,this.dispatchService=i.dispatchService,this.modelId||(this.modelId=t.getUniqueId("parameter_")),this.label||(this.label=this.name),this.parameterId=this.modelId+"_"+this.name,this.eventNameSet=this.parameterId+"_set",this.eventNameGet=this.parameterId+"_get",this.eventNameChange=this.parameterId+"_change",this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(n,this.eventNameSet,o),this.dispatchService.register(n,this.eventNameGet,o)}},getInfo:function(){var e={parameterId:this.parameterId,type:"boolean",name:this.name,label:this.label,setEvent:this.eventNameSet,getEvent:this.eventNameGet,changeEvent:this.eventNameChange},t=this.model[this.name];return e.value=t,e},_handle:function(e,t,i){if(e.type===this.eventNameSet){var r=e.value;this.model[this.name]=r,this.updateFn&&this.updateFn.call(this.model,this.name,r);var o=this.model[this.name],s={type:this.eventNameChange,parameterId:this.parameterId,value:o};this.dispatchService.send(n,s)}else if(e.type===this.eventNameGet){o=this.model[this.name];e.value=o}}}),l=t.Class({canvasId:null,interactionId:null,svgId:null,modelId:null,dispatchService:null,showService:null,sourceModelId:null,svgRenderer:null,background:null,forceOptions:null,forceLayout:null,styleRules:null,popup:null,nodesById:null,linksById:null,elementsByDocId:null,elementGenerator:null,currentMouseOver:null,lastElementIdSelected:null,sticky:null,initialize:function(e){var l=t.extend({canvasId:null,interactionId:null,config:null,moduleDisplay:null,sourceModelId:null,background:null,force:{},popup:null,styleRules:null,toggleSelection:!0,elementGeneratorType:"default",elementGeneratorOptions:null,elementGenerator:null,onSuccess:function(){},onError:function(e){}},e),c=this;this.canvasId=l.canvasId,this.interactionId=l.interactionId,this.sourceModelId=l.sourceModelId,this.background=l.background,this.toggleSelection=l.toggleSelection,this.elementGenerator=l.elementGenerator,this.modelId=t.getUniqueId("forceGraph"),this.forceOptions=t.extend({gravity:.1,friction:.9,theta:.8,charge:-30,chargeDistance:null,linkDistance:30,linkStrength:1},l.force),this.styleRules=t.styleRule.loadRulesFromObject(l.styleRules);var d=l.config;d&&d.directory&&(this.dispatchService=d.directory.dispatchService,this.showService=d.directory.showService);try{if(l.popup&&this.showService){var u=t.extend({delay:null},l.popup,{showService:this.showService});this.popup=new o(u)}}catch(e){t.log("ForceGraph can not install popup: "+e)}if(this.sticky=!1,this.stickyParameter=new a({model:this,modelId:this.modelId,name:"sticky",label:i("Sticky Nodes"),updateFn:this._updateParameter,dispatchService:this.dispatchService}),this.nodesById={},this.linksById={},this.elementsByDocId={},this.currentMouseOver=null,this.lastElementIdSelected=null,this.elementGenerator||(this.elementGenerator=t.canvasElementGenerator.CreateElementGenerator({type:l.elementGeneratorType,options:l.elementGeneratorOptions,config:l.config})),this.elementGenerator&&(this.elementGenerator.setElementsChangedListener(function(e,t,i){c._elementsChanged(e,t,i)}),this.elementGenerator.setIntentChangedListener(function(e){c._intentChanged(e)})),this.dispatchService){var h=function(e){c._handleDispatch(e)};this.dispatchService.register(n,"modelGetInfo",h),this.dispatchService.register(n,"modelStateUpdated",h),this.dispatchService.register(n,"windowResized",h),this.dispatchService.register(n,"findIsAvailable",h)}if(this.forceLayout=r.layout.force().gravity(this.forceOptions.gravity).friction(this.forceOptions.friction).theta(this.forceOptions.theta).charge(this.forceOptions.charge).linkDistance(this.forceOptions.linkDistance).linkStrength(this.forceOptions.linkStrength),this.forceOptions.chargeDistance&&this.forceLayout.chargeDistance(this.forceOptions.chargeDistance),this.forceLayout.drag().on("dragstart",function(e){c.sticky&&(e.fixed=!0)}),this.createGraph(),l.onSuccess(),this.sourceModelId&&this.dispatchService){var p={type:"modelGetState",modelId:this.sourceModelId,state:null};this.dispatchService.synchronousCall(n,p),p.state&&this._dbPerspectiveUpdated(p.state)}var f=new s({modelId:this.modelId,dispatchService:this.dispatchService,elemId:this.canvasId,style:null});t.log("forceGraph",this),t.log("settingWidget",f)},createGraph:function(){var e=this;this.svgId=t.getUniqueId();var i=r.select("#"+this.canvasId).append("svg").attr("id",this.svgId).classed({n2CanvasForceGraph:!0}),o=i.append("rect").attr({x:"0",y:"0"}).classed({n2CanvasForceGraph_background:!0}).on("click",function(){e._backgroundClicked()});if(this.background&&"object"==typeof this.background){var s=t.svg.presentationAttributeMap;for(var a in this.background)if("string"==typeof a&&s[a]){var l=this.background[a];"string"==typeof l?o.attr(a,l):"number"==typeof l&&o.attr(a,l)}}else o.attr({"stroke-opacity":0,"fill-opacity":0});i.append("g").attr("class","links"),i.append("g").attr("class","nodes"),i.append("g").attr("class","labels"),this.svgRenderer=new t.svg.Renderer({svgElem:i[0][0]}),this.resizeGraph(),this.dispatchService&&this.dispatchService.send(n,{type:"canvasForceGraphReportCanvas",svg:i})},getGraphSize:function(){var t=e("#"+this.canvasId);return[t.width(),t.height()]},resizeGraph:function(){var e=this.getGraphSize();this.forceLayout.size([e[0],e[1]]).start();this._getSvgElem().attr({width:e[0],height:e[1]}).select(".n2CanvasForceGraph_background").attr({width:e[0],height:e[1]})},_getSvgElem:function(){return r.select("#"+this.svgId)},_elementsChanged:function(e,t,i){for(var r=0,o=i.length;r<o;++r){var s=i[r];s.isNode?delete this.nodesById[s.id]:s.isLink&&delete this.linksById[s.id]}for(r=0,o=e.length;r<o;++r){var a=e[r];a.isNode?this.nodesById[a.id]=a:a.isLink&&(this.linksById[a.id]=a)}var l=[],c=[];for(r=0,o=t.length;r<o;++r){var d=t[r];d.isNode?l.push(d):d.isLink&&c.push(d)}for(var u in this.elementsByDocId={},this.nodesById){if((f=this.nodesById[u]).fragments)for(var h in f.fragments){if(m=f.fragments[h].context)if(v=m.n2_doc){var p=v._id;(g=this.elementsByDocId[p])||(g=[],this.elementsByDocId[p]=g),g.push(f)}}}for(var u in this.linksById){var f;if((f=this.linksById[u]).fragments)for(var h in f.fragments){var m,v;if(m=f.fragments[h].context)if(v=m.n2_doc){var g;p=v._id;(g=this.elementsByDocId[p])||(g=[],this.elementsByDocId[p]=g),g.push(f)}}}this._documentsUpdated(l,c),this.dispatchService.send(n,{type:"findAvailabilityChanged"})},_intentChanged:function(e){for(var t=[],i=[],n=!1,r=0,o=e.length;r<o;++r){var s=e[r];s.isNode?(t.push(s),s.n2_found&&!s.forceFound?(n=!0,s.forceFound=!0):!s.n2_found&&s.forceFound&&(s.forceFound=!1)):s.isLink&&i.push(s)}var a=this._getSvgElem().select("g.nodes").selectAll(".node").data(t,function(e){return e.id});this._adjustElementStyles(a);var l=this._getSvgElem().select("g.links").selectAll(".link").data(i,function(e){return e.id});this._adjustElementStyles(l,!0);var c=this._getSvgElem().select("g.labels").selectAll(".label").data(t,function(e){return e.id});this._adjustElementStyles(c),n&&this.forceLayout.start()},_documentsUpdated:function(t,i){var n=this,r=[];for(var o in this.nodesById){var s=this.nodesById[o];r.push(s)}var a=[];for(var o in this.linksById){var l=this.linksById[o];a.push(l)}this.forceLayout.nodes(r).links(a).start();var c=this._getSvgElem().select("g.nodes").selectAll(".node").data(r,function(e){return e.id}),d=c.enter().append(function(){return this.ownerDocument.createElementNS(this.namespaceURI,"circle")}).attr("class","node").on("click",function(e,t){n._initiateMouseClick(e)}).on("mouseover",function(e,t){n._initiateMouseOver(e)}).on("mouseout",function(e,t){n._initiateMouseOut(e)}).call(this.forceLayout.drag).each(function(e,t){n.popup&&e.n2_doc&&n.popup.installPopup(this,e.n2_doc)});this._adjustElementStyles(d),c.exit().remove();var u=this._getSvgElem().select("g.nodes").selectAll(".node").data(t,function(e){return e.id});this._adjustElementStyles(u);var h=this._getSvgElem().select("g.links").selectAll(".link").data(a,function(e){return e.id}),p=h.enter().append("path").attr("class","link").on("click",function(e,t){n._initiateMouseClick(e)}).on("mouseover",function(e,t){n._initiateMouseOver(e)}).on("mouseout",function(e,t){n._initiateMouseOut(e)});this._adjustElementStyles(p,!0),h.exit().remove();var f=this._getSvgElem().select("g.links").selectAll(".link").data(i,function(e){return e.id});this._adjustElementStyles(f,!0);var m=this._getSvgElem().select("g.labels").selectAll(".label").data(r,function(e){return e.id}),v=m.enter().append(function(){return this.ownerDocument.createElementNS(this.namespaceURI,"text")}).attr("class","label").on("click",function(e,t){n._initiateMouseClick(e)}).on("mouseover",function(e,t){n._initiateMouseOver(e)}).on("mouseout",function(e,t){n._initiateMouseOut(e)}).call(this.forceLayout.drag).each(function(e,t){n.popup&&e.n2_doc&&n.popup.installPopup(this,e.n2_doc)});this._adjustElementStyles(v),m.exit().remove();var g=this._getSvgElem().select("g.labels").selectAll(".label").data(t,function(e){return e.id});this._adjustElementStyles(g),this.forceLayout.on("tick",function(t){var i=e("#"+n.canvasId).width(),r=e("#"+n.canvasId).height(),o=i/2,s=r/2;c.each(function(e,t){if(e.n2_found){if(e.x>o){var i=(e.x-o)/2;e.x-=i}else{i=(o-e.x)/2;e.x+=i}if(e.y>s){i=(e.y-s)/2;e.y-=i}else{i=(s-e.y)/2;e.y+=i}}}),c.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),h.attr("d",function(e){return"function"==typeof e.pathFn?e.pathFn(e,e.source,e.target):["M",e.source.x," ",e.source.y," L ",e.target.x," ",e.target.y].join("")}),m.attr("x",function(e){return e.x}).attr("y",function(e){return e.y})})},_adjustElementStyles:function(e,t){var i=this;e.each(function(e,t){e.n2_elem=this,i.styleRules.getSymbolizer(e).adjustSvgElement(this,e),delete e.n2_elem}),t&&e.attr("fill","none")},_dispatch:function(e){var t=this.dispatchService;t&&t.send(n,e)},_dbPerspectiveUpdated:function(e){this.elementGenerator.sourceModelUpdated(e)},_initiateMouseClick:function(e){var t=e.id;this.toggleSelection&&this.lastElementIdSelected===t?(this.elementGenerator.selectOff(e),this.lastElementIdSelected=null):(this.elementGenerator.selectOn(e),this.lastElementIdSelected=t)},_initiateMouseOver:function(e){var t=e.id;t!==this.currentMouseOver&&(this.currentMouseOver&&(this.elementGenerator.focusOff(this.currentMouseOver),this.currentMouseOver=null),this.elementGenerator.focusOn(e),this.currentMouseOver=t)},_initiateMouseOut:function(e){e.id===this.currentMouseOver&&(this.elementGenerator.focusOff(e),this.currentMouseOver=null)},_backgroundClicked:function(){this._dispatch({type:"userUnselect"})},_handleDispatch:function(e){if("modelGetInfo"===e.type)e.modelId===this.modelId&&(e.modelInfo=this._getModelInfo());else if("modelStateUpdated"===e.type)this.sourceModelId===e.modelId&&e.state&&this._dbPerspectiveUpdated(e.state);else if("windowResized"===e.type)this.resizeGraph();else if("findIsAvailable"===e.type){var t=e.docId;t&&this.elementsByDocId[t]&&this.elementsByDocId[t].length&&(e.isAvailable=!0)}},_getModelInfo:function(){var e={modelId:this.modelId,modelType:"obi_force_graph",parameters:[]};return e.parameters.push(this.stickyParameter.getInfo()),e},_updateParameter:function(e,t){if("sticky"===e&&!t){var i=!1;for(var n in this.nodesById){var r=this.nodesById[n];r.fixed&&(r.fixed=!1,i=!0)}i&&this.forceLayout.start()}}});t.canvasForceGraph={ForceGraph:l,HandleCanvasAvailableRequest:function(e){"forceGraph"===e.canvasType&&(e.isAvailable=!0)},HandleCanvasDisplayRequest:function(e){if("forceGraph"===e.canvasType){var t={};if(e.canvasOptions)for(var i in e.canvasOptions)t[i]=e.canvasOptions[i];t.canvasId=e.canvasId,t.interactionId=e.interactionId,t.config=e.config,t.moduleDisplay=e.moduleDisplay,t.onSuccess=e.onSuccess,t.onError=e.onError,new l(t)}}}}}(jQuery,nunaliit2),function(e,t){var i="n2.radialCanvas",n=window.d3;if(n){var r=t.Class({canvasId:null,interactionId:null,svgId:null,modelId:null,dispatchService:null,sourceModelId:null,moduleDisplay:null,background:null,toggleSelection:null,line:null,magnify:null,magnifyThresholdCount:null,styleRules:null,nodesById:null,sortedNodes:null,linksById:null,elementGenerator:null,currentMouseOver:null,lastElementIdSelected:null,initialize:function(e){var n=t.extend({canvasId:null,interactionId:null,config:null,moduleDisplay:null,sourceModelId:null,background:null,magnify:null,styleRules:null,toggleSelection:!0,elementGeneratorType:"default",elementGeneratorOptions:null,elementGenerator:null,onSuccess:function(){},onError:function(e){}},e),r=this;this.canvasId=n.canvasId,this.interactionId=n.interactionId,this.moduleDisplay=n.moduleDisplay,this.sourceModelId=n.sourceModelId,this.background=n.background,this.toggleSelection=n.toggleSelection,this.elementGenerator=n.elementGenerator,this.modelId=t.getUniqueId("radialCanvas"),this.styleRules=t.styleRule.loadRulesFromObject(n.styleRules);var o=n.config;if(o&&o.directory&&(this.dispatchService=o.directory.dispatchService),this.nodesById={},this.sortedNodes=[],this.linksById={},this.currentMouseOver=null,this.lastElementIdSelected=null,this.focusInfo=null,this.selectInfo=null,this.magnifyThresholdCount=null,this.elementGenerator||(this.elementGenerator=t.canvasElementGenerator.CreateElementGenerator({type:n.elementGeneratorType,options:n.elementGeneratorOptions,config:n.config})),this.elementGenerator&&(this.elementGenerator.setElementsChangedListener(function(e,t,i){r._elementsChanged(e,t,i)}),this.elementGenerator.setIntentChangedListener(function(e){r._intentChanged(e)})),this.dispatchService){var s=function(e){r._handleDispatch(e)};this.dispatchService.register(i,"modelGetInfo",s),this.dispatchService.register(i,"modelStateUpdated",s)}this.line=d3.svg.line.radial().interpolate("basis").tension(.85).radius(function(e){return e.y}).angle(function(e){return e.x/180*Math.PI});var a=t.extend({radius:10,distortion:2,thresholdCount:120},n.magnify);for(var l in this.magnify=function(){var e,t,i=10,n=2,r=null,o="x";function s(n){var s=n[o];if(null===r)return{x:s,z:1};var a=s-r;a>180&&(a-=360),a<-180&&(a+=360);var l=Math.sqrt(a*a);if(!l||l>=i)return{x:s,z:1};var c=e*(1-Math.exp(-l*t))/l*.75+.25,d=r+a*c;return d<0&&(d+=360),d>360&&(d-=360),{x:d,z:Math.min(c,10)}}function a(){return e=(e=Math.exp(n))/(e-1)*i,t=n/i,s}return s.radius=function(e){return arguments.length?(i=+e,a()):i},s.distortion=function(e){return arguments.length?(n=+e,a()):n},s.angle=function(e){return arguments.length?(r=e,s):r},s.angleAttribute=function(e){return arguments.length?(o=e,s):o},a(),s}().angleAttribute("orig_x"),a){var c=a[l];"radius"===l&&"number"==typeof c&&this.magnify.radius(c),"distortion"===l&&"number"==typeof c&&this.magnify.distortion(c),"thresholdCount"===l&&"number"==typeof c&&(this.magnifyThresholdCount=c)}if(this.createGraph(),n.onSuccess(),this.sourceModelId&&this.dispatchService){var d={type:"modelGetState",modelId:this.sourceModelId,state:null};this.dispatchService.synchronousCall(i,d),d.state&&this._sourceModelUpdated(d.state)}t.log("RadialCanvas",this)},createGraph:function(){this.background&&"string"==typeof this.background.color&&e("#"+this.canvasId).css("background-color",this.background.color);this.svgId=t.getUniqueId();var i=n.select("#"+this.canvasId).append("svg").attr("id",this.svgId).append("g").attr("class","radialRoot");i.append("g").attr("class","links"),i.append("g").attr("class","nodes"),i.append("g").attr("class","labels"),this.resizeGraph()},getGraphSize:function(){var t=e("#"+this.canvasId);return[t.width(),t.height()]},resizeGraph:function(){var e=this.getGraphSize(),t=(this._getSvgElem().attr("width",e[0]).attr("height",e[1]).select("g.radialRoot").attr("transform","translate("+e[0]/2+","+e[1]/2+")"),e[0]);t>e[1]&&(t=e[1]),this.canvasWidth=t,this.radius=Math.floor(t/2-120),this._documentsUpdated([],[])},_getSvgElem:function(){return n.select("#"+this.svgId)},_elementsChanged:function(e,t,i){for(var n=0,r=i.length;n<r;++n){var o=i[n];o.isNode?delete this.nodesById[o.id]:o.isLink&&delete this.linksById[o.id]}for(n=0,r=e.length;n<r;++n){var s=e[n];s.isNode?(s.n2_geometry="point",this.nodesById[s.id]=s):s.isLink&&(s.n2_geometry="line",this.linksById[s.id]=s)}var a=[],l=[];for(n=0,r=t.length;n<r;++n){var c=t[n];c.isNode?(c.n2_geometry="point",a.push(c)):c.isLink&&(c.n2_geometry="line",l.push(c))}this._documentsUpdated(a,l)},_intentChanged:function(e){for(var t=[],i=[],n=0,r=e.length;n<r;++n){var o=e[n];o.isNode?(t.push(o),o.n2_found&&!o.forceFound?o.forceFound=!0:!o.n2_found&&o.forceFound&&(o.forceFound=!1)):o.isLink&&i.push(o)}var s=this._getSvgElem().select("g.nodes").selectAll(".node").data(t,function(e){return e.id});this._adjustElementStyles(s);var a=this._getSvgElem().select("g.labels").selectAll(".label").data(t,function(e){return e.id});this._adjustElementStyles(a);var l=this._getSvgElem().select("g.links").selectAll(".link").data(i,function(e){return e.id});for(var c in this._adjustElementStyles(l),i=[],this.linksById){var d=this.linksById[c];i.push(d)}this._getSvgElem().select("g.links").selectAll(".link").data(i,function(e){return e.id}).filter(function(e){return e.n2_selected}).each(function(e){this.parentNode.appendChild(this)}),this._getSvgElem().select("g.links").selectAll(".link").data(i,function(e){return e.id}).filter(function(e){return e.n2_hovered}).each(function(e){this.parentNode.appendChild(this)})},_documentsUpdated:function(e,t){var i=this;for(var n in this.sortedNodes=[],this.nodesById){var r=this.nodesById[n];this.sortedNodes.push(r)}if(this.sortedNodes.sort(function(e,t){return d3.ascending(e.sortValue,t.sortValue)}),this.sortedNodes.length>0)for(var o=360/this.sortedNodes.length,s=0,a=0,l=this.sortedNodes.length;a<l;++a){(r=this.sortedNodes[a]).orig_x=s,r.y=this.radius;var c=this.magnify(r);r.x=c.x,r.z=c.z,s+=o}var d=[];for(var n in this.linksById){var u=this.linksById[n];d.push(u)}var h=this._getSvgElem().select("g.nodes").selectAll(".node").data(this.sortedNodes,function(e){return e.id}),p=this._getSvgElem().select("g.labels").selectAll(".label").data(this.sortedNodes,function(e){return e.id});h.transition().attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+e.y+",0)"}),p.transition().attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+(e.y+8)+",0)"+(e.x<180?"":"rotate(180)")}).style("text-anchor",function(e){return e.x<180?"start":"end"});var f=h.enter().append("circle").attr("class","node").attr("r",3).attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+e.y+",0)"}).on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e),i._magnifyElement(e)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});this._adjustElementStyles(f);var m=p.enter().append(function(){return this.ownerDocument.createElementNS(this.namespaceURI,"text")}).attr("class","label").attr("dy",".31em").attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+(e.y+8)+",0)"+(e.x<180?"":"rotate(180)")}).style("text-anchor",function(e){return e.x<180?"start":"end"}).text(function(e){return""}).on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e),i._magnifyElement(e)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});this._adjustElementStyles(m),h.exit().remove(),p.exit().remove();var v=this._getSvgElem().select("g.nodes").selectAll(".node").data(e,function(e){return e.id});this._adjustElementStyles(v);var g=this._getSvgElem().select("g.labels").selectAll(".label").data(e,function(e){return e.id});this._adjustElementStyles(g);var y=this._getSvgElem().select("g.links").selectAll(".link").data(d,function(e){return e.id});y.transition().attr("d",function(e){return i.line([e.source,{x:0,y:0},e.target])});var _=y.enter().append("path").attr("class","link").attr("d",function(e){return i.line([e.source,{x:0,y:0},e.target])}).on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});this._adjustElementStyles(_),y.exit().remove();var S=this._getSvgElem().select("g.links").selectAll(".link").data(t,function(e){return e.linkId});this._adjustElementStyles(S)},_adjustElementStyles:function(e){var t=this;e.each(function(e,i){e.n2_elem=this,t.styleRules.getSymbolizer(e).adjustSvgElement(this,e),delete e.n2_elem})},_dispatch:function(e){var t=this.dispatchService;t&&t.send(i,e)},_sourceModelUpdated:function(e){this.elementGenerator.sourceModelUpdated(e)},_magnifyElement:function(e){var t=this,i=e.orig_x;this.magnify.angle(i);var n=!1;"number"==typeof this.magnifyThresholdCount&&this.magnifyThresholdCount<=this.sortedNodes.length&&(n=!0);for(var r=[],o=0,s=this.sortedNodes.length;o<s;++o){var a=this.sortedNodes[o];if(a.transitionNeeded=!1,n){var l=this.magnify(a);l.z===a.z||(a.z=l.z,a.x=l.x,a.transitionNeeded=!0,r.push(a))}else 1!==a.z&&(a.z=1,a.x=a.orig_x,a.transitionNeeded=!0,r.push(a))}this._getSvgElem().select("g.nodes").selectAll(".node").data(r,function(e){return e.id}).transition().attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+e.y+",0)"}),this._getSvgElem().select("g.labels").selectAll(".label").data(r,function(e){return e.id}).transition().attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+(e.y+8)+",0)"+(e.x<180?"":"rotate(180)")}).style("text-anchor",function(e){return e.x<180?"start":"end"});var c=[];for(var d in this.linksById){var u=this.linksById[d];c.push(u)}this._getSvgElem().select("g.links").selectAll(".link").data(c,function(e){return e.id}).filter(function(e){return!!e.source.transitionNeeded||!!e.target.transitionNeeded}).transition().attr("d",function(e){return t.line([e.source,{x:0,y:0},e.target])})},_initiateMouseClick:function(e){var t=e.id;this.toggleSelection&&this.lastElementIdSelected===t?(this.elementGenerator.selectOff(e),this.lastElementIdSelected=null):(this.elementGenerator.selectOn(e),this.lastElementIdSelected=t)},_initiateMouseOver:function(e){var t=e.id;t!==this.currentMouseOver&&(this.currentMouseOver&&(this.elementGenerator.focusOff(this.currentMouseOver),this.currentMouseOver=null),this.elementGenerator.focusOn(e),this.currentMouseOver=t)},_initiateMouseOut:function(e){e.id===this.currentMouseOver&&(this.elementGenerator.focusOff(e),this.currentMouseOver=null)},_handleDispatch:function(e){"modelGetInfo"===e.type?e.modelId===this.modelId&&(e.modelInfo=this._getModelInfo()):"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&e.state&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){return{modelId:this.modelId,modelType:"radialCanvas",parameters:[]}}});t.canvasRadial={RadialCanvas:r,HandleCanvasAvailableRequest:function(e){"radial"===e.canvasType&&(e.isAvailable=!0)},HandleCanvasDisplayRequest:function(e){if("radial"===e.canvasType){var t={};if(e.canvasOptions)for(var i in e.canvasOptions)t[i]=e.canvasOptions[i];t.canvasId=e.canvasId,t.interactionId=e.interactionId,t.config=e.config,t.moduleDisplay=e.moduleDisplay,t.onSuccess=e.onSuccess,t.onError=e.onError,new r(t)}}}}}(jQuery,nunaliit2),function(e,t){var i="n2.radialTreeCanvas",n=void 0;var r=t.Class({canvasId:null,interactionId:null,svgId:null,modelId:null,dispatchService:null,sourceModelId:null,moduleDisplay:null,background:null,toggleSelection:null,styleRules:null,nodesById:null,sortedNodes:null,links:null,elementGenerator:null,elementsById:null,findableDocsById:null,dimensions:null,layout:null,line:null,bundle:null,magnify:null,magnifyThresholdCount:null,currentMouseOver:null,lastElementIdSelected:null,initialize:function(e){var n=t.extend({canvasId:null,interactionId:null,config:null,moduleDisplay:null,sourceModelId:null,background:null,line:null,magnify:null,styleRules:null,toggleSelection:!0,elementGeneratorType:"default",elementGeneratorOptions:null,elementGenerator:null,onSuccess:function(){},onError:function(e){}},e),r=this;this.canvasId=n.canvasId,this.interactionId=n.interactionId,this.moduleDisplay=n.moduleDisplay,this.sourceModelId=n.sourceModelId,this.background=n.background,this.toggleSelection=n.toggleSelection,this.elementGenerator=n.elementGenerator,this.modelId=t.getUniqueId("radialTreeCanvas"),this.styleRules=t.styleRule.loadRulesFromObject(n.styleRules);var o=n.config;if(o&&o.directory&&(this.dispatchService=o.directory.dispatchService),this.nodesById={},this.sortedNodes=[],this.links=[],this.currentMouseOver=null,this.elementsById={},this.findableDocsById={},this.dimensions={},this.lastElementIdSelected=null,this.focusInfo=null,this.selectInfo=null,this.magnifyThresholdCount=null,this.elementGenerator||(this.elementGenerator=t.canvasElementGenerator.CreateElementGenerator({type:n.elementGeneratorType,options:n.elementGeneratorOptions,config:n.config})),this.elementGenerator&&(this.elementGenerator.setElementsChangedListener(function(e,t,i){r._elementsChanged(e,t,i)}),this.elementGenerator.setIntentChangedListener(function(e){r._intentChanged(e)})),this.dispatchService){var s=function(e){r._handleDispatch(e)};this.dispatchService.register(i,"modelGetInfo",s),this.dispatchService.register(i,"modelStateUpdated",s),this.dispatchService.register(i,"windowResized",s),this.dispatchService.register(i,"findIsAvailable",s)}this.createGraph(),this.layout=d3.layout.cluster().size([360,this.dimensions.radius]).sort(function(e,t){return d3.ascending(e.sortValue,t.sortValue)}).value(function(e){return e.size});var a=t.extend({interpolate:"bundle",tension:.85},n.line);for(var l in this.line=d3.svg.line.radial().interpolate("bundle").tension(.85).radius(function(e){return e.y}).angle(function(e){return e.x/180*Math.PI}),a){var c=a[l];"interpolate"===l&&"string"==typeof c&&this.line.interpolate(c),"tension"===l&&"number"==typeof c&&this.line.tension(c)}this.bundle=d3.layout.bundle();var d=t.extend({radius:10,distortion:2,thresholdCount:100},n.magnify);for(var l in this.magnify=function(){var e,t,i=10,n=2,r=null,o="x";function s(n){var s=n[o];if(null===r)return{x:s,z:1};var a=s-r;a>180&&(a-=360),a<-180&&(a+=360);var l=Math.sqrt(a*a);if(l>=i)return{x:s,z:1};if(!l)return{x:s,z:10};var c=e*(1-Math.exp(-l*t))/l*.75+.25,d=r+a*c;return d<0&&(d+=360),d>360&&(d-=360),{x:d,z:Math.min(c,10)}}function a(){return e=(e=Math.exp(n))/(e-1)*i,t=n/i,s}return s.radius=function(e){return arguments.length?(i=+e,a()):i},s.distortion=function(e){return arguments.length?(n=+e,a()):n},s.angle=function(e){return arguments.length?(r=e,s):r},s.angleAttribute=function(e){return arguments.length?(o=e,s):o},a(),s}().radius(10).distortion(2).angleAttribute("orig_x"),d){c=d[l];"radius"===l&&"number"==typeof c&&this.magnify.radius(c),"distortion"===l&&"number"==typeof c&&this.magnify.distortion(c),"thresholdCount"===l&&"number"==typeof c&&(this.magnifyThresholdCount=c)}if(n.onSuccess(),this.sourceModelId&&this.dispatchService){var u={type:"modelGetState",modelId:this.sourceModelId,state:null};this.dispatchService.synchronousCall(i,u),u.state&&this._sourceModelUpdated(u.state)}t.log("RadialTreeCanvas",this)},createGraph:function(){var i=this;this.background&&"string"==typeof this.background.color&&e("#"+this.canvasId).css("background-color",this.background.color);this.svgId=t.getUniqueId();var r=n.select("#"+this.canvasId).append("svg").attr("id",this.svgId);r.append("rect").attr("class","radialBackground").attr("x",0).attr("y",0).attr("stroke","none").attr("fill","#000000").attr("fill-opacity",0).on("click",function(){i._initiateBackgroundMouseClick()}).on("mousemove",function(){i._magnifyOut()});var o=r.append("g").attr("class","radialScale").append("g").attr("class","radialRoot");o.append("circle").attr("class","magnifyEvents").attr("stroke","#000000").attr("stroke-opacity",0).attr("fill","none").on("mouseover",function(){var e=n.event;i._magnifyLocation(e)}).on("mousemove",function(){var e=n.event;i._magnifyLocation(e)}),o.append("g").attr("class","links"),o.append("g").attr("class","nodes"),o.append("g").attr("class","labels"),this.resizeGraph()},getGraphSize:function(){var t=e("#"+this.canvasId);return[t.width(),t.height()]},resizeGraph:function(){var e=this.getGraphSize(),t=e[0];t>e[1]&&(t=e[1]);this.dimensions={width:e[0],height:e[1],cx:Math.floor(e[0]/2),cy:Math.floor(e[1]/2),canvasWidth:t,radius:Math.floor(300),textWidth:100};var i=this._getSvgElem().attr("width",e[0]).attr("height",e[1]);i.select("g.radialScale").attr("transform","translate("+this.dimensions.cx+","+this.dimensions.cy+") scale("+t/800+")"),i.select("rect.radialBackground").attr("width",e[0]).attr("height",e[1]),i.select("g.radialRoot").select("circle.magnifyEvents").attr("r",this.dimensions.radius+Math.floor(this.dimensions.textWidth/2)+5).attr("stroke-width",this.dimensions.textWidth+10)},_getSvgElem:function(){return n.select("#"+this.svgId)},_elementsChanged:function(e,i,n){for(var r in this.elementsById){delete(y=this.elementsById[r]).parent,delete y.children,delete y.depth,delete y.x,delete y.y,delete y.z,delete y.orig_x}for(var o=0,s=n.length;o<s;++o){var a=n[o];delete this.elementsById[a.id]}for(o=0,s=e.length;o<s;++o){var l=e[o];this.elementsById[l.id]=l}for(o=0,s=i.length;o<s;++o){var c=i[o];this.elementsById[c.id]=c}for(var d in this.findableDocsById={},this.elementsById){var u=this.elementsById[d];if(u.fragments)for(var h in u.fragments){var p=u.fragments[h].context;if(p){var f=p.n2_doc;if(f){var m=f._id;this.findableDocsById[m]=f}}}}var v={id:"__root__",name:"",children:[]};for(var r in this.elementsById){if((y=this.elementsById[r]).parentId){var g=this.elementsById[y.parentId];g&&(y.parent=g,g.children||(g.children=[]),g.children.push(y))}else null===y.parentId&&(y.parent=v,v.children.push(y))}for(var r in this.layout.nodes(v),this.sortedNodes=[],this.links=[],this.elementsById){var y;(y=this.elementsById[r]).isLink&&(y.n2_geometry="line",S(y.source)&&S(y.target)?this.links.push(y):t.log("link not in tree",y)),y.isNode&&(y.n2_geometry="point",y.orig_x=y.x,delete y.x,S(y)?this.sortedNodes.push(y):t.log("node not in tree.",y))}this.sortedNodes.sort(function(e,t){return e.orig_x<t.orig_x?-1:e.orig_x>t.orig_x?1:0});var _=this.bundle(this.links);for(o=0,s=this.links.length;o<s;++o)this.links[o].path=_[o];function S(e){return!!e&&(e===v||S(e.parent))}this._documentsUpdated(this.sortedNodes,this.links)},_intentChanged:function(e){for(var t in this.elementsById){(a=this.elementsById[t]).temp_hovered=!1,a.temp_selected=!1}for(var i={},n={},r=0,o=e.length;r<o;++r){var s=e[r];s.isNode?i[s.id]=s:s.isLink&&(n[s.id]=s)}for(var t in this.elementsById){(a=this.elementsById[t]).isLink&&(a.n2_selected&&(a.source.temp_selected=!0,a.target.temp_selected=!0),a.n2_hovered&&(a.source.temp_hovered=!0,a.target.temp_hovered=!0),a.source.n2_selected&&(a.temp_selected=!0,a.target.temp_selected=!0),a.target.n2_selected&&(a.temp_selected=!0,a.source.temp_selected=!0),a.source.n2_hovered&&(a.temp_hovered=!0,a.target.temp_hovered=!0),a.target.n2_hovered&&(a.temp_hovered=!0,a.source.temp_hovered=!0))}for(var t in this.elementsById){var a;(a=this.elementsById[t]).n2_derived_selected!==a.temp_selected&&(a.n2_derived_selected=a.temp_selected,a.isLink?n[a.id]=a:a.isNode&&(i[a.id]=a)),a.n2_derived_hovered!==a.temp_hovered&&(a.n2_derived_hovered=a.temp_hovered,a.isLink?n[a.id]=a:a.isNode&&(i[a.id]=a))}var l=[];for(var c in i)l.push(i[c]);var d=[];for(var u in n)d.push(n[u]);var h=this._getSvgElem().select("g.nodes").selectAll(".node").data(l,function(e){return e.id});this._adjustElementStyles(h);var p=this._getSvgElem().select("g.labels").selectAll(".label").data(l,function(e){return e.id});this._adjustElementStyles(p);var f=this._getSvgElem().select("g.links").selectAll(".link").data(d,function(e){return e.id});this._adjustElementStyles(f,!0),this._reOrderLinks()},_reOrderLinks:function(){var e=[];for(var t in this.elementsById){var i=this.elementsById[t];i.isLink&&e.push(i)}this._getSvgElem().select("g.links").selectAll(".link").data(e,function(e){return e.id}).filter(function(e){return e.n2_selected||e.n2_derived_selected}).each(function(e){this.parentNode.appendChild(this)}),this._getSvgElem().select("g.links").selectAll(".link").data(e,function(e){return e.id}).filter(function(e){return e.n2_found}).each(function(e){this.parentNode.appendChild(this)}),this._getSvgElem().select("g.links").selectAll(".link").data(e,function(e){return e.id}).filter(function(e){return e.n2_hovered||e.n2_derived_hovered}).each(function(e){this.parentNode.appendChild(this)})},_documentsUpdated:function(e,t){var i=this,r=this._getSvgElem().select("g.nodes").selectAll(".node").data(e,function(e){return e.id}),o=this._getSvgElem().select("g.labels").selectAll(".label").data(e,function(e){return e.id}),s=r.enter().append("circle").attr("class","node").attr("r",3).attr("transform",function(e){return"rotate("+(e.orig_x-90)+")translate("+e.y+",0)"}).on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e),i._magnifyLocation(n.event)}).on("mousemove",function(e,t){i._magnifyLocation(n.event)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});this._adjustElementStyles(s);var a=o.enter().append(function(){return this.ownerDocument.createElementNS(this.namespaceURI,"text")}).attr("class","label").attr("dy",".31em").attr("transform",function(e){return"rotate("+(e.orig_x-90)+")translate("+(e.y+8)+",0)"+(e.orig_x<180?"":"rotate(180)")}).style("text-anchor",function(e){return e.orig_x<180?"start":"end"}).text(function(e){return""}).on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e),i._magnifyLocation(n.event)}).on("mousemove",function(e,t){i._magnifyLocation(n.event)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});this._adjustElementStyles(a),r.exit().remove(),o.exit().remove(),this._adjustElementStyles(r),this._adjustElementStyles(o);var l=this._getSvgElem().select("g.links").selectAll(".link").data(t,function(e){return e.id}),c=l.enter().append("path").attr("class","link").on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});this._adjustElementStyles(c,!0),l.exit().remove(),this._adjustElementStyles(l,!0),this._positionElements(),this._reOrderLinks()},_adjustElementStyles:function(e,t){var i=this;e.each(function(e,t){e.n2_elem=this,i.styleRules.getSymbolizer(e).adjustSvgElement(this,e),delete e.n2_elem}),t&&e.attr("fill","none")},_dispatch:function(e){var t=this.dispatchService;t&&t.send(i,e)},_sourceModelUpdated:function(e){this.elementGenerator.sourceModelUpdated(e)},_focusAngleFromLocation:function(e,t){var i=null,n=e-this.dimensions.cx,r=this.dimensions.cy-t;return 0==n&&0==r?null:(0==r?i=n<0?-90:90:(i=180*Math.atan(n/r)/Math.PI,r<0&&(i+=180),i>360&&(i-=360)),i)},_magnifyLocation:function(e){var t=null;try{t=this._getSvgElem()[0][0].getScreenCTM().inverse()}catch(e){}if(t){var i=e.clientX*t.a+e.clientY*t.c+t.e,n=e.clientX*t.b+e.clientY*t.d+t.f,r=this._focusAngleFromLocation(i,n);null!==r&&(this.magnify.angle(r),this._positionElements())}},_magnifyOut:function(){this.magnify.angle(null),this._positionElements()},_positionElements:function(){var e=this,t=!1;"number"==typeof this.magnifyThresholdCount&&this.magnifyThresholdCount<=this.sortedNodes.length&&(t=!0);for(var i=[],n=0,r=this.sortedNodes.length;n<r;++n){var o=this.sortedNodes[n];o.transitionNeeded=!1;var s=null,a=null;if(t){var l=this.magnify(o);s=l.x,a=l.z}else s=o.orig_x,a=2;var c=!1;if("number"!=typeof o.x)o.x=s,c=!0;else Math.abs(s-o.x)>.01&&(o.x=s,c=!0);if("number"!=typeof o.z)o.z=a,c=!0;else Math.abs(a-o.z)>.01&&(o.z=a,c=!0);c&&(o.transitionNeeded=!0,i.push(o))}var d=this._getSvgElem().select("g.nodes").selectAll(".node").data(i,function(e){return e.id});d.transition().attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+e.y+",0)"}),this._adjustElementStyles(d);var u=this._getSvgElem().select("g.labels").selectAll(".label").data(i,function(e){return e.id});u.transition().attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+(e.y+8)+",0)"+(e.x<180?"":"rotate(180)")}).style("text-anchor",function(e){return e.x<180?"start":"end"}),this._adjustElementStyles(u),this._getSvgElem().select("g.links").selectAll(".link").data(this.links,function(e){return e.id}).filter(function(e){return!!e.source.transitionNeeded||!!e.target.transitionNeeded}).transition().attr("d",function(t){return e.line(t.path)})},_initiateBackgroundMouseClick:function(){this._dispatch({type:"userUnselect"})},_initiateMouseClick:function(e){var t=e.id;this.toggleSelection&&this.lastElementIdSelected===t?(this.elementGenerator.selectOff(e),this.lastElementIdSelected=null):(this.elementGenerator.selectOn(e),this.lastElementIdSelected=t)},_initiateMouseOver:function(e){var t=e.id;t!==this.currentMouseOver&&(this.currentMouseOver&&(this.elementGenerator.focusOff(this.currentMouseOver),this.currentMouseOver=null),this.elementGenerator.focusOn(e),this.currentMouseOver=t)},_initiateMouseOut:function(e){e.id===this.currentMouseOver&&(this.elementGenerator.focusOff(e),this.currentMouseOver=null)},_handleDispatch:function(e){if("modelGetInfo"===e.type)e.modelId===this.modelId&&(e.modelInfo=this._getModelInfo());else if("modelStateUpdated"===e.type)this.sourceModelId===e.modelId&&e.state&&this._sourceModelUpdated(e.state);else if("windowResized"===e.type)this.resizeGraph();else if("findIsAvailable"===e.type){var t=e.doc._id;this.findableDocsById[t]&&(e.isAvailable=!0)}},_getModelInfo:function(){return{modelId:this.modelId,modelType:"radialTreeCanvas",parameters:[]}}});t.canvasRadialTree={RadialTreeCanvas:r,HandleCanvasAvailableRequest:function(e){!n&&window&&(n=window.d3),"radialTree"===e.canvasType&&(n?e.isAvailable=!0:t.log("Canvas radialTree requires d3 library"))},HandleCanvasDisplayRequest:function(e){if("radialTree"===e.canvasType){var t={};if(e.canvasOptions)for(var i in e.canvasOptions)t[i]=e.canvasOptions[i];t.canvasId=e.canvasId,t.interactionId=e.interactionId,t.config=e.config,t.moduleDisplay=e.moduleDisplay,t.onSuccess=e.onSuccess,t.onError=e.onError,new r(t)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.collapsibleRadialTreeCanvas",n=0;function r(e){if("number"!=typeof e)throw new Error("Degrees() accepts only numbers");return e>360&&(e%=360),e<-360&&(e%=360),e<0&&(e+=360),e}r.toRadians=function(e){if("number"!=typeof e)throw new Error("Degrees.toRadians() accepts only numbers");return e*Math.PI/180},r.sin=function(e){var t=r.toRadians(e);return Math.sin(t)},r.cos=function(e){var t=r.toRadians(e);return Math.cos(t)},r.atan=function(e){return 180*Math.atan(e)/Math.PI};var o=t.Class("Angle",{degrees:null,initialize:function(e){var i=t.extend({degrees:void 0,radians:void 0},e);if("number"==typeof i.degrees?this.degrees=i.degrees:"number"==typeof i.radians&&(this.degrees=180*i.radians/Math.PI),"number"!=typeof this.degrees)throw new Error("An angle must be specified in degrees or radians");this._adjust()},asDegrees:function(){return this.degrees},asRadians:function(){return this.degrees*Math.PI/180},sin:function(){return Math.sin(this.degrees*Math.PI/180)},cos:function(){return Math.cos(this.degrees*Math.PI/180)},add:function(e){return new o({degrees:this.degrees+e.degrees})},subtract:function(e){return new o({degrees:this.degrees-e.degrees})},_adjust:function(){this.degrees=r(this.degrees)}}),s=t.Class("AngleInterval",{min:null,max:null,initialize:function(e){var i=t.extend({min:void 0,max:void 0},e);if(this.min=i.min,this.max=i.max,"object"!=typeof this.min||"number"!=typeof this.min.degrees)throw new Error("AngleInterval must be given an angle as min property");if("object"!=typeof this.max||"number"!=typeof this.max.degrees)throw new Error("AngleInterval must be given an angle as max property")},getMin:function(){return this.min},getMax:function(){return this.max},add:function(e){var t=this.min.add(e),i=this.max.add(e);return new s({min:t,max:i})},subtract:function(e){var t=this.min.subtract(e),i=this.max.subtract(e);return new s({min:t,max:i})},includes:function(e){if(this.min.degrees===this.max.degrees){if(this.min.degrees===e.degrees)return!0}else if(this.min.degrees<this.max.degrees){if(this.min.degrees<=e.degrees&&e.degrees<=this.max.degrees)return!0}else if(this.min.degrees>this.max.degrees&&(this.min.degrees>=e.degrees||e.degrees>=this.max.degrees))return!0;return!1}});function a(){}a.visitNodes=function(e,i){"object"==typeof e&&null!==e&&"function"==typeof i&&function e(i,n,r){r(i,n);if(t.isArray(i.children))for(var o=0,s=i.children.length;o<s;++o){var a=i.children[o];e(a,n+1,r)}}(e,0,i)},a.getNodeDepth=function(e){return e&&e.parent?1+a.getNodeDepth(e.parent):0},a.visitParents=function(e,t){if(e&&"function"==typeof t){var i=a.getNodeDepth(e);e.parent&&function e(t,i,n){n(t,i);t.parent&&e(t.parent,i-1,n)}(e.parent,i-1,t)}},a.isNodeInTree=function(e,t){return!!e&&(!!t&&(e===t||a.isNodeInTree(e.parent,t)))},a.isRoot=function(e){return!e.parent};var l=t.Class({xSize:null,ySize:null,shownFn:null,assignFn:null,comparatorFn:null,reverseOrder:null,initialize:function(e){var i=t.extend({xSize:1,ySize:1,shownFn:null,assignFn:null,comparatorFn:null,reverseOrder:!1},e);this.xSize=i.xSize,this.ySize=i.ySize,this.shown(i.shownFn),this.assign(i.assignFn),this.comparator(i.comparatorFn),this.reverseOrder=i.reverseOrder,this.shownFn||(this.shownFn=function(e){return!0}),this.assignFn||(this.assignFn=function(e,t){e.x=t.x,e.y=t.y})},nodes:function(e){var t=this,i=[],n=0;!function e(r,o,s){var a=!1;for(var l=0,c=r.length;l<c;++l){var d=r[l],u={level:o,node:d,parent:s},h=t.shownFn(d);if(h&&!t.reverseOrder&&(a=!0,i.push(u)),d.children)if(t.comparatorFn){var p=d.children.slice(0);p.sort(t.comparatorFn),t.reverseOrder&&p.reverse(),e(p,o+1,u)}else e(d.children,o+1,u);h&&t.reverseOrder&&(a=!0,i.push(u))}a&&n<o&&(n=o)}([e],0,void 0);var r=0;this.xSize>0&&i.length>0&&(r=this.xSize/i.length);var o=0;this.ySize>0&&n>0&&(o=this.ySize/n);for(var s=0,a=i.length;s<a;++s){(c=i[s])&&(c.x=s*r,c.y=c.level*o,c.xIndent=r,c.yIndent=o,u(c,c.x))}var l=[];for(s=0,a=i.length;s<a;++s){var c;if(c=i[s]){var d=c.node;this.assignFn(d,c),l.push(d)}}return l;function u(e,t){e&&("number"!=typeof e.xMax?e.xMax=t:e.xMax<t&&(e.xMax=t),"number"!=typeof e.xMin?e.xMin=t:e.xMin>t&&(e.xMin=t),u(e.parent,t))}},size:function(e,t){this.xSize=e,this.ySize=t},shown:function(e){"function"==typeof e?this.shownFn=e:"string"==typeof e&&(this.shownFn=function(t){return t[e]})},assign:function(e){"function"==typeof e&&(this.assignFn=e)},comparator:function(e){"function"==typeof e&&(this.comparatorFn=e)}}),c=t.Class({dispatchService:null,selectedMap:null,onChangeFn:null,eventSourcesToIgnoreMap:null,initialize:function(e){var n=t.extend({dispatchService:null},e),r=this;if(this.dispatchService=n.dispatchService,this.selectedMap={},this.eventSourcesToIgnoreMap={},this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(i,"selected",o),this.dispatchService.register(i,"selectedSupplement",o),this.dispatchService.register(i,"unselected",o)}},onChange:function(e){"function"==typeof e&&(this.onChangeFn=e)},addIgnoreEventSource:function(e){this.eventSourcesToIgnoreMap[e]=!0},_reportChange:function(){if("function"==typeof this.onChangeFn){var e={};for(var t in this.selectedMap)e[t]=!0;this.onChangeFn(e)}},_performUnselected:function(e){var t=!1;for(var i in this.selectedMap)t=!0;return this.selectedMap={},e||this._reportChange(),t},_performSelected:function(e){var i=this._performUnselected(!0);if("string"==typeof e)this.selectedMap[e]=!0,i=!0;else if(t.isArray(e))for(var n=0,r=e.length;n<r;++n){var o=e[n];this.selectedMap[o]=!0,i=!0}return i&&this._reportChange(),i},_performSelectedSupplement:function(e){var t=!1;return this.selectedMap[e]||(this.selectedMap[e]=!0,t=!0),t&&this._reportChange(),t},_performFind:function(e){return!1},_shoudIgnoreEvent:function(e){return!(!e._source||!this.eventSourcesToIgnoreMap[e._source])},_handle:function(e,t,i){"selected"===e.type?this._shoudIgnoreEvent(e)||(e.docId?this._performSelected(e.docId):e.docIds&&this._performSelected(e.docIds)):"selectedSupplement"===e.type?this._shoudIgnoreEvent(e)||(e.origin?this.selectedMap[e.origin]&&this._performSelectedSupplement(e.docId):e.docId&&this._performSelectedSupplement(e.docId)):"unselected"===e.type&&this._performUnselected()}}),d=t.Class({canvasId:null,interactionId:null,svgId:null,modelId:null,dispatchService:null,sourceModelId:null,moduleDisplay:null,radius:null,background:null,toggleSelection:null,originAngle:null,transitionDuration:null,collapseBeforeExpand:null,styleRules:null,displayedNodesSorted:null,displayedLinks:null,eventSource:null,elementGenerator:null,elementsById:null,elementsByGroup:null,elementIdToGroupName:null,elementsByDocId:null,effectiveElementsById:null,elementToEffectiveId:null,elementTreeRoot:null,sourceLinks:null,dimensions:null,layout:null,line:null,bundle:null,magnifyOptions:null,magnify:null,magnifyThresholdCount:null,filterOptions:null,arcOptions:null,currentMouseOver:null,lastElementIdSelected:null,outsideSelectionDocIdMap:null,expandedNodesById:null,fixOriginOnNode:null,originOffset:null,initialize:function(e){var o=t.extend({canvasId:null,interactionId:null,config:null,moduleDisplay:null,sourceModelId:null,radius:300,background:null,layout:null,line:null,magnify:null,styleRules:null,filter:null,arcs:null,toggleSelection:!1,originAngle:0,transitionDuration:250,collapseBeforeExpand:!0,elementGeneratorType:"default",elementGeneratorOptions:null,elementGenerator:null,onSuccess:function(){},onError:function(e){}},e),s=this;this.canvasId=o.canvasId,this.interactionId=o.interactionId,this.moduleDisplay=o.moduleDisplay,this.sourceModelId=o.sourceModelId,this.radius=0+o.radius,this.background=o.background,this.toggleSelection=o.toggleSelection,this.elementGenerator=o.elementGenerator,this.transitionDuration=o.transitionDuration,this.collapseBeforeExpand=o.collapseBeforeExpand,this.modelId=t.getUniqueId("collapsibleRadialTreeCanvas"),this.styleRules=t.styleRule.loadRulesFromObject(o.styleRules);var a=o.config;if(a&&a.directory&&(this.dispatchService=a.directory.dispatchService),"number"!=typeof o.originAngle&&(o.originAngle=0+o.originAngle),"number"!=typeof o.originAngle&&(o.originAngle=0),this.originAngle=r(o.originAngle),this.elementsByGroup={},this.elementIdToGroupName={},this.displayedNodesSorted=[],this.displayedLinks=[],this.currentMouseOver=null,this.elementsById={},this.elementsByDocId={},this.effectiveElementsById={},this.elementToEffectiveId={},this.elementTreeRoot={},this.sourceLinks=[],this.dimensions={},this.lastElementIdSelected=null,this.focusInfo=null,this.selectInfo=null,this.magnifyThresholdCount=null,this.outsideSelectionDocIdMap=null,this.expandedNodesById={},this.fixOriginOnNode=null,this.originOffset=0,this.eventSource="CollapsibleRadialTreeCanvas_"+n,++n,this.elementGenerator||(this.elementGenerator=t.canvasElementGenerator.CreateElementGenerator({type:o.elementGeneratorType,options:o.elementGeneratorOptions,config:o.config})),this.elementGenerator&&(this.elementGenerator.setElementsChangedListener(function(e,t,i){s._elementsChanged(e,t,i)}),this.elementGenerator.setIntentChangedListener(function(e){s._intentChanged(e)}),"function"==typeof this.elementGenerator.setEventSource&&this.elementGenerator.setEventSource(this.eventSource)),this.dispatchService){var d=function(e){s._handleDispatch(e)};this.dispatchService.register(i,"modelGetInfo",d),this.dispatchService.register(i,"modelStateUpdated",d),this.dispatchService.register(i,"windowResized",d),this.dispatchService.register(i,"findIsAvailable",d),this.dispatchService.register(i,"find",d),this.selectionTracker=new c({dispatchService:this.dispatchService}),this.selectionTracker.addIgnoreEventSource(this.eventSource),this.selectionTracker.onChange(function(e){s._selectionChanged(e)})}this.createGraph();var u=t.extend({reverseOrder:!1},o.layout,{xSize:360,assignFn:function(e,t){e.x=t.x,e.xMax=t.xMax,e.xMin=t.xMin,e.xIndent=t.xIndent,e.y=s.dimensions.radius},shownFn:function(e){return!!e.canvasVisible||!!e.canvasVisibleDerived},comparatorFn:function(e,t){return e.sortValue<t.sortValue?-1:e.sortValue>t.sortValue?1:0}});this.layout=new l(u);var h=t.extend({interpolate:"bundle",tension:.85},o.line);for(var p in this.line=d3.svg.line.radial().radius(function(e){return e.y}).angle(function(e){return e.x/180*Math.PI}),h){var f=h[p];"interpolate"===p&&"string"==typeof f&&this.line.interpolate(f),"tension"===p&&"number"==typeof f&&this.line.tension(f)}for(var p in this.bundle=d3.layout.bundle(),this.magnifyOptions=t.extend({enabled:!0,radius:10,distortion:2,thresholdCount:100},o.magnify),this.magnify=function(){var e,t,i=10,n=2,o=null,s=function(e){return e.x};function a(s){if("number"!=typeof o)return{x:s,z:1};var a=r(s)-o;a>180&&(a-=360),a<-180&&(a+=360);var l=Math.abs(a);if(l>=i)return{x:s,z:1};if(!l)return{x:s,z:n};var c=e*(1-Math.exp(-l*t))/l*.75+.25;return{x:r(o+a*c),z:Math.min(c,n)}}function l(e){return a(s(e))}function c(){return e=(e=Math.exp(n))/(e-1)*i,t=n/i,l}return l.compute=function(e){return a(r(e))},l.radius=function(e){return arguments.length?(i=+e,c()):i},l.distortion=function(e){return arguments.length?(n=+e,c()):n},l.angle=function(e){return arguments.length?(o="number"==typeof e?r(e):e,l):o},l.angleAttribute=function(e){if(!arguments.length)return s;if("function"==typeof e)s=e;else{if("string"!=typeof e)throw new Error("Invalid angleAttribute property");s=function(t){return t[e]}}return l},c(),l}().radius(10).distortion(2).angleAttribute(function(e){return e.orig_x}),this.magnifyOptions){f=this.magnifyOptions[p];"radius"===p&&"number"==typeof f&&this.magnify.radius(f),"distortion"===p&&"number"==typeof f&&this.magnify.distortion(f),"thresholdCount"===p&&"number"==typeof f&&(this.magnifyThresholdCount=f)}if(this.filterOptions=t.extend({expand:!1,showGroupMembers:!0},o.filter),this.arcOptions=t.extend({show:!0,offset:0,extent:200},o.arcs),o.onSuccess(),this.sourceModelId&&this.dispatchService){var m={type:"modelGetState",modelId:this.sourceModelId,state:null};this.dispatchService.synchronousCall(i,m),m.state&&this._sourceModelUpdated(m.state)}t.log("collapsibleRadialTreeCanvas",this)},createGraph:function(){var n=this;this.background&&"string"==typeof this.background.color&&e("#"+this.canvasId).css("background-color",this.background.color);this.svgId=t.getUniqueId();var r=d3.select("#"+this.canvasId).append("svg").attr("id",this.svgId);r.append("rect").attr("class","collapsibleRadialTreeBackground").attr("x",0).attr("y",0).attr("stroke","none").attr("fill","#000000").attr("fill-opacity",0).on("click",function(){n._initiateBackgroundMouseClick()}).on("mousemove",function(){n._magnifyOut()});var o=r.append("g").attr("class","collapsibleRadialTreeScale").append("g").attr("class","collapsibleRadialTreeRoot");if(o.append("circle").attr("class","magnifyEvents").attr("stroke","#000000").attr("stroke-opacity",0).attr("fill","none").on("click",function(){n._initiateBackgroundMouseClick()}).on("mouseover",function(){var e=d3.event;n._magnifyLocation(e)}).on("mousemove",function(){var e=d3.event;n._magnifyLocation(e)}),o.append("g").attr("class","arcs"),o.append("g").attr("class","links"),o.append("g").attr("class","nodes"),o.append("g").attr("class","labels"),this.resizeGraph(),this.dispatchService){var s={type:"canvasReportSvg",canvasType:"collapsibleRadialTree",canvas:this,svg:void 0};r.each(function(){s.svg=this}),this.dispatchService.send(i,s)}},getGraphSize:function(){var t=e("#"+this.canvasId);return[t.width(),t.height()]},resizeGraph:function(){var e=this.getGraphSize(),t=e[0];t>e[1]&&(t=e[1]);var i=800-this.radius;this.dimensions={width:e[0],height:e[1],cx:Math.floor(e[0]/2),cy:Math.floor(e[1]/2),canvasWidth:t,radius:Math.floor(this.radius),textWidth:i};var n=this._getSvgElem().attr("width",e[0]).attr("height",e[1]);n.select("g.collapsibleRadialTreeScale").attr("transform","translate("+this.dimensions.cx+","+this.dimensions.cy+") scale("+t/800+")"),n.select("rect.collapsibleRadialTreeBackground").attr("width",e[0]).attr("height",e[1]),n.select("g.collapsibleRadialTreeRoot").select("circle.magnifyEvents").attr("r",this.dimensions.radius+Math.floor(this.dimensions.textWidth/2)+5).attr("stroke-width",this.dimensions.textWidth+10)},_getSvgElem:function(){return d3.select("#"+this.svgId)},_elementsChanged:function(e,t,n){for(var r=0,o=n.length;r<o;++r){var s=n[r];if(delete this.elementsById[s.id],l=this.elementIdToGroupName[s.id])(d=this.elementsByGroup[l])&&(d=d.filter(function(e){return e.id!==s.id}),this.elementsByGroup[l]=d),delete this.elementIdToGroupName[s.id]}for(r=0,o=e.length;r<o;++r){var a=e[r];if(this.elementsById[a.id]=a,a.group){var l=a.group;(d=this.elementsByGroup[l])||(d=[],this.elementsByGroup[l]=d),d.push(a),this.elementIdToGroupName[a.id]=l}}for(r=0,o=t.length;r<o;++r){var c=t[r];if(this.elementsById[c.id]=c,(l=this.elementIdToGroupName[c.id])!==c.group){if(l)(d=this.elementsByGroup[l])&&(d=d.filter(function(e){return e.id!==c.id}),this.elementsByGroup[l]=d),delete this.elementIdToGroupName[c.id];if(c.group){var d;l=c.group;(d=this.elementsByGroup[l])||(d=[],this.elementsByGroup[l]=d),d.push(c),this.elementIdToGroupName[c.id]=l}}}for(var u in this.elementsByDocId={},this.elementsById){var h=this.elementsById[u];if(h.fragments)for(var p in h.fragments){var f=h.fragments[p].context;if(f){var m=f.n2_doc;if(m){var v=m._id,g=this.elementsByDocId[v];g||(g=[],this.elementsByDocId[v]=g),g.push(h)}}}}this._createGraphicalElements(),this.dispatchService.send(i,{type:"findAvailabilityChanged"})},_createGraphicalElements:function(){for(var e in this.elementsById){delete(t=this.elementsById[e]).parent,delete t.children,delete t.expanded}for(var e in this.elementTreeRoot={id:"__root__",name:"",x:0,y:0,children:[],expanded:!0},this.sourceLinks=[],this.elementsById){var t;if((t=this.elementsById[e]).isNode)if(t.children||(t.children=[]),t.parentId){var i=this.elementsById[t.parentId];t.parent=i,i.children||(i.children=[]),i.children.push(t)}else t.parent=this.elementTreeRoot,this.elementTreeRoot.children.push(t);t.isLink&&this.sourceLinks.push(t)}this._redraw()},_redraw:function(){var e=this;if(this.effectiveElementsById={},this.elementToEffectiveId={},this.outsideSelectionDocIdMap){var t={};for(var i in this.outsideSelectionDocIdMap){var n=void 0;if(i&&(n=this.elementsByDocId[i]),n)for(var o=0,s=n.length;o<s;++o){t[(d=n[o]).id]=d}}var l={};for(var c in t){var d;(d=t[c]).isNode&&(d.canvasVisible&&(e.fixOriginOnNode||(e.fixOriginOnNode={id:d.id,position:r(d.orig_x-e.originAngle)})),a.visitParents(d,function(t){a.isRoot(t)||(l[t.id]=!0,e.expandedNodesById[t.id]||"number"!=typeof t.orig_x||e.fixOriginOnNode||(e.fixOriginOnNode={id:t.id,position:r(t.orig_x-e.originAngle)}))}))}this.expandedNodesById=l}for(var u in this.elementsById){(b=this.elementsById[u]).isNode&&(this.expandedNodesById[u]?b.expanded=!0:b.expanded=!1)}if(this.filterOptions.expand){var h=void 0,p=-1;if(a.visitNodes(this.elementTreeRoot,function(t,i){t.canvasVisible=!1,t.canvasVisibleDerived=!1,t.expanded&&p<i&&(h=t,p=i),a.isRoot(t)?t.canvasAvailable=!1:t.parent&&function t(i){if(!i)return!1;if(!a.isNodeInTree(i,e.elementTreeRoot))return!1;if(!i.expanded)return!1;if(i.parent&&!t(i.parent))return!1;return!0}(t.parent)?t.canvasAvailable=!0:t.canvasAvailable=!1}),h&&h.children){for(o=0,s=h.children.length;o<s;++o){(L=h.children[o]).canvasVisible=!0}h.canvasVisible=!0,a.visitParents(h,function(e,t){a.isRoot(e)?e.canvasVisible=!1:e.canvasVisible=!0})}for(o=0,s=this.sourceLinks.length;o<s;++o){var f=M((k=this.sourceLinks[o]).source),m=M(k.target),v=O(k.source),g=O(k.target);f&&m||(f&&g?g.canvasVisibleDerived=!0:m&&v&&(v.canvasVisibleDerived=!0))}var y=this.filterOptions.showGroupMembers;a.visitNodes(this.elementTreeRoot,function(e,t){y&&e.group&&(e.canvasAvailable=!0,e.canvasVisible=!0)})}else a.visitNodes(this.elementTreeRoot,function(e,t){a.isRoot(e)?e.canvasVisible=!1:e.parent&&e.parent.expanded?e.canvasVisible=!0:e.canvasVisible=!1});if(this.elementTreeRoot.canvasVisible=!1,this.elementTreeRoot.canvasVisibleDerived=!1,this.displayedNodesSorted=this.layout.nodes(this.elementTreeRoot),this.originOffset=0,this.fixOriginOnNode){var _=this.fixOriginOnNode.id,S=this.fixOriginOnNode.position;if("number"==typeof S)for(o=0,s=this.displayedNodesSorted.length;o<s;++o){_===(L=this.displayedNodesSorted[o]).id&&(this.originOffset=S-L.x)}}this.displayedLinks=[];for(o=0,s=this.sourceLinks.length;o<s;++o){u=(b=this.sourceLinks[o]).id;var b,I=A(b.source),C=A(b.target);if(I&&C){var D=F(I,C),w=this.effectiveElementsById[D];w||(w={id:D,isLink:!0,source:I,target:C,elementIds:[I.id,C.id],fragments:{},n2_geometry:"line"},this.effectiveElementsById[D]=w,this.displayedLinks.push(w)),R(w,I),R(w,C),this.elementToEffectiveId[u]=D}}for(o=0,s=this.displayedLinks.length;o<s;++o){var E=[(k=this.displayedLinks[o]).source,this.elementTreeRoot,k.target];k.path=E,this._refreshEffectiveLinkIntent(k)}var x=1;this.displayedNodesSorted.length>0&&(x=80/this.displayedNodesSorted.length)>1&&(x=1);for(o=0,s=this.displayedNodesSorted.length;o<s;++o){(L=this.displayedNodesSorted[o]).n2_geometry="point",L.orig_x=r(L.x+this.originAngle+this.originOffset),delete L.x,"number"==typeof L.xMax&&(L.xMax=r(L.xMax+this.originAngle+this.originOffset)),"number"==typeof L.xMin&&(L.xMin=r(L.xMin+this.originAngle+this.originOffset)),L.zFactor=x,this.effectiveElementsById[L.id]=L}p=void 0;var T=void 0;if(a.visitNodes(this.elementTreeRoot,function(e,t){delete e.detailedView,delete e.generalView,(e.canvasVisible||e.canvasVisibleDerived)&&("number"==typeof p?p<t?(p=t,(T=[]).push(e)):p===t&&T.push(e):(p=t,(T=[]).push(e)))}),T)for(o=0,s=T.length;o<s;++o){(L=T[o]).detailedView=!0}for(o=0,s=this.displayedLinks.length;o<s;++o){delete(k=this.displayedLinks[o]).detailedView,delete k.generalView,k.source.detailedView?k.detailedView=!0:k.target.detailedView?k.detailedView=!0:k.generalView=!0}for(o=0,s=this.displayedLinks.length;o<s;++o){var k;(k=this.displayedLinks[o]).detailedView&&(k.source.detailedView=!0,k.target.detailedView=!0)}for(o=0,s=this.displayedNodesSorted.length;o<s;++o){var L;(L=this.displayedNodesSorted[o]).detailedView||(L.generalView=!0)}function M(t){if(!t)return null;if(!a.isNodeInTree(t,e.elementTreeRoot))return null;if(t.canvasVisible)return t;var i=t.parent;return i?M(i):null}function O(t){if(!t)return null;if(!a.isNodeInTree(t,e.elementTreeRoot))return null;if(t.canvasAvailable)return t;var i=t.parent;return i?O(i):null}function A(t){if(!t)return null;if(!a.isNodeInTree(t,e.elementTreeRoot))return null;if(t.canvasVisible)return t;if(t.canvasVisibleDerived)return t;var i=t.parent;return i?M(i):null}function F(e,t){var i=[e.id,t.id];return i.sort(),i.join("_to_")}function R(e,t){if(e&&t&&(e.fragments||(e.fragments={}),t.fragments))for(var i in t.fragments){var n=t.fragments[i];e.fragments[i]=n}}this._computeDerivedIntent({},{}),this._documentsUpdated(this.displayedNodesSorted,this.displayedLinks)},_refreshEffectiveLinkIntent:function(e){e.n2_selected=!0,e.n2_selectedIntent=void 0,e.n2_hovered=!0,e.n2_hoveredIntent=void 0,e.n2_found=!0,e.n2_intent=void 0;var t=!1;if(e.elementIds)for(var i=0,n=e.elementIds.length;i<n;++i){var r=e.elementIds[i],o=this.elementsById[r];o&&(t=!0,o.n2_selected||(e.n2_selected=!1),o.n2_hovered||(e.n2_hovered=!1),o.n2_found||(e.n2_found=!1),o.n2_selectedIntent&&(null===e.n2_selectedIntent||(void 0===e.n2_selectedIntent?e.n2_selectedIntent=o.n2_selectedIntent:e.n2_selectedIntent=null)),o.n2_hoveredIntent&&(null===e.n2_hoveredIntent||(void 0===e.n2_hoveredIntent?e.n2_hoveredIntent=o.n2_hoveredIntent:e.n2_hoveredIntent=null)),o.n2_intent&&(null===e.n2_intent||(void 0===e.n2_intent?e.n2_intent=o.n2_intent:e.n2_intent=null)))}t||(e.n2_selected=!1,e.n2_hovered=!1,e.n2_intent=!1),e.n2_selected||(e.n2_selectedIntent=void 0),e.n2_hovered||(e.n2_hoveredIntent=void 0),e.n2_found||(e.n2_intent=void 0)},_computeDerivedIntent:function(e,t){var i=0,n=0;for(var r in this.effectiveElementsById){(o=this.effectiveElementsById[r]).isNode&&(o.n2_selected&&++i,o.n2_hovered&&++n)}for(var r in this.effectiveElementsById){(o=this.effectiveElementsById[r]).isLink&&(o.n2_selected&&(o.source.temp_selected=!0,o.target.temp_selected=!0),o.n2_hovered&&(o.source.temp_hovered=!0,o.target.temp_hovered=!0),o.source.n2_selected&&i<2&&(o.temp_selected=!0,o.target.temp_selected=!0),o.target.n2_selected&&i<2&&(o.temp_selected=!0,o.source.temp_selected=!0),o.source.n2_hovered&&n<2&&(o.temp_hovered=!0,o.target.temp_hovered=!0),o.target.n2_hovered&&n<2&&(o.temp_hovered=!0,o.source.temp_hovered=!0))}for(var r in this.effectiveElementsById){var o;(o=this.effectiveElementsById[r]).n2_derived_selected!==o.temp_selected&&(o.n2_derived_selected=o.temp_selected,o.isLink?t[o.id]=o:o.isNode&&(e[o.id]=o)),o.n2_derived_hovered!==o.temp_hovered&&(o.n2_derived_hovered=o.temp_hovered,o.isLink?t[o.id]=o:o.isNode&&(e[o.id]=o))}},_intentChanged:function(e){for(var t in this.effectiveElementsById){var i=this.effectiveElementsById[t];i.temp_hovered=!1,i.temp_selected=!1}for(var n={},r={},o={},s=0,a=e.length;s<a;++s){var l=e[s].id;(c=this.elementToEffectiveId[l])?o[c]=!0:o[l]=!0}for(var c in o){var d=this.effectiveElementsById[c];d&&(d.isNode?n[d.id]=d:d.isLink&&(this._refreshEffectiveLinkIntent(d),r[d.id]=d))}this._computeDerivedIntent(n,r);var u=[];for(var h in n)u.push(n[h]);var p=[];for(var f in r)p.push(r[f]);var m=this._getSvgElem().select("g.nodes").selectAll(".node").data(u,function(e){return e.id});this._adjustElementStyles(m);var v=this._getSvgElem().select("g.labels").selectAll(".label").data(u,function(e){return e.id});if(this._adjustElementStyles(v),this.arcOptions.show){var g=this._getSvgElem().select("g.arcs").selectAll(".arc").data(u,function(e){return e.id});this._adjustElementStyles(g)}var y=this._getSvgElem().select("g.links").selectAll(".link").data(p,function(e){return e.id});this._adjustElementStyles(y,!0),this._reOrderElements()},_reOrderElements:function(){this._getSvgElem().select("g.links").selectAll(".link").data(this.displayedLinks,function(e){return e.id}).filter(function(e){return e.n2_selected}).each(function(e){this.parentNode.appendChild(this)}),this._getSvgElem().select("g.links").selectAll(".link").data(this.displayedLinks,function(e){return e.id}).filter(function(e){return e.n2_found}).each(function(e){this.parentNode.appendChild(this)}),this._getSvgElem().select("g.links").selectAll(".link").data(this.displayedLinks,function(e){return e.id}).filter(function(e){return e.n2_hovered}).each(function(e){this.parentNode.appendChild(this)}),this._getSvgElem().select("g.arcs").selectAll(".arc").data(this.displayedNodesSorted,function(e){return e.id}).filter(function(e){return e.n2_selected}).each(function(e){this.parentNode.appendChild(this)}),this._getSvgElem().select("g.arcs").selectAll(".arc").data(this.displayedNodesSorted,function(e){return e.id}).filter(function(e){return e.n2_found}).each(function(e){this.parentNode.appendChild(this)}),this._getSvgElem().select("g.arcs").selectAll(".arc").data(this.displayedNodesSorted,function(e){return e.id}).filter(function(e){return e.n2_hovered}).each(function(e){this.parentNode.appendChild(this)})},_documentsUpdated:function(e,t){var i=this,n=this._getSvgElem().select("g.nodes").selectAll(".node").data(e,function(e){return e.id}),o=n.enter().append("circle").attr("class","node").attr("r",3).attr("transform",function(e){return"rotate("+r(e.orig_x-90)+")translate("+e.y+",0)"}).on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e),i._magnifyLocation(d3.event)}).on("mousemove",function(e,t){i._magnifyLocation(d3.event)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});this._adjustElementStyles(o),n.exit().remove();var s=this._getSvgElem().select("g.labels").selectAll(".label").data(e,function(e){return e.id}),a=s.enter().append(function(){return this.ownerDocument.createElementNS(this.namespaceURI,"text")}).attr("class","label").attr("dy",".31em").attr("transform",function(e){return"rotate("+r(e.orig_x-90)+")translate("+(e.y+6)+",0)"+(e.orig_x<180?"":"rotate(180)")}).style("text-anchor",function(e){return e.orig_x<180?"start":"end"}).text(function(e){return""}).on("click",function(e,t){i._initiateMouseClick(e),i._initiateExpandCollapse(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e),i._magnifyLocation(d3.event)}).on("mousemove",function(e,t){i._magnifyLocation(d3.event)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});if(this._adjustElementStyles(a),s.exit().remove(),this._adjustElementStyles(s),this.arcOptions.show){var l=e.filter(function(e){return"boolean"==typeof e.showArc&&e.showArc}),c=this._getSvgElem().select("g.arcs").selectAll(".arc").data(l,function(e){return e.id}),d=c.enter().append("path").attr("class","arc").on("click",function(e,t){i._initiateMouseClick(e),i._initiateExpandCollapse(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e),i._magnifyLocation(d3.event)}).on("mousemove",function(e,t){i._magnifyLocation(d3.event)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});this._adjustElementStyles(d),c.exit().remove(),this._adjustElementStyles(c)}var u=this._getSvgElem().select("g.links").selectAll(".link").data(t,function(e){return e.id}),h=u.enter().append("path").attr("class","link").on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});this._adjustElementStyles(h,!0),u.exit().remove(),this._adjustElementStyles(u,!0),this._positionElements(),this._reOrderElements()},_adjustElementStyles:function(e,t){var i=this;e.each(function(e,t){e.n2_elem=this,i.styleRules.getSymbolizer(e).adjustSvgElement(this,e),delete e.n2_elem}),t&&e.attr("fill","none")},_sourceModelUpdated:function(e){this.elementGenerator.sourceModelUpdated(e)},_focusAngleFromLocation:function(e,t){var i=null,n=e-this.dimensions.cx,o=this.dimensions.cy-t;return 0==n&&0==o?null:(0==o?i=n<0?-90:90:(i=r.atan(n/o),o<0&&(i+=180),i>360&&(i-=360)),i)},_magnifyLocation:function(e){var t=null;try{t=this._getSvgElem()[0][0].getScreenCTM().inverse()}catch(e){}if(t){var i=e.clientX*t.a+e.clientY*t.c+t.e,n=e.clientX*t.b+e.clientY*t.d+t.f,r=this._focusAngleFromLocation(i,n);null!==r&&(this.magnify.angle(r),this._positionElements())}},_magnifyOut:function(){this.magnify.angle(null),this._positionElements()},_positionElements:function(){var e=this,t=this.magnifyOptions.enabled;t&&"number"==typeof this.magnifyThresholdCount&&this.magnifyThresholdCount>this.displayedNodesSorted.length&&(t=!1);for(var i=[],n=0,o=this.displayedNodesSorted.length;n<o;++n){var s=this.displayedNodesSorted[n];s.transitionNeeded=!1;var a=null;t?a=f(s):((a={}).x=s.orig_x,a.z=1,"number"==typeof s.xMax&&(a.xArcStart=s.xMin-s.xIndent/2,a.xArcEnd=s.xMax+s.xIndent/2));var l=!1;m(s,"x",a.x)&&(l=!0),m(s,"z",a.z)&&(l=!0),m(s,"xArcStart",a.xArcStart)&&(l=!0),m(s,"xArcEnd",a.xArcEnd)&&(l=!0),l&&(s.transitionNeeded=!0,i.push(s))}var c=this._getSvgElem().select("g.nodes").selectAll(".node").data(i,function(e){return e.id});c.transition().duration(this.transitionDuration).attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+e.y+",0)"}),this._adjustElementStyles(c);var d=this._getSvgElem().select("g.labels").selectAll(".label").data(i,function(e){return e.id});if(d.transition().duration(this.transitionDuration).attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+(e.y+6)+",0)"+(e.x<180?"":"rotate(180)")}).style("text-anchor",function(e){return e.x<180?"start":"end"}),this._adjustElementStyles(d),this.arcOptions.show){var u=this._getSvgElem().select("g.arcs").selectAll(".arc").data(i,function(e){return e.id}),h=this.arcOptions.offset,p=this.arcOptions.extent;u.transition().duration(this.transitionDuration).attr("transform",function(e){return"rotate(-90)"}).attr("d",function(e){var t=e.y+h,i=e.y+h+p,n=r(e.xArcEnd-e.xArcStart);return["M",t*r.cos(e.xArcStart),t*r.sin(e.xArcStart),"A",t,t,"0",n>180?"1":"0","1",t*r.cos(e.xArcEnd),t*r.sin(e.xArcEnd),"L",i*r.cos(e.xArcEnd),i*r.sin(e.xArcEnd),"A",i,i,"0",n>180?"1":"0","0",i*r.cos(e.xArcStart),i*r.sin(e.xArcStart),"Z"].join(" ")}),this._adjustElementStyles(u)}function f(t){var i=e.magnify(t);return"number"==typeof t.xMin&&(i.xArcStart=e.magnify.compute(t.xMin-t.xIndent/2).x),"number"==typeof t.xMax&&(i.xArcEnd=e.magnify.compute(t.xMax+t.xIndent/2).x),i}function m(e,t,i,n){var r=e[t];if(typeof r!=typeof i)return e[t]=i,!0;if("number"==typeof r&&"number"==typeof n){if(Math.abs(i-r)>n)return e[t]=i,!0}else if(r!=i)return e[t]=i,!0;return!1}this._getSvgElem().select("g.links").selectAll(".link").data(this.displayedLinks,function(e){return e.id}).filter(function(e){return!!e.source.transitionNeeded||!!e.target.transitionNeeded}).transition().duration(this.transitionDuration).attr("d",function(t){return e.line(t.path)})},_initiateBackgroundMouseClick:function(){this.lastElementIdSelected=null,this.dispatchService.send(i,{type:"userUnselect"})},_initiateExpandCollapse:function(e){var t=this;if(e.children&&!(e.children.length<1)){this.outsideSelectionDocIdMap=null;var i=e.id;if(this.expandedNodesById[i])this.fixOriginOnNode={id:e.id,position:r(e.orig_x-this.originAngle)},delete this.expandedNodesById[i];else{var n=e.group;if(n){var o=this.elementsByGroup[n];if(o)for(var s=0,a=o.length;s<a;++s){var l=o[s];if(l.id!==e.id&&this.expandedNodesById[l.id]){if(this.collapseBeforeExpand)return this._initiateExpandCollapse(l),void window.setTimeout(function(){t._initiateExpandCollapse(e)},this.transitionDuration);delete this.expandedNodesById[l.id]}}}this.fixOriginOnNode={id:e.id,position:r(e.orig_x-this.originAngle)},this.expandedNodesById[i]=!0}this._redraw()}},_initiateMouseClick:function(e){var t=e.id;this.toggleSelection&&this.lastElementIdSelected===t?(this.elementGenerator.selectOff(e),this.lastElementIdSelected=null):(this.elementGenerator.selectOn(e),this.lastElementIdSelected=t)},_initiateMouseOver:function(e){var t=e.id;t!==this.currentMouseOver&&(this.currentMouseOver&&(this.elementGenerator.focusOff(this.currentMouseOver),this.currentMouseOver=null),this.elementGenerator.focusOn(e),this.currentMouseOver=t)},_initiateMouseOut:function(e){e.id===this.currentMouseOver&&(this.elementGenerator.focusOff(e),this.currentMouseOver=null)},_findElements:function(e){for(var t=this,i=!1,n=0,r=e.length;n<r;++n){var o=e[n];o.isNode&&!o.canvasVisible&&a.visitParents(o,function(e){e.parent&&(e.expanded||(t.expandedNodesById[e.id]=!0,i=!0))})}i&&this._redraw()},_selectionChanged:function(e){this.fixOriginOnNode=null,this.outsideSelectionDocIdMap=e,this._redraw()},_handleDispatch:function(e){if("modelGetInfo"===e.type)e.modelId===this.modelId&&(e.modelInfo=this._getModelInfo());else if("modelStateUpdated"===e.type)this.sourceModelId===e.modelId&&e.state&&this._sourceModelUpdated(e.state);else if("windowResized"===e.type)this.resizeGraph();else if("findIsAvailable"===e.type){var t=e.doc._id;this.elementsByDocId[t]&&(e.isAvailable=!0)}else if("find"===e.type){var i=void 0;(t=e.docId)&&(i=this.elementsByDocId[t]),i&&this._findElements(i)}},_getModelInfo:function(){return{modelId:this.modelId,modelType:"collapsibleRadialTreeCanvas",parameters:[]}}});t.canvasCollapsibleRadialTree={CollapsibleRadialTreeCanvas:d,HandleCanvasAvailableRequest:function(e){"collapsibleRadialTree"===e.canvasType&&(window&&window.d3?e.isAvailable=!0:t.log("Canvas collapsibleRadialTree requires d3 library"))},HandleCanvasDisplayRequest:function(e){if("collapsibleRadialTree"===e.canvasType){var t={};if(e.canvasOptions)for(var i in e.canvasOptions)t[i]=e.canvasOptions[i];t.canvasId=e.canvasId,t.interactionId=e.interactionId,t.config=e.config,t.moduleDisplay=e.moduleDisplay,t.onSuccess=e.onSuccess,t.onError=e.onError,new d(t)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.canvasGrid",n=t.Class("GridCanvas",{canvasId:null,sourceModelId:null,refreshIntervalInMs:null,elementGenerator:null,dispatchService:null,showService:null,elementsById:null,sortedElements:null,intentView:null,initialize:function(e){var n=t.extend({canvasId:null,sourceModelId:null,refreshIntervalInMs:200,elementGenerator:null,config:null,moduleDisplay:null,elemIdToDocId:null,onSuccess:function(){},onError:function(e){}},e),r=this;try{this.canvasId=n.canvasId,this.sourceModelId=n.sourceModelId,this.refreshIntervalInMs=n.refreshIntervalInMs,this.elementGenerator=n.elementGenerator;var o=n.config;if(o&&o.directory&&(this.dispatchService=o.directory.dispatchService,this.showService=o.directory.showService),this.elementsById={},this.sortedElements=[],this.elementGenerator&&(this.elementGenerator.setElementsChangedListener(function(e,t,i){r._elementsChanged(e,t,i)}),this.elementGenerator.setIntentChangedListener(function(e){r._intentChanged(e)})),this.dispatchService){var s=function(e){r._handleDispatch(e)};this.dispatchService.register(i,"modelGetInfo",s),this.dispatchService.register(i,"modelStateUpdated",s),this.dispatchService.register(i,"windowResized",s),this.dispatchService.register(i,"canvasGridRefresh",s)}this._createGrid(),t.log(this._classname,this)}catch(e){var a=new Error("Unable to create "+this._classname+": "+err);n.onError(a)}n.onSuccess()},_getElem:function(){var t=e("#"+this.canvasId);if(!(t.length<1))return t},_createGrid:function(){var t=this,i=this._getElem();i&&i.empty().addClass("n2gridcanvas").click(function(i){var n=e(i.target);n.hasClass("n2gridcanvas_cell")||n.parents(".n2gridcanvas_cell").length>0||t._backgroundClicked()}).scroll(function(){return t._scrollChanged(e(this)),!1})},_backgroundClicked:function(){this.dispatchService&&this.dispatchService.send(i,{type:"userUnselect"})},_elementsChanged:function(e,t,i){for(var n=0,r=i.length;n<r;++n){var o=i[n];delete this.elementsById[o.id]}for(n=0,r=e.length;n<r;++n){var s=e[n];this.elementsById[s.id]=s}for(n=0,r=t.length;n<r;++n){var a=t[n];this.elementsById[a.id]=a}for(var l in this.sortedElements=[],this.elementsById){var c=this.elementsById[l];this.sortedElements.push(c),void 0===c.sort&&(c.sort=c.id)}this.sortedElements.sort(function(e,t){return e.sort<t.sort?-1:e.sort>t.sort?1:0}),this._redrawGrid()},_intentChanged:function(t){var i=this;t.forEach(function(t){var n=i.canvasId+"_cell_"+t.id,r=e("#"+n);i._adjustIntent(t,r)})},_adjustIntent:function(e,t){e.n2_hovered?t.addClass("n2gridcanvas_cell_hovered"):t.removeClass("n2gridcanvas_cell_hovered"),e.n2_selected?t.addClass("n2gridcanvas_cell_selected"):t.removeClass("n2gridcanvas_cell_selected")},_redrawGrid:function(){var t=this,i=(this._getElem(),e(".n2gridcanvas"));i.empty(),this.sortedElements.forEach(function(n){var r=n.id,o=t.canvasId+"_cell_"+r,s=e("<div>").attr("id",o).addClass("n2gridcanvas_cell").attr("n2-element-id",r).appendTo(i).click(function(){var i=e(this).attr("n2-element-id");t._cellClicked(i)}).mouseover(function(){var i=e(this).attr("n2-element-id");t._cellMouseOver(i)}).mouseout(function(){var i=e(this).attr("n2-element-id");t._cellMouseOut(i)});t._adjustIntent(n,s)}),this._reloadTiles()},_cellClicked:function(e){var t=this.elementsById[e];this.toggleSelection&&this.lastElementIdSelected===e?(this.elementGenerator.selectOff(t),this.lastElementIdSelected=null):(this.elementGenerator.selectOn(t),this.lastElementIdSelected=e)},_cellMouseOver:function(e){var t=this.elementsById[e];e!==this.currentMouseOverId&&(this.currentMouseOver&&(this.elementGenerator.focusOff(this.currentMouseOverId),this.currentMouseOverId=null),this.elementGenerator.focusOn(t),this.currentMouseOverId=e)},_cellMouseOut:function(e){this.elementsById[e];e===this.currentMouseOverId&&(this.elementGenerator.focusOff(e),this.currentMouseOverId=null)},_reloadTiles:function(){var t=this,i=this._getElem(),n=i.width(),r=i.height();i.scrollTop(),i.scrollLeft();i.find(".n2gridcanvas_cell").each(function(){var i=e(this),o=i.position(),s=i.height(),a=i.width(),l=!0;o.top>r?l=!1:o.top+s<0?l=!1:o.left>n?l=!1:o.left+a<0&&(l=!1),l?i.hasClass("n2gridcanvas_cell_show")||(t._displayTile(i),i.addClass("n2gridcanvas_cell_show")):i.hasClass("n2gridcanvas_cell_show")&&i.empty().removeClass("n2gridcanvas_cell_show")})},_displayTile:function(t){var i=t.attr("n2-element-id"),n=this.elementsById[i];if(n){t.empty();var r=e("<div>").addClass("n2gridcanvas_cell_image").appendTo(t),o=e("<div>").addClass("n2gridcanvas_cell_label").appendTo(t);if(n.gridImage){var s=n.gridImage;e("<span>").attr("class","n2s_insertMediaView").attr("nunaliit-document",s.doc).attr("nunaliit-attachment",s.attachment).appendTo(r)}if(this.elementsById[i].id)e("<span>").attr("class","n2s_briefDisplay").attr("nunaliit-document",n.id).appendTo(o);this.showService.fixElementAndChildren(t)}},_scrollChanged:function(e){var t=this,i=e.scrollTop(),n=e.scrollLeft();this.lastScrollTop=i,this.lastScrollLeft=n,window.setTimeout(function(){t.lastScrollTop===i&&t.lastScrollLeft===n&&t._reloadTiles()},this.refreshIntervalInMs)},_sourceModelUpdated:function(e){this.elementGenerator.sourceModelUpdated(e)},_handleDispatch:function(e){var t=this;"modelGetInfo"===e.type?e.modelId===this.modelId&&(e.modelInfo=this._getModelInfo()):"modelStateUpdated"===e.type?this.sourceModelId===e.modelId&&e.state&&this._sourceModelUpdated(e.state):"windowResized"===e.type?window.setTimeout(function(){t._reloadTiles()},this.refreshIntervalInMs):"canvasGridRefresh"===e.type&&window.setTimeout(function(){t._reloadTiles()},this.refreshIntervalInMs)}});t.canvasGrid={GridCanvas:n,HandleCanvasAvailableRequest:function(e){"grid"===e.canvasType&&(e.isAvailable=!0)},HandleCanvasDisplayRequest:function(e){if("grid"===e.canvasType){var i={};if(e.canvasOptions)for(var r in e.canvasOptions)i[r]=e.canvasOptions[r];i.elementGenerator||(i.elementGenerator=t.canvasElementGenerator.CreateElementGenerator({type:i.elementGeneratorType,options:i.elementGeneratorOptions,config:e.config})),i.canvasId=e.canvasId,i.config=e.config,i.onSuccess=e.onSuccess,i.onError=e.onError,new n(i)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.canvasPack",n=void 0,r=t.Class({canvasId:null,interactionId:null,svgId:null,modelId:null,dispatchService:null,sourceModelId:null,moduleDisplay:null,background:null,toggleSelection:null,pack:null,line:null,styleRules:null,elementsById:null,elementGenerator:null,currentMouseOver:null,lastElementIdSelected:null,initialize:function(e){var n=t.extend({canvasId:null,interactionId:null,config:null,moduleDisplay:null,sourceModelId:null,background:null,styleRules:null,toggleSelection:!0,elementGeneratorType:"default",elementGeneratorOptions:null,elementGenerator:null,onSuccess:function(){},onError:function(e){}},e),r=this;this.canvasId=n.canvasId,this.interactionId=n.interactionId,this.moduleDisplay=n.moduleDisplay,this.sourceModelId=n.sourceModelId,this.background=n.background,this.toggleSelection=n.toggleSelection,this.elementGenerator=n.elementGenerator,this.modelId=t.getUniqueId("canvasPack"),this.styleRules=t.styleRule.loadRulesFromObject(n.styleRules);var o=n.config;if(o&&o.directory&&(this.dispatchService=o.directory.dispatchService),this.elementsById={},this.currentMouseOver=null,this.lastElementIdSelected=null,this.focusInfo=null,this.selectInfo=null,this.elementGenerator||(this.elementGenerator=t.canvasElementGenerator.CreateElementGenerator({type:n.elementGeneratorType,options:n.elementGeneratorOptions,config:n.config})),this.elementGenerator&&(this.elementGenerator.setElementsChangedListener(function(e,t,i){r._elementsChanged(e,t,i)}),this.elementGenerator.setIntentChangedListener(function(e){r._intentChanged(e)})),this.dispatchService){var s=function(e){r._handleDispatch(e)};this.dispatchService.register(i,"modelGetInfo",s),this.dispatchService.register(i,"modelStateUpdated",s)}this.createGraph();var a=this.getGraphSize();if(this.pack=d3.layout.pack().size(a).value(function(e){return e.size}).padding(25),this.line=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("basis"),n.onSuccess(),this.sourceModelId&&this.dispatchService){var l={type:"modelGetState",modelId:this.sourceModelId,state:null};this.dispatchService.synchronousCall(i,l),l.state&&this._sourceModelUpdated(l.state)}t.log("PackCanvas",this)},createGraph:function(){this.background&&"string"==typeof this.background.color&&e("#"+this.canvasId).css("background-color",this.background.color);this.svgId=t.getUniqueId();var i=n.select("#"+this.canvasId).append("svg").attr("id",this.svgId).append("g").attr("class","packRoot");i.append("g").attr("class","backnodes"),i.append("g").attr("class","links"),i.append("g").attr("class","forenodes"),this.resizeGraph()},getGraphSize:function(){var t=e("#"+this.canvasId);return[t.width(),t.height()]},resizeGraph:function(){var e=this.getGraphSize(),t=(this._getSvgElem().attr("width",e[0]).attr("height",e[1]).select("g.packRoot"),e[0]);t>e[1]&&(t=e[1]),this.canvasWidth=t,this.radius=Math.floor(t/2-120),this._documentsUpdated([],[],[])},_getSvgElem:function(){return n.select("#"+this.svgId)},_elementsChanged:function(e,i,n){for(var r in this.elementsById){delete(g=this.elementsById[r]).parent,delete g.children,delete g.size,delete g.value,delete g.depth,delete g.x,delete g.y,delete g.r}for(var o=0,s=n.length;o<s;++o){var a=n[o];delete this.elementsById[a.id]}for(o=0,s=e.length;o<s;++o){var l=e[o];this.elementsById[l.id]=l}var c={id:"__root__",name:"",children:[]};for(var r in this.elementsById){if((g=this.elementsById[r]).parentId){var d=this.elementsById[g.parentId];d&&(g.parent=d,d.children||(d.children=[]),d.children.push(g))}else null===g.parentId&&(g.parent=c,c.children.push(g))}!function e(t,i){if(t.children)for(var n=0,r=t.children.length;n<r;++n)e(t.children[n],i);else t.size=i}(c,5);var u=this.pack.nodes(c),h=[],p=[];for(o=0,s=u.length;o<s;++o){var f=u[o],m=!1;f===c||(m=!0),m&&(f.isLeaf?p.push(f):h.push(f))}var v=[];for(var r in this.elementsById){var g;(g=this.elementsById[r]).isLink&&(g.n2_geometry="line",y(g.source)&&y(g.target)?(g.path=[g.source,g.target],v.push(g),t.log("path",g,this.line(g.path))):t.log("link not in tree",g))}function y(e){return!!e&&(e===c||y(e.parent))}t.log("backnodes: "+h.length+" forenodes: "+p.length+" links: "+v.length),this._documentsUpdated(h,p,v)},_documentsUpdated:function(e,t,i){var n=this,r=this._getSvgElem().select("g.backnodes").selectAll(".backnode").data(e,function(e){return e.id});r.exit().remove(),r.enter().append("g").attr("class","backnode").on("click",function(e,t){n._initiateMouseClick(e)}).on("mouseover",function(e,t){n._initiateMouseOver(e)}).on("mouseout",function(e,t){n._initiateMouseOut(e)}).append("circle");var o=this._getSvgElem().select("g.backnodes").selectAll(".backnode").data(e,function(e){return e.id}).attr("transform",function(e){return"translate("+e.x+","+e.y+")"});o.select("circle").attr("r",function(e){return e.r}),this._adjustElementStyles(o);var s=this._getSvgElem().select("g.forenodes").selectAll(".forenode").data(t,function(e){return e.id});s.exit().remove(),s.enter().append("g").attr("class","forenode").on("click",function(e,t){n._initiateMouseClick(e)}).on("mouseover",function(e,t){n._initiateMouseOver(e)}).on("mouseout",function(e,t){n._initiateMouseOut(e)}).append("circle");var a=this._getSvgElem().select("g.forenodes").selectAll(".forenode").data(t,function(e){return e.id}).attr("transform",function(e){return"translate("+e.x+","+e.y+")"});a.select("circle").attr("r",function(e){return e.r}),this._adjustElementStyles(a);var l=this._getSvgElem().select("g.links").selectAll(".link").data(i,function(e){return e.id});l.enter().append("path").attr("class","link").on("click",function(e,t){n._initiateMouseClick(e)}).on("mouseover",function(e,t){n._initiateMouseOver(e)}).on("mouseout",function(e,t){n._initiateMouseOut(e)}),l.exit().remove();var c=this._getSvgElem().select("g.links").selectAll(".link").data(i,function(e){return e.id}).attr("d",function(e){return n.line(e.path)});this._adjustElementStyles(c)},_intentChanged:function(e){var t=this._getSvgElem().select("g.backnodes").selectAll(".backnode").data(e,function(e){return e.id});this._adjustElementStyles(t);t=this._getSvgElem().select("g.forenodes").selectAll(".forenode").data(e,function(e){return e.id});this._adjustElementStyles(t);var i=this._getSvgElem().select("g.links").selectAll(".link").data(e,function(e){return e.id});this._adjustElementStyles(i)},_adjustElementStyles:function(e){var t=this;e.each(function(e,i){e.n2_elem=this,t.styleRules.getSymbolizer(e).adjustSvgElement(this,e),delete e.n2_elem})},_dispatch:function(e){var t=this.dispatchService;t&&t.send(i,e)},_sourceModelUpdated:function(e){this.elementGenerator.sourceModelUpdated(e)},_initiateMouseClick:function(e){var t=e.id;this.toggleSelection&&this.lastElementIdSelected===t?(this.elementGenerator.selectOff(e),this.lastElementIdSelected=null):(this.elementGenerator.selectOn(e),this.lastElementIdSelected=t)},_initiateMouseOver:function(e){var t=e.id;t!==this.currentMouseOver&&(this.currentMouseOver&&(this.elementGenerator.focusOff(this.currentMouseOver),this.currentMouseOver=null),this.elementGenerator.focusOn(e),this.currentMouseOver=t)},_initiateMouseOut:function(e){e.id===this.currentMouseOver&&(this.elementGenerator.focusOff(e),this.currentMouseOver=null)},_handleDispatch:function(e){"modelGetInfo"===e.type?e.modelId===this.modelId&&(e.modelInfo=this._getModelInfo()):"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&e.state&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){return{modelId:this.modelId,modelType:"packCanvas",parameters:[]}}});t.canvasPack={PackCanvas:r,HandleCanvasAvailableRequest:function(e){!n&&window&&(n=window.d3),"pack"===e.canvasType&&(n?e.isAvailable=!0:t.log("Canvas pack requires d3 library"))},HandleCanvasDisplayRequest:function(e){if("pack"===e.canvasType){var t={};if(e.canvasOptions)for(var i in e.canvasOptions)t[i]=e.canvasOptions[i];t.canvasId=e.canvasId,t.interactionId=e.interactionId,t.config=e.config,t.moduleDisplay=e.moduleDisplay,t.onSuccess=e.onSuccess,t.onError=e.onError,new r(t)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.canvasTree",n=void 0,r=t.Class({canvasId:null,interactionId:null,svgId:null,modelId:null,dispatchService:null,sourceModelId:null,moduleDisplay:null,background:null,toggleSelection:null,margin:null,layoutStyle:null,treeLayout:null,diagonalLine:null,styleRules:null,elementsById:null,elementGenerator:null,currentMouseOver:null,lastElementIdSelected:null,initialize:function(e){var n=t.extend({canvasId:null,interactionId:null,config:null,moduleDisplay:null,sourceModelId:null,background:null,styleRules:null,layoutStyle:"tree",toggleSelection:!0,elementGeneratorType:"default",elementGeneratorOptions:null,elementGenerator:null,onSuccess:function(){},onError:function(e){}},e),r=this;this.canvasId=n.canvasId,this.interactionId=n.interactionId,this.moduleDisplay=n.moduleDisplay,this.sourceModelId=n.sourceModelId,this.background=n.background,this.layoutStyle=n.layoutStyle,this.toggleSelection=n.toggleSelection,this.elementGenerator=n.elementGenerator,this.modelId=t.getUniqueId("canvasTree"),this.styleRules=t.styleRule.loadRulesFromObject(n.styleRules);var o=n.config;if(o&&o.directory&&(this.dispatchService=o.directory.dispatchService),this.elementsById={},this.currentMouseOver=null,this.lastElementIdSelected=null,this.focusInfo=null,this.selectInfo=null,this.margin=10,this.elementGenerator||(this.elementGenerator=t.canvasElementGenerator.CreateElementGenerator({type:n.elementGeneratorType,options:n.elementGeneratorOptions,config:n.config})),this.elementGenerator&&(this.elementGenerator.setElementsChangedListener(function(e,t,i){r._elementsChanged(e,t,i)}),this.elementGenerator.setIntentChangedListener(function(e){r._intentChanged(e)})),this.dispatchService){var s=function(e){r._handleDispatch(e)};this.dispatchService.register(i,"modelGetInfo",s),this.dispatchService.register(i,"modelStateUpdated",s)}this.createGraph();var a=this.getGraphSize();if(a[0]=a[0]-2*this.margin,a[1]=a[1]-2*this.margin,"cluster"===this.layoutStyle?this.treeLayout=d3.layout.cluster().sort(function(e,t){return d3.ascending(e.sortValue,t.sortValue)}).size(a):this.treeLayout=d3.layout.tree().sort(function(e,t){return d3.ascending(e.sortValue,t.sortValue)}).size(a),this.diagonalLine=d3.svg.diagonal(),n.onSuccess(),this.sourceModelId&&this.dispatchService){var l={type:"modelGetState",modelId:this.sourceModelId,state:null};this.dispatchService.synchronousCall(i,l),l.state&&this._sourceModelUpdated(l.state)}t.log("TreeCanvas",this)},createGraph:function(){var i=this;this.background&&"string"==typeof this.background.color&&e("#"+this.canvasId).css("background-color",this.background.color);this.svgId=t.getUniqueId();var r=n.select("#"+this.canvasId).append("svg").attr("id",this.svgId).append("g").attr("class","packRoot");r.append("rect").attr("x",0).attr("y",0).attr("fill-opacity",0).classed({n2CanvasTree_background:!0}).on("click",function(){i._backgroundClicked()}),r.append("g").attr("class","links"),r.append("g").attr("class","nodes"),r.append("g").attr("class","labels"),this.resizeGraph()},getGraphSize:function(){var t=e("#"+this.canvasId);return[t.width(),t.height()]},resizeGraph:function(){var e=this.getGraphSize(),t=this._getSvgElem().attr("width",e[0]).attr("height",e[1]);t.select(".n2CanvasTree_background").attr("width",e[0]).attr("height",e[1]);t.select("g.packRoot");var i=e[0];i>e[1]&&(i=e[1]),this.canvasWidth=i,this.radius=Math.floor(i/2-120),this._documentsUpdated([],[])},_getSvgElem:function(){return n.select("#"+this.svgId)},_elementsChanged:function(e,i,n){for(var r=this,o=0,s=n.length;o<s;++o){var a=n[o];this.elementsById[a.id]&&(delete this.elementsById[a.id].parent,delete this.elementsById[a.id].children,delete this.elementsById[a.id])}for(o=0,s=e.length;o<s;++o){var l=e[o];this.elementsById[l.id]=l}for(var c in this.elementsById){delete(g=this.elementsById[c]).parent,delete g.children,delete g.depth,delete g.x,delete g.y}var d={id:"__root__",name:"",children:[]},u=[];for(var c in this.elementsById){if((g=this.elementsById[c]).isNode){if(g.parentId){var h=this.elementsById[g.parentId];h&&(g.parent=h,h.children||(h.children=[]),h.children.push(g))}g.parent||(g.parent=d,d.children.push(g)),g.n2_geometry="point",u.push(g)}}var p=0,f=0;for(o=0,s=u.length;o<s;++o){var m=u[o];m.parentId&&(++p,m.parent&&++f)}t.log("nodes: "+u.length+" root children: "+d.children.length+" nested: "+f+" parent id: "+p),(u=this.treeLayout.nodes(d)).forEach(function(e){e.x=e.x+r.margin,e.y=e.y+r.margin});var v=[];for(var c in this.elementsById){var g;(g=this.elementsById[c]).isLink&&(g.n2_geometry="line",v.push(g))}this._documentsUpdated(u,v)},_intentChanged:function(e){for(var t=[],i=[],n=0,r=e.length;n<r;++n){var o=e[n];o.isNode?t.push(o):o.isLink&&i.push(o)}var s=this._getSvgElem().select("g.nodes").selectAll(".node").data(t,function(e){return e.id});this._adjustElementStyles(s);var a=this._getSvgElem().select("g.links").selectAll(".link").data(i,function(e){return e.id});this._adjustElementStyles(a);var l=this._getSvgElem().select("g.labels").selectAll(".label").data(t,function(e){return e.id});this._adjustElementStyles(l)},_documentsUpdated:function(e,t){var i=this,n=this._getSvgElem().select("g.nodes").selectAll(".node").data(e,function(e){return e.id});n.transition().attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),n.exit().remove(),n.enter().append("circle").attr("class","node").attr("r",5).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});var r=this._getSvgElem().select("g.nodes").selectAll(".node").data(e,function(e){return e.id});this._adjustElementStyles(r);var o=this._getSvgElem().select("g.links").selectAll(".link").data(t,function(e){return e.id});o.transition().attr("d",this.diagonalLine),o.exit().remove(),o.enter().append("path").attr("class","link").attr("d",this.diagonalLine).attr("fill","none").attr("stroke","#000000").attr("stroke-width",1).attr("stroke-opacity",1).on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});var s=this._getSvgElem().select("g.links").selectAll(".link").data(t,function(e){return e.id});this._adjustElementStyles(s),this._getSvgElem().select("g.labels").selectAll(".label").data(e,function(e){return e.id}).enter().append(function(){return this.ownerDocument.createElementNS(this.namespaceURI,"text")}).attr("class","label").attr("x",function(e){return e.x}).attr("y",function(e){return e.y}).text(function(e){return""}).on("click",function(e,t){i._initiateMouseClick(e)}).on("mouseover",function(e,t){i._initiateMouseOver(e)}).on("mouseout",function(e,t){i._initiateMouseOut(e)});var a=this._getSvgElem().select("g.labels").selectAll(".label").data(e,function(e){return e.id});this._adjustElementStyles(a)},_adjustElementStyles:function(e){var t=this;e.each(function(e,i){e.n2_elem=this,t.styleRules.getSymbolizer(e).adjustSvgElement(this,e),delete e.n2_elem})},_dispatch:function(e){var t=this.dispatchService;t&&t.send(i,e)},_sourceModelUpdated:function(e){this.elementGenerator.sourceModelUpdated(e)},_initiateMouseClick:function(e){var t=e.id;this.toggleSelection&&this.lastElementIdSelected===t?(this.elementGenerator.selectOff(e),this.lastElementIdSelected=null):(this.elementGenerator.selectOn(e),this.lastElementIdSelected=t)},_initiateMouseOver:function(e){var t=e.id;t!==this.currentMouseOver&&(this.currentMouseOver&&(this.elementGenerator.focusOff(this.currentMouseOver),this.currentMouseOver=null),this.elementGenerator.focusOn(e),this.currentMouseOver=t)},_initiateMouseOut:function(e){e.id===this.currentMouseOver&&(this.elementGenerator.focusOff(e),this.currentMouseOver=null)},_backgroundClicked:function(){this._dispatch({type:"userUnselect"})},_handleDispatch:function(e){"modelGetInfo"===e.type?e.modelId===this.modelId&&(e.modelInfo=this._getModelInfo()):"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&e.state&&this._sourceModelUpdated(e.state)},_getModelInfo:function(){return{modelId:this.modelId,modelType:"treeCanvas",parameters:[]}}});t.canvasTree={TreeCanvas:r,HandleCanvasAvailableRequest:function(e){!n&&window&&(n=window.d3),"tree"===e.canvasType&&(n?e.isAvailable=!0:t.log("Canvas tree requires d3 library"))},HandleCanvasDisplayRequest:function(e){if("tree"===e.canvasType){var t={};if(e.canvasOptions)for(var i in e.canvasOptions)t[i]=e.canvasOptions[i];t.canvasId=e.canvasId,t.interactionId=e.interactionId,t.config=e.config,t.moduleDisplay=e.moduleDisplay,t.onSuccess=e.onSuccess,t.onError=e.onError,new r(t)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.canvasCustomHTML",r=t.Class({canvasId:null,interactionId:null,dispatchService:null,showService:null,moduleDisplay:null,intentView:null,nodesById:null,initialize:function(n){var r=t.extend({canvasId:null,interactionId:null,config:null,moduleDisplay:null,htmlAttachment:null,cssAttachment:null,elemIdToDocId:null,onSuccess:function(){},onError:function(e){}},n),o=this;this.canvasId=r.canvasId,this.interactionId=r.interactionId,this.moduleDisplay=r.moduleDisplay;var s=r.config;if(s&&s.directory&&(this.dispatchService=s.directory.dispatchService,this.showService=s.directory.showService),this.nodesById={},"object"==typeof r.elemIdToDocId)for(var a in r.elemIdToDocId){var l={n2_id:r.elemIdToDocId[a],nodeId:a};this.nodesById[a]=l}if(this.dispatchService&&(this.intentView=new t.userIntentView.IntentView({dispatchService:this.dispatchService}),this.intentView.addListener(function(e){o._intentChanged(e)})),this.dispatchService,r.cssAttachment){var c=this._computeAttachmentUrl(r.cssAttachment);c?e.ajax({url:c,type:"get",async:!0,dataType:"text",success:function(e){d(e)},error:function(e,t,n){r.onError(i("Error loading CSS from location: {url}",{url:c}))}}):r.onError(i("Location of CSS is undefined for customHtml canvas"))}else d(void 0);function d(t){if(r.htmlAttachment){var n=o._computeAttachmentUrl(r.htmlAttachment);n?e.ajax({url:n,type:"get",async:!0,dataType:"html",success:function(e){r.onSuccess(),o._renderHtmlDocument(e,t)},error:function(e,t,o){r.onError(i("Error loading HTML from location: {url}",{url:n}))}}):r.onError(i("Location of HTML is undefined for customHtml canvas"))}else r.onError(i("A HTML file must be specified for the customHtml canvas"))}t.log("CustomHtmlCanvas",this)},_handleDispatch:function(e){},_renderHtmlDocument:function(i,n){var r=this;t.log("custom html loaded");var o=e("#"+this.canvasId).html(i);if(o.children().css("width","100%").css("height","100%").css("position","absolute").css("left","0").css("top","0"),n){var s=o.find("html");s.length<1&&(s=e("html"));var a=s.find("head");if(a.length<1&&(a=e("<head>").prependTo(s)),a.length>0){var l=e("<style>").attr("type","text/css").text(n);a.first().append(l)}}for(var c in o.find("img").each(function(){var t=e(this),i=t.attr("src");if(i){var n=r._computeAttachmentUrl(i);t.attr("src",n)}}),this.nodesById){var d=(h=this.nodesById[c]).n2_id;e("#"+c).attr("n2-doc-id",d).mouseover(function(t){r._mouseOver(e(this),t)}).mouseout(function(t){r._mouseOut(e(this),t)}).click(function(t){r._mouseClick(e(this),t)})}o.find(".n2canvas_linkDocId").each(function(){var i=e(this),n=i.attr("id");n||(n=t.getUniqueId(),i.attr("id",n));var o=i.attr("n2-doc-id");if(o){var s={n2_id:o,nodeId:n};r.nodesById[n]=s,i.mouseover(function(t){r._mouseOver(e(this),t)}).mouseout(function(t){r._mouseOut(e(this),t)}).click(function(t){r._mouseClick(e(this),t)})}i.removeClass("n2canvas_linkDocId").addClass("n2canvas_linkedDocId")});var u=[];for(var c in this.nodesById){var h=this.nodesById[c];u.push(h)}this.intentView.addNodes(u),this._intentChanged(u),o.find(".n2canvas_unselect").each(function(){e(this).click(function(t){r._mouseUnselect(e(this),t)}).removeClass("n2canvas_unselect").addClass("n2canvas_unselected")}),this.showService&&this.showService.fixElementAndChildren(o,{},void 0)},_mouseOver:function(e,t){var i=e.attr("n2-doc-id");i&&this.dispatchService&&this.dispatchService.send(n,{type:"userFocusOn",docId:i})},_mouseOut:function(e,t){var i=e.attr("n2-doc-id");i&&this.dispatchService&&this.dispatchService.send(n,{type:"userFocusOff",docId:i})},_mouseClick:function(e,t){var i=e.attr("n2-doc-id");i&&this.dispatchService&&this.dispatchService.send(n,{type:"userSelect",docId:i}),t.stopPropagation()},_mouseUnselect:function(e,t){this.dispatchService.send(n,{type:"userUnselect"})},_intentChanged:function(t){for(var i=0,n=t.length;i<n;++i){var r=t[i],o=e("#"+r.nodeId);r.n2_hovered?o.addClass("n2canvas_hovered"):o.removeClass("n2canvas_hovered"),r.n2_selected?o.addClass("n2canvas_selected"):o.removeClass("n2canvas_selected"),r.n2_selected&&r.n2_hovered?o.addClass("n2canvas_selectedHovered"):o.removeClass("n2canvas_selectedHovered")}},_computeAttachmentUrl:function(e){var t=void 0;return this.moduleDisplay&&this.moduleDisplay.module&&(t=this.moduleDisplay.module.getAttachmentUrl(e)),t}});t.canvasCustomHtml={CustomHtmlCanvas:r,HandleCanvasAvailableRequest:function(e){"customHtml"===e.canvasType&&(e.isAvailable=!0)},HandleCanvasDisplayRequest:function(e){if("customHtml"===e.canvasType){var t={};if(e.canvasOptions)for(var i in e.canvasOptions)t[i]=e.canvasOptions[i];t.canvasId=e.canvasId,t.interactionId=e.interactionId,t.config=e.config,t.moduleDisplay=e.moduleDisplay,t.onSuccess=e.onSuccess,t.onError=e.onError,new r(t)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.canvasCustomSVG",r=void 0,o=t.Class({canvasId:null,interactionId:null,canvasName:null,dispatchService:null,moduleDisplay:null,intentView:null,nodesById:null,initialize:function(n){var r=t.extend({canvasId:null,interactionId:null,canvasName:null,config:null,moduleDisplay:null,svgAttachment:null,cssAttachment:null,elemIdToDocId:null,unselectIds:null,onSuccess:function(){},onError:function(e){}},n),o=this;this.canvasId=r.canvasId,this.interactionId=r.interactionId,this.canvasName=r.canvasName,this.moduleDisplay=r.moduleDisplay;var s=r.config;if(s&&s.directory&&(this.dispatchService=s.directory.dispatchService),this.nodesById={},"object"==typeof r.elemIdToDocId)for(var a in r.elemIdToDocId){var l={n2_id:r.elemIdToDocId[a],nodeId:a};this.nodesById[a]=l}if(t.isArray(r.unselectIds))for(var c=0,d=r.unselectIds.length;c<d;++c){l={nodeId:a=r.unselectIds[c],unselect:!0};this.nodesById[a]=l}if(this.dispatchService&&(this.intentView=new t.userIntentView.IntentView({dispatchService:this.dispatchService}),this.intentView.addListener(function(e){o._intentChanged(e)})),this.dispatchService,r.cssAttachment){var u=this._computeAttachmentUrl(r.cssAttachment);u?e.ajax({url:u,type:"get",async:!0,dataType:"text",success:function(e){h(e)},error:function(e,t,n){r.onError(i("Error loading CSS from location: {url}",{url:u}))}}):r.onError(i("Location of CSS is undefined for customSvg canvas"))}else h(void 0);function h(t){if(r.svgAttachment){var n=o._computeAttachmentUrl(r.svgAttachment);n?e.ajax({url:n,type:"get",async:!0,dataType:"xml",success:function(e){r.onSuccess(),o._renderSvgDocument(e,t)},error:function(e,t,o){r.onError(i("Error loading SVG from location: {url}",{url:n}))}}):r.onError(i("Location of SVG is undefined for customSvg canvas"))}else r.onError(i("A SVG file must be specified for the customSvg canvas"))}t.log("CustomSvgCanvas",this)},_handleDispatch:function(e){},_renderSvgDocument:function(i,n){var o=this;if(t.log("custom svg loaded"),e("#"+this.canvasId).empty().append(i.documentElement),r.select("#"+this.canvasId).selectAll("svg").attr("width","100%").attr("height","100%").attr("preserveAspectRatio","xMidYMid meet"),n){var s=e("#"+this.canvasId).find("style");if(s.length>0)s.append(n);else{var a=e("#"+this.canvasId).children("svg");a.length>0&&e("<style>").attr("type","text/css").text(n).prependTo(a)}}for(var l in r.select("#"+this.canvasId).selectAll("image").each(function(){var e=r.select(this),t=e.attr("xlink:href");if(t){var i=o._computeAttachmentUrl(t);e.attr("xlink:href",i)}}),this.nodesById){if((u=this.nodesById[l]).n2_id){var c=u.n2_id;r.select("#"+l).attr("n2-doc-id",c).on("mouseover",function(e,t){o._mouseOver(r.select(this),r.event)}).on("mouseout",function(e,t){o._mouseOut(r.select(this),r.event)}).on("click",function(e,t){o._mouseClick(r.select(this),r.event)})}else u.unselect&&r.select("#"+l).on("click",function(e,t){o._mouseUnselect(r.select(this),r.event)})}r.select("#"+this.canvasId).selectAll(".n2canvas_linkDocId").each(function(){var e=r.select(this),i=e.attr("id");i||(i=t.getUniqueId(),e.attr("id",i));var n=e.attr("n2-doc-id");if(n){var s={n2_id:n,nodeId:i};o.nodesById[i]=s,e.on("mouseover",function(e,t){o._mouseOver(r.select(this),r.event)}).on("mouseout",function(e,t){o._mouseOut(r.select(this),r.event)}).on("click",function(e,t){o._mouseClick(r.select(this),r.event)})}e.classed({n2canvas_linkDocId:!1,n2canvas_linkedDocId:!0})});var d=[];for(var l in this.nodesById){var u=this.nodesById[l];d.push(u)}this.intentView.addNodes(d),this._intentChanged(d),r.select("#"+this.canvasId).selectAll(".n2canvas_unselect").each(function(){r.select(this).on("click",function(e,t){o._mouseUnselect(r.select(this),r.event)}).classed({n2canvas_unselect:!1,n2canvas_unselected:!0})})},_mouseOver:function(e,t){var i=e.attr("n2-doc-id");i&&this.dispatchService&&this.dispatchService.send(n,{type:"userFocusOn",docId:i,_source:this.canvasName})},_mouseOut:function(e,t){var i=e.attr("n2-doc-id");i&&this.dispatchService&&this.dispatchService.send(n,{type:"userFocusOff",docId:i,_source:this.canvasName})},_mouseClick:function(e,t){var i=e.attr("n2-doc-id");i&&this.dispatchService&&this.dispatchService.send(n,{type:"userSelect",docId:i,_source:this.canvasName}),t.stopPropagation()},_mouseUnselect:function(e,t){this.dispatchService.send(n,{type:"userUnselect",_source:this.canvasName})},_intentChanged:function(e){for(var t=0,i=e.length;t<i;++t){var n=e[t];r.select("#"+n.nodeId).classed({n2canvas_hovered:n.n2_hovered,n2canvas_selected:n.n2_selected,n2canvas_selectedHovered:n.n2_selected&&n.n2_hovered})}},_computeAttachmentUrl:function(e){var t=void 0;return this.moduleDisplay&&this.moduleDisplay.module&&(t=this.moduleDisplay.module.getAttachmentUrl(e)),t}});t.canvasCustomSvg={CustomSvgCanvas:o,HandleCanvasAvailableRequest:function(e){!r&&window&&(r=window.d3),"customSvg"===e.canvasType&&(r?e.isAvailable=!0:t.log("Canvas customSvg requires d3 library"))},HandleCanvasDisplayRequest:function(e){if("customSvg"===e.canvasType&&r){var t={};if(e.canvasOptions)for(var i in e.canvasOptions)t[i]=e.canvasOptions[i];t.canvasId=e.canvasId,t.interactionId=e.interactionId,t.config=e.config,t.moduleDisplay=e.moduleDisplay,t.onSuccess=e.onSuccess,t.onError=e.onError,new o(t)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.canvasReferenceBrowser",r=t.Class({canvasId:null,atlasDesign:null,schemaRepository:null,showService:null,dispatchService:null,docsById:null,briefsById:null,schemaNames:null,schemaLabelByName:null,sortingSchemaNames:null,refs:null,initialize:function(e){var r=t.extend({canvasId:null,config:null,schemaNames:null,onSuccess:function(){},onError:function(e){}},e),o=this;if(this.canvasId=r.canvasId,this.docsById={},this.briefsById={},this.schemaLabelByName={},this.refs=[],this.schemaNames=r.schemaNames,this.sortingSchemaNames=this.schemaNames.slice(),r.config&&(this.atlasDesign=r.config.atlasDesign,r.config.directory&&(this.schemaRepository=r.config.directory.schemaRepository,this.showService=r.config.directory.showService,this.dispatchService=r.config.directory.dispatchService)),this.dispatchService){var s=function(e,t,i){o._handle(e,t,i)};this.dispatchService.register(n,"documentContent",s),this.dispatchService.register(n,"documentContentCreated",s),this.dispatchService.register(n,"documentContentUpdated",s),this.dispatchService.register(n,"documentDeleted",s)}r.onSuccess(),this._display(),this._loadDocs(),this.schemaRepository&&this.schemaRepository.getSchemas({names:this.schemaNames,onSuccess:function(e){e.forEach(function(e){var t=e.name;e.label&&(t=i(e.label)),o.schemaLabelByName[e.name]=t}),o._display()}})},_getElem:function(){var t=e("#"+this.canvasId);if(!(t.length<1))return t},_display:function(){var t=this,i=this._getElem();if(i){i.empty().addClass("n2ReferenceBrowserCanvas").click(function(e){t._backgroundClicked()}),e("<button>").text("Export CSV").appendTo(i).click(function(){return t._exportCsv(),!1});for(var n=e("<table>").appendTo(i),r=e("<tr>").appendTo(n),o=0,s=t.schemaNames.length;o<s;++o){var a=t.schemaNames[o],l=t.schemaLabelByName[a];l||(l=a);var c=e("<th>").appendTo(r);e("<a>").text(l).attr("href","#").attr("data-schema-name",a).appendTo(c).click(function(){var i=e(this).attr("data-schema-name");return t._sortOnCriteria(i),!1})}for(o=0,s=t.refs.length;o<s;++o)for(var d=t.refs[o],u=(r=e("<tr>").appendTo(n),0),h=t.schemaNames.length;u<h;++u){var p=d[a=t.schemaNames[u]];if(p){var f=p.display,m=p.id,v=t.docsById[m],g=e("<td>").appendTo(r),y=e("<a>").text(f).attr("href","#").attr("n2-doc-id",m).appendTo(g).click(function(){var i=e(this).attr("n2-doc-id");return t._select(i),!1});t.showService&&v&&t.showService.displayBriefDescription(y,{},v)}else e("<td>").appendTo(r)}}},_backgroundClicked:function(){this.dispatchService&&this.dispatchService.send(n,{type:"userUnselect"})},_loadDocs:function(){var e=this;function i(){e._computeReferences(),e._display()}this.atlasDesign.queryView({viewName:"nunaliit-schema",keys:this.schemaNames,include_docs:!0,onSuccess:function(t){for(var n=!1,r=0,o=t.length;r<o;++r){var s=t[r].doc,a=s._id;e.docsById[a]=s,e.briefsById[a]&&delete e.briefsById[a],n=!0}n&&e._computeSortValues({onSuccess:i})},onError:function(e){t.reportErrorForced(e)}})},_computeReferences:function(){var e={};for(var i in this.docsById){var n=this.docsById[i],r=[];t.couchUtils.extractLinks(n,r);for(var o=0,s=r.length;o<s;++o){var a=r[o];if(a&&a.doc){var l=a.doc;if(this.docsById[l]){var c=i,d=l;d<c&&(c=l,d=i),e[c]||(e[c]={}),e[c][d]=!0}}}}var u=[];for(var h in e){var p=e[h];for(var f in p){var m=this.docsById[h],v=this.docsById[f],g=m.nunaliit_schema,y=v.nunaliit_schema,_=this.briefsById[h],S=this.briefsById[f],b={};b[g]={id:h,display:_},b[y]={id:f,display:S},u.push(b)}}this.refs=u,this._sortReferences()},_sortOnCriteria:function(e){var t=this.sortingSchemaNames.indexOf(e);t>=0&&(this.sortingSchemaNames.splice(t,1),this.sortingSchemaNames.unshift(e),this._sortReferences(),this._display())},_sortReferences:function(){var e=this;this.refs.sort(function(t,i){for(var n=0,r=e.sortingSchemaNames.length;n<r;++n){var o=e.sortingSchemaNames[n],s=t[o],a=i[o];if(s&&a){var l=s.display,c=a.display;if(l<c)return-1;if(l>c)return 1}else{if(s)return-1;if(a)return 1}}return 0})},_computeSortValues:function(i){var n=t.extend({onSuccess:function(){}},i),r=this;this.schemaRepository.getSchemas({names:this.schemaNames,onSuccess:function(t){for(var i={},o=0,s=t.length;o<s;++o){i[(d=t[o]).name]=d}for(var a in r.docsById){var l=r.docsById[a],c=r.briefsById[a];if(!c){var d;if(d=i[l.nunaliit_schema]){var u=e("<div>");d.brief(l,u),c=u.text()}else c=l._id;r.briefsById[a]=c}}n.onSuccess()}})},_select:function(e){var t=this.docsById[e];this.dispatchService&&this.dispatchService.send(n,{type:"userSelect",docId:e,doc:t})},_addDocument:function(e){var t=this,i=e._id,n=!1;this.docsById[i]?this.docsById[i]._rev!==e._rev&&(this.docsById[i]=e,delete this.briefsById[i],n=!0):(this.docsById[i]=e,n=!0),n&&this._computeSortValues({onSuccess:function(){t._computeReferences(),t._display()}})},_deleteDocument:function(e){this.docsById[e]&&(delete this.docsById[e],delete this.briefsById[e],this._computeReferences(),this._display())},_handle:function(e,t,i){if("documentContent"===e.type||"documentContentCreated"===e.type||"documentContentUpdated"===e.type){var n=e.doc;if(n){var r=n.nunaliit_schema;if(this.schemaNames.indexOf(r)<0){var o=n._id;this._deleteDocument(o)}else this._addDocument(n)}}else if("documentDeleted"===e.type){o=e.docId;this._deleteDocument(o)}},_computeCsvContent:function(){var e=[],i=[];e.push(i);for(var n=0,r=this.schemaNames.length;n<r;++n){var o=this.schemaNames[n];i.push(o+"(docId)"),i.push(o+"(description)")}for(n=0,r=this.refs.length;n<r;++n){var s=this.refs[n],a=[];e.push(a);for(var l=0,c=this.schemaNames.length;l<c;++l){var d=s[o=this.schemaNames[l]];if(d){var u=d.display,h=d.id;a.push(h),a.push(u)}else a.push(""),a.push("")}}return t.csv.ValueTableToCsvString(e)},_exportCsv:function(){var n=this._computeCsvContent();if("undefined"!=typeof Blob&&"function"==typeof saveAs){var r=new Blob([n],{type:"text/plain;charset="+document.characterSet});saveAs(r,"references.csv")}else{var o=e("<div>").addClass("n2canvasReferenceBrowser_exportCsv_dialog"),s=t.utils.getElementIdentifier(o);e("<textarea>").addClass("n2canvasReferenceBrowser_exportCsv_text").text(n).appendTo(o),o.dialog({autoOpen:!0,title:i("References"),modal:!0,width:370,close:function(t,i){var n=e("#"+s);n.dialog("destroy"),n.remove()}})}}});t.canvasReferenceBrowser={ReferenceBrowserCanvas:r,HandleCanvasAvailableRequest:function(e){"referenceBrowser"===e.canvasType&&(e.isAvailable=!0)},HandleCanvasDisplayRequest:function(e){if("referenceBrowser"===e.canvasType){var t={};if(e.canvasOptions)for(var i in e.canvasOptions)t[i]=e.canvasOptions[i];t.canvasId=e.canvasId,t.interactionId=e.interactionId,t.config=e.config,t.moduleDisplay=e.moduleDisplay,t.onSuccess=e.onSuccess,t.onError=e.onError,new r(t)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.canvasTable";function r(e){e.getValue=r.getValue,e.getSortValue=r.getSortValue,e.getExportValue=r.getExportValue}function o(e){if(e.getCell=o.getCell,e.getValue=o.getValue,e.getSortValue=o.getSortValue,e.getExportValue=o.getExportValue,e.getRowName=o.getRowName,e.isRowElement=!0,e.cells)for(var t in e.cells){var i=e.cells[t];r(i),i.fragments||(i.fragments=e.fragments)}}function s(e){e.getValue=s.getValue,e.getSortValue=s.getSortValue,e.getExportValue=s.getExportValue,e.isCellElement=!0}function a(e){e.addCell=a.addCell,e.getCell=a.getCell,e.getValue=a.getValue,e.getSortValue=a.getSortValue,e.getExportValue=a.getExportValue,e.getRowName=a.getRowName,e.cells||(e.cells={})}r.getValue=function(e){return"function"==typeof this.value?this.value(this,e):this.value},r.getSortValue=function(e){var t=this.sortValue;return void 0===t&&(t=this.getValue(e)),t},r.getExportValue=function(e){return"function"==typeof this.exportValue?this.exportValue(this,e):void 0!==this.exportValue?this.exportValue:this.getValue(e)},o.getCell=function(e){return this.cells?this.cells[e]:void 0},o.getValue=function(e){var t=this.getCell(e);return t?t.getValue(this):void 0},o.getSortValue=function(e){var t=this.getCell(e);return t?t.getSortValue(this):void 0},o.getExportValue=function(e){var t=this.getCell(e);return t?t.getExportValue(this):void 0},o.getRowName=function(){return this.id},s.getValue=function(e){return"function"==typeof this.value?this.value(this,e):this.value},s.getSortValue=function(e){var t=this.sortValue;return void 0===t&&(t=this.getValue(e)),t},s.getExportValue=function(e){return"function"==typeof this.exportValue?this.exportValue(this,e):void 0!==this.exportValue?this.exportValue:this.getValue(e)},a.addCell=function(e){var t=e.column;this.cells[t]=e},a.getCell=function(e){return this.cells?this.cells[e]:void 0},a.getValue=function(e){var t=this.getCell(e);return t?t.getValue(this):void 0},a.getSortValue=function(e){var t=this.getCell(e);return t?t.getSortValue(this):void 0},a.getExportValue=function(e){var t=this.getCell(e);return t?t.getExportValue(this):void 0},a.getRowName=function(){return this.rowName};var l=t.Class({canvasId:null,sourceModelId:null,elementGenerator:null,dispatchService:null,showService:null,elementsById:null,rowsByName:null,sortedRows:null,headings:null,sortOrder:null,styleRules:null,useLazyDisplay:null,refreshIntervalInMs:null,initialize:function(e){var i=t.extend({canvasId:null,sourceModelId:null,elementGenerator:null,useLazyDisplay:!1,refreshIntervalInMs:200,styleRules:null,dispatchService:null,showService:null,sortOrder:null,onSuccess:function(){},onError:function(e){}},e),r=this;if(this.canvasId=i.canvasId,this.sourceModelId=i.sourceModelId,this.elementGenerator=i.elementGenerator,this.useLazyDisplay=i.useLazyDisplay,this.refreshIntervalInMs=i.refreshIntervalInMs,this.dispatchService=i.dispatchService,this.showService=i.showService,this.sortOrder=[],"string"==typeof i.sortOrder)this.sortOrder.push({name:i.sortOrder,direction:1});else if(t.isArray(i.sortOrder))for(var o=0,s=i.sortOrder.length;o<s;++o){var a=i.sortOrder[o];"string"==typeof a?this.sortOrder.push({name:a,direction:1}):"object"==typeof a&&"string"==typeof a.name&&("number"!=typeof a.direction&&(a.direction=1),this.sortOrder.push(a))}else i.sortOrder&&"object"==typeof i.sortOrder&&"string"==typeof i.sortOrder.name&&("number"!=typeof i.sortOrder.direction&&(i.sortOrder.direction=1),this.sortOrder.push(i.sortOrder));if(this.elementsById={},this.rowsByName={},this.sortedRows=[],this.headings=[],this.styleRules=t.styleRule.loadRulesFromObject(i.styleRules),this.elementGenerator&&(this.elementGenerator.setElementsChangedListener(function(e,t,i){r._elementsChanged(e,t,i)}),this.elementGenerator.setIntentChangedListener(function(e){r._intentChanged(e)})),this.dispatchService){var l=function(e){r._handleDispatch(e)};this.dispatchService.register(n,"modelGetInfo",l),this.dispatchService.register(n,"modelStateUpdated",l)}if(this.createGraph(),i.onSuccess(),this.sourceModelId&&this.dispatchService){var c={type:"modelGetState",modelId:this.sourceModelId,state:null};this.dispatchService.synchronousCall(n,c),c.state&&this._sourceModelUpdated(c.state)}t.log("TableCanvas",this)},_getElem:function(){var t=e("#"+this.canvasId);if(!(t.length<1))return t},createGraph:function(){var t=this,i=this._getElem();if(i){i.empty().addClass("n2TableCanvas").click(function(e){t._backgroundClicked()}),e("<button>").text("Export CSV").appendTo(i).click(function(){return t._exportCsv(),!1});var n=e("<table>").appendTo(i);e("<tbody>").appendTo(n).scroll(function(){return t._scrollChanged(e(this)),!0})}},_backgroundClicked:function(){this.dispatchService&&this.dispatchService.send(n,{type:"userUnselect"})},_scrollChanged:function(e){if(this.useLazyDisplay){var t=this,i=e.scrollTop();this.lastScrollTop=i,window.setTimeout(function(){t.lastScrollTop===i&&t._refreshRows()},this.refreshIntervalInMs)}},_elementsChanged:function(e,t,i){for(var n=this,r=0,l=i.length;r<l;++r){var c=i[r];delete this.elementsById[c.id]}for(r=0,l=e.length;r<l;++r){var d=e[r];d.isHeader?y(d):d.cells?(this.elementsById[d.id]=d,o(d)):d.row&&d.column&&(this.elementsById[d.id]=d,s(d))}for(r=0,l=t.length;r<l;++r){var u=t[r];u.isHeader?y(u):u.cells?(this.elementsById[u.id]=u,o(u)):u.row&&u.column&&(this.elementsById[u.id]=u,s(u))}var h=[],p={};for(var f in this.elementsById){var m=this.elementsById[f];if(m.cells)h.push(m),p[m.getRowName()]=m;else if(m.row&&m.column){var v=m.row,g=p[v];g||(a(g={rowName:v}),p[v]=g,h.push(g)),g.addCell(m)}}function y(e){e.columns&&(n.headings=e.columns)}this._sortRows(h),this.sortedRows=h,this.rowsByName=p,this._redraw()},_redraw:function(){var n=this,r=this._getElem().find("tbody");r.empty();var o=e("<tr>").appendTo(r);this.headings.forEach(function(t){var r=i(t.label);r||(r=t.name);var s=e("<th>").appendTo(o),a=e("<a>").attr("href","#").attr("data-sort-name",t.name).text(r).appendTo(s).click(function(){var t=e(this).attr("data-sort-name");return n._sortOnName(t),!1});t.title&&a.attr("title",i(t.title))}),this.sortedRows.forEach(function(i){var o=e("<tr>").attr("nunaliit-row",i.getRowName()).appendTo(r);i.elemId||(i.elemId=t.getUniqueId()),o.attr("id",i.elemId),i.isRowElement&&n._adjustStyles(o,i),n.headings.forEach(function(r){var s=r.name,a=e("<td>").attr("nunaliit-column",s).attr("nunaliit-row",i.getRowName()).appendTo(o),l=i.getCell(s);l&&(l.isCellElement&&(l.elemId||(l.elemId=t.getUniqueId()),a.attr("id",l.elemId),n._adjustStyles(a,l)),n.useLazyDisplay?a.addClass("n2TableCanvas_lazyDisplay"):n._displayCell(a))})}),this.useLazyDisplay?this._refreshRows():this.showService.fixElementAndChildren(r)},_refreshRows:function(){var t=this,i=this._getElem(),n=i.find("tbody"),r=n.position(),o=n.height(),s=n.scrollTop(),a=!1;i.find(".n2TableCanvas_lazyDisplay").each(function(){var i=e(this),n=i.position(),l=i.height(),c=!0;n.top>o+s+r.top?c=!1:n.top+l<s+r.top&&(c=!1),c&&(t._displayCell(i),i.removeClass("n2TableCanvas_lazyDisplay"),a=!0)}),a&&this.showService.fixElementAndChildren(i)},_displayCell:function(t){var i=this,n=t.attr("nunaliit-column"),r=t.attr("nunaliit-row"),o=this.rowsByName[r],s=o.getCell(n);if(s)if("function"==typeof s.display)s.display(t,s,o),t.click(function(){var t=e(this);return i._selectedCell(t),!1}).mouseover(function(){var t=e(this);return i._mouseOver(t),!1}).mouseout(function(){var t=e(this);return i._mouseOut(t),!1});else if("string"==typeof s.display)e("<a>").attr("href","#").attr("nunaliit-row",o.getRowName()).attr("nunaliit-colmun",n).text(s.display).appendTo(t).click(function(){var t=e(this);return i._selectedCell(t),!1}).mouseover(function(){var t=e(this);return i._mouseOver(t),!1}).mouseout(function(){var t=e(this);return i._mouseOut(t),!1});else{var a=o.getValue(n);void 0!==a&&("reference"===s.type?e("<a>").addClass("n2s_referenceLink").attr("nunaliit-document",a).text(a).appendTo(t):e("<a>").attr("href","#").attr("nunaliit-row",o.getRowName()).attr("nunaliit-column",n).text(a).appendTo(t).click(function(){var t=e(this);return i._selectedCell(t),!1}).mouseover(function(){var t=e(this);return i._mouseOver(t),!1}).mouseout(function(){var t=e(this);return i._mouseOut(t),!1}))}},_selectedCell:function(e){var t=this._getElementFromHtml(e);t&&this.elementGenerator.selectOn(t)},_mouseOver:function(e){var t=this._getElementFromHtml(e);t&&this.elementGenerator.focusOn(t)},_mouseOut:function(e){var t=this._getElementFromHtml(e);t&&this.elementGenerator.focusOff(t)},_getElementFromHtml:function(e){var t=e.attr("nunaliit-row"),i=e.attr("nunaliit-column"),n=this.rowsByName[t];if(n){var r=n.getCell(i);if(r&&r.isCellElement)return r;if(n.isRowElement)return n}},_sortOnName:function(e){this.sortOrder.length<1&&this.headings.length>0&&this.headings[0].name===e&&this.sortOrder.unshift({name:e,direction:1});var t=-1;this.sortOrder.forEach(function(i,n){i.name===e&&(t=n)});var i=!0;0==t?(this.sortOrder[0].direction=-1*this.sortOrder[0].direction,i=!1):t>=0&&this.sortOrder.splice(t,1),i&&this.sortOrder.unshift({name:e,direction:1}),this._sortRows(this.sortedRows),this._reorderDisplayedRows()},_reorderDisplayedRows:function(){this.sortedRows.forEach(function(t){var i=t.elemId;if(i){var n=e("#"+i);if(n.length>0){var r=n.parent();n.appendTo(r)}}})},_intentChanged:function(t){var i=this;t.forEach(function(t){if(t.elemId){var n=e("#"+t.elemId);n.length>0&&i._adjustStyles(n,t)}})},_sourceModelUpdated:function(e){this.elementGenerator.sourceModelUpdated(e)},_handleDispatch:function(e){"modelGetInfo"===e.type?e.modelId===this.modelId&&(e.modelInfo=this._getModelInfo()):"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&e.state&&this._sourceModelUpdated(e.state)},_adjustStyles:function(e,t){t.n2_elem=e[0],this.styleRules.getSymbolizer(t).adjustHtmlElement(e[0],t),delete t.n2_elem},_sortRows:function(e){var t=[],i={};this.sortOrder.forEach(function(e){var n=e.name;i[n]||(t.push(e),i[n]=!0)}),this.headings.forEach(function(e){var n=e.name;i[n]||(t.push({name:n,direction:1}),i[n]=!0)}),e.sort(function(e,i){for(var n=0,r=t.length;n<r;++n){var o=t[n].name,s=t[n].direction,a=e.getSortValue(o),l=i.getSortValue(o);if(a<l)return-1*s;if(a>l)return 1*s}return 0})},_computeCsvContent:function(){var e=this,i=[],n=[];return i.push(n),this.headings.forEach(function(e){n.push(e.name)}),this.sortedRows&&this.sortedRows.forEach(function(t){var n=[];i.push(n),e.headings.forEach(function(e){var i=e.name,r=t.getExportValue(i);n.push(r)})}),t.csv.ValueTableToCsvString(i)},_exportCsv:function(){var n=this._computeCsvContent();if("undefined"!=typeof Blob&&"function"==typeof saveAs){var r=new Blob([n],{type:"text/plain;charset="+document.characterSet});saveAs(r,"table.csv")}else{var o=e("<div>").addClass("n2canvasReferenceBrowser_exportCsv_dialog"),s=t.utils.getElementIdentifier(o);e("<textarea>").addClass("n2canvasTable_exportCsv_text").text(n).appendTo(o),o.dialog({autoOpen:!0,title:i("CSV"),modal:!0,width:370,close:function(t,i){var n=e("#"+s);n.dialog("destroy"),n.remove()}})}}}),c=t.canvasElementGenerator.ElementGenerator,d=t.Class("DefaultTableElementGenerator",c,{initialize:function(e){c.prototype.initialize.call(this,e)},_createFragmentsFromDoc:function(e){return[{id:e._id,n2_id:e._id,n2_doc:e}]},_updateElements:function(e,t){var i={},n={id:"__HEADER__",isHeader:!0,columns:[{name:"id",label:"id"},{name:"rev",label:"rev"}]};for(var r in i[n.id]=n,e){var o=e[r],s=r,a=t[s];a||(a={id:s}),a.fragments={},a.fragments[r]=o,i[s]=a;var l=o.n2_doc;a.cells={id:{value:l._id},rev:{value:l._rev}},a.n2_id=l._id}return i}});t.canvasElementGenerator.AddElementGeneratorFactory({type:"tableDefault",factoryFn:function(e){var i=t.extend({type:null,options:null,config:null},e),n={};if(i.options)for(var r in i.options){var o=i.options[r];n[r]=o}return i.config&&i.config.directory&&(n.dispatchService=i.config.directory.dispatchService),new d(n)}}),t.canvasTable={TableCanvas:l,HandleCanvasAvailableRequest:function(e){"table"===e.canvasType&&(e.isAvailable=!0)},HandleCanvasDisplayRequest:function(e){if("table"===e.canvasType){var i={elementGeneratorType:"tableDefault"};if(e.canvasOptions)for(var n in e.canvasOptions)i[n]=e.canvasOptions[n];i.elementGenerator||(i.elementGenerator=t.canvasElementGenerator.CreateElementGenerator({type:i.elementGeneratorType,options:i.elementGeneratorOptions,config:e.config})),i.canvasId=e.canvasId,i.interactionId=e.interactionId,i.moduleDisplay=e.moduleDisplay,i.onSuccess=e.onSuccess,i.onError=e.onError,e.config&&e.config.directory&&(i.dispatchService=e.config.directory.dispatchService,i.showService=e.config.directory.showService),new l(i)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.display",n=t.Class({dispatchService:null,initialize:function(e){var n=t.extend({dispatchService:null},e),r=this;if(this.dispatchService=n.dispatchService,this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(i,"displayIsTypeAvailable",o),this.dispatchService.register(i,"displayRender",o)}},_handle:function(e,i,n){"displayIsTypeAvailable"===e.type?(t.couchDisplay&&t.couchDisplay.HandleDisplayAvailableRequest&&t.couchDisplay.HandleDisplayAvailableRequest(e),t.couchDisplayTiles&&t.couchDisplayTiles.HandleDisplayAvailableRequest&&t.couchDisplayTiles.HandleDisplayAvailableRequest(e),t.displayRibbon&&t.displayRibbon.HandleDisplayAvailableRequest&&t.displayRibbon.HandleDisplayAvailableRequest(e),t.displayRibbon2&&t.displayRibbon2.HandleDisplayAvailableRequest&&t.displayRibbon2.HandleDisplayAvailableRequest(e)):"displayRender"===e.type&&(t.couchDisplay&&t.couchDisplay.HandleDisplayRenderRequest&&t.couchDisplay.HandleDisplayRenderRequest(e),t.couchDisplayTiles&&t.couchDisplayTiles.HandleDisplayRenderRequest&&t.couchDisplayTiles.HandleDisplayRenderRequest(e),t.displayRibbon&&t.displayRibbon.HandleDisplayRenderRequest&&t.displayRibbon.HandleDisplayRenderRequest(e),t.displayRibbon2&&t.displayRibbon2.HandleDisplayRenderRequest&&t.displayRibbon2.HandleDisplayRenderRequest(e))}});t.display={Service:n}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.displayRibbon";t.Class({height:null,tileHeight:null,initialize:function(e,t){this.height=e||0,this.tileHeight=t||150},get:function(e,t){t+=12;var i,n,r,o=Math.ceil(t/e),s=[],a=Math.max(1,Math.ceil(this.height/this.tileHeight));for(s.push(new Tiles.Rectangle(0,0,2,a)),i=1,n=0,r=1;r<t;++r){for(i+=1;i>=e;)i=0,(n+=1)<a&&(i=2);s.push(new Tiles.Rectangle(i,n,1,1))}return new Tiles.Template(s,e,o)}});var r=t.Class({elemId:null,changeCallback:null,schemaRepository:null,selectedSchema:null,initialize:function(i,n,r){var o=e(i);this.elemId=o.attr("id"),this.elemId||(this.elemId=t.getUniqueId(),o.attr("id",this.elemId)),this.changeCallback=n,this.schemaRepository=r},display:function(e){var i=this,n={};if(e)for(var r=0,o=e.length;r<o;++r){var s=e[r];s.schema&&(n[s.schema]=!0)}var a=[];for(var l in n)a.push(l);this.schemaRepository.getSchemas({names:a,onSuccess:function(e){i._displaySchemas(e)},onError:function(e){t.log("Error getting schemas for displaying schema filter",e)}})},filter:function(e){if(this.selectedSchema){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i];r.schema===this.selectedSchema&&t.push(r)}return t}return e},_getElem:function(){return e("#"+this.elemId)},_displaySchemas:function(n){var r=this,o=this._getElem();o.empty();var s=function(){var t=e(this).attr("n2SchemaName");return t=t||null,r._schemaSelected(t),!1};e("<a>").attr("href","#").text(i("All")).addClass("n2DisplayRibbon_filter").addClass("n2DisplayRibbon_filter_all").appendTo(o).click(s);for(var a=!1,l=0,c=n.length;l<c;++l){var d=n[l];d.name===this.selectedSchema&&(a=!0);var u=d.name;d.label&&(u=i(d.label)),e("<a>").attr("href","#").attr("n2SchemaName",d.name).text(u).addClass("n2DisplayRibbon_filter_schema").addClass("n2DisplayRibbon_filter_schema_"+t.utils.stringToHtmlId(d.name)).appendTo(o).click(s)}a||(this.selectedSchema=null),this._adjustSelection()},_adjustSelection:function(){var e=this._getElem();e.find(".n2DisplayRibbon_filter_selected").removeClass("n2DisplayRibbon_filter_selected"),this.selectedSchema?e.find(".n2DisplayRibbon_filter_schema_"+t.utils.stringToHtmlId(this.selectedSchema)).addClass("n2DisplayRibbon_filter_selected"):e.find(".n2DisplayRibbon_filter_all").addClass("n2DisplayRibbon_filter_selected")},_schemaSelected:function(e){this.selectedSchema=e,this._adjustSelection(),this.changeCallback()}}),o=t.Class({schemaRepository:null,initialize:function(e){var i=t.extend({schemaRepository:null},e);this.schemaRepository=i.schemaRepository},get:function(e,t){return new r(e,t,this.schemaRepository)}}),s=t.Class({documentSource:null,initialize:function(e){var i=t.extend({documentSource:null},e);this.documentSource=i.documentSource},getRelatedDocumentIds:function(e){var i=t.extend({doc:null,onSuccess:function(e,t){},onError:function(e){}},e),n=i.doc;this.documentSource.getReferencesFromId({docId:n._id,onSuccess:function(e){var r={},o=[];t.couchUtils.extractLinks(n,o);for(var s=0,a=o.length;s<a;++s){var l=o[s].doc;r[l]=!0}for(var s=0,a=e.length;s<a;++s){var l=e[s];r[l]=!0}var c=[];for(var d in r)c.push(d);i.onSuccess(n,c)},onError:function(e){i.onError(e)}})},areDocumentsRelated:function(e){var i=t.extend({selectedDoc:null,relatedDoc:null,onRelated:function(e,t){},onNotRelated:function(e,t){},onError:function(e){}},e),n=i.selectedDoc,r=i.relatedDoc,o=[];t.couchUtils.extractLinks(n,o);for(var s=0,a=o.length;s<a;++s){if(o[s].doc===r._id)return void i.onRelated(n,r)}o=[];t.couchUtils.extractLinks(r,o);for(s=0,a=o.length;s<a;++s){if(o[s].doc===n._id)return void i.onRelated(n,r)}i.onNotRelated(n,r)}}),a=t.Class({showService:null,initialize:function(e){var i=t.extend({showService:void 0},e);this.showService=i.showService},showInfo:function(n){var r=t.extend({doc:void 0,locationElem:void 0,onClose:function(){}},n),o=e(r.locationElem),s=r.doc._id,a=e("<div>").addClass("n2DisplayRibbon_popup_outer_layout n2DisplayRibbon_popup_"+t.utils.stringToHtmlId(s)).appendTo(o),l=e("<div>").addClass("n2DisplayRibbon_popup_layout").appendTo(a),c=e("<div>").addClass("n2DisplayRibbon_popup_container").appendTo(l),d=e("<div>").addClass("n2DisplayRibbon_popup_content").appendTo(c);this.showService?this.showService.printDocument(d,s):d.text(s);var u=e("<div>").addClass("n2DisplayRibbon_popup_buttons").appendTo(c);e("<a>").attr("href","#").addClass("n2DisplayRibbon_popup_button n2DisplayRibbon_popup_button_close").text(i("Close")).click(function(){return e(this).parents(".n2DisplayRibbon_popup_outer_layout").first().remove(),r.onClose(),!1}).appendTo(u)},removeInfo:function(i){var n=t.extend({docId:void 0,locationElem:void 0},i),r=e(n.locationElem),o=n.docId,s="n2DisplayRibbon_popup_"+t.utils.stringToHtmlId(o);r.find("."+s).remove()}}),l=t.Class({id:null,top:null,left:null,width:null,height:null,$el:null,parentId:null,initialize:function(t,i){this.id=t,this.top=0,this.left=0,this.width=0,this.height=0,this.$el=e(i||document.createElement("div")),this.$el.addClass("n2DisplayRibbon_tile_invisible")},appendTo:function(e,i,n,r){var o=t.utils.getElementIdentifier(e);return o!==this.parentId&&(this.parentId=o,this.$el.hide().appendTo(e),i?this.$el.delay(n).fadeIn(r):this.$el.show(),!0)},remove:function(t,i){t?this.$el.fadeOut({complete:function(){e(this).remove()}}):this.$el.remove()},resize:function(e,t,i,n){var r={},o=!1;this.left!==e.x&&(r.left=e.x,this.left=e.x,o=!0),this.top!==e.y&&(r.top=e.y,this.top=e.y,o=!0),this.width!==e.width&&(r.width=e.width,this.width=e.width,o=!0),this.height!==e.height&&(r.height=e.height,this.height=e.height,o=!0);var s=this,a=function(){var e=s.$el[0];s.left!==e.offsetLeft&&s.$el.css("left",s.left),s.top!==e.offsetTop&&s.$el.css("top",s.top),n&&n()};t&&o?this.$el.animate(r,{duration:i,easing:"swing",complete:a}):(o&&this.$el.css(r),setTimeout(a,i))},isVisible:function(){return this.$el.hasClass("n2DisplayRibbon_tile_visible")},setVisible:function(e){e?this.$el.removeClass("n2DisplayRibbon_tile_invisible").addClass("n2DisplayRibbon_tile_visible"):this.$el.removeClass("n2DisplayRibbon_tile_visible").addClass("n2DisplayRibbon_tile_invisible")}}),c=t.Class({createTile:null,cellSize:null,cellSizeMin:null,cellPadding:null,numColumnMin:null,animationDuration:null,elemId:null,currentTile:null,relatedTiles:null,removedTiles:null,rateOfChange:null,rateOfChangeEnd:null,relatedOffset:null,relatedOffsetMin:null,intervalId:null,tileVisibilityChangedFn:null,initialize:function(i){var n=this,r=e(i);this.elemId=t.utils.getElementIdentifier(r),this.createTile=function(t){var i=e("div").css({position:"absolute"});return new l(t,i)},this.animationDuration=500,this.cellPadding=10,this.cellSizeMin=150,this.numColumnMin=3,this.currentTile=void 0,this.relatedTiles=[],this.removedTiles=[],this.rateOfChange=0,this.rateOfChangeEnd=!0,this.relatedOffset=0,this.relatedOffsetMin=0,this.intervalId=window.setInterval(function(){n._intervalTask()},300),r.empty();var o=r.css("position");o&&"absolute"===o||r.css("position","relative"),e("<div>").addClass("n2DisplayRibbon_grid_current").css({position:"absolute",left:"0",top:"0",bottom:"0",right:"auto",width:"170px"}).appendTo(r);var s=e("<div>").addClass("n2DisplayRibbon_grid_extra").css({position:"absolute",left:"170px",top:"0",bottom:"0",right:"0"}).appendTo(r);e("<div>").addClass("n2DisplayRibbon_grid_related").css({position:"absolute",left:"0",top:"0",bottom:"0"}).appendTo(s),e("<div>").addClass("n2DisplayRibbon_grid_button_previous").appendTo(s).mousedown(function(){return n._buttonChanged("down","previous"),!1}).mouseup(function(){return n._buttonChanged("up","previous"),!1}),e("<div>").addClass("n2DisplayRibbon_grid_button_next").appendTo(s).mousedown(function(){return n._buttonChanged("down","next"),!1}).mouseup(function(){return n._buttonChanged("up","next"),!1})},updateTiles:function(e,t){var i={};this.currentTile&&(i[this.currentTile.id]=this.currentTile);for(var n=0,r=this.relatedTiles.length;n<r;++n){i[(d=this.relatedTiles[n]).id]=d}var o={},s=void 0;e&&((d=i[c=e])||((d=this.createTile(c)).id=c),d&&(o[c]=d,s=d));var a=[];for(n=0,r=t.length;n<r;++n){(d=i[c=t[n]])||((d=this.createTile(c)).id=c),d&&(o[c]=d,a.push(d))}var l=[];for(var c in i){var d=i[c];o[c]||l.push(d)}this.currentTile=s,this.relatedTiles=a,this.removedTiles=l},redraw:function(e,t){if(this._shouldRedraw()){var i=this._getElem(),n=i.find(".n2DisplayRibbon_grid_current"),r=i.find(".n2DisplayRibbon_grid_extra"),o=i.find(".n2DisplayRibbon_grid_related"),s=i.height(),a=i.width(),l=s-2*this.cellPadding;l<this.cellSizeMin&&(l=this.cellSizeMin);var c=(a-this.cellPadding)/this.numColumnMin-this.cellPadding;c<this.cellSizeMin&&(c=this.cellSizeMin),this.cellSize=Math.min(l,c);var d=this.animationDuration;this.relatedOffset=0,i.find(".n2DisplayRibbon_grid_related").css({left:this.relatedOffset});var u=0;this.currentTile?(u=this.cellSize+2*this.cellPadding,n.css({display:"block",width:u+"px"}),r.css({left:u+"px"}),this.currentTile.resize({width:this.cellSize,height:this.cellSize,x:this.cellPadding,y:this.cellPadding},!0,d,void 0),this.currentTile.appendTo(n,!1,0,d)):(n.css({display:"none"}),r.css({left:"0px"}));for(var h=0,p=this.removedTiles.length;h<p;++h){(m=this.removedTiles[h]).remove(e,d)}this.removedTiles=[];var f=this.cellPadding;for(h=0,p=this.relatedTiles.length;h<p;++h){var m;(m=this.relatedTiles[h]).resize({width:this.cellSize,height:this.cellSize,x:f,y:this.cellPadding},!0,d,void 0),m.appendTo(o,!1,0,d),f+=this.cellSize+this.cellPadding}this.relatedOffsetMin=a-u-f,this.relatedOffsetMin>0&&(this.relatedOffsetMin=0),this._updateRelatedOffset(this.relatedOffset),this._updateVisibleTiles(),"function"==typeof t&&setTimeout(function(){t(!0)},d+10)}else t&&t(!1)},setTileVisibilityChangeFunction:function(e){this.tileVisibilityChangedFn=e},_shouldRedraw:function(){return!0},_buttonChanged:function(e,t){"up"===e?this.rateOfChangeEnd=!0:(this.rateOfChangeEnd=!1,this.rateOfChange="next"===t?-250:250)},_intervalTask:function(){if(this._getElem().length<1)window.clearInterval(this.intervalId);else if(0!=this.rateOfChange){var e=this.relatedOffset;e+=this.rateOfChange,this._updateRelatedOffset(e),this._updateVisibleTiles(),this.rateOfChangeEnd&&(this.rateOfChange=0)}},_updateRelatedOffset:function(e){if(e>0&&(e=0),e<this.relatedOffsetMin&&(e=this.relatedOffsetMin),e!=this.relatedOffset){this.relatedOffset=e;var t=(n=this._getElem()).find(".n2DisplayRibbon_grid_related"),i={left:this.relatedOffset};t.animate(i,{duration:300,easing:"linear"})}var n=this._getElem();this.relatedOffset<=this.relatedOffsetMin?n.addClass("n2DisplayRibbon_grid_related_max"):n.removeClass("n2DisplayRibbon_grid_related_max"),this.relatedOffset>=0?n.addClass("n2DisplayRibbon_grid_related_min"):n.removeClass("n2DisplayRibbon_grid_related_min")},_updateVisibleTiles:function(){var e=this._getElem().width(),t=0;this.currentTile&&(t=this.cellSize+2*this.cellPadding,this.currentTile.isVisible()||this.currentTile.setVisible(!0));for(var i=0-this.relatedOffset,n=i+(e-t),r=this.cellPadding,o=r+this.cellSize,s=0,a=this.relatedTiles.length;s<a;++s){var l=this.relatedTiles[s],c=!0;r>n?c=!1:o<i&&(c=!1);var d=!1;c?l.isVisible()||(l.setVisible(!0),d=!0):l.isVisible()&&(l.setVisible(!1),d=!0),d&&"function"==typeof this.tileVisibilityChangedFn&&this.tileVisibilityChangedFn({visible:c,docId:l.id,tile:l}),o=(r=r+this.cellSize+this.cellPadding)+this.cellSize}},_getElem:function(){return e("#"+this.elemId)}}),d=t.Class("RibbonDisplay",{documentSource:null,displayPanelName:null,showService:null,requestService:null,schemaRepository:null,customService:null,dispatchService:null,boolOptions:null,restrictAddRelatedButtonToLoggedIn:null,currentDetails:null,displayedDocumentsOrder:null,displayedDocuments:null,grid:null,createDocProcess:null,defaultSchema:null,relatedDocumentDiscoveryProcess:null,documentInfoFunction:null,sortFunction:null,filterFactory:null,filter:null,hoverInFn:null,hoverOutFn:null,clickFn:null,hoverDocId:null,infoDisplay:null,initialize:function(i){var r=t.extend({documentSource:null,displayPanelName:null,showService:null,requestService:null,schemaRepository:null,customService:null,dispatchService:null,createDocProcess:null,displayRelatedInfoFunction:null,displayOnlyRelatedSchemas:!1,displayBriefInRelatedInfo:!1,restrictAddRelatedButtonToLoggedIn:!1,relatedDocumentDiscoveryProcess:null,documentInfoFunction:null,sortFunction:null,filterFactory:null,infoDisplay:null},i),l=this;this.currentDetails={},this.displayedDocuments={},this.displayedDocumentsOrder=null,this.documentSource=r.documentSource,this.displayPanelName=r.displayPanelName,this.showService=r.showService,this.requestService=r.requestService,this.schemaRepository=r.schemaRepository,this.customService=r.customService,this.dispatchService=r.dispatchService,this.createDocProcess=r.createDocProcess,this._getDisplayDiv(),this.boolOptions={displayOnlyRelatedSchemas:r.displayOnlyRelatedSchemas,displayBriefInRelatedInfo:r.displayBriefInRelatedInfo},this.restrictAddRelatedButtonToLoggedIn=r.restrictAddRelatedButtonToLoggedIn,!this.restrictAddRelatedButtonToLoggedIn&&this.customService&&(this.restrictAddRelatedButtonToLoggedIn=this.customService.getOption("restrictAddRelatedButtonToLoggedIn",!1));var c=this.dispatchService;if(c){var d=function(e,t,i){l._handleDispatch(e,t,i)};c.register(n,"selected",d),c.register(n,"searchResults",d),c.register(n,"documentDeleted",d),c.register(n,"authLoggedIn",d),c.register(n,"authLoggedOut",d),c.register(n,"editClosed",d),c.register(n,"documentContent",d),c.register(n,"documentContentCreated",d),c.register(n,"documentContentUpdated",d),c.register(n,"windowResized",d)}if(!r.displayRelatedInfoFunction){var u=this._getBooleanOption("displayOnlyRelatedSchemas");r.displayRelatedInfoFunction=u?function(e){l._displayRelatedInfo(e)}:function(e){l._displayLinkedInfo(e)}}if(this.relatedDocumentDiscoveryProcess=r.relatedDocumentDiscoveryProcess,!this.relatedDocumentDiscoveryProcess&&this.customService&&(this.relatedDocumentDiscoveryProcess=this.customService.getOption("relatedDocumentDiscoveryProcess",null)),this.relatedDocumentDiscoveryProcess||(this.relatedDocumentDiscoveryProcess=new s({documentSource:this.documentSource})),this.documentInfoFunction=r.documentInfoFunction,!this.documentInfoFunction&&this.customService){var h=this.customService.getOption("displayDocumentInfoFunction");"function"==typeof h&&(this.documentInfoFunction=h)}if(this.documentInfoFunction||(this.documentInfoFunction=function(e){var i=t.extend({docIds:null,display:null,onSuccess:function(e){},onError:function(e){}},e);i.display.documentSource.getDocumentInfoFromIds({docIds:i.docIds,onSuccess:i.onSuccess,onError:i.onError})}),this.sortFunction=r.sortFunction,!this.sortFunction&&this.customService){var p=this.customService.getOption("displaySortFunction");"function"==typeof p&&(this.sortFunction=p)}if(this.sortFunction||(this.sortFunction=function(e){e.sort(function(e,t){if(e.updatedTime&&t.updatedTime){if(e.updatedTime>t.updatedTime)return-1;if(e.updatedTime<t.updatedTime)return 1}return e.id>t.id?-1:e.id<t.id?1:0})}),this.filterFactory=r.filterFactory,!this.filterFactory&&this.customService){var f=this.customService.getOption("displayFilterFactory");f&&"function"==typeof f.get&&(this.filterFactory=f)}this.filterFactory||(this.filterFactory=new o({schemaRepository:this.schemaRepository})),this.hoverInFn=function(){var t=e(this);return l._hoverInTile(t),!1},this.hoverOutFn=function(){var t=e(this);return l._hoverOutTile(t),!1},this.clickFn=function(t){if(t&&t.target&&e(t.target).parents(".n2DisplayRibbon_popup").length>0)return!0;var i=e(this);return l._clickedTile(i),!1};var m=window.setInterval(function(){l._getDisplayDiv().length<0?window.clearInterval(m):l._performIntervalTask()},500);if(r.infoDisplay&&"string"==typeof r.infoDisplay&&this.dispatchService){var v={type:"ribbonGetInfoDisplay",name:r.infoDisplay,infoDisplay:null};this.dispatchService.synchronousCall(n,v),this.infoDisplay=v.infoDisplay}this.infoDisplay||(this.infoDisplay=new a({showService:this.showService})),e("body").addClass("n2_display_format_ribbon"),t.log("DisplayRibbon",this)},setSchema:function(e){this.defaultSchema=e},_handleDispatch:function(e,t,i){if(this._getDisplayDiv().length<1)i.deregister(t);else if("selected"===e.type)if(e.doc)this._displayDocument(e.doc._id,e.doc);else if(e.docId)this._displayDocument(e.docId,null);else if(e.docs){for(var n=[],r=0,o=e.docs.length;r<o;++r)n.push(e.docs[r]._id);this._displayMultipleDocuments(n,e.docs)}else e.docIds&&this._displayMultipleDocuments(e.docIds,null);else if("searchResults"===e.type)this._displaySearchResults(e.results);else if("documentDeleted"===e.type);else if("authLoggedIn"===e.type||"authLoggedOut"===e.type)this.currentDetails&&this.currentDetails.docId&&this.currentDetails.doc&&(this._receiveDocumentContent(this.currentDetails.doc),this._displayDocumentButtons(this.currentDetails.doc,this.currentDetails.schema));else if("editClosed"===e.type){if(!e.deleted){var s=e.doc;s&&this._displayDocument(s._id,s)}}else"documentContent"===e.type?this._receiveDocumentContent(e.doc):"documentContentCreated"===e.type?this._receiveDocumentContent(e.doc):"documentContentUpdated"===e.type?this._receiveDocumentContent(e.doc):"windowResized"===e.type&&this.grid&&this.grid.redraw(!0)},_displayDocument:function(e,t){(this._reclaimDisplayDiv(),this.currentDetails&&this.currentDetails.docId===e)||(this.currentDetails={docId:e},this._addDisplayedDocument(e,t),this._getDisplayDiv().find(".n2DisplayRibbon_info").hide(),this._adjustCurrentTile(e),t?this._receiveDocumentContent(t):this._requestDocumentWithId(e))},_displaySearchResults:function(e){this._reclaimDisplayDiv();var t=[];if(e&&e.sorted&&e.sorted.length)for(var n=0,r=e.sorted.length;n<r;++n)t.push(e.sorted[n].id);(this._displayMultipleDocuments(t,null),t.length<1)&&this._getDisplayDiv().find(".n2DisplayRibbon_info").text(i("Empty search results")).show()},_displayMultipleDocuments:function(e,t){this._reclaimDisplayDiv(),this._getDisplayDiv().find(".n2DisplayRibbon_info").hide(),this.currentDetails={docIds:e,docs:{}},this._adjustCurrentTile(null);var i={};if(t)for(var n=0,r=t.length;n<r;++n){var o=t[n];this.currentDetails.docs[o._id]=o,i[o._id]=o}this._changeDisplayedDocuments(e,i)},_displayDocumentButtons:function(r,o){var s=this;if(r&&r._id&&this.currentDetails.docId===r._id){var a=this._getDisplayDiv().find(".n2DisplayRibbon_current_buttons").empty();if(t.couchMap.canEditDoc(r)&&e('<a href="#"></a>').addClass("n2DisplayRibbon_current_button n2DisplayRibbon_current_button_edit").text(i("Edit")).appendTo(a).click(function(){return s._performDocumentEdit(r),!1}),t.couchMap.canDeleteDoc(r)&&e('<a href="#"></a>').addClass("n2DisplayRibbon_current_button n2DisplayRibbon_current_button_delete").text(i("Delete")).appendTo(a).click(function(){return s._performDocumentDelete(r),!1}),o&&o.relatedSchemaNames&&o.relatedSchemaNames.length){var l=!0;if(this.restrictAddRelatedButtonToLoggedIn){var c=!1;if(this.dispatchService){var d={type:"authIsLoggedIn",isLoggedIn:!1};this.dispatchService.synchronousCall(n,d),c=d.isLoggedIn}c||(l=!1)}if(l){var u=e("<span>").appendTo(a);this.createDocProcess.insertAddRelatedSelection({placeHolderElem:u,doc:r,onElementCreated:function(e){e.addClass("n2DisplayRibbon_current_button n2DisplayRibbon_current_button_add_related_item")}})}}if(this.dispatchService&&this.dispatchService.isEventTypeRegistered("findIsAvailable")&&this.dispatchService.isEventTypeRegistered("find")){var h=!1;d={type:"findIsAvailable",doc:r,isAvailable:!1};this.dispatchService.synchronousCall(n,d),d.isAvailable&&(h=!0),h&&e('<a href="#"></a>').addClass("n2DisplayRibbon_current_button n2DisplayRibbon_current_button_find_on_map").text(i("Find on Map")).appendTo(a).click(function(){return s._dispatch({type:"find",docId:r._id,doc:r}),!1})}r&&r.nunaliit_layer_definition&&this.dispatchService&&this.dispatchService.isEventTypeRegistered("addLayerToMap")&&e('<a href="#"></a>').addClass("n2DisplayRibbon_current_button n2DisplayRibbon_current_button_add_layer").text(i("Add Layer")).appendTo(a).click(function(){return s._performAddLayerToMap(r),!1}),r&&e('<a href="#"></a>').addClass("n2DisplayRibbon_current_button n2DisplayRibbon_current_button_tree_view").text(i("Tree View")).appendTo(a).click(function(){return s._performTreeView(r),!1})}},_currentDocReferencesUpdated:function(){if(this.currentDetails&&this.currentDetails.doc&&this.currentDetails.referenceDocIds){for(var e={},t=0,i=this.currentDetails.referenceDocIds.length;t<i;++t){e[this.currentDetails.referenceDocIds[t]]=!0}var n=[];for(var r in this.displayedDocuments)r===this.currentDetails.docId||e[r]||n.push(r);for(t=0,i=n.length;t<i;++t)this._removeDisplayedDocument(n[t]);for(var r in e)this._addDisplayedDocument(r);this.displayedDocumentsOrder=null,this._updateDisplayedDocuments()}},_updateDisplayedDocuments:function(){var e=this,i=[];for(var n in this.displayedDocuments)this.displayedDocuments[n].info||i.push(n);function r(){e._getDisplayDiv();var t=null,i=null;if(e.displayedDocumentsOrder){for(var n=[],r=0,o=(i=e.displayedDocumentsOrder).length;r<o;++r){var s=i[r];e.displayedDocuments[s]&&e.displayedDocuments[s].info&&n.push(e.displayedDocuments[s].info)}e.filter.display(n,e),i=[];for(r=0,o=(n=e.filter.filter(n,e)).length;r<o;++r){var a=n[r];i.push(a.id)}}else{n=[];for(var s in e.displayedDocuments)e.displayedDocuments[s].info&&n.push(e.displayedDocuments[s].info);e.filter.display(n,e),n=e.filter.filter(n,e),e.sortFunction(n);var l={};i=[],e.currentDetails&&e.currentDetails.docId&&(t=e.currentDetails.docId,l[e.currentDetails.docId]=!0);for(r=0,o=n.length;r<o;++r){l[s=n[r].id]||(i.push(s),l[s]=!0)}}e.grid.updateTiles(t,i),e.grid.isDirty=!0,e.grid.redraw(!0),t&&e._requestDocumentWithId(t)}i.length>0?this.documentInfoFunction({docIds:i,display:this,onSuccess:function(t){for(var i=0,n=t.length;i<n;++i){var o=t[i],s=o.id;e.displayedDocuments[s]&&(e.displayedDocuments[s].info=o)}r()},onError:function(e){t.log("Unable to obtain document information",e)}}):r()},_changeDisplayedDocuments:function(e,t){for(var i={},n=0,r=e.length;n<r;++n){i[o=e[n]]=!0}for(var o in this.displayedDocuments)i[o]||this._removeDisplayedDocument(o);for(n=0,r=e.length;n<r;++n){o=e[n];var s=null;t&&t[o]&&(s=t[o]),this._addDisplayedDocument(o,s)}this.displayedDocumentsOrder=e,this._updateDisplayedDocuments()},_addDisplayedDocument:function(e,t){this.displayedDocuments[e]||(this.displayedDocuments[e]={id:e}),t&&(this.displayedDocuments[e].doc=t)},_removeDisplayedDocument:function(e){this.displayedDocuments[e]&&delete this.displayedDocuments[e]},_receiveDocumentContent:function(i){var n=this,r=this._getDisplayDiv(),o=i._id;if(this.displayedDocuments[o]&&(this.displayedDocuments[o].doc=i),i._id===this.currentDetails.docId){var s=!1;this.currentDetails.doc?i._rev!==this.currentDetails.doc._rev&&(this.currentDetails.doc=i,s=!0):(this.currentDetails.doc=i,s=!0),s&&this.relatedDocumentDiscoveryProcess.getRelatedDocumentIds({doc:i,onSuccess:function(e,t){n.currentDetails.docId===e._id&&(n.currentDetails.referenceDocIds=t,n._currentDocReferencesUpdated())},onError:function(e){t.log("Error obtaining reference ids",e)}})}var a="n2DisplayRibbon_wait_brief_"+t.utils.stringToHtmlId(o);r.find("."+a).each(function(){var t=e(this);n.showService&&n.showService.displayBriefDescription(t,{},i),t.removeClass(a)});a="n2DisplayRibbon_wait_current_"+t.utils.stringToHtmlId(o);var l="n2DisplayRibbon_current_buttons_"+t.utils.stringToHtmlId(o);r.find("."+a).each(function(){var t=e(this).empty();e("<div>").addClass("n2DisplayRibbon_current_buttons").addClass(l).appendTo(t);var r=e("<div>").appendTo(t);n.showService?n.showService.displayDocument(r,{},i):r.text(i._id),t.removeClass(a)}),e("."+l).each(function(){e(this);n._displayDocumentButtons(i,n.currentDetails.schema)});var c=!1,d=!1,u=!1,h=null,p=null;if(i.nunaliit_attachments&&i.nunaliit_attachments.files)for(var f in i.nunaliit_attachments.files){var m=i.nunaliit_attachments.files[f];m.source||("image"===m.fileClass?c=!0:"audio"===m.fileClass?d=!0:"video"===m.fileClass&&(u=!0),m.thumbnail&&(h=m.thumbnail))}if(i.nunaliit_schema&&(p=i.nunaliit_schema),r.find(".n2DisplayRibbon_tile_"+t.utils.stringToHtmlId(o)).each(function(){var i=e(this);i.removeClass("n2DisplayRibbon_tile_image n2DisplayRibbon_tile_audio n2DisplayRibbon_tile_video"),u?i.addClass("n2DisplayRibbon_tile_video"):d?i.addClass("n2DisplayRibbon_tile_audio"):c&&i.addClass("n2DisplayRibbon_tile_image"),p&&i.addClass("n2DisplayRibbon_tile_schema_"+t.utils.stringToHtmlId(p))}),h&&(i.nunaliit_attachments.files[h]&&"attached"===i.nunaliit_attachments.files[h].status||(h=null)),h){var v=this.documentSource.getDocumentAttachmentUrl(i,h);v&&r.find(".n2DisplayRibbon_wait_thumb_"+t.utils.stringToHtmlId(o)).each(function(){var t=e(this);t.empty(),e("<img>").attr("src",v).appendTo(t)})}function g(e,t){n.currentDetails.docId===e._id&&(t&&!n.currentDetails.schema?(n.currentDetails.schema=t,n._displayDocumentButtons(e,t)):n.currentDetails.schema&&!t?(n.currentDetails.schema=null,n._displayDocumentButtons(e,null)):n.currentDetails.schema&&t&&n.currentDetails.schema.name!==t.name&&(n.currentDetails.schema=t,n._displayDocumentButtons(e,t)))}i.nunaliit_schema&&this.schemaRepository?this.schemaRepository.getSchema({name:i.nunaliit_schema,onSuccess:function(e){g(i,e)},onError:function(e){g(i,null)}}):g(i,null),this.currentDetails.doc&&i._id!==this.currentDetails.docId&&this.relatedDocumentDiscoveryProcess.areDocumentsRelated({selectedDoc:this.currentDetails.doc,relatedDoc:i,onRelated:function(e,t){if(e._id===n.currentDetails.docId){var r=-1;n.currentDetails.referenceDocIds&&(r=n.currentDetails.referenceDocIds.indexOf(i._id)),r<0&&(n.currentDetails.referenceDocIds||(n.currentDetails.referenceDocIds=[]),n.currentDetails.referenceDocIds.push(i._id),n._currentDocReferencesUpdated())}},onNotRelated:function(e,t){if(e._id===n.currentDetails.docId){var r=-1;n.currentDetails.referenceDocIds&&(r=n.currentDetails.referenceDocIds.indexOf(i._id)),r>=0&&(n.currentDetails.referenceDocIds.splice(r,1),n._currentDocReferencesUpdated())}},onError:function(e){t.log("Error in displayTiled. Unable to check relation.",e)}})},_performDocumentEdit:function(e){var i=this;this.documentSource.getDocument({docId:e._id,onSuccess:function(e){i._dispatch({type:"editInitiate",doc:e})},onError:function(e){t.log("Unable to load document: "+e)}})},_performDocumentDelete:function(e){confirm(i("You are about to delete this document. Do you want to proceed?"))&&this.documentSource.deleteDocument({doc:e,onSuccess:function(){}})},_performAddLayerToMap:function(e){var t=e.nunaliit_layer_definition,i=t.id;i||(i=e._id);var n={name:t.name,type:"couchdb",options:{layerName:i,documentSource:this.documentSource}};this._dispatch({type:"addLayerToMap",layer:n,options:{setExtent:{bounds:t.bbox,crs:"EPSG:4326"}}})},_performTreeView:function(e){new t.couchDisplay.TreeDocumentViewer({doc:e})},_reclaimDisplayDiv:function(){var i=this,n=this._getDisplayDiv(),r=n.find(".n2DisplayRibbon_filters"),o=n.find(".n2DisplayRibbon_buttons"),s=n.find(".n2DisplayRibbon_info"),a=n.find(".n2DisplayRibbon_documents");(r.length<1||o.length<1||s.length<1||a.length<1)&&(n.empty(),r=e("<div>").addClass("n2DisplayRibbon_filters"),o=e("<div>").addClass("n2DisplayRibbon_buttons").appendTo(n),s=e("<div>").addClass("n2DisplayRibbon_info").appendTo(n),a=e("<div>").addClass("n2DisplayRibbon_documents").appendTo(n),this.currentDetails={},this.grid=new c(a),this.grid.createTile=function(e){return i._createTile(e)},this.grid.setTileVisibilityChangeFunction(function(e){i._tileVisibilityChanged(e)}),this.filter=this.filterFactory.get(r,function(){i._documentFilterChanged()}),new t.widgetNavigation.NavigationWidget({elem:o,dispatchService:this.dispatchService}))},_createTile:function(i){var n=e("<div>").addClass("n2DisplayRibbon_tile").addClass("n2DisplayRibbon_tile_"+t.utils.stringToHtmlId(i)).attr("n2DocId",i);n.hover(this.hoverInFn,this.hoverOutFn),n.click(this.clickFn);var r=new l(i,n);return this.currentDetails&&this.currentDetails.docId===i?(n.addClass("n2DisplayRibbon_tile_current"),this._generateCurrentDocumentContent(n,i)):(n.removeClass("n2DisplayRibbon_tile_current"),this._generateRelatedDocumentContent(n,i)),r},_tileVisibilityChanged:function(e){if(e&&e.visible&&e.docId&&e.tile){var t=e.docId;this._requestDocumentWithId(t)}},_clickedTile:function(e){var t=e.attr("n2DocId");this.currentDetails&&this.currentDetails.docId===t?this._showCurrentPopUp():this._dispatch({type:"userSelect",docId:t})},_hoverInTile:function(e){var t=e.attr("n2DocId");t&&t!==this.hoverDocId&&(this.hoverDocId=t,this._dispatch({type:"userFocusOn",docId:t}))},_hoverOutTile:function(e){var t=e.attr("n2DocId");t&&t===this.hoverDocId&&(this.hoverDocId=null,this._dispatch({type:"userFocusOff",docId:t})),e.find(".n2DisplayRibbon_tile_menu").remove()},_showCurrentPopUp:function(){if(this.currentDetails&&this.currentDetails.docId){var i=this.currentDetails.docId,n=this.currentDetails.doc,r=".n2DisplayRibbon_tile_"+t.utils.stringToHtmlId(i),o=this._getDisplayDiv().find(r);if(o.length>0){var s=o.find(".n2DisplayRibbon_popup");s.length<1?(s=e("<div>").addClass("n2DisplayRibbon_popup").appendTo(o),this.infoDisplay.showInfo({doc:n,locationElem:s,onClose:function(){s.remove()}})):(this.infoDisplay.removeInfo({docId:i,locationElem:s}),s.remove())}}},_adjustCurrentTile:function(i){var n=this,r=this._getDisplayDiv().find(".n2DisplayRibbon_documents"),o=null;i&&(o="n2DisplayRibbon_tile_"+t.utils.stringToHtmlId(i)),r.find(".n2DisplayRibbon_tile_current").each(function(){var t=e(this);if(o&&t.hasClass(o));else{t.removeClass("n2DisplayRibbon_tile_current");var i=t.attr("n2DocId");n._generateRelatedDocumentContent(t,i)}}),o&&r.find("."+o).each(function(){var t=e(this);if(t.hasClass("n2DisplayRibbon_tile_current"));else{t.addClass("n2DisplayRibbon_tile_current");var i=t.attr("n2DocId");n._generateCurrentDocumentContent(t,i)}})},_getDisplayDiv:function(){var t=this.displayPanelName;return e("#"+t)},_dispatch:function(e){var t=this.dispatchService;t&&t.send(n,e)},_getBooleanOption:function(e){var t=!1;this.boolOptions[e]&&(t=!0);var i=this.customService;i&&!t&&(i.getOption(e)&&(t=!0));return t},_getCachedDocumentFromId:function(e){return this.displayedDocuments&&this.displayedDocuments[e]&&this.displayedDocuments[e].doc?this.displayedDocuments[e].doc:this.currentDetails&&this.currentDetails.docId===e&&this.currentDetails.doc?this.currentDetails.doc:null},_requestDocumentWithId:function(e){var t=this._getCachedDocumentFromId(e);t?this._receiveDocumentContent(t):this.requestService&&this.requestService.requestDocument(e)},_generateCurrentDocumentContent:function(i,n){i.empty();var r=e("<div>").addClass("n2DisplayRibbon_tile_container").appendTo(i);e("<div>").addClass("n2DisplayRibbon_thumb n2DisplayRibbon_wait_thumb_"+t.utils.stringToHtmlId(n)).appendTo(r),e("<div>").addClass("n2DisplayRibbon_wait_brief_"+t.utils.stringToHtmlId(n)).addClass("n2DisplayRibbon_tile_brief").text(n).appendTo(r)},_generateRelatedDocumentContent:function(i,n){i.empty();var r=e("<div>").addClass("n2DisplayRibbon_tile_container").appendTo(i);e("<div>").addClass("n2DisplayRibbon_thumb n2DisplayRibbon_wait_thumb_"+t.utils.stringToHtmlId(n)).appendTo(r),e("<div>").addClass("n2DisplayRibbon_wait_brief_"+t.utils.stringToHtmlId(n)).addClass("n2DisplayRibbon_tile_brief").text(n).appendTo(r)},_performIntervalTask:function(){this._getDisplayDiv().find(".n2DisplayRibbon_documents")},_documentFilterChanged:function(){this._updateDisplayedDocuments()}});t.displayRibbon={RibbonDisplay:d,HandleDisplayAvailableRequest:function(e){"ribbon"===e.displayType&&(e.isAvailable=!0)},HandleDisplayRenderRequest:function(e){if("ribbon"===e.displayType){var t={};if(e.displayOptions)for(var i in e.displayOptions)t[i]=e.displayOptions[i];t.documentSource=e.config.documentSource,t.displayPanelName=e.displayId,t.showService=e.config.directory.showService,t.createDocProcess=e.config.directory.createDocProcess,t.requestService=e.config.directory.requestService,t.schemaRepository=e.config.directory.schemaRepository,t.customService=e.config.directory.customService,t.dispatchService=e.config.directory.dispatchService;var n=new d(t);e.onSuccess(n)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2",i)},n="n2.displayRibbon2";t.Class({height:null,tileHeight:null,initialize:function(e,t){this.height=e||0,this.tileHeight=t||150},get:function(e,t){t+=12;var i,n,r,o=Math.ceil(t/e),s=[],a=Math.max(1,Math.ceil(this.height/this.tileHeight));for(s.push(new Tiles.Rectangle(0,0,2,a)),i=1,n=0,r=1;r<t;++r){for(i+=1;i>=e;)i=0,(n+=1)<a&&(i=2);s.push(new Tiles.Rectangle(i,n,1,1))}return new Tiles.Template(s,e,o)}});var r=t.Class({elemId:null,changeCallback:null,schemaRepository:null,selectedSchema:null,initialize:function(i,n,r){var o=e(i);this.elemId=o.attr("id"),this.elemId||(this.elemId=t.getUniqueId(),o.attr("id",this.elemId)),this.changeCallback=n,this.schemaRepository=r},display:function(e){var i=this,n={};if(e)for(var r=0,o=e.length;r<o;++r){var s=e[r];s.schema&&(n[s.schema]=!0)}var a=[];for(var l in n)a.push(l);this.schemaRepository.getSchemas({names:a,onSuccess:function(e){i._displaySchemas(e)},onError:function(e){t.log("Error getting schemas for displaying schema filter",e)}})},filter:function(e){if(this.selectedSchema){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i];r.schema===this.selectedSchema&&t.push(r)}return t}return e},_getElem:function(){return e("#"+this.elemId)},_displaySchemas:function(n){var r=this,o=this._getElem();o.empty();var s=function(){var t=e(this).attr("n2SchemaName");return t=t||null,r._schemaSelected(t),!1};e("<a>").attr("href","#").text(i("All")).addClass("n2DisplayRibbon2_filter").addClass("n2DisplayRibbon2_filter_all").appendTo(o).click(s);for(var a=!1,l=0,c=n.length;l<c;++l){var d=n[l];d.name===this.selectedSchema&&(a=!0);var u=d.name;d.label&&(u=i(d.label)),e("<a>").attr("href","#").attr("n2SchemaName",d.name).text(u).addClass("n2DisplayRibbon2_filter_schema").addClass("n2DisplayRibbon2_filter_schema_"+t.utils.stringToHtmlId(d.name)).appendTo(o).click(s)}a||(this.selectedSchema=null),this._adjustSelection()},_adjustSelection:function(){var e=this._getElem();e.find(".n2DisplayRibbon2_filter_selected").removeClass("n2DisplayRibbon2_filter_selected"),this.selectedSchema?e.find(".n2DisplayRibbon2_filter_schema_"+t.utils.stringToHtmlId(this.selectedSchema)).addClass("n2DisplayRibbon2_filter_selected"):e.find(".n2DisplayRibbon2_filter_all").addClass("n2DisplayRibbon2_filter_selected")},_schemaSelected:function(e){this.selectedSchema=e,this._adjustSelection(),this.changeCallback()}}),o=t.Class({schemaRepository:null,initialize:function(e){var i=t.extend({schemaRepository:null},e);this.schemaRepository=i.schemaRepository},get:function(e,t){return new r(e,t,this.schemaRepository)}}),s=t.Class({documentSource:null,initialize:function(e){var i=t.extend({documentSource:null},e);this.documentSource=i.documentSource},getRelatedDocumentIds:function(e){var i=t.extend({doc:null,onSuccess:function(e,t){},onError:function(e){}},e),n=i.doc;this.documentSource.getReferencesFromId({docId:n._id,onSuccess:function(e){var r={},o=[];t.couchUtils.extractLinks(n,o);for(var s=0,a=o.length;s<a;++s){var l=o[s].doc;r[l]=!0}for(var s=0,a=e.length;s<a;++s){var l=e[s];r[l]=!0}var c=[];for(var d in r)c.push(d);i.onSuccess(n,c)},onError:function(e){i.onError(e)}})},areDocumentsRelated:function(e){var i=t.extend({selectedDoc:null,relatedDoc:null,onRelated:function(e,t){},onNotRelated:function(e,t){},onError:function(e){}},e),n=i.selectedDoc,r=i.relatedDoc,o=[];t.couchUtils.extractLinks(n,o);for(var s=0,a=o.length;s<a;++s){if(o[s].doc===r._id)return void i.onRelated(n,r)}o=[];t.couchUtils.extractLinks(r,o);for(s=0,a=o.length;s<a;++s){if(o[s].doc===n._id)return void i.onRelated(n,r)}i.onNotRelated(n,r)}}),a=t.Class({id:null,top:null,left:null,width:null,height:null,$el:null,parentId:null,initialize:function(t,i){this.id=t,this.top=0,this.left=0,this.width=0,this.height=0,this.$el=e(i||document.createElement("div"))},appendTo:function(e,i,n,r){var o=t.utils.getElementIdentifier(e);return o!==this.parentId&&(this.parentId=o,this.$el.hide().appendTo(e),i?this.$el.delay(n).fadeIn(r):this.$el.show(),!0)},remove:function(t,i){t?this.$el.fadeOut({complete:function(){e(this).remove()}}):this.$el.remove()},resize:function(e,t,i,n){var r={},o=!1;this.left!==e.x&&(r.left=e.x,this.left=e.x,o=!0),this.top!==e.y&&(r.top=e.y,this.top=e.y,o=!0),this.width!==e.width&&(r.width=e.width,this.width=e.width,o=!0),this.height!==e.height&&(r.height=e.height,this.height=e.height,o=!0);var s=this,a=function(){var e=s.$el[0];s.left!==e.offsetLeft&&s.$el.css("left",s.left),s.top!==e.offsetTop&&s.$el.css("top",s.top),n&&n()};t&&o?this.$el.animate(r,{duration:i,easing:"swing",complete:a}):(o&&this.$el.css(r),setTimeout(a,i))}}),l=t.Class({showService:null,documentSource:null,requestService:null,relatedDocumentDiscoveryProcess:null,documentInfoFunction:null,sortFunction:null,filterFactory:null,elemId:null,currentDocId:null,docIds:null,initialize:function(i){var n=t.extend({elem:null,currentDocId:null,docIds:null,showService:null,documentSource:null,requestService:null,relatedDocumentDiscoveryProcess:null,documentInfoFunction:null,sortFunction:null,filterFactory:null},i);this.showService=n.showService,this.documentSource=n.documentSource,this.relatedDocumentDiscoveryProcess=n.relatedDocumentDiscoveryProcess,this.documentInfoFunction=n.documentInfoFunction,this.sortFunction=n.sortFunction,this.documentSource=n.documentSource,this.requestService=n.requestService,this.filterFactory=n.filterFactory,this.currentDocId=n.currentDocId,this.docIds=n.docIds,this.docIds||(this.docIds=[]);var r=e(n.elem);this.elemId=t.utils.getElementIdentifier(r),this._display()},_getElem:function(){return e("#"+this.elemId)},_display:function(){var t=this,i=this._getElem();i.empty().addClass("n2DisplayRibbon2_film");var n=e("<div>").addClass("n2DisplayRibbon2_film_filters").appendTo(i);this.filter=this.filterFactory.get(n,function(){t._documentFilterChanged()});e("<div>").addClass("n2DisplayRibbon2_film_currentLayout").appendTo(i);var r=e("<div>").addClass("n2DisplayRibbon2_film_tilesOuter").appendTo(i);e("<div>").addClass("n2DisplayRibbon2_film_tilesInner").appendTo(r);e("<div>").addClass("n2DisplayRibbon2_film_tilesPrevious").appendTo(r),e("<div>").addClass("n2DisplayRibbon2_film_tilesNext").appendTo(r),this.currentDocId?this._displaySingle():this._displayMultiple()},_displaySingle:function(){var t=this,i=this._getElem().addClass("n2DisplayRibbon2_film_containsCurrent");function n(n,r){for(var o={},s=0,a=r.length;s<a;++s){o[c=r[s]]=!0}var l=[];for(var c in o)l.push(c);t.documentInfoFunction({docIds:l,display:this,onSuccess:function(r){!function(n,r){t.filter.display(r,t),r=t.filter.filter(r,t),t.sortFunction(r),function(n,r){var o=i.find(".n2DisplayRibbon2_film_currentLayout"),s=e("<div>").addClass("n2DisplayRibbon2_film_currentContainer").appendTo(o),a=e("<div>").addClass("n2DisplayRibbon2_film_currentContent").appendTo(s);t.showService.printBriefDescription(a,n._id);for(var l=0,c=e("<div>").addClass("n2DisplayRibbon2_film_tilesOuter").appendTo(i),d=e("<div>").addClass("n2DisplayRibbon2_film_tilesInner").appendTo(c),u=0,h=r.length;u<h;++u){var p=r[u],f=p.id,m=e("<div>").addClass("n2DisplayRibbon2_film_tileLayout").css({position:"absolute",left:l,top:0}).appendTo(d);l+=m.width();var v=e("<div>").addClass("n2DisplayRibbon2_film_tileContainer").appendTo(m);e("<div>").addClass("n2DisplayRibbon2_film_thumb n2s_insertFirstThumbnail").attr("nunaliit-document",f).appendTo(v),e("<div>").addClass("n2DisplayRibbon2_film_tileContent n2s_briefDisplay").attr("nunaliit-document",f).appendTo(v)}t._installCallBacks(),t.showService.fixElementAndChildren(i)}(n,r)}(n,r)},onError:function(e){}})}this.requestService.requestDocument(this.currentDocId,function(e){t.relatedDocumentDiscoveryProcess.getRelatedDocumentIds({doc:e,onSuccess:n,onError:function(e){}})})},_displayMultiple:function(){for(var t=this._getElem(),i=0,n=t.find(".n2DisplayRibbon2_film_tilesInner"),r=0,o=this.docIds.length;r<o;++r){var s=this.docIds[r],a=e("<div>").addClass("n2DisplayRibbon2_film_tileLayout").css({position:"absolute",left:i,top:0}).appendTo(n);i+=a.width();var l=e("<div>").addClass("n2DisplayRibbon2_film_tileContainer").appendTo(a),c=(e("<div>").addClass("n2DisplayRibbon2_film_thumb n2s_insertFirstThumbnail").attr("nunaliit-document",s).appendTo(l),e("<div>").addClass("n2DisplayRibbon2_film_tileContent n2s_briefDisplay").attr("nunaliit-document",s).appendTo(l));this.showService.printBriefDescription(c,s)}this._installCallBacks(),this.showService.fixElementAndChildren(t)},_installCallBacks:function(){},_documentFilterChanged:function(){}}),c=t.Class({createTile:null,cellSize:null,cellSizeMin:null,cellPadding:null,numColumnMin:null,animationDuration:null,elemId:null,currentTile:null,relatedTiles:null,removedTiles:null,rateOfChange:null,rateOfChangeEnd:null,relatedOffset:null,relatedOffsetMin:null,intervalId:null,initialize:function(i){var n=this,r=e(i);this.elemId=t.utils.getElementIdentifier(r),this.createTile=function(t){var i=e("div").css({position:"absolute"});return new a(t,i)},this.animationDuration=500,this.cellPadding=10,this.cellSizeMin=150,this.numColumnMin=3,this.currentTile=void 0,this.relatedTiles=[],this.removedTiles=[],this.rateOfChange=0,this.rateOfChangeEnd=!0,this.relatedOffset=0,this.relatedOffsetMin=0,this.intervalId=window.setInterval(function(){n._intervalTask()},300),r.empty();var o=r.css("position");o&&"absolute"===o||r.css("position","relative"),e("<div>").addClass("n2DisplayRibbon2_grid_current").css({position:"absolute",left:"0",top:"0",bottom:"0",right:"auto",width:"170px"}).appendTo(r);var s=e("<div>").addClass("n2DisplayRibbon2_grid_extra").css({position:"absolute",left:"170px",top:"0",bottom:"0",right:"0"}).appendTo(r);e("<div>").addClass("n2DisplayRibbon2_grid_related").css({position:"absolute",left:"0",top:"0",bottom:"0"}).appendTo(s),e("<div>").addClass("n2DisplayRibbon2_grid_button_previous").appendTo(s).mousedown(function(){return n._buttonChanged("down","previous"),!1}).mouseup(function(){return n._buttonChanged("up","previous"),!1}),e("<div>").addClass("n2DisplayRibbon2_grid_button_next").appendTo(s).mousedown(function(){return n._buttonChanged("down","next"),!1}).mouseup(function(){return n._buttonChanged("up","next"),!1})},updateTiles:function(e,t){var i={};this.currentTile&&(i[this.currentTile.id]=this.currentTile);for(var n=0,r=this.relatedTiles.length;n<r;++n){i[(d=this.relatedTiles[n]).id]=d}var o={},s=void 0;e&&((d=i[c=e])||(d=this.createTile(c)),d&&(o[c]=d,s=d));var a=[];for(n=0,r=t.length;n<r;++n){(d=i[c=t[n]])||(d=this.createTile(c)),d&&(o[c]=d,a.push(d))}var l=[];for(var c in i){var d=i[c];o[c]||l.push(d)}this.currentTile=s,this.relatedTiles=a,this.removedTiles=l},redraw:function(e,t){if(this._shouldRedraw()){var i=this._getElem(),n=i.find(".n2DisplayRibbon2_grid_current"),r=i.find(".n2DisplayRibbon2_grid_extra"),o=i.find(".n2DisplayRibbon2_grid_related"),s=i.height(),a=i.width(),l=s-2*this.cellPadding;l<this.cellSizeMin&&(l=this.cellSizeMin);var c=(a-this.cellPadding)/this.numColumnMin-this.cellPadding;c<this.cellSizeMin&&(c=this.cellSizeMin),this.cellSize=Math.min(l,c);var d=this.animationDuration;this.relatedOffset=0,i.find(".n2DisplayRibbon2_grid_related").css({left:this.relatedOffset});var u=0;this.currentTile?(u=this.cellSize+2*this.cellPadding,n.css({display:"block",width:u+"px"}),r.css({left:u+"px"}),this.currentTile.resize({width:this.cellSize,height:this.cellSize,x:this.cellPadding,y:this.cellPadding},!0,d,void 0),this.currentTile.appendTo(n,!1,0,d)):(n.css({display:"none"}),r.css({left:"0px"}));for(var h=0,p=this.removedTiles.length;h<p;++h){(m=this.removedTiles[h]).remove(e,d)}this.removedTiles=[];var f=this.cellPadding;for(h=0,p=this.relatedTiles.length;h<p;++h){var m;(m=this.relatedTiles[h]).resize({width:this.cellSize,height:this.cellSize,x:f,y:this.cellPadding},!0,d,void 0),m.appendTo(o,!1,0,d),f+=this.cellSize+this.cellPadding}this.relatedOffsetMin=a-u-f,this.relatedOffsetMin>0&&(this.relatedOffsetMin=0),this._updateRelatedOffset(this.relatedOffset),"function"==typeof t&&setTimeout(function(){t(!0)},d+10)}else t&&t(!1)},_shouldRedraw:function(){return!0},_buttonChanged:function(e,t){"up"===e?this.rateOfChangeEnd=!0:(this.rateOfChangeEnd=!1,this.rateOfChange="next"===t?-250:250)},_intervalTask:function(){if(this._getElem().length<1)window.clearInterval(this.intervalId);else if(0!=this.rateOfChange){var e=this.relatedOffset;e+=this.rateOfChange,this._updateRelatedOffset(e),this.rateOfChangeEnd&&(this.rateOfChange=0)}},_updateRelatedOffset:function(e){if(e>0&&(e=0),e<this.relatedOffsetMin&&(e=this.relatedOffsetMin),e!=this.relatedOffset){this.relatedOffset=e;var t=(n=this._getElem()).find(".n2DisplayRibbon2_grid_related"),i={left:this.relatedOffset};t.animate(i,{duration:300,easing:"linear"})}var n=this._getElem();this.relatedOffset<=this.relatedOffsetMin?n.addClass("n2DisplayRibbon2_grid_related_max"):n.removeClass("n2DisplayRibbon2_grid_related_max"),this.relatedOffset>=0?n.addClass("n2DisplayRibbon2_grid_related_min"):n.removeClass("n2DisplayRibbon2_grid_related_min")},_getElem:function(){return e("#"+this.elemId)}}),d=t.Class("RibbonDisplay",{documentSource:null,displayPanelName:null,showService:null,requestService:null,schemaRepository:null,customService:null,dispatchService:null,boolOptions:null,restrictAddRelatedButtonToLoggedIn:null,currentDetails:null,displayedDocumentsOrder:null,displayedDocuments:null,grid:null,createDocProcess:null,defaultSchema:null,relatedDocumentDiscoveryProcess:null,documentInfoFunction:null,sortFunction:null,filterFactory:null,filter:null,hoverInFn:null,hoverOutFn:null,clickFn:null,hoverDocId:null,initialize:function(i){var r=t.extend({documentSource:null,displayPanelName:null,showService:null,requestService:null,schemaRepository:null,customService:null,dispatchService:null,createDocProcess:null,displayRelatedInfoFunction:null,displayOnlyRelatedSchemas:!1,displayBriefInRelatedInfo:!1,restrictAddRelatedButtonToLoggedIn:!1,relatedDocumentDiscoveryProcess:null,documentInfoFunction:null,sortFunction:null,filterFactory:null},i),a=this;this.currentDetails={},this.displayedDocuments={},this.displayedDocumentsOrder=null,this.documentSource=r.documentSource,this.displayPanelName=r.displayPanelName,this.showService=r.showService,this.requestService=r.requestService,this.schemaRepository=r.schemaRepository,this.customService=r.customService,this.dispatchService=r.dispatchService,this.createDocProcess=r.createDocProcess,this._getDisplayDiv(),this.boolOptions={displayOnlyRelatedSchemas:r.displayOnlyRelatedSchemas,displayBriefInRelatedInfo:r.displayBriefInRelatedInfo},this.restrictAddRelatedButtonToLoggedIn=r.restrictAddRelatedButtonToLoggedIn,!this.restrictAddRelatedButtonToLoggedIn&&this.customService&&(this.restrictAddRelatedButtonToLoggedIn=this.customService.getOption("restrictAddRelatedButtonToLoggedIn",!1));var l=this.dispatchService;if(l){var c=function(e,t,i){a._handleDispatch(e,t,i)};l.register(n,"selected",c),l.register(n,"searchResults",c),l.register(n,"documentDeleted",c),l.register(n,"authLoggedIn",c),l.register(n,"authLoggedOut",c),l.register(n,"editClosed",c),l.register(n,"documentContent",c),l.register(n,"documentContentCreated",c),l.register(n,"documentContentUpdated",c)}if(!r.displayRelatedInfoFunction){var d=this._getBooleanOption("displayOnlyRelatedSchemas");r.displayRelatedInfoFunction=d?function(e){a._displayRelatedInfo(e)}:function(e){a._displayLinkedInfo(e)}}if(this.relatedDocumentDiscoveryProcess=r.relatedDocumentDiscoveryProcess,!this.relatedDocumentDiscoveryProcess&&this.customService&&(this.relatedDocumentDiscoveryProcess=this.customService.getOption("relatedDocumentDiscoveryProcess",null)),this.relatedDocumentDiscoveryProcess||(this.relatedDocumentDiscoveryProcess=new s({documentSource:this.documentSource})),this.documentInfoFunction=r.documentInfoFunction,!this.documentInfoFunction&&this.customService){var u=this.customService.getOption("displayDocumentInfoFunction");"function"==typeof u&&(this.documentInfoFunction=u)}if(this.documentInfoFunction||(this.documentInfoFunction=function(e){var i=t.extend({docIds:null,display:null,onSuccess:function(e){},onError:function(e){}},e);a.documentSource.getDocumentInfoFromIds({docIds:i.docIds,onSuccess:i.onSuccess,onError:i.onError})}),this.sortFunction=r.sortFunction,!this.sortFunction&&this.customService){var h=this.customService.getOption("displaySortFunction");"function"==typeof h&&(this.sortFunction=h)}if(this.sortFunction||(this.sortFunction=function(e){e.sort(function(e,t){if(e.updatedTime&&t.updatedTime){if(e.updatedTime>t.updatedTime)return-1;if(e.updatedTime<t.updatedTime)return 1}return e.id>t.id?-1:e.id<t.id?1:0})}),this.filterFactory=r.filterFactory,!this.filterFactory&&this.customService){var p=this.customService.getOption("displayFilterFactory");p&&"function"==typeof p.get&&(this.filterFactory=p)}this.filterFactory||(this.filterFactory=new o({schemaRepository:this.schemaRepository})),this.hoverInFn=function(){var t=e(this);return a._hoverInTile(t),!1},this.hoverOutFn=function(){var t=e(this);return a._hoverOutTile(t),!1},this.clickFn=function(){var t=e(this);return a._clickedTile(t),!1};var f=window.setInterval(function(){a._getDisplayDiv().length<0?window.clearInterval(f):a._performIntervalTask()},500);e("body").addClass("n2_display_format_ribbon"),t.log("DisplayRibbon2",this)},setSchema:function(e){this.defaultSchema=e},_handleDispatch:function(e,t,i){if(this._getDisplayDiv().length<1)i.deregister(t);else if("selected"===e.type)if(e.doc)this._displayDocument(e.doc._id,e.doc);else if(e.docId)this._displayDocument(e.docId,null);else if(e.docs){for(var n=[],r=0,o=e.docs.length;r<o;++r)n.push(e.docs[r]._id);this._displayMultipleDocuments(n,e.docs)}else e.docIds&&this._displayMultipleDocuments(e.docIds,null);else if("searchResults"===e.type)this._displaySearchResults(e.results);else if("documentDeleted"===e.type);else if("authLoggedIn"===e.type||"authLoggedOut"===e.type)this.currentDetails&&this.currentDetails.docId&&this.currentDetails.doc&&(this._receiveDocumentContent(this.currentDetails.doc),this._displayDocumentButtons(this.currentDetails.doc,this.currentDetails.schema));else if("editClosed"===e.type){if(!e.deleted){var s=e.doc;s&&this._displayDocument(s._id,s)}}else"documentContent"===e.type?this._receiveDocumentContent(e.doc):"documentContentCreated"===e.type?this._receiveDocumentContent(e.doc):"documentContentUpdated"===e.type&&this._receiveDocumentContent(e.doc)},_displayDocument:function(e,t){if(this._reclaimDisplayDiv(),!this.currentDetails||this.currentDetails.docId!==e){this.currentDetails={docId:e},this._addDisplayedDocument(e,t);var i=this._getDisplayDiv();i.find(".n2DisplayRibbon2_info").hide();var n=i.find(".n2DisplayRibbon2_documents");new l({elem:n,currentDocId:e,docIds:[],showService:this.showService,requestService:this.requestService,documentSource:this.documentSource,relatedDocumentDiscoveryProcess:this.relatedDocumentDiscoveryProcess,documentInfoFunction:this.documentInfoFunction,sortFunction:this.sortFunction,filterFactory:this.filterFactory})}},_displaySearchResults:function(e){this._reclaimDisplayDiv();var t=[];if(e&&e.sorted&&e.sorted.length)for(var n=0,r=e.sorted.length;n<r;++n)t.push(e.sorted[n].id);(this._displayMultipleDocuments(t,null),t.length<1)&&this._getDisplayDiv().find(".n2DisplayRibbon2_info").text(i("Empty search results")).show()},_displayMultipleDocuments:function(e,t){this._reclaimDisplayDiv();var i=this._getDisplayDiv();i.find(".n2DisplayRibbon2_info").hide(),this.currentDetails={docIds:e,docs:{}};var n=i.find(".n2DisplayRibbon2_documents");new l({elem:n,currentDocId:null,docIds:e,showService:this.showService,requestService:this.requestService,documentSource:this.documentSource,relatedDocumentDiscoveryProcess:this.relatedDocumentDiscoveryProcess,documentInfoFunction:this.documentInfoFunction,sortFunction:this.sortFunction,filterFactory:this.filterFactory})},_displayDocumentButtons:function(r,o){var s=this;if(r&&r._id&&this.currentDetails.docId===r._id){var a=this._getDisplayDiv().find(".n2DisplayRibbon2_current_buttons").empty();if(t.couchMap.canEditDoc(r)&&e('<a href="#"></a>').addClass("n2DisplayRibbon2_current_button n2DisplayRibbon2_current_button_edit").text(i("Edit")).appendTo(a).click(function(){return s._performDocumentEdit(r),!1}),t.couchMap.canDeleteDoc(r)&&e('<a href="#"></a>').addClass("n2DisplayRibbon2_current_button n2DisplayRibbon2_current_button_delete").text(i("Delete")).appendTo(a).click(function(){return s._performDocumentDelete(r),!1}),o&&o.relatedSchemaNames&&o.relatedSchemaNames.length){var l=!0;if(this.restrictAddRelatedButtonToLoggedIn){var c=!1;if(this.dispatchService){var d={type:"authIsLoggedIn",isLoggedIn:!1};this.dispatchService.synchronousCall(n,d),c=d.isLoggedIn}c||(l=!1)}if(l){var u=e("<span>").appendTo(a);this.createDocProcess.insertAddRelatedSelection({placeHolderElem:u,doc:r,onElementCreated:function(e){e.addClass("n2DisplayRibbon2_current_button n2DisplayRibbon2_current_button_add_related_item")}})}}if(this.dispatchService&&this.dispatchService.isEventTypeRegistered("findIsAvailable")&&this.dispatchService.isEventTypeRegistered("find")){var h=!1;d={type:"findIsAvailable",doc:r,isAvailable:!1};this.dispatchService.synchronousCall(n,d),d.isAvailable&&(h=!0),h&&e('<a href="#"></a>').addClass("n2DisplayRibbon2_current_button n2DisplayRibbon2_current_button_find_on_map").text(i("Find on Map")).appendTo(a).click(function(){return s._dispatch({type:"find",docId:r._id,doc:r}),!1})}r&&r.nunaliit_layer_definition&&this.dispatchService&&this.dispatchService.isEventTypeRegistered("addLayerToMap")&&e('<a href="#"></a>').addClass("n2DisplayRibbon2_current_button n2DisplayRibbon2_current_button_add_layer").text(i("Add Layer")).appendTo(a).click(function(){return s._performAddLayerToMap(r),!1}),r&&e('<a href="#"></a>').addClass("n2DisplayRibbon2_current_button n2DisplayRibbon2_current_button_tree_view").text(i("Tree View")).appendTo(a).click(function(){return s._performTreeView(r),!1})}},_currentDocReferencesUpdated:function(){if(this.currentDetails&&this.currentDetails.doc&&this.currentDetails.referenceDocIds){for(var e={},t=0,i=this.currentDetails.referenceDocIds.length;t<i;++t){e[this.currentDetails.referenceDocIds[t]]=!0}var n=[];for(var r in this.displayedDocuments)r===this.currentDetails.docId||e[r]||n.push(r);for(t=0,i=n.length;t<i;++t)this._removeDisplayedDocument(n[t]);for(var r in e)this._addDisplayedDocument(r);this.displayedDocumentsOrder=null,this._updateDisplayedDocuments()}},_updateDisplayedDocuments:function(){var e=this,i=[];for(var n in this.displayedDocuments)this.displayedDocuments[n].info||i.push(n);function r(){e._getDisplayDiv();var t=null,i=null;if(e.displayedDocumentsOrder){for(var n=[],r=0,o=(i=e.displayedDocumentsOrder).length;r<o;++r){var s=i[r];e.displayedDocuments[s]&&e.displayedDocuments[s].info&&n.push(e.displayedDocuments[s].info)}e.filter.display(n,e),i=[];for(r=0,o=(n=e.filter.filter(n,e)).length;r<o;++r){var a=n[r];i.push(a.id)}}else{n=[];for(var s in e.displayedDocuments)e.displayedDocuments[s].info&&n.push(e.displayedDocuments[s].info);e.filter.display(n,e),n=e.filter.filter(n,e),e.sortFunction(n);var l={};i=[],e.currentDetails&&e.currentDetails.docId&&(t=e.currentDetails.docId,l[e.currentDetails.docId]=!0);for(r=0,o=n.length;r<o;++r){l[s=n[r].id]||(i.push(s),l[s]=!0)}}e.grid.updateTiles(t,i),e.grid.isDirty=!0,e.grid.redraw(!0),t&&e._requestDocumentWithId(t);for(r=0,o=i.length;r<o;++r){s=i[r];e._requestDocumentWithId(s)}}i.length>0?this.documentInfoFunction({docIds:i,display:this,onSuccess:function(t){for(var i=0,n=t.length;i<n;++i){var o=t[i],s=o.id;e.displayedDocuments[s]&&(e.displayedDocuments[s].info=o)}r()},onError:function(e){t.log("Unable to obtain document information",e)}}):r()},_changeDisplayedDocuments:function(e,t){for(var i={},n=0,r=e.length;n<r;++n){i[o=e[n]]=!0}for(var o in this.displayedDocuments)i[o]||this._removeDisplayedDocument(o);for(n=0,r=e.length;n<r;++n){o=e[n];var s=null;t&&t[o]&&(s=t[o]),this._addDisplayedDocument(o,s)}this.displayedDocumentsOrder=e,this._updateDisplayedDocuments()},_addDisplayedDocument:function(e,t){this.displayedDocuments[e]||(this.displayedDocuments[e]={id:e}),t&&(this.displayedDocuments[e].doc=t)},_removeDisplayedDocument:function(e){this.displayedDocuments[e]&&delete this.displayedDocuments[e]},_receiveDocumentContent:function(i){var n=this,r=this._getDisplayDiv(),o=i._id;if(this.displayedDocuments[o]&&(this.displayedDocuments[o].doc=i),i._id===this.currentDetails.docId){var s=!1;this.currentDetails.doc?i._rev!==this.currentDetails.doc._rev&&(this.currentDetails.doc=i,s=!0):(this.currentDetails.doc=i,s=!0),s&&this.relatedDocumentDiscoveryProcess.getRelatedDocumentIds({doc:i,onSuccess:function(e,t){n.currentDetails.docId===e._id&&(n.currentDetails.referenceDocIds=t,n._currentDocReferencesUpdated())},onError:function(e){t.log("Error obtaining reference ids",e)}})}var a="n2DisplayRibbon2_wait_brief_"+t.utils.stringToHtmlId(o);r.find("."+a).each(function(){var t=e(this);n.showService&&n.showService.displayBriefDescription(t,{},i),t.removeClass(a)});a="n2DisplayRibbon2_wait_current_"+t.utils.stringToHtmlId(o);var l="n2DisplayRibbon2_current_buttons_"+t.utils.stringToHtmlId(o);r.find("."+a).each(function(){var t=e(this).empty();e("<div>").addClass("n2DisplayRibbon2_current_buttons").addClass(l).appendTo(t);var r=e("<div>").appendTo(t);n.showService?n.showService.displayDocument(r,{},i):r.text(i._id),t.removeClass(a)}),e("."+l).each(function(){e(this);n._displayDocumentButtons(i,n.currentDetails.schema)});var c=!1,d=!1,u=!1,h=null,p=null;if(i.nunaliit_attachments&&i.nunaliit_attachments.files)for(var f in i.nunaliit_attachments.files){var m=i.nunaliit_attachments.files[f];m.source||("image"===m.fileClass?c=!0:"audio"===m.fileClass?d=!0:"video"===m.fileClass&&(u=!0),m.thumbnail&&(h=m.thumbnail))}if(i.nunaliit_schema&&(p=i.nunaliit_schema),r.find(".n2DisplayRibbon2_tile_"+t.utils.stringToHtmlId(o)).each(function(){var i=e(this);i.removeClass("n2DisplayRibbon2_tile_image n2DisplayRibbon2_tile_audio n2DisplayRibbon2_tile_video"),u?i.addClass("n2DisplayRibbon2_tile_video"):d?i.addClass("n2DisplayRibbon2_tile_audio"):c&&i.addClass("n2DisplayRibbon2_tile_image"),p&&i.addClass("n2DisplayRibbon2_tile_schema_"+t.utils.stringToHtmlId(p))}),h&&(i.nunaliit_attachments.files[h]&&"attached"===i.nunaliit_attachments.files[h].status||(h=null)),h){var v=this.documentSource.getDocumentAttachmentUrl(i,h);v&&r.find(".n2DisplayRibbon2_wait_thumb_"+t.utils.stringToHtmlId(o)).each(function(){var t=e(this);t.empty(),e("<img>").attr("src",v).appendTo(t)})}function g(e,t){n.currentDetails.docId===e._id&&(t&&!n.currentDetails.schema?(n.currentDetails.schema=t,n._displayDocumentButtons(e,t)):n.currentDetails.schema&&!t?(n.currentDetails.schema=null,n._displayDocumentButtons(e,null)):n.currentDetails.schema&&t&&n.currentDetails.schema.name!==t.name&&(n.currentDetails.schema=t,n._displayDocumentButtons(e,t)))}i.nunaliit_schema&&this.schemaRepository?this.schemaRepository.getSchema({name:i.nunaliit_schema,onSuccess:function(e){g(i,e)},onError:function(e){g(i,null)}}):g(i,null),this.currentDetails.doc&&i._id!==this.currentDetails.docId&&this.relatedDocumentDiscoveryProcess.areDocumentsRelated({selectedDoc:this.currentDetails.doc,relatedDoc:i,onRelated:function(e,t){if(e._id===n.currentDetails.docId){var r=-1;n.currentDetails.referenceDocIds&&(r=n.currentDetails.referenceDocIds.indexOf(i._id)),r<0&&(n.currentDetails.referenceDocIds||(n.currentDetails.referenceDocIds=[]),n.currentDetails.referenceDocIds.push(i._id),n._currentDocReferencesUpdated())}},onNotRelated:function(e,t){if(e._id===n.currentDetails.docId){var r=-1;n.currentDetails.referenceDocIds&&(r=n.currentDetails.referenceDocIds.indexOf(i._id)),r>=0&&(n.currentDetails.referenceDocIds.splice(r,1),n._currentDocReferencesUpdated())}},onError:function(e){t.log("Error in displayTiled. Unable to check relation.",e)}})},_performDocumentEdit:function(e){var i=this;this.documentSource.getDocument({docId:e._id,onSuccess:function(e){i._dispatch({type:"editInitiate",doc:e})},onError:function(e){t.log("Unable to load document: "+e)}})},_performDocumentDelete:function(e){confirm(i("You are about to delete this document. Do you want to proceed?"))&&this.documentSource.deleteDocument({doc:e,onSuccess:function(){}})},_performAddLayerToMap:function(e){var t=e.nunaliit_layer_definition,i=t.id;i||(i=e._id);var n={name:t.name,type:"couchdb",options:{layerName:i,documentSource:this.documentSource}};this._dispatch({type:"addLayerToMap",layer:n,options:{setExtent:{bounds:t.bbox,crs:"EPSG:4326"}}})},_performTreeView:function(e){new t.couchDisplay.TreeDocumentViewer({doc:e})},_reclaimDisplayDiv:function(){var i=this,n=this._getDisplayDiv(),r=n.find(".n2DisplayRibbon2_filters"),o=n.find(".n2DisplayRibbon2_buttons"),s=n.find(".n2DisplayRibbon2_info"),a=n.find(".n2DisplayRibbon2_documents");(r.length<1||o.length<1||s.length<1||a.length<1)&&(n.empty(),r=e("<div>").addClass("n2DisplayRibbon2_filters"),o=e("<div>").addClass("n2DisplayRibbon2_buttons").appendTo(n),s=e("<div>").addClass("n2DisplayRibbon2_info").appendTo(n),a=e("<div>").addClass("n2DisplayRibbon2_documents").appendTo(n),this.currentDetails={},this.grid=new c(a),this.grid.createTile=function(e){return i._createTile(e)},this.filter=this.filterFactory.get(r,function(){i._documentFilterChanged()}),new t.widgetNavigation.NavigationWidget({elem:o,dispatchService:this.dispatchService}))},_createTile:function(i){var n=e("<div>").addClass("n2DisplayRibbon2_tile").addClass("n2DisplayRibbon2_tile_"+t.utils.stringToHtmlId(i)).attr("n2DocId",i);n.hover(this.hoverInFn,this.hoverOutFn),n.click(this.clickFn);var r=new a(i,n);return this.currentDetails&&this.currentDetails.docId===i?(n.addClass("n2DisplayRibbon2_tile_current"),this._generateCurrentDocumentContent(n,i)):(n.removeClass("n2DisplayRibbon2_tile_current"),this._generateRelatedDocumentContent(n,i)),r},_clickedTile:function(e){var t=e.attr("n2DocId");this.currentDetails&&this.currentDetails.docId===t?this._showCurrentPopUp():this._dispatch({type:"userSelect",docId:t})},_hoverInTile:function(e){var t=e.attr("n2DocId");t&&t!==this.hoverDocId&&(this.hoverDocId=t,this._dispatch({type:"userFocusOn",docId:t}))},_hoverOutTile:function(e){var t=e.attr("n2DocId");t&&t===this.hoverDocId&&(this.hoverDocId=null,this._dispatch({type:"userFocusOff",docId:t})),e.find(".n2DisplayRibbon2_tile_menu").remove()},_showCurrentPopUp:function(){if(this.currentDetails&&this.currentDetails.docId){var i=this.currentDetails.docId,n=".n2DisplayRibbon2_tile_"+t.utils.stringToHtmlId(i),r=this._getDisplayDiv().find(n);if(r.length>0){var o=r.find(".n2DisplayRibbon2_popup");o.length<1?(o=e("<div>").addClass("n2DisplayRibbon2_popup").appendTo(r),this._populateCurrentPopUp(i,o)):o.remove()}}},_hideCurrentPopUp:function(){this._getDisplayDiv().find(".n2DisplayRibbon2_popup").remove()},_populateCurrentPopUp:function(t,n){var r=e("<div>").addClass("n2DisplayRibbon2_popup_layout").appendTo(n),o=e("<div>").addClass("n2DisplayRibbon2_popup_container").appendTo(r),s=e("<div>").addClass("n2DisplayRibbon2_popup_content").appendTo(o);this.showService?this.showService.printDocument(s,t):s.text(t);var a=e("<div>").addClass("n2DisplayRibbon2_popup_buttons").appendTo(o);e("<a>").attr("href","#").addClass("n2DisplayRibbon2_popup_button n2DisplayRibbon2_popup_button_close").text(i("Close")).click(function(){return e(this).parents(".n2DisplayRibbon2_popup").first().remove(),!1}).appendTo(a)},_adjustCurrentTile:function(i){var n=this,r=this._getDisplayDiv().find(".n2DisplayRibbon2_documents"),o=null;i&&(o="n2DisplayRibbon2_tile_"+t.utils.stringToHtmlId(i)),r.find(".n2DisplayRibbon2_tile_current").each(function(){var t=e(this);if(o&&t.hasClass(o));else{t.removeClass("n2DisplayRibbon2_tile_current");var i=t.attr("n2DocId");n._generateRelatedDocumentContent(t,i)}}),o&&r.find("."+o).each(function(){var t=e(this);if(t.hasClass("n2DisplayRibbon2_tile_current"));else{t.addClass("n2DisplayRibbon2_tile_current");var i=t.attr("n2DocId");n._generateCurrentDocumentContent(t,i)}})},_getDisplayDiv:function(){var t=this.displayPanelName;return e("#"+t)},_dispatch:function(e){var t=this.dispatchService;t&&t.send(n,e)},_getBooleanOption:function(e){var t=!1;this.boolOptions[e]&&(t=!0);var i=this.customService;i&&!t&&(i.getOption(e)&&(t=!0));return t},_getCachedDocumentFromId:function(e){return this.displayedDocuments&&this.displayedDocuments[e]&&this.displayedDocuments[e].doc?this.displayedDocuments[e].doc:this.currentDetails&&this.currentDetails.docId===e&&this.currentDetails.doc?this.currentDetails.doc:null},_requestDocumentWithId:function(e){var t=this._getCachedDocumentFromId(e);t?this._receiveDocumentContent(t):this.requestService&&this.requestService.requestDocument(e)},_generateCurrentDocumentContent:function(i,n){i.empty();var r=e("<div>").addClass("n2DisplayRibbon2_tile_container").appendTo(i);e("<div>").addClass("n2DisplayRibbon2_thumb n2DisplayRibbon2_wait_thumb_"+t.utils.stringToHtmlId(n)).appendTo(r),e("<div>").addClass("n2DisplayRibbon2_wait_brief_"+t.utils.stringToHtmlId(n)).addClass("n2DisplayRibbon2_tile_brief").text(n).appendTo(r)},_generateRelatedDocumentContent:function(i,n){i.empty();var r=e("<div>").addClass("n2DisplayRibbon2_tile_container").appendTo(i);e("<div>").addClass("n2DisplayRibbon2_thumb n2DisplayRibbon2_wait_thumb_"+t.utils.stringToHtmlId(n)).appendTo(r),e("<div>").addClass("n2DisplayRibbon2_wait_brief_"+t.utils.stringToHtmlId(n)).addClass("n2DisplayRibbon2_tile_brief").text(n).appendTo(r)},_performIntervalTask:function(){this._getDisplayDiv().find(".n2DisplayRibbon2_documents")},_documentFilterChanged:function(){this._updateDisplayedDocuments()}});t.displayRibbon2={RibbonDisplay:d,HandleDisplayAvailableRequest:function(e){"ribbon2"===e.displayType&&(e.isAvailable=!0)},HandleDisplayRenderRequest:function(e){if("ribbon2"===e.displayType){var t={};if(e.displayOptions)for(var i in e.displayOptions)t[i]=e.displayOptions[i];t.documentSource=e.config.documentSource,t.displayPanelName=e.displayId,t.showService=e.config.directory.showService,t.createDocProcess=e.config.directory.createDocProcess,t.requestService=e.config.directory.requestService,t.schemaRepository=e.config.directory.schemaRepository,t.customService=e.config.directory.customService,t.dispatchService=e.config.directory.dispatchService;var n=new d(t);e.onSuccess(n)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.comment",r=t.Class({commentService:null,dispatchService:null,documentSource:null,showService:null,createDocProcess:null,cachedCommentsByDocId:null,reinsertElementsId:null,initialize:function(i){var r=t.extend({commentService:null,dispatchService:null,documentSource:null,showService:null,createDocProcess:null},i),o=this;if(this.commentService=r.commentService,this.dispatchService=r.dispatchService,this.documentSource=r.documentSource,this.showService=r.showService,this.createDocProcess=r.createDocProcess,this.dispatchService){var s=function(e,t,i){o._handleDispatch(e,t,i)};this.dispatchService.register(n,"documentContentCreated",s),this.dispatchService.register(n,"documentContentUpdated",s),this.dispatchService.register(n,"documentDeleted",s),this.dispatchService.register(n,"cacheRetrieveDocument",s)}var a=e("<div>").css({position:"absolute",display:"none"}).addClass("n2comment_reinsert_cache").appendTo(e("body"));this.reinsertElementsId=t.utils.getElementIdentifier(a)},display:function(i){var n=t.extend({divId:null,div:null,doc:null},i),r=n.doc,o=r._id,s=this.showService,a=(new t.couchDisplay.ButtonDisplay,n.div);if(a||(a=e("#"+n.divId)),a.length)if(s){a.empty(),e("<div>").addClass("n2Comment_stream n2Comment_stream_"+t.utils.stringToHtmlId(o)).appendTo(a),this._refreshStream({docId:o});var l=e("<div>").addClass("n2Comment_add_section").appendTo(a);this._resetAddSection(r,l)}else t.log("Show service not available for comment process")},_refreshStream:function(n){var r=t.extend({docId:null},n),o=this,s=r.docId,a=new t.couchDisplay.ButtonDisplay;function l(n){o.cachedCommentsByDocId={},n.forEach(function(e){var t=e._id;o.cachedCommentsByDocId[t]=e}),n.sort(function(e,t){var i=void 0;e&&e.nunaliit_created&&(i=e.nunaliit_created.time),e&&e.nunaliit_last_updated&&(i=e.nunaliit_last_updated.time);var n=void 0;return t&&t.nunaliit_created&&(n=t.nunaliit_created.time),t&&t.nunaliit_last_updated&&(n=t.nunaliit_last_updated.time),"number"==typeof i&&"number"==typeof n?n-i:i?-1:n?1:e._id>t._id?1:-1});var r={},l={};for(var c in n.forEach(function(e){var t=e._id,i={docId:t,doc:e,replies:{},inReplyToId:void 0};r[t]=i}),r){var d=r[c],u=d.doc,h=!0;if(u&&u.nunaliit_source&&"string"==typeof u.nunaliit_source.doc){var p=u.nunaliit_source.doc,f=r[p];f&&(d.inReplyToId=p,f.replies[c]=d,h=!1)}h&&(l[c]=d)}var m=e("#"+o.reinsertElementsId),v=e(".n2Comment_stream_"+t.utils.stringToHtmlId(s));if(v.length>0){v.find(".n2Comment_reinsert").appendTo(m),v.empty();var g=0;n.forEach(function(n){var r=n._id,s=e("<div>").addClass("n2Comment_doc n2Comment_doc_"+t.utils.stringToHtmlId(r)).attr("n2DocId",r).appendTo(v),l=e("<div>").addClass("n2Comment_content nunaliit_list_mod2_"+g%2).appendTo(s);o.showService.printDocument(l,r);var c=e("<div>").addClass("n2Comment_buttons").appendTo(s);a.drawButton({elem:c,name:"reply",label:i("Reply"),click:function(){var t=e(this).parents(".n2Comment_doc"),i=t.attr("n2DocId");o._addReply(i,t)}}),a.drawButton({elem:c,name:"more_details",label:i("More Details"),click:function(){var t=e(this).parents(".n2Comment_doc").attr("n2DocId");o._changeFocus(t)}}),m.find(".n2Comment_reinsert_"+t.utils.stringToHtmlId(r)).appendTo(s),++g})}m.empty()}this.documentSource.getReferencesFromOrigin({docId:s,onSuccess:function(e){o.documentSource.getDocuments({docIds:e,onSuccess:l})}})},_resetAddSection:function(n,r){var o=this,s=new t.couchDisplay.ButtonDisplay;r.empty(),s.drawButton({elem:r,name:"add_comment",label:i("Add Comment"),click:function(){var t=e(this).parents(".n2Comment_add_section");t.empty(),o._addComment(n,t)}})},_addComment:function(t,i){var n=this,r=this.createDocProcess,o=this.commentService.getCommentSchema(),s=e("<div>").appendTo(i);r.replyToDocument({doc:t,schema:o,originDocId:t._id,elem:s,onSuccess:function(e){n._resetAddSection(t,i)},onError:function(e){n._resetAddSection(t,i)},onCancel:function(){n._resetAddSection(t,i)}})},_addReply:function(i,n){var r=this.documentSource,o=this.createDocProcess,s=this.commentService.getCommentSchema(),a=void 0;n.length>0&&(a=e("<div>").addClass("n2Comment_reply n2Comment_reinsert n2Comment_reinsert_"+t.utils.stringToHtmlId(i)).appendTo(n)),r.getDocument({docId:i,onSuccess:function(e){o.replyToDocument({doc:e,schema:s,elem:a})}})},_changeFocus:function(e){this.dispatchService.send(n,{type:"userSelect",docId:e})},_handleDispatch:function(e,t,i){if("documentContentCreated"===e.type){var n=e.doc;this._handleDocumentContent(n)}else if("documentContentUpdated"===e.type){n=e.doc;this._handleDocumentContent(n)}else if("documentDeleted"===e.type){var r=e.docId;this._handleDocumentDeleted(r)}else if("cacheRetrieveDocument"===e.type){r=e.docId;if(this.cachedCommentsByDocId)(n=this.cachedCommentsByDocId[r])&&(e.doc=n)}},_handleDocumentContent:function(i){if(this.cachedCommentsByDocId&&this.cachedCommentsByDocId[i._id]&&(this.cachedCommentsByDocId[i._id]=i),i.nunaliit_origin&&"string"==typeof i.nunaliit_origin.doc){var n=i.nunaliit_origin.doc;e(".n2Comment_stream_"+t.utils.stringToHtmlId(n)).length>0&&this._refreshStream({docId:n})}else{e(".n2Comment_doc_"+t.utils.stringToHtmlId(i._id)).remove()}},_handleDocumentDeleted:function(i){e(".n2Comment_stream_"+t.utils.stringToHtmlId(i)).remove(),e(".n2Comment_doc_"+t.utils.stringToHtmlId(i)).remove()}}),o=t.Class({documentSource:null,showService:null,createDocProcess:null,dispatchService:null,customService:null,commentSchema:null,commentStreamDisplay:null,initialize:function(e){var i=t.extend({documentSource:null,showService:null,createDocProcess:null,dispatchService:null,customService:null,commentSchema:null},e);this.documentSource=i.documentSource,this.showService=i.showService,this.createDocProcess=i.createDocProcess,this.dispatchService=i.dispatchService,this.customService=i.customService,this.commentSchema=i.commentSchema},getCommentSchema:function(){return this.commentSchema},setCommentSchema:function(t){this.commentSchema=t,this.commentSchema?e(".n2Comment_button_addcomment").removeClass("n2Comment_button_addcomment_unavailable").addClass("n2Comment_button_addcomment_available"):e(".n2Comment_button_addcomment").removeClass("n2Comment_button_addcomment_available").addClass("n2Comment_button_addcomment_unavailable")},insertAddCommentButton:function(n){var r=t.extend({div:null,doc:null,buttonDisplay:null},n),o=this,s=r.doc,a=e(r.div),l=r.buttonDisplay;l||(l=new t.couchDisplay.ButtonDisplay);var c=["n2Comment_button_addcomment"];this.commentSchema?c.push("n2Comment_button_addcomment_available"):c.push("n2Comment_button_addcomment_unavailable"),l.drawButton({elem:a,name:"add_comment",label:i("Add Comment"),classNames:c,click:function(){o._addComment(s)}})},_addComment:function(e){this.createDocProcess.replyToDocument({doc:e,schema:this.commentSchema,originDocId:e._id})},getCommentStreamDisplay:function(){return this.commentStreamDisplay||(this.commentStreamDisplay=new r({commentService:this,dispatchService:this.dispatchService,documentSource:this.documentSource,showService:this.showService,createDocProcess:this.createDocProcess})),this.commentStreamDisplay}});t.comment={Service:o,CommentStreamDisplay:r}}(jQuery,nunaliit2),function(e,t){var i=t.Class({img_ref:null,div_ref:null,div_half_width:null,div_half_height:null,zoom_control_refs:null,zoom_levels:null,zoom_level_count:null,img_current_left:null,img_current_top:null,zoom_level:null,img_orig_width:null,img_orig_height:null,img_zoom_width:null,img_zoom_height:null,click_last:null,img_start_left:null,img_start_top:null,origin:null,initialize:function(i){var n=t.extend({imageElem:null,wrapperElem:null},i),r=this;if(this.img_current_left=null,this.zoom_control_refs={},this.zoom_levels=[],this.zoom_level_count=0,this.zoom_level=0,this.click_last=0,this.img_start_left=null,this.img_start_top=null,this.origin=null,this.img_ref=e(n.imageElem).addClass("n2_zoomify_image"),this.img_ref.length>0){n.wrapperElem?this.div_ref=e(n.wrapperElem):(this.div_ref=e("<div>").insertBefore(this.img_ref),this.img_ref.appendTo(this.div_ref)),this.div_ref.addClass("n2_zoomify_image_wrapper");try{var o=getComputedStyle(this.div_ref[0],"");o.getPropertyValue("border-top-width"),this.div_half_width=o.getPropertyValue("width"),this.div_half_height=o.getPropertyValue("height")}catch(e){this.div_ref.css("border-top-width"),this.div_half_width=this.div_ref.css("width"),this.div_half_height=this.div_ref.css("height")}this.div_half_width=Math.round(parseInt(this.div_half_width,10)/2),this.div_half_height=Math.round(parseInt(this.div_half_height,10)/2),this.img_orig_width=this.img_ref.width(),this.img_orig_height=this.img_ref.height();for(var s=[{t:"in",s:"on"},{t:"in",s:"off"},{t:"out",s:"on"},{t:"out",s:"off"}],a=0,l=s.length;a<l;++a){var c=s[a],d=c.t+"-"+c.s;this.zoom_control_refs[d]=e("<div>").addClass("n2_zoomify_control n2_zoomify_"+c.t+" n2_zoomify_"+c.s),"in"===c.t?"on"===c.s&&this.zoom_control_refs[d].mousedown(function(){return r.image_zoom_in()}):"on"===c.s&&this.zoom_control_refs[d].mousedown(function(){return r.image_zoom_out()}),"on"===c.s&&this.zoom_control_refs[d].css({cursor:"pointer"}),this.zoom_control_refs[d].appendTo(this.div_ref)}var u=2*this.div_half_width,h=2*this.div_half_height,p=this.img_orig_width,f=this.img_orig_height;for(this.zoom_levels[this.zoom_levels.length]=p;p>u||f>h;)p*=.75,f*=.75,this.zoom_levels[this.zoom_levels.length]=Math.round(p);this.zoom_levels.reverse(),this.zoom_levels[this.zoom_levels.length]=Math.round(1.75*this.img_orig_width),this.zoom_levels[this.zoom_levels.length]=Math.round(3*this.img_orig_width),this.zoom_level_count=this.zoom_levels.length-1,this.image_zoom(0),this.img_ref.css({visibility:"visible"}),this.div_ref.addClass("js-active"),this.img_ref.mousedown(function(){return r.image_move_start()}).bind("touchstart",function(){return r.image_move_start()}),this.div_ref.bind("DOMMouseScroll",function(e){return r.scroll_event(e)}),this.div_ref.bind("mousewheel",function(e){return r.scroll_event(e)}),document.onkeyup=function(e){var t=e?e.which:window.event.keyCode;37===t||39===t?(r.img_current_left=r.img_current_left+(39===t?50:-50),r.image_move_update()):38===t||40===t?(r.img_current_top=r.img_current_top+(40===t?50:-50),r.image_move_update()):107===t||187===t||61===t?r.image_zoom_in():109!==t&&189!==t||r.image_zoom_out()}}t.log("ZoomImage",this)},image_zoom:function(e){var t=this,i=this.zoom_level+e;if(i>=this.zoom_level_count){if(i>this.zoom_level_count)return this.div_ref.css({opacity:.5}),void setTimeout(function(){t.div_ref.css({opacity:1})},150);this.zoom_control_refs["in-on"].css({display:"none"}),this.zoom_control_refs["in-off"].css({display:"block"})}else this.zoom_control_refs["in-on"].css({display:"block"}),this.zoom_control_refs["in-off"].css({display:"none"});if(i<=0){if(i<0)return this.div_ref.css({opacity:.5}),void setTimeout(function(){t.div_ref.css({opacity:1})},150);this.zoom_control_refs["out-on"].css({display:"none"}),this.zoom_control_refs["out-off"].css({display:"block"})}else this.zoom_control_refs["out-on"].css({display:"block"}),this.zoom_control_refs["out-off"].css({display:"none"});this.zoom_level=i;var n=this.zoom_levels[i],r=this.zoom_levels[i]*(this.img_orig_height/this.img_orig_width);if(this.img_ref.width(n),this.img_ref.height(r),null===this.img_current_left)this.img_current_left=this.div_half_width-n/2,this.img_current_top=this.div_half_height-r/2;else{var o=n/this.img_zoom_width;this.img_current_left=this.div_half_width-(this.div_half_width-this.img_current_left)*o,this.img_current_top=this.div_half_height-(this.div_half_height-this.img_current_top)*o}this.img_zoom_width=n,this.img_zoom_height=r,this.img_ref.css({left:this.img_current_left+"px",top:this.img_current_top+"px"})},image_zoom_in:function(){this.image_zoom(1)},image_zoom_out:function(){this.image_zoom(-1)},scroll_event:function(e){var t=(e=e||window.event).detail?-1*e.detail:e.wheelDelta/40;return this.image_zoom(t>0?1:-1),e.preventDefault?e.preventDefault():e.returnValue=!1,!1},event_coords:function(e){var t=[];return e.touches&&e.touches.length?(t[0]=e.touches[0].clientX,t[1]=e.touches[0].clientY):(t[0]=e.clientX,t[1]=e.clientY),t},image_move_update:function(){var e=this.div_half_width-this.img_zoom_width,t=this.div_half_height-this.img_zoom_height;this.img_current_left>this.div_half_width&&(this.img_current_left=this.div_half_width),this.img_current_top>this.div_half_height&&(this.img_current_top=this.div_half_height),this.img_current_left<e&&(this.img_current_left=e),this.img_current_top<t&&(this.img_current_top=t),this.img_ref.css({left:this.img_current_left+"px",top:this.img_current_top+"px"})},image_move_event:function(e){e=e||window.event;var t=this.event_coords(e);return this.img_current_left=this.img_start_left+(t[0]-this.origin[0]),this.img_current_top=this.img_start_top+(t[1]-this.origin[1]),this.image_move_update(),e.preventDefault?e.preventDefault():e.returnValue=!1,!1},image_move_start:function(e){(e=e||window.event).preventDefault?e.preventDefault():e.returnValue=!1;var t=(new Date).getTime();this.click_last>t-200?this.image_zoom_in():this.click_last=t,this.img_start_left=this.img_current_left,this.img_start_top=this.img_current_top,this.origin=this.event_coords(e)}});t.zoomify={zoomImage:function(e){return new i(e)}}}(jQuery,nunaliit2),function(e){var t={accesskey:!0,class:!0,contenteditable:!0,contextmenu:!0,dir:!0,draggable:!0,dropzone:!0,hidden:!0,id:!0,itemid:!0,itemprop:!0,itemref:!0,itemscope:!0,itemtype:!0,lang:!0,spellcheck:!0,style:!0,tabindex:!0,title:!0,translate:!0};e.html={isAttributeNameValid:function(e){return e=e.toLowerCase(),!!t[e]||"aria-"===e.substr(0,"aria-".length)||"data-"===e.substr(0,"data-".length)},globalAttributeMap:t}}(nunaliit2),function(e){var t=/^\s*$/;function i(e){return""===e||!!t.test(e)}var n=/^[=-]/;function r(e,t){var i=void 0;return e.length>t&&(i=e[t]),i}function o(e){return e=e.replace(/[&><\r]/g,function(e){return"&"===e?"&amp;":">"===e?"&gt;":"<"===e?"&lt;":"\r"===e?"":e})}function s(e){return e=e.replace(/[><]/g,function(e){return">"===e?"&gt;":"<"===e?"&lt;":e})}var a="\x3c!--",l="--\x3e";function c(e){function t(e){return!!function(e){return!!i(e)||!!n.test(e)}(e)||("*"===e[0]||("#"===e[0]||("{"===e[0]||("}"===e[0]||("|"===e[0]||"!"===e[0])))))}for(var r=[],o=null,s=0,a=e.length;s<a;++s){var l=e[s];null===o?(t(l)||(o=l),r.push(l)):t(l)?(o=null,r.push(l)):(o=o+" "+l,r[r.length-1]=o)}return r}var d=/^\{\|(.*)$/,u=/^\|\}(.*)$/,h=/^\|\+(.*)$/,p=/^(?:\||!)(.*)$/,f=/^\|-(.*)$/;var m=/^\s*([-_a-zA-Z][-_a-zA-Z0-9]*)\s*=\s*"(.*)"\s*$/;var v=/^\s*([-_a-zA-Z][-_a-zA-Z0-9]*)\s*=\s*"(.*)"\s*$/;function g(t){var i=t.split("|"),n=!1,r=i[0],s=void 0;if("http://"===r.substr(0,"http://".length)||"https://"===r.substr(0,"https://".length)||"mailto:"===r.substr(0,"mailto:".length))!0;else{if("nunaliit:"===r.substr(0,"nunaliit:".length))return i[0]=r.substr("nunaliit:".length),function(t){var i=[];i.push(t.shift());for(var n={},r=0,o=t.length;r<o;++r){var s=t[r],a=v.exec(s);if(a){var l=a[1],c=a[2];"class"===l?i.push(c):n[l]=c}else e.log("Invalid wiki nunaliit attribute: "+s)}var d=[];for(d.push('<div class="'),r=0,o=i.length;r<o;++r){var u=i[r];r>0&&d.push(" "),d.push(u)}for(var l in d.push('"'),n){var h=!1;"on"===l.substr(0,"on".length)||("nunaliit-"===l.substr(0,"nunaliit-".length)?h=!0:e.html.isAttributeNameValid(l)&&(h=!0)),h&&(c=n[l],d.push(" "),d.push(l),d.push('="'),d.push(c),d.push('"'))}return d.push("/>"),d.join("")}(i);n=!0,s=r,r="#"}var a=!1,l=r;i.length>1&&(l=i[1],a=!0),l=o(l);var c=[];return c.push('<a class="n2wiki'),n&&(c.push(" n2s_userEvents n2s_createDocOnClick"),a||c.push(" n2s_briefDisplay")),c.push('" href="'),c.push(r),c.push('"'),n&&c.push(' nunaliit-document="'+s+'"'),c.push(">"),c.push(l),c.push("</a>"),c.join("")}e.wiki={WikiToHtml:function(t){var n=e.extend({wiki:null},t).wiki;if("string"!=typeof n)throw new Error("Wiki text must be specified for WikiToHtml()");var v=n.split("\n");v=function(t){function i(e){if(e.commentOpen){if(!(e.line.indexOf(l)>=0))return void(e.skipLine=!0);var t=e.line.indexOf(l),n=o.substr(t+l.length);e.line=n,e.commentOpen=!1}if(e.line.indexOf(a)>=0){t=e.line.indexOf(a);var r=e.line.substr(0,t),o=e.line.substr(t+a.length);e.commentOpen=!0,e.commentFound=!0,e.line=r,o.indexOf(l)>=0&&(t=o.indexOf(l),n=o.substr(t+l.length),e.line=r+n,e.commentOpen=!1,i(e))}}for(var n=[],r={commentOpen:!1,commentFound:!1,skipLine:!1},o=0,s=t.length;o<s;++o){var c=t[o];r.line=c,r.skipLine=!1,r.commentFound=!1,i(r),r.skipLine||(r.commentFound?""!==e.trim(r.line)&&n.push(r.line):n.push(r.line))}return n}(v);for(var y=0,_=v.length;y<_;++y){var S=v[y];v[y]=o(S)}for(v=function(t){for(var i=[],n=[],r=0,o=t.length;r<o;++r){var s=t[r];if("{{"===s.substr(0,2)){var a={start:r};n.push(a)}else"}}"===s.substr(0,2)&&n.length>0&&((a=n.pop()).end=r,i.push(a))}for(r=0,o=i.length;r<o;++r){var l=c(t[(a=i[r]).start]);l&&(t[a.start]=l,t[a.end]="</div>")}return t;function c(t){for(var i=(t=t.substr(2)).split("|"),n={},r=0,o=i.length;r<o;++r){var s=i[r],a=m.exec(s);if(a){var l=a[1],c=a[2];n[l]=c}else e.log("Invalid wiki section attribute: "+s)}var d=[];for(var l in d.push("<div"),n){var u=!1;"on"===l.substr(0,"on".length)||("nunaliit-"===l.substr(0,"nunaliit-".length)?u=!0:e.html.isAttributeNameValid(l)&&(u=!0)),u&&(c=n[l],d.push(" "),d.push(l),d.push('="'),d.push(c),d.push('"'))}return d.push(">"),d.join("")}}(v=function(t){function i(e,t,i){t&&(i.push('<div class="n2wiki n2wiki_tableCaption">'),i.push(t),i.push("</div>"));var n='<table class="n2wiki"';e&&(n+=" ",n+=e),n+=">",i.push(n),i.push("<tr>")}function n(t,n){for(var r=!1,a=void 0,l=void 0,c=0,m=t.length;c<m;++c){var v=t[c],g=d.exec(v),y=u.exec(v),_=h.exec(v),S=p.exec(v),b=f.exec(v);if(g){var I=s(g[1]);(I=e.trim(I)).length>0&&(a=I)}else if(y)r||(i(a,l,n),r=!0),n.push("</tr></table>");else if(_){var C=o(_[1]);(C=e.trim(C)).length>0&&(l=C)}else if(b){r||(i(a,l,n),r=!0);var D=b[1];D=s(D),D=e.trim(D),n.push("</tr>");var w="<tr";D.length>0&&(w+=" ",w+=D),w+=">",n.push(w)}else if(S){r||(i(a,l,n),r=!0);var E=!1;"!"===v[0]&&(E=!0);for(var x=S[1].split("||"),T=0,k=x.length;T<k;++T){var L=x[T].split("|"),M=void 0,O=void 0;L.length>1?(M=L[0],O=L[1]):O=L[0];var A="<td";E&&(A="<th"),M&&(A+=" ",A+=s(M)),A+=">",n.push(A),n.push(o(O)),E?n.push("</th>"):n.push("</td>")}}}}for(var r=[],a=0,l=t.length;a<l;++a){var c=t[a];if("{|"===c.substr(0,2)){for(var m=[];a<l;){if("|}"===(c=t[a]).substr(0,2)){m.push(c);break}m.push(c),++a}n(m,r)}else r.push(c)}return r}(v=function(e){function t(e,i,n){var o=r(e[0],i);"*"===o?n.push('<ul class="n2wiki">'):n.push('<ol class="n2wiki">');for(var s=!1,a=0,l=e.length;a<l;++a){var c=e[a],d=r(c,i+1);if("*"===d||"#"===d){s||n.push('<li class="n2wiki">');for(var u=[];a<l&&r(c=e[a],i+1)===d;)u.push(c),++a;a<l&&--a,t(u,i+1,n),n.push("</li>"),s=!1}else s?n.push('</li><li class="n2wiki">'):n.push('<li class="n2wiki">'),n.push(c.substr(i+1)),s=!0}s&&n.push("</li>"),"*"===o?n.push("</ul>"):n.push("</ol>")}for(var i=[],n=0,o=e.length;n<o;++n){var s=e[n],a=r(s,0);if("*"===a||"#"===a){for(var l=[];n<o&&r(s=e[n],0)===a;)l.push(s),++n;n<o&&--n,t(l,0,i)}else i.push(s)}return i}(v=c(v)))),y=0,_=v.length;y<_;++y)i(S=(S=(S=(S=(S=(S=v[y]).replace(/(?:^)([=]+)(.*)\1/g,function(e,t,i){return"<h"+t.length+' class="n2wiki">'+i+"</h"+t.length+">"})).replace(/(?:^|\n)([-]+)\s*/g,function(e,t){return t.length>=4?'<hr class="n2wiki"/>':t})).replace(/\x5b\x5b([^\x5d]*)\x5d\x5d/g,function(e,t){return g(t)})).replace(/'''([^']+)'''/g,function(e,t){return"<b>"+t+"</b>"})).replace(/''([^']+)''/g,function(e,t){return"<i>"+t+"</i>"}))&&(S="<br/>"),v[y]=S;return v.join("")}}}(nunaliit2),function(e,t){var i="n2.tuio",n=!0,r=400,o=void 0,s=!1,a=void 0,l=void 0,c=0,d=1,u=200,h=1e3,p=.1,f=1250,m=.25,v=1,g=!1,y=void 0,_=void 0,S=0,b=!1,I=16,C=void 0,D=void 0,w=null,E=!1,x=void 0,T=.18,k=void 0,L=800,M=!1,O=0,A=0,F=0,R=30,N=void 0;function P(){return s}function B(){return e("body").hasClass("nunaliit_tuio")}function U(e,t){this.x=e,this.y=t}function j(e,t,i,n){return Math.abs(Math.sqrt((e-i)*(e-i)+(t-n)*(t-n)))}function z(e){if(1==e.length)return e[0];if(2==e.length)return new U((e[0].x+e[1].x)/2,(e[0].y+e[1].y)/2);for(var t=1/0,i=1/0,n=0,r=0,o=0;o<e.length;++o)t=Math.min(t,e[o].x),i=Math.min(i,e[o].y),n=Math.max(n,e[o].x),r=Math.max(r,e[o].y);return new U(t+(n-t)/2,i+(r-i)/2)}function G(e,t,i,n){var r=t.subtract(e),o=n.subtract(i),s=(-r.y*(e.x-i.x)+r.x*(e.y-i.y))/(-o.x*r.y+r.x*o.y),a=(o.x*(e.y-i.y)-o.y*(e.x-i.x))/(-o.x*r.y+r.x*o.y);return s>=0&&s<=1&&a>=0&&a<=1?new U(e.x+a*r.x,e.y+a*r.y):null}function q(e){if(e.length<4)return null;var t=[],i=null,n=null;function r(e,r,o){if(i){for(var s=!1,a=0;a<t.length;++a)if(e<=t[a][1]&&t[a][0]<=r){s=!0;break}!s&&r-e>i[1]-i[0]&&(i=[e,r],n=o)}else i=[e,r],n=o;t.push([e,r])}for(var o=0;o<e.length-3;++o){for(var s=e[o],a=e[o+1],l=!1,c=o+2;c<e.length-1&&!l;++c){var d=e[c],u=e[c+1],h=G(s,a,d,u);h?(r(o,c,h),l=!0):c>o+4&&(j(s.x,s.y,d.x,d.y)<=R?(r(o,c,null),l=!0):j(a.x,a.y,d.x,d.y)<=R?(r(o+1,c,null),l=!0):j(s.x,s.y,u.x,u.y)<=R?(r(o,c+1,null),l=!0):j(a.x,a.y,u.x,u.y)<=R&&(r(o+1,c+1,null),l=!0))}l&&(o=c,l=!1)}if(i){var p=e.slice(i[0],i[1]);return n&&p.push(n),p}return null}function V(e,t,i,n){var r=t.subtract(e),o=r.magnitude(),s=i-o;return o<i?new U(0,0):r.scale(n*s*.5/o)}function H(e,t){U.call(this,e,t),this.targetPos=new U(e,t),this.vel=new U(0,0),this.div=void 0,this.dirty=!1,this.alive=!0,this.birthTime=Date.now(),this.deathTime=void 0,this.distanceMoved=0,this.lastTime=null}function W(){H.call(this,Number.NaN,Number.NaN),this.down=!1,this.downX=Number.NaN,this.downY=Number.NaN,this.index=Number.NaN,this.lastSeen=Date.now(),this.hand=void 0,this.show=function(){b&&(null==this.div&&(this.div=ie(this.x,this.y,this.index)),this.div.style.left=this.x*window.innerWidth-10+"px",this.div.style.top=this.y*window.innerHeight-10+"px")}}function $(){this.id=new Number,this.x=new Number,this.y=new Number,this.angle=new Number,this.div=void 0}function K(e,t){H.call(this,e,t),this.cursors=[],this.index=v++,this.downX=e,this.downY=t}U.prototype.add=function(e){return new U(this.x+e.x,this.y+e.y)},U.prototype.subtract=function(e){return new U(this.x-e.x,this.y-e.y)},U.prototype.scale=function(e){return new U(this.x*e,this.y*e)},U.prototype.magnitude=function(e){return Math.sqrt(this.x*this.x+this.y*this.y)},U.prototype.distance=function(e){var t=this.x-e.x,i=this.y-e.y;return Math.sqrt(t*t+i*i)},H.prototype=Object.create(U.prototype),H.prototype.kill=function(){this.alive=!1,this.deathTime=Date.now()},H.prototype.moveTo=function(e,t){return isNaN(this.x)||isNaN(this.y)||(this.distanceMoved+=j(this.x,this.y,e,t)),e==this.targetPos.x&&t==this.targetPos.y||(this.targetPos=new U(e,t),(isNaN(this.x)||isNaN(this.y))&&(this.x=this.targetPos.x,this.y=this.targetPos.y),this.dirty=!0),n||(this.x=this.targetPos.x,this.y=this.targetPos.y),this.dirty},H.prototype.updatePosition=function(e,t){if(!n)return this.x=this.targetPos.x,this.y=this.targetPos.y,!0;if(!this.lastTime)return this.lastTime=e,!0;if(!this.dirty||this.x==this.targetPos.x&&this.y==this.targetPos.y)return this.dirty=!1,this.lastTime=e,!1;var i=(e-this.lastTime)/200;this.lastTime=e,this.vel=this.vel.scale(.1);var r=V(this.targetPos,this,1e-13,160),o=this.vel.add(r.scale(i)).scale(t),s=o.scale(i),a=this.add(s);return this.x=a.x,this.y=a.y,this.vel=o,s.magnitude()<1e-4&&(this.x=this.targetPos.x,this.y=this.targetPos.y,this.vel=new U(0,0)),this.x=Math.min(Math.max(0,this.x),1),this.y=Math.min(Math.max(0,this.y),1),!0},W.prototype=Object.create(H.prototype),W.prototype.constructor=W,W.prototype.kill=function(){H.prototype.kill.call(this),null!=this.hand&&0==this.hand.numAliveCursors()&&this.hand.kill()},K.prototype=Object.create(H.prototype),K.prototype.constructor=K,K.prototype.updateTargetPosition=function(){if(this.cursors.length>0){var e=z(this.cursors);this.moveTo(e.x,e.y)}},K.prototype.updatePosition=function(e,t){if(!(this.cursors.length<1)){if(!n){var i=z(this.cursors);return this.moveTo(i.x,i.y),!0}if(!this.lastTime)return this.lastTime=e,!0;if(!this.dirty)return this.dirty=!1,this.lastTime=e,!1;var o=(e-this.lastTime)/500;this.lastTime=e,this.vel=this.vel.scale(.1);for(var s=new U(0,0),a=0;a<this.cursors.length;++a){var l=this.cursors[a],c=0;if(l.alive){var d=Date.now()-l.birthTime;c=Math.min(d/r*160,160)}else{var u=Date.now()-l.deathTime;c=Math.min((r-u)/r*160,160)}var h=V(l,this,1e-13,c);s=s.add(h)}var p=this.vel.add(s.scale(o)).scale(t),f=p.scale(o),m=this.add(f);return this.x=m.x,this.y=m.y,this.vel=p,!0}},K.prototype.numAliveCursors=function(){for(var e=0,t=0;t<this.cursors.length;++t)this.cursors[t].alive&&++e;return e},K.prototype.removeCursor=function(e){for(var t=0;t<this.cursors.length;++t)if(this.cursors[t]==e){this.cursors.splice(t,1);break}0==this.cursors.length?function(e){var t=X[e];null!=t.div&&document.body.removeChild(t.div);e==y&&(y=void 0,C=void 0,D=void 0);x=void 0,delete X[e]}(this.index):(this.updateTargetPosition(),this.show())},K.prototype.show=function(){b&&(null==this.div&&(this.div=ie(this.x,this.y,"H"+this.index)),this.div.style.left=this.x*window.innerWidth-10+"px",this.div.style.top=this.y*window.innerHeight-10+"px",this.div.style.borderColor="red")},K.prototype.span=function(){for(var e=0,t=0;t<this.cursors.length;++t)for(var i=0;i<this.cursors.length;++i)t!=i&&(e=Math.max(e,j(this.cursors[t].x,this.cursors[t].y,this.cursors[i].x,this.cursors[i].y)));return e},K.prototype.trimCursors=function(){for(var e=[];this.span()>m;){for(var t=0,i=void 0,n=0;n<this.cursors.length;++n){var r=this.cursors[n],o=j(r.x,r.y,this.x,this.y);o>t&&(t=o,i=n)}null!=i&&(e.push(this.cursors[i]),this.removeCursor(this.cursors[i]))}return e};var Y=new Object,J=new Object,X=new Object;function Q(e,t,i){isNaN(t)||isNaN(i)||function(e,t,i){var n=document.elementFromPoint(t,i);if(null==n)return;Z(e,n,t,i)}(e,t*window.innerWidth,i*window.innerHeight)}function Z(e,t,i,n){var r=new MouseEvent(e,{view:window,bubbles:!0,cancelable:!0,clientX:i,clientY:n,button:0});t.dispatchEvent(r)}function ee(e,t){null!=e[t].div&&document.body.removeChild(e[t].div),null!=e[t].hand&&e[t].hand.removeCursor(e[t]),delete e[t]}function te(e,t){for(var i={},n=0,o=t.length;n<o;++n){i[t[n]]=!0}for(var s in e)e.hasOwnProperty(s)&&e[s].alive&&(i[s]||("function"==typeof e[s].kill&&e[s].kill(),e==Y&&se(s),window.setTimeout(ee,r,e,s)));for(n=t.length-1;n>=0;n--)if(!e.hasOwnProperty(t[n])){var a=t[n];e==Y?(e[a]=new W,e[a].index=a):e==J&&(e[a]=new $)}}function ie(e,t,i){var n=document.createElement("div");return n.className="n2tuio_feedback_circle n2tuio_remove",n.style.width=I+"px",n.style.height=I+"px",n.style.left=e*window.innerWidth-I/2+"px",n.style.top=t*window.innerHeight-I/2+"px",n.innerHTML=i,document.body.appendChild(n),n}function ne(){e(".n2tuio_edit_ring").css({"background-color":"red"}),window.setTimeout(function(){e(".n2tuio_edit_ring").css({"background-color":"transparent"})},500)}function re(e){var t=Y[e];0==S&&null==_&&(_=e,k&&k.show(),g=!0,Q("mousedown",t.x,t.y)),++S}function oe(e){var t=Y[e];if(null==_&&g&&(k&&k.show(),Q("mousedown",t.x,t.y),_=e),e==_){g&&Q("mousemove",t.x,t.y);var i=Date.now()-t.birthTime;t.distanceMoved<=p&&i>f&&(console.log("Long press!"),k&&k.abortStroke(),Q("click",t.x,t.y),ve(),_=void 0,g=!1)}else g&&S>1&&Date.now()-t.birthTime>u&&(k&&k.abortStroke(),_=void 0,g=!1)}function se(t){var i=Y[t];if(t==_){var n=k.setSensitive(!1),r=function(e,t){if(isNaN(e)||isNaN(t))return null;var i=e*window.innerWidth,n=t*window.innerHeight;return document.elementFromPoint(i,n)}(i.x,i.y);k.setSensitive(n);var o=Date.now()-i.birthTime,s=i.distanceMoved<=p&&o<h;if(r&&s&&("input"==r.nodeName.toLowerCase()||"textarea"==r.nodeName.toLowerCase())&&"button"!=r.getAttribute("type")&&e(r).focus(),Q("mouseup",i.x,i.y),r&&s){var a=i.x*window.innerWidth,l=i.y*window.innerHeight;r.id.startsWith("OpenLayers")&&me(),Z("mousedown",r,a,l),Z("mouseup",r,a,l),Z("click",r,a,l)}_=void 0}--S}function ae(e){var t=X[e],i=function(){var e=0;for(var t in X)X.hasOwnProperty(t)&&X[t].alive&&++e;return e}();if(!g)if(null==y&&1==i&&(y=e),1==i&&e==y&&t.cursors.length>1){if(null==C&&null==D)t.moveTo(z(t.cursors)),t.x=t.targetPos.x,t.y=t.targetPos.y;else if(void 0!==N){var n=C-t.x,r=D-t.y;N.mapControl.map.pan(n*window.innerWidth*d,r*window.innerHeight*d,{animate:!1,dragging:!0})}C=t.x,D=t.y}else{var o=[];for(var e in X)X.hasOwnProperty(e)&&X[e].alive&&o.push(X[e]);if(o.length<2)return void(x=void 0);for(var s=0,a=0;a<o.length-1;++a){var l=j(o[a].x,o[a].y,o[a+1].x,o[a+1].y);l>.5*m&&l>s&&(s=l)}if(null!=x){var c=x-s,u=N.mapControl.map.getZoom(),h=N.mapControl.map.getNumZoomLevels();c>T?(u>2?N.mapControl.map.zoomOut():ne(),x=s):c<-T&&(u<h-1?N.mapControl.map.zoomIn():ne(),x=s)}else x=s}}function le(e,t){if(a&&a.isEditing()){for(var i=new ke({tuioService:a}),n=0,r=t.length;n<r;++n)i.addPoint(t[n]);i.endDrawing()}else{g=!1;var o=q(t);if(!o)return;var s=1/0,l=0,c=0,d=1/0;for(n=0;n<o.length;++n)s=Math.min(s,o[n].x),l=Math.max(l,o[n].y),c=Math.max(c,o[n].x),d=Math.min(d,o[n].y);if(c-s>8&&l-d>8){var u=N.mapControl.map.getLonLatFromPixel(new OpenLayers.Pixel(s,d)),h=N.mapControl.map.getLonLatFromPixel(new OpenLayers.Pixel(c,l));N.mapControl.map.zoomToExtent([u.lon,h.lat,h.lon,u.lat])}}}function ce(e){var t,i=function(e,t){var i=1/0,n=null;for(var r in X)if(X.hasOwnProperty(r)){var o=z(X[r].cursors),s=j(e,t,o.x,o.y);s<=m&&X[r].numAliveCursors()<5&&s<=i&&(n=X[r],i=s)}return n}(e.x,e.y);return i?(i.cursors.push(e),i.dirty=!0,i.alive=!0):((i=new K(e.x,e.y)).cursors=[e],X[i.index]=i,t=i.index,X[t],null==y?y=t:(g&&(_=void 0,k&&k.abortStroke(),g=!1),X[y],y=void 0,C=void 0,D=void 0)),e.hand=i,i}function de(e){var t=document.getElementsByClassName("n2_content_text")[0].getBoundingClientRect(),i=t.left+t.width/2,n=t.top+t.height/2;return Math.atan2(e.pageY-n,e.pageX-i)*(180/Math.PI)}function ue(e){document.getElementsByClassName("n2_content_text")[0];e.preventDefault(),e.stopPropagation(),M=!0,F=de(e),document.addEventListener("mousemove",he,!0),document.addEventListener("mouseup",pe,!0)}function he(e){if(M){var t=document.getElementsByClassName("n2_content_text")[0],i=de(e)-F;e.preventDefault(),e.stopPropagation(),A=O+i,t.style.transform="rotate("+A+"deg)"}}function pe(e){M&&(e.preventDefault(),e.stopPropagation(),O=A,M=!1,document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",pe))}function fe(){var e=document.createElement("div");return e.className="n2tuio_rotate_handle n2tuio_remove",e.innerHTML="&orarr;",e.onmousedown=ue,e}function me(){var t=e(".n2_content_text");t.removeClass("n2tuio_showPane"),t.removeAttr("style"),t.children(".n2tuio_rotate_handle").remove()}function ve(){e(".n2_content_text").hasClass("n2tuio_showPane")?me():function(){var t=e(".n2_content_text"),i=document.getElementsByClassName("n2_content_text")[0];t.addClass("n2tuio_showPane"),i.style.transform="rotate("+A+"deg)";var n=fe();n.id="left_rotate_handle",n.style.left="-88px",n.style.borderTopLeftRadius="130px",n.style.borderBottomLeftRadius="130px",i.appendChild(n);var r=fe();r.id="right_rotate_handle",r.style.left="450px",r.style.borderTopRightRadius="130px",r.style.borderBottomRightRadius="130px",i.appendChild(r)}()}var ge=null,ye=!1,_e=1;function Se(e){window.setTimeout(function(){window.requestAnimationFrame(e)},1e3/30)}function be(e){if(!ye||!ge)return ge=e,void Se(be);for(var t=Math.min(e-ge,15),i=ge+t;ye&&i<=e;i+=t)Ie(i);Se(be)}function Ie(e){var t=e-ge;ge=e,_e=Math.max(0,Math.min(_e,_e-t/1e3));var i=!1;for(var n in Y)if(Y.hasOwnProperty(n)){var r=Y[n];i=r.updatePosition(e,_e)||i,r.show()}var o=!1;for(var n in X){(l=X[n]).updateTargetPosition();var s=l.trimCursors();if(s.length>0){for(var a=0;a<s.length;++a)ce(s[a]);o=!0}}for(var n in X){var l=X[n];o&&l.updateTargetPosition(),l.dirty&&(i=l.updatePosition(e,_e)||i,ae(l.index)),l.show()}i||(ye=!1)}function Ce(e,t,i,n){var r=this;this.parent=e,this.drawing=!1,this.isMouseDown=!1,this.startTime=Date.now(),this.points=[],this.pathCallback=n,this.canvas=document.createElement("canvas"),this.canvas.className="n2tuio_overlay n2tuio_remove",t&&(this.canvas.width=t),i&&(this.canvas.height=i),e.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),this.getMousePosition=function(e){var t=r.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}},this.canvas.onmousedown=function(e){var t=r.getMousePosition(e);r.isMouseDown=!0,r.startStroke(t.x,t.y)},this.canvas.onmousemove=function(e){if(r.drawing){var t=r.getMousePosition(e);r.moveTo(t.x,t.y)}},this.canvas.onmouseup=function(e){var t=r.getMousePosition(e);r.moveTo(t.x,t.y),r.mouseUpTime=Date.now(),r.isMouseDown=!1,window.setTimeout(function(){r.endStroke()},1.5*L)}}Ce.prototype.setSensitive=function(e){var t="none"!=this.canvas.style.pointerEvents;return this.canvas.style.pointerEvents=e?"auto":"none",t},Ce.prototype.show=function(){this.canvas.style.left="0px",this.canvas.style.width="100%",this.setSensitive(!0)},Ce.prototype.hide=function(){this.canvas.style.left="100%",this.canvas.style.width="0",this.setSensitive(!1)},Ce.prototype.startStroke=function(e,t){this.context.lineCap="round",this.context.lineWidth=2,a&&a.isEditing()?this.context.strokeStyle="#FF0000":this.context.strokeStyle="#00FF00",this.context.imageSmoothingEnabled=!0,this.drawing?this.context.lineTo(e,t):(this.context.beginPath(),this.context.moveTo(e,t),this.drawing=!0),this.points.push(new U(e,t))},Ce.prototype.moveTo=function(e,t){this.drawing&&(this.points.length>0&&this.points[this.points.length-1].x==e&&this.points[this.points.length-1].y==t||(this.context.lineTo(e,t),this.context.stroke(),this.points.push(new U(e,t))))},Ce.prototype.abortStroke=function(){this.drawing&&(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.hide(),this.drawing=!1,this.isMouseDown=!1,this.points=[])},Ce.prototype.endStroke=function(){if(!this.isMouseDown&&Date.now()-this.mouseUpTime>=L){var e=this.canvas.getBoundingClientRect();this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.hide(),this.points.length>0&&(this.pathCallback(e,this.points),this.points=[]),this.drawing=!1}else{var t=this;window.setTimeout(function(){t.endStroke()},1.5*L)}};var De=t.Class({initialize:function(e){t.extend({},e)},loadConfiguration:function(){var e=t.storage.getLocalStorage().getItem("n2tuio_configuration"),i=void 0;if(e)try{i=JSON.parse(e)}catch(e){t.log("Unable to parse TUIO configuration:"+e)}return i||(i={}),i},saveConfiguration:function(e){var i=t.storage.getLocalStorage(),n=JSON.stringify(e);i.setItem("n2tuio_configuration",n)},deleteConfiguration:function(){t.storage.getLocalStorage().removeItem("n2tuio_configuration")},isEnabled:function(){return this.loadConfiguration().enabled},setEnabled:function(e){var t=this.loadConfiguration();t.enabled=e,this.saveConfiguration(t)},isTableModeActive:function(){return this.loadConfiguration().active},setTableModeActive:function(e){var t=this.loadConfiguration();t.active=e,this.saveConfiguration(t)},getCalibration:function(){var e={cursorXScale:.672,cursorYScale:.953,cursorXOffset:-.04,cursorYOffset:.002,xMargin:450,xOffset:-90,yMargin:15,yOffset:10},i=this.loadConfiguration();return i.calibration&&(e=t.extend(e,i.calibration)),e},setCalibration:function(e){var t=this.loadConfiguration();t.calibration=e,this.saveConfiguration(t)}});function we(){if(!B()){e("body").addClass("nunaliit_tuio"),e(".nunaliit_content").css({left:w.xMargin+w.xOffset+"px",right:w.xMargin-w.xOffset+"px",top:w.yMargin+w.yOffset+"px",bottom:w.yMargin-w.yOffset+"px"});var t=e(".n2_content_map");if(t.length>0){var i=t[0];k=new Ce(i,i.offsetWidth,i.offsetHeight,le),g=!0}var n=e("<div>").addClass("n2tuio_resetExtent_outer n2tuio_remove").appendTo(e(".nunaliit_content"));e("<a>").addClass("n2tuio_resetExtent").attr("href","#").text("#").appendTo(n).click(function(){return a&&a.resetMapToInitialExtent(),!1}),e("<div>").addClass("n2tuio_edit_ring n2tuio_remove").appendTo(e("#content")),l&&l.setTableModeActive(!0),a.disableMapToggleClick(),N&&N.mapControl&&N.mapControl.map&&window.setTimeout(function(){N.mapControl.map.updateSize()},200)}}function Ee(){B()?B()&&(e("body").removeClass("nunaliit_tuio"),e(".nunaliit_content").removeAttr("style"),e(".n2tuio_remove").remove(),me(),l&&l.setTableModeActive(!1),a.restoreMapToggleClick(),N&&N.mapControl&&N.mapControl.map&&window.setTimeout(function(){N.mapControl.map.updateSize()},200)):we()}function xe(){(l=new De).isEnabled()&&"function"==typeof io&&((o=io("http://localhost:3000"))&&(o.on("cursor update",function(e){te(Y,e.alive),function(e){for(var t in e)if(e.hasOwnProperty(t)&&null!=e[t]&&null!=Y[t]){var i=(e[t][0]-.5)*w.cursorXScale+.5+w.cursorXOffset,r=(e[t][1]-.5)*w.cursorYScale+.5+w.cursorYOffset;if(!isNaN(i)&&!isNaN(r)){if(Y[t].moveTo(i,r),ye=!0,Y[t].down){oe(t);var o=Math.abs(j(Y[t].x,Y[t].y,i,r));_e=Math.min(1,_e+1e3*o)}else Y[t].down=!0,Y[t].birthTime=Date.now(),Y[t].downX=i,Y[t].downY=r,ce(Y[t]),re(t),_e=Math.min(1,_e+1);n||Y[t].show(),Y[t].hand&&(Y[t].hand.dirty=!0)}}if(!n){for(var t in X){(c=X[t]).updateTargetPosition();var s=c.trimCursors();if(s.length>0){for(var l=0;l<s.length;++l)ce(s[l]);cursorsMoved=!0}}for(var t in X){var c;(c=X[t]).updateTargetPosition(),c.dirty&&ae(c.index),c.show()}}a&&a._updateCursors(Y,X)}(e.set)}),o.on("tangibles update",function(e){te(J,e.alive),function(e){for(var t in e)e.hasOwnProperty(t)&&null!=e[t]&&null!=J[t]&&(J[t].id=e[t][0],J[t].x=(e[t][1]-.5)*w.cursorXScale+.5+w.cursorXOffset,J[t].y=(e[t][2]-.5)*w.cursorYScale+.5+w.cursorYOffset,J[t].angle=e[t][3],J[t].alive=!0);a&&a._updateTangibles(J)}(e.set)}),o.on("welcome",function(e){s=!0,t.log("tuio connected")}),o.emit("new client",{})),w=l.getCalibration(),window.setInterval(function(){c=0,E&&t.storage&&t.storage.getLocalStorage&&void 0!==JSON&&JSON.stringify&&JSON.parse&&(l.setCalibration(w),E=!1)},2e3),window.onkeydown=function(t){var i=t.keyCode?t.keyCode:t.which;if(27===i&&++c>=3&&(c=0,Ee()),B()){var n=e(".nunaliit_content")[0];70==i?b=!b:67===i&&c>=2?a&&a.startCalibration():66==i?e(".n2tuio_edit_ring").toggleClass("n2tuio_hide"):t.shiftKey?37==i?(t.altKey?w.cursorXOffset-=.001:w.cursorXScale-=.001,E=!0):39==i?(t.altKey?w.cursorXOffset+=.001:w.cursorXScale+=.001,E=!0):40==i?(t.altKey?w.cursorYOffset+=.001:w.cursorYScale-=.001,E=!0):38==i&&(t.altKey?w.cursorYOffset-=.001:w.cursorYScale+=.001,E=!0):37==i?(t.altKey?w.xMargin+=2:w.xOffset-=2,n.style.left=w.xMargin+w.xOffset+"px",n.style.right=w.xMargin-w.xOffset+"px",E=!0):39==i?(t.altKey?w.xMargin-=2:w.xOffset+=2,n.style.left=w.xMargin+w.xOffset+"px",n.style.right=w.xMargin-w.xOffset+"px",E=!0):40==i?(t.altKey?w.yMargin+=2:w.yOffset+=2,n.style.top=w.yMargin+w.yOffset+"px",n.style.bottom=w.yMargin-w.yOffset+"px",E=!0):38==i?(t.altKey?w.yMargin-=2:w.yOffset-=2,n.style.top=w.yMargin+w.yOffset+"px",n.style.bottom=w.yMargin-w.yOffset+"px",E=!0):80==i&&ve()}},n&&window.requestAnimationFrame(be),l.isTableModeActive()&&we())}var Te=t.Class({intervalId:null,timeLeft:null,canvasId:null,canvasContext:null,width:null,height:null,initialize:function(i){t.extend({},i);var n=this;this.timeLeft=10,this.intervalId=window.setInterval(function(){n.timeLeft=n.timeLeft-1,n.timeLeft<=0&&(t.log("CalibrationProcess aborting",this),n._abortProcess())},500);var r=e(".nunaliit_content");this.width=r.width(),this.height=r.height(),this.canvasId=t.getUniqueId();var o=e("<canvas>").attr("id",this.canvasId).attr("width",this.width).attr("height",this.height).css({position:"absolute",left:"0",top:"0"}).appendTo(r)[0];this.canvasContext=o.getContext("2d"),o.onmousedown=function(e){return n._mouseDown(e)},this._startFirstStep(),t.log("CalibrationProcess",this)},_mouseDown:function(e){var i=this._getMousePosition(e);return t.log("calibration mouse down",i),1==this.step?(this.press1=i,this._clearCanvas(),this._startSecondStep()):2==this.step&&(this.press2=i,this._clearCanvas(),this._calibrate()),!1},_calibrate:function(){this._abortProcess()},_clearCanvas:function(){this.canvasContext.clearRect(0,0,this.width,this.height)},_startFirstStep:function(){this.step=1,this.step1={x:Math.floor(this.width/2),y:Math.floor(this.height/2)},this._drawMarker(this.step1)},_startSecondStep:function(){this.step=2,this.step2={x:this.step1.x+250,y:this.step1.y+250},this._drawMarker(this.step2)},_drawMarker:function(e){this.canvasContext.fillStyle="#000000",this.canvasContext.fillRect(e.x-7,e.y-7,14,14),this.canvasContext.fillStyle="#ffff00",this.canvasContext.fillRect(e.x-5,e.y-5,10,10),this.canvasContext.fillStyle="#000000",this.canvasContext.fillRect(e.x-1,e.y-1,2,2)},_getMousePosition:function(t){var i=e("#"+this.canvasId)[0].getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}},_abortProcess:function(){window.clearInterval(this.intervalId),e("#"+this.canvasId).remove(),this.canvasContext=null,t.log("CalibrationProcess ended",this)}}),ke=t.Class({tuioService:null,positions:null,initialize:function(e){var i=t.extend({tuioService:null},e);this.positions=[],this.tuioService=i.tuioService},addPoint:function(e){0!=this.positions.length&&this.positions[this.positions.length-1].x==e.x&&this.positions[this.positions.length-1].y==e.y||this.positions.push(e)},positionsToPoints:function(e){for(var t=[],i=0;i<e.length;++i){var n=e[i],r=this.tuioService.getMapPosition(n.x,n.y);if(r){var o=new OpenLayers.Geometry.Point(r.lon,r.lat);t.push(o)}}return t},getGeometry:function(){if(0==this.positions.length)return null;var e=this.positions[0],t=this.positions[this.positions.length-1],i=null;if(!(function(e){if(e.length<2)return 0;for(var t=0,i=0;i<e.length-1;++i){var n=e[i],r=e[i+1];t+=j(n.x,n.y,r.x,r.y)}return t}(this.positions)<=16)){if(null!=(i=q(this.positions))||j(e.x,e.y,t.x,t.y)<=16){for(var n=i?this.positionsToPoints(i):this.positionsToPoints(this.positions),r=new OpenLayers.Geometry.LinearRing,o=0;o<n.length;++o)r.addPoint(n[o]);return new OpenLayers.Geometry.Polygon([r])}n=this.positionsToPoints(this.positions);var s=new OpenLayers.Geometry.LineString;for(o=0;o<n.length;++o)s.addPoint(n[o]);return s}var a=z(this.positions),l=this.tuioService.getMapPosition(a.x,a.y);return l?new OpenLayers.Geometry.Point(l.lon,l.lat):null},endDrawing:function(){if(this.tuioService.isEditing()){var e=this.getGeometry();if(e){var i=this.tuioService.getMapControl();i&&(t.log("mapControl",i),i.initiateEditFromGeometry({geometry:e,suppressCenter:!0}),this.tuioService.dispatch({type:"editTriggerSave"}))}}}}),Le=t.Class({dispatchService:null,tangibleState:null,unrecognizedTangibles:null,editing:null,mapEditing:null,moduleDisplay:null,originalMapToggleClick:null,initialize:function(e){var n=t.extend({dispatchService:null},e),r=this;if(this.tangibleState={},this.unrecognizedTangibles={},this.editing=!1,this.mapEditing=!1,this.originalMapToggleClick=!0,this.dispatchService=n.dispatchService,this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(i,"tuioGetState",o),this.dispatchService.register(i,"reportModuleDisplay",o),this.dispatchService.register(i,"editInitiate",o),this.dispatchService.register(i,"mapReportMode",o),this.dispatchService.register(i,"editClosed",o),this.dispatchService.register(i,"start",o)}a=this},startCalibration:function(){new Te},getModuleDisplay:function(){return this.moduleDisplay},isEditing:function(){return!!this.editing||!!this.mapEditing},getMapControl:function(){var e=void 0;return this.moduleDisplay&&(e=this.moduleDisplay.mapControl),e},getOpenLayersMap:function(){var e=void 0,t=this.getMapControl();return t&&(e=t.map),e},getMapPosition:function(e,t){var i=void 0,n=this.getOpenLayersMap();return n&&(i=n.getLonLatFromPixel({x:e,y:t})),i},getMapProjection:function(){var e=void 0,t=this.getOpenLayersMap();return t&&(e=t.getProjectionObject()),e},resetMapToInitialExtent:function(){this.dispatch({type:"mapResetExtent"})},disableMapToggleClick:function(){var e=this.getMapControl();e&&e.options&&(e.options.toggleClick=!1)},restoreMapToggleClick:function(){var e=this.getMapControl();e&&e.options&&(e.options.toggleClick=this.originalMapToggleClick)},dispatch:function(e){this.dispatchService&&this.dispatchService.send(i,e)},_handle:function(t,i,n){if("tuioGetState"===t.type)P()&&(t.connected=!0),B()?t.mode="table":t.mode="regular";else if("reportModuleDisplay"===t.type){N=t.moduleDisplay,this.moduleDisplay=t.moduleDisplay,(r=this.getMapControl())&&r.options&&(this.originalMapToggleClick=r.options.toggleClick)}else if("editInitiate"===t.type)this.editing=!0;else if("editClosed"===t.type)this.editing=!1;else if("mapReportMode"===t.type){var r;(r=t.mapControl)&&r.modes&&r.modes.NAVIGATE&&(t.mode===r.modes.NAVIGATE.name?(this.mapEditing=!1,e("body").removeClass("nunaliit_editing")):(this.mapEditing=!0,e("body").addClass("nunaliit_editing")))}else"start"===t.type&&xe()},_updateTangibles:function(e){for(var n in e){var r=e[n],o=r.id;r.service||(r.service={}),0===o?r.alive&&!r.service.start?(r.service.start=!0,this.dispatchService.send(i,{type:"loginShowForm"})):r.alive||r.service.end||(r.service.end=!0,this.dispatchService.send(i,{type:"logout"})):1===o?r.service.start||(r.service.start=!0,this.startCalibration()):this.unrecognizedTangibles[o]||(this.unrecognizedTangibles[o]=!0,t.log("Tangible not recognized: "+o))}this.tangibleState.tangibles=e,this.dispatchService&&this.dispatchService.send(i,{type:"tuioTangiblesUpdate",tangibles:this.tangibleState})},_updateCursors:function(e,t){this.tangibleState.cursors=e,this.tangibleState.hands=t,this.dispatchService&&this.dispatchService.send(i,{type:"tuioTangiblesUpdate",tangibles:this.tangibleState})}});t.tuioClient={IsTuioConnected:P,TuioService:Le,TuioConfiguration:De}}(jQuery,nunaliit2),function(e,t){var i="n2.utilities",n=t.Class({layerId:null,onlyWithGeometries:null,dispatchService:null,initialize:function(e){var n=t.extend({layerId:null,onlyWithGeometries:!1,dispatchService:null},e),r=this;if(this.layerId=n.layerId,this.onlyWithGeometries=n.onlyWithGeometries,this.dispatchService=n.dispatchService,this.dispatchService){this.dispatchService.register(i,"preDocCreation",function(e,t,i){r._handle(e,t,i)})}t.log("AssignLayerOnDocumentCreation",this)},_handle:function(e,t,i){if("preDocCreation"===e.type){var n=e.doc,r=!0;this.onlyWithGeometries&&(n.nunaliit_geom||(r=!1)),r&&(n.nunaliit_layers||(n.nunaliit_layers=[]),this.layerId&&n.nunaliit_layers.indexOf(this.layerId)<0&&n.nunaliit_layers.push(this.layerId))}}}),r=t.Class({docIds:null,dispatchService:null,initialize:function(e){var n=t.extend({docId:null,docIds:null,dispatchService:null},e),r=this;if(this.dispatchService=n.dispatchService,this.docIds=[],this.moduleStarted=!1,"string"==typeof n.docId&&this.docIds.push(n.docId),t.isArray(n.docIds))for(var o=0,s=n.docIds.length;o<s;++o){var a=n.docIds[o];"string"==typeof a&&this.docIds.push(a)}if(this.dispatchService){this.dispatchService.register(i,"modulePerformIntroduction",function(e,t,i){r._handle(e,t,i)})}t.log("SelectDocumentOnModuleIntroduction",this)},_handle:function(e,t,n){"modulePerformIntroduction"===e.type&&(e.performed||(this.docIds.length>1?(e.performed=!0,this.dispatchService.send(i,{type:"selected",docIds:this.docIds})):this.docIds.length>0&&(e.performed=!0,this.dispatchService.send(i,{type:"selected",docId:this.docIds[0]}))))}}),o=t.Class("SelectDocumentOnFilterChange",{dispatchService:null,sourceModelId:null,selectionToDocId:null,selectedChoicesChangeEventName:null,performSelectedEvent:null,initialize:function(e){var n=t.extend({dispatchService:void 0,sourceModelId:void 0,selectionMap:void 0,performSelectedEvent:void 0},e),r=this;if(this.dispatchService=n.dispatchService,"string"!=typeof n.sourceModelId)throw new Error("In configuration for SelectDocumentOnFilterChange, sourceModelId must be specified as a string");if(this.sourceModelId=n.sourceModelId,this.selectionToDocId={},n.selectionMap&&"object"==typeof n.selectionMap)for(var o in n.selectionMap){var s=n.selectionMap[o],a=this._selectionToString(s);a&&(this.selectionToDocId[a]=o)}if(this.performSelectedEvent=!1,n.performSelectedEvent&&(this.performSelectedEvent=!0),this.dispatchService&&this.sourceModelId){var l={type:"modelGetInfo",modelId:this.sourceModelId,modelInfo:null};this.dispatchService.synchronousCall(i,l);var c=l.modelInfo;if(c&&c.parameters&&c.parameters.selectedChoices){var d=c.parameters.selectedChoices;this.selectedChoicesChangeEventName=d.changeEvent}this.selectedChoicesChangeEventName&&this.dispatchService.register(i,this.selectedChoicesChangeEventName,function(e,t,i){r._handleFilterChange(e,t,i)})}t.log(this._classname,this)},_handleFilterChange:function(e,t,n){if(this.selectedChoicesChangeEventName===e.type&&e.value){var r=e.value,o=this._selectionToString(r),s=this.selectionToDocId[o];if(s){var a="userSelect";this.performSelectedEvent&&(a="selected"),this.dispatchService.send(i,{type:a,docId:s})}}},_selectionToString:function(e){var i=this,n=void 0;if("string"==typeof e)n=this._escapeSelector(e);else if(t.isArray(e)){var r=[];e.forEach(function(e){"string"==typeof e&&r.push(i._escapeSelector(e))}),r.sort(),n=r.join("|")}return n},_escapeSelector:function(e){return e.replace(/\|/g,"oranges")}}),s=t.Class({dispatchService:null,initialize:function(e){var n=t.extend({dispatchService:null},e),r=this;if(this.dispatchService=n.dispatchService,this.dispatchService){this.dispatchService.register(i,"utilityCreate",function(e,t,i){r._handle(e,t,i)})}},_handle:function(e,i,s){if("utilityCreate"===e.type){if(!e.utilityType)return void t.log("utilityType must be provided when creating a utility");if("assignLayerOnDocumentCreation"===e.utilityType){var a={};if("object"==typeof e.utilityOptions)for(var l in e.utilityOptions){var c=e.utilityOptions[l];a[l]=c}e.config&&e.config.directory&&(a.dispatchService=e.config.directory.dispatchService),new n(a),e.created=!0}else if("selectDocumentOnModuleIntroduction"===e.utilityType){a={};if("object"==typeof e.utilityOptions)for(var l in e.utilityOptions){c=e.utilityOptions[l];a[l]=c}e.config&&e.config.directory&&(a.dispatchService=e.config.directory.dispatchService),new r(a),e.created=!0}else if("selectDocumentOnFilterChange"===e.utilityType){a={};if("object"==typeof e.utilityOptions)for(var l in e.utilityOptions){c=e.utilityOptions[l];a[l]=c}e.config&&e.config.directory&&(a.dispatchService=e.config.directory.dispatchService),new o(a),e.created=!0}else t.mapUtilities&&"function"==typeof t.mapUtilities.HandleUtilityCreateRequests&&t.mapUtilities.HandleUtilityCreateRequests(e,i,s),t.utilitiesModel&&"function"==typeof t.utilitiesModel.HandleUtilityCreateRequests&&t.utilitiesModel.HandleUtilityCreateRequests(e,i,s),t.utilitiesChangeDetectors&&"function"==typeof t.utilitiesChangeDetectors.HandleUtilityCreateRequests&&t.utilitiesChangeDetectors.HandleUtilityCreateRequests(e,i,s)}}});t.utilities={Service:s,AssignLayerOnDocumentCreation:n,SelectDocumentOnModuleIntroduction:r,SelectDocumentOnFilterChange:o}}(jQuery,nunaliit2),function(e,t){var i="n2.utilitiesModel",n=t.Class({initialize:function(e){t.extend({},e)},execute:function(){throw new Exception("Action.execute() must be implemented by subclasses")}}),r=t.Class("SetFilterSelectionAction",n,{dispatchService:null,modelId:null,selection:null,selectAll:null,selectedChoicesSetEventName:null,allSelectedSetEventName:null,initialize:function(e){var n=t.extend({dispatchService:void 0,modelId:void 0,selection:void 0,selectAll:void 0},e);if(this.dispatchService=n.dispatchService,this.modelId=n.modelId,this.selection=n.selection,this.selectAll=n.selectAll,"string"!=typeof this.modelId)throw new Error("modelId must be a string");if(void 0===this.selection);else{if(!t.isArray(this.selection))throw new Error('If parameter "selection" is specified, then it must be an array of strings');this.selection.forEach(function(e){if("string"!=typeof e)throw new Error('If parameter "selection" is specified, then it must be an array of strings')})}if(void 0===this.selectAll);else if("boolean"!=typeof this.selectAll)throw new Error('If parameter "selectAll" is specified, it must be a boolean');if(!this.selectAll&&!this.selection)throw new Error('At least one of the parameters "selectAll" or "selection" must be specified.');if(this.dispatchService){var r={type:"modelGetInfo",modelId:this.modelId,modelInfo:null};this.dispatchService.synchronousCall(i,r);var o=r.modelInfo;if(o&&o.parameters){if(o.parameters.selectedChoices){var s=o.parameters.selectedChoices;this.selectedChoicesSetEventName=s.setEvent}if(o.parameters.allSelected){s=o.parameters.allSelected;this.allSelectedSetEventName=s.setEvent}}}},execute:function(){this.selectAll?this.dispatchService.send(i,{type:this.allSelectedSetEventName,value:!0}):this.selection&&this.dispatchService.send(i,{type:this.selectedChoicesSetEventName,value:this.selection})}});function o(e,t){if("object"!=typeof t)throw new Error("Unable to create an instance of Action since definition is not provided");"string"==typeof t.actionType&&"string"!=typeof t.type&&(t.type=t.actionType);var n={type:"instanceCreate",instanceConfiguration:t,instance:void 0};e.synchronousCall(i,n);var r=n.instance;if(!r)throw new Error("Unable to create an instance of type: "+t.type);if("object"!=typeof r)throw new Error("Instance of type: "+t.type+" is not an object");if("function"!=typeof r.execute)throw new Error("Instance of type: "+t.type+" must implement execute() method");return r}var s=t.Class("FilterMonitor",{dispatchService:null,sourceModelId:null,allSelectedAction:null,notAllSelectedAction:null,selectedChoicesChangeEventName:null,allSelectedChangeEventName:null,allSelected:null,initialize:function(e){var n=t.extend({dispatchService:void 0,sourceModelId:void 0,onAllSelected:void 0,onNotAllSelected:void 0},e),r=this;if(this.dispatchService=n.dispatchService,this.sourceModelId=n.sourceModelId,"object"==typeof n.onAllSelected&&(this.allSelectedAction=o(this.dispatchService,n.onAllSelected)),"object"==typeof n.onNotAllSelected&&(this.notAllSelectedAction=o(this.dispatchService,n.onNotAllSelected)),this.dispatchService){var s={type:"modelGetInfo",modelId:this.sourceModelId,modelInfo:null};this.dispatchService.synchronousCall(i,s);var a=s.modelInfo;if(a&&a.parameters){if(a.parameters.selectedChoices){var l=a.parameters.selectedChoices;this.selectedChoicesChangeEventName=l.changeEvent,l.value&&(this.selectedChoices=l.value,this.selectedChoiceIdMap={},this.selectedChoices.forEach(function(e){r.selectedChoiceIdMap[e]=!0}))}if(a.parameters.allSelected){l=a.parameters.allSelected;this.allSelectedChangeEventName=l.changeEvent,"boolean"==typeof l.value&&(this.allSelected=l.value,this.allSelected?this.allSelectedAction&&this.allSelectedAction.execute():this.notAllSelectedAction&&this.notAllSelectedAction.execute())}}var c=function(e,t,i){r._handle(e,t,i)};this.selectedChoicesChangeEventName&&this.dispatchService.register(i,this.selectedChoicesChangeEventName,c),this.allSelectedChangeEventName&&this.dispatchService.register(i,this.allSelectedChangeEventName,c)}t.log(this._classname,this)},_handle:function(e,t,i){this.allSelectedChangeEventName===e.type&&"boolean"==typeof e.value&&(this.allSelected&&!e.value?this.notAllSelectedAction&&this.notAllSelectedAction.execute():!this.allSelected&&e.value&&this.allSelectedAction&&this.allSelectedAction.execute(),this.allSelected=e.value)}});t.utilitiesModel={HandleUtilityCreateRequests:function(e,t,i){if("filterMonitor"===e.utilityType){var n={};if("object"==typeof e.utilityOptions)for(var r in e.utilityOptions){var o=e.utilityOptions[r];n[r]=o}e.config&&e.config.directory&&(n.dispatchService=e.config.directory.dispatchService),new s(n),e.created=!0}},handleInstanceCreate:function(e,t,n){if("setFilterSelection"===e.instanceConfiguration.type){var o=function(e){var t=void 0;if(e){var n={type:"configurationGetCurrentSettings"};e.synchronousCall(i,n),t=n.configuration}return t}(n),s={};if("object"==typeof e.instanceConfiguration)for(var a in e.instanceConfiguration){var l=e.instanceConfiguration[a];s[a]=l}o&&o.directory&&(s.dispatchService=o.directory.dispatchService),e.instance=new r(s)}},FilterMonitor:s}}(jQuery,nunaliit2),function(e,t){var i=t.Class("InputChangeDetector",{disable:null,initialize:function(i){var n=t.extend({config:null,disable:!1,options:null},i);n.disable&&"boolean"==typeof n.disable&&(this.disable=n.disable),this.disable||(e("body").addClass("n2_input_change_detector"),this.startDetector()),t.log(this._classname,this)},startDetector:function(){e("body").change(function(){e(this).find("input").each(function(){var t=e(this),i=t.val();""===i||t.hasClass("n2_input_detected")?""===i&&t.hasClass("n2_input_detected")&&t.removeClass("n2_input_detected"):t.addClass("n2_input_detected")})})}});t.utilitiesChangeDetectors={HandleUtilityCreateRequests:function(e,t,n){if("inputChangeDetector"===e.utilityType){var r={};if("object"==typeof e.utilityOptions)for(var o in e.utilityOptions){var s=e.utilityOptions[o];r[o]=s}e.config&&e.config.directory&&(r.dispatchService=e.config.directory.dispatchService),new i(r),e.created=!0}},InputChangeDetector:i}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n=!1;function r(e,i){if(!JSON||"function"!=typeof JSON.parse)return t.error.fromString(i);var n=e.responseText;if(!n)return t.error.fromString(i);var r=JSON.parse(n);if(!r)return t.error.fromString(i);var o=void 0;if(o="string"==typeof r.reason?t.error.fromString(r.reason):t.error.fromString(i),r.error){var s="couchDb_"+r.error;o.setCondition(s)}return o}function o(e){return e.toLowerCase().replace(" ","")}var s=t.Class("couch.Session",{server:null,pathToSession:null,changedContextListeners:null,lastSessionContext:null,initialize:function(e,t){if(this.server=e,this.changedContextListeners=[],this.lastSessionContext=null,t&&t.ok){var i=t.userCtx;this.changeContext(i)}},getUrl:function(){return this.server.getSessionUrl()},getContext:function(){return this.lastSessionContext},addChangedContextListener:function(e){"function"==typeof e&&(this.changedContextListeners.push(e),this.lastSessionContext&&e(this.lastSessionContext))},changeContext:function(e){if(this.lastSessionContext=e,this.lastSessionContext)for(var t=0,i=this.changedContextListeners.length;t<i;++t){var n=this.changedContextListeners[t];try{n(this.lastSessionContext)}catch(i){}}},refreshContext:function(i){var n=e.extend({onSuccess:function(e){},onError:t.reportErrorForced},i),o=this,s=this.getUrl(),a={};a.r=Date.now(),e.ajax({url:s,type:"get",async:!0,dataType:"json",data:a,success:function(e){if(e.ok){var t=e.userCtx;o.changeContext(t),n.onSuccess(t)}else n.onError("Malformed context reported")},error:function(e,t,i){var o=r(e,t);n.onError("Error obtaining context: "+o)}})},login:function(i){var s=e.extend({name:null,password:null,onSuccess:function(e){},onError:t.reportErrorForced},i),a=this,l=this.getUrl();if(n&&(l+="?r="+Date.now()),l+="?r="+Date.now(),s.name){var c=o(s.name);e.ajax({url:l,type:"post",async:!0,data:{name:c,password:s.password},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){e&&e.ok?a.refreshContext({onSuccess:s.onSuccess,onError:s.onError}):s.onError("Unknown error during log in")},error:function(e,t,i){var n=r(e,t);s.onError("Error during log in: "+n)}})}else s.onError("A name must be supplied when logging in")},logout:function(i){var n=e.extend({onSuccess:function(e){},onError:t.reportErrorForced},i),o=this,s=this.getUrl();e.ajax({url:s,type:"DELETE",async:!0,dataType:"json",success:function(e){e&&e.ok?o.refreshContext({onSuccess:n.onSuccess,onError:n.onError}):n.onError("Unknown error during log out")},error:function(e,t,i){var o=r(e,t);n.onError("Error during log out: "+o)}})}}),a=t.Class("couch.designDoc",{ddUrl:null,ddName:null,db:null,initialize:function(e){var i=t.extend({ddUrl:null,ddName:null,db:null},e);this.ddUrl=i.ddUrl,this.ddName=i.ddName,this.db=i.db},getDatabase:function(){return this.db},getQueryUrl:function(t){var i=e.extend(!0,{viewName:null,listName:null},t);return i.listName?this.ddUrl+"_list/"+i.listName+"/"+i.viewName:this.ddUrl+"_view/"+i.viewName},queryView:function(i){var o=e.extend(!0,{viewName:void 0,listName:void 0,viewUrl:void 0,startkey:void 0,endkey:void 0,keys:void 0,group:void 0,group_level:void 0,include_docs:void 0,limit:void 0,onlyRows:!0,rawResponse:!1,reduce:!1,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i);JSON&&JSON.stringify||o.onError("json.js is required to query a view");var s=o.viewUrl;s||(s=o.listName?this.ddUrl+"_list/"+o.listName+"/"+o.viewName:this.ddUrl+"_view/"+o.viewName);var a=!1,l=0,c={},d={};for(var u in o)"viewName"===u||"listName"===u||"viewUrl"===u||"onlyRows"===u||"rawResponse"===u||"onSuccess"===u||"onError"===u||void 0===o[u]||null===o[u]||("keys"===u?(a=!0,d[u]=o[u]):(++l,c[u]=JSON.stringify(o[u])));var h="json";if(o.rawResponse&&(h="text"),a){var p=JSON.stringify(d),f=s;if(l>0)f=s+"?"+e.param(c);e.ajax({url:f,type:"POST",async:!0,data:p,contentType:"application/json",dataType:h,success:m,error:function(e,t,i){var n=r(e,t);o.onError("Error during view query "+o.viewName+": "+n)}})}else n&&(c.r=Date.now()),e.ajax({url:s,type:"GET",async:!0,cache:!1,data:c,dataType:h,success:m,error:function(e,t,i){var n=r(e,t);o.onError("Error during view query "+o.viewName+": "+n)}});function m(e){o.onlyRows?e.rows?o.onSuccess(e.rows):o.onError("Unexpected response during view query "+o.view):o.onSuccess(e)}}}),l=t.Class("couch.ChangeNotifier",{changeUrl:null,include_docs:null,pollInterval:null,longPoll:null,timeout:null,style:null,db:null,listeners:null,lastSequence:null,currentRequest:null,currentWait:null,onError:function(e){t.log(e)},initialized:null,initializationListeners:null,initialize:function(e){var i=t.extend({db:null,changeUrl:null,include_docs:!1,pollInterval:5e3,longPoll:!1,timeout:2e4,style:"all_docs",listeners:null,onSuccess:function(e){}},e),n=this;function r(){n.reschedule(),n.requestChanges(),n.initialized=!0,n.initializationListeners.forEach(function(e){e(n)}),n.initializationListeners=null}this.initialized=!1,this.initializationListeners=[],this.listeners=[],this.db=i.db,this.changeUrl=i.changeUrl,this.include_docs=i.include_docs,this.pollInterval=i.pollInterval,this.longPoll=i.longPoll,this.timeout=i.timeout,this.style=i.style,t.isArray(i.listeners)&&i.listeners.forEach(function(e){"function"==typeof e&&n.listeners.push(e)}),"function"==typeof i.onSuccess&&this.initializationListeners.push(i.onSuccess),i.doNotReset?r():this.resetLastSequence({onSuccess:r,onError:function(e){t.logError("Error while obtaining database update sequence: "+e),r()}})},addListener:function(e){"function"==typeof e&&(this.listeners.push(e),this.requestChanges())},addInitializationListener:function(e){"function"==typeof e&&(this.initialized?e(this):this.initializationListeners.push(e))},resetLastSequence:function(e){var i=t.extend({onSuccess:function(){},onError:function(e){}},e),n=this;this.db.getChanges({limit:1,descending:!0,onSuccess:function(e){if(e&&e.last_seq)if("string"==typeof e.last_seq)n.lastSequence=e.last_seq,i.onSuccess();else if("number"==typeof e.last_seq)n.lastSequence=""+e.last_seq,i.onSuccess();else{var t=new Error("Error with database change feed. Can not interpret last_seq: "+e.last_seq);i.onError(t)}},onError:function(e){i.onError("Error during a query of last update sequence: "+e)}})},getLastSequence:function(){return this.lastSequence},_reportChanges:function(e){if("string"==typeof e.last_seq?this.lastSequence=e.last_seq:"number"==typeof e.last_seq&&(this.lastSequence=""+e.last_seq),e.results&&e.results.length>0)for(var t=0,i=this.listeners.length;t<i;++t)this.listeners[t](e)},requestChanges:function(){if(this.listeners&&!(this.listeners.length<1)&&!this.currentRequest&&!this.currentWait){var t={feed:"normal",style:this.style};this.lastSequence&&(t.since=this.lastSequence),this.include_docs&&(t.include_docs=this.include_docs),this.longPoll&&(t.feed="longpoll",t.timeout=this.timeout),n&&(t.r=Date.now()),this.currentRequest=t;var i=this;e.ajax({url:this.changeUrl,type:"GET",async:!0,data:t,dataType:"json",success:function(e){i.currentRequest=null,i._reportChanges(e),i.reschedule()},error:function(e,t,n){var o=r(e,t);i.onError("Error during a server notifications: "+o),i.reschedule()}})}},reschedule:function(){var e=t.utils.getCurrentTime()+this.pollInterval;if(this.currentWait){if(!(this.currentWait.expected>e))return;"function"==typeof clearTimeout&&clearTimeout(this.currentWait.timerId),this.currentWait=null}this.currentWait={delayInMs:this.pollInterval,expected:e};var i=this;this.currentWait.timerId=setTimeout(function(){i.currentWait=null,i.requestChanges()},this.currentWait.delayInMs)}}),c=t.Class("couch.DatabaseCallbacks",{onCreatedCallbacks:null,onUpdatedCallbacks:null,onDeletedCallbacks:null,initialize:function(){this.onCreatedCallbacks=[],this.onUpdatedCallbacks=[],this.onDeletedCallbacks=[]},addOnCreatedCallback:function(e){"function"==typeof e&&this.onCreatedCallbacks.push(e)},addOnUpdatedCallback:function(e){"function"==typeof e&&this.onUpdatedCallbacks.push(e)},addOnDeletedCallback:function(e){"function"==typeof e&&this.onDeletedCallbacks.push(e)},_reportOnCreated:function(e){for(var t=0,i=this.onCreatedCallbacks.length;t<i;++t){(0,this.onCreatedCallbacks[t])(e)}},_reportOnUpdated:function(e){for(var t=0,i=this.onCreatedCallbacks.length;t<i;++t){(0,this.onUpdatedCallbacks[t])(e)}},_reportOnDeleted:function(e){for(var t=0,i=this.onDeletedCallbacks.length;t<i;++t){(0,this.onUpdatedCallbacks[t])(e)}}}),d=t.Class("couch.Database",{dbUrl:null,dbName:null,server:null,callbacks:null,changeNotifier:null,changeNotifierRefreshIntervalInMs:null,initialize:function(e,i){var n=t.extend({dbUrl:null,dbName:null,changeNotifierRefreshIntervalInMs:5e3},e);if(this.server=i,this.dbUrl=n.dbUrl,this.dbName=n.dbName,this.changeNotifierRefreshIntervalInMs=n.changeNotifierRefreshIntervalInMs,!this.dbUrl){var r=i.getPathToServer();this.dbUrl=r+this.dbName+"/"}this.callbacks=new c},getUrl:function(){return this.dbUrl},getServer:function(){return this.server},getDesignDoc:function(t){var i=e.extend({ddUrl:null,ddName:null},t);if("string"!=typeof i.ddUrl){if("string"!=typeof i.ddName)throw new Error("Database.getDesignDoc() must specify ddName as a string if ddUrl is not");i.ddUrl=this.dbUrl+"_design/"+i.ddName+"/"}return i.db=this,new a(i)},getChangeNotifier:function(e){var i=t.extend({onSuccess:function(e){}},e);return this.changeNotifier?this.changeNotifier.addInitializationListener(i.onSuccess):this.changeNotifier=new l({db:this,changeUrl:this.dbUrl+"_changes",pollInterval:this.changeNotifierRefreshIntervalInMs,onSuccess:i.onSuccess}),this.changeNotifier},getChanges:function(i){var o=t.extend({since:void 0,limit:void 0,descending:!1,include_docs:!1,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i),s={feed:"normal"};o.since&&(s.since=o.since),o.limit&&(s.limit=o.limit),o.descending&&(s.descending=o.descending),o.include_docs&&(s.include_docs=o.include_docs),n&&(s.r=Date.now());var a=this.dbUrl+"_changes";e.ajax({url:a,type:"GET",async:!0,data:s,dataType:"json",success:o.onSuccess,error:function(e,t,i){var n=r(e,t);o.onError("Error obtaining database changes: "+n)}})},getDocumentUrl:function(e){if("string"==typeof e)var t=e;else t=e._id;return this.dbUrl+t},getAttachmentUrl:function(e,t){return this.getDocumentUrl(e)+"/"+encodeURIComponent(t)},getDocumentRevision:function(i){var o=e.extend({docId:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i);if(o.docId){var s={startkey:'"'+o.docId+'"',endkey:'"'+o.docId+'"',include_docs:!1};n&&(s.r=Date.now()),e.ajax({url:this.dbUrl+"_all_docs",type:"get",async:!0,data:s,dataType:"json",success:function(e){e.rows&&e.rows[0]&&e.rows[0].value&&e.rows[0].value.rev?o.onSuccess(e.rows[0].value.rev):o.onError("Malformed document revision for: "+o.docId)},error:function(e,t,i){var n=r(e,t);o.onError("Error obtaining document revision for "+o.docId+": "+n)}})}else o.onError("No docId set. Can not retrieve document information")},getDocumentRevisions:function(i){var n=e.extend({docIds:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i);if(n.docIds)if(t.isArray(n.docIds)){var o={keys:n.docIds};e.ajax({url:this.dbUrl+"_all_docs?include_docs=false",type:"POST",async:!0,data:JSON.stringify(o),contentType:"application/json",dataType:"json",success:function(e){if(e.rows){for(var t={},i=0,r=e.rows.length;i<r;++i){var o=e.rows[i];o.id&&o.value&&o.value.rev&&(o.value.deleted||(t[o.id]=o.value.rev))}n.onSuccess(t)}else n.onError("Malformed document revisions")},error:function(e,t,i){var o=r(e,t);n.onError("Error obtaining document revision for "+n.docId+": "+o)}})}else n.onError("docIds must ba an array. Can not retrieve document revisions");else n.onError("No docIds set. Can not retrieve document revisions")},buildUploadFileForm:function(n,r){var o=this,s=e.extend({docId:null,rev:null,doc:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},r);function a(t,n,a){var l=e(t),c=e('<form method="post"></form>'),d=e('<input class="n2CouchInputButton" type="button"/>');c.append(e('<input class="n2CouchInputFile" type="file" name="_attachments"/>')),c.append(e('<input type="hidden" name="_rev" value="'+a+'"/>')),d.val(i("Upload")),c.append(d),l.append(c),d.click(function(){c.ajaxSubmit({type:"post",url:o.dbUrl+n,dataType:"json",success:function(e){l.find("*").removeAttr("disabled"),e.error?s.onError(i("Error while uploading: ")+e.error,r):s.onSuccess(e,r)},error:function(e,t,n){l.find("*").removeAttr("disabled"),s.onError(i("Error while uploading: ")+n,r)}}),l.find(".n2CouchInputButton").attr("disabled","disabled")})}n.empty(),e.fn.ajaxSubmit||s.onError("Can not perform file uploads unless jquery.form.js is included"),null==s.docId&&s.doc&&(s.docId=s.doc._id),null==s.docId&&s.onError("Must specify document id when performing file uploads"),null==s.rev&&s.doc&&(s.rev=s.doc._rev),null==s.rev?this.getDocumentRevision({docId:s.docId,onSuccess:function(e){n.each(function(t,i){a(i,s.docId,e)})},onError:s.onError}):n.each(function(e,t){a(t,s.docId,s.rev)})},createDocument:function(n){var o=e.extend(!0,{data:{},deviceId:void 0,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},n);JSON&&JSON.stringify||o.onError("json.js is required to create database documents");var s=this,a="";o.deviceId&&(a="?deviceId="+o.deviceId);var l=o.data._id;function c(n){e.ajax({url:s.dbUrl+n+a,type:"put",async:!0,data:JSON.stringify(o.data),contentType:"application/json",dataType:"json",success:function(e){s.callbacks._reportOnCreated(e),o.onSuccess(e)},error:function(e,n,s){var a=r(e,n),l=t.error.fromString(i("Error creating document"),a);o.onError(l)}})}l?c(l):this.server.getUniqueId({onSuccess:c,onError:o.onError})},updateDocument:function(n){var o=e.extend(!0,{data:null,deviceId:void 0,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},n);if(JSON&&"function"==typeof JSON.stringify)if(o.data&&o.data._id&&o.data._rev){var s="";o.deviceId&&(s="?deviceId="+o.deviceId);var a=this;e.ajax({url:a.dbUrl+o.data._id+s,type:"PUT",async:!0,data:JSON.stringify(o.data),contentType:"application/json",dataType:"json",success:function(e){a.callbacks._reportOnUpdated(e),o.onSuccess(e)},error:function(e,n,s){var a=r(e,n),l=t.error.fromString(i("Error updating document"),a);o.onError(l)}})}else o.onError("On update, a valid document with _id and _rev attributes must be supplied");else o.onError("json.js is required to update database documents")},deleteDocument:function(n){var o=e.extend(!0,{data:null,deviceId:void 0,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},n);if(JSON&&"function"==typeof JSON.stringify)if(o.data&&o.data._id&&o.data._rev){var s="";o.deviceId&&(s="&deviceId="+o.deviceId);var a=this;e.ajax({url:a.dbUrl+o.data._id+"?rev="+o.data._rev+s,type:"DELETE",async:!0,dataType:"json",success:function(e){a.callbacks._reportOnDeleted(e),o.onSuccess(e)},error:function(e,n,s){var a=r(e,n),l=t.error.fromString(i("Error deleting document"),a);o.onError(l)}})}else o.onError("On delete, a valid document with _id and _rev attributes must be supplied");else o.onError("json.js is required to delete database documents")},bulkDocuments:function(i,n){var o=e.extend(!0,{onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},n);JSON&&JSON.stringify||o.onError("json.js is required to create database documents");var s=JSON.stringify({docs:i});e.ajax({url:this.dbUrl+"_bulk_docs",type:"POST",async:!0,data:s,contentType:"application/json",dataType:"json",success:function(e){o.onSuccess(e)},error:function(e,t,i){var n=r(e,t);o.onError("Error on bulk document operation: "+n)}})},getDocument:function(i){var o=e.extend(!0,{docId:null,rev:null,revs_info:!1,revisions:!1,conflicts:!1,deleted_conflicts:!1,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i);o.docId||o.onError("No docId set. Can not retrieve document");var s={};o.rev&&(s.rev=o.rev),o.revs_info&&(s.revs_info="true"),o.revisions&&(s.revs="true"),o.conflicts&&(s.conflicts="true"),o.deleted_conflicts&&(s.deleted_conflicts="true"),n&&(s.r=Date.now());var a=this.dbUrl+o.docId;e.ajax({url:a,type:"get",async:!0,data:s,dataType:"json",success:function(e){o.onSuccess(e)},error:function(e,t,i){var n=r(e,t);o.onError("Error obtaining document content for "+o.docId+": "+n)}})},getDocuments:function(i){var n=e.extend(!0,{docIds:null,onSuccess:function(e){},onError:function(e){t.log(e)}},i);if(JSON&&JSON.stringify)if(n.docIds){var o=this.dbUrl+"_all_docs?include_docs=true",s={keys:n.docIds};e.ajax({url:o,type:"POST",async:!0,data:JSON.stringify(s),contentType:"application/json",dataType:"json",success:function(e){if(e.rows){for(var t=[],i=0,r=e.rows.length;i<r;++i){var o=e.rows[i];o&&o.doc&&t.push(o.doc)}n.onSuccess(t)}else n.onError("Unexpected response during query of multiple documents")},error:function(e,t,i){var o=r(e,t);n.onError("Error during query of multiple documents: "+o)}})}else n.onError("No docIds set. Can not retrieve documents");else n.onError("json.js is required to query multiple documents")},listAllDocuments:function(i){var o=e.extend(!0,{onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i),s=this.dbUrl+"_all_docs?include_docs=false";n&&(s+="&r="+Date.now()),e.ajax({url:s,type:"GET",async:!0,dataType:"json",success:function(e){if(e.rows){for(var t=[],i=0,n=e.rows.length;i<n;++i){var r=e.rows[i];r&&r.id&&t.push(r.id)}o.onSuccess(t)}else o.onError("Unexpected response during listing of all documents")},error:function(e,t,i){var n=r(e,t);o.onError("Error during listing of all documents: "+n)}})},getAllDocuments:function(i){var o=e.extend(!0,{startkey:null,endkey:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i);JSON&&JSON.stringify||o.onError("json.js is required to query a view");var s={include_docs:!0};for(var a in o)null===o[a]||"startkey"!==a&&"endkey"!==a||(s[a]=JSON.stringify(o[a]));var l=this.dbUrl+"_all_docs";n&&(s.r=Date.now()),e.ajax({url:l,type:"GET",async:!0,data:s,dataType:"json",success:function(e){if(e.rows){for(var t=[],i=0,n=e.rows.length;i<n;++i){var r=e.rows[i];r&&r.doc&&t.push(r.doc)}o.onSuccess(t)}else o.onError("Unexpected response during retrieval of all documents")},error:function(e,t,i){var n=r(e,t);o.onError("Error during retrieval of all documents: "+n)}})},getInfo:function(i){var o=e.extend(!0,{onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i),s={};n&&(s.r=Date.now()),e.ajax({url:this.dbUrl,type:"GET",async:!0,dataType:"json",data:s,success:function(e){e.error?o.onError(e.error):o.onSuccess(e)},error:function(e,t,i){var n=r(e,t);o.onError("Error during databse infro: "+n)}})},queryTemporaryView:function(i){var n=t.extend({map:null,reduce:null,onSuccess:function(e){},onError:t.reportErrorForced},i);n.map||n.onError('"map" must be provided in temporary view');var o={map:n.map};n.reduce&&(o.reduce=n.reduce);var s=this.dbUrl+"_temp_view";e.ajax({url:s,type:"post",async:!0,dataType:"json",data:JSON.stringify(o),contentType:"application/json",success:function(e){e.rows?n.onSuccess(e.rows):n.onError("Unexpected response during query of temporary view")},error:function(e,t,i){var o=r(e,t);n.onError("Error during query temporary view: "+o)}})}}),u=t.Class("couch.UserDb",d,{initialize:function(e,t){t||(dbName="_users"),d.prototype.initialize.call(this,{dbName:t},e)},createUser:function(i){var n=e.extend({name:null,password:null,onSuccess:function(e){},onError:t.reportErrorForced},i),s=this.getUrl();JSON&&"function"==typeof JSON.stringify?this.server.getUniqueId({onSuccess:function(i){var a="org.couchdb.user:"+o(n.name),l=i,c=t.crypto.hex_sha1(n.password+l),d={};for(var u in n)"name"!==u&&"password"!==u&&"onSuccess"!==u&&"onError"!==u&&(d[u]=n[u]);d.type="user",d.name=o(n.name),d.password_sha=c,d.salt=l,t.isArray(d.roles)||(d.roles=[]);e.ajax({url:s+a,type:"put",async:!0,data:JSON.stringify(d),contentType:"application/json",dataType:"json",success:n.onSuccess,error:function(e,t,i){var o=r(e,t);n.onError("Error during user creation: "+o)}})}}):n.onError("json.js is required to create database documents")},updateUser:function(i){var n=e.extend(!0,{user:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i),o=this.getUrl();JSON&&"function"==typeof JSON.stringify?n.user&&n.user._id?e.ajax({url:o+n.user._id,type:"PUT",async:!0,data:JSON.stringify(n.user),contentType:"application/json",dataType:"json",success:function(e){n.onSuccess(e)},error:function(e,t,i){var o=r(e,t);n.onError("Error updating user: "+o)}}):n.onError("On update, a valid document with _id attribute must be supplied"):n.onError("json.js is required to update user documents")},setUserPassword:function(i){var n=e.extend(!0,{user:null,password:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i),o=this.getUrl();JSON&&"function"==typeof JSON.stringify?n.user&&n.user._id&&n.user._rev?n.password?this.computeUserPassword({userDoc:n.user,password:n.password,onSuccess:function(t){e.ajax({url:o+n.user._id,type:"PUT",async:!0,data:JSON.stringify(t),contentType:"application/json",dataType:"json",success:function(e){n.onSuccess(e)},error:function(e,t,i){var o=r(e,t);n.onError("Error changing user password: "+o)}})},onError:n.onError}):n.onError("On password change, a valid password must be supplied"):n.onError("On password change, a valid user document with _id and _rev attributes must be supplied"):n.onError("json.js is required to set user password")},computeUserPassword:function(i){var n=e.extend({userDoc:null,password:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i);JSON&&"function"==typeof JSON.stringify?n.userDoc?n.password?this.server.getUniqueId({onSuccess:function(e){var i=e,r=t.crypto.hex_sha1(n.password+i);n.userDoc.password&&delete n.userDoc.password;n.userDoc.password_scheme&&delete n.userDoc.password_scheme;n.userDoc.iterations&&delete n.userDoc.iterations;n.userDoc.derived_key&&delete n.userDoc.derived_key;n.userDoc.salt&&delete n.userDoc.salt;n.userDoc.password_sha&&delete n.userDoc.password_sha;n.userDoc.password_sha=r,n.userDoc.salt=i,n.onSuccess(n.userDoc)}}):n.onError("On setting change, a valid password must be supplied"):n.onError("On setting password, a user document must be provided"):n.onError("json.js is required to set user password")},deleteUser:function(i){var n=e.extend({user:null,id:null,rev:null,name:null,onSuccess:function(e){},onError:t.reportErrorForced},i),s=this.getUrl(),a=null,l=null;n.user&&(a=n.user._id,l=n.user._rev),!a&&n.id&&(a=n.id),!a&&n.name&&(a="org.couchdb.user:"+o(n.name)),!l&&n.rev&&(l=n.rev),e.ajax({url:s+a+"?rev="+l,type:"DELETE",async:!0,dataType:"json",success:n.onSuccess,error:function(e,t,i){var o=r(e,t);n.onError("Error during user deletion: "+o)}})},getUser:function(s){var a=e.extend(!0,{name:null,id:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},s),l=this.getUrl(),c=a.id;c||(c="org.couchdb.user:"+o(a.name));var d={};n&&(d.r=Date.now()),e.ajax({url:l+c,type:"get",async:!0,dataType:"json",data:d,success:function(e){a.onSuccess(e)},error:function(e,t,n){var o=r(e,t);a.onError(i("Error obtaining user document for {id}: {err}",{id:c,err:o}))}})},getUsers:function(i){var n=e.extend(!0,{names:null,ids:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i),s=this,a=this.getUrl()+"_all_docs?include_docs=true",l=null;if(l=n.ids&&n.ids.length?n.ids.slice(0):[],n.names&&n.names.length)for(var c=0,d=n.names.length;c<d;++c)l.push("org.couchdb.user:"+o(n.names[c]));if(JSON&&JSON.stringify){var u={keys:l},h=[],p={};e.ajax({url:a,type:"POST",async:!0,data:JSON.stringify(u),contentType:"application/json",dataType:"json",success:function(e){if(e.rows){for(var t=!1,i=0,r=e.rows.length;i<r;++i){var o=e.rows[i];o&&o.doc&&(o.doc._id?h.push(o.doc):(t=!0,p[o.id]=!0,f(o.id)))}t||n.onSuccess(h)}else n.onError("Unexpected response during query of multiple users")},error:function(e,t,i){var o=r(e,t);n.onError("Error during query of multiple users: "+o)}})}else n.onError("json.js is required to query multiple users");function f(e){s.getUser({id:e,onSuccess:function(t){t._id&&h.push(t),delete p[e],m()},onError:function(t){delete p[e],m()}})}function m(){for(var e in p)return e;n.onSuccess(h)}},getAllUsers:function(i){var o=e.extend({onSuccess:function(e){},onError:t.reportErrorForced},i),s=this;if(JSON&&JSON.stringify){var a=this.getUrl()+"_all_docs",l={startkey:JSON.stringify("org.couchdb.user:"),endkey:JSON.stringify("org.couchdb.user="),include_docs:!0};n&&(l.r=Date.now());var c=[],d={};e.ajax({url:a,type:"get",async:!0,data:l,dataType:"json",success:function(e){if(e.rows){for(var t=!1,i=0,n=e.rows.length;i<n;++i){var r=e.rows[i];r&&r.doc&&(r.doc._id?c.push(r.doc):(t=!0,d[r.id]=!0,u(r.id)))}t||o.onSuccess(c)}else o.onError("Unexpected response during query of all users")},error:function(e,t,i){var n=r(e,t);o.onError("Error during query of all users: "+n)}})}else o.onError("json.js is required to query a view");function u(e){s.getUser({id:e,onSuccess:function(t){t._id&&c.push(t),delete d[e],h()},onError:function(t){delete d[e],h()}})}function h(){for(var e in d)return e;o.onSuccess(c)}}}),h=t.Class("couch.Server",{options:null,isInitialized:!1,uuids:null,userDbName:null,userDb:null,session:null,initListeners:null,initialize:function(i,o){this.options=t.extend({pathToServer:"../",pathToSession:null,pathToUserDb:null,pathToUuids:null,pathToReplicate:null,pathToActiveTasks:null,pathToAllDbs:null,version:null,skipSessionInitialization:!1,userDbName:null,onSuccess:function(e){},onError:function(e){}},i),this.isInitialized=!1,this.uuids=[],this.userDbName=this.options.userDbName,this.userDb=null,this.session=null,this.initListeners=o,this.initListeners||(this.initListeners=[]);var s=this;function a(e){s.options.skipSessionInitialization?l():s.getSession().refreshContext({onSuccess:l,onError:c})}function l(){s.isInitialized=!0;for(var e=0,t=s.initListeners;e<t;++e){var i=s.initListeners[e];try{i()}catch(t){}}s.initListeners=[],s.options.onSuccess(s),delete s.options.onSuccess,delete s.options.onError}function c(e){s.options.onError(e),delete s.options.onSuccess,delete s.options.onError}!function(){if(s.options.version)a();else{var t={};n&&(t.r=Date.now()),e.ajax({url:s.options.pathToServer,type:"get",async:!0,dataType:"json",data:t,success:function(t){t.version?(s.options.version=t.version,function(){if(null!=s.userDbName)a(null);else{var t=s.getSessionUrl(),i={};n&&(i.r=Date.now()),e.ajax({url:t,type:"get",async:!0,dataType:"json",data:i,success:function(e){e.ok?(e&&e.info&&e.info.authentication_db&&(s.userDbName=e.info.authentication_db),a(e)):c("Malformed session information message.")},error:function(e,t,i){var n=r(e,t);c("Error obtaining session information: "+n)}})}}()):c("Malformed database welcome message.")},error:function(e,t,i){var n=r(e,t);c("Error obtaining database welcome: "+n)}})}}()},getPathToServer:function(){return this.options.pathToServer},getVersion:function(){return this.options.version},getReplicateUrl:function(){return null==this.options.pathToReplicate?this.options.pathToServer+"_replicate":this.options.pathToReplicate},getActiveTasksUrl:function(){return null==this.options.pathToActiveTasks?this.options.pathToServer+"_active_tasks":this.options.pathToActiveTasks},getSessionUrl:function(){var e=this.options.pathToSession;return e||(e=this.options.pathToServer+"_session"),e},getUniqueId:function(i){var o=e.extend({onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i),s=this;if(this.uuids.length>0){var a=this.uuids.pop();o.onSuccess(a)}else{var l=this.options.pathToUuids;l||(l=this.options.pathToServer+"_uuids");var c={count:10};n&&(c.r=Date.now()),e.ajax({url:l,type:"get",async:!0,data:c,dataType:"json",success:function(e){if(e.uuids){for(var t=0,i=e.uuids.length;t<i;++t){var n=e.uuids[t];s.uuids.push(n)}n=s.uuids.pop();o.onSuccess(n)}else o.onError("Malformed uuids from database.")},error:function(e,t,i){var n=r(e,t);o.onError("Error obtaining new uuids from database: "+n)}})}},listDatabases:function(i){var o=e.extend({onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i),s=this.options.pathToAllDbs;s||(s=this.options.pathToServer+"_all_dbs");var a={};n&&(a.r=Date.now()),e.ajax({url:s,type:"get",async:!0,dataType:"json",data:a,success:o.onSuccess,error:function(e,t,i){var n=r(e,t);o.onError("Error obtaining list of databases: "+n)}})},getUserDb:function(){return this.userDb||(this.userDb=new u(this,this.userDbName)),this.userDb},getSession:function(e){return this.session||(this.session=new s(this,e)),this.session},getDb:function(e){return new d(e,this)},createDb:function(i){var n=t.extend({dbName:null,onSuccess:function(e){},onError:t.reportErrorForced},i);if(n.dbName){var o=this.getPathToServer()+n.dbName,s=this;e.ajax({url:o,type:"put",async:!0,dataType:"json",success:function(e){if(e.ok){var t=s.getDb({dbUrl:o});n.onSuccess(t)}else n.onError("Error occurred when creating database: "+e.error)},error:function(e,t,i){var o=r(e,t);n.onError("Error creating database: "+o)}})}else n.onError('"dbName" must be provided when creating a database')},deleteDb:function(i){var n=t.extend({dbName:null,onSuccess:function(){},onError:t.reportErrorForced},i);if(n.dbName){var o=this.getPathToServer()+n.dbName;e.ajax({url:o,type:"DELETE",async:!0,dataType:"json",success:function(e){e.ok?n.onSuccess():n.onError("Error occurred when deleting database: "+e.error)},error:function(e,t,i){var o=r(e,t);n.onError("Error deleting database: "+o)}})}else n.onError('"dbName" must be provided when deleting a database')},replicate:function(i){var n=t.extend({source:null,target:null,filter:null,docIds:null,continuous:!1,onSuccess:function(e){},onError:t.reportErrorForced},i);if(n.source)if(n.target){var o={source:n.source,target:n.target};n.filter&&(o.filter=n.filter),n.continuous&&(o.continuous=!0),n.docIds&&(o.doc_ids=n.docIds);var s=this.getReplicateUrl();e.ajax({url:s,type:"POST",async:!0,data:JSON.stringify(o),contentType:"application/json",dataType:"json",success:function(e){e.error?n.onError("Error while initiating replication: "+e.error):n.onSuccess(e)},error:function(e,t,i){var o=r(e,t);n.onError("Error initiating replication: "+o)}})}else n.onError('"target" must be provided for replication');else n.onError('"source" must be provided for replication')},addInitializedListener:function(e){if("function"==typeof e)if(this.isInitialized)try{e()}catch(e){}else this.initListeners.push(e)}});t.couch=e.extend({},{isBadProxy:function(){return n},setBadProxy:function(e){n=!!e},getServer:function(e){return new h(e)},DefaultServer:null,defaultInitializeListeners:[],getPathToServer:function(){return t.couch.DefaultServer.getPathToServer()},addInitializedListener:function(e){t.couch.DefaultServer?t.couch.DefaultServer.addInitializedListener(e):"function"==typeof e&&t.couch.defaultInitializeListeners.push(e)},initialize:function(e){t.couch.DefaultServer=new h(e,t.couch.defaultInitializeListeners)},getVersion:function(){return t.couch.DefaultServer.getVersion()},getSession:function(){return t.couch.DefaultServer.getSession()},getUserDb:function(){return t.couch.DefaultServer.getUserDb()},getReplicateUrl:function(){return t.couch.DefaultServer.getReplicateUrl()},getActiveTasksUrl:function(){return t.couch.DefaultServer.getActiveTasksUrl()},getDb:function(e){return t.couch.DefaultServer.getDb(e)},getUniqueId:function(e){t.couch.DefaultServer.getUniqueId()},addAttachmentToDocument:function(e){var i=t.extend({doc:null,data:null,attachmentName:null,contentType:"application/binary"},e);return i.doc&&i.data&&i.attachmentName?void 0===t.Base64?"Base64 not included":(i.doc._attachments||(i.doc._attachments={}),i.doc._attachments[i.attachmentName]={},i.doc._attachments[i.attachmentName].content_type=i.contentType,i.doc._attachments[i.attachmentName].data=t.Base64.encode(i.data),null):"Invalid parameters"},compareSessionContexts:function(e,t){if(e===t)return!0;if(!e)return!1;if(!t)return!1;if(e.name!==t.name)return!1;var i={};if(e.roles)for(var n=0,r=e.roles.length;n<r;++n)i[s=e.roles[n]]=!0;var o={};if(t.roles)for(n=0,r=t.roles.length;n<r;++n)o[s=t.roles[n]]=!0;for(var s in i)if(!o[s])return!1;for(var s in o)if(!i[s])return!1;return!0}}),e.fn.couchUploadFile=function(e){return t.couch.getDb(e).buildUploadFileForm(this,e),this}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couch.indexedDb",r=t.Class("couchIndexedDb.DesignDoc",{couchDesignDoc:null,db:null,initialize:function(e){var i=t.extend({couchDesignDoc:null,db:null},e);this.couchDesignDoc=i.couchDesignDoc,this.db=i.db},getDatabase:function(){return this.db},getQueryUrl:function(e){return this.couchDesignDoc.getQueryUrl(e)},queryView:function(e){var i=t.extend({},e),n=this,r=!1;i.include_docs&&(r=!0,i.include_docs=!1);var o=i.onSuccess;i.onSuccess=function(e){if(i.reduce)o(e);else if(r){var s=[],a={};e.forEach(function(e){var t=e.id,i=a[t];i||(i=[],a[t]=i,s.push(t)),i.push(e)}),n.db.getDocuments({docIds:s,onSuccess:function(t){t.forEach(function(e){var t=e._id,i=a[t];i&&i.forEach(function(t){t.doc=e})}),o(e)},onError:function(e){var n=t.error.fromString("Error obtaining documents returned by query",e);i.onError(n)}})}else o(e)},this.couchDesignDoc.queryView(i)}}),o=t.Class("couchIndexedDb.Database",{wrappedDb:null,documentCache:null,dbName:null,dbChangeNotifier:null,dispatchService:null,remoteDocumentCountLimit:null,remoteRevisionCountLimit:null,id:null,outstandingRevisionCount:null,isInitialized:null,initializeListeners:null,isCachingEnabled:null,fetchDocumentRequests:null,fetchDocumentRequestsByDocId:null,initialize:function(e){var i=t.extend({couchDb:null,documentCache:null,dispatchService:null,remoteDocumentCountLimit:null,remoteRevisionCountLimit:null},e),n=this;function r(){var e=n.dbChangeNotifier.getLastSequence();n.documentCache.initializeCache({dbName:n.dbName,updateSequence:e,onSuccess:function(){t.log("Document cache: re-initialized"),o()},onError:function(e){t.logError("Error while re-initializing document cache. "+e),s()}})}function o(){n.dbChangeNotifier.addListener(function(e){n._dbChanges(e)}),n.isCachingEnabled=!0,n.isInitialized=!0,n.initializeListeners.forEach(function(e){e()}),n.initializeListeners=[]}function s(){t.logError("Document cache: disabled"),n.isCachingEnabled=!1,n.isInitialized=!0}this.wrappedDb=i.couchDb,this.documentCache=i.documentCache,this.dispatchService=i.dispatchService,this.remoteDocumentCountLimit=i.remoteDocumentCountLimit,this.remoteRevisionCountLimit=i.remoteRevisionCountLimit,this.id=t.getUniqueId(),this.outstandingRevisionCount=0,this.isInitialized=!1,this.isCachingEnabled=!1,this.initializeListeners=[],this.fetchDocumentRequests=null,this.fetchDocumentRequestsByDocId=null,this.getChangeNotifier({onSuccess:function(e){n.dbChangeNotifier=e,n.getInfo({onSuccess:function(e){e&&"string"==typeof e.db_name?(n.dbName=e.db_name,n.documentCache.getUpdateSequence({dbName:n.dbName,onSuccess:function(e){!function(e){var i=n.dbChangeNotifier.getLastSequence();e?i===e?(t.log("Document cache: up-to-date"),o()):n.getChanges({since:e,limit:1e3,onSuccess:function(e){e&&t.isArray(e.results)&&e.results.length<1e3?(n._dbChanges(e),t.log("Document cache: updating"),o()):r()},onError:function(e){r()}}):n.documentCache.initializeCache({dbName:n.dbName,updateSequence:i,onSuccess:function(){t.log("Document cache: initialized "),o()},onError:function(e){t.logError("Error while recording initializing document cache. "+e),s()}})}(e)},onError:function(e){t.logError("Error while getting document cache sequence number: "+e),r()}})):(t.logError("Error with database information",e),s())},onError:function(e){t.logError("Error while fetching database information: "+e),s()}})},onError:function(e){t.logError("Error while getting database change notifier: "+e),s()}})},getUrl:function(){return this.wrappedDb.getUrl()},getServer:function(){return this.wrappedDb.getServer()},getDesignDoc:function(e){var t=this.wrappedDb.getDesignDoc(e);return new r({couchDesignDoc:t,db:this})},getChangeNotifier:function(e){return this.wrappedDb.getChangeNotifier(e)},getChanges:function(e){this.wrappedDb.getChanges(e)},getDocumentUrl:function(e){return this.wrappedDb.getDocumentUrl(e)},getAttachmentUrl:function(e,t){return this.wrappedDb.getAttachmentUrl(e,t)},getDocumentRevision:function(e){this.wrappedDb.getDocumentRevision(e)},getDocumentRevisions:function(e){var i=this;if("number"==typeof this.remoteRevisionCountLimit){var n=e.docIds.slice(),r={},o=n.length;this._updateOutstandingRevisionCount(o);var s=t.extend({onSuccess:function(e){},onError:function(e){}},e);!function e(){if(n.length<=0)i._updateOutstandingRevisionCount(0-o),s.onSuccess(r);else{var t=n.splice(0,i.remoteRevisionCountLimit);i.wrappedDb.getDocumentRevisions({docIds:t,onSuccess:function(n){for(var s in i._updateOutstandingRevisionCount(0-t.length),o-=t.length,n){var a=n[s];r[s]=a}e()},onError:function(e){i._updateOutstandingRevisionCount(0-o),s.onError(e)}})}}()}else this.wrappedDb.getDocumentRevisions(e)},buildUploadFileForm:function(e,t){this.wrappedDb.buildUploadFileForm(e,t)},createDocument:function(e){var i=this;if(this.isInitialized){var n=t.extend({},e,{onSuccess:function(n){if(i.isCachingEnabled){var r=t.extend({},e.data);r._id=n.id,r._rev=n.rev;var o=[];o.push({dbName:i.dbName,id:r._id,rev:r._rev,doc:r}),i.documentCache.performChanges(o)}e.onSuccess(n)}});this.wrappedDb.createDocument(n)}else this.initializeListeners.push(function(){i.createDocument(e)})},updateDocument:function(e){var i=this;if(this.isInitialized){var n=t.extend({},e,{onSuccess:function(n){if(i.isCachingEnabled){var r=t.extend({},e.data);r._id=n.id,r._rev=n.rev;var o=[];o.push({dbName:i.dbName,id:r._id,rev:r._rev,doc:r}),i.documentCache.performChanges(o)}e.onSuccess(n)}});this.wrappedDb.updateDocument(n)}else this.initializeListeners.push(function(){i.updateDocument(e)})},deleteDocument:function(e){var i=this;if(this.isInitialized){var n=t.extend({},e,{onSuccess:function(t){if(i.isCachingEnabled){var n=[];n.push({dbName:i.dbName,id:e.data._id,rev:t.rev,deleted:!0}),i.documentCache.performChanges(n)}e.onSuccess(t)}});this.wrappedDb.deleteDocument(n)}else this.initializeListeners.push(function(){i.deleteDocument(e)})},bulkDocuments:function(e,t){this.wrappedDb.bulkDocuments(e,t)},getDocument:function(e){var i=this;if(this.isInitialized){var n=!1,r=!1;e.rev&&(n=!0,r=!0),e.revs_info&&(n=!0,r=!0),e.revisions&&(n=!0,r=!0),e.conflicts&&(n=!0,r=!0),e.deleted_conflicts&&(n=!0,r=!0),e.skipCache&&(n=!0),n?s():this._validateDocumentCache({onSuccess:function(){i.documentCache.getDocument({dbName:i.dbName,docId:e.docId,onSuccess:o,onError:s})},onError:s})}else this.initializeListeners.push(function(){i.getDocument(e)});function o(t){t?e.onSuccess(t):s()}function s(){var n=t.extend({},e,{onSuccess:a});i.wrappedDb.getDocument(n)}function a(t){if(i.isCachingEnabled&&!r){var n=[];n.push({dbName:i.dbName,id:t._id,rev:t._rev,doc:t}),i.documentCache.performChanges(n)}e.onSuccess(t)}},getDocuments:function(i){var n=this;if(this.isInitialized){var r=e.extend(!0,{docIds:null,skipCache:void 0,onSuccess:function(e){},onError:function(e){t.log(e)}},i);if(!t.isArray(r.docIds))throw new Error("Database.getDocuments() docIds must be an array");r.docIds.forEach(function(e){if("string"!=typeof e)throw new Error("Database.getDocuments() docIds[*] must be a string")}),r.skipCache?o():this._validateDocumentCache({onSuccess:function(){n._performDocumentFetchRequest({docIds:r.docIds,onSuccess:r.onSuccess,onError:r.onError})},onError:o})}else this.initializeListeners.push(function(){n.getDocuments(i)});function o(){var e=t.extend({},r,{onSuccess:function(e){if(n.isCachingEnabled){var t=[];e.forEach(function(e){t.push({dbName:n.dbName,id:e._id,rev:e._rev,doc:e})}),n.documentCache.performChanges(t)}r.onSuccess(e)}});n.wrappedDb.getDocuments(e)}},listAllDocuments:function(e){this.wrappedDb.listAllDocuments(e)},getAllDocuments:function(e){this.wrappedDb.getAllDocuments(e)},getInfo:function(e){this.wrappedDb.getInfo(e)},queryTemporaryView:function(e){this.wrappedDb.queryTemporaryView(e)},_dbChanges:function(e){var i=this,n=void 0;"string"==typeof e.last_seq?n=e.last_seq:"number"==typeof e.last_seq?n=""+e.last_seq:t.logError("Unable to handle last_seq: "+e.last_seq);var r=e.results.slice();r.reverse();var o={},s=[];r.forEach(function(e){var n,r,a=e.id;if(!o[a])if(t.isArray(e.changes)&&e.changes.forEach(function(e){var t=1*e.rev.split("-")[0];void 0===n?(n=t,r=e.rev):t>n&&(n=t,r=e.rev)}),e.deleted&&"string"==typeof r){var l={dbName:i.dbName,id:a,rev:r,deleted:!0};s.push(l),o[a]=l}else if("string"==typeof r){l={dbName:i.dbName,id:a,rev:r};s.push(l),o[a]=l}}),s.push({dbName:i.dbName,updateSequence:n}),this.documentCache.performChanges(s)},_validateDocumentCache:function(e){var i=t.extend({onSuccess:function(){},onError:function(e){}},e),n=this;function r(e){n._dbChanges(e),i.onSuccess()}this.isCachingEnabled||i.onError("Caching is not enabled"),this.documentCache.getUpdateSequence({dbName:n.dbName,onSuccess:function(e){n.wrappedDb.getChanges({since:e,onSuccess:r,onError:function(e){t.log("Error while validating cache (get changes). "+e),i.onError(e)}})},onError:function(e){t.log("Error while validating cache (retrieve cache sequence number). "+e),i.onError(e)}})},_updateOutstandingDocumentCount:function(e){this.dispatchService&&this.dispatchService.send(n,{type:"waitReport",requester:this.id,name:"fetchDocuments",label:i("Retrieving documents"),count:e})},_updateOutstandingRevisionCount:function(e){this.outstandingRevisionCount+=e,this.dispatchService&&this.dispatchService.send(n,{type:"waitReport",requester:this.id,name:"fetchRevisions",label:i("Verifying revisions"),count:this.outstandingRevisionCount})},_performDocumentFetchRequest:function(e){var i=this;if("object"!=typeof e)throw new Error("Database._performDocumentFetchRequest() request must be an object");if(!t.isArray(e.docIds))throw new Error("Database._performDocumentFetchRequest() request.docId must be an array");if(e.docIds.forEach(function(e){if("string"!=typeof e)throw new Error("Database._performDocumentFetchRequest() request.docId[*] must be a string")}),"function"!=typeof e.onSuccess)throw new Error("Database._performDocumentFetchRequest() request.onSuccess must be a function");if("function"!=typeof e.onError)throw new Error("Database._performDocumentFetchRequest() request.onError must be a function");if(e.docsById={},e.outsdandingDocumentCount=e.docIds.length,e.docIds.length<=0)e.onSuccess([]);else{var n=!1;this.fetchDocumentRequests||(n=!0,this.fetchDocumentRequests=[],this.fetchDocumentRequestsByDocId={}),e.docIds.forEach(function(t){var n=i.fetchDocumentRequestsByDocId[t];n||(n={docId:t,requests:[]},i.fetchDocumentRequestsByDocId[t]=n,i.fetchDocumentRequests.push(n)),n.requests.push(e)}),this._updateOutstandingDocumentCount(this.fetchDocumentRequests.length);var r=[],o=[];n&&s()}function s(){i.fetchDocumentRequests.length<=0?(i.fetchDocumentRequests=null,i.fetchDocumentRequestsByDocId=null,i._updateOutstandingDocumentCount(0)):(i._updateOutstandingDocumentCount(i.fetchDocumentRequests.length),r=[],function e(){if(i.fetchDocumentRequests.length<=0)a();else if("number"==typeof i.remoteDocumentCountLimit&&r.length>=i.remoteDocumentCountLimit)a();else{var t=i.fetchDocumentRequests.shift();if(i.isCachingEnabled)i.documentCache.getDocument({dbName:i.dbName,docId:t.docId,onSuccess:function(i){i?(c(i),e()):(r.push(t.docId),e())},onError:function(i){r.push(t.docId),e()}});else{for(r.push(t.docId);i.fetchDocumentRequests.length>0;)t=i.fetchDocumentRequests.shift(),r.push(t.docId);a()}}}())}function a(){if(r.length>0){var e={};r.forEach(function(t){e[t]=null}),i.wrappedDb.getDocuments({docIds:r,onSuccess:function(t){for(var n in t.forEach(function(t){e[t._id]=t}),e){var r=e[n];r?c(r):d(n)}if(i.isCachingEnabled){var o=[];t.forEach(function(e){o.push({dbName:i.dbName,id:e._id,rev:e._rev,doc:e})}),i.documentCache.performChanges(o)}l(),s()},onError:function(t){for(var i in e)u(i,t);l(),s()}}),l()}else l(),s()}function l(){var e=o;o=[],e.forEach(function(e){if(e.error)e.onError(e.error);else{var t=[];for(var i in e.docsById){var n=e.docsById[i];t.push(n)}e.onSuccess(t)}})}function c(e){var t=i.fetchDocumentRequestsByDocId[e._id];t&&(t.requests.forEach(function(t){t.docsById[e._id]||(t.docsById[e._id]=e,--t.outsdandingDocumentCount,t.outsdandingDocumentCount<=0&&o.push(t))}),delete i.fetchDocumentRequestsByDocId[e._id])}function d(e){var t=i.fetchDocumentRequestsByDocId[e];t&&(t.requests.forEach(function(e){--e.outsdandingDocumentCount,e.outsdandingDocumentCount<=0&&o.push(e)}),delete i.fetchDocumentRequestsByDocId[e])}function u(e,t){var n=i.fetchDocumentRequestsByDocId[e];n&&(n.requests.forEach(function(e){e.error||(e.error=t,o.push(e))}),delete i.fetchDocumentRequestsByDocId[e])}}}),s=t.Class("couchIndexedDb.Server",{wrappedServer:null,indexedDbService:null,dispatchService:null,initialize:function(e){var i=t.extend({couchServer:null,indexedDbService:null,dispatchService:null},e);this.wrappedServer=i.couchServer,this.indexedDbService=i.indexedDbService,this.dispatchService=i.dispatchService},getPathToServer:function(){return this.wrappedServer.getPathToServer()},getVersion:function(){return this.wrappedServer.getVersion()},getReplicateUrl:function(){return this.wrappedServer.getReplicateUrl()},getActiveTasksUrl:function(){return this.wrappedServer.getActiveTasksUrl()},getSessionUrl:function(){return this.wrappedServer.getSessionUrl()},getUniqueId:function(e){this.wrappedServer.getUniqueId(e)},listDatabases:function(e){this.wrappedServer.listDatabases(e)},getUserDb:function(){return this.wrappedServer.getUserDb()},getSession:function(e){return this.wrappedServer.getSession(e)},getDb:function(e){var t=this.wrappedServer.getDb(e);if(e.allowCaching){var i=this.indexedDbService.getDocumentCache();return new o({couchDb:t,documentCache:i,dispatchService:this.dispatchService,remoteDocumentCountLimit:e.remoteDocumentCountLimit,remoteRevisionCountLimit:e.remoteRevisionCountLimit})}return t},createDb:function(e){var i=t.extend({dbName:null,onSuccess:function(e){},onError:t.reportErrorForced},e);this.wrappedServer.createDb({dbName:i.dbName,onSuccess:function(e){var t=new o({couchDb:e});i.onSuccess(t)},onError:i.onError})},deleteDb:function(e){this.wrappedServer.deleteDb(e)},replicate:function(e){this.wrappedServer.replicate(e)},addInitializedListener:function(e){this.wrappedServer.addInitializedListener(e)}});t.couchIndexedDb={getServer:function(e){var i=t.extend({couchServer:null,indexedDbService:null,dispatchService:null,onSuccess:function(e){},onError:function(e){}},e),n=new s({couchServer:i.couchServer,dispatchService:i.dispatchService,indexedDbService:i.indexedDbService});i.onSuccess(n)}}}(jQuery,nunaliit2);
/*!
	Papa Parse
	v4.3.2
	https://github.com/mholt/PapaParse
*/var n2utils={isArray:function(e){return null!==e&&("object"==typeof e&&("number"==typeof e.length&&("function"==typeof e.push&&("function"==typeof e.pop&&("function"==typeof e.concat&&("function"==typeof e.join&&("function"==typeof e.slice&&("function"==typeof e.reverse&&("function"==typeof e.splice&&"function"==typeof e.sort)))))))))},isArrayOfStrings:function(e){if(!n2utils.isArray(e))return!1;for(var t=0,i=e.length;t<i;++t)if("string"!=typeof e[t])return!1;return!0},isValidBounds:function(e){if(0==n2utils.isArray(e))return!1;if(4!=e.length)return!1;var t=e[0],i=e[1],n=e[2],r=e[3];return"number"==typeof t&&("number"==typeof i&&("number"==typeof n&&"number"==typeof r))},isValidWkt:function(e){function t(e){if(e.index<e.str.length)return e.str[e.index]}function i(e){return" "===e||"\n"===e||"\r"===e}function n(e){for(;e.index<e.str.length;){if(!i(e.str[e.index]))break;++e.index}}function r(e){var i=!1,n=t(e);if("-"===n&&(++e.index,n=t(e)),"0"<=n&&"9">=n){for(i=!0;"0"<=n&&"9">=n;)++e.index,n=t(e);if("."===n)for(++e.index,n=t(e);"0"<=n&&"9">=n;)++e.index,n=t(e)}return i}function o(e){if(!r(e))return!1;if(!i(t(e)))return!1;if(n(e),!r(e))return!1;var o=e.index;return n(e),r(e)||(e.index=o),!0}function s(e){return"("===t(e)&&(++e.index,n(e),!!o(e)&&(n(e),")"===t(e)&&(++e.index,!0)))}function a(e){if("("!==t(e))return!1;if(++e.index,n(e),!o(e))return!1;n(e);for(var i=1;","===t(e);){if(++e.index,++i,n(e),!o(e))return!1;n(e)}return")"===t(e)&&(++e.index,!(i<2))}function l(e){if("("!==t(e))return!1;if(++e.index,n(e),!a(e))return!1;for(n(e);","===t(e);){if(++e.index,n(e),!a(e))return!1;n(e)}return")"===t(e)&&(++e.index,!0)}var c={str:e,index:0};return n(c),!!function e(i){if("point"===i.str.substr(i.index,"point".length).toLowerCase())return i.index+="point".length,n(i),!!s(i);if("linestring"===i.str.substr(i.index,"linestring".length).toLowerCase())return i.index+="linestring".length,n(i),!!a(i);if("polygon"===i.str.substr(i.index,"polygon".length).toLowerCase())return i.index+="polygon".length,n(i),!!l(i);if("multipoint"===i.str.substr(i.index,"multipoint".length).toLowerCase()){if(i.index+="multipoint".length,n(i),"("!==t(i))return!1;if(++i.index,n(i),!s(i))return!1;for(n(i);","===t(i);){if(++i.index,n(i),!s(i))return!1;n(i)}return")"===t(i)&&(++i.index,!0)}if("multilinestring"===i.str.substr(i.index,"multilinestring".length).toLowerCase()){if(i.index+="multilinestring".length,n(i),"("!==t(i))return!1;if(++i.index,n(i),!a(i))return!1;for(n(i);","===t(i);){if(++i.index,n(i),!a(i))return!1;n(i)}return")"===t(i)&&(++i.index,!0)}if("multipolygon"===i.str.substr(i.index,"multipolygon".length).toLowerCase()){if(i.index+="multipolygon".length,n(i),"("!==t(i))return!1;if(++i.index,n(i),!l(i))return!1;for(n(i);","===t(i);){if(++i.index,n(i),!l(i))return!1;n(i)}return")"===t(i)&&(++i.index,!0)}if("geometrycollection"===i.str.substr(i.index,"geometrycollection".length).toLowerCase()){if(i.index+="geometrycollection".length,n(i),"("!==t(i))return!1;if(++i.index,n(i),!e(i))return!1;for(n(i);","===t(i);){if(++i.index,n(i),!e(i))return!1;n(i)}return")"===t(i)&&(++i.index,!0)}return!1}(c)&&(n(c),c.str.length===c.index)},isValidGeom:function(e){return"object"==typeof e&&("string"==typeof e.nunaliit_type&&("geometry"===e.nunaliit_type&&(!!e.bbox&&(0!=n2utils.isValidBounds(e.bbox)&&("string"==typeof e.wkt&&!!n2utils.isValidWkt(e.wkt))))))},geomSize:function(e){return"object"!=typeof e?0:"string"==typeof e.wkt?e.wkt.length:0},extractLayers:function(e){var t=null;if(e.nunaliit_layers&&n2utils.isArray(e.nunaliit_layers)){for(var i={},n=0,r=e.nunaliit_layers.length;n<r;++n){var o=e.nunaliit_layers[n];"string"==typeof o&&(i[o]=!0)}for(var s in i)t||(t=[]),t.push(s)}return t},excludedSearchTerms:["a","the","of","an","and","or","by","in","to"],extractSearchTerms:function(e,t){var i=[];n2utils.extractStrings(e,i,null,n2utils.excludedSearchAttributes);for(var n={},r=0,o=i.length;r<o;++r)n2utils.extractWordsFromString(i[r],n,t);return n},excludedSearchAttributes:["_rev","nunaliit_geom","nunaliit_import.geometry"],reWordSplit:/[\x00-\x26\x28-\x2f\x3a-\x40\x5b-\x5e\x60\x7b-\x7f]+/,addWordToMap:function(e,t,i){e=e.toLowerCase();if((e=n2utils.removeApostrophe(e))&&""!==e)if(i[e])i[e].count++,t<i[e].index&&(i[e].index=t);else{var n=n2utils.foldWord(e);i[e]={index:t,count:1,folded:n}}},extractWordsFromString:function(e,t,i){for(var n=e.split(n2utils.reWordSplit),r=0,o=n.length;r<o;++r)if(n2utils.addWordToMap(n[r],r,t),i){var s=n[r].split("_");if(s.length>1)for(var a=0,l=s.length;a<l;++a)s[a].length>0&&n2utils.addWordToMap(s[a],r,t)}},extractStrings:function(e,t,i,n){for(var r=0,o=n.length;r<o;++r)if(n[r]===i)return;if(null===e);else if("string"==typeof e)t.push(e);else if(n2utils.isArray(e))for(r=0,o=e.length;r<o;++r){var s=i?i+"."+r:""+r;n2utils.extractStrings(e[r],t,s,n)}else if("object"==typeof e)for(var a in e){s=i?i+"."+a:""+a;n2utils.extractStrings(e[a],t,s,n)}},foldedChars:{96:39,192:97,193:97,194:97,195:97,196:97,199:99,200:101,201:101,202:101,203:101,204:105,205:105,206:105,207:105,209:110,210:111,211:111,212:111,213:111,214:111,216:111,217:117,218:117,219:117,220:117,221:121,224:97,225:97,226:97,227:97,228:97,231:99,232:101,233:101,234:101,235:101,236:105,237:105,238:105,239:105,241:110,242:111,243:111,244:111,245:111,246:111,248:111,249:117,250:117,251:117,252:117,253:121,255:121,256:97,257:97,258:97,259:97,260:97,261:97,262:99,263:99,264:99,265:99,266:99,267:99,268:99,269:99,270:100,271:100,272:100,273:100,274:101,275:101,276:101,277:101,278:101,279:101,280:101,281:101,282:101,283:101,284:103,285:103,286:103,287:103,288:103,289:103,290:103,291:103,292:104,293:104,294:104,295:104,296:105,297:105,298:105,299:105,300:105,301:105,302:105,303:105,304:105,305:105,308:106,309:106,310:107,311:107,312:107,313:108,314:108,315:108,316:108,317:108,318:108,319:108,320:108,321:108,322:108,323:110,324:110,325:110,326:110,327:110,328:110,329:110,330:110,331:110,332:111,333:111,334:111,335:111,336:111,337:111,340:114,341:114,342:114,343:114,344:114,345:114,346:115,347:115,348:115,349:115,350:115,351:115,352:115,353:115,354:116,355:116,356:116,357:116,358:116,359:116,360:117,361:117,362:117,363:117,364:117,365:117,366:117,367:117,368:117,369:117,370:117,371:117,372:119,373:119,374:121,375:121,376:121,377:122,378:122,379:122,380:122,381:122,382:122,8216:39,8217:39,8219:39,8242:39,8245:39},foldWord:function(e){for(var t=[],i=0,n=(e=e.toLowerCase()).length;i<n;++i){var r=e.charCodeAt(i);if(r==r){var o=n2utils.foldedChars[r];o?t.push(String.fromCharCode(o)):t.push(String.fromCharCode(r))}}return t.join("")},removeApostrophe:function(e){return e.length>1&&n2utils.isApostropheCodeChar(e.charCodeAt(0))&&(e=e.substr(1,e.length-1)),e.length>1&&n2utils.isApostropheCodeChar(e.charCodeAt(e.length-1))&&(e=e.substr(0,e.length-1)),e.length>2&&"s"===e[e.length-1]&&n2utils.isApostropheCodeChar(e.charCodeAt(e.length-2))&&(e=e.substr(0,e.length-2)),e},isApostropheCodeChar:function(e){return 39===e||96===e||8216===e||8217===e||8219===e||8242===e||8245===e},extractTypes:function(e,t,i){if(!((i=i||[]).indexOf(e)>=0)){if(i.push(e),null===e);else if(n2utils.isArray(e))for(var n=0,r=e.length;n<r;++n)n2utils.extractTypes(e[n],t,i);else if("object"==typeof e)for(var o in e.nunaliit_type&&(t[e.nunaliit_type]=1),e){var s=e[o];n2utils.extractTypes(s,t,i)}i.pop()}},extractSpecificType:function(e,t,i,n){if(!((n=n||[]).indexOf(e)>=0)){if(n.push(e),null===e);else if(n2utils.isArray(e))for(var r=0,o=e.length;r<o;++r)n2utils.extractSpecificType(e[r],t,i,n);else if("object"==typeof e)if(e.nunaliit_type&&e.nunaliit_type===t)i.push(e);else for(var s in e)if("__n2Source"!==s){var a=e[s];n2utils.extractSpecificType(a,t,i,n)}n.pop()}},extractLinks:function(e,t){n2utils.extractSpecificType(e,"reference",t)},extractGeometries:function(e,t){n2utils.extractSpecificType(e,"geometry",t)},getAtlasRole:function(e,t){return e&&"string"==typeof e.name?e.name+"_"+t:t},validateDocumentStructure:function(e,t){n2utils.validateTypes(e,t),e.nunaliit_schema&&"string"!=typeof e.nunaliit_schema&&t("If nunaliit_schema is specified, it must be a string");var i=[];n2utils.extractGeometries(e,i);for(var n=0,r=i.length;n<r;++n){var o=i[n];n2utils.isValidGeom(o)||t("Invalid geometry")}e.nunaliit_created&&("object"!=typeof e.nunaliit_created&&t('Field "nunaliit_created" must be an object'),"actionstamp"!==e.nunaliit_created.nunaliit_type&&t('"nunaliit_created" must be of type "actionstamp"'),"number"!=typeof e.nunaliit_created.time&&t('"nunaliit_created.time" must be a number'),"created"!==e.nunaliit_created.action&&t('"nunaliit_created.action" must be a "created"')),e.nunaliit_last_updated&&("object"!=typeof e.nunaliit_last_updated&&t('Field "nunaliit_last_updated" must be an object'),"actionstamp"!==e.nunaliit_last_updated.nunaliit_type&&t('"nunaliit_last_updated" must be of type "actionstamp"'),"number"!=typeof e.nunaliit_last_updated.time&&t('"nunaliit_last_updated.time" must be a number'),"updated"!==e.nunaliit_last_updated.action&&t('"nunaliit_last_updated.action" must be a "updated"'));var s=[];n2utils.extractSpecificType(e,"actionstamp",s);for(n=0,r=s.length;n<r;++n){var a=s[n];"string"!=typeof a.name&&t('Action stamps must have a string field named: "name"'),"number"!=typeof a.time&&t('Action stamps must have a number field named: "time"')}if(e.nunaliit_layers&&(n2utils.isArrayOfStrings(e.nunaliit_layers)||t("nunaliit_layers must be an array of strings")),"translationRequest"===e.nunaliit_type&&("string"!=typeof e.str&&t('Translation requests must have a string "str"'),"string"!=typeof e.lang&&t('Translation requests must have a string "lang"'),e.trans&&"string"!=typeof e.trans&&t('Translation requests providing "trans" field must be string')),e.nunaliit_css&&("object"!=typeof e.nunaliit_css&&t("CSS fragments must have an object structure"),"css"!==e.nunaliit_css.nunaliit_type&&t('CSS fragments must have a type of "css"'),"string"!=typeof e.nunaliit_css.name&&t('CSS fragments must have a string "name" property.'),void 0!==e.nunaliit_css.css&&"string"!=typeof e.nunaliit_css.css&&t('CSS fragments must have a string "css" property.')),e.nunaliit_submission&&("object"!=typeof e.nunaliit_submission&&t("Submission documents must have an object structure"),"string"!=typeof e.nunaliit_submission.state&&t("Submission documents must include a state"),"string"!=typeof e.nunaliit_submission.submitter_name&&t("Submission documents must include the name of the submitter"),0==n2utils.isArrayOfStrings(e.nunaliit_submission.submitter_roles)&&t("Submission documents must include the roles of the submitter"),e.nunaliit_submission.original_reserved&&("object"!=typeof e.nunaliit_submission.original_reserved&&t('Submission documents must have an object for field "original_reserved"'),"string"!=typeof e.nunaliit_submission.original_reserved.id&&t("Submission documents must include the original identifier")),"object"!=typeof e.nunaliit_submission.original_doc&&void 0!==e.nunaliit_submission.original_doc&&t('In a submission document, if specified, "original_doc" must be an object'),"object"!=typeof e.nunaliit_submission.submitted_reserved&&void 0!==e.nunaliit_submission.submitted_reserved&&t('In a submission document, if specified, "submitted_reserved" must be an object'),"object"!=typeof e.nunaliit_submission.submitted_doc&&void 0!==e.nunaliit_submission.submitted_doc&&t('In a submission document, if specified, "submitted_doc" must be an object'),"boolean"!=typeof e.nunaliit_submission.deletion&&void 0!==e.nunaliit_submission.deletion&&t('In a submission document, if specified, "deletion" must be a boolean'),e.nunaliit_submission.deletion||e.nunaliit_submission.submitted_reserved||t('In a submission document, if not a deletion, then "submitted_reserved" must be specified'),e.nunaliit_submission.submitted_reserved||e.nunaliit_submission.original_reserved||t('In a submission document, one of "submitted_reserved" or "original_reserved" must be specified')),e.nunaliit_attachments)for(var l in"object"!=typeof e.nunaliit_attachments&&t('"nunaliit_attachments" must be an object structure'),"attachment_descriptions"!==e.nunaliit_attachments.nunaliit_type&&t('"nunaliit_attachments" must be of type "attachment_descriptions"'),"object"!=typeof e.nunaliit_attachments.files&&t('"nunaliit_attachments" must have an object structure named "files"'),e.nunaliit_attachments.files){var c=e.nunaliit_attachments.files[l];"object"!=typeof c&&t('Attachment descriptors must be of type "object"'),c.attachmentName!==l&&t('Attachment descriptors must have a duplicate name in "attachmentName"'),"string"!=typeof c.status&&t('Attachment descriptors must have a "status" string')}},validateTypes:function(e,t){if(null===e);else if(n2utils.isArray(e)){for(var i=0,n=e.length;i<n;++i)if(n2utils.validateTypes(e[i],t))return!0}else if("object"==typeof e){if(e.nunaliit_type&&"string"!=typeof e.nunaliit_type)return t('Fields named "nunaliit_type" must be strings'),!0;for(var r in e){var o=e[r];if(n2utils.validateTypes(o,t))return!0}}return!1}};exports.isArray=n2utils.isArray,exports.isArrayOfStrings=n2utils.isArrayOfStrings,exports.isValidBounds=n2utils.isValidBounds,exports.isValidWkt=n2utils.isValidWkt,exports.isValidGeom=n2utils.isValidGeom,exports.extractLayers=n2utils.extractLayers,exports.extractLinks=n2utils.extractLinks,exports.extractSearchTerms=n2utils.extractSearchTerms,exports.addWordToMap=n2utils.addWordToMap,exports.extractStrings=n2utils.extractStrings,exports.foldWord=n2utils.foldWord,exports.removeApostrophe=n2utils.removeApostrophe,exports.isApostropheCodeChar=n2utils.isApostropheCodeChar,exports.extractTypes=n2utils.extractTypes,exports.extractSpecificType=n2utils.extractSpecificType,exports.extractGeometries=n2utils.extractGeometries,exports.getAtlasRole=n2utils.getAtlasRole,exports.validateDocumentStructure=n2utils.validateDocumentStructure,exports.validateTypes=n2utils.validateTypes,"function"==typeof nunaliit2&&(nunaliit2.couchUtils={},nunaliit2.couchUtils.isArray=n2utils.isArray,nunaliit2.couchUtils.isArrayOfStrings=n2utils.isArrayOfStrings,nunaliit2.couchUtils.isValidBounds=n2utils.isValidBounds,nunaliit2.couchUtils.isValidWkt=n2utils.isValidWkt,nunaliit2.couchUtils.isValidGeom=n2utils.isValidGeom,nunaliit2.couchUtils.extractLayers=n2utils.extractLayers,nunaliit2.couchUtils.extractLinks=n2utils.extractLinks,nunaliit2.couchUtils.extractSearchTerms=n2utils.extractSearchTerms,nunaliit2.couchUtils.addWordToMap=n2utils.addWordToMap,nunaliit2.couchUtils.extractStrings=n2utils.extractStrings,nunaliit2.couchUtils.foldWord=n2utils.foldWord,nunaliit2.couchUtils.removeApostrophe=n2utils.removeApostrophe,nunaliit2.couchUtils.isApostropheCodeChar=n2utils.isApostropheCodeChar,nunaliit2.couchUtils.extractTypes=n2utils.extractTypes,nunaliit2.couchUtils.extractSpecificType=n2utils.extractSpecificType,nunaliit2.couchUtils.extractGeometries=n2utils.extractGeometries,nunaliit2.couchUtils.getAtlasRole=n2utils.getAtlasRole,nunaliit2.couchUtils.validateDocumentStructure=n2utils.validateDocumentStructure,nunaliit2.couchUtils.validateTypes=n2utils.validateTypes);var n2tiles={format4326_65K:null,format4326_200:null,format4326_25M:null,makeFormat:function(e,t,i,n,r,o){var s=(i-e)*r,a=(n-t)*o;return{minx:e,miny:t,maxx:i,maxy:n,resx:r,resy:o,tiles:s*a,nx:s,ny:a,incx:(i-e)/s,incy:(n-t)/a}},getBoundsFromTile:function(e,t){var i=t%e.nx,n=(t-i)/e.nx,r=i*e.incx+e.minx,o=n*e.incy+e.miny;return{minx:r,miny:o,maxx:r+e.incx,maxy:o+e.incy}},getTileFromPosition:function(e,t,i){return i*e.nx+t},getTilePositionFromCoords:function(e,t,i){var n=Math.floor((t-e.minx)/e.incx),r=Math.floor((i-e.miny)/e.incy);return n<0&&(n=0),n>=e.nx&&(n=e.nx-1),r<0&&(r=0),r>=e.ny&&(r=e.ny-1),{x:n,y:r,tile:n2tiles.getTileFromPosition(e,n,r)}},getTileFromCoords:function(e,t,i){var n=Math.floor((t-e.minx)/e.incx),r=Math.floor((i-e.miny)/e.incy);return n<0&&(n=0),n>=e.nx&&(n=e.nx-1),r<0&&(r=0),r>=e.ny&&(r=e.ny-1),n2tiles.getTileFromPosition(e,n,r)},getTilesFromBounds:function(e,t,i,n,r,o){var s=n2tiles.getTilePositionFromCoords(e,t,i),a=n2tiles.getTilePositionFromCoords(e,n,r),l=s.x,c=a.x,d=a.tile;t>n&&l===c&&--c<0&&(c=e.nx-1);for(var u=[],h=0,p=s.x,f=s.y,m=n2tiles.getTileFromPosition(e,p,f);!h;){if(u.push(m),m==d)h=1;else if(p==c)for(p=l,f+=1;f>=e.ny;)f-=e.ny;else for(p+=1;p>=e.nx;)p-=e.nx;if(m=n2tiles.getTileFromPosition(e,p,f),u.length>e.tiles)return[];if(o&&u.length>o)return[]}return u},getApproxTilesForBounds:function(e,t,i,n,r){var o=n>t?(n-t)/e.incx:(e.maxx-n+(t-e.minx))/e.incx,s=r>i?(r-i)/e.incy:(e.maxy-r+(i-e.miny))/e.incy;return(Math.floor(o)+1)*(Math.floor(s)+1)}};n2tiles.format4326_200={minx:-180,miny:-90,maxx:180,maxy:90,resx:.05,resy:.05,tiles:162,nx:18,ny:9,incx:20,incy:20},n2tiles.format4326_65K={minx:-180,miny:-90,maxx:180,maxy:90,resx:1,resy:1,tiles:64800,nx:360,ny:180,incx:1,incy:1},n2tiles.format4326_25M={minx:-180,miny:-90,maxx:180,maxy:90,resx:20,resy:20,tiles:2592e4,nx:7200,ny:3600,incx:.05,incy:.05},exports.makeFormat=n2tiles.makeFormat,exports.getBoundsFromTile=n2tiles.getBoundsFromTile,exports.getTileFromCoords=n2tiles.getTileFromCoords,exports.getTilesFromBounds=n2tiles.getTilesFromBounds,exports.getApproxTilesForBounds=n2tiles.getApproxTilesForBounds,exports.format4326_65K=n2tiles.format4326_65K,exports.format4326_200=n2tiles.format4326_200,exports.format4326_25M=n2tiles.format4326_25M,"function"==typeof nunaliit2&&(nunaliit2.tiles={},nunaliit2.tiles.makeFormat=n2tiles.makeFormat,nunaliit2.tiles.getBoundsFromTile=n2tiles.getBoundsFromTile,nunaliit2.tiles.getTilePositionFromCoords=n2tiles.getTilePositionFromCoords,nunaliit2.tiles.getTileFromCoords=n2tiles.getTileFromCoords,nunaliit2.tiles.getTilesFromBounds=n2tiles.getTilesFromBounds,nunaliit2.tiles.getApproxTilesForBounds=n2tiles.getApproxTilesForBounds,nunaliit2.tiles.format4326_65K=n2tiles.format4326_65K,nunaliit2.tiles.format4326_200=n2tiles.format4326_200,nunaliit2.tiles.format4326_25M=n2tiles.format4326_25M),function(e,t){var i=t.Class(t.schema.SchemaRepository,{couchOptions:null,initialize:function(e){t.schema.SchemaRepository.prototype.initialize.apply(this),this.couchOptions=t.extend({db:null,designDoc:null,viewNameSchemas:"schemas",viewNameRootSchemas:"schemas-root",dispatchService:null,preload:!1,preloadedCallback:function(){},onError:function(e){}},e);var i=this;this.loadSchemasFn=function(e){i._loadSchemas(e)};var n=this._getDispatcher();if(n){var r=n.getHandle("n2.couchSchema"),o=function(e){i._handle(e)};n.register(r,"documentContentCreated",o),n.register(r,"documentContentUpdated",o)}this.couchOptions.preload&&this._preload()},_loadSchemas:function(e){var i=t.extend({names:null,rootSchemas:!1,onSuccess:function(e){},onError:function(e){t.reportError(e)}},e),n={viewName:this.couchOptions.viewNameSchemas,include_docs:!0,onSuccess:function(e){for(var t=[],n=0,r=e.length;n<r;++n)t.push(e[n].doc);i.onSuccess(t)},onError:i.onError};i.names&&(n.keys=i.names),i.rootSchemas&&(n.viewName=this.couchOptions.viewNameRootSchemas),this.couchOptions.designDoc.queryView(n)},_handle:function(e){if("documentContentCreated"===e.type||"documentContentUpdated"===e.type){var i=e.doc;"schema"===i.nunaliit_type&&this.addSchemas({schemas:[i],onError:function(e){t.log("Error adding created/updated schema ("+i._id+") to repository: "+e)}})}},_getDispatcher:function(){return this.couchOptions.dispatchService},_preload:function(){var e=this;this.couchOptions.designDoc.queryView({viewName:this.couchOptions.viewNameSchemas,include_docs:!0,onSuccess:function(t){for(var i=[],n=0,r=t.length;n<r;++n)i.push(t[n].doc);e.addSchemas({schemas:i}),e.rootSchemasQueried=!0,e.couchOptions.preloadedCallback()},onError:function(i){var n,r;e.couchOptions.onError((n="Unable to preload schemas: {err}",r={err:i},t.loc(n,"nunaliit2-couch",r)))}})}});t.couchSchema={CouchSchemaRepository:i}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch-import",i)},n=t.Class({divId:null,initialize:function(i){var n=t.extend({div:null},i);if(n.div){var r=e(n.div),o=r.attr("id");o||(o=t.getUniqueId(),r.attr("id",o)),this.divId=o}},log:function(i){var n=this._getLog(),r=t.getUniqueId();return e('<div class="data_import_status"></div>').attr("id",r).text(i).appendTo(n),r},error:function(i){var n=this._getLog(),r=t.getUniqueId();return e('<div class="data_import_status data_import_error"></div>').attr("id",r).text("Error: "+i).appendTo(n),r},empty:function(){this._getLog().empty()},_getLog:function(){return e("#"+this.divId)}});t.OneToManyDataImporter=t.Class("$n2.OneToManyDataImporter",{options:{db:null,designDoc:null,atlasDesign:null,dataArray:[],statusDiv:null,logger:null,eraseStatusDiv:!0,containsGeometry:[!1],descriptiveLabels:[""],viewNames:[""],keyValueFns:[function(e){return null}],jsonPropertiesVerifyFn:function(e){return!0},convertJsonForUpload:function(e){return[e]},incrementalUpdateFns:[function(e,t){}]},statusId:1,initialize:function(e){this.options=t.extend({},this.options,e),this.options.logger?this.logger=this.options.logger:this.options.statusDiv&&(this.logger=new n({div:this.options.statusDiv})),this.options.eraseStatusDiv&&this.logger&&this.logger.empty()},loadEntry:function(e){if(e>=this.options.dataArray.length)this.postStatusMsgImmediate(i("Done"));else{var n=this.options.dataArray[e],r=this.options.designDoc,o=this.options.viewNames.slice(0),s=this.options.keyValueFns.slice(0),a=this.options.descriptiveLabels.slice(0),l=this.allocateStatusMsgSpace();!function n(c,d,u){if(o.length<=0||s.length<=0||a.length<=0)return void u(c);var h=s.shift();var p=o.shift();var f=a.shift();if(!t.isDefined(h)||!t.isDefined(p))return void n(c,d,u);var m=h(d);if(null===m)return void c.loadEntry(e+1);r.queryView({viewName:p,startkey:m,endkey:m,onSuccess:function(t){if(t.length>0){var r=i("{label} definition ({key}) already exists - not loaded or updated",{label:i(f),key:m});c.updateStatusMsgAsynch(r,l),c.loadEntry(e+1)}else n(c,d,u)},onError:function(t){var n=i("Error: query error while verifying {label} definition ({key})",{label:i(f),key:m});c.updateStatusMsgAsynch(n,l),c.loadEntry(e+1)}})}(this,n,function(t){t.createEntry(e,n)})}},createEntry:function(n,r){var o=[],s=this.options.db,a=this.options.atlasDesign;if(this.options.jsonPropertiesVerifyFn(r)){o=this.options.convertJsonForUpload(r),t.isArray(o)||(o=[o]);var l=this.options.descriptiveLabels.slice(0),c=this.options.incrementalUpdateFns.slice(0),d=this.options.containsGeometry.slice(0);h(this)}else this.postStatusMsgImmediate(i("Required fields missing for ")+this.options.descriptiveLabels[0]+i(" definition: ")+n),u(this);function u(e){o.length>0?h(e):e.loadEntry(n+1)}function h(r){if(!(o.length<=0)){var h=r.allocateStatusMsgSpace(),p=o.shift(),f=l.shift(),m=d.shift(),v=null;if(o.length>=1&&(v=c.shift()),!t.isDefined(p))return r.postStatusMsgImmediate(f+i(" definition null and skipped.")),void u(r);t.couchDocument.adjustDocument(p),s.createDocument({data:p,onSuccess:function(n){if(r.updateStatusMsgAsynch(f+i(" definition (")+n.id+")",h),t.isDefined(v)){var s=t.extend({},p,{_id:n.id,_rev:n.rev});v(n.id,o,s)}!function(t,n,r,o){!function s(a){a&&(tilingViews=["geom-layer-tile200","geom-layer-tile25m","geom-layer-tile65k","geom-tile200","geom-tile25m","geom-tile65k"]);if(!r||tilingViews.length<1)o(n);else{var l=tilingViews.pop();t.queryView({viewName:l,limit:1,onSuccess:function(){s(!1)},onError:function(t){e("#status").append(e("<div>"+i("STOPPING: Failed verifying view ")+l+" ("+t+")"))}})}}(!0)}(a,r,m,u)},onError:function(e){t.log("Error creating document: "+e,p),r.updateStatusMsgAsynch(i("Error creating ")+f+i(" definition (index: ")+n+i("). STOPPING: ")+e,h)}})}}},setDataArray:function(e){this.options.dataArray=e},postStatusMsgImmediate:function(e){return this.logger?this.logger.log(e):null},allocateStatusMsgSpace:function(){return this.logger?this.logger.log(""):null},updateStatusMsgAsynch:function(t,i){i&&e("#"+i).text(t)}}),t.DataImporter=t.Class("$n2.DataImporter",{options:{db:null,designDoc:null,atlasDesign:null,dataArray:[],containsGeometry:!1,statusDiv:null,logger:null,descriptiveLabel:"",viewName:"",keyValueFn:function(e){return null},jsonPropertiesVerifyFn:function(e){return!0},convertJsonForUpload:function(e){return e}},importer:null,initialize:function(e){this.options=t.extend({},this.options,e),this.importer=new t.OneToManyDataImporter({db:this.options.db,designDoc:this.options.designDoc,atlasDesign:this.options.atlasDesign,dataArray:this.options.dataArray,containsGeometry:[this.options.containsGeometry],statusDiv:this.options.statusDiv,logger:this.options.logger,descriptiveLabels:[this.options.descriptiveLabel],viewNames:[this.options.viewName],keyValueFns:[this.options.keyValueFn],jsonPropertiesVerifyFn:this.options.jsonPropertiesVerifyFn,convertJsonForUpload:this.options.convertJsonForUpload,incrementalUpdateFns:[]})},loadEntry:function(e){this.importer.loadEntry(e)},setDataArray:function(e){this.options.dataArray=e,this.importer.setDataArray(e)}}),t.JSONInputPlugInForDataImport=t.Class("$n2.JSONInputPlugInForDataImport",{options:{jsonFile:"",importer:null,entriesFromData:function(e){return e}},initialize:function(e){this.options=t.extend({},this.options,e)},loadJson:function(){var i=this;e.getJSON(this.options.jsonFile,function(e,n){var r=null;e&&(r=i.options.entriesFromData(e)),r&&t.isArray(r)&&(i.options.importer.setDataArray(r),i.options.importer.loadEntry(0))})}}),t.GeoJSONInputPlugInForDataImport=t.Class("$n2.GeoJSONInputPlugInForDataImport",{options:{jsonFile:"",importer:null,crs:"EPSG:4326"},geojsonParser:null,initialize:function(e){this.options=t.extend({},this.options,e),this.geojsonParser=new OpenLayers.Format.GeoJSON},loadGeoJson:function(){var i=this;e.getJSON(this.options.jsonFile,function(e,n){if(t.isDefined(e)&&t.isDefined(e.crs)&&t.isDefined(e.crs.type)&&"name"===e.crs.type&&t.isDefined(e.crs.properties)&&t.isDefined(e.crs.properties.name)&&(i.options.crs=e.crs.properties.name),t.isDefined(e)&&t.isDefined(e.type)&&"featurecollection"===e.type.toLowerCase()&&t.isDefined(e.features)&&t.isArray(e.features)){for(var r=[],o=0,s=e.features.length;o<s;o++){var a=i.geojsonParser.read(e.features[o],"Feature",null);r.push(a)}i.options.importer.setDataArray(r),i.options.importer.loadEntry(0)}})},convertGeomToWkt:function(e){var t=e.geometry.toString(),i=e.geometry.getBounds(),n=i.left,r=i.right;return{nunaliit_geom:{nunaliit_type:"geometry",wkt:t,bbox:[n,i.bottom,r,i.top]}}}})}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n=t.Class("ConfigurationService",{serverUrl:null,dispatchService:null,configuration:null,serverVersion:null,serverBuild:null,initialize:function(e){var i=t.extend({url:null,dispatchService:null,configuration:null},e),n=this;if(this.serverUrl=i.url,this.dispatchService=i.dispatchService,this.configuration=i.configuration,this.dispatchService){this.dispatchService.register("n2.couchConfiguration","configurationGetCurrentSettings",function(e,t,i){n._handle(e,t,i)})}},getNunaliitServerRoles:function(n){var r=t.extend({onSuccess:function(e){},onError:function(e){}},n);e.ajax({url:this.serverUrl+"getServerRoles",type:"GET",dataType:"json",success:function(e,t,n){e&&e.roles?r.onSuccess(e.roles):r.onError(i("Invalid server response"))},error:function(e,i,n){var o=t.utils.parseHttpJsonError(e,i);r.onError(o)}})},getAtlasRoles:function(n){var r=t.extend({onSuccess:function(e){},onError:function(e){}},n);e.ajax({url:this.serverUrl+"getAtlasRoles",type:"GET",dataType:"json",success:function(e,t,n){e&&e.roles?r.onSuccess(e.roles):r.onError(i("Invalid server response"))},error:function(e,i,n){var o=t.utils.parseHttpJsonError(e,i);r.onError(o)}})},_handle:function(e,t,i){"configurationGetCurrentSettings"===e.type&&(e.configuration=this.configuration)},testConnection:function(e){var i,n,r,o=t.extend({onSuccess:function(e){},onError:function(e){}},e),s=this,a={badProxy:!1,speed:0},l=Date.now();function c(e){r=Date.now(),n=e,i&&i===n&&(a.badProxy=!0),a.testDurationInMs=r-l,a.testDurationInMs>1500&&(a.speed=1),u()}function d(e){t.log("Problem testing for bad proxy",e),u()}function u(){s.connectionInfo=a,o.onSuccess(a)}this._getChannelRandom({onSuccess:function(e){i=e,s._getChannelRandom({onSuccess:c,onError:d})},onError:d})},_getChannelRandom:function(i){var n=t.extend({onSuccess:function(e){},onError:function(e){}},i),r=this;e.ajax({url:this.serverUrl+"testChannel",type:"GET",dataType:"json",success:function(e,t,i){if(e){var o=e.version,s=e.build;r._reportServerVersion(o,s)}e&&e.random?n.onSuccess(e.random):n.onError("Did not receive random from server")},error:function(e,i,r){var o=t.utils.parseHttpJsonError(e,i);n.onError(o)}})},_reportServerVersion:function(e,i){this.serverVersion||(this.serverVersion=e,this.serverBuild=i,this.configuration&&(this.configuration.serverVersion=e,this.configuration.serverBuild=i),n2atlas&&(this.serverVersion!==n2atlas.version&&t.logError("Version mismatch. Client: "+n2atlas.version+" Server: "+this.serverVersion),this.serverBuild!==n2atlas.build&&t.logError("Build mismatch. Client: "+n2atlas.build+" Server: "+this.serverBuild)))}});t.couchConfiguration={Configure:function(r){var o,s=t.extend({rootPath:null,couchServerUrl:null,atlasDbUrl:null,atlasDesignName:"atlas",siteDesignName:"site",progressServerUrl:null,mediaUrl:null,uploadServerUrl:null,exportServerUrl:null,configServerUrl:null,userServerUrl:null,submissionDbUrl:null,submissionServerUrl:null,dateServerUrl:null,simplifiedGeometryServerUrl:null,mailServerUrl:null,onSuccess:function(e){}},r),a={directory:{},rootPath:s.rootPath},l=!1,c=!1;function d(){a.start=function(){a.directory.dispatchService&&a.directory.dispatchService.send("n2.couchConfiguration",{type:"start"})},a.directory.customService=new t.custom.CustomService({directory:a.directory}),a.directory.customService.getOption("couchDbCachingEnabled",!1)&&(c=!0),a.directory.customService.getOption("couchDbCachingDisabled",!1)&&(c=!1),(o=new t.debug.DebugConfiguration).isBadProxyEnabled()&&t.couch.setBadProxy(!0),o.isCouchDbCachingEnabled()&&(c=!0),o.isCouchDbCachingDisabled()&&(c=!1);var i=!1;o.isEventLoggingEnabled()&&(i=!0),a.directory.dispatchService=new t.dispatch.Dispatcher({logging:i}),t.couchMap.Configure({dispatchService:a.directory.dispatchService}),a.directory.historyMonitor=new t.history.Monitor({directory:a.directory}),a.directory.historyTracker=new t.history.Tracker({dispatchService:a.directory.dispatchService}),a.directory.history=new t.history.History({dispatchService:a.directory.dispatchService}),a.directory.eventService=new t.couchEvents.EventSupport({directory:a.directory}),a.directory.analyticsService=new t.analytics.AnalyticsService({dispatchService:a.directory.dispatchService}),a.directory.userIntentService=new t.userIntentView.IntentService({dispatchService:a.directory.dispatchService}),e.cometd={init:function(){},subscribe:function(){},publish:function(){}},a.directory.configService=new n({url:s.configServerUrl,dispatchService:a.directory.dispatchService,configuration:a}),o.forceSlowConnectionHandling()&&(l=!0),a.directory.configService.testConnection({onSuccess:function(e){t.log("Connection speed:"+e.speed+" elapsed:"+e.testDurationInMs+"ms"),e.badProxy&&(t.couch.setBadProxy(!0),t.log("Detected bad proxy in communication channel")),e.speed>0&&(l=!0,t.log("Detected slow connection")),u()},onError:u})}function u(){l&&t.log("Slow connection handling requested"),t.couch.isBadProxy()&&t.log("Bad proxy circumvention requested"),t.indexedDb.openIndexedDb({dispatchService:a.directory.dispatchService,onSuccess:function(e){a.directory.indexedDbService=e,h()},onError:h})}function h(){function e(e){t.log("Unable to initialize with CouchDb server.",e)}c&&a.directory.indexedDbService?t.couch.initialize({pathToServer:s.couchServerUrl,onSuccess:function(e){t.couchIndexedDb.getServer({couchServer:e,dispatchService:a.directory.dispatchService,indexedDbService:a.directory.indexedDbService,onSuccess:p,onError:function(i){t.log("Error while initializing cached server.",i),p(e)}})},onError:e}):t.couch.initialize({pathToServer:s.couchServerUrl,onSuccess:p,onError:e})}function p(e){a.couchServer=e,a.directory.couchServer=e;var t=void 0,i=void 0,n=void 0;l&&(t=100,i=1e3,n=15e3),a.atlasDb=a.couchServer.getDb({dbUrl:s.atlasDbUrl,allowCaching:!0,remoteDocumentCountLimit:t,remoteRevisionCountLimit:i,changeNotifierRefreshIntervalInMs:n}),a.atlasDesign=a.atlasDb.getDesignDoc({ddName:s.atlasDesignName}),a.siteDesign=a.atlasDb.getDesignDoc({ddName:s.siteDesignName}),a.atlasDb.getInfo({onSuccess:function(e){a.atlasDbName=e.db_name,f()},onError:f})}function f(){a.directory.attachmentService=new t.couchAttachment.AttachmentService({mediaRelativePath:s.mediaUrl,dispatchService:a.directory.dispatchService}),s.submissionDbUrl&&(a.submissionDb=a.couchServer.getDb({dbUrl:s.submissionDbUrl})),a.dataSources=[];var e=null;e=a.submissionDb?new t.couchDocument.CouchDocumentSourceWithSubmissionDb({id:"main",db:a.atlasDb,submissionDb:a.submissionDb,submissionServerUrl:s.submissionServerUrl,dispatchService:a.directory.dispatchService,attachmentService:a.directory.attachmentService,isDefaultDocumentSource:!0}):new t.couchDocument.CouchDocumentSource({id:"main",db:a.atlasDb,dispatchService:a.directory.dispatchService,attachmentService:a.directory.attachmentService,isDefaultDocumentSource:!0}),a.dataSources.push(e),a.documentSource=e,t.couchHelp&&t.couchHelp.CheckBrowserCompliance&&t.couchHelp.CheckBrowserCompliance({db:a.atlasDb}),a.directory.schemaRepository=new t.couchSchema.CouchSchemaRepository({db:a.atlasDb,designDoc:a.atlasDesign,dispatchService:a.directory.dispatchService,preload:!0,preloadedCallback:m})}function m(){var e=void 0;l&&(e=10),a.directory.authService=new t.couchAuth.AuthService({onSuccess:v,atlasDb:a.atlasDb,schemaRepository:a.directory.schemaRepository,directory:a.directory,userServerUrl:s.userServerUrl,refreshIntervalInSec:e})}function v(){a.directory.localizationService=new t.couchL10n.LocalizationService({db:a.atlasDb,designDoc:a.atlasDesign,dispatchService:a.directory.dispatchService}),a.directory.progressService=new t.progress.ProgressServer({url:s.progressServerUrl}),a.directory.uploadService=new t.upload.Upload({url:s.uploadServerUrl,progressServer:a.directory.progressService}),a.directory.mailService=new t.mail.MailService({url:s.mailServerUrl,dispatchService:a.directory.dispatchService,customService:a.directory.customService}),a.directory.exportService=new t.couchExport.ExportService({url:s.exportServerUrl,atlasDb:a.atlasDb,atlasDesign:a.atlasDesign,config:a}),a.directory.dateService=new t.dateService.DateService({url:s.dateServerUrl}),a.directory.searchService=new t.couchSearch.SearchServer({designDoc:a.atlasDesign,db:a.atlasDb,dispatchService:a.directory.dispatchService,customService:a.directory.customService,dateService:a.directory.dateService}),a.mediaRelativePath=s.mediaUrl,a.directory.requestService=new t.couchRequests({documentSource:a.documentSource,userDb:t.couch.getUserDb(),dispatchService:a.directory.dispatchService,userServerUrl:s.userServerUrl}),a.directory.dispatchSupport=new t.couchDispatchSupport.DispatchSupport({dispatchService:a.directory.dispatchService}),a.directory.languageService=new t.languageSupport.LanguageService({directory:a.directory}),a.directory.displayImageSourceFactory=new t.couchDisplayBox.DisplayImageSourceFactory({dispatchService:a.directory.dispatchService}),a.directory.showService=new t.couchShow.Show({db:a.atlasDb,documentSource:a.documentSource,requestService:a.directory.requestService,dispatchService:a.directory.dispatchService,schemaRepository:a.directory.schemaRepository,customService:a.directory.customService,attachmentService:a.directory.attachmentService,displayImageSourceFactory:a.directory.displayImageSourceFactory}),a.directory.navigationService=new t.couchNavigation.NavigationService({dispatchService:a.directory.dispatchService,showService:a.directory.showService,documentSource:a.documentSource}),a.directory.dialogService=new t.couchDialogs.DialogService({dispatchService:a.directory.dispatchService,documentSource:a.documentSource,searchService:a.directory.searchService,showService:a.directory.showService,schemaRepository:a.directory.schemaRepository,atlasDesign:a.atlasDesign}),a.directory.createDocProcess=new t.couchRelatedDoc.CreateRelatedDocProcess({documentSource:a.documentSource,schemaRepository:a.directory.schemaRepository,uploadService:a.directory.uploadService,showService:a.directory.showService,authService:a.directory.authService,dialogService:a.directory.dialogService,dispatchService:a.directory.dispatchService}),a.directory.commentService=new t.comment.Service({documentSource:a.documentSource,showService:a.directory.showService,createDocProcess:a.directory.createDocProcess,dispatchService:a.directory.dispatchService,customService:a.directory.customService}),a.directory.schemaEditorService=new t.couchEdit.SchemaEditorService({documentSource:a.documentSource,showService:a.directory.showService,searchService:a.directory.searchService,dispatchService:a.directory.dispatchService,dialogService:a.directory.dialogService}),a.directory.editService=new t.couchEdit.EditService({documentSource:a.documentSource,schemaRepository:a.directory.schemaRepository,uploadService:a.directory.uploadService,showService:a.directory.showService,authService:a.directory.authService,dispatchService:a.directory.dispatchService,searchService:a.directory.searchService,schemaEditorService:a.directory.schemaEditorService,customService:a.directory.customService,dialogService:a.directory.dialogService,createDocProcess:a.directory.createDocProcess}),a.couchEditor=a.directory.editService,a.directory.userService=new t.couchUser.UserService({userDb:t.couch.getUserDb(),configService:a.directory.configService,schemaRepository:a.directory.schemaRepository,schemaEditorService:a.directory.schemaEditorService,userServerUrl:s.userServerUrl,customService:a.directory.customService}),a.directory.modelService=new t.model.Service({dispatchService:a.directory.dispatchService}),a.directory.utilityService=new t.utilities.Service({dispatchService:a.directory.dispatchService}),a.directory.instanceService=new t.instance.Service({dispatchService:a.directory.dispatchService}),a.directory.canvasService=new t.canvas.Service({dispatchService:a.directory.dispatchService}),a.directory.displayService=new t.display.Service({dispatchService:a.directory.dispatchService}),a.directory.widgetService=new t.widgetBasic.Service({config:a}),t.mapAndControls.DefaultPopupHtmlFunction=function(t){var n=t.feature;if(n.cluster&&1===n.cluster.length&&(n=n.cluster[0]),n.cluster){var r=n.cluster.length;n.attributes&&n.attributes.count&&(r=n.attributes.count),(c=e('<span class="n2_popup"></span>')).text(i("This cluster contains {count} features",{count:r})),(s=e("<div></div>")).append(c);var o=s.html();t.onSuccess(o)}else{var s,l=t.feature.data,c=e('<span class="n2_popup"></span>');a.directory.showService.displayBriefDescription(c,{},l),(s=e("<div></div>")).append(c),o=s.html(),t.onSuccess(o)}},a.directory.hoverSoundService=new t.couchSound.HoverSoundService({db:a.atlasDb,dispatchService:a.directory.dispatchService,requestService:a.directory.requestService,customService:a.directory.customService});var n={};window.nunaliit_custom&&window.nunaliit_custom.geoNames&&window.nunaliit_custom.geoNames.username&&(n.username=window.nunaliit_custom.geoNames.username),a.directory.geoNamesService=new t.GeoNames.Service(n),a.directory.importProfileService=new t.couchImportProfile.ImportProfileService({atlasDb:a.atlasDb,atlasDesign:a.atlasDesign,schemaRepository:a.directory.schemaRepository,dispatchService:a.directory.dispatchService}),a.directory.documentListService=new t.couchDocumentList.DocumentListService({atlasDesign:a.atlasDesign,dispatchService:a.directory.dispatchService}),a.directory.simplifiedGeometryService=new t.couchSimplifiedGeometries.Service({url:s.simplifiedGeometryServerUrl,atlasDb:a.atlasDb,dispatchService:a.directory.dispatchService,customService:a.directory.customService,indexedDbService:c?a.directory.indexedDbService:null,dbName:a.atlasDbName}),t.tuioClient&&(a.directory.tuioService=new t.tuioClient.TuioService({dispatchService:a.directory.dispatchService})),a.atlasDb&&(t.couchHelp.InstallHelpDocument({db:a.atlasDb,id:"help.dates",key:"dates"}),t.couchHelp.InstallHelpDocument({db:a.atlasDb,id:"help.wiki",key:"wiki"})),g()}function g(){t.scripts.areAllCustomScriptsLoaded()?window&&window.nunaliit_custom&&"function"==typeof window.nunaliit_custom.configuration?window.nunaliit_custom.configuration(a,y):y():window.setTimeout(g,100)}function y(){a.directory.showService&&a.directory.showService.fixElementAndChildren(e("body")),t.log("nunaliit configuration",a),s.onSuccess(a)}n2atlas&&n2atlas.googleMapApiKey?t.scripts.loadGoogleMapApi({googleMapApiKey:n2atlas.googleMapApiKey,onLoaded:d,onError:function(e){t.logError("Error while loading Google Map API: "+e),d()}}):d()},ConfigService:n}}(jQuery,nunaliit2),function(e){function t(e){var t=e.getBounds();return{nunaliit_type:"geometry",wkt:e.toString(),bbox:[t.left,t.bottom,t.right,t.top]}}function i(t,i,n,r){var o=[{tile:e.tiles.format4326_25M,name:"geom-tile25m",list:"noduplicate",layer:!1,fid:!1},{tile:e.tiles.format4326_25M,name:"geom-layer-tile25m",list:"noduplicate",layer:!0,fid:!1},{tile:e.tiles.format4326_65K,name:"geom-tile65k",list:"noduplicate",layer:!1,fid:!1},{tile:e.tiles.format4326_65K,name:"geom-layer-tile65k",list:"noduplicate",layer:!0,fid:!1},{tile:e.tiles.format4326_200,name:"geom-tile200",list:"noduplicate",layer:!1,fid:!1},{tile:e.tiles.format4326_200,name:"geom-layer-tile200",list:"noduplicate",layer:!0,fid:!1},{tile:null,name:"geom-layer-fid",layer:!0,fid:!0},{tile:null,name:"geom-layer",layer:!0,fid:!1},{tile:null,name:"geom",layer:!1,fid:!0}];i&&r&&(i=null);for(var s=0,a=o.length;s<a;++s){var l=o[s];if(i&&l.tile&&n&&l.layer){if(e.tiles.getApproxTilesForBounds(l.tile,i[0],i[1],i[2],i[3])<500){t.viewName=l.name;var c=e.tiles.getTilesFromBounds(l.tile,i[0],i[1],i[2],i[3]);t.keys=[];for(var d=0,u=c.length;d<u;++d)t.keys.push([n,c[d]]);return l.list&&(t.listName=l.list),!0}}else if(i&&l.tile&&!n&&!l.layer){if(e.tiles.getApproxTilesForBounds(l.tile,i[0],i[1],i[2],i[3])<500)return t.viewName=l.name,t.keys=e.tiles.getTilesFromBounds(l.tile,i[0],i[1],i[2],i[3]),l.list&&(t.listName=l.list),!0}else{if(r&&l.fid&&n&&l.layer){t.viewName=l.name,t.keys=[];for(d=0,u=r.length;d<u;++d)t.keys.push([n,r[d]]);return l.list&&(t.listName=l.list),!0}if(r&&l.fid&&!n&&!l.layer)return t.viewName=l.name,t.keys=r,l.list&&(t.listName=l.list),!0;if(!r&&!l.fid&&n&&l.layer)return t.viewName=l.name,t.keys=[n],l.list&&(t.listName=l.list),!0;if(!(i||r||n||l.fid||l.layer||l.tile))return t.viewName=l.name,l.list&&(t.listName=l.list),!0}}return!1}e.couchGeom={getCouchGeometry:t,updateDocumentWithWktGeometry:function(i){var n=e.extend({doc:null,wkt:null},i);if(!n.doc)throw'Attribute "doc" not provided while updating a geometry document';if(!n.wkt)throw'Attribute "wkt" not provided while updating a geometry document';if(OpenLayers&&OpenLayers.Geometry&&OpenLayers.Geometry.fromWKT){var r=OpenLayers.Geometry.fromWKT(n.wkt);if(r){var o=t(r);n.doc.nunaliit_geom=o}}else n.onError("OpenLayers must be installed to update document geometries")},updatedGeometry:function(e){if(OpenLayers&&OpenLayers.Geometry&&OpenLayers.Geometry.fromWKT){var t=OpenLayers.Geometry.fromWKT(e.wkt);if(t){var i=t.getBounds();e.bbox=[i.left,i.bottom,i.right,i.top]}}e.simplified&&delete e.simplified},getOpenLayersGeometry:function(t){var i=e.extend({doc:null,couchGeom:null,wkt:null},t),n=i.wkt;if(!n&&i.couchGeom&&(n=i.couchGeom.wkt),!n&&i.doc&&i.doc.nunaliit_geom&&(n=i.doc.nunaliit_geom.wkt),n){if(OpenLayers&&OpenLayers.Geometry&&OpenLayers.Geometry.fromWKT)return OpenLayers.Geometry.fromWKT(n);throw"OpenLayers must be installed to update document geometries"}},selectTileViewFromBounds:i,queryGeometries:function(e,t){var n=null,r={viewName:"geom",listName:"noduplicate"};for(var o in t)"bounds"===o?n=t[o]:r[o]=t[o];n&&i(r,n),e.queryView(r)}}}(nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchShow",r=!1;var o=/(^|\s)(https?:\/\/[^\s]*)(\s|$)/;function s(e,t,i){var n=e.className;if(n){var r=n.split(" "),o=[];r.forEach(function(e){e===t?o.push(i):o.push(e)});var s=o.join(" ");e.className=s}}var a=t.Class({db:null,documentSource:null,showService:null,displayFunction:null,editFunction:null,deleteFunction:null,viewLayerFunction:null,changes:null,changesWithContext:null,observerChangeMap:null,mutationObserver:null,initialize:function(e){var i=t.extend({db:null,documentSource:null,showService:null,displayFunction:null,editFunction:null,deleteFunction:null,viewLayerFunction:null},e);this.db=i.db,this.documentSource=i.documentSource,this.showService=i.showService,this.displayFunction=i.displayFunction,this.editFunction=i.editFunction,this.deleteFunction=i.deleteFunction,this.viewLayerFunction=i.viewLayerFunction;var n=this;this.changes=[{source:"n2s_localize",target:"n2s_localized",fn:this._localize,acceptsContextDocument:!1},{source:"n2_localize",target:"n2_localized",fn:this._localize,acceptsContextDocument:!1},{source:"n2s_briefDisplay",target:"n2s_briefDisplayed",fn:this._briefDisplay,acceptsContextDocument:!0},{source:"n2_briefDisplay",target:"n2_briefDisplayed",fn:this._briefDisplay,acceptsContextDocument:!0},{source:"n2s_fullDisplay",target:"n2s_fullDisplayed",fn:this._fullDisplay,acceptsContextDocument:!0},{source:"n2s_referenceLink",target:"n2s_insertedReferenceLink",fn:this._insertReferenceLink,acceptsContextDocument:!1},{source:"n2s_insertTime",target:"n2s_insertedTime",fn:this._insertTime,acceptsContextDocument:!1},{source:"n2s_insertUserName",target:"n2s_insertedUserName",fn:this._insertUserName,acceptsContextDocument:!1},{source:"n2s_insertLayerName",target:"n2s_insertedLayerName",fn:this._insertLayerName,acceptsContextDocument:!0},{source:"n2s_insertMediaView",target:"n2s_insertedMediaView",fn:this._insertMediaView,acceptsContextDocument:!0},{source:"n2s_insertMediaPlayer",target:"n2s_insertedMediaPlayer",fn:this._insertMediaPlayer,acceptsContextDocument:!0},{source:"n2s_insertModuleName",target:"n2s_insertedModuleName",fn:this._insertModuleName,acceptsContextDocument:!0},{source:"n2s_insertFirstThumbnail",target:"n2s_insertedFirstThumbnail",fn:this._insertFirstThumbnail,acceptsContextDocument:!0},{source:"n2s_insertHoverSoundIcon",target:"n2s_insertedHoverSoundIcon",fn:this._insertHoverSoundIcon,acceptsContextDocument:!0},{source:"n2s_externalMediaLink",target:"n2s_adjustedExternalMediaLink",fn:this._adjustExternalMediaLink,acceptsContextDocument:!0},{source:"n2s_insertExternalMediaLink",target:"n2s_insertedExternalMediaLink",fn:this._insertExternalMediaLink,acceptsContextDocument:!0},{source:"n2s_convertTextUrlToLink",target:"n2s_convertedTextUrlToLink",fn:this._convertTextUrlToLink,acceptsContextDocument:!1},{source:"n2s_clickFindGeometryOnMap",target:"n2s_findGeometryOnMap",fn:this._clickFindGeometryOnMap,acceptsContextDocument:!0},{source:"n2s_clickAddLayerFromDefinition",target:"n2s_addLayerFromDefinition",fn:this._clickAddLayerFromDefinition,acceptsContextDocument:!0},{source:"n2s_clickEdit",target:"n2s_edit",fn:this._clickEdit,acceptsContextDocument:!0},{source:"n2s_clickDelete",target:"n2s_delete",fn:this._clickDelete,acceptsContextDocument:!0},{source:"n2s_handleHover",target:"n2s_handledHover",fn:this._handleHover,acceptsContextDocument:!0},{source:"n2s_installMaxHeight",target:"n2s_installedMaxHeight",fn:this._installMaxHeight,acceptsContextDocument:!1},{source:"n2s_clickLogin",target:"n2s_login",fn:this._clickLogin,acceptsContextDocument:!1},{source:"n2s_clickMapEdit",target:"n2s_mapEdit",fn:this._clickMapEdit,acceptsContextDocument:!1},{source:"n2s_preserveSpaces",target:"n2s_preservedSpaces",fn:this._preserveSpaces,acceptsContextDocument:!1},{source:"n2s_insertDocumentList",target:"n2s_insertedDocumentList",fn:this._insertDocumentList,acceptsContextDocument:!1},{source:"n2s_select",target:"n2s_selected",fn:this._select,acceptsContextDocument:!1},{source:"n2s_installTiledImageClick",target:"n2s_installedTiledImageClick",fn:this._installTiledImageClick,acceptsContextDocument:!0},{source:"n2s_custom",target:"n2s_customed",fn:this._custom,acceptsContextDocument:!0},{source:"n2s_userEvents",target:"n2s_userEvents_installed",fn:this._userEvents,acceptsContextDocument:!0},{source:"n2s_wikiTransform",target:"n2s_wikiTransformed",fn:this._wikiTransform,acceptsContextDocument:!0},{source:"n2s_showFindAvailable",target:"n2s_showedFindAvailable",fn:this._showFindAvailable,acceptsContextDocument:!0}],this.changesWithContext=[],this.changes.forEach(function(e){e.acceptsContextDocument&&n.changesWithContext.push(e)}),this.changesMap={},this.changes.forEach(function(e){n.changesMap[e.source]=e}),this.mutationObserver=null},fixElementAndChildren:function(e,t,i){this._fixElementAndChildrenV3(e,t,i)},_fixElementAndChildrenV3:function(t,i,r){var o=this,a=this.showService.dispatchService;function l(t){var n=t.className;"string"==typeof n&&n.split(" ").forEach(function(n){var a=o.changesMap[n];if(a&&"string"==typeof a.target&&"function"==typeof a.fn)try{s(t,n,a.target),a.fn.call(o,e(t),r,i)}catch(e){console.log("Error applying change: "+n,e)}})}a&&a.synchronousCall(n,{type:"showPreprocessElement",elem:t,doc:r,showService:this.showService}),t.each(function(){l(this),function e(t,i){for(var n=[],r=t.childNodes,o=0;o<r.length;++o){var s=r.item(o);s&&1===s.nodeType&&n.push(s)}n.forEach(function(t){i(t),e(t,i)})}(this,l)})},_fixElementAndChildrenV2:function(t,i,r){var o=this,s=this.showService.dispatchService;s&&s.synchronousCall(n,{type:"showPreprocessElement",elem:t,doc:r,showService:this.showService});var a=t;function l(t,i,n,r){t.hasClass(i)&&c(t,i,n,r),t.find("."+i).each(function(){c(e(this),i,n,r)})}function c(e,t,n,s){e.removeClass(t).addClass(n),s.call(o,e,r,i)}this.mutationObserver?this.changesWithContext.forEach(function(e){var t=e.source,i=e.target,n=e.fn;l(a,t,i,n)}):this.changes.forEach(function(e){var t=e.source,i=e.target,n=e.fn;l(a,t,i,n)})},_fixElementAndChildrenV1:function(t,i,r){var o=this,s=this.showService.dispatchService;s&&s.synchronousCall(n,{type:"showPreprocessElement",elem:t,doc:r,showService:this.showService});var a=t.find("*").addBack();this.changes.forEach(function(t){var n=t.source,s=t.target,l=t.fn;a.filter("."+n).each(function(){var t=e(this);t.removeClass(n).addClass(s),l.call(o,t,r,i)})})},_observeMutations:function(t){var i=this;function n(t){var n=t.className;"string"==typeof n&&n.split(" ").forEach(function(n){var r=i.observerChangeMap[n];if(r&&"string"==typeof r.target&&"function"==typeof r.fn)try{s(t,n,r.target),r.fn.call(i,e(t))}catch(e){console.log("Error applying change: "+n,e)}})}t.forEach(function(e){if("attributes"===e.type)e.target&&1===e.target.nodeType&&n(e.target);else if("childList"===e.type){if(e.addedNodes&&e.addedNodes.length)for(var t=0;t<e.addedNodes.length;++t){var i=e.addedNodes.item(t);i&&1===i.nodeType&&n(i)}}else console.log("mutation: "+e.type,e)})},_receivedDocumentContent:function(i){var n=this,r=void 0;i&&(r=i._id);var o=void 0;if(r&&(o="n2show_documentContent_"+t.utils.stringToHtmlId(r)),o&&e("."+o).each(function(){var t=e(this);n._refreshElementWithDocument(t,i),t.attr("data-content-continuous")||t.removeClass(o)}),i&&i.nunaliit_layer_definition){var s=i.nunaliit_layer_definition.id;s||(s=i._id),s&&(o="n2show_layerContent_"+t.utils.stringToHtmlId(s),e("."+o).each(function(){var t=e(this);t.removeClass(o),n._associateDocumentToElement(i,t),n._refreshElementWithDocument(t,i)}))}},_receivedDocumentUpdate:function(i){var n=this,r=void 0;i&&(r=i._id);var o=void 0;r&&(o="n2show_documentUpdate_"+t.utils.stringToHtmlId(r)),o&&e("."+o).each(function(){var t=e(this);n._refreshElementWithDocument(t,i)}),e(".n2show_documentList").each(function(){var t=e(this);n._insertDocumentList(t)})},_refreshElementWithDocument:function(e,t){var i=this.showService.dispatchService;i&&i.synchronousCall(n,{type:"showPreprocessElement",elem:e,doc:t,showService:this.showService}),e.hasClass("n2s_insertedMediaView")&&this._insertMediaView(e,t),e.hasClass("n2s_insertedMediaPlayer")&&this._insertMediaPlayer(e,t),e.hasClass("n2s_insertedFirstThumbnail")&&this._insertFirstThumbnail(e,t),e.hasClass("n2s_customed")&&this._custom(e,t),e.hasClass("n2s_userEvents_installed")&&this._userEvents(e,t),e.hasClass("n2s_briefDisplayed")&&this._briefDisplay(e,t),e.hasClass("n2s_fullDisplayed")&&this._fullDisplay(e,t),e.hasClass("n2s_insertedLayerName")&&this._insertLayerName(e,t),e.hasClass("n2s_insertedModuleName")&&this._insertModuleName(e,t),e.hasClass("n2s_showedFindAvailable")&&this._showFindAvailable(e,t)},_localize:function(e){var i=e.text(),n=void 0;t.l10n&&t.l10n.lookupDictionaryTranslation&&(n=t.l10n.lookupDictionaryTranslation(i,"nunaliit2-couch")),"string"==typeof n?e.text(n):e.addClass("n2s_waiting_for_localization")},_preserveSpaces:function(t){t.each(function(){!function t(i){var n=i.firstChild;for(;n;)3===n.nodeType?(e(n.parentNode).css("white-space","pre-wrap"),n=n.nextSibling):(t(n),n=n.nextSibling)}(this)})},_insertDocumentList:function(e){var t=e.attr("nunaliit-list-type");void 0===t&&(t=e.attr("n2-list-type"))&&e.attr("nunaliit-list-type",t);var i=e.attr("nunaliit-list-name");void 0===i&&(i=e.attr("n2-list-name"))&&e.attr("nunaliit-list-name",i),e.addClass("n2show_documentList n2show_documentList_wait").empty();var r=this.showService.dispatchService;r&&r.send(n,{type:"documentListQuery",listType:t,listName:i})},_select:function(t){var i=t.attr("n2-choice"),n=!1;t.find(".n2s_choice").each(function(){var t=e(this);t.attr("n2-choice")===i?n=!0:t.remove()}),n&&t.find(".n2s_choiceDefault").remove()},_briefDisplay:function(e,t){(i=e.attr("nunaliit-document"))||(i=e.text(),e.attr("nunaliit-document",i));var i=this._associateDocumentToElement(t,e);t&&t._id===i&&this.showService._displayDocumentBrief(e,t)},_fullDisplay:function(e,t,i){var n=this._associateDocumentToElement(t,e);t&&t._id===n&&this.showService._displayDocumentFull(e,t,i)},_insertReferenceLink:function(e){var t=this,i=e.attr("nunaliit-document");i||(i=e.text(),e.attr("nunaliit-document",i)),this.showService.printBriefDescription(e,i),e.click(function(){var e=t.showService.dispatchService;return e&&e.send(n,{type:"userSelect",docId:i}),t.displayFunction&&t.displayFunction(i,opt_),!1})},_insertTime:function(e){var t=1*e.text(),i=new Date(t).toString();e.text(i)},_insertUserName:function(e){var t=e.attr("nunaliit-user");t||(t=e.text()),this.showService.printUserName(e,t,{showHandle:!0})},_insertLayerName:function(e,n){var r=e.attr("nunaliit-layer"),o=e.attr("nunaliit-document");r||o||(r=e.text(),e.attr("nunaliit-layer",r));var s=void 0;n&&n.nunaliit_layer_definition&&((s=n.nunaliit_layer_definition).id||(s.id=n._id));var a=void 0;if(r){if(s&&s.id===r)a=n;else if(!e.hasClass("n2show_layerAssociated")){e.addClass("n2show_layerAssociated");var l="n2show_layerContent_"+t.utils.stringToHtmlId(r);e.addClass(l),this.showService._requestLayerDefinition(r)}}else o?(n&&n._id===o&&(a=n),this._associateDocumentToElement(n,e)):s&&(a=n,this._associateDocumentToElement(n,e));if(a&&a.nunaliit_layer_definition){var c=a.nunaliit_layer_definition.id;if(c||(c=a._id),c===r&&a.nunaliit_layer_definition.name){var d=i(a.nunaliit_layer_definition.name);e.text(d)}}},_insertMediaView:function(n,o){var s=this,a=this._associateDocumentToElement(o,n),l=n.attr("nunaliit-attachment");if(l||(l=n.text(),n.attr("nunaliit-attachment",l)),n.empty(),o&&o._id===a){var c=null;o._attachments&&o._attachments[l]&&(c=o._attachments[l]);var d=null;if(o&&o.nunaliit_attachments&&o.nunaliit_attachments.files&&(d=o.nunaliit_attachments.files[l]),d&&"attached"===d.status&&c){var u=this.db.getAttachmentUrl(o,l),h=null;if(d.thumbnail&&o._attachments[d.thumbnail]){var p=this.db.getAttachmentUrl(o,d.thumbnail);h=e('<div class="n2Show_thumb_wrapper"><img src="'+p+'"/></div>')}else h="image"===d.fileClass?e('<div class="n2Show_icon_wrapper"><div class="n2Show_icon_image"></div></div>'):"audio"===d.fileClass?e('<div class="n2Show_icon_wrapper"><div class="n2Show_icon_audio"></div></div>'):"video"===d.fileClass?e('<div class="n2Show_icon_wrapper"><div class="n2Show_icon_video"></div></div>'):e('<div class="n2Show_icon_wrapper"><div class="n2Show_icon_file"></div></div>');if(null!=h){n.append(h);var f=function(i,n,o,a){return function(l){var c={url:n,suppressLeaveConfirmation:r},d=null;o._attachments&&o._attachments[a]&&(d=o._attachments[a]),d&&(c.mimeType=d.content_type);var u=o.nunaliit_attachments.files[a];if(u&&u.data&&u.data.title&&(c.title=u.data.title),u&&(u.width&&(c.width=u.width),u.height&&(c.height=u.height),"image"===i&&u.photosphere&&"panorama"===u.photosphere.type&&(i="photosphere")),"image"===i||"photosphere"===i)s.showService.displayImageSourceFactory.getImageSourceForDoc({doc:o,attName:a,showService:s.showService,onSuccess:function(e,t,i){new nunaliit2.displayBox.DisplayBox({imageSource:e,startIndex:i})},onError:function(e){t.log("Error while creating image source factory",e)}});else{var h=e("<div></div>");s.showService._displayDocumentBrief(h,o,{onDisplayed:function(){var e=h.html();c.metaDataHtml=e,c.type=i,t.mediaDisplay.displayMedia(c)}})}return!1}}(d.fileClass,u,o,l);h.click(f)}}}else{var m=i("Media({docId},{attName})",{docId:a,attName:l});e("<span>").addClass("n2s_insertMediaView_wait").text(m).appendTo(n)}},_insertMediaPlayer:function(n,r){var o=this._associateDocumentToElement(r,n),s=n.attr("nunaliit-attachment");if(s||(s=n.text(),n.attr("nunaliit-attachment",s)),n.empty(),r&&r._id===o){var a=null;r._attachments&&r._attachments[s]&&(a=r._attachments[s]);var l=null;r&&r.nunaliit_attachments&&r.nunaliit_attachments.files&&(l=r.nunaliit_attachments.files[s]);var c=null;if(l&&l.thumbnail&&(c=this.db.getAttachmentUrl(r,l.thumbnail)),l&&"attached"===l.status&&a){var d=this.db.getAttachmentUrl(r,s),u=t.getUniqueId(),h=t.getUniqueId();if("audio"===l.fileClass&&d){var p=e("<div>").attr("id",u).appendTo(n),f=e("<audio>").attr("id",h).attr("controls","controls").attr("width",300).appendTo(p),m=e("<source>").attr("src",d).appendTo(f);l.mimeType&&m.attr("type",l.mimeType),e("#"+h).mediaelementplayer({features:["playpause","progress","volume","sourcechooser"]})}else if("video"===l.fileClass&&d){p=e("<div>").attr("id",u).appendTo(n);var v=e("<video>").attr("id",h).attr("controls","controls").attr("width",l.width).attr("height",l.height).appendTo(p),g=e("<source>").attr("src",d).appendTo(v);l.mimeType&&g.attr("type",l.mimeType),e("#"+h).mediaelementplayer({poster:c,features:["playpause","progress","volume","sourcechooser","fullscreen"]})}var y=e("<span>").addClass("n2s_briefDisplay").attr("nunaliit-document",r._id).appendTo(n);this.fixElementAndChildren(y,{},null)}}else{var _=i("Media({docId},{attName})",{docId:o,attName:s});e("<span>").addClass("n2s_insertMediaPlayer_wait").text(_).appendTo(n)}},_insertModuleName:function(e,t){var n=this._associateDocumentToElement(t,e);if(t&&t._id===n&&t.nunaliit_module&&t.nunaliit_module.title){var r=i(t.nunaliit_module.title);e.text(r)}},_insertFirstThumbnail:function(t,i){var n=this._associateDocumentToElement(i,t);t.empty();var r=null;if(this.showService&&(r=this.showService.attachmentService),i&&i._id===n){var o=null;if(r)for(var s=r.getAttachments(i),a=0,l=s.length;a<l;++a){var c=s[a];if(c.isSource){var d=c.getThumbnailAttachment();if(d&&d.isAttached()){o=d;break}}}o&&e("<img>").attr("src",o.computeUrl()).appendTo(t)}},_insertHoverSoundIcon:function(i,r){var o=this,s=!1;if(t.couchSound&&t.couchSound.DocumentContainsHoverSound&&t.couchSound.DocumentContainsHoverSound(r)){var a=e("<div>").addClass("n2Show_icon_wrapper").appendTo(i);e("<div>").addClass("n2Show_icon_speaker").appendTo(a).click(function(){var e;return(e=o.showService.dispatchService)&&(s?(e.send(n,{type:"playHoverSoundOff",doc:r}),s=!1):(e.send(n,{type:"playHoverSoundOn",doc:r}),s=!0)),!1})}},_adjustExternalMediaLink:function(e,t){var n=e.attr("href"),o=null;t._attachments&&t._attachments[n]&&(o=t._attachments[n]);var s=null;if(t&&t.nunaliit_attachments&&t.nunaliit_attachments.files&&(s=t.nunaliit_attachments.files[n]),s&&"attached"===s.status&&o){var a=this.db.getAttachmentUrl(t,n);e.attr("href",a),e.click(function(e){return!!r||!!confirm(i("You are about to leave this page. Do you wish to continue?"))})}else e.click(function(e){return alert(i("File is not currently available")),!1})},_insertExternalMediaLink:function(t,n){var o=t.attr("nunaliit-attachment");t.empty();var s=null;n&&n._attachments&&n._attachments[o]&&(s=n._attachments[o]);var a=null;if(n&&n.nunaliit_attachments&&n.nunaliit_attachments.files&&(a=n.nunaliit_attachments.files[o]),a&&"attached"===a.status&&s){var l=this.db.getAttachmentUrl(n,o);a.originalAttachment&&n._attachments[a.originalAttachment]&&(l=this.db.getAttachmentUrl(n,a.originalAttachment));var c=e("<a></a>").addClass("n2s_adjustedExternalMediaLink").attr("href",l).click(function(e){return!!r||!!confirm(i("You are about to leave this page. Do you wish to continue?"))}).appendTo(t),d=a.originalName;d||(d=o),e("<span></span>").addClass("n2s_externalMediaLinkName").text(d).appendTo(c)}},_convertTextUrlToLink:function(e){function t(e,t){for(var i=t.nodeValue,n=!1,r=o.exec(i),s=null;r;){n=!0,s=r[3]+i.substr(r.index+r[0].length);var a=i.substr(0,r.index)+r[1];if(a.length>0){var l=e.ownerDocument.createTextNode(a);e.insertBefore(l,t)}var c=e.ownerDocument.createElement("a");c.setAttribute("href",r[2]),c.setAttribute("class","n2s_convertedUrl");var d=e.ownerDocument.createTextNode(r[2]);c.appendChild(d),e.insertBefore(c,t),i=s,r=o.exec(i)}if(s){var u=e.ownerDocument.createTextNode(s);e.insertBefore(u,t)}n&&e.removeChild(t)}e.each(function(){!function e(i){var n=i.firstChild;for(;n;)if(3===n.nodeType){var r=n.nextSibling;t(i,n),n=r}else e(n),n=n.nextSibling}(this)})},_clickFindGeometryOnMap:function(e,t){var i=this.showService.dispatchService;t&&t.nunaliit_geom&&i&&i.isEventTypeRegistered("find")?e.click(function(){return i.send(n,{type:"find",docId:t._id,doc:t}),!1}):e.remove()},_clickAddLayerFromDefinition:function(e,t){var i=this,r=this.viewLayerFunction,o=i.showService.dispatchService;(r||o)&&t&&t.nunaliit_layer_definition?e.click(function(){var e=t.nunaliit_layer_definition;if(r&&r(t),o){var s=e.id;s||(s=t._id);var a={name:e.name,type:"couchdb",options:{layerName:s,documentSource:i.documentSource}};o.send(n,{type:"addLayerToMap",layer:a,options:{setExtent:{bounds:e.bbox,crs:"EPSG:4326"}}})}return!1}):e.remove()},_clickEdit:function(e,t,i){var n=this;this.editFunction?e.click(function(){return n.editFunction(t,i),!1}):e.empty()},_clickDelete:function(e,t,i){var n=this;this.deleteFunction?e.click(function(){return n.deleteFunction(t,i),!1}):e.empty()},_clickLogin:function(e){var t=this;e.click(function(){var e=t.showService.dispatchService;return e&&e.send(n,{type:"loginShowForm"}),!1})},_clickMapEdit:function(e){var t=this;e.click(function(){var e=t.showService.dispatchService;return e&&e.send(n,{type:"mapSwitchToEditMode"}),!1})},_installMaxHeight:function(n){var r=n.attr("_maxheight");if(r){if(n.height()>r){var o=i("More"),s=i("Less"),a=t.getUniqueId(),l=n.contents(),c=e('<div class="n2show_maxHeightContent n2show_maxHeight_truncated"></div>').attr("id",a);n.append(c),l.each(function(){e(this).appendTo(c)}),c.css({overflow:"hidden",height:r+"px"});var d=e('<a href="#" class="n2show_maxHeightLink"></a>').text(o).click(function(t){t.preventDefault();var i=e(this),n=e("#"+a);return n.height()>r?(i.text(o),n.css("height",r+"px").addClass("n2show_maxHeight_truncated").removeClass("n2show_maxHeight_full")):(i.text(s),n.css("height","auto").addClass("n2show_maxHeight_full").removeClass("n2show_maxHeight_truncated")),!1});e('<div class="n2show_maxHeightLinkContainer"></div>').append(d).appendTo(n)}}else n.attr("n2s_error","Attribute _maxheight not found"),t.log("n2Show installMaxHeight: Attribute _maxHeight not found")},_handleHover:function(e,t){var i=this.showService.dispatchService,r=this._getDocumentIdentifier(t,e);i&&e.hover(function(){i.send(n,{type:"userFocusOn",docId:r})},function(){i.send(n,{type:"userFocusOff",docId:r})})},_installTiledImageClick:function(e,i){var n=this,r=this._getDocumentIdentifier(i,e),o=e.attr("nunaliit-attachment");if(r)if(o){var s=this.db.getAttachmentUrl({_id:r},o);e.css("cursor","pointer").click(function(){return new t.displayTiledImage.DisplayTiledImage({url:s,tileMapResourceName:"tilemapresource.xml",docId:r,showService:n.showService}),!1})}else e.attr("nunaliit-error","No attachment specified");else e.attr("nunaliit-error","No document specified")},_custom:function(e,i){this._associateDocumentToElement(i,e);var r=e.attr("nunaliit-custom");if(r)if(i){var o=e.attr("nunaliit-selector"),s=void 0;o&&(s=t.objectSelector.decodeFromDomAttribute(o)),(a=this.showService.dispatchService)&&a.synchronousCall(n,{type:"showCustom",elem:e,doc:i,customType:r,selector:s,showService:this.showService})}else{var a;(a=this.showService.dispatchService)&&a.synchronousCall(n,{type:"showCustom",elem:e,customType:r,showService:this.showService})}else e.attr("nunaliit-error","No custom type specified")},_userEvents:function(i,r){var o=this,s=this._getDocumentIdentifier(r,i),a=!1;"true"==i.attr("nunaliit-disable-click")&&(a=!0);var l=!1;if("true"==i.attr("nunaliit-disable-hover")&&(l=!0),s){var c="n2s_userEvents_doc_"+t.utils.stringToHtmlId(s);i.addClass(c);var d=this.showService.dispatchService;if(d){var u={type:"userIntentGetCurrent",intentMap:null};if(d.synchronousCall(n,u),u.intentMap){var h=u.intentMap[s];h&&(h.n2_selected&&i.addClass("nunaliit_selected"),h.n2_hovered&&i.addClass("nunaliit_hovered"),h.n2_find&&i.addClass("nunaliit_found"))}a||i.click(function(){var t=e(this).attr("nunaliit-create-schema");return t?o.showService._createDocIfInexistant(s,t):d.send(n,{type:"userSelect",docId:s}),!1}),l||i.mouseover(function(e){d.send(n,{type:"userFocusOn",docId:s})}).mouseout(function(e){d.send(n,{type:"userFocusOff",docId:s})})}}},_wikiTransform:function(i,n){var r=this,o=i.text();if(t.wiki){var s=t.wiki.WikiToHtml({wiki:o});i.html(s),i.find(".n2s_createDocOnClick").each(function(){var t=e(this);n&&n.nunaliit_schema&&t.attr("nunaliit-create-schema",n.nunaliit_schema)}),i.children().each(function(){r.fixElementAndChildren(e(this),{},n)})}},_showFindAvailable:function(e,i){var r=this._associateDocumentToElement(i,e),o="n2show_documentContent_"+t.utils.stringToHtmlId(r);if(e.addClass(o).attr("data-content-continuous","true"),i&&i._id===r){var s=!1,a=this.showService.dispatchService;if(a){var l={type:"findIsAvailable",docId:r,doc:i,isAvailable:!1};a.synchronousCall(n,l),l.isAvailable&&(s=!0)}s?e.removeClass("n2show_findNotAvailable").addClass("n2show_findAvailable"):e.removeClass("n2show_findAvailable").addClass("n2show_findNotAvailable")}},_getDocumentIdentifier:function(e,t){var i=t.attr("nunaliit-document");return!i&&e&&(i=e._id),i},_associateDocumentToElement:function(e,i){var n=this._getDocumentIdentifier(e,i),r=i.hasClass("n2show_documentAssociated");if(n&&!r){i.attr("nunaliit-document",n),i.addClass("n2show_documentAssociated");var o="n2show_documentUpdate_"+t.utils.stringToHtmlId(n);if(i.addClass(o),e&&e._id===n);else{var s="n2show_documentContent_"+t.utils.stringToHtmlId(n);i.addClass(s),this.showService._requestDocument(n)}}return n}}),l=t.Class({options:null,db:null,documentSource:null,requestService:null,dispatchService:null,schemaRepository:null,customService:null,attachmentService:null,displayImageSourceFactory:null,defaultSchema:null,displayFunction:null,editFunction:null,deleteFunction:null,viewLayerFunction:null,preprocessDocument:null,eliminateDeniedMedia:null,eliminateNonApprovedMedia:null,domStyler:null,postProcessDisplayFns:null,initialize:function(e){var i=t.extend({db:null,documentSource:null,requestService:null,dispatchService:null,schemaRepository:null,customService:null,attachmentService:null,displayImageSourceFactory:null,defaultSchema:null,displayFunction:null,editFunction:null,deleteFunction:null,viewLayerFunction:null,preprocessDocument:null,eliminateDeniedMedia:!1,eliminateNonApprovedMedia:!1},e),r=this;this.options={},this.db=i.db,this.documentSource=i.documentSource,this.requestService=i.requestService,this.dispatchService=i.dispatchService,this.schemaRepository=i.schemaRepository,this.customService=i.customService,this.attachmentService=i.attachmentService,this.displayImageSourceFactory=i.displayImageSourceFactory,this.defaultSchema=i.defaultSchema,this.displayFunction=i.displayFunction,this.editFunction=i.editFunction,this.deleteFunction=i.deleteFunction,this.viewLayerFunction=i.viewLayerFunction,this.options.preprocessDocument=i.preprocessDocument,this.eliminateDeniedMedia=i.eliminateDeniedMedia,this.eliminateNonApprovedMedia=i.eliminateNonApprovedMedia,this.postProcessDisplayFns=[],this.domStyler=new a({db:this.db,documentSource:this.documentSource,showService:this,displayFunction:this.displayFunction,editFunction:this.editFunction,deleteFunction:this.deleteFunction,viewLayerFunction:this.viewLayerFunction});var o=this.requestService;o&&o.addUserListener(function(e){r._displayUserDocument(e)});var s=this.dispatchService;if(s){var l=function(e,t,i){r._handleDispatch(e,t,i)};s.register(n,"start",l),s.register(n,"documentListResults",l),s.register(n,"documentContent",l),s.register(n,"documentDeleted",l),s.register(n,"documentContentCreated",l),s.register(n,"documentContentUpdated",l),s.register(n,"userIntentChanged",l),s.register(n,"findAvailabilityChanged",l)}},addPostProcessDisplayFunction:function(e){"function"==typeof e&&this.postProcessDisplayFns.push(e)},fixElementAndChildren:function(e,t,i){this.domStyler.fixElementAndChildren(e,t,i)},displayBriefDescription:function(e,i,n){var r=t.extend({onDisplayed:null,schemaName:null},i);n&&n._id&&(e.addClass("n2s_briefDisplayed"),e.attr("nunaliit-document",n._id),this.domStyler._associateDocumentToElement(n,e),this._displayDocumentBrief(e,n,r))},displayDocument:function(e,i,n){var r=t.extend({onDisplayed:null,schemaName:null},i);n&&n._id&&(e.addClass("n2s_fullDisplayed"),e.attr("nunaliit-document",n._id),this.domStyler._associateDocumentToElement(n,e),this._displayDocumentFull(e,n,r))},printUserName:function(e,i,n){e.addClass("n2ShowUser_"+t.utils.stringToHtmlId(i)),n&&n.showHandle?e.addClass("n2ShowUserDisplayAndHandle"):e.addClass("n2ShowUserDisplay"),this._adjustUserNameNode(e,i,void 0),this._requestUser(i)},printBriefDescription:function(e,t){e.addClass("n2s_briefDisplayed"),e.addClass("n2Show_docNotFound"),e.attr("nunaliit-document",t),this.domStyler._briefDisplay(e)},printDocument:function(e,t){e.addClass("n2s_fullDisplayed"),e.addClass("n2Show_docNotFound"),e.attr("nunaliit-document",t),this.domStyler._fullDisplay(e)},printLayerName:function(e,t){e.addClass("n2s_insertedLayerName"),e.attr("nunaliit-layer",t),e.text(t),this.domStyler._insertLayerName(e)},installUserEvents:function(i){var n=t.extend({doc:null,elem:null,disableClick:!1,disableHover:!1},i),r=e(n.elem);n.disableClick&&r.attr("nunaliit-disable-click","true"),n.disableHover&&r.attr("nunaliit-disable-hover","true"),this.domStyler._userEvents(r,n.doc)},showFindAvailable:function(i){var n=t.extend({doc:null,docId:null,elem:null},i),r=n.doc,o=n.docId;!o&&r&&(o=r._id);var s=null;n.elem&&(s=e(n.elem)),o&&s&&s.length>0&&(s.addClass("n2s_showedFindAvailable"),s.attr("nunaliit-document",o),this.domStyler._showFindAvailable(s,r))},_displayUserDocument:function(i){var n=this,r=i._id,o=i.display,s=null;"org.couchdb.user:"===r.substr(0,"org.couchdb.user:".length)&&(s=r.substr("org.couchdb.user:".length)),s&&e(".n2ShowUser_"+t.utils.stringToHtmlId(s)).each(function(){var t=e(this);n._adjustUserNameNode(t,s,o)})},_adjustUserNameNode:function(t,i,n){var r=!0;t.hasClass("n2ShowUserDisplay")?r=!1:t.hasClass("n2ShowUserDisplayAndHandle")&&(r=!0),t.empty().removeClass("n2ShowInsertedUserDisplayName"),n&&(e("<span>").addClass("n2Show_userDisplayName").text(n).appendTo(t),t.addClass("n2ShowInsertedUserDisplayName")),r&&e("<span>").addClass("n2Show_userName").text(i).appendTo(t)},_displayDocumentBrief:function(e,n,r){var o=t.extend({onDisplayed:null,schemaName:null},r),s=this;function a(e,t){e.removeClass("n2Show_docNotFound"),t.brief(n,e),s.fixElementAndChildren(e,{},n),s._postProcessDisplay(e,n),"function"==typeof o.onDisplayed&&o.onDisplayed(e,n,t,r)}function l(e){e.text(i("Unable to display brief description")),"function"==typeof o.onDisplayed&&o.onDisplayed(e,n,null,r)}n=this._preprocessDocument(n),o.schemaName?s.schemaRepository.getSchema({name:o.schemaName,onSuccess:function(t){a(e,t)},onError:function(){l(e)}}):n.nunaliit_schema?s.schemaRepository.getSchema({name:n.nunaliit_schema,onSuccess:function(t){a(e,t)},onError:function(){l(e)}}):s.defaultSchema?a(e,s.defaultSchema):l(e)},_displayDocumentFull:function(e,n,r){var o=t.extend({onDisplayed:null,schemaName:null},r),s=this;function a(e,t){e.removeClass("n2Show_docNotFound"),t.display(n,e),s.fixElementAndChildren(e,{},n),s._postProcessDisplay(e,n),"function"==typeof o.onDisplayed&&o.onDisplayed(e,n,t,r)}function l(e){e.text(i("Unable to display document"))}n=this._preprocessDocument(n),o.schemaName?s.schemaRepository.getSchema({name:o.schemaName,onSuccess:function(t){a(e,t)},onError:function(){l(e)}}):n.nunaliit_schema?s.schemaRepository.getSchema({name:n.nunaliit_schema,onSuccess:function(t){a(e,t)},onError:function(){l(e)}}):s.defaultSchema?a(e,s.defaultSchema):l(e)},_preprocessDocument:function(e){var t=e;return this.options&&this.options.preprocessDocument&&(t=this.options.preprocessDocument(t)),t},_postProcessDisplay:function(e,t){for(var i=0,n=this.postProcessDisplayFns.length;i<n;++i){(0,this.postProcessDisplayFns[i])(t,e)}},_requestUser:function(e){var t=this.requestService;t&&t.requestUser(e)},_requestDocument:function(e,t){var i=this.requestService;i&&i.requestDocument(e,t)},_requestLayerDefinition:function(e){var t=this.requestService;t&&t.requestLayerDefinition(e)},_handleDocumentListResults:function(t){var i=this;e(".n2show_documentList_wait").each(function(){var n=e(this),r=n.attr("nunaliit-list-type");void 0===r&&(r=n.attr("n2-list-type"));var o=n.attr("nunaliit-list-name");void 0===o&&(o=n.attr("n2-list-name"));var s=n.attr("nunaliit-list-live");if("false"===s&&(s=void 0),r===t.listType&&o===t.listName)if(n.removeClass("n2show_documentList_empty"),s||n.removeClass("n2show_documentList_wait"),n.empty(),t.docs&&t.docs.length>0){for(var a=0,l=t.docs.length;a<l;++a){var c=t.docs[a],d=c._id,u=e("<div>").addClass("n2show_documentList_item").addClass("n2s_userEvents").attr("nunaliit-document",d).appendTo(n),h=e("<a>").attr("href","#").appendTo(u);i._displayDocumentBrief(h,c)}i.fixElementAndChildren(n,{},null)}else if(t.docIds&&t.docIds.length>0){for(a=0,l=t.docIds.length;a<l;++a)d=t.docIds[a],u=e("<div>").addClass("n2show_documentList_item").addClass("n2s_userEvents").attr("nunaliit-document",d).appendTo(n),h=e("<a>").attr("href","#").addClass("n2s_briefDisplay").attr("nunaliit-document",d).text(d).appendTo(u);i.fixElementAndChildren(n,{},null)}else n.addClass("n2show_documentList_empty")})},_handleDocumentContent:function(e){e&&this.domStyler._receivedDocumentContent(e)},_handleDocumentUpdate:function(e){e&&this.domStyler._receivedDocumentUpdate(e)},_handleUserIntentChanged:function(i){if(i&&i.length>0)for(var n=0,r=i.length;n<r;++n){var o=i[n],s=o.n2_id,a="n2s_userEvents_doc_"+t.utils.stringToHtmlId(s);e("."+a).each(function(){var t=e(this);o.n2_selected?t.addClass("nunaliit_selected"):t.removeClass("nunaliit_selected"),o.n2_hovered?t.addClass("nunaliit_hovered"):t.removeClass("nunaliit_hovered"),o.n2_find?t.addClass("nunaliit_found"):t.removeClass("nunaliit_found")})}},_handleDispatch:function(i,n,o){if("start"===i.type){var s=this.customService;if(s){var a=s.getOption("displayPostProcessFunctions");if(a)for(var l=0,c=a.length;l<c;++l){var d=a[l];this.addPostProcessDisplayFunction(d)}r=s.getOption("displaySuppressLeaveConfirmation",!1)}}else if("documentListResults"===i.type)this._handleDocumentListResults(i);else if("documentDeleted"===i.type){if(f=i.docId){var u=t.utils.stringToHtmlId(f);e(".n2show_documentUpdate_"+u).remove()}}else if("documentContentCreated"===i.type){(h=i.doc)&&this._handleDocumentUpdate(h)}else if("documentContentUpdated"===i.type){var h;(h=i.doc)&&this._handleDocumentUpdate(h)}else if("documentContent"===i.type)this._handleDocumentContent(i.doc);else if("userIntentChanged"===i.type)i.changes&&this._handleUserIntentChanged(i.changes);else if("findAvailabilityChanged"===i.type){var p={};for(var f in e(".n2s_showedFindAvailable").each(function(){var t=e(this).attr("nunaliit-document");t&&(p[t]=!0)}),p)this._requestDocument(f)}},_createDocIfInexistant:function(e,t){var i=this;this.documentSource.getDocumentInfoFromIds({docIds:[e],onSuccess:function(r){for(var o={},s=0,a=r.length;s<a;++s){var l=r[s];o[l.id]=l}o[e]?i.dispatchService.send(n,{type:"userSelect",docId:e}):i.schemaRepository.getSchema({name:t,onSuccess:function(t){var r=t.createObject({_id:e});i.dispatchService.send(n,{type:"editInitiate",doc:r})}})}})}});t.couchShow={Show:l}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchEdit";function r(){var e=null;return"undefined"!=typeof OpenLayers&&OpenLayers.Projection&&(e=new OpenLayers.Projection("EPSG:4326")),e}function o(e,t,i){return!!t&&("_id"!==t[0]&&("_rev"!==t[0]&&"__n2Source"!==t[0]))}function s(e,t,i){return!!t&&("_id"!==t[0]&&("_rev"!==t[0]&&"__n2Source"!==t[0]))}function a(e,t,i){return!!t&&("_id"!==t[0]&&("_rev"!==t[0]&&"__n2Source"!==t[0]))}var l=t.Class({elemId:null,editedDocument:null,schema:null,defaultEditSchema:null,schemaRepository:null,schemaEditorService:null,dispatchService:null,editors:null,couchProj:null,treeEditor:null,slideEditor:null,isInsert:null,editorsContainerId:null,initialize:function(i){var o=t.extend({elem:null,elemId:null,doc:null,schema:null,defaultEditSchema:null,schemaRepository:null,schemaEditorService:null,dispatchService:null,editors:null,couchProj:null},i);if(this.elemId=o.elemId,o.elem){var s=e(o.elem);this.elemId=s.attr("id"),this.elemId||(this.elemId=t.getUniqueId(),s.attr("id",this.elemId))}this.schema=o.schema,this.defaultEditSchema=o.defaultEditSchema,this.schemaRepository=o.schemaRepository,this.schemaEditorService=o.schemaEditorService,this.dispatchService=o.dispatchService,this.editors=o.editors,this.couchProj=o.couchProj,this.editedDocument={};var a=t.extend(!0,{},o.doc);for(var l in a)"__n2Source"===l||(this.editedDocument[l]=a[l]);if(this.editedDocumentSource=void 0,this.dispatchService){var c={type:"documentSourceFromDocument",doc:o.doc};this.dispatchService.synchronousCall(n,c),this.editedDocumentSource=c.documentSource}if(this.isInsert=!1,this.couchProj||(this.couchProj=r()),this.dispatchService){var d=function(e){_this._handle(e)};this.dispatchService.register(n,"editGeometryModified",d),this.dispatchService.register(n,"mapGeometryAdded",d)}this.editors||(this.editors=[t.couchEdit.Constants.FORM_EDITOR,t.couchEdit.Constants.TREE_EDITOR,t.couchEdit.Constants.SLIDE_EDITOR,t.couchEdit.Constants.RELATION_EDITOR]),this._edit()},getDocument:function(){return this.editedDocument},_getDiv:function(){return e("#"+this.elemId)},_edit:function(){var e=this;this.isInsert=void 0===this.editedDocument._rev||null===this.editedDocument._rev,this._selectSchema(function(i){if(e.isInsert&&i){var n=i.createObject({});t.extend(!0,e.editedDocument,n)}e._displayEditor(i)})},_displayEditor:function(n){var r=this,l=this.editedDocument;this._synchronousCall({type:"editorStartDocumentEdit",doc:l}),t.couchDocument.adjustDocument(l);for(var c=!1,d=!1,u=0,h=0,p=this.editors.length;h<p;++h){var f=this.editors[h];t.couchEdit.Constants.FORM_EDITOR===f?n&&this.schemaEditorService&&++u:t.couchEdit.Constants.TREE_EDITOR===f?++u:t.couchEdit.Constants.SLIDE_EDITOR===f?++u:t.couchEdit.Constants.RELATION_EDITOR===f&&(d=!0)}u>1&&(c=!0);var m=this._getDiv();m.empty(),this.editorsContainerId=t.getUniqueId();var v=e('<div id="'+this.editorsContainerId+'" class="n2CouchEditor_container"></div>');m.append(v);for(h=0,p=this.editors.length;h<p;++h){f=this.editors[h];if(t.couchEdit.Constants.FORM_EDITOR===f&&n&&this.schemaEditorService){if(c){var g=e("<h3>").appendTo(v);e("<a>").attr("href","#").text(i("Form View")).appendTo(g)}var y=e('<div class="n2CouchEditor_schema"></div>').addClass("n2CouchEditor_schema").appendTo(v);this.schemaEditor=this.schemaEditorService.editDocument({doc:l,schema:n,$div:y,onChanged:function(){r._adjustInternalValues(r.editedDocument),r.treeEditor&&r.treeEditor.refresh(),r.slideEditor&&r.slideEditor.refresh(),r._refreshRelations(l),r._onEditorObjectChanged(l)}})}else if(t.couchEdit.Constants.TREE_EDITOR===f){if(c){var _=e("<h3>").appendTo(v);e("<a>").attr("href","#").text(i("Tree View")).appendTo(_)}var S=e("<div>").addClass("n2CouchEditor_tree").appendTo(v),b={onObjectChanged:function(){r._adjustInternalValues(r.editedDocument),r.slideEditor&&r.slideEditor.refresh(),r.schemaEditor&&r.schemaEditor.refresh(),r._refreshRelations(l),r._onEditorObjectChanged(l)},isKeyEditingAllowed:o,isValueEditingAllowed:s,isKeyDeletionAllowed:a},I=new t.tree.ObjectTree(S,l,b);this.treeEditor=new t.tree.ObjectTreeEditor(I,l,b)}else if(t.couchEdit.Constants.SLIDE_EDITOR===f){if(c){var C=e("<h3>").appendTo(v);e("<a>").attr("href","#").text(i("Editor View")).appendTo(C)}var D=e("<div>").addClass("n2CouchEditor_slide").appendTo(v),w={onObjectChanged:function(){r._adjustInternalValues(r.editedDocument),r.treeEditor&&r.treeEditor.refresh(),r.schemaEditor&&r.schemaEditor.refresh(),r._refreshRelations(l),r._onEditorObjectChanged(l)},isKeyEditingAllowed:o,isValueEditingAllowed:s,isKeyDeletionAllowed:a};this.slideEditor=new t.slideEditor.Editor(D,l,w)}}if(c&&v.accordion({collapsible:!0}),d){var E=e('<div class="editorDisplayRelations"></div>');v.append(E),this._refreshRelations(l)}},_selectSchema:function(n){var r=this;function o(o){if(o.length<1)n(null);else if(1!=o.length){for(var s=t.getUniqueId(),a=t.getUniqueId(),l=e('<div id="'+s+'" class="editorSelectSchemaDialog"><label for="'+a+'">'+i("Select a schema:")+'</label><select id="'+a+'"></select><div><button>'+i("OK")+"</button><button>"+i("Cancel")+"</button></div></div>"),c=l.find("select"),d=0,u=o.length;d<u;++d)c.append(e("<option>"+o[d].name+"</option>"));var h=!0;l.find("button").first().button({icons:{primary:"ui-icon-check"}}).click(function(){var i=e("#"+s),o=i.find("select").val();return t.log("schemaName",o),r.schemaRepository.getSchema({name:o,onSuccess:function(e){n(e)},onError:function(e){reportError("Unable to get selected schema: "+e),r._cancelEdit()}}),h=!1,i.dialog("close"),!1}).next().button({icons:{primary:"ui-icon-cancel"}}).click(function(){return e("#"+s).dialog("close"),!1});var p={autoOpen:!0,title:i("Select Document Schema"),modal:!0,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove(),h&&r._cancelEdit()}};l.dialog(p)}else n(o[0])}this.editedDocument.nunaliit_schema?this.schemaRepository.getSchema({name:this.editedDocument.nunaliit_schema,onSuccess:function(e){n(e)},onError:function(e){t.log("Error fetching schema: "+r.editedDocument.nunaliit_schema,e),n(null)}}):this.schema&&this.isInsert?t.couchEdit.Constants.ALL_SCHEMAS===this.schema?this.schemaRepository.getRootSchemas({onSuccess:function(e){o(e)},onError:function(e){t.log("Error fetching root schemas",e),n(null)}}):t.isArray(this.schema)?o(this.schema):n(this.schema):this.defaultEditSchema&&!this.isInsert?n(this.defaultEditSchema):n(null)},_dispatch:function(e){this.dispatchService&&this.dispatchService.send(n,e)},_synchronousCall:function(e){this.dispatchService&&this.dispatchService.send(n,e)},_handle:function(e,t,i){this._getDiv().length<1&&i.deregister(t),"editGeometryModified"===e.type?e._origin!==this&&this._geometryModified(e.docId,e.geom,e.proj):"mapGeometryAdded"===e.type&&this._addGeometry(e.geometry,e.projection)},_adjustInternalValues:function(e){if("undefined"!=typeof OpenLayers){var i=e.nunaliit_geom;i&&this.currentGeometryWkt!=i.wkt&&t.couchGeom.updatedGeometry(i)}},_refreshRelations:function(t){var n=this,r=this._getDiv().find(".editorDisplayRelations");if(!(r.length<1)){var o=this.showService;if(o){var s={};if(t&&t.nunaliit_relations&&t.nunaliit_relations.length)for(var a=0,l=t.nunaliit_relations.length;a<l;++a){var c=t.nunaliit_relations[a];c.doc&&(s[c.doc]=!0)}t&&t.nunaliit_source&&t.nunaliit_source.doc&&(s[t.nunaliit_source.doc]=!0),r.find(".editorDisplayRelation").each(function(){var t=e(this),i=t.attr("nunaliitRelationDocId");s[i]?delete s[i]:t.remove()});var d=function(t){var i=e(this).parents(".editorDisplayRelation");if(i.length>0){var r=i.attr("nunaliitRelationDocId");n._removeRelation(r),i.remove()}return!1};for(var u in s){var h=e('<div class="editorDisplayRelation"></div>');r.append(h),h.attr("nunaliitRelationDocId",u),e("<span></span>").text(i("Relation: ")).appendTo(h);var p=e("<span></span>").text(u).appendTo(h);o&&o.printBriefDescription(p,u),e('<button class="editorDisplayRelationButton"></button>').text(i("Remove")).appendTo(h).button({icons:{primary:"ui-icon-trash"}}).click(d)}}}},_onEditorObjectChanged:function(e){var i=e.nunaliit_geom;if(i&&"undefined"!=typeof OpenLayers&&this.currentGeometryWkt!==i.wkt){this.currentGeometryWkt=i.wkt;var n=t.couchGeom.getOpenLayersGeometry({couchGeom:i});this._dispatch({type:"editGeometryModified",docId:e._id,geom:n,proj:this.couchProj,_origin:this})}},_geometryModified:function(e,i,n){n.getCode()!=this.couchProj.getCode()&&(i=i.clone()).transform(n,this.options.couchProj);var r=this.editedDocument.nunaliit_geom;r.wkt=i.toString(),t.couchGeom.updatedGeometry(r),this.currentGeometryWkt=r.wkt,this.schemaEditor&&this.schemaEditor.refresh(),this.treeEditor&&this.treeEditor.refresh(),this.slideEditor&&this.slideEditor.refresh()},_addGeometry:function(e,i){i.getCode()!=this.couchProj.getCode()&&(e=e.clone()).transform(i,this.couchProj);var n=this.editedDocument.nunaliit_geom;n||(n={nunaliit_type:"geometry"},this.editedDocument.nunaliit_geom=n),n.wkt=e.toString(),t.couchGeom.updatedGeometry(n),this.currentGeometryWkt=n.wkt,this.schemaEditor&&this.schemaEditor.refresh(),this.treeEditor&&this.treeEditor.refresh(),this.slideEditor&&this.slideEditor.refresh()}}),c=t.Class({panelName:null,uploadService:null,searchService:null,showService:null,schemaEditorService:null,schemaRepository:null,customService:null,dispatchService:null,dialogService:null,initialLayers:null,schema:null,defaultEditSchema:null,documentSource:null,couchProj:null,onCancelFn:null,onCloseFn:null,moduleEditInfo:null,relatedDocProcess:null,schemaEditor:null,treeEditor:null,slideEditor:null,attachmentEditor:null,originalDocument:null,editedDocument:null,editedDocumentSchema:null,currentGeometryWkt:null,editorContainerId:null,isInsert:null,userButtons:null,editorSuppressSlideView:null,editorSuppressTreeView:null,editorSuppressFormView:null,onRefreshFunctions:null,enableAddFile:null,initialize:function(e){var i=t.extend({panelName:null,uploadService:null,searchService:null,showService:null,schemaEditorService:null,schemaRepository:null,customService:null,dispatchService:null,dialogService:null,initialLayers:[],schema:null,defaultEditSchema:null,documentSource:null,couchProj:null,onCancelFn:function(e){},onCloseFn:function(){},moduleEditInfo:null,relatedDocProcess:null},e),n=this;this.panelName=i.panelName,this.uploadService=i.uploadService,this.searchService=i.searchService,this.showService=i.showService,this.schemaEditorService=i.schemaEditorService,this.schemaRepository=i.schemaRepository,this.customService=i.customService,this.dispatchService=i.dispatchService,this.dialogService=i.dialogService,this.initialLayers=i.initialLayers,this.schema=i.schema,this.defaultEditSchema=i.defaultEditSchema,this.documentSource=i.documentSource,this.couchProj=i.couchProj,this.onCancelFn=i.onCancelFn,this.onCloseFn=i.onCloseFn,this.moduleEditInfo=i.moduleEditInfo,this.relatedDocProcess=i.relatedDocProcess,this.userButtons=[];for(var r in i)"button"===r.substr(0,"button".length)&&this.userButtons.push(i[r]);this.editorSuppressSlideView=!1,this.editorSuppressTreeView=!1,this.editorSuppressFormView=!1,this.enableAddFile=!1,this.onRefreshFunctions=[];var o=this.customService;o&&(this.editorSuppressSlideView=o.getOption("editorSuppressSlideView",!1),this.editorSuppressTreeView=o.getOption("editorSuppressTreeView",!1),this.editorSuppressFormView=o.getOption("editorSuppressFormView",!1),o.getOption("editorEnableAddFile",!1)&&(this.enableAddFile=!0),o.getOption("editorOnRefreshFunctions",[]).forEach(function(e){"function"==typeof e&&n.onRefreshFunctions.push(e)}));this.moduleEditInfo&&this.moduleEditInfo.enableAddFile&&(this.enableAddFile=!0)},isEditing:function(){return!!this.editedDocument},startEditingFromGeometry:function(e,i){var r=this;this.editedDocument={},this.editedDocumentSchema=null,this.currentGeometryWkt=void 0,this.isInsert=!0,this._selectSchema(function(){if(r.editedDocumentSchema){var o=r.editedDocumentSchema.createObject({});t.extend(!0,r.editedDocument,o)}if(i.getCode()!=r.couchProj.getCode()){var s=e.clone();s.transform(i,r.couchProj),e=s}var a=t.couchGeom.getCouchGeometry(e);r.editedDocument.nunaliit_geom=a,r.currentGeometryWkt=a.wkt,r.initialLayers&&r.initialLayers.length>0&&(r.editedDocument.nunaliit_layers=r.initialLayers);r.dispatchService.synchronousCall(n,{type:"preDocCreation",doc:r.editedDocument}),r._prepareDocument()})},startDocumentEditing:function(e){var i=this;this.editedDocument={},this.editedDocumentSchema=null;var r=t.extend(!0,{},e);for(var o in r)"__n2Source"===o||(this.editedDocument[o]=r[o]);if(this.editedDocumentSource=void 0,this.dispatchService){var s={type:"documentSourceFromDocument",doc:e};this.dispatchService.synchronousCall(n,s),this.editedDocumentSource=s.documentSource}this.currentGeometryWkt=void 0,this.editedDocument&&this.editedDocument.nunaliit_geom&&(this.currentGeometryWkt=this.editedDocument.nunaliit_geom.wkt),this.isInsert=void 0===this.editedDocument._rev||null===this.editedDocument._rev,this._selectSchema(function(){if(i.isInsert){if(i.editedDocumentSchema){var e=i.editedDocumentSchema.createObject({});t.extend(!0,e,i.editedDocument),i.editedDocument=e}i.dispatchService.synchronousCall(n,{type:"preDocCreation",doc:i.editedDocument})}i._prepareDocument()})},_prepareDocument:function(){var i=this,n=i.editedDocument,r=n.nunaliit_geom;if(r&&r.simplified&&r.simplified.original){var o=r.simplified.original;if(n._attachments&&n._attachments[o]&&this.editedDocumentSource){var s=this.editedDocumentSource.getDocumentAttachmentUrl(n,o);e.ajax({url:s,type:"get",async:!0,dataType:"text",success:function(e){t.couchGeom.updateDocumentWithWktGeometry({doc:n,wkt:e}),a()},error:function(e,i,r){t.log("Unable to retrieve original geometry",n),a()}})}else a()}else a();function a(){i.originalDocument=t.extend(!0,{},n);var e=t.couchGeom.getOpenLayersGeometry({doc:n});i._dispatch({type:"editReportOriginalDocument",docId:n._id,doc:n,geometry:e,projection:i.couchProj,_origin:i}),i._displayEditor()}},_selectSchema:function(e){var i=this;this.editedDocumentSchema=null,this.editedDocument.nunaliit_schema?this.schemaRepository.getSchema({name:this.editedDocument.nunaliit_schema,onSuccess:function(t){i.editedDocumentSchema=t,e(t)},onError:function(n){t.log("Error fetching schema: "+i.editedDocument.nunaliit_schema,n),e(null)}}):this.schema&&this.isInsert?t.couchEdit.Constants.ALL_SCHEMAS===this.schema?this.dialogService.selectSchema({onSelected:function(t){i.editedDocumentSchema=t,e(t)},onReset:function(){i._cancelEdit()}}):t.isArray(this.schema)?this.dialogService.selectSchema({schemas:this.schema,onSelected:function(t){i.editedDocumentSchema=t,e(t)},onReset:function(){i._cancelEdit()}}):(this.editedDocumentSchema=this.schema,e(this.schema)):this.defaultEditSchema&&!this.isInsert?(this.editedDocumentSchema=this.defaultEditSchema,e(this.defaultEditSchema)):e(null)},_displayEditor:function(){var n=this,r=this.editedDocumentSchema;e("body").addClass("nunaliit_editing"),e(".n2_disable_on_edit").attr("disabled","disabled");var l=this.editedDocument;this._synchronousCall({type:"editorStartDocumentEdit",doc:l}),t.couchDocument.adjustDocument(l);var c=!1,d=!1,u=!1,h=0,p=!1,m=this.schemaEditorService;!this.editorSuppressFormView&&r&&m&&(c=!0,++h),this.editorSuppressTreeView||(d=!0,++h),this.editorSuppressTreeView||(u=!0,++h),h>1&&(p=!0);var v=e("#"+this.panelName);v.empty(),this.editorContainerId=t.getUniqueId();var g=e('<div id="'+this.editorContainerId+'" class="n2CouchEditor_container"></div>');if(v.append(g),c){if(p){var y=e("<h3>").appendTo(g);e("<a>").attr("href","#").text(i("Form View")).appendTo(y)}var _=e("<div>").addClass("n2CouchEditor_schema").appendTo(g);this.schemaEditor=m.editDocument({doc:l,schema:r,$div:_,onChanged:function(){n._adjustInternalValues(n.editedDocument),n.treeEditor&&n.treeEditor.refresh(),n.slideEditor&&n.slideEditor.refresh(),n.attachmentEditor&&n.attachmentEditor.refresh(),n._refreshRelations(l),n.onEditorObjectChanged(l)}})}if(d){if(p){var S=e("<h3>").appendTo(g);e("<a>").attr("href","#").text(i("Tree View")).appendTo(S)}var b=e("<div>").addClass("n2CouchEditor_tree").appendTo(g),I={onObjectChanged:function(){n._adjustInternalValues(n.editedDocument),n.slideEditor&&n.slideEditor.refresh(),n.schemaEditor&&n.schemaEditor.refresh(),n.attachmentEditor&&n.attachmentEditor.refresh(),n._refreshRelations(l),n.onEditorObjectChanged(l)},isKeyEditingAllowed:o,isValueEditingAllowed:s,isKeyDeletionAllowed:a},C=new t.tree.ObjectTree(b,l,I);this.treeEditor=new t.tree.ObjectTreeEditor(C,l,I)}if(u){if(p){var D=e("<h3>").appendTo(g);e("<a>").attr("href","#").text(i("Editor View")).appendTo(D)}var w=e("<div>").addClass("n2CouchEditor_slide").appendTo(g),E={onObjectChanged:function(){n._adjustInternalValues(n.editedDocument),n.treeEditor&&n.treeEditor.refresh(),n.schemaEditor&&n.schemaEditor.refresh(),n.attachmentEditor&&n.attachmentEditor.refresh(),n._refreshRelations(l),n.onEditorObjectChanged(l)},isKeyEditingAllowed:o,isValueEditingAllowed:s,isKeyDeletionAllowed:a};this.slideEditor=new t.slideEditor.Editor(w,l,E)}p&&g.accordion({collapsible:!0}),e("<div>").addClass("editorDisplayRelations").appendTo(g),this._refreshRelations(l);var x=!this.enableAddFile,T=e("<div>").addClass("editorAttachments").appendTo(g);if(this.attachmentEditor=new f({doc:l,elem:T,documentSource:this.documentSource,uploadService:this.uploadService,disableAddFile:x,disableRemoveFile:x,moduleEditInfo:this.moduleEditInfo,onChangedFn:function(){n._adjustInternalValues(n.editedDocument),n.schemaEditor&&n.schemaEditor.refresh(),n.treeEditor&&n.treeEditor.refresh(),n.slideEditor&&n.slideEditor.refresh(),n._refreshRelations(l),n.onEditorObjectChanged(l)}}),window.cordova){var k=e("<label>").addClass("cordova-btn cordova-icon cordova-location-toggle width-200").appendTo(g).text(i("Current Location")).click(function(t){t.preventDefault(),n.attachmentEditor.cordovaLocation=!n.attachmentEditor.cordovaLocation,n.attachmentEditor.cordovaLocation?(e(this).removeClass("icon-unchecked"),e(this).addClass("icon-checked")):(e(this).removeClass("icon-checked"),e(this).addClass("icon-unchecked"))});n.attachmentEditor.cordovaLocation?(k.removeClass("icon-unchecked"),k.addClass("icon-checked")):(k.removeClass("icon-checked"),k.addClass("icon-unchecked"))}var L=e('<div class="editorButtons"></div>');g.append(L);var M=e('<button class="save">'+i("Save")+"</button>");if(L.append(M),M.button({icons:{primary:"ui-icon-check"}}),M.click(function(){return n._save(),!1}),!this.isInsert&&t.couchMap.canDeleteDoc(l)){var O=e('<button class="delete">'+i("Delete")+"</button>");L.append(O),O.button({icons:{primary:"ui-icon-trash"}}),O.click(function(e){return confirm(i("Do you really want to delete this feature?"))&&n.documentSource.deleteDocument({doc:n.editedDocument,onSuccess:function(){n._discardEditor({deleted:!0})},onError:function(e){n._enableControls(),t.reportErrorForced("Unable to delete document: "+e)}}),!1})}this.attachmentEditor&&this.attachmentEditor.printButtons({elem:L});var A=e('<button class="relation">'+i("Add Relation")+"</button>");L.append(A),A.button({icons:{primary:"ui-icon-plusthick"}}),A.click(function(){return n._addRelationDialog(),!1});var F=e('<button class="layers">'+i("Layers")+"</button>");L.append(F),F.button({icons:{primary:"ui-icon-link"}}),F.click(function(){return n._manageLayersDialog(),!1});var R=e('<button class="cancel">'+i("Cancel")+"</button>");L.append(R),R.button({icons:{primary:"ui-icon-cancel"}}),R.click(function(){return n._cancelEdit(),!1});for(var N=0,P=this.userButtons.length;N<P;++N){var B=this.userButtons[N],U=e("<button>"+i(""+B.label)+"</button>");if(B.buttonClass&&U.addClass(B.buttonClass),B.before)L.find("button."+B.before).before(U);else if(B.after){L.find("button."+B.after).after(U)}else L.append(U);U.button(B.options),j(U,B)}g=n._getEditorContainer();function j(e,t){e.click(function(){return!!t.click&&t.click(n.editedDocument,n,t)})}n.onRefreshFunctions.forEach(function(e){e(n.editedDocument,g,n)})},_save:function(){var e=this;if(window.cordova){if(!(e.attachmentEditor.cordovaAttachment||"demo_media"!==e.attachmentEditor.doc.nunaliit_schema&&"media"!==e.attachmentEditor.doc.nunaliit_schema))return void alert(i("A file must be selected or recorded"));e.editedDocument.nunaliit_attachments=null,e.editedDocument.nunaliit_mobile_attachments=e.attachmentEditor.cordovaAttachment,e.editedDocument.nunaliit_mobile_needs_new_location=e.attachmentEditor.cordovaLocation,o()}else this._disableControls(),this.uploadService?this.uploadService.getWelcome({onSuccess:function(){n()},onError:function(i){e._enableControls(),t.reportErrorForced("Server is not available: "+i)}}):n();function n(){e.attachmentEditor?e.attachmentEditor.performPreSavingActions({onSuccess:function(e){r()},onError:function(i){e._enableControls(),t.reportErrorForced(i)}}):r()}function r(){if(e.editedDocument&&e.editedDocument.nunaliit_attachments&&(void 0!==e.editedDocument.nunaliit_attachments._compulsory&&delete e.editedDocument.nunaliit_attachments._compulsory,e.editedDocument.nunaliit_attachments.files))for(var t in e.editedDocument.nunaliit_attachments.files){var i=e.editedDocument.nunaliit_attachments.files[t];void 0!==i._compulsory&&delete i._compulsory}o()}function o(){var n=!1;e.documentSource.isSubmissionDataSource&&(n=!0),e.isInsert?e.documentSource.createDocument({doc:e.editedDocument,onSuccess:function(e){s(e,!0,n)},onError:function(n){e._enableControls(),t.reportErrorForced(i("Unable to submit document: {err}",{err:n}))}}):e.documentSource.updateDocument({doc:e.editedDocument,originalDoc:e.originalDocument,onSuccess:function(e){s(e,!1,n)},onError:function(n){e._enableControls(),t.reportErrorForced(i("Unable to submit document: {err}",{err:n}))}})}function s(i,n,r){window.cordova?a(i,n,r):e.attachmentEditor?e.attachmentEditor.performPostSavingActions({onSuccess:function(e){a(i,n,r)},onError:function(i){e._enableControls(),t.reportErrorForced(i)}}):a(i,n,r)}function a(t,i,n){var r={saved:!0,submissionDs:n};i?r.inserted=!0:r.updated=!0,e._discardEditor(r)}},_addRelationDialog:function(){var e=this;this.dialogService&&this.dialogService.searchForDocumentId({onSelected:function(t){e._addRelation(t)}})},_addRelation:function(e){var t=this.editedDocument;if(!t||!t.nunaliit_source||t.nunaliit_source.doc!==e){if(t&&t.nunaliit_relations&&t.nunaliit_relations.length)for(var i=0,n=t.nunaliit_relations.length;i<n;++i){if(t.nunaliit_relations[i].doc===e)return}t&&(t.nunaliit_relations||(t.nunaliit_relations=[]),t.nunaliit_relations.push({nunaliit_type:"reference",doc:e}),this.refresh())}},_removeRelation:function(e){var t=this.editedDocument,i=!1;if(t&&t.nunaliit_source&&t.nunaliit_source.doc===e&&(delete t.nunaliit_source,i=!0),t&&t.nunaliit_relations&&t.nunaliit_relations.length){for(var n=!1,r=[],o=0,s=t.nunaliit_relations.length;o<s;++o){var a=t.nunaliit_relations[o];a.doc===e?n=!0:r.push(a)}r.length<1?(delete t.nunaliit_relations,i=!0):n&&(t.nunaliit_relations=r,i=!0)}i&&this.refresh()},_manageLayersDialog:function(){var e=this,t=this.editedDocument,i=t.nunaliit_layers;i||(i=[]),this.dialogService&&this.dialogService.selectLayersDialog({currentLayers:i,onSelected:function(i){i.length<1?t.nunaliit_layers&&delete t.nunaliit_layers:t.nunaliit_layers=i,e.refresh()}})},_removeAttachment:function(e){var t=this.editedDocument,i={};if(t&&t.nunaliit_attachments&&t.nunaliit_attachments.files)for(var n in t.nunaliit_attachments.files){var r=t.nunaliit_attachments.files[n];n===e?i[n]=!0:r.source===e&&(i[n]=!0)}var o=!1;n=null;for(n in i)t._attachments&&t._attachments[n]&&(delete t._attachments[n],o=!0),t.nunaliit_attachments.files[n]&&(delete t.nunaliit_attachments.files[n],o=!0);if(t._attachments){var s=!0;for(n in t._attachments)s=!1;s&&(delete t._attachments,o=!0)}if(t.nunaliit_attachments){s=!0;if(t.nunaliit_attachments.files)for(n in t.nunaliit_attachments.files)s=!1;s&&(delete t.nunaliit_attachments,o=!0)}o&&this.refresh()},_cancelEdit:function(){this._dispatch({type:"editCancel",doc:this.editedDocument})},performCancellation:function(e){var i=t.extend({suppressEvents:!1},e);null!=this.editedDocument&&(this.onCancelFn(this.editedDocument),this._discardEditor({cancelled:!0,suppressEvents:i.suppressEvents}))},performSave:function(e){t.extend({},e);null!=this.editedDocument&&this._save()},_discardEditor:function(i){var n=t.extend({saved:!1,inserted:!1,updated:!1,submissionDs:!1,deleted:!1,cancelled:!1,suppressEvents:!1},i);if(null!=this.editedDocument){var r=this.originalDocument,o=this.editedDocument;if(this.editedDocument=null,this._getEditorContainer().remove(),this.onCloseFn(o,this,{saved:n.saved,inserted:n.inserted,updated:n.updated,deleted:n.deleted,cancelled:n.cancelled}),!n.suppressEvents){var s=void 0,a=void 0;n.cancelled?r&&r._id&&(a=(s=r)._id):n.saved&&o&&o._id&&(a=(s=o)._id),this._dispatch({type:"editClosed",docId:a,doc:s,saved:n.saved,inserted:n.inserted,updated:n.updated,deleted:n.deleted,cancelled:n.cancelled,submissionDs:n.submissionDs})}this.editorContainerId=null,e("body").removeClass("nunaliit_editing"),e(".n2_disable_on_edit").removeAttr("disabled")}},refresh:function(){this._adjustInternalValues(this.editedDocument),this.treeEditor&&this.treeEditor.refresh(),this.slideEditor&&this.slideEditor.refresh(),this.schemaEditor&&this.schemaEditor.refresh(),this._refreshRelations(this.editedDocument),this.onEditorObjectChanged(this.editedDocument)},_adjustInternalValues:function(e){if("undefined"!=typeof OpenLayers){var i=e.nunaliit_geom;i&&this.currentGeometryWkt!=i.wkt&&t.couchGeom.updatedGeometry(i)}},_refreshRelations:function(t){var n=this,r=this._getEditorContainer().find(".editorDisplayRelations");if(!(r.length<1)){var o=this.showService,s={};if(t&&t.nunaliit_relations&&t.nunaliit_relations.length)for(var a=0,l=t.nunaliit_relations.length;a<l;++a){var c=t.nunaliit_relations[a];c.doc&&(s[c.doc]=!0)}t&&t.nunaliit_source&&t.nunaliit_source.doc&&(s[t.nunaliit_source.doc]=!0),r.find(".editorDisplayRelation").each(function(){var t=e(this),i=t.attr("nunaliitRelationDocId");s[i]?delete s[i]:t.remove()});var d=function(t){var i=e(this).parents(".editorDisplayRelation");if(i.length>0){var r=i.attr("nunaliitRelationDocId");n._removeRelation(r),i.remove()}return!1};for(var u in s){var h=e('<div class="editorDisplayRelation"></div>');r.append(h),h.attr("nunaliitRelationDocId",u),e("<span></span>").text(i("Relation: ")).appendTo(h);var p=e("<span></span>").text(u).appendTo(h);o&&o.printBriefDescription(p,u),e('<button class="editorDisplayRelationButton"></button>').text(i("Remove")).appendTo(h).button({icons:{primary:"ui-icon-trash"}}).click(d)}}},onEditorObjectChanged:function(e){var i=this,n=void 0;if(e&&e.nunaliit_geom&&(n=e.nunaliit_geom.wkt),"undefined"!=typeof OpenLayers&&this.currentGeometryWkt!==n){this.currentGeometryWkt=n;var r=null;n&&(r=t.couchGeom.getOpenLayersGeometry({wkt:n})),this._dispatch({type:"editGeometryModified",docId:e._id,geom:r,proj:this.couchProj,_origin:this})}var o=this._getEditorContainer();this.onRefreshFunctions.forEach(function(e){e(i.editedDocument,o,i)})},_geometryModified:function(e,i,n){n.getCode()!=this.couchProj.getCode()&&(i=i.clone()).transform(n,this.couchProj);var r=this.editedDocument.nunaliit_geom;r.wkt=i.toString(),t.couchGeom.updatedGeometry(r),this.currentGeometryWkt=r.wkt,this.schemaEditor&&this.schemaEditor.refresh(),this.treeEditor&&this.treeEditor.refresh(),this.slideEditor&&this.slideEditor.refresh()},_addGeometry:function(e,i){i.getCode()!=this.couchProj.getCode()&&(e=e.clone()).transform(i,this.couchProj);var n=this.editedDocument.nunaliit_geom;n||(n={nunaliit_type:"geometry"},this.editedDocument.nunaliit_geom=n),n.wkt=e.toString(),t.couchGeom.updatedGeometry(n),this.currentGeometryWkt=n.wkt,this.schemaEditor&&this.schemaEditor.refresh(),this.treeEditor&&this.treeEditor.refresh(),this.slideEditor&&this.slideEditor.refresh()},_getEditorContainer:function(){return e("#"+this.editorContainerId)},_disableControls:function(){var e=this._getEditorContainer();e.find("button").attr("disabled","disabled"),e.find("input:text").attr("disabled","disabled"),e.find(".editorAttachFile").find("input:text").removeAttr("disabled")},_enableControls:function(){var e=this._getEditorContainer();e.find("button").removeAttr("disabled"),e.find("input:text").removeAttr("disabled")},_dispatch:function(e){var t=this.dispatchService;t&&t.send(n,e)},_synchronousCall:function(e){var t=this.dispatchService;t&&t.synchronousCall(n,e)},_handle:function(e){"editGeometryModified"===e.type?e._origin!==this&&this._geometryModified(e.docId,e.geom,e.proj):"mapGeometryAdded"===e.type?this._addGeometry(e.geometry,e.projection):"historyIsHashChangePermitted"===e.type&&null!=this.editedDocument&&(confirm(i("Do you wish to leave document editor?"))?this._cancelEdit():e.permitted=!1)}}),d=t.Class({options:null,documentSource:null,panelName:null,couchProj:null,schema:null,defaultEditSchema:null,schemaRepository:null,uploadService:null,showService:null,authService:null,dispatchService:null,searchService:null,schemaEditorService:null,customService:null,dialogService:null,initialLayers:null,userButtons:null,relatedDocProcess:null,isFormEditor:null,currentEditor:null,moduleEditInfo:null,initialize:function(e){var i=t.extend({documentSource:null,panelName:null,couchProj:null,schema:null,defaultEditSchema:null,schemaRepository:null,uploadService:null,showService:null,authService:null,dispatchService:null,searchService:null,schemaEditorService:null,customService:null,dialogService:null,createDocProcess:null,initialLayers:[]},e),o=this;this.options={},this.documentSource=i.documentSource,this.panelName=i.panelName,this.couchProj=i.couchProj,this.options.schema=i.schema,this.defaultEditSchema=i.defaultEditSchema,this.initialLayers=i.initialLayers,this.schemaRepository=i.schemaRepository,this.uploadService=i.uploadService,this.showService=i.showService,this.authService=i.authService,this.dispatchService=i.dispatchService,this.searchService=i.searchService,this.schemaEditorService=i.schemaEditorService,this.customService=i.customService,this.dialogService=i.dialogService,this.isFormEditor=!0,this.relatedDocProcess=i.createDocProcess,this.couchProj||(this.couchProj=r());var s=this.dispatchService;if(s){var a=function(e){o._handle(e)};s.register(n,"editInitiate",a),s.register(n,"editCreateFromGeometry",a),s.register(n,"editCancel",a),s.register(n,"editTriggerSave",a),s.register(n,"editGetState",a),s.register(n,"selected",a),s.register(n,"editGeometryModified",a),s.register(n,"mapGeometryAdded",a),s.register(n,"historyIsHashChangePermitted",a)}this.userButtons={};for(var l in i)"button"===l.substr(0,"button".length)&&(this.userButtons[l]=i[l])},showDocumentForm:function(e,t){null!=this.currentEditor&&(this.currentEditor.performCancellation(),this.currentEditor=null),this.currentEditor=this._createEditor(t),this.currentEditor.startDocumentEditing(e)},configureOptions:function(e){this.moduleEditInfo=e},_createEditor:function(e){var t={panelName:(e=e||{}).panelName?e.panelName:this.panelName,initialLayers:e.initialLayers?e.initialLayers:this.initialLayers,schema:e.schema?e.schema:this.options.schema,onCancelFn:e.onCancelFn,onCloseFn:e.onCloseFn,moduleEditInfo:this.moduleEditInfo,uploadService:this.uploadService,searchService:this.searchService,showService:this.showService,schemaEditorService:this.schemaEditorService,schemaRepository:this.schemaRepository,customService:this.customService,dispatchService:this.dispatchService,dialogService:this.dialogService,defaultEditSchema:this.defaultEditSchema,documentSource:this.documentSource,couchProj:this.couchProj,relatedDocProcess:this.relatedDocProcess};for(var i in this.userButtons)t[i]=this.userButtons[i];for(var i in e)"button"===i.substr(0,"button".length)&&(t[i]=e[i]);return new c(t)},cancelDocumentForm:function(e){null!=this.currentEditor&&(this.currentEditor.performCancellation(e),this.currentEditor=null)},saveDocumentForm:function(e){null!=this.currentEditor&&(this.currentEditor.performSave(e),this.currentEditor=null)},setPanelName:function(e){this.panelName=e},setSchemas:function(e){this.options.schema=e},getInitialLayerIds:function(){return this.initialLayers},setInitialLayerIds:function(e){this.initialLayers=e},_initiateEditor:function(e){var t=this,i=this.authService;i&&0==i.isLoggedIn()?i.showLoginForm({onSuccess:function(i,n){t._initiateEditor(e)}}):this.showDocumentForm(e)},_createFromGeometry:function(e,t){var i=this,n=this.authService;n&&0==n.isLoggedIn()?n.showLoginForm({onSuccess:function(n,r){i._createFromGeometry(e,t)}}):(null!=this.currentEditor&&(this.currentEditor.performCancellation(),this.currentEditor=null),this.currentEditor=this._createEditor(),this.currentEditor.startEditingFromGeometry(e,t))},_handle:function(e,t,i){"editInitiate"===e.type?this._initiateEditor(e.doc):"editCreateFromGeometry"===e.type?this._createFromGeometry(e.geometry,e.projection):"editCancel"===e.type?this.cancelDocumentForm():"editTriggerSave"===e.type?this.saveDocumentForm():"editGetState"===e.type?this.currentEditor&&this.currentEditor.isEditing()&&(e.isEditing=!0):"selected"===e.type?null!=this.currentEditor&&(this.cancelDocumentForm(),this.dispatchService.send(n,e)):this.currentEditor&&this.currentEditor.isEditing()&&this.currentEditor._handle(e)}}),u=t.Class({doc:null,schema:null,$div:null,onChanged:null,formEditor:null,postProcessFns:null,showService:null,initialize:function(e){var i=t.extend({doc:null,schema:null,$div:null,onChanged:function(){},funcMap:null,postProcessFns:null,showService:null},e),n=this;this.doc=i.doc,this.schema=i.schema,this.$div=i.$div,this.onChanged=i.onChanged,this.postProcessFns=i.postProcessFns,this.showService=i.showService,this.formEditor=this.schema.form(this.doc,this.$div,{},function(){var e=n.showService;e&&e.fixElementAndChildren(n.$div,{},n.doc),n.onChanged()},i.funcMap);var r=this.showService;r&&r.fixElementAndChildren(this.$div,{},this.doc),this._performPostProcess()},refresh:function(){this.formEditor.refresh();var e=this.showService;e&&e.fixElementAndChildren(this.$div,{},this.doc),this._performPostProcess()},_performPostProcess:function(){for(var e=0,t=this.postProcessFns.length;e<t;++e){var i=this.postProcessFns[e];"function"==typeof i&&i(this.doc,this.$div)}}}),h=function(){},p=t.Class({documentSource:null,showService:null,searchService:null,dispatchService:null,dialogService:null,funcMap:null,postProcessFunctions:null,initialize:function(e){var i=t.extend({postProcessFn:null,documentSource:null,showService:null,searchService:null,dispatchService:null,dialogService:null},e);this.postProcessFunctions=[],this.documentSource=i.documentSource,this.showService=i.showService,this.searchService=i.searchService,this.dispatchService=i.dispatchService,this.dialogService=i.dialogService,this.funcMap={},this.dialogService&&(this.funcMap=this.dialogService.getFunctionMap()),i.postProcessFn&&this.postProcessFunctions.push(i.postProcessFn)},editDocument:function(e){var i=t.extend({doc:null,schema:null,$div:null,onChanged:h},e);return new u({doc:i.doc,schema:i.schema,$div:i.$div,onChanged:i.onChanged,funcMap:this.funcMap,postProcessFns:this.postProcessFunctions,showService:this.showService})},addPostProcessFunction:function(e){"function"==typeof e&&this.postProcessFunctions.push(e)}}),f=t.Class({doc:null,elemId:null,documentSource:null,uploadService:null,onChangedFn:null,creationAttachmentNames:null,compulsoryAttachmentNames:null,disableAddFile:null,disableRemoveFile:null,moduleEditInfo:null,recordingButton:null,recordingStatus:null,recorder:null,recordingStream:null,recordingInterval:null,currentRecordingType:null,maxAudioRecordingLengthSeconds:null,maxVideoRecordingLengthSeconds:null,recordVideoSize:null,mediaElementEl:null,cordovaAttachment:null,cordovaLocation:null,initialize:function(i){var n=t.extend({doc:null,elem:null,documentSource:null,uploadService:null,onChangedFn:function(){},disableAddFile:!1,disableRemoveFile:!1,moduleEditInfo:void 0},i);this.doc=n.doc,this.documentSource=n.documentSource,this.uploadService=n.uploadService,this.onChangedFn=n.onChangedFn,this.disableAddFile=n.disableAddFile,this.disableRemoveFile=n.disableRemoveFile,this.moduleEditInfo=n.moduleEditInfo,this.creationAttachmentNames=[],this.compulsoryAttachmentNames=[],this.maxAudioRecordingLengthSeconds=300,this.maxVideoRecordingLengthSeconds=300,this.recordVideoSize={width:640,height:480},this.moduleEditInfo&&("number"==typeof this.moduleEditInfo.maxAudioRecordingLengthSeconds&&this.moduleEditInfo.maxAudioRecordingLengthSeconds>0&&(this.maxAudioRecordingLengthSeconds=this.moduleEditInfo.maxAudioRecordingLengthSeconds),"number"==typeof this.moduleEditInfo.maxVideoRecordingLengthSeconds&&this.moduleEditInfo.maxVideoRecordingLengthSeconds>0&&(this.maxVideoRecordingLengthSeconds=this.moduleEditInfo.maxVideoRecordingLengthSeconds),"object"==typeof this.moduleEditInfo.recordVideoSize&&(this.recordVideoSize=t.extend(this.recordVideoSize,this.moduleEditInfo.recordVideoSize)));var r=e(n.elem);if(r.addClass("attachmentEditor"),this.elemId=t.utils.getElementIdentifier(r),this.doc&&!this.doc._rev&&(void 0!==this.doc.nunaliit_maxAudioRecordingLengthSeconds&&(this.maxAudioRecordingLengthSeconds=this.doc.nunaliit_maxAudioRecordingLengthSeconds,delete this.doc.nunaliit_maxAudioRecordingLengthSeconds),void 0!==this.doc.nunaliit_maxVideoRecordingLengthSeconds&&(this.maxVideoRecordingLengthSeconds=this.doc.nunaliit_maxVideoRecordingLengthSeconds,delete this.doc.nunaliit_maxVideoRecordingLengthSeconds),void 0!==this.doc.nunaliit_recordVideoSize)){var o=this.doc.nunaliit_recordVideoSize.split("x");this.recordVideoSize={width:o[0],height:o[1]},delete this.doc.nunaliit_recordVideoSize}this.cordovaLocation=!this.doc._rev;var s=!0;if(this.doc&&!this.doc._rev&&this.doc.nunaliit_attachments&&(void 0!==this.doc.nunaliit_attachments._compulsory&&(s=this.doc.nunaliit_attachments._compulsory),this.doc.nunaliit_attachments.files))for(var a in this.doc.nunaliit_attachments.files){var l=this.doc.nunaliit_attachments.files[a],c=s;void 0!==l._compulsory&&(c=l._compulsory),this.creationAttachmentNames.push(a),c&&this.compulsoryAttachmentNames.push(a),l.attachmentName=a,l.status="waiting for upload",l.data||(l.data={})}this.refresh()},refresh:function(){var n=this._getElem();if(!(n.length<1)){var r={};if(this.doc.nunaliit_attachments&&this.doc.nunaliit_attachments.files)for(var o in this.doc.nunaliit_attachments.files){var s=this.doc.nunaliit_attachments.files[o];r[o]=s}var a=[];for(var o in r){var l=(s=r[o]).source;l&&r[l]&&a.push(o)}for(var c=0,d=a.length;c<d;++c){o=a[c];delete r[o]}var u=[];for(var o in r)u.push(o);u.sort(),n.find(".attachmentEditor_att").each(function(){var t=e(this),i=t.attr("n2AttName");i&&r[i]||t.remove()});for(c=0,d=u.length;c<d;++c){o=u[c];var h="attachmentEditor_att_"+t.utils.stringToHtmlId(o);if(n.find("."+h).length<1){var p=i("File");this.creationAttachmentNames.indexOf(o)>=0?this._addCreationAttachmentElement({attName:o,label:p}):this.disableRemoveFile||this._addFileElement({attName:o,label:p})}}!u.length&&window.cordova&&this.doc.nunaliit_mobile_attachments&&(this.cordovaAttachment=this.doc.nunaliit_mobile_attachments,this._addCreationAttachmentElement({attName:this.cordovaAttachment,label:i("File")}))}},printButtons:function(n){var r=t.extend({elem:null,classNames:null},n),o=this;if(!this.disableAddFile){var s=e(r.elem),a=e("<button>").text(i("Add File")).appendTo(s).click(function(){return o._openAddFileDialog(),!1});r.classNames&&a.addClass(r.classNames),a.button({icons:{primary:"ui-icon-plusthick"}})}},performPreSavingActions:function(n){for(var r=t.extend({onSuccess:function(){},onError:function(e){}},n),o=this,s=this.documentSource,a=this._getElem(),l=null,c=0,d=this.compulsoryAttachmentNames.length;c<d;++c){var u=this.compulsoryAttachmentNames[c];(p=(h=a.find(".attachmentEditor_att_"+t.utils.stringToHtmlId(u))).find('input[type="file"]').val())||y(h)&&(p="recordedFile"),p||(l=u)}if(l)r.onError(i("A file must be selected or recorded"));else{void 0!==o.recordingStream&&null!=o.recordingStream&&o.recordingStream.stop();for(c=0,d=this.creationAttachmentNames.length;c<d;++c){var h,p;u=this.creationAttachmentNames[c];(p=(h=a.find(".attachmentEditor_att_"+t.utils.stringToHtmlId(u))).find('input[type="file"]').val())||y(h)&&(p="recordedFile"),p||(h.remove(),this.doc.nunaliit_attachments&&this.doc.nunaliit_attachments.files&&this.doc.nunaliit_attachments.files[u]&&delete this.doc.nunaliit_attachments.files[u])}if(this.doc.nunaliit_attachments){var f=0;if(this.doc.nunaliit_attachments.files)for(var u in this.doc.nunaliit_attachments.files)++f;f<1&&delete this.doc.nunaliit_attachments}var m=a.find("form"),v=m.length;if(v<1)r.onSuccess();else{var g=[];!function t(){g.length>=v?(n=o.doc,m.each(function(){var t=e(this),i=t.attr("n2AttName"),r=g.pop(),o=null;n&&n.nunaliit_attachments&&n.nunaliit_attachments.files&&(o=n.nunaliit_attachments.files[i]),o?(o.uploadId=r,n._id&&e('<input type="hidden">').attr("name","id").attr("value",n._id).prependTo(t),n._rev&&e('<input type="hidden">').attr("name","rev").attr("value",n._rev).prependTo(t),r&&e('<input type="hidden">').attr("name","uploadId").attr("value",r).prependTo(t)):t.remove()}),r.onSuccess()):s.getUniqueIdentifier({onSuccess:function(e){g.push(e),t()},onError:function(e){r.onError(i("Unable to reach server: {err}",{err:e}))}});var n}()}}function y(e){var t=e.find("audio"),i=e.find("video"),n=null;return t.length>0?n=t[0]:i.length>0&&(n=i[0]),!(!n||null===n.currentSrc||""===n.currentSrc||null!==n.srcObject)}},performPostSavingActions:function(e){var n=t.extend({onSuccess:function(e){},onError:function(e){}},e),r=this,o=this._getElem().find("form");if(o.length<1)n.onSuccess();else{var s=o.first(),a=s.attr("n2AttName"),l=null,c=null;this.doc&&this.doc.nunaliit_attachments&&this.doc.nunaliit_attachments.files&&a&&this.doc.nunaliit_attachments.files[a]&&(l=(c=this.doc.nunaliit_attachments.files[a]).uploadId);var d=s.find('input[type="file"]').val(),u=null;if(!d){var h=s.find("audio");h.length>0&&(u=m(h=h[0],"audio/mp3",".mp3"),d="audio.mp3")}if(!d){var p=s.find("video");p.length>0&&null!==(p=p[0]).currentSrc&&""!==p.currentSrc&&null===p.srcObject&&(u=m(p,"video/webm",".webm"),d="video.webm")}d&&c&&l?this.uploadService.submitForm({form:s,uploadFile:u,suppressInformationDialog:!0,onSuccess:function(){s.remove(),f()},onError:function(e){n.onError(i("Unable to upload file. Cause: {err}",{err:e}))}}):(s.remove(),f())}function f(){r.performPostSavingActions(e)}function m(e,t,i){var n=function(e,t){if(!window||window.window!==window)throw new Error("This module is only available in browser");var i=window.Blob||window.MozBlob||window.WebKitBlob;if(!i)throw new Error("Blob was not supported");var n=e.match(/^data:((.*?)(;charset=.*?)?)(;base64)?,/);if(!n)throw new Error("invalid dataURI");for(var r=!!n[4],o=e.slice(n[0].length),s=r?atob(o):decodeURIComponent(o),a=[],l=0;l<s.length;l++)a.push(s.charCodeAt(l));return new i([new Uint8Array(a)],{type:t})}(e.src,t);return"function"==typeof File&&File.length>=2?(d=(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"")+i,new File([n],d,{type:t})):new Blob([n],{type:t})}},_getElem:function(){return e("#"+this.elemId)},_openAddFileDialog:function(){var n=this;if(!(this._getElem().length<1)){var r=t.getUniqueId(),o=t.getUniqueId(),s=e("<div>").attr("id",r).addClass("attachmentEditor_dialog"),a=e("<div>").addClass("attachmentEditor_dialog_content").appendTo(s),l=e("<form>").attr("id",o).addClass("attachmentEditor_form").appendTo(a);e('<input type="file">').attr("name","media").appendTo(l);var c=e("<div>").addClass("attachmentEditor_dialog_buttons").appendTo(s);e("<button>").text(i("Attach")).appendTo(c).click(function(){var t=e("#"+r),s=e("#"+o);return s.find("input").val()?(n._addFileForm(s),t.dialog("close")):alert(i("You must select a file")),!1}).button({icons:{primary:"ui-icon-plusthick"}}),e("<button>").text(i("Cancel")).appendTo(c).click(function(){return e("#"+r).dialog("close"),!1}).button({icons:{primary:"ui-icon-cancel"}}),s.dialog({autoOpen:!0,title:i("Add File"),modal:!0,width:740,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}})}},_addFileForm:function(e){if(this.doc){this.doc.nunaliit_attachments||(this.doc.nunaliit_attachments={nunaliit_type:"attachment_descriptions",files:{}}),this.doc.nunaliit_attachments.files||(this.doc.nunaliit_attachments.files={});var n="media";if(this.doc.nunaliit_attachments.files[n])for(var r=0;this.doc.nunaliit_attachments.files[n];)if(n="media_"+ ++r,r>100)return void t.log("Unable to compute attachment name for new attachment");this.doc.nunaliit_attachments.files[n]={attachmentName:n,status:"waiting for upload",data:{}},e.attr("n2AttName",n),e.addClass("attachmentEditor_form"),this._addFileElement({attName:n,label:i("New File"),form:e}),this.onChangedFn()}},_removeAttachment:function(e){var t=!1,i=[];if(this.doc&&this.doc.nunaliit_attachments&&this.doc.nunaliit_attachments.files){for(var n in this.doc.nunaliit_attachments.files[e]&&(delete this.doc.nunaliit_attachments.files[e],t=!0),this.doc.nunaliit_attachments.files){e===this.doc.nunaliit_attachments.files[n].source&&i.push(n)}for(var r=0,o=i.length;r<o;++r){var s=i[r];delete this.doc.nunaliit_attachments.files[s],t=!0}var a=0;for(n in this.doc.nunaliit_attachments.files)++a;a<1&&delete this.doc.nunaliit_attachments}if(this.doc&&this.doc._attachments){this.doc._attachments[e]&&(delete this.doc._attachments[e],t=!0);for(r=0,o=i.length;r<o;++r){s=i[r];this.doc._attachments[s]&&(delete this.doc._attachments[s],t=!0)}}t&&(this.refresh(),this.onChangedFn())},_addCreationAttachmentElement:function(n){var r,o,s=t.extend({attName:null,label:null},n),a=this,l=this._getElem(),c=s.attName,d="attachmentEditor_att_"+t.utils.stringToHtmlId(c),u=e("<div>").addClass("attachmentEditor_att").addClass(d).attr("n2AttName",c).appendTo(l),h=e("<form>").addClass("attachmentEditor_creationForm").attr("n2AttName",c).appendTo(u),p=[];if(window.cordova){var f=e("<div>").addClass("attachmentEditor_cordovaCaptureButtonsContainer").appendTo(h),m=e("<div>").addClass("attachmentEditor_cordovaCaptureButtonsContainer").appendTo(h).hide();e("<label>").addClass("cordova-btn cordova-icon icon-remove cordova-remove-button").appendTo(m).text(i("Remove")).click(function(e){e.preventDefault(),a.cordovaAttachment=null,f.show(),D(),m.hide(),o&&(o.remove(),o=null)});if(a.cordovaAttachment){var v=a.cordovaAttachment.lastIndexOf("/"),g=a.cordovaAttachment.substring(v+1),y=e("<p>").text(g).appendTo(h);p.push(y),f.hide(),m.show()}document.addEventListener("deviceready",function(){var t=e("<div>").addClass("attachmentEditor_buttonDiv").appendTo(f);e('<input type="file" id="file-input">').addClass("attachmentEditor_hiddenFileInput").appendTo(t).change(function(t){if(t.target&&t.target.files&&t.target.files[0]){var n=t.target.files[0].name;if(!n)return console.error("Impossible to get the file name."),void alert("Our apologies, there was a problem getting the file.");var r=this;window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(o){o.root.getFile(n,{create:!0,exclusive:!1},function(n){n.createWriter(function(o){o.onwriteend=function(){E(n.nativeURL),D();var i=e("<div>").addClass("attachmentEditor_fileName").text(t.target.files[0].name).appendTo(h);C(m),p.push(i),f.hide(),m.show(),r.value=null},o.onerror=function(e){console.error("Failed file write: "+e.toString()),alert(i("Our apologies, there was a problem getting the file."))},o.write(t.target.files[0])})},function(e){console.error("Error getting file",e),alert(i("Our apologies, there was a problem getting the file."))})},function(e){console.error("Error requesting file system",e),alert(i("Our apologies, there was a problem getting the file."))})}}),e('<label for="file-input">').addClass("cordova-btn width-150 cordova-icon icon-file").text(i("Choose File")).appendTo(t);var n=e("<div>").addClass("attachmentEditor_buttonDiv").appendTo(f);navigator.camera&&e("<label>").addClass("cordova-btn width-150 cordova-icon icon-camera").appendTo(n).text(i("Capture Photo")).click(function(t){t.preventDefault(),navigator.camera.getPicture(function(t){E(t),D();var i=e("<img>",{src:t}).addClass("attachmentEditor_photoPreview").appendTo(h);C(m),p.push(i),f.hide(),m.show()},function(e){console.error("Error getting picture:",e),alert(i("Our apologies, there was a problem getting the photo."))},{correctOrientation:!0})});var o=e("<div>").addClass("attachmentEditor_buttonDiv").appendTo(f);navigator.device&&navigator.device.capture&&e("<label>").addClass("cordova-btn width-150 cordova-icon icon-video").appendTo(o).text(i("Capture Video")).click(function(t){t.preventDefault(),navigator.device.capture.captureVideo(function(t){if(t&&t[0]&&t[0].fullPath){var n=t[0].fullPath.lastIndexOf("/"),r=t[0].fullPath.substring(n+1);E(t[0].fullPath),D();var o=e("<p>").addClass("attachmentEditor_fileName").text(r).appendTo(h);C(m),p.push(o),f.hide(),m.show()}else console.error("No video uploaded."),alert(i("Our apologies, we cannot get your video."))},function(e){console.error("Error getting video:",e),alert(i("Our apologies, there was a problem getting the video."))},{quality:0,duration:30})});var s=e("<div>").addClass("attachmentEditor_buttonDiv").appendTo(f);window.Media&&e("<label>").addClass("cordova-btn width-150 cordova-icon icon-audio").appendTo(s).text(i("Capture Audio")).click(function(t){t.preventDefault();var n="audio_"+a.doc.nunaliit_created.time+".aac";!function(t){m.show(),f.hide(),r=e("<div>").addClass("attachmentEditor_cordovaRecordingControls").appendTo(h),e("<div>").addClass("cordova-btn cordova-icon icon-record").text(i("Record")).appendTo(r).click(function(i){i.preventDefault(),t.startRecord(),e(this).hide(),n.show()});var n=e("<div>").addClass("cordova-btn cordova-icon icon-stop").text(i("Stop")).appendTo(r).click(function(e){e.preventDefault(),t.stopRecord(),r.hide()}).hide()}(new window.Media(n,function(){E(window.file.externalRootDirectory+n),D();var t=e("<p>").addClass("attachmentEditor_fileName").text(i("Recording complete: {audioFilename}",{audioFilename:n})).appendTo(h);C(m),p.push(t),m.show(),f.hide()},function(e){console.error("recordAudio():Audio Error: ",e),alert(i("Our apologies, there was a problem recording audio. Error code: {code}",{code:e.code}))}))})},!1)}else{e("<div>").addClass("attachmentEditor_clearfix").appendTo(u);var _="file",S=e("<div>").addClass("attachmentEditor_uploadTabs").appendTo(h);e("<button>").text(i("File Upload")).addClass("attachmentEditor_uploadTab_file").appendTo(S).click(function(e){e.preventDefault(),a._clickTab(c,"file")});var b=e("<div>").addClass("attachmentEditor_uploadTabContent attachmentEditor_uploadTabContent_file").appendTo(h);e('<input type="file">').attr("name","media").change(function(e){a._attachmentFileChanged(e)}).appendTo(b);var I=!1;("https:"==document.location.protocol||"localhost"==window.location.hostname||window.location.hostname.startsWith("127.0."))&&(I=!0),"undefined"!=typeof DetectRTC&&"undefined"!=typeof RecordRTC&&"undefined"!=typeof lamejs&&I?DetectRTC.load(function(){if(DetectRTC.hasMicrophone){e("<button>").text(i("Record Audio")).addClass("attachmentEditor_uploadTab_audio").click(function(e){e.preventDefault(),a._clickTab(c,"audio")}).appendTo(S);var n=e("<div>").addClass("attachmentEditor_uploadTabContent attachmentEditor_uploadTabContent_audio").appendTo(h),r=e("<div>").addClass("attachmentEditor_recordingContainer").appendTo(n);if(a.audioRecordingButton=e("<button>").addClass("attachmentEditor_micButton").appendTo(r).click(function(e){a._clickRecording(e,"audio")}),a.audioRecordStatus=e("<div>").addClass("attachmentEditor_recordStatus").appendTo(r),DetectRTC.hasWebcam&&!DetectRTC.browser.isEdge){h.addClass("attachmentEditor_creationFormWithVideo"),e("<button>").text(i("Record Video")).addClass("attachmentEditor_uploadTab_video").click(function(e){e.preventDefault(),a._clickTab(c,"video")}).appendTo(S);var o=e("<div>").addClass("attachmentEditor_uploadTabContent attachmentEditor_uploadTabContent_video").appendTo(h),s=e("<div>").addClass("attachmentEditor_videoRecordingContainer").appendTo(o);a.videoRecordingButton=e("<button>").addClass("attachmentEditor_videoButton").appendTo(s).click(function(e){a._clickRecording(e,"video")});var l=e("<div>").addClass("attachmentEditor_meVideo").appendTo(s);a.videoRecordStatus=e("<div>").addClass("attachmentEditor_recordStatus").appendTo(l)}else t.log("no webcam present")}else t.log("no microphone present");w()}):w()}function C(t){window.resolveLocalFileSystemURL("file:"+a.cordovaAttachment,function(n){n.file(function(n){n&&n.type&&(n.type.startsWith("image")||(o=e("<label>").addClass("cordova-btn cordova-icon icon-preview cordova-preview-button").appendTo(t).text(i("Preview")).click(function(e){e.preventDefault(),window.cordova.plugins.fileOpener2.open(a.cordovaAttachment,n.type,{error:function(e){console.error("Error opening file",n)},success:function(){console.log("Opening file",n)}})})))})},function(e){console.error("Problem fetching cordova attachment preview for "+a.cordovaAttachment,e)})}function D(){for(var e=0;e<p.length;e++)p[e].remove();r&&r.hide()}function w(){a._clickTab(c,_)}function E(e){a.cordovaAttachment=e.replace("file:/","/")}},_addFileElement:function(n){var r=t.extend({attName:null,label:null,form:null},n),o=this,s=this._getElem(),a=r.attName,l="attachmentEditor_att_"+t.utils.stringToHtmlId(a),c=e("<div>").addClass("attachmentEditor_att").addClass(l).attr("n2AttName",a).appendTo(s);if(e("<span>").addClass("attachmentEditor_label").text(r.label).appendTo(c),r.form){var d,u=r.form.find('input[type="file"]').val();if(u)(d=u.lastIndexOf("/"))>=0&&(u=u.substr(d+1));if(u)(d=u.lastIndexOf("\\"))>=0&&(u=u.substr(d+1));e("<span>").addClass("attachmentEditor_attName").text(u).appendTo(c)}else e("<span>").addClass("attachmentEditor_attName").text(a).appendTo(c);e("<a>").attr("href","#").attr("n2AttName",a).addClass("attachmentEditor_delete").text(i("Remove")).appendTo(c).click(function(){var t=e(this).attr("n2AttName");return t&&o._removeAttachment(t),!1}),r.form&&r.form.appendTo(c)},_attachmentFileChanged:function(e){},_clickTab:function(e,i){var n=this._getElem().find(".attachmentEditor_att_"+t.utils.stringToHtmlId(e)),r=n.find(".attachmentEditor_uploadTab_"+i),o="attachmentEditor_uploadTabContent_"+i;if(i!==n.attr("n2attType")){n.attr("n2attType",i),n.find(".attachmentEditor_uploadTabContent").hide(),n.find(".attachmentEditor_uploadTabs button").removeClass("active"),null!==this.recordingInterval&&this._cancelRecording(),void 0!==this.recordStatus&&this.recordStatus.text("");var s=n.find(".attachmentEditor_videoRecordingContainer video");s.length>0&&(void 0!==this.recordingStream&&null!=this.recordingStream&&this.recordingStream.stop(),s.remove(),this.mediaElementEl.remove(),n.find(".attachmentEditor_videoRecordingContainer .mejs__container")[0].remove());var a=n.find(".attachmentEditor_recordingContainer audio");a.length>0&&a.remove(),n.find(".attachmentEditor_uploadTabContent_file input").val(""),r.addClass("active"),n.find("."+o).show(),"audio"!==i&&"video"!==i||(this._setupRecording(i),this.currentRecordingType=i)}},_clickRecording:function(e,t){e.preventDefault();null===this.recordingInterval?this._startRecording(t):this._stopRecording(t)},_setupRecording:function(t){var i=this;"audio"===t?(i.recordStatus=i.audioRecordStatus,i.recordingButton=i.audioRecordingButton):"video"===t&&(i.recordStatus=i.videoRecordStatus,i.recordingButton=i.videoRecordingButton),i._captureUserMedia(t,function(n){if(i.recordingStream=n,"audio"===t)i.recorder=RecordRTC(n,{type:"audio",recorderType:StereoAudioRecorder,numberOfAudioChannels:1});else{i._setupVideoPreview(n);var r="video/webm";i._isMimeTypeSupported("video/webm;codecs=h264")&&(r="video/webm;codecs=h264"),i.recorder=RecordRTC(n,{mimeType:r})}var o=e(".attachmentEditor_recordingContainer audio");o.length>0&&o[0].remove()})},_setupVideoPreview:function(t){var i=e(".attachmentEditor_videoRecordingContainer video");i.length>0&&(this.mediaElementEl.remove(),delete i[0],e(".attachmentEditor_videoRecordingContainer .mejs__container")[0].remove());var n=e(".attachmentEditor_meVideo"),r=320/(this.recordVideoSize.width/this.recordVideoSize.height),o=e("<video>").attr("controls","controls").attr("height",r+"px").attr("width","320px").prependTo(n)[0];e.fn&&e.fn.mediaelementplayer&&(this.mediaElementEl=e(o).mediaelementplayer({features:["fullscreen"]}),e(".attachmentEditor_videoRecordingContainer .mejs__container .mejs__overlay-play .mejs__overlay-button").hide()),o.muted=!0,o.controlls=!1,o.src=null,o.srcObject=t,o.play()},_isMimeTypeSupported:function(e){return"Edge"!==DetectRTC.browser.name&&"Safari"!==DetectRTC.browser.name&&"undefined"!=typeof MediaRecorder&&("function"!=typeof MediaRecorder.isTypeSupported||MediaRecorder.isTypeSupported(e))},_startRecording:function(t){this.obj;(this.recordStatus.text(""),this.recorder.startRecording(),"audio"===t)?this.recordingButton.toggleClass("attachmentEditor_stopRecordingButton attachmentEditor_micButton"):(this.recordingButton.toggleClass("attachmentEditor_stopRecordingButton attachmentEditor_videoButton"),null==e(".attachmentEditor_videoRecordingContainer video")[0].srcObject&&this._setupVideoPreview(this.recordingStream));this._recordingTimer(t)},_recordingTimer:function(e){var t=this,i=0,n="audio"===e?t.maxAudioRecordingLengthSeconds:t.maxVideoRecordingLengthSeconds,r=t._secondsToTimeString(n);t.recordingInterval=setInterval(function(){if(++i>=n)t._stopRecording();else{var e=t._secondsToTimeString(i);t.recordStatus.text(e+"/"+r)}},1e3)},_secondsToTimeString:function(e){var t=Math.floor(e/60),i=e-60*t;return i<10&&(i="0"+i),t+":"+i},_stopRecordingTimer:function(){clearInterval(this.recordingInterval),this.recordingInterval=null},_captureUserMedia:function(e,n){var r={audio:!0};if("video"===e){var o=!0;o="Firefox"===DetectRTC.browser.name||"Chrome"===DetectRTC.browser.name&&DetectRTC.browser.version>=60?{width:this.recordVideoSize.width,height:this.recordVideoSize.height}:{optional:[],mandatory:{minWidth:this.recordVideoSize.width,minHeight:this.recordVideoSize.height}},r.video=o}navigator.getUserMedia(r,n,function(e){alert(i("Unable to capture your microphone and/or camera.")),t.logError(e)})},_cancelRecording:function(){this._stopRecordingTimer(),this.recorder.stopRecording(),this.recordingStream.stop(),"video"===this.currentRecordingType?this.recordingButton.toggleClass("attachmentEditor_stopRecordingButton attachmentEditor_videoButton"):"audio"===this.currentRecordingType&&this.recordingButton.toggleClass("attachmentEditor_stopRecordingButton attachmentEditor_micButton"),this.recordStatus.text("")},_stopRecording:function(e){var t=this;this.obj;t._stopRecordingTimer(),t.recordingButton.prop("disabled",!0),t.recordStatus.text(i("Processing...")),t.recorder.stopRecording(function(){var i=t.recorder.getBlob();"audio"===e?t._processAudioRecording(i):t.recorder.getDataURL(function(e){t._processVideoRecording(e)})})},_processAudioRecording:function(t){var n=this,r=new FileReader;r.onload=function(){var t=n._getWavSamples(this.result),r=n._encodeMp3(t),o=new FileReader;o.onload=function(t){var r=e(".attachmentEditor_recordingContainer audio");r.length>0?r[0].src=t.target.result:e("<audio>").attr("src",t.target.result).attr("controls","controls").insertAfter(n.recordingButton),n.recordingButton.prop("disabled",!1),n.recordingButton.toggleClass("attachmentEditor_stopRecordingButton attachmentEditor_micButton"),n.recordStatus.text(i("Captured Audio"))},o.readAsDataURL(r)},r.readAsArrayBuffer(t)},_processVideoRecording:function(t){var n=e(".attachmentEditor_videoRecordingContainer video");n.length>0&&(this.mediaElementEl.remove(),delete n[0],e(".attachmentEditor_videoRecordingContainer .mejs__container")[0].remove());var r=e(".attachmentEditor_meVideo"),o=320/(this.recordVideoSize.width/this.recordVideoSize.height),s=e("<video>").attr("src",t).attr("height",o+"px").attr("width","320px").attr("controls","controls").prependTo(r);this.mediaElementEl=e(s).mediaelementplayer({features:["playpause","progress","volume","fullscreen"]}),this.recordingButton.prop("disabled",!1),this.recordingButton.toggleClass("attachmentEditor_stopRecordingButton attachmentEditor_videoButton"),this.recordStatus.text(i("Captured Video"))},_getWavSamples:function(e){var t=new Int16Array(e);if(2===lamejs.WavHeader.readHeader(new DataView(e)).channels){for(var i=[],n=[],r=0;r<t.length;)i.push(t[r]),n.push(t[r+1]),r+=2;t=new Int16Array(i)}return t.slice(45,t.length-45)},_encodeMp3:function(e){for(var t=new lamejs.Mp3Encoder(1,44100,128),i=[],n=0;n<e.length;n+=1152){var r=e.subarray(n,n+1152);(o=t.encodeBuffer(r)).length>0&&i.push(o)}var o;return(o=t.flush()).length>0&&i.push(new Int8Array(o)),new Blob(i,{type:"audio/mp3"})}});t.couchEdit={EditService:d,SchemaEditorService:p,CouchSimpleDocumentEditor:l,Constants:{ALL_SCHEMAS:{},FORM_EDITOR:{},TREE_EDITOR:{},SLIDE_EDITOR:{},RELATION_EDITOR:{}},AttachmentEditor:f},t.CouchEditor={Constants:t.couchEdit.Constants}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchRelatedDoc",r=t.Class({elemId:null,schemaNames:null,allSchemas:null,label:null,dialogPrompt:null,createDocProcess:null,initialize:function(e){var n=t.extend({elem:null,schemaNames:null,allSchemas:!1,label:null,dialogPrompt:null,createDocProcess:null},e);this.createDocProcess=n.createDocProcess,this.schemaNames=n.schemaNames,this.allSchemas=n.allSchemas,this.label=n.label,this.dialogPrompt=n.dialogPrompt,this.elemId=t.utils.getElementIdentifier(n.elem),this.label||(this.label=i("Create Document")),this._refresh()},_getElem:function(){return e("#"+this.elemId)},_refresh:function(){var t=this,i=this._getElem();i.empty(),e("<button>").text(this.label).appendTo(i).click(function(){t._createDocClicked()})},_createDocClicked:function(){this.createDocProcess.createDocumentFromSchemaNames({schemaNames:this.schemaNames,allSchemas:this.allSchemas,prompt:this.dialogPrompt})}}),o=t.Class({documentSource:null,uploadService:null,showService:null,dialogService:null,obj:null,schema:null,prompt:null,onSuccess:null,onError:null,onCancel:null,moduleEditInfo:null,diagId:null,attachmentUploadHandler:null,initialize:function(n){var r=t.extend({documentSource:null,uploadService:null,showService:null,dialogService:null,obj:null,schema:null,prompt:null,elem:null,onSuccess:function(e){},onError:t.reportErrorForced,onCancel:function(){},moduleEditInfo:void 0},n);for(var o in this.documentSource=r.documentSource,this.uploadService=r.uploadService,this.showService=r.showService,this.dialogService=r.dialogService,this.schema=r.schema,this.prompt=r.prompt,this.onSuccess=r.onSuccess,this.onError=r.onError,this.onCancel=r.onCancel,this.moduleEditInfo=r.moduleEditInfo,this.obj={},r.obj)"__n2Source"===o||(this.obj[o]=r.obj[o]);var s=this,a=t.getUniqueId();this.diagId=a;var l=e("<div>").attr("id",a).addClass("n2RelatedDoc_dialog");if(r.elem){var c=e(r.elem);l.addClass("n2RelatedDoc_located").appendTo(c)}else l.appendTo(e("body"));var d=this.obj,u=this.schema,h={};this.dialogService&&(h=this.dialogService.getFunctionMap());var p=e("<div>").addClass("n2RelatedDoc_dialogContent").appendTo(l),f=e("<div>").appendTo(p);u.form(d,f,null,function(){s.showService&&s.showService.fixElementAndChildren(f,{},d)},h),this.showService&&this.showService.fixElementAndChildren(f,{},d);var m=e("<div>").appendTo(p);if(this.attachmentUploadHandler=new t.couchEdit.AttachmentEditor({doc:d,elem:m,documentSource:this.documentSource,uploadService:this.uploadService,disableAddFile:!0,disableRemoveFile:!0,moduleEditInfo:this.moduleEditInfo}),e("<button>").text(i("OK")).button({icons:{primary:"ui-icon-check"}}).appendTo(p).click(function(){return s._clickOK(),!1}),e("<button>").text(i("Cancel")).button({icons:{primary:"ui-icon-cancel"}}).appendTo(p).click(function(){return s._clickCancel(),!1}),!r.elem){var v={autoOpen:!0,title:i("Fill Out Related Document"),modal:!window.cordova,width:window.cordova?"100%":740,close:function(t,i){e("#"+a).remove()}};l.dialog(v)}},_clickOK:function(){var e=this,t=this.obj;if(window.cordova){if(!e.attachmentUploadHandler.cordovaAttachment)return void alert(i("A file must be selected or recorded"));e._saveObj()}else this.attachmentUploadHandler.performPreSavingActions({doc:t,documentSource:this.documentSource,onSuccess:function(){e._saveObj()},onError:function(e){alert(e)}})},_clickCancel:function(){var t=e("#"+this.diagId);t.hasClass("n2RelatedDoc_located")?t.remove():t.dialog("close"),this.onCancel()},_saveObj:function(){var e=this,n=this.obj;t.couchDocument.adjustDocument(n),window.cordova&&(n.nunaliit_attachments=null,n.nunaliit_mobile_attachments=e.attachmentUploadHandler.cordovaAttachment),this.documentSource.createDocument({doc:n,onSuccess:function(t){window.cordova?e._success(t._id):e._uploadFile(t)},onError:function(t){e._error(i("Unable to reach database to submit document: {err}",{err:t}))}})},_uploadFile:function(e){var t=this;this.attachmentUploadHandler.performPostSavingActions({doc:e,onSuccess:function(){t._success(e._id)},onError:function(e){t._error(i("Error occurred after related document was created. Error: {err}",{err:e}))}})},_success:function(t){var i=e("#"+this.diagId);i.hasClass("n2RelatedDoc_located")?i.remove():i.dialog("close"),this.onSuccess(t)},_error:function(t){var n=this,r=e("#"+this.diagId).find(".n2RelatedDoc_dialogContent").empty();e("<div>").addClass("n2RelatedDoc_error").text(t).appendTo(r),e("<button>").text(i("Cancel")).button({icons:{primary:"ui-icon-cancel"}}).appendTo(r).click(function(){return n._clickCancel(),!1}),this.onError(t)}}),s=t.Class({documentSource:null,schemaRepository:null,uploadService:null,showService:null,authService:null,dialogService:null,moduleEditInfo:null,initialize:function(e){var i=t.extend({documentSource:null,schemaRepository:null,dispatchService:null,uploadService:null,showService:null,authService:null,dialogService:null},e);this.documentSource=i.documentSource,this.schemaRepository=i.schemaRepository,this.uploadService=i.uploadService,this.showService=i.showService,this.authService=i.authService,this.dialogService=i.dialogService,this.dispatchService=i.dispatchService},configureOptions:function(e){this.moduleEditInfo=e},getCreateWidget:function(e){var i=t.extend({elem:null,schemaNames:null,allSchemas:!1,label:null,dialogPrompt:null},e);return new r({elem:i.elem,schemaNames:i.schemaNames,allSchemas:i.allSchemas,label:i.label,dialogPrompt:i.dialogPrompt,createDocProcess:this})},createDocumentFromSchema:function(e){var r=this,s=this.authService;if(s&&0==s.isLoggedIn())s.showLoginForm({onSuccess:function(t,i){r.createDocumentFromSchema(e)}});else{var a=t.extend({schema:null,elem:null,relatedDoc:null,originDocId:null,prompt:null,onSuccess:function(e){},onError:t.reportErrorForced,onCancel:function(){}},e);a.schema&&a.schema.isSchema?window.cordova?l():this.uploadService.checkWelcome({onSuccess:l,onError:function(e){alert(i("Upload service can not be reached. Unable to submit a related document."))}}):a.onError(i("A valid schema must be provided"))}function l(){var e=a.schema.createObject();a.relatedDoc&&(e.nunaliit_source={nunaliit_type:"reference",doc:a.relatedDoc._id,category:"attachment"}),a.originDocId&&(e.nunaliit_origin={nunaliit_type:"reference",doc:a.originDocId}),r.dispatchService&&r.dispatchService.synchronousCall(n,{type:"preDocCreation",doc:e,relatedDoc:a.relatedDoc});var t=a.prompt;t||(t=a.originDocId?i("Fill Out Reply"):a.relatedDoc?i("Fill Out Related Document"):i("Fill out content of new document")),new o({documentSource:r.documentSource,uploadService:r.uploadService,showService:r.showService,dialogService:r.dialogService,obj:e,schema:a.schema,prompt:t,elem:a.elem,onSuccess:a.onSuccess,onError:a.onError,onCancel:a.onCancel,moduleEditInfo:r.moduleEditInfo})}},createDocumentFromSchemaNames:function(e){var i=this,n=this.authService;if(n&&0==n.isLoggedIn())n.showLoginForm({onSuccess:function(t,n){i.createDocumentFromSchemaNames(e)}});else{var r=t.extend({schemaNames:[],allSchemas:!1,relatedDoc:null,originDocId:null,prompt:null,onSuccess:function(e){},onError:t.reportErrorForced,onCancel:function(){}},e);r.allSchemas?this.dialogService.selectSchema({onSelected:o,onError:r.onError,onReset:r.onCancel}):this.dialogService.selectSchemaFromNames({schemaNames:r.schemaNames,onSelected:o,onError:r.onError,onReset:r.onCancel})}function o(e){i.createDocumentFromSchema({schema:e,relatedDoc:r.relatedDoc,originDocId:r.originDocId,prompt:r.prompt,onSuccess:r.onSuccess,onError:r.onError,onCancel:r.onCancel})}},replyToDocument:function(e){var n=this,r=this.authService;if(r&&0==r.isLoggedIn())r.showLoginForm({onSuccess:function(t,i){n.replyToDocument(e)}});else{var o=t.extend({doc:null,elem:null,schema:null,originDocId:null,onSuccess:function(e){},onError:t.reportErrorForced,onCancel:function(){}},e);if(o.schema&&o.schema.isSchema){var s=null;o.originDocId?s=o.originDocId:o.doc.nunaliit_origin&&o.doc.nunaliit_origin.doc?s=o.doc.nunaliit_origin.doc:o.doc.nunaliit_source&&o.doc.nunaliit_source.doc&&(s=o.doc.nunaliit_source.doc),this.createDocumentFromSchema({schema:o.schema,elem:o.elem,relatedDoc:o.doc,originDocId:s,onSuccess:o.onSuccess,onError:o.onError,onCancel:o.onCancel})}else o.onError(i("A valid schema must be provided"))}},insertAddRelatedSelection:function(n){var r=t.extend({placeHolderElem:null,doc:null,onElementCreated:function(e){},onRelatedDocumentCreated:function(e){}},n),o=this,s=e(r.placeHolderElem),a=r.doc,l=a.nunaliit_schema;function c(t){if(t.length<1)d();else{var n=e("<select>");e("<option>").text(i("Add Related Item")).val("").appendTo(n);for(var l=0,c=t.length;l<c;++l){var u=t[l];e("<option>").text(u.getLabel()).val(u.name).appendTo(n)}n.insertBefore(s).change(function(){var t=e(this).val();return e(this).val(""),t&&t.length>0&&o.createDocumentFromSchemaNames({schemaNames:[t],relatedDoc:a,onSuccess:r.onRelatedDocumentCreated}),!1}),s.remove(),r.onElementCreated(n)}}function d(){s.remove()}l?this.schemaRepository.getSchema({name:l,onSuccess:function(e){e.relatedSchemaNames&&e.relatedSchemaNames.length>0?o.schemaRepository.getSchemas({names:e.relatedSchemaNames,onSuccess:c,onError:d}):d()},onError:d}):d()}});t.couchRelatedDoc={CreateRelatedDocProcess:s}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchDisplay";function r(e,t){return e.substr(0,t.length)===t}function o(e,t,i){var n=!1;(t[e]&&(n=!0),i&&!n)&&(i.getOption(e)&&(n=!0));return n}var s=t.Class({options:null,documentSource:null,displayPanelName:null,currentFeature:null,createRelatedDocProcess:null,defaultSchema:null,displayRelatedInfoProcess:null,displayOnlyRelatedSchemas:null,displayBriefInRelatedInfo:null,restrictAddRelatedButtonToLoggedIn:null,restrictReplyButtonToLoggedIn:null,classDisplayFunctions:null,showService:null,uploadService:null,customService:null,authService:null,requestService:null,dispatchService:null,schemaRepository:null,initialize:function(i){var r=this,s=t.extend({documentSource:null,displayPanelName:null,showService:null,uploadService:null,createDocProcess:null,serviceDirectory:null,displayRelatedInfoFunction:null,displayRelatedInfoProcess:null,classDisplayFunctions:{},displayOnlyRelatedSchemas:!1,displayBriefInRelatedInfo:!1,restrictAddRelatedButtonToLoggedIn:!1,restrictReplyButtonToLoggedIn:!1},i);this.documentSource=s.documentSource,this.displayPanelName=s.displayPanelName,this.uploadService=s.uploadService,this.classDisplayFunctions=s.classDisplayFunctions,this.createRelatedDocProcess=s.createDocProcess,s.serviceDirectory&&(this.showService=s.serviceDirectory.showService,this.customService=s.serviceDirectory.customService,this.authService=s.serviceDirectory.authService,this.requestService=s.serviceDirectory.requestService,this.schemaRepository=s.serviceDirectory.schemaRepository,this.dispatchService=s.serviceDirectory.dispatchService),this.showService||(this.showService=s.showService),this.displayOnlyRelatedSchemas=o("displayOnlyRelatedSchemas",s,this.customService),this.displayBriefInRelatedInfo=o("displayBriefInRelatedInfo",s,this.customService),this.restrictAddRelatedButtonToLoggedIn=o("restrictAddRelatedButtonToLoggedIn",s,this.customService),this.restrictReplyButtonToLoggedIn=o("restrictReplyButtonToLoggedIn",s,this.customService);var l=this.customService,u=this.dispatchService;if(u){var h=function(e,t,i){r._handleDispatch(e,t,i)};u.register(n,"selected",h),u.register(n,"searchResults",h),u.register(n,"documentDeleted",h),u.register(n,"authLoggedIn",h),u.register(n,"authLoggedOut",h),u.register(n,"editClosed",h),u.register(n,"documentContentCreated",h),u.register(n,"documentContentUpdated",h)}if(this.requestService&&this.requestService.addDocumentListener(function(e){r._refreshDocument(e),r._populateWaitingDocument(e)}),s.displayRelatedInfoProcess&&(this.displayRelatedInfoProcess=s.displayRelatedInfoProcess),!this.displayRelatedInfoProcess&&s.displayRelatedInfoFunction&&(this.displayRelatedInfoProcess=new a(s.displayRelatedInfoFunction)),!this.displayRelatedInfoProcess&&l){var p=l.getOption("displayRelatedInfoProcess");p&&(this.displayRelatedInfoProcess=p)}if(!this.displayRelatedInfoProcess&&l){var f=l.getOption("displayRelatedInfoFunction");"function"==typeof f&&(this.displayRelatedInfoProcess=new a(f))}this.displayRelatedInfoProcess||(this.displayOnlyRelatedSchemas?this.displayRelatedInfoProcess=new a(c):this.displayRelatedInfoProcess=new a(d)),e("body").addClass("n2_display_format_classic"),t.log("ClassicDisplay",this)},setSchema:function(e){this.defaultSchema=e},_displayDocument:function(e,t){var i=this;e.empty(),this._displayObject(e,t,{onUpdated:function(){i._displayDocument(e,t)},onDeleted:function(){e.empty()}})},_shouldSuppressNonApprovedMedia:function(){return this.showService.eliminateNonApprovedMedia},_shouldSuppressDeniedMedia:function(){return this.showService.eliminateDeniedMedia},_getDisplayDiv:function(){var t=this.displayPanelName;return e("#"+t)},_displayObject:function(i,n,r){var o=this,s=t.extend({onUpdated:function(){},onDeleted:function(){},suppressContributionReferences:!1,showContributionReplyButton:!1,showAddContributionButton:!1,showRelatedContributions:!1},r),a=n._id,l=e('<div class="couchDisplay_'+t.utils.stringToHtmlId(a)+'"></div>');i.append(l);var c=e('<div class="n2s_handleHover"></div>');if(l.append(c),this.showService.displayDocument(c,{onDisplayed:function(e,t,i,n){if(o.classDisplayFunctions)for(var r in o.classDisplayFunctions){var a=o.classDisplayFunctions[r],l=h(r,a,t,s);e.find("."+r).each(l)}}},n),n.nunaliit_schema){var d=o.schemaRepository;d?d.getSchema({name:n.nunaliit_schema,onSuccess:function(e){u(e)},onError:function(){u(null)}}):u(null)}else u(null);function u(i){o._addAttachmentProgress(l,n),o._addButtons(l,n,{schema:i,related:!0,reply:!0,geom:!0,edit:!0,delete:!0,addLayer:!0,treeView:!0,simplifiedGeoms:!0});var r=e("<div>").addClass("n2Display_relatedInfo couchDisplayRelated_"+t.utils.stringToHtmlId(n._id)).appendTo(l),s=t.utils.getElementIdentifier(r);o.displayRelatedInfoProcess.display({divId:s,display:o,doc:n,schema:i})}function h(t,i,n,r){return function(){var o=e(this);i(n,o,r),o.removeClass(t)}}},_addButtons:function(i,n,r){var o=t.extend({schema:null,focus:!1,related:!1,reply:!1,geom:!1,edit:!1,delete:!1,addLayer:!1,treeView:!1,simplifiedGeoms:!1},r),s=e("<div></div>");s.addClass("n2Display_buttons"),s.addClass("n2Display_buttons_"+t.utils.stringToHtmlId(n._id)),i.append(s);var a="options";o.focus&&(a+="_focus"),o.edit&&(a+="_edit"),o.related&&(a+="_related"),o.reply&&(a+="_reply"),o.geom&&(a+="_geom"),o.delete&&(a+="_delete"),o.addLayer&&(a+="_addLayer"),o.treeView&&(a+="_treeView"),o.simplifiedGeoms&&(a+="_simplifiedGeoms"),s.addClass(a);var l={doc:n,schema:o.schema,focus:o.focus,edit:o.edit,related:o.related,reply:o.reply,geom:o.geom,addLayer:o.addLayer,treeView:o.treeView,simplifiedGeoms:o.simplifiedGeoms};l.delete=o.delete,this._displayButtons(s,l)},_refreshButtons:function(e){for(var i=this,n=null,o=!1,s=!1,a=!1,l=!1,c=!1,d=!1,u=!1,h=!1,p=!1,f=e.attr("class").split(" "),m=0,v=f.length;m<v;++m){var g=f[m];if(r(g,"n2Display_buttons_")){var y=g.substr("n2Display_buttons_".length);n=t.utils.unescapeHtmlId(y)}else if(r(g,"options"))for(var _=g.split("_"),S=0,b=_.length;S<b;++S){var I=_[S];"focus"===I?o=!0:"edit"===I?s=!0:"related"===I?a=!0:"reply"===I?l=!0:"geom"===I?c=!0:"addLayer"===I?u=!0:"treeView"===I?h=!0:"simplifiedGeoms"===I?p=!0:"delete"===I&&(d=!0)}}function C(t,n){var r={doc:t,schema:n,focus:o,edit:s,related:a,reply:l,geom:c,addLayer:u,treeView:h,simplifiedGeoms:p};r.delete=d,e.empty(),i._displayButtons(e,r)}n&&this.documentSource.getDocument({docId:n,onSuccess:function(e){if(e.nunaliit_schema){var t=i.schemaRepository;t?t.getSchema({name:e.nunaliit_schema,onSuccess:function(t){C(e,t)},onError:function(){C(e,null)}}):C(e,null)}else C(e,null)},onError:function(){}})},_displayButtons:function(e,r){var o=this,s=r.doc,a=(r.schema,new h),l=this.dispatchService;o.schemaRepository;if(r.focus&&s&&s._id&&a.drawButton({elem:e,name:"more_info",label:i("More Info"),click:function(){o._dispatch({type:"userSelect",docId:s._id})}}),r.edit&&t.couchMap.canEditDoc(s)&&a.drawButton({elem:e,name:"edit",label:i("Edit"),click:function(){o._performDocumentEdit(s,r)}}),r.delete&&t.couchMap.canDeleteDoc(s)&&a.drawButton({elem:e,name:"delete",label:i("Delete"),click:function(){o._performDocumentDelete(s,r)}}),r.related&&this.displayRelatedInfoProcess&&this.displayRelatedInfoProcess.addButton({display:this,div:e[0],doc:s,schema:r.schema,buttonDisplay:a}),r.reply&&r.schema&&r.schema.options&&r.schema.options.enableReplies){var c=!0;if(this.restrictReplyButtonToLoggedIn){var d={type:"authIsLoggedIn",isLoggedIn:!1};l&&l.synchronousCall(n,d),d.isLoggedIn||(c=!1)}c&&a.drawButton({elem:e,name:"reply",label:i("Reply"),click:function(){o._replyToDocument(s,r.schema)}})}if(s){var u=a.drawButton({elem:e,name:"find_on_map",label:i("Find on Map"),click:function(){o._dispatch({type:"find",docId:s._id,doc:s})}});this.showService.showFindAvailable({elem:u,doc:s})}r.addLayer&&s&&s.nunaliit_layer_definition&&l&&l.isEventTypeRegistered("addLayerToMap")&&a.drawButton({elem:e,name:"add_layer",label:i("Add Layer"),click:function(){var e=s.nunaliit_layer_definition,t=e.id;t||(t=s._id);var i={name:e.name,type:"couchdb",options:{layerName:t,documentSource:o.documentSource}};o._dispatch({type:"addLayerToMap",layer:i,options:{setExtent:{bounds:e.bbox,crs:"EPSG:4326"}}})}}),r.treeView&&s&&a.drawButton({elem:e,name:"tree_view",label:i("Tree View"),click:function(){o._performDocumentTreeView(s)}}),r.simplifiedGeoms&&s&&s.nunaliit_geom&&a.drawButton({elem:e,name:"simplified_geoms",label:i("Geometries"),click:function(){o._performSimplifiedGeometries(s)}})},_addAttachmentProgress:function(i,n){var r=e("<div></div>").addClass("n2Display_attProgress").addClass("n2Display_attProgress_"+t.utils.stringToHtmlId(n._id)).appendTo(i);this._refreshAttachmentProgress(r,n)},_refreshAttachmentProgress:function(t,n){var r=null;if(t.empty(),window.cordova&&n.nunaliit_mobile_attachments){var o=n.nunaliit_mobile_attachments.lastIndexOf("/"),s=n.nunaliit_mobile_attachments.substring(o+1);e("<p>1 mobile attachment: "+s+"</p>").appendTo(t),window.resolveLocalFileSystemURL("file:"+n.nunaliit_mobile_attachments,function(r){r.file(function(r){if(r&&r.type)if(r.type.startsWith("image"))e("<img>",{src:n.nunaliit_mobile_attachments}).addClass("n2Display_cordovaImgAttachmentPreview").on("error",function(){e(this).hide()}).appendTo(t);else e("<label>").addClass("cordova-btn cordova-preview-button icon-preview width-100").appendTo(t).text(i("Preview")).click(function(e){e.preventDefault(),window.cordova.plugins.fileOpener2.open(n.nunaliit_mobile_attachments,r.type,{error:function(e){console.error("Error opening file",r)},success:function(){console.log("Opening file",r)}})})})})}if(n.nunaliit_attachments&&n.nunaliit_attachments.files)for(var a in n.nunaliit_attachments.files){var l=n.nunaliit_attachments.files[a];l.source||l.status&&"attached"!==l.status&&(r||(r={}),r[l.status]=!0)}if(r){var c=e("<div></div>").addClass("n2Display_attProgress_outer").appendTo(t);e("<div></div>").addClass("n2Display_attProgress_icon").appendTo(c),r["waiting for approval"]?(c.addClass("n2Display_attProgress_waiting"),e("<div></div>").addClass("n2Display_attProgress_message").text(i("Attachment is waiting for approval")).appendTo(c)):r.denied?(c.addClass("n2Display_attProgress_denied"),e("<div></div>").addClass("n2Display_attProgress_message").text(i("Attachment has been denied")).appendTo(c)):(c.addClass("n2Display_attProgress_busy"),e("<div></div>").addClass("n2Display_attProgress_message").text(i("Attachment is being processed")).appendTo(c)),e("<div></div>").addClass("n2Display_attProgress_outer_end").appendTo(c)}},_getAllReferences:function(e){var i=t.extend({doc:null,onSuccess:function(e){},onError:function(e){}},e),n=this,r=i.doc,o={},s=[];t.couchUtils.extractLinks(r,s);for(var a=0,l=s.length;a<l;++a){var c=s[a].doc;o[c]||(o[c]={}),o[c].forward=!0}function d(){var e=[];for(var t in o)e.push(t);e.length>0?n.documentSource.getDocumentInfoFromIds({docIds:e,onSuccess:function(e){for(var t=0,n=e.length;t<n;++t){var r=e[t].id;o[r].exists=!0,e[t].schema&&(o[r].schema=e[t].schema)}i.onSuccess(o)},onError:i.onError}):i.onSuccess(o)}this.documentSource.getReferencesFromId({docId:r._id,onSuccess:function(e){for(var t=0,i=e.length;t<i;++t){var n=e[t];o[n]||(o[n]={}),o[n].reverse=!0}d()},onError:d})},_replyToDocument:function(e,t){this.createRelatedDocProcess.replyToDocument({doc:e,schema:t,onSuccess:function(e){}})},_refreshDocument:function(i){var n=this,r=this.schemaRepository;function o(i,r){var o=i._id;e(".n2Display_buttons_"+t.utils.stringToHtmlId(o)).each(function(){var t=e(this);n._refreshButtons(t)}),e(".displayRelatedButton_"+t.utils.stringToHtmlId(o)).each(function(){var t=e(this);t.empty(),n._addButtons(t,i,{schema:r,focus:!0,geom:!0,reply:!0,treeView:!0,simplifiedGeoms:!0})}),e(".n2Display_attProgress_"+t.utils.stringToHtmlId(o)).each(function(){var t=e(this);n._refreshAttachmentProgress(t,i)}),n._shouldSuppressNonApprovedMedia()?t.couchMap.documentContainsMedia(i)&&0==t.couchMap.documentContainsApprovedMedia(i)&&e(".n2SupressNonApprovedMedia_"+t.utils.stringToHtmlId(o)).each(function(){var t=e(this),i=t.parent();t.remove(),n._fixDocumentList(i)}):n._shouldSuppressDeniedMedia()&&t.couchMap.documentContainsMedia(i)&&t.couchMap.documentContainsDeniedMedia(i)&&e(".n2SupressDeniedMedia_"+t.utils.stringToHtmlId(o)).each(function(){var t=e(this),i=t.parent();t.remove(),n._fixDocumentList(i)})}i.nunaliit_schema&&r?r.getSchema({name:i.nunaliit_schema,onSuccess:function(e){o(i,e)},onError:function(){o(i,null)}}):o(i,null)},_populateWaitingDocument:function(i){var n=this;if(i){var r=i._id,o=t.utils.stringToHtmlId(r),s="couchDisplayWait_"+o;e("."+s).each(function(){var t=e(this);t.removeClass(s).addClass("couchDisplayAdded_"+o),n._displayDocument(t,i)})}},_fixDocumentList:function(t){if(t.hasClass("_n2DocumentListParent"))var i=t;else i=t.parents("._n2DocumentListParent");if(i.length>0){var n=i.find("._n2DocumentListEntry"),r=n.length;i.find("._n2DisplayDocCount").text(""+r),n.each(function(t){var i=e(this);i.removeClass("olkitSearchMod2_0"),i.removeClass("olkitSearchMod2_1"),i.addClass("olkitSearchMod2_"+t%2)})}},_performDocumentEdit:function(e,i){var n=this;this.documentSource.getDocument({docId:e._id,onSuccess:function(e){n._dispatch({type:"editInitiate",doc:e})},onError:function(e){t.log("Unable to load document: "+e)}})},_performDocumentDelete:function(e,t){confirm(i("You are about to delete this document. Do you want to proceed?"))&&this.documentSource.deleteDocument({doc:e,onSuccess:function(){t.onDeleted&&t.onDeleted()}})},_performDocumentTreeView:function(e){new p({doc:e})},_performSimplifiedGeometries:function(n){var r=t.getUniqueId();if(n&&n.nunaliit_geom&&n.nunaliit_geom.wkt){var o=[];if(o.push({label:i("Inline"),wkt:n.nunaliit_geom.wkt}),n.nunaliit_geom.simplified&&n.nunaliit_geom.simplified.reported_resolution&&(o[0].resolution=n.nunaliit_geom.simplified.reported_resolution),n.nunaliit_geom.simplified){var s=n.nunaliit_geom.simplified;if(s.original){var a=this.documentSource.getDocumentAttachmentUrl(n,s.original);o.push({label:i("Original"),url:a,attName:s.original})}if(s.resolutions){var l=[];for(var c in s.resolutions){var d=s.resolutions[c];a=this.documentSource.getDocumentAttachmentUrl(n,c);l.push({label:i("Resolution"),url:a,attName:c,resolution:d})}l.sort(function(e,t){return e.resolution<t.resolution?-1:e.resolution>t.resolution?1:0});for(var u=0,h=l.length;u<h;++u)o.push(l[u])}}var p=e("<div>").attr("id",r);m(p),p.dialog({autoOpen:!0,title:i("Geometries"),modal:!0,width:600,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}});for(u=0,h=o.length;u<h;++u){var f=o[u];f.url&&f.attName&&v(f.attName,f.url)}}function m(t){t||(t=e("#"+r)),t.empty();for(var i=0,n=o.length;i<n;++i){var s=o[i],a=s.label;if(s.resolution&&(a+=" - "+s.resolution),s.attName&&(a+=" - "+s.attName),e("<div>").addClass("n2display_geometries_heading").text(a).appendTo(t),s.wkt){var l=s.wkt+" ["+s.wkt.length+"]";e("<div>").addClass("n2display_geometries_wkt").text(l).appendTo(t)}}}function v(t,i){e.ajax({url:i,dataType:"text",success:function(e){for(var i=0,n=o.length;i<n;++i){var r=o[i];r.attName===t&&(r.wkt=e)}m()}})}},_displayDocumentId:function(n,r){var o=this;n.empty(),this.documentSource.getDocument({docId:r,onSuccess:function(e){o._displayDocument(n,e)},onError:function(o){n.empty(),e("<div>").addClass("couchDisplayWait_"+t.utils.stringToHtmlId(r)).text(i("Unable to retrieve document")).appendTo(n)}})},_handleDispatch:function(t,i,n){var r=this,o=this._getDisplayDiv();if(o.length<1)n.deregister(i);else if("selected"===t.type)t.doc?this._displayDocument(o,t.doc):t.docId?this._displayDocumentId(o,t.docId):t.docs?this._displayMultipleDocuments(o,t.docs):t.docIds&&(o.empty(),this._displayMultipleDocumentIds(o,t.docIds));else if("searchResults"===t.type)this._displaySearchResults(t.results);else if("documentDeleted"===t.type){var s=t.docId;this._handleDocumentDeletion(s)}else if("authLoggedIn"===t.type||"authLoggedOut"===t.type)e(".n2Display_buttons").each(function(){var t=e(this);r._refreshButtons(t)});else if("editClosed"===t.type){if(!t.deleted){var a=t.doc;a&&this._displayDocument(o,a)}}else"documentContentCreated"===t.type?(this._handleDocumentCreation(t.doc),this._populateWaitingDocument(t.doc)):"documentContentUpdated"===t.type&&(this._refreshDocument(t.doc),this._populateWaitingDocument(t.doc))},_displayMultipleDocuments:function(i,n){var r=e('<div class="_n2DocumentListParent"></div>');i.empty().append(r);for(var o=0,s=n.length;o<s;++o){var a=n[o],l=a._id,c=e("<div></div>").addClass("_n2DocumentListEntry").addClass("_n2DocumentListEntry_"+t.utils.stringToHtmlId(l)).addClass("olkitSearchMod2_"+o%2).addClass("n2SupressNonApprovedMedia_"+t.utils.stringToHtmlId(l)).addClass("n2SupressDeniedMedia_"+t.utils.stringToHtmlId(l));r.append(c);var d=e('<div class="n2s_handleHover"></div>');c.append(d),this.showService.displayBriefDescription(d,{},a);var u=e("<div></div>");c.append(u),this._addButtons(u,a,{focus:!0,geom:!0})}},_displayMultipleDocumentIds:function(i,n){var r=e('<div class="_n2DocumentListParent"></div>');i.empty().append(r);for(var o=0,s=n.length;o<s;++o){var a=n[o],l=e("<div></div>").addClass("_n2DocumentListEntry").addClass("_n2DocumentListEntry_"+t.utils.stringToHtmlId(a)).addClass("olkitSearchMod2_"+o%2).addClass("n2SupressNonApprovedMedia_"+t.utils.stringToHtmlId(a)).addClass("n2SupressDeniedMedia_"+t.utils.stringToHtmlId(a));r.append(l);var c=e('<div class="n2s_handleHover"></div>');if(l.append(c),this.showService.printBriefDescription(c,a),this.requestService){var d=e('<div class="n2Display_attProgress n2Display_attProgress_'+t.utils.stringToHtmlId(a)+'"></div>');l.append(d);var u=e('<div class="displayRelatedButton displayRelatedButton_'+t.utils.stringToHtmlId(a)+'"></div>');l.append(u),this.requestService.requestDocument(a)}}},_displaySearchResults:function(t){var n=[];if(t&&t.sorted&&t.sorted.length)for(var r=0,o=t.sorted.length;r<o;++r)n.push(t.sorted[r].id);var s=this._getDisplayDiv();if(s.empty(),n.length<1)s.append(e("<div>"+i("Search results empty")+"</div>"));else{var a=e('<div class="n2_search_result"></div>').appendTo(s);this._displayMultipleDocumentIds(a,n)}},_dispatch:function(e){var t=this.dispatchService;t&&t.send(n,e)},_handleDocumentDeletion:function(i){var n=this;e(".couchDisplay_"+t.utils.stringToHtmlId(i)).remove(),e(".couchDisplayWait_"+t.utils.stringToHtmlId(i)).remove(),e("._n2DocumentListEntry_"+t.utils.stringToHtmlId(i)).each(function(){var t=e(this),i=t.parent();t.remove(),n._fixDocumentList(i)})},_handleDocumentCreation:function(i){var n=this,r=[];t.couchUtils.extractLinks(i,r);for(var o=0,s=r.length;o<s;++o){var a=r[o].doc;if(a){var l=e(".couchDisplayRelated_"+t.utils.stringToHtmlId(a));l.length>0&&c(a,l)}}function c(e,t){var i=n.requestService;i&&i.requestDocument(e,function(e){!function(e,t){var i=e.nunaliit_schema?e.nunaliit_schema:null,r=n.schemaRepository;i&&r?r.getSchema({name:i,onSuccess:function(i){d(e,i,t)},onError:function(){d(e,null,t)}}):d(e,null,t)}(e,t)})}function d(t,i,r){r.each(function(){var r=e(this);r.empty(),n.displayRelatedInfoProcess.display({div:r,display:n,doc:t,schema:i})})}}}),a=t.Class({legacyFunction:null,initialize:function(e){this.legacyFunction=e},display:function(e){return this.legacyFunction(e)},addButton:function(i){var n=t.extend({display:null,div:null,doc:null,schema:null},i),r=n.display,o=n.doc,s=e(n.div),a=r.createRelatedDocProcess,l=e("<span>").appendTo(s);a.insertAddRelatedSelection({placeHolderElem:l,doc:o,onElementCreated:function(e){e.addClass("nunaliit_form_link"),e.addClass("nunaliit_form_link_add_related_item"),e.menuselector()},onRelatedDocumentCreated:function(e){}})}});function l(n,r,o,s){var a=e("#"+r);if(!s||s.length<1)a.remove();else{var l=t.getUniqueId(),c=e('<div id="'+l+'" class="_n2DocumentListParent"><h3></h3><div style="padding-left:0px;padding-right:0px;"></div></div>');a.append(c),t.blindWidget(c,{data:s,onBeforeOpen:function(i){var r=i.content;if(r.find(".___n2DataLoaded").length>0)return;var o=i.data;r.empty(),r.append(e('<div class="___n2DataLoaded" style="display:none;"></div>'));for(var s=0,a=o.length;s<a;++s){var l=o[s],c=e("<div></div>");r.append(c),0===s&&c.addClass("_n2DocumentListStart"),a-1===s&&c.addClass("_n2DocumentListEnd"),c.addClass("_n2DocumentListEntry").addClass("_n2DocumentListEntry_"+t.utils.stringToHtmlId(l)).addClass("olkitSearchMod2_"+s%2).addClass("n2SupressNonApprovedMedia_"+t.utils.stringToHtmlId(l)).addClass("n2SupressDeniedMedia_"+t.utils.stringToHtmlId(l));var d=e("<div>").addClass("n2s_handleHover").appendTo(c);if(n.showService?n.displayBriefInRelatedInfo?n.showService.printBriefDescription(d,l):n.showService.printDocument(d,l):d.text(l),n.requestService){var u=e('<div class="n2Display_attProgress n2Display_attProgress_'+t.utils.stringToHtmlId(l)+'"></div>');c.append(u);var h=e('<div class="displayRelatedButton displayRelatedButton_'+t.utils.stringToHtmlId(l)+'"></div>');c.append(h),n.requestService.requestDocument(l)}}}}).setHtml('<span class="_n2DisplaySchemaName"></span> (<span class="_n2DisplayDocCount"></span>)'),null==o?c.find("._n2DisplaySchemaName").text(i("Uncategorized")):c.find("._n2DisplaySchemaName").text(o),c.find("._n2DisplayDocCount").text(""+s.length);var d=n.schemaRepository;d&&o&&d.getSchema({name:o,onSuccess:function(t){e("#"+l).find("._n2DisplaySchemaName").text(i(t.getLabel()))}})}}function c(i){var n=t.extend({divId:null,div:null,display:null,doc:null,schema:null},i),r=n.doc,o=(r._id,n.display),s=n.schema,a=n.div;if(a||(a=e("#"+n.divId)),a.length&&s&&s.relatedSchemaNames&&s.relatedSchemaNames.length){for(var c={},d=0,u=s.relatedSchemaNames.length;d<u;++d){var h=s.relatedSchemaNames[d];c[h]={docIds:[]}}o._getAllReferences({doc:r,onSuccess:function(i){for(var n in i)if(i[n].exists&&i[n].reverse&&i[n].schema){var r=i[n].schema,s=c[r];s&&s.docIds.push(n)}for(var r in c){var s=c[r];if(s.docIds.length>0){var d=t.getUniqueId(),u=e('<div id="'+d+'"></div>');a.append(u);var h=s.docIds;l(o,d,r,h)}}}})}}function d(i){var n=t.extend({divId:null,div:null,display:null,doc:null,schema:null},i),r=n.display,o=n.doc,s=(o._id,n.div);s||(s=e("#"+n.divId)),s.length&&r._getAllReferences({doc:o,onSuccess:function(i){var n={},o=[];for(var a in i)if(i[a].exists){var c=i[a].schema;c?(n[c]||(n[c]={docIds:[]}),n[c].docIds.push(a)):o.push(a)}for(var c in n){var d=t.getUniqueId(),u=e('<div id="'+d+'"></div>');s.append(u);var h=n[c].docIds;l(r,d,c,h)}if(o.length>0){var d=t.getUniqueId(),u=e('<div id="'+d+'"></div>');s.append(u),l(r,d,null,o)}}})}var u=t.Class({commentSchema:null,dispatchService:null,commentService:null,initialize:function(e){var i=t.extend({schema:null,dispatchService:null},e);if(this.commentSchema=i.schema,this.dispatchService=i.dispatchService,this.dispatchService){var r={type:"configurationGetCurrentSettings"};this.dispatchService.synchronousCall(n,r),r.configuration&&r.configuration.directory&&(this.commentService=r.configuration.directory.commentService)}},display:function(e){t.extend({divId:null,div:null,doc:null},e);if(this.commentService){this.commentSchema&&this.commentService.setCommentSchema(this.commentSchema);var i=this.commentService.getCommentStreamDisplay();i&&i.display(e)}else t.log("Comment service not available for comment process")},addButton:function(e){var i=t.extend({display:null,div:null,doc:null,schema:null,buttonDisplay:null},e);this.commentService?this.commentService.insertAddCommentButton({div:i.div,doc:i.doc,buttonDisplay:i.buttonDisplay}):t.log("Comment service not available for comment process")}}),h=t.Class({initialize:function(e){},drawButton:function(i){var n=t.extend({elem:null,name:null,label:null,click:null,className:null,classNames:null},i);if(!n.elem)throw new Error('In ButtonDisplay.drawButton(), parameter "elem" must be provided');var r=e(n.elem),o=n.name,s=n.label;s||(s=o);var a,l=e("<a>").attr("href","#").appendTo(r).addClass("nunaliit_form_link").click((a=n.click,function(){return"function"==typeof a&&a.apply(this,arguments),!1}));if(s&&l.text(s),o){for(var c=o,d=c.indexOf(" ");-1!==d;)d=(c=c.slice(0,d)+"_"+c.slice(d+1)).indexOf(" ");l.addClass("nunaliit_form_link_"+c.toLowerCase())}return"string"==typeof n.className&&l.addClass(n.className),t.isArray(n.classNames)&&n.classNames.forEach(function(e){"string"==typeof e&&l.addClass(e)}),l}}),p=t.Class({doc:null,initialize:function(e){var i=t.extend({doc:null},e);for(var n in this.doc={},i.doc)"__n2Source"!==n&&(this.doc[n]=i.doc[n]);this._display()},_display:function(){var n=e("<div>").addClass("n2Display_treeViewer_dialog"),r=t.utils.getElementIdentifier(n),o=e("<div>").addClass("n2Display_treeViewer_content").appendTo(n);new t.tree.ObjectTree(o,this.doc);var s=e("<div>").addClass("n2Display_treeViewer_buttons").appendTo(n);e("<button>").text(i("Close")).appendTo(s).click(function(){return e("#"+r).dialog("close"),!1}),n.dialog({autoOpen:!0,title:i("Tree View"),modal:!0,width:370,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}})}});t.couchDisplay={Display:s,CommentRelatedInfo:u,TreeDocumentViewer:p,HandleDisplayAvailableRequest:function(e){"classic"===e.displayType&&(e.isAvailable=!0)},HandleDisplayRenderRequest:function(e){if("classic"===e.displayType){var t={};if(e.displayOptions)for(var i in e.displayOptions)t[i]=e.displayOptions[i];t.documentSource=e.config.documentSource,t.displayPanelName=e.displayId,t.showService=e.config.directory.showService,t.uploadService=e.config.directory.uploadService,t.createDocProcess=e.config.directory.createDocProcess,t.serviceDirectory=e.config.directory;var n=new s(t),r="object";e.displayOptions&&e.displayOptions.defaultSchemaName&&(r=e.displayOptions.defaultSchemaName),e.config.directory.schemaRepository.getSchema({name:r,onSuccess:function(e){n.setSchema&&n.setSchema(e)}}),e.onSuccess(n)}},ButtonDisplay:h}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchDisplayTiles";var r=t.Class({height:null,tileHeight:null,initialize:function(e,t){this.height=e||0,this.tileHeight=t||150},get:function(e,t){t+=12;var i,n,r,o=Math.ceil(t/e),s=[],a=Math.max(1,Math.ceil(this.height/this.tileHeight));for(s.push(new Tiles.Rectangle(0,0,2,a)),i=1,n=0,r=1;r<t;++r){for(i+=1;i>=e;)i=0,(n+=1)<a&&(i=2);s.push(new Tiles.Rectangle(i,n,1,1))}return new Tiles.Template(s,e,o)}}),o=t.Class({documentSource:null,displayPanelName:null,showService:null,requestService:null,schemaRepository:null,customService:null,dispatchService:null,boolOptions:null,restrictAddRelatedButtonToLoggedIn:null,currentDetails:null,displayedDocumentsOrder:null,displayedDocuments:null,grid:null,createDocProcess:null,defaultSchema:null,relatedDocumentDiscoveryProcess:null,documentInfoFunction:null,sortFunction:null,filterFactory:null,filter:null,hoverInFn:null,hoverOutFn:null,hoverDocId:null,initialize:function(i){var r=t.extend({documentSource:null,displayPanelName:null,showService:null,requestService:null,schemaRepository:null,customService:null,dispatchService:null,createDocProcess:null,displayRelatedInfoFunction:null,displayOnlyRelatedSchemas:!1,displayBriefInRelatedInfo:!1,restrictAddRelatedButtonToLoggedIn:!1,relatedDocumentDiscoveryProcess:null,documentInfoFunction:null,sortFunction:null,filterFactory:null},i),o=this;this.currentDetails={},this.displayedDocuments={},this.displayedDocumentsOrder=null,this.documentSource=r.documentSource,this.displayPanelName=r.displayPanelName,this.showService=r.showService,this.requestService=r.requestService,this.schemaRepository=r.schemaRepository,this.customService=r.customService,this.dispatchService=r.dispatchService,this.createDocProcess=r.createDocProcess,this._getDisplayDiv(),this.boolOptions={displayOnlyRelatedSchemas:r.displayOnlyRelatedSchemas,displayBriefInRelatedInfo:r.displayBriefInRelatedInfo},this.restrictAddRelatedButtonToLoggedIn=r.restrictAddRelatedButtonToLoggedIn,!this.restrictAddRelatedButtonToLoggedIn&&this.customService&&(this.restrictAddRelatedButtonToLoggedIn=this.customService.getOption("restrictAddRelatedButtonToLoggedIn",!1));var s=this.dispatchService;if(s){var c=function(e,t,i){o._handleDispatch(e,t,i)};s.register(n,"selected",c),s.register(n,"searchResults",c),s.register(n,"documentDeleted",c),s.register(n,"authLoggedIn",c),s.register(n,"authLoggedOut",c),s.register(n,"editClosed",c),s.register(n,"documentContent",c),s.register(n,"documentContentCreated",c),s.register(n,"documentContentUpdated",c)}if(!r.displayRelatedInfoFunction){var d=this._getBooleanOption("displayOnlyRelatedSchemas");r.displayRelatedInfoFunction=d?function(e){o._displayRelatedInfo(e)}:function(e){o._displayLinkedInfo(e)}}if(this.relatedDocumentDiscoveryProcess=r.relatedDocumentDiscoveryProcess,!this.relatedDocumentDiscoveryProcess&&this.customService&&(this.relatedDocumentDiscoveryProcess=this.customService.getOption("relatedDocumentDiscoveryProcess",null)),this.relatedDocumentDiscoveryProcess||(this.relatedDocumentDiscoveryProcess=new l({documentSource:this.documentSource})),this.documentInfoFunction=r.documentInfoFunction,!this.documentInfoFunction&&this.customService){var u=this.customService.getOption("displayDocumentInfoFunction");"function"==typeof u&&(this.documentInfoFunction=u)}if(this.documentInfoFunction||(this.documentInfoFunction=function(e){var i=t.extend({docIds:null,display:null,onSuccess:function(e){},onError:function(e){}},e);i.display.documentSource.getDocumentInfoFromIds({docIds:i.docIds,onSuccess:i.onSuccess,onError:i.onError})}),this.sortFunction=r.sortFunction,!this.sortFunction&&this.customService){var h=this.customService.getOption("displaySortFunction");"function"==typeof h&&(this.sortFunction=h)}if(this.sortFunction||(this.sortFunction=function(e){e.sort(function(e,t){if(e.updatedTime&&t.updatedTime){if(e.updatedTime>t.updatedTime)return-1;if(e.updatedTime<t.updatedTime)return 1}return e.id>t.id?-1:e.id<t.id?1:0})}),this.filterFactory=r.filterFactory,!this.filterFactory&&this.customService){var p=this.customService.getOption("displayFilterFactory");p&&"function"==typeof p.get&&(this.filterFactory=p)}this.filterFactory||(this.filterFactory=new a({schemaRepository:this.schemaRepository})),this.hoverInFn=function(){var t=e(this).attr("n2DocId");t&&t!==o.hoverDocId&&(o.hoverDocId=t,o._dispatch({type:"userFocusOn",docId:t}))},this.hoverOutFn=function(){var t=e(this).attr("n2DocId");t&&t===o.hoverDocId&&(o.hoverDocId=null,o._dispatch({type:"userFocusOff",docId:t}))};var f=window.setInterval(function(){o._getDisplayDiv().length<0?window.clearInterval(f):o._performIntervalTask()},500);e("body").addClass("n2_display_format_tiled"),t.log("TiledDisplay",this)},setSchema:function(e){this.defaultSchema=e},_handleDispatch:function(e,t,i){if(this._getDisplayDiv().length<1)i.deregister(t);else if("selected"===e.type)if(e.doc)this._displayDocument(e.doc._id,e.doc);else if(e.docId)this._displayDocument(e.docId,null);else if(e.docs){for(var n=[],r=0,o=e.docs.length;r<o;++r)n.push(e.docs[r]._id);this._displayMultipleDocuments(n,e.docs)}else e.docIds&&this._displayMultipleDocuments(e.docIds,null);else if("searchResults"===e.type)this._displaySearchResults(e.results);else if("documentDeleted"===e.type);else if("authLoggedIn"===e.type||"authLoggedOut"===e.type)this.currentDetails&&this.currentDetails.docId&&this.currentDetails.doc&&(this._receiveDocumentContent(this.currentDetails.doc),this._displayDocumentButtons(this.currentDetails.doc,this.currentDetails.schema));else if("editClosed"===e.type){if(!e.deleted){var s=e.doc;s&&this._displayDocument(s._id,s)}}else"documentContent"===e.type?this._receiveDocumentContent(e.doc):"documentContentCreated"===e.type?this._receiveDocumentContent(e.doc):"documentContentUpdated"===e.type&&this._receiveDocumentContent(e.doc)},_displayDocument:function(e,t){(this._reclaimDisplayDiv(),this.currentDetails&&this.currentDetails.docId===e)||(this.currentDetails={docId:e},this._addDisplayedDocument(e,t),this._getDisplayDiv().find(".n2DisplayTiled_info").hide(),this.grid.template=null,this.grid.templateFactory=new r,this._adjustCurrentTile(e),t?this._receiveDocumentContent(t):this._requestDocumentWithId(e))},_displaySearchResults:function(e){this._reclaimDisplayDiv();var t=[];if(e&&e.sorted&&e.sorted.length)for(var n=0,r=e.sorted.length;n<r;++n)t.push(e.sorted[n].id);(this._displayMultipleDocuments(t,null),t.length<1)&&this._getDisplayDiv().find(".n2DisplayTiled_info").text(i("Empty search results")).show()},_displayMultipleDocuments:function(e,t){this._reclaimDisplayDiv(),this._getDisplayDiv().find(".n2DisplayTiled_info").hide(),this.currentDetails={docIds:e,docs:{}},this.grid.template=null,this.grid.templateFactory=Tiles.UniformTemplates,this._adjustCurrentTile(null);var i={};if(t)for(var n=0,r=t.length;n<r;++n){var o=t[n];this.currentDetails.docs[o._id]=o,i[o._id]=o}this._changeDisplayedDocuments(e,i)},_displayDocumentButtons:function(r,o){var s=this;if(r&&r._id&&this.currentDetails.docId===r._id){var a=this._getDisplayDiv().find(".n2DisplayTiled_current_buttons").empty();if(t.couchMap.canEditDoc(r)&&e('<a href="#"></a>').addClass("n2DisplayTiled_current_button n2DisplayTiled_current_button_edit").text(i("Edit")).appendTo(a).click(function(){return s._performDocumentEdit(r),!1}),t.couchMap.canDeleteDoc(r)&&e('<a href="#"></a>').addClass("n2DisplayTiled_current_button n2DisplayTiled_current_button_delete").text(i("Delete")).appendTo(a).click(function(){return s._performDocumentDelete(r),!1}),o&&o.relatedSchemaNames&&o.relatedSchemaNames.length){var l=!0;if(this.restrictAddRelatedButtonToLoggedIn){var c=!1;if(this.dispatchService){var d={type:"authIsLoggedIn",isLoggedIn:!1};this.dispatchService.synchronousCall(n,d),c=d.isLoggedIn}c||(l=!1)}if(l){var u=e("<span>").appendTo(a);this.createDocProcess.insertAddRelatedSelection({placeHolderElem:u,doc:r,onElementCreated:function(e){e.addClass("n2DisplayTiled_current_button n2DisplayTiled_current_button_add_related_item")}})}}var h=e('<a href="#"></a>').addClass("n2DisplayTiled_current_button n2DisplayTiled_current_button_find_on_map").text(i("Find on Map")).appendTo(a).click(function(){return s._dispatch({type:"find",docId:r._id,doc:r}),!1});this.showService.showFindAvailable({elem:h,doc:r}),r&&r.nunaliit_layer_definition&&this.dispatchService&&this.dispatchService.isEventTypeRegistered("addLayerToMap")&&e('<a href="#"></a>').addClass("n2DisplayTiled_current_button n2DisplayTiled_current_button_add_layer").text(i("Add Layer")).appendTo(a).click(function(){return s._performAddLayerToMap(r),!1}),r&&e('<a href="#"></a>').addClass("n2DisplayTiled_current_button n2DisplayTiled_current_button_tree_view").text(i("Tree View")).appendTo(a).click(function(){return s._performTreeView(r),!1})}},_currentDocReferencesUpdated:function(){if(this.currentDetails&&this.currentDetails.doc&&this.currentDetails.referenceDocIds){for(var e={},t=0,i=this.currentDetails.referenceDocIds.length;t<i;++t){e[this.currentDetails.referenceDocIds[t]]=!0}var n=[];for(var r in this.displayedDocuments)r===this.currentDetails.docId||e[r]||n.push(r);for(t=0,i=n.length;t<i;++t)this._removeDisplayedDocument(n[t]);for(var r in e)this._addDisplayedDocument(r);this.displayedDocumentsOrder=null,this._updateDisplayedDocuments()}},_updateDisplayedDocuments:function(){var e=this,i=[];for(var n in this.displayedDocuments)this.displayedDocuments[n].info||i.push(n);function r(){e._getDisplayDiv();var t=null;if(e.displayedDocumentsOrder){for(var i=[],n=0,r=(t=e.displayedDocumentsOrder).length;n<r;++n){var o=t[n];e.displayedDocuments[o]&&e.displayedDocuments[o].info&&i.push(e.displayedDocuments[o].info)}e.filter.display(i,e),t=[];for(n=0,r=(i=e.filter.filter(i,e)).length;n<r;++n){var s=i[n];t.push(s.id)}}else{i=[];for(var o in e.displayedDocuments)e.displayedDocuments[o].info&&i.push(e.displayedDocuments[o].info);e.filter.display(i,e),i=e.filter.filter(i,e),e.sortFunction(i);var a={};t=[],e.currentDetails&&e.currentDetails.docId&&(t.push(e.currentDetails.docId),a[e.currentDetails.docId]=!0);for(n=0,r=i.length;n<r;++n){a[o=i[n].id]||(t.push(o),a[o]=!0)}}e.grid.updateTiles(t),e.grid.isDirty=!0,e.grid.redraw(!0);for(n=0,r=t.length;n<r;++n){o=t[n];e._requestDocumentWithId(o)}}i.length>0?this.documentInfoFunction({docIds:i,display:this,onSuccess:function(t){for(var i=0,n=t.length;i<n;++i){var o=t[i],s=o.id;e.displayedDocuments[s]&&(e.displayedDocuments[s].info=o)}r()},onError:function(e){t.log("Unable to obtain document information",e)}}):r()},_changeDisplayedDocuments:function(e,t){for(var i={},n=0,r=e.length;n<r;++n){i[o=e[n]]=!0}for(var o in this.displayedDocuments)i[o]||this._removeDisplayedDocument(o);for(n=0,r=e.length;n<r;++n){o=e[n];var s=null;t&&t[o]&&(s=t[o]),this._addDisplayedDocument(o,s)}this.displayedDocumentsOrder=e,this._updateDisplayedDocuments()},_addDisplayedDocument:function(e,t){this.displayedDocuments[e]||(this.displayedDocuments[e]={id:e}),t&&(this.displayedDocuments[e].doc=t)},_removeDisplayedDocument:function(e){this.displayedDocuments[e]&&delete this.displayedDocuments[e]},_receiveDocumentContent:function(i){var n=this,r=this._getDisplayDiv(),o=i._id;if(this.displayedDocuments[o]&&(this.displayedDocuments[o].doc=i),i._id===this.currentDetails.docId){var s=!1;this.currentDetails.doc?i._rev!==this.currentDetails.doc._rev&&(this.currentDetails.doc=i,s=!0):(this.currentDetails.doc=i,s=!0),s&&this.relatedDocumentDiscoveryProcess.getRelatedDocumentIds({doc:i,onSuccess:function(e,t){n.currentDetails.docId===e._id&&(n.currentDetails.referenceDocIds=t,n._currentDocReferencesUpdated())},onError:function(e){t.log("Error obtaining reference ids",e)}})}var a="n2DisplayTiled_wait_brief_"+t.utils.stringToHtmlId(o);r.find("."+a).each(function(){var t=e(this);n.showService&&n.showService.displayBriefDescription(t,{},i),t.removeClass(a)});a="n2DisplayTiled_wait_current_"+t.utils.stringToHtmlId(o);var l="n2DisplayTiled_current_buttons_"+t.utils.stringToHtmlId(o);r.find("."+a).each(function(){var t=e(this).empty();e("<div>").addClass("n2DisplayTiled_current_buttons").addClass(l).appendTo(t);var r=e("<div>").appendTo(t);n.showService?n.showService.displayDocument(r,{},i):r.text(i._id),t.removeClass(a)}),e("."+l).each(function(){e(this);n._displayDocumentButtons(i,n.currentDetails.schema)});var c=!1,d=!1,u=!1,h=null,p=null;if(i.nunaliit_attachments&&i.nunaliit_attachments.files)for(var f in i.nunaliit_attachments.files){var m=i.nunaliit_attachments.files[f];m.source||("image"===m.fileClass?c=!0:"audio"===m.fileClass?d=!0:"video"===m.fileClass&&(u=!0),m.thumbnail&&(h=m.thumbnail))}if(i.nunaliit_schema&&(p=i.nunaliit_schema),r.find(".n2DisplayTiled_tile_"+t.utils.stringToHtmlId(o)).each(function(){var i=e(this);i.removeClass("n2DisplayTiled_tile_image n2DisplayTiled_tile_audio n2DisplayTiled_tile_video"),u?i.addClass("n2DisplayTiled_tile_video"):d?i.addClass("n2DisplayTiled_tile_audio"):c&&i.addClass("n2DisplayTiled_tile_image"),p&&i.addClass("n2DisplayTiled_tile_schema_"+t.utils.stringToHtmlId(p))}),h&&(i.nunaliit_attachments.files[h]&&"attached"===i.nunaliit_attachments.files[h].status||(h=null)),h){var v=this.documentSource.getDocumentAttachmentUrl(i,h);v&&r.find(".n2DisplayTiled_wait_thumb_"+t.utils.stringToHtmlId(o)).each(function(){var t=e(this);t.empty(),e("<img>").attr("src",v).appendTo(t)})}function g(e,t){n.currentDetails.docId===e._id&&(t&&!n.currentDetails.schema?(n.currentDetails.schema=t,n._displayDocumentButtons(e,t)):n.currentDetails.schema&&!t?(n.currentDetails.schema=null,n._displayDocumentButtons(e,null)):n.currentDetails.schema&&t&&n.currentDetails.schema.name!==t.name&&(n.currentDetails.schema=t,n._displayDocumentButtons(e,t)))}i.nunaliit_schema&&this.schemaRepository?this.schemaRepository.getSchema({name:i.nunaliit_schema,onSuccess:function(e){g(i,e)},onError:function(e){g(i,null)}}):g(i,null),this.currentDetails.doc&&i._id!==this.currentDetails.docId&&this.relatedDocumentDiscoveryProcess.areDocumentsRelated({selectedDoc:this.currentDetails.doc,relatedDoc:i,onRelated:function(e,t){if(e._id===n.currentDetails.docId){var r=-1;n.currentDetails.referenceDocIds&&(r=n.currentDetails.referenceDocIds.indexOf(i._id)),r<0&&(n.currentDetails.referenceDocIds||(n.currentDetails.referenceDocIds=[]),n.currentDetails.referenceDocIds.push(i._id),n._currentDocReferencesUpdated())}},onNotRelated:function(e,t){if(e._id===n.currentDetails.docId){var r=-1;n.currentDetails.referenceDocIds&&(r=n.currentDetails.referenceDocIds.indexOf(i._id)),r>=0&&(n.currentDetails.referenceDocIds.splice(r,1),n._currentDocReferencesUpdated())}},onError:function(e){t.log("Error in displayTiled. Unable to check relation.",e)}})},_performDocumentEdit:function(e){var i=this;this.documentSource.getDocument({docId:e._id,onSuccess:function(e){i._dispatch({type:"editInitiate",doc:e})},onError:function(e){t.log("Unable to load document: "+e)}})},_performDocumentDelete:function(e){confirm(i("You are about to delete this document. Do you want to proceed?"))&&this.documentSource.deleteDocument({doc:e,onSuccess:function(){}})},_performAddLayerToMap:function(e){var t=e.nunaliit_layer_definition,i=t.id;i||(i=e._id);var n={name:t.name,type:"couchdb",options:{layerName:i,documentSource:this.documentSource}};this._dispatch({type:"addLayerToMap",layer:n,options:{setExtent:{bounds:t.bbox,crs:"EPSG:4326"}}})},_performTreeView:function(e){new t.couchDisplay.TreeDocumentViewer({doc:e})},_reclaimDisplayDiv:function(){var i=this,n=this._getDisplayDiv(),r=n.find(".n2DisplayTiled_filters"),o=n.find(".n2DisplayTiled_info"),s=n.find(".n2DisplayTiled_documents");(r.length<1||o.length<1||s.length<1)&&(n.empty(),r=e("<div>").addClass("n2DisplayTiled_filters").appendTo(n),o=e("<div>").addClass("n2DisplayTiled_info").appendTo(n),s=e("<div>").addClass("n2DisplayTiled_documents").appendTo(n),this.currentDetails={},this.grid=new Tiles.Grid(s),this.grid.createTile=function(n){var r=e("<div>").addClass("n2DisplayTiled_tile").addClass("n2DisplayTiled_tile_"+t.utils.stringToHtmlId(n)).attr("n2DocId",n);r.hover(i.hoverInFn,i.hoverOutFn);var o=new Tiles.Tile(n,r);return i.currentDetails&&i.currentDetails.docId===n?(r.addClass("n2DisplayTiled_tile_current"),i._generateCurrentDocumentContent(r,n)):i._generateDocumentContent(r,n),o},this.filter=this.filterFactory.get(r,function(){i._documentFilterChanged()}))},_adjustCurrentTile:function(i){var n=this,r=this._getDisplayDiv().find(".n2DisplayTiled_documents"),o=null;i&&(o="n2DisplayTiled_tile_"+t.utils.stringToHtmlId(i)),r.find(".n2DisplayTiled_tile_current").each(function(){var t=e(this);if(o&&t.hasClass(o));else{t.removeClass("n2DisplayTiled_tile_current");var i=t.attr("n2DocId");n._generateDocumentContent(t,i)}}),o&&r.find("."+o).each(function(){var t=e(this);if(t.hasClass("n2DisplayTiled_tile_current"));else{t.addClass("n2DisplayTiled_tile_current");var i=t.attr("n2DocId");n._generateCurrentDocumentContent(t,i)}})},_getDisplayDiv:function(){var t=this.displayPanelName;return e("#"+t)},_dispatch:function(e){var t=this.dispatchService;t&&t.send(n,e)},_getBooleanOption:function(e){var t=!1;this.boolOptions[e]&&(t=!0);var i=this.customService;i&&!t&&(i.getOption(e)&&(t=!0));return t},_getCachedDocumentFromId:function(e){return this.displayedDocuments&&this.displayedDocuments[e]&&this.displayedDocuments[e].doc?this.displayedDocuments[e].doc:this.currentDetails&&this.currentDetails.docId===e&&this.currentDetails.doc?this.currentDetails.doc:null},_requestDocumentWithId:function(e){var t=this._getCachedDocumentFromId(e);t?this._receiveDocumentContent(t):this.requestService&&this.requestService.requestDocument(e)},_generateCurrentDocumentContent:function(i,n){i.empty();var r="n2DisplayTiled_wait_current_"+t.utils.stringToHtmlId(n);e("<div>").addClass(r).addClass("n2DisplayTiled_tile_content").text(n).appendTo(i)},_generateDocumentContent:function(i,n){var r=this;i.empty(),e("<div>").addClass("n2DisplayTiled_thumb n2DisplayTiled_wait_thumb_"+t.utils.stringToHtmlId(n)).appendTo(i),e("<div>").addClass("n2DisplayTiled_wait_brief_"+t.utils.stringToHtmlId(n)).addClass("n2DisplayTiled_tile_brief").text(n).appendTo(i),i.attr("n2Click")||(i.click(function(){r._dispatch({type:"userSelect",docId:n})}),i.attr("n2Click","installed"))},_performIntervalTask:function(){var e=this._getDisplayDiv().find(".n2DisplayTiled_documents");if(this.currentDetails&&this.currentDetails.docId){var t=e.find(".n2DisplayTiled_tile_current").find(".n2DisplayTiled_tile_content");if(t.length>0){var i=t.height();if(i!=this.currentDetails.height){this.currentDetails.height=i;var n=this.grid.cellSize;this.grid.template=null,this.grid.templateFactory=new r(i,n),this.grid.redraw(!0)}}}},_documentFilterChanged:function(){this._updateDisplayedDocuments()}}),s=t.Class({elemId:null,changeCallback:null,schemaRepository:null,selectedSchema:null,initialize:function(i,n,r){var o=e(i);this.elemId=o.attr("id"),this.elemId||(this.elemId=t.getUniqueId(),o.attr("id",this.elemId)),this.changeCallback=n,this.schemaRepository=r},display:function(e){var i=this,n={};if(e)for(var r=0,o=e.length;r<o;++r){var s=e[r];s.schema&&(n[s.schema]=!0)}var a=[];for(var l in n)a.push(l);this.schemaRepository.getSchemas({names:a,onSuccess:function(e){i._displaySchemas(e)},onError:function(e){t.log("Error getting schemas for displaying schema filter",e)}})},filter:function(e){if(this.selectedSchema){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i];r.schema===this.selectedSchema&&t.push(r)}return t}return e},_getElem:function(){return e("#"+this.elemId)},_displaySchemas:function(n){var r=this,o=this._getElem();o.empty();var s=function(){var t=e(this).attr("n2SchemaName");return t=t||null,r._schemaSelected(t),!1};e("<a>").attr("href","#").text(i("All")).addClass("n2DisplayTiled_filter").addClass("n2DisplayTiled_filter_all").appendTo(o).click(s);for(var a=!1,l=0,c=n.length;l<c;++l){var d=n[l];d.name===this.selectedSchema&&(a=!0);var u=d.name;d.label&&(u=i(d.label)),e("<a>").attr("href","#").attr("n2SchemaName",d.name).text(u).addClass("n2DisplayTiled_filter_schema").addClass("n2DisplayTiled_filter_schema_"+t.utils.stringToHtmlId(d.name)).appendTo(o).click(s)}a||(this.selectedSchema=null),this._adjustSelection()},_adjustSelection:function(){var e=this._getElem();e.find(".n2DisplayTiled_filter_selected").removeClass("n2DisplayTiled_filter_selected"),this.selectedSchema?e.find(".n2DisplayTiled_filter_schema_"+t.utils.stringToHtmlId(this.selectedSchema)).addClass("n2DisplayTiled_filter_selected"):e.find(".n2DisplayTiled_filter_all").addClass("n2DisplayTiled_filter_selected")},_schemaSelected:function(e){this.selectedSchema=e,this._adjustSelection(),this.changeCallback()}}),a=t.Class({schemaRepository:null,initialize:function(e){var i=t.extend({schemaRepository:null},e);this.schemaRepository=i.schemaRepository},get:function(e,t){return new s(e,t,this.schemaRepository)}}),l=t.Class({documentSource:null,initialize:function(e){var i=t.extend({documentSource:null},e);this.documentSource=i.documentSource},getRelatedDocumentIds:function(e){var i=t.extend({doc:null,onSuccess:function(e,t){},onError:function(e){}},e),n=i.doc;this.documentSource.getReferencesFromId({docId:n._id,onSuccess:function(e){var r={},o=[];t.couchUtils.extractLinks(n,o);for(var s=0,a=o.length;s<a;++s){var l=o[s].doc;r[l]=!0}for(var s=0,a=e.length;s<a;++s){var l=e[s];r[l]=!0}var c=[];for(var d in r)c.push(d);i.onSuccess(n,c)},onError:function(e){i.onError(e)}})},areDocumentsRelated:function(e){var i=t.extend({selectedDoc:null,relatedDoc:null,onRelated:function(e,t){},onNotRelated:function(e,t){},onError:function(e){}},e),n=i.selectedDoc,r=i.relatedDoc,o=[];t.couchUtils.extractLinks(n,o);for(var s=0,a=o.length;s<a;++s){if(o[s].doc===r._id)return void i.onRelated(n,r)}o=[];t.couchUtils.extractLinks(r,o);for(s=0,a=o.length;s<a;++s){if(o[s].doc===n._id)return void i.onRelated(n,r)}i.onNotRelated(n,r)}});t.couchDisplayTiles={TiledDisplay:o,SchemaFilterFactory:a,ReferenceRelatedDocumentDiscovery:l,HandleDisplayAvailableRequest:function(e){"tiled"===e.displayType&&(e.isAvailable=!0)},HandleDisplayRenderRequest:function(e){if("tiled"===e.displayType){var t={};if(e.displayOptions)for(var i in e.displayOptions)t[i]=e.displayOptions[i];t.documentSource=e.config.documentSource,t.displayPanelName=e.displayId,t.showService=e.config.directory.showService,t.createDocProcess=e.config.directory.createDocProcess,t.requestService=e.config.directory.requestService,t.schemaRepository=e.config.directory.schemaRepository,t.customService=e.config.directory.customService,t.dispatchService=e.config.directory.dispatchService;var n=new o(t);e.onSuccess(n)}}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchSearch";function r(e){if(!e)return null;var i=t.couchUtils.extractSearchTerms(e,!1),n=[];for(var r in i){var o=i[r].folded;o&&n.push(o)}return n}var o=t.Class({id:null,index:null,count:null,initialize:function(e){var i=t.extend({id:null,index:null,count:null},e);this.id=i.id,this.index=i.index,i.count?this.count=i.count:this.count=1},add:function(e){this.index>e.index&&(this.index=e.index),this.count+=e.count}}),s=t.Class({id:null,initialize:function(e){t.extend({},e);this.id=t.getUniqueId()},execute:function(e){t.extend({onSuccess:function(e,t){},onError:function(e,t){},onPartial:function(e,t){}},e);throw"Subclasses must implement method execute"}}),a=t.Class(s,{textTerm:null,constraint:null,designDoc:null,searchView:null,initialize:function(e){var i=t.extend({textTerm:null,constraint:null,designDoc:null,searchView:null},e);if(s.prototype.initialize.apply(this,arguments),this.textTerm=i.textTerm,this.constraint=i.constraint,this.designDoc=i.designDoc,this.searchView=i.searchView,"string"!=typeof this.textTerm)throw"In ResearchTerm constructor, the textTerm must be a string";if("object"!=typeof this.designDoc)throw"In ResearchTerm constructor, the designDoc must be provided";if("string"!=typeof this.searchView)throw"In ResearchTerm constructor, the searchView must be provided"},execute:function(e){var i=t.extend({onSuccess:function(e,t){},onError:function(e,t){},onPartial:function(e,t){}},e),n=this.textTerm.toLowerCase(),r=null;if(this.constraint){if("string"==typeof this.constraint){var s=[];s.push(this.constraint),this.constraint=s}if(t.isArray(this.constraint)&&this.constraint.length>0)for(var a=this.constraint.length,l=0,c=this.constraint.length;l<c;++l)r||(r={}),this.designDoc.queryView({viewName:this.searchView,startkey:[this.constraint[l],n,0],endkey:[this.constraint[l],n,{}],constraint:this.constraint,onSuccess:function(e){for(var t=0,n=e.length;t<n;++t){var s=e[t].id,l=e[t].key[1];if(r[s]&&r[s].index<=l);else{var c=new o({id:s,index:l});r[s]=c}}--a<=0?i.onSuccess(r):i.onPartial(r)},onError:function(e){i.onError(e)}});else i.onError("Invalid search constraint")}else{var d=[n,0],u=[n,{}];this.designDoc.queryView({viewName:this.searchView,startkey:d,endkey:u,onSuccess:function(e){for(var t={},n=0,r=e.length;n<r;++n){var s=e[n].id,a=e[n].key[1];if(t[s]&&t[s].index<=a);else{var l=new o({id:s,index:a});t[s]=l}}i.onSuccess(t)},onError:function(e){i.onError(e)}})}}}),l=t.Class(s,{dateInterval:null,dateService:null,initialize:function(e){var i=t.extend({dateInterval:null,dateService:null},e);if(s.prototype.initialize.apply(this,arguments),this.dateInterval=i.dateInterval,this.dateService=i.dateService,"object"!=typeof this.dateInterval)throw"In ResearchDate constructor, the dateInterval must be provided";if("object"!=typeof this.dateService)throw"In ResearchDate constructor, the dateService must be provided"},execute:function(e){var i=t.extend({onSuccess:function(e,t){},onError:function(e,t){},onPartial:function(e,t){}},e);this.dateService.getDocIdsFromInterval({interval:this.dateInterval,onSuccess:function(e){for(var t=[],n=0,r=e.length;n<r;++n)t.push({docId:e[n],index:0});var s={};for(n=0,r=e.length;n<r;++n){var a=e[n],l=new o({id:a,index:0});s[a]=l}i.onSuccess(s)},onError:function(e){i.onError(e)}})}}),c=t.Class(s,{childrenById:null,resultsByDocId:null,count:null,waiting:null,error:null,initialize:function(e){t.extend({},e);s.prototype.initialize.apply(this,arguments),this.childrenById={},this.resultsByDocId={}},addResearch:function(e){var t=e.id;this.childrenById[t]=e},execute:function(e){var i=t.extend({onSuccess:function(e,t){},onError:function(e,t){},onPartial:function(e,t){}},e),n=this,r=function(e,t){n._receiveResult(e,t,i.onSuccess,i.onPartial)};for(var o in this.error=void 0,this.count=0,this.childrenById)++this.count;for(var o in this.waiting=this.count,this.resultsByDocId={},this.childrenById){this.childrenById[o].execute({onSuccess:r,onError:function(e){--n.waiting,n.error||(n.error=e,i.onError(e))}})}this.count<1&&this._checkIfFinished(i.onSuccess,i.onPartial)},_receiveResult:function(e,t,i,n){for(var r in e){var o=e[r];o.count=1,this.resultsByDocId[r]?this.resultsByDocId[r].add(o):this.resultsByDocId[r]=o}--this.waiting,this._checkIfFinished(i,n)},_checkIfFinished:function(e,t){this.error||(this.waiting<1?e(this.resultsByDocId,this):t(this.resultsByDocId,this))}}),d=t.Class(s,{childrenById:null,resultsByDocId:null,waiting:null,count:null,error:null,initialize:function(e){t.extend({},e);s.prototype.initialize.apply(this,arguments),this.childrenById={},this.resultsByDocId={}},addResearch:function(e){var t=e.id;this.childrenById[t]=e},execute:function(e){var i=t.extend({onSuccess:function(e,t){},onError:function(e,t){},onPartial:function(e,t){}},e),n=this,r=function(e,t){n._receiveResult(e,t,i.onSuccess,i.onPartial)};for(var o in this.error=void 0,this.count=0,this.childrenById)++this.count;for(var o in this.waiting=this.count,this.resultsByDocId={},this.childrenById){this.childrenById[o].execute({onSuccess:r,onError:function(e){--n.waiting,n.error||(n.error=e,i.onError(e))}})}this.count<1&&this._checkIfFinished(i.onSuccess,i.onPartial)},_receiveResult:function(e,t,i,n){if(this.waiting===this.count)for(var r in e){(o=e[r]).count=1,this.resultsByDocId[r]=o}else{for(var r in e){var o=e[r];this.resultsByDocId[r]&&this.resultsByDocId[r].add(o)}var s=[];for(var r in this.resultsByDocId)e[r]||s.push(r);for(var a=0,l=s.length;a<l;++a){r=s[a];delete this.resultsByDocId[r]}}--this.waiting,this._checkIfFinished(i,n)},_checkIfFinished:function(e,t){this.error||(this.waiting<1?e(this.resultsByDocId,this):t(this.resultsByDocId,this))}}),u=t.Class({options:null,searchResults:null,initialize:function(e,i){this.options=t.extend({designDoc:null,db:null,constraint:null,dateService:null,searchLimit:25,onlyFinalResults:!1,strict:!0,onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},i),t.isArray(e)&&(e=p.join(" "));var n=[];if(this.options.dateService)for(var o=t.date.findAllDateStrings(e),s=0,u=o.length;s<u;++s){n.push(o[s]);var h=o[s].str;e.indexOf(h)>=0&&(e=e.replace(h,""))}var p=void 0;if("string"!=typeof e)throw"Search terms must be a string or an array";(p=r(e))||(p=[]);var f=void 0;f=this.options.strict?new d:new c;var m="text-search";this.options.constraint&&(m="text-search-constrained"),this.searchResults={terms:[],actionReturnedCount:0,pending:0,map:{},sorted:[],list:[]};for(s=0,u=p.length;s<u;++s){var v=new a({textTerm:p[s],constraint:this.options.constraint,designDoc:this.options.designDoc,searchView:m});f.addResearch(v),++this.searchResults.pending}for(s=0,u=n.length;s<u;++s){var g=n[s],y=(v=new c,new l({dateInterval:g.interval,dateService:this.options.dateService}));v.addResearch(y);for(var _=r(g.str),S=0,b=_.length;S<b;++S){var I=_[S],C=new a({textTerm:I,constraint:this.options.constraint,designDoc:this.options.designDoc,searchView:m});v.addResearch(C)}f.addResearch(v),++this.searchResults.pending}if(this.searchResults.pending<1)this._returnSearchResults();else{var D=this;f.execute({onSuccess:function(e,t){D._receiveSearchResults(e,!1)},onError:function(e,t){D.searchResults=null,D.options.onError(e)},onPartial:function(e,t){D._receiveSearchResults(e,!0)}})}},abortSearch:function(){this.searchResults=null},_receiveSearchResults:function(e,t){var i=this.searchResults;i&&(--i.pending,++i.actionReturnedCount,i.map=e,t&&this.options.onlyFinalResults||this._returnSearchResults())},_returnSearchResults:function(){var e=this.searchResults;if(e){var t=0;for(var i in e.sorted=[],e.map){var n=e.map[i];e.sorted.push(n),t<n.count&&(t=n.count)}e.sorted.sort(function(e,t){return e.count>t.count?-1:e.count<t.count?1:e.index<t.index?-1:e.index>t.index?1:0}),e.list=[];for(var r=0,o=e.sorted.length;r<o;++r){var s=e.sorted[r];s.count>=t&&e.list.push(s)}this.options.onSuccess(e)}}}),h=t.Class({designDoc:null,lookAheadLimit:null,lookAheadPrefixMin:null,lookAheadCacheSize:null,lookAheadMap:null,lookAheadCounter:null,constraint:null,initialize:function(e){var i=t.extend({designDoc:null,lookAheadLimit:5,lookAheadPrefixMin:3,lookAheadCacheSize:10,constraint:null},e);this.designDoc=i.designDoc,this.lookAheadLimit=i.lookAheadLimit,this.lookAheadPrefixMin=i.lookAheadPrefixMin,this.lookAheadCacheSize=i.lookAheadCacheSize,this.constraint=i.constraint,this.lookAheadMap={},this.lookAheadCounter=0},setConstraint:function(e){this.constraint=e},queryPrefix:function(e,t){var i=this,n=this._retrievePrefix(e);if(n)t(e,n);else{var r="text-lookahead";this.constraint&&(r="text-lookahead-constrained");var o=[e,null],s=[e+"香",{}];this.constraint&&(o=[this.constraint,e,null],s=[this.constraint,e+"香",{}]),this.designDoc.queryView({viewName:r,listName:"text-lookahead",startkey:o,endkey:s,top:this.lookAheadLimit,group:!0,onlyRows:!1,reduce:!0,onSuccess:function(n){for(var r=n.rows,o=[],s=0,a=r.length;s<a;++s)o.push(r[s][0]);i._cachePrefix({prefix:e,words:o,full:n.all_rows}),0==o.length?t(e,null):t(e,o)},onError:function(){t(e,null)}})}},queryTerms:function(e,t){if(null!==e&&0!=e.length){for(var i=e.length-1;i>=0;){var n=e[i];if(""!==n){var r=null;i>0&&(r=e.slice(0,i));break}--i}if(n=n.toLowerCase())if(n.length<this.lookAheadPrefixMin)t(null);else{var o="";r&&(o=r.join(" ")+" "),this.queryPrefix(n,function(e,i){if(null===i)t(null);else{for(var n=[],r=0,s=i.length;r<s;++r)n.push(o+i[r]);t(n)}})}else t(null)}else t(null)},_cachePrefix:function(e){this.lookAheadMap[e.prefix]=e,e.counter=this.lookAheadCounter,++this.lookAheadCounter;var t=[],i=this.lookAheadMap,n=this.lookAheadCounter-this.lookAheadCacheSize;for(var r in i)i[r].counter<n&&t.push(r);for(var o=0,s=t.length;o<s;++o)delete i[t[o]]},_retrievePrefix:function(e){if(this.lookAheadMap[e])return this.lookAheadMap[e].words;for(var t=e.substring(0,e.length-1);t.length>=this.lookAheadPrefixMin;){if(this.lookAheadMap[t]&&this.lookAheadMap[t].full){for(var i=this.lookAheadMap[t].words,n=[],r=0,o=i.length;r<o;++r){var s=i[r];s.length>=e.length&&s.substr(0,e.length)===e&&n.push(s)}return n}t=t.substring(0,t.length-1)}return null},getJqAutoCompleteSource:function(){var e=this;return function(t,i){e._jqAutoComplete(t,i)}},_jqAutoComplete:function(e,t){var i=r(e.term),n=t;this.queryTerms(i,n)}}),p=t.Class({options:null,searchServer:null,textInputId:null,searchButtonId:null,keyPressedSinceLastSearch:null,dispatchHandle:null,initialize:function(i,r){this.options=t.extend({textInput:null,searchButton:null,initialSearchText:null,constraint:null,displayFn:null,dispatchService:null},i);var o=this;if(this.searchServer=r,this.keyPressedSinceLastSearch=!1,this.options.dispatchService){var s=function(e){o._handle(e)};this.options.dispatchService.register(n,"searchInitiate",s),this.options.dispatchService.register(n,"selected",s),this.options.dispatchService.register(n,"unselected",s),this.options.dispatchService.register(n,"searchActivated",s),this.options.dispatchService.register(n,"searchDeactivated",s),e(".searchIcon").click(function(){e(".nunaliit_search_input").hasClass("search_active")?o.options.dispatchService.send(n,{type:"searchDeactivated"}):(e(".nunaliit_search_input").hasClass("search_inactive"),o.options.dispatchService.send(n,{type:"searchActivated"}))})}var a=this.options.textInput;if(this.textInputId=t.utils.getElementIdentifier(a),this.options.textInput=null,this.options.searchButton){var l=this.options.searchButton,c=l.attr("id");c||(c=t.getUniqueId(),l.attr("id",c)),this.searchButtonId=c,this.options.searchButton=null}this.options.initialSearchText||(this.options.initialSearchText=""),this._install()},getTextInput:function(){return e("#"+this.textInputId)},getSearchButton:function(){return this.searchButtonId?e("#"+this.searchButtonId):null},getSearchLine:function(){var e=this.getTextInput().val();return e&&e.length>0?e===this.options.initialSearchText?"":e:""},performSearch:function(e){var t=this;this.options.dispatchService?this.options.dispatchService.send(n,{type:"searchInitiate",searchLine:e}):this.searchServer&&this.searchServer.submitRequest(e,{onSuccess:function(e){t._processSearchResults(e)},onError:function(e){t._processSearchError(e)}}),this.keyPressedSinceLastSearch=!1,this._displayWait()},_install:function(){var e=this,t=this.getTextInput();this.options.initialSearchText&&t.val(this.options.initialSearchText),t.autocomplete&&t.autocomplete({source:this._getJqAutoCompleteSource()}),t.keydown(function(t){e._keyDown(t)}),t.focus(function(t){e._focus(t)}),t.blur(function(t){e._blur(t)});var i=this.getSearchButton();i&&i.click(function(t){e._clickSearch(t)})},_focus:function(e){var t=this.getTextInput();if(this.options.initialSearchText){var i=t.val();this.options.initialSearchText===i&&t.val("")}t.select()},_blur:function(e){if(this.options.initialSearchText){var t=this.getTextInput();""===t.val()&&t.val(this.options.initialSearchText)}},_keyDown:function(e){var t=null;if(null===e&&(e=window.event),null!==e&&e.keyCode&&(t=e.keyCode),this.keyPressedSinceLastSearch=!0,13===t||null===t){var i=this.getSearchLine();i.length>0&&(this._closeLookAhead(),this.performSearch(i),this._closeLookAhead())}},_clickSearch:function(e){var t=this.getSearchLine();t.length>0&&(this._closeLookAhead(),this.performSearch(t),this._closeLookAhead())},_closeLookAhead:function(e){e||(e=this.getTextInput()),e.autocomplete&&e.autocomplete("close")},_processSearchResults:function(e){this.options.displayFn?(e.type="results",this.options.displayFn(e)):this.options.dispatchService?this.options.dispatchService.send(n,{type:"searchResults",results:e}):t.log("Unable to return search results")},_processSearchError:function(e){if(this.options.displayFn){var t={type:"error",error:e};this.options.displayFn(t)}else this.options.dispatchService&&this.options.dispatchService.send(n,{type:"searchResults",error:e})},_displayWait:function(){this.options.displayFn&&this.options.displayFn({type:"wait"})},_getJqAutoCompleteSource:function(){var e=this;return function(t,i){e._jqAutoComplete(t,i)}},_jqAutoComplete:function(e,t){var i=this;this.searchServer.getLookAheadService()._jqAutoComplete(e,function(e){i.keyPressedSinceLastSearch?t(e):t(null)})},_activateSearchBar:function(){e(".nunaliit_search_input").addClass("search_active").removeClass("search_inactive"),e(".nunaliit_search_input input").focus()},_deactivateSearchBar:function(){e(".nunaliit_search_input").addClass("search_inactive").removeClass("search_active")},_handle:function(e){if("searchInitiate"===e.type)(t=this.getTextInput()).val(e.searchLine),this.options.dispatchService.send(n,{type:"searchActivated"});else if("selected"===e.type||"unselected"===e.type){var t=this.getTextInput();this.options.initialSearchText?(t.val(this.options.initialSearchText),this.options.dispatchService.synchronousCall(n,{type:"searchDeactivated"})):t.val("")}else"searchActivated"===e.type?this._activateSearchBar():"searchDeactivated"===e.type&&this._deactivateSearchBar()}}),f=t.Class({options:null,designDoc:null,db:null,dateService:null,dispatchService:null,customService:null,constraint:null,searchLimit:null,lookAheadLimit:null,lookAheadPrefixMin:null,lookAheadCacheSize:null,lookAheadService:null,initialize:function(e){var i=t.extend({designDoc:null,db:null,dateService:null,dispatchService:null,customService:null,constraint:null,searchLimit:25,lookAheadLimit:5,lookAheadPrefixMin:3,lookAheadCacheSize:10},e),n=this;this.designDoc=i.designDoc,this.db=i.db,this.dateService=i.dateService,this.dispatchService=i.dispatchService,this.customService=i.customService,this.constraint=i.constraint,this.searchLimit=i.searchLimit,this.lookAheadLimit=i.lookAheadLimit,this.lookAheadPrefixMin=i.lookAheadPrefixMin,this.lookAheadCacheSize=i.lookAheadCacheSize,this.lookAheadService=null;var r=this.dispatchService;if(r){var o=r.getHandle("n2.couchSearch");r.register(o,"searchInitiate",function(e){n._handle(e)})}},setConstraint:function(e){this.constraint=e,this.lookAheadService&&this.lookAheadService.setConstraint(e)},getLookAheadService:function(){return null===this.lookAheadService&&(this.lookAheadService=new h({designDoc:this.designDoc,lookAheadLimit:this.lookAheadLimit,lookAheadPrefixMin:this.lookAheadPrefixMin,lookAheadCacheSize:this.lookAheadCacheSize,constraint:this.constraint})),this.lookAheadService},submitRequest:function(e,i){var n=t.extend({designDoc:this.designDoc,db:this.db,dateService:this.dateService,searchLimit:this.searchLimit,constraint:this.constraint},i);return new u(e,n)},getJqAutoCompleteSource:function(){return this.getLookAheadService().getJqAutoCompleteSource()},installSearch:function(e){return new p(e,this)},installSearchWidget:function(n){var r=t.extend({elem:null,label:null,useButton:!1,buttonLabel:null,doNotDisable:!1,constraint:null},n),o=this.customService,s=e(r.elem),a=r.label;null===a&&o&&(a=o.getOption("searchWidgetText",null)),null===a&&(a=i("search the atlas")),s.empty();e("<div>").addClass("searchIcon").appendTo(s);var l=e('<input type="text">').addClass("search_panel_input").val(a).appendTo(s);r.doNotDisable||l.addClass("n2_disable_on_edit");var c=r.buttonLabel;null===c&&o&&(c=o.getOption("searchButtonText",null)),null===c&&(c=i("Search"));var d=null;return r.useButton&&(d=e('<input type="button">').val(c).appendTo(s)),new p({textInput:l,initialSearchText:a,dispatchService:this.dispatchService,searchButton:d,constraint:r.constraint},this)},_handle:function(e){if("searchInitiate"===e.type){var t=e.searchLine,i=this.dispatchService,n=i.getHandle("n2.couchSearch");this.submitRequest(t,{onSuccess:function(e){i.send(n,{type:"searchResults",results:e})},onError:function(e){i.send(n,{type:"searchError",error:e})}})}}});t.couchSearch={SearchServer:f,SearchRequest:u}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchDialogs";function r(t){var i=t,n=e("body").width();if("number"==typeof n){var r=.9*n;i>r&&(i=r)}return i}var o=t.Class({dialogId:null,progressLabel:null,onCancelFn:null,cancellingLabel:null,initialize:function(n){var r=t.extend({title:i("Progress"),progressLabel:i("Progress"),onCancelFn:null,cancelButtonLabel:i("Cancel"),cancellingLabel:i("Cancelling Operation...")},n),o=this;this.dialogId=t.getUniqueId(),this.progressLabel=r.progressLabel,this.onCancelFn=r.onCancelFn,this.cancellingLabel=r.cancellingLabel;var s=e('<div id="'+this.dialogId+'" class="n2dialogs_progress"><div class="n2dialogs_progress_message"><span class="n2dialogs_progress_label"></span>: <span class="n2dialogs_progress_percent"></span></div></div>');s.find("span.n2dialogs_progress_label").text(this.progressLabel);var a={autoOpen:!0,title:r.title,modal:!0,closeOnEscape:!1,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};if(s.dialog(a),s.parents(".ui-dialog").first().find(".ui-dialog-titlebar-close").hide(),"function"==typeof r.onCancelFn){var l=e('<div><button class="n2dialogs_progress_cancelButton"></button></div>');s.append(l),l.find("button").text(r.cancelButtonLabel).click(function(){return o.cancel(),!1})}this.updatePercent(0)},cancel:function(){if("function"==typeof this.onCancelFn){var t=e("#"+this.dialogId).find(".n2dialogs_progress_cancelButton"),i=e("<span></span>").text(this.cancellingLabel);t.before(i).remove(),this.onCancelFn()}},close:function(){e("#"+this.dialogId).dialog("close")},updatePercent:function(t){e("#"+this.dialogId).find(".n2dialogs_progress_percent").text(Math.floor(t)+"%")},updateHtmlMessage:function(t){e("#"+this.dialogId).find(".n2dialogs_progress_message").html(t)}}),s=t.Class({dialogId:null,initialize:function(n){var r=t.extend({title:i("Alert"),message:null},n),o=this;this.dialogId=t.getUniqueId();var s=e("<div>").attr("id",this.dialogId).addClass("n2dialogs_alert");e("<div>").addClass("n2dialogs_alert_message").text(r.message).appendTo(s);var a=e("<div>").appendTo(s);e("<button>").addClass("n2dialogs_alert_okButton").text(i("OK")).appendTo(a).click(function(){return o.close(),!1});var l={autoOpen:!0,title:r.title,modal:!0,closeOnEscape:!1,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};s.dialog(l)},close:function(){e("#"+this.dialogId).dialog("close")}});function a(n){var o=t.extend({searchServer:null,showService:null,onSelected:function(e){},onReset:function(){}},n),s=!0,a=t.getUniqueId(),l=t.getUniqueId(),c=t.getUniqueId(),d=t.getUniqueId(),u=e('<div id="'+a+'" class="editorSelectDocumentDialog"><div><label for="'+l+'">'+i("Search:")+'</label><input id="'+l+'" type="text"/><button id="'+c+'">'+i("Search")+'</button></div><div  class="editorSelectDocumentDialogResults" id="'+d+'"></div><div><button class="cancel">'+i("Cancel")+"</button></div></div>");u.find("button.cancel").button({icons:{primary:"ui-icon-cancel"}}).click(function(){return e("#"+a).dialog("close"),!1});var h={autoOpen:!0,title:i("Select Document"),modal:!0,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove(),s&&o.onReset()}},p=r(370);"number"==typeof p&&(h.width=p),u.dialog(h),o.searchServer.installSearch({textInput:e("#"+l),searchButton:e("#"+c),displayFn:function(t){if(t)if("wait"===t.type)e("#"+d).empty();else if("results"===t.type){for(var n=[],r=0,s=t.list.length;r<s;++r){var a=t.list[r].id;n.push(a)}!function(t){if(t.length<1)e("#"+d).empty().append(i("Search result is empty"));else{var n=e("<table></table>");e("#"+d).empty().append(n);for(var r=0,s=t.length;r<s;++r){var a=t[r],l=e("<tr>").appendTo(n),c=e("<td>").addClass("n2_search_result olkitSearchMod2_"+r%2).appendTo(l),u=e("<a>").attr("href","#"+a).attr("alt",a).appendTo(c).click(f(a));o.showService?o.showService.printBriefDescription(u,a):u.text(a)}}}(n)}else reportError("Invalid search results returned");else reportError("Invalid search results returned")},onlyFinalResults:!0});e("#"+l);function f(t){return function(i){return o.onSelected(t),s=!1,e("#"+a).dialog("close"),!1}}e("#"+l).focus()}function l(o){var s=t.extend({currentLayers:[],cb:function(e){},resetFn:function(){},documentSource:null,showService:null,dispatchService:null},o),a={};if("string"==typeof s.currentLayers)for(var l=s.currentLayers.split(","),c=0,d=l.length;c<d;++c){var u=t.trim(l[c]);a[u]={currentlySelected:!0,id:u,label:null}}else if(t.isArray(s.currentLayers))for(c=0,d=s.currentLayers.length;c<d;++c){u=t.trim(s.currentLayers[c]);a[u]={currentlySelected:!0,id:u,label:null}}var h=!0,p=t.getUniqueId(),f=e('<div id="'+p+'" class="editorSelectLayerDialog"><div class="editorSelectLayerContent"></div><div class="editorSelectLayerButtons"><button class="ok">'+i("OK")+'</button><button class="cancel">'+i("Cancel")+"</button></div></div>");f.find("button.cancel").button({icons:{primary:"ui-icon-cancel"}}).click(function(){return e("#"+p).dialog("close"),!1}),f.find("button.ok").button({icons:{primary:"ui-icon-check"},disabled:!0});var m={autoOpen:!0,title:i("Select Layers"),modal:!0,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove(),h&&s.resetFn()}},v=r(370);function g(){var r={type:"mapGetLayers",layers:{}};for(var o in s.dispatchService.synchronousCall(n,r),r.layers)a[o]||(a[o]={currentlySelected:!1});!function(){var n=e("#"+p),r=n.find(".editorSelectLayerContent");for(var o in r.empty(),a){var l=o;a[o].label&&(l=i(a[o].label));var c=t.getUniqueId(),d=e("<div>").appendTo(r),u=e('<input type="checkbox">').addClass("layer").attr("id",c).attr("name",o).appendTo(d),f=e("<label>").attr("for",c).text(l).appendTo(d);a[o].currentlySelected&&u.attr("checked","checked"),s.showService&&!a[o].label&&s.showService.printLayerName(f,o)}n.find("button.ok").button("option","disabled",!1).click(function(){var t=[],i=e("#"+p);i.find("input.layer").each(function(){var i=e(this);if(i.is(":checked")){var n=i.attr("name");t.push(n)}}),s.cb(t),h=!1,i.dialog("close")})}()}"number"==typeof v&&(m.width=v),f.dialog(m),s.documentSource?s.documentSource.getLayerDefinitions({onSuccess:function(e){for(var t=0,i=e.length;t<i;++t){var n=e[t],r=n.id;a[r]||(a[r]={currentlySelected:!1}),n.name&&(a[r].label=n.name)}g()},onError:function(t){var i;i=t,e("#"+p).find(".editorSelectLayerContent").text("Error: "+i)}}):g()}var c=t.Class({showService:null,dialogPrompt:null,sortOnBrief:null,initialize:function(e){var n=t.extend({showService:null,sortOnBrief:!1,dialogPrompt:i("Select")},e);this.showService=n.showService,this.dialogPrompt=n.dialogPrompt,this.sortOnBrief=n.sortOnBrief},getDialogFunction:function(){var e=this;return function(t){e.showDialog(t)}},getDocuments:function(e){var i=t.extend({args:[],onSuccess:function(e){},onError:function(e){}},e);t.log("Subclasses to SearchBriefDialogFactory must implement getDocuments()"),i.onSuccess([])},showDialog:function(n){var o=t.extend({args:[],onSelected:function(e){},onReset:function(){}},n),s=this,a=!0,l=t.getUniqueId(),c=t.getUniqueId(),d=t.getUniqueId(),u=e("<div>").attr("id",l).addClass("editorSelectDocumentDialog"),h=e("<div>").appendTo(u);e("<label>").attr("for",c).text(i("Search:")).appendTo(h),e("<input>").attr("id",c).attr("type","text").appendTo(h).keyup(function(){for(var i=e(this).val().split(" "),n=[],r=0,o=i.length;r<o;++r){var s=t.trim(i[r].toLowerCase());s.length>0&&n.push(s)}t.log("text : "+n.join("+")),function(t){var i=e("#"+l).find(".trResult");!t||t.length<1?i.show():i.each(function(){for(var i=e(this),n=i.text().toLowerCase(),r=!0,o=0,s=t.length;o<s&&r;++o){var a=t[o];n.indexOf(a)<0&&(r=!1)}r?i.show():i.hide()})}(n)});var p=e("<div>").attr("id",d).addClass("editorSelectDocumentDialogResults").appendTo(u);e("<div>").addClass("olkit_wait").appendTo(p);var f=e("<div>").appendTo(u);e("<button>").addClass("cancel").text(i("Cancel")).appendTo(f).button({icons:{primary:"ui-icon-cancel"}}).click(function(){return e("#"+l).dialog("close"),!1});var m={autoOpen:!0,title:this.dialogPrompt,modal:!0,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove(),a&&o.onReset()}},v=r(370);function g(t){return function(i){return o.onSelected(t),a=!1,e("#"+l).dialog("close"),!1}}"number"==typeof v&&(m.width=v),u.dialog(m),this.getDocuments({args:o.args,onSuccess:function(t){if(t.length<1)e("#"+d).empty().text(i("No document found"));else{var n=e("<table></table>");e("#"+d).empty().append(n);for(var r={},o=0,a=t.length;o<a;++o){var l=t[o],c=l._id;if(r[c]);else{r[c]=!0;var u=e("<tr>").addClass("trResult").appendTo(n),h=e("<td>").addClass("n2_search_result olkitSearchMod2_"+o%2).appendTo(u),p=e("<a>").attr("href","#"+c).attr("alt",c).appendTo(h).click(g(c));s.showService?s.showService.displayBriefDescription(p,{},l):p.text(c)}}s.sortOnBrief&&function(t){var i=t.find("tr");i.each(function(){var t=e(this);t.attr("n2-sort-key",t.text())}),i.toArray().sort(function(t,i){var n=e(t).attr("n2-sort-key"),r=e(i).attr("n2-sort-key");return n===r?0:n?r?n<r?-1:n>r?1:0:1:-1}).forEach(function(e){t.append(e)})}(n)}},onError:function(t){var n;n=i("Unable to retrieve documents: {err}",{err:t}),e("#"+d).empty().text(n)}})}}),d=t.Class("SearchOnSchemaDialogFactory",c,{atlasDesign:null,showService:null,dialogPrompt:null,initialize:function(e){var n=t.extend({atlasDesign:void 0,showService:void 0,sortOnBrief:!0,dialogPrompt:i("Select a Document")},e);t.couchDialogs.SearchBriefDialogFactory.prototype.initialize.call(this,n),this.atlasDesign=n.atlasDesign},getDocuments:function(e){var n=t.extend({args:[],onSuccess:function(e){},onError:function(e){}},e),r=[],o=!0;if(t.isArray(n.args)&&n.args.length>0){o=!1;r=[];n.args.forEach(function(e){"string"==typeof e?r.push(e):o=!0})}o?(t.logError("Can not search for documents based on schema",n.args),n.onError(i("Can not search for documents based on schema"))):this.atlasDesign.queryView({viewName:"nunaliit-schema",keys:r,include_docs:!0,onSuccess:function(e){for(var t=[],i=0,r=e.length;i<r;++i){var o=e[i].doc;o&&t.push(o)}n.onSuccess(t)},onError:function(e){t.logError("Unable to retrieve documents for schema "+r+": "+e),n.onError(i("Unable to retrieve documents for schema {name}",{name:""+r}))}})}}),u=t.Class("SearchOnLayerDialogFactory",c,{atlasDesign:null,showService:null,dialogPrompt:null,initialize:function(e){var n=t.extend({atlasDesign:void 0,showService:void 0,sortOnBrief:!0,dialogPrompt:i("Select a Document")},e);t.couchDialogs.SearchBriefDialogFactory.prototype.initialize.call(this,n),this.atlasDesign=n.atlasDesign},getDocuments:function(e){var n=t.extend({args:[],onSuccess:function(e){},onError:function(e){}},e),r=[],o=!0;if(t.isArray(n.args)&&n.args.length>0){o=!1;r=[];n.args.forEach(function(e){"string"==typeof e?r.push(e):o=!0})}o?(t.logError("Can not search for documents based on layer",n.args),n.onError(i("Can not search for documents based on layer"))):this.atlasDesign.queryView({viewName:"layers",keys:r,include_docs:!0,onSuccess:function(e){for(var t=[],i=0,r=e.length;i<r;++i){var o=e[i].doc;o&&t.push(o)}n.onSuccess(t)},onError:function(e){t.logError("Unable to retrieve documents for layer "+r+": "+e),n.onError(i("Unable to retrieve documents for layer {name}",{name:""+r}))}})}}),h=t.Class("SearchRelatedMediaDialogFactory",{documentSource:null,searchService:null,showService:null,dialogPrompt:null,initialize:function(e){var n=t.extend({documentSource:null,searchService:null,showService:null,dialogPrompt:i("Select a Media")},e);this.documentSource=n.documentSource,this.searchService=n.searchService,this.showService=n.showService,this.dialogPrompt=n.dialogPrompt},getDialogFunction:function(){var e=this;return function(t){e.showDialog(t)}},filterDocuments:function(e){var i=t.extend({docs:null,onSuccess:function(e){},onError:function(e){}},e),n=[];t.isArray(i.docs)&&i.docs.forEach(function(e){t.couchAttachment.getAttachments(e).forEach(function(t){t.isSource()&&t.isAttached()&&n.push(e)})}),i.onSuccess(n)},showDialog:function(n){var o=t.extend({contextDoc:null,onSelected:function(e){},onReset:function(){}},n),s=this,a=!0,l=t.getUniqueId(),c=t.getUniqueId(),d=t.getUniqueId(),u=t.getUniqueId(),h=t.getUniqueId(),p=e("<div>").attr("id",l).addClass("editorSelectDocumentDialog editorSelectDocumentDialog_relatedMedia"),f=(e("<div>").addClass("editorSelectDocumentDialog_suggestedHeader").text(i("Suggestions")).appendTo(p),e("<div>").attr("id",u).addClass("editorSelectDocumentDialog_suggestedList").appendTo(p),e("<div>").addClass("editorSelectDocumentDialog_searchLine").appendTo(p));e("<label>").attr("for",c).text(i("Search:")).appendTo(f),e("<input>").attr("id",c).attr("type","text").appendTo(f),e("<button>").attr("id",d).text(i("Search")).appendTo(f),e("<div>").attr("id",h).addClass("editorSelectDocumentDialogResults").appendTo(p);var m=e("<div>").appendTo(p);e("<button>").addClass("cancel").text(i("Cancel")).appendTo(m).button({icons:{primary:"ui-icon-cancel"}}).click(function(){return e("#"+l).dialog("close"),!1});var v={autoOpen:!0,title:this.dialogPrompt,modal:!0,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove(),a&&o.onReset()}},g=r(370);"number"==typeof g&&(v.width=g),p.dialog(v),this.searchService.installSearch({textInput:e("#"+c),searchButton:e("#"+d),displayFn:function(t){if(t)if("wait"===t.type)e("#"+h).empty();else if("results"===t.type){for(var n=[],r=0,o=t.list.length;r<o;++r){var a=t.list[r].id;n.push(a)}n.length<1?y([]):s.documentSource.getDocuments({docIds:n,onSuccess:function(e){s.filterDocuments({docs:e,onSuccess:function(e){y(e,h)},onError:S})},onError:function(e){S(i("Unable to retrieve documents"))}})}else S(i("Invalid search results returned"));else S(i("Invalid search results returned"))},onlyFinalResults:!0});e("#"+c);function y(t,n){if(t.length<1)e("#"+n).empty().text(i("No results returned by search"));else{var r=e("<table></table>");e("#"+n).empty().append(r);for(var o=0,a=t.length;o<a;++o){var l=t[o],c=l._id,d=e("<tr></tr>");r.append(d);var u=e("<td>").addClass("n2_search_result olkitSearchMod2_"+o%2).appendTo(d),h=e("<a>").attr("href","#"+c).attr("alt",c).appendTo(u).click(_(c));s.showService?s.showService.displayBriefDescription(h,{},l):h.text(c)}}}function _(t){return function(i){return o.onSelected(t),a=!1,e("#"+l).dialog("close"),!1}}function S(t){e("#"+h).empty().text(t)}e("#"+c).focus(),o.contextDoc&&"string"==typeof o.contextDoc._id&&this.documentSource.getReferencesFromId({docId:o.contextDoc._id,onSuccess:function(e){e.length<1?y([]):s.documentSource.getDocuments({docIds:e,onSuccess:function(e){s.filterDocuments({docs:e,onSuccess:function(e){y(e,u)},onError:S})},onError:function(e){S(i("Unable to retrieve documents"))}})},onError:function(e){t.logError("Unable to fetch related documents for "+o.contextDoc._id)}})}}),p=t.Class("SearchRelatedImageDialogFactory",h,{initialize:function(e){var n=t.extend({documentSource:void 0,searchService:void 0,showService:void 0,dialogPrompt:i("Select a Related Image")},e);h.prototype.initialize.call(this,n)},filterDocuments:function(e){var i=t.extend({docs:null,onSuccess:function(e){},onError:function(e){}},e),n=[];t.isArray(i.docs)&&i.docs.forEach(function(e){t.couchAttachment.getAttachments(e).forEach(function(t){t.isSource()&&t.isAttached()&&"image"===t.getFileClass()&&n.push(e)})}),i.onSuccess(n)}}),f=t.Class("SearchRelatedAudioDialogFactory",h,{initialize:function(e){var n=t.extend({documentSource:void 0,searchService:void 0,showService:void 0,dialogPrompt:i("Select a Related Audio File")},e);h.prototype.initialize.call(this,n)},filterDocuments:function(e){var i=t.extend({docs:null,onSuccess:function(e){},onError:function(e){}},e),n=[];t.isArray(i.docs)&&i.docs.forEach(function(e){t.couchAttachment.getAttachments(e).forEach(function(t){t.isSource()&&t.isAttached()&&"audio"===t.getFileClass()&&n.push(e)})}),i.onSuccess(n)}}),m=t.Class("SearchRelatedVideoDialogFactory",h,{initialize:function(e){var n=t.extend({documentSource:void 0,searchService:void 0,showService:void 0,dialogPrompt:i("Select a Related Video File")},e);h.prototype.initialize.call(this,n)},filterDocuments:function(e){var i=t.extend({docs:null,onSuccess:function(e){},onError:function(e){}},e),n=[];t.isArray(i.docs)&&i.docs.forEach(function(e){t.couchAttachment.getAttachments(e).forEach(function(t){t.isSource()&&t.isAttached()&&"video"===t.getFileClass()&&n.push(e)})}),i.onSuccess(n)}}),v=t.Class("HoverSoundSearchDialogFactory",h,{initialize:function(e){var n=t.extend({documentSource:void 0,searchService:void 0,showService:void 0,dialogPrompt:i("Select a Hover Sound")},e);h.prototype.initialize.call(this,n)},filterDocuments:function(e){var i=t.extend({docs:null,onSuccess:function(e){},onError:function(e){}},e),n=[];t.isArray(i.docs)&&i.docs.forEach(function(e){t.couchAttachment.getAttachments(e).forEach(function(t){t.isSource()&&t.isAttached()&&"audio"===t.getFileClass()&&n.push(e)})}),i.onSuccess(n)}}),g=t.Class({atlasDb:null,searchService:null,showService:null,dialogPrompt:null,initialize:function(e){var n=t.extend({atlasDb:null,searchService:null,showService:null,dialogPrompt:i("Search")},e);this.atlasDb=n.atlasDb,this.searchService=n.searchService,this.showService=n.showService,this.dialogPrompt=n.dialogPrompt},getDialogFunction:function(){var e=this;return function(t){e.showDialog(t)}},filterDocuments:function(e){var i=t.extend({docs:null,onSuccess:function(e){},onError:function(e){}},e);t.log("Subclasses to FilteredSearchDialogFactory must implement filterDocuments()"),i.onSuccess(i.docs)},showDialog:function(n){var o=t.extend({onSelected:function(e){},onReset:function(){}},n),s=this,a=!0,l=t.getUniqueId(),c=t.getUniqueId(),d=t.getUniqueId(),u=t.getUniqueId(),h=e("<div>").attr("id",l).addClass("editorSelectDocumentDialog"),p=e("<div>").appendTo(h);e("<label>").attr("for",c).text(i("Search:")).appendTo(p),e("<input>").attr("id",c).attr("type","text").appendTo(p),e("<button>").attr("id",d).text(i("Search")).appendTo(p),e("<div>").attr("id",u).addClass("editorSelectDocumentDialogResults").appendTo(h);var f=e("<div>").appendTo(h);e("<button>").addClass("cancel").text(i("Cancel")).appendTo(f).button({icons:{primary:"ui-icon-cancel"}}).click(function(){return e("#"+l).dialog("close"),!1});var m={autoOpen:!0,title:this.dialogPrompt,modal:!0,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove(),a&&o.onReset()}},v=r(370);"number"==typeof v&&(m.width=v),h.dialog(m),this.searchService.installSearch({textInput:e("#"+c),searchButton:e("#"+d),displayFn:function(t){if(t)if("wait"===t.type)e("#"+u).empty();else if("results"===t.type){for(var n=[],r=0,o=t.list.length;r<o;++r){var a=t.list[r].id;n.push(a)}n.length<1?g([]):s.atlasDb.getDocuments({docIds:n,onSuccess:function(e){s.filterDocuments({docs:e,onSuccess:g,onError:_})},onError:function(e){_(i("Unable to retrieve documents"))}})}else _(i("Invalid search results returned"));else _(i("Invalid search results returned"))},onlyFinalResults:!0});e("#"+c);function g(t){if(t.length<1)e("#"+u).empty().text(i("No results returned by search"));else{var n=e("<table></table>");e("#"+u).empty().append(n);for(var r=0,o=t.length;r<o;++r){var a=t[r],l=a._id,c=e("<tr></tr>");n.append(c);var d=e("<td>").addClass("n2_search_result olkitSearchMod2_"+r%2).appendTo(c),h=e("<a>").attr("href","#"+l).attr("alt",l).appendTo(d).click(y(l));s.showService?s.showService.displayBriefDescription(h,{},a):h.text(l)}}}function y(t){return function(i){return o.onSelected(t),a=!1,e("#"+l).dialog("close"),!1}}function _(t){e("#"+u).empty().text(t)}e("#"+c).focus()}}),y=t.Class({dispatchService:null,documentSource:null,searchService:null,showService:null,schemaRepository:null,funcMap:null,atlasDesign:null,initialize:function(e){var i=t.extend({dispatchService:null,documentSource:null,searchService:null,showService:null,schemaRepository:null,funcMap:null,atlasDesign:null},e),n=this;for(var r in this.dispatchService=i.dispatchService,this.documentSource=i.documentSource,this.searchService=i.searchService,this.showService=i.showService,this.schemaRepository=i.schemaRepository,this.atlasDesign=i.atlasDesign,this.funcMap={},i.funcMap){var o=i.funcMap[r];"function"==typeof o&&(this.funcMap[r]=o)}if(this.funcMap.getDocumentId||(this.funcMap.getDocumentId=function(e){n.searchForDocumentId(e)}),this.funcMap.getLayers||(this.funcMap.getLayers=function(e){n.selectLayersDialog(e)}),!this.funcMap.getRelatedMedia){var s=new h({documentSource:this.documentSource,searchService:this.searchService,showService:this.showService});this.funcMap.getRelatedMedia=s.getDialogFunction()}if(!this.funcMap.getRelatedImage){var a=new p({documentSource:this.documentSource,searchService:this.searchService,showService:this.showService});this.funcMap.getRelatedImage=a.getDialogFunction()}if(!this.funcMap.getRelatedAudio){a=new f({documentSource:this.documentSource,searchService:this.searchService,showService:this.showService});this.funcMap.getRelatedAudio=a.getDialogFunction()}if(!this.funcMap.getRelatedVideo){a=new m({documentSource:this.documentSource,searchService:this.searchService,showService:this.showService});this.funcMap.getRelatedVideo=a.getDialogFunction()}if(!this.funcMap.getHoverSound){var l=new v({documentSource:this.documentSource,searchService:this.searchService,showService:this.showService});this.funcMap.getHoverSound=l.getDialogFunction()}if(!this.funcMap.getDocumentFromSchema){a=new d({atlasDesign:this.atlasDesign,showService:this.showService});this.funcMap.getDocumentFromSchema=a.getDialogFunction()}if(!this.funcMap.getDocumentFromLayer){a=new u({atlasDesign:this.atlasDesign,showService:this.showService});this.funcMap.getDocumentFromLayer=a.getDialogFunction()}},getFunctionMap:function(){return this.funcMap},addFunctionToMap:function(e,t){"function"==typeof t&&(this.funcMap[e]=t)},searchForDocumentId:function(e){var i=t.extend({onSelected:function(e){},onReset:function(){}},e);a({searchServer:this.searchService,showService:this.showService,onSelected:i.onSelected,onReset:i.onReset})},selectLayersDialog:function(e){var i=t.extend({currentLayers:[],onSelected:function(e){},onReset:function(){}},e);l({currentLayers:i.currentLayers,cb:i.onSelected,resetFn:i.onReset,showService:this.showService,dispatchService:this.dispatchService,documentSource:this.documentSource})},selectSchemaFromNames:function(e){var i=t.extend({schemaNames:[],onSelected:function(e){},onError:t.reportErrorForced,onReset:function(){}},e),n=this;this.schemaRepository.getSchemas({names:i.schemaNames,onSuccess:function(e){n.selectSchema({schemas:e,onSelected:i.onSelected,onError:i.onError,onReset:i.onReset})},onError:i.onError})},selectSchema:function(n){var o=t.extend({schemas:null,onSelected:function(e){},onError:t.reportErrorForced,onReset:function(){}},n),s=this;if(null!==o.schemas)if(o.schemas.length)if(1!=o.schemas.length){var a=t.getUniqueId(),l=e('<div id="'+a+'"></div>');if(!window.cordova){var c=e("<span></span>");c.text(i("Select schema")+": "),l.append(c)}var d=e("<select></select>");window.cordova&&d.addClass("cordova-select-dropdown"),l.append(d);for(var u=0,h=o.schemas.length;u<h;++u){var p=o.schemas[u],f=p.name,m=p.getLabel();e("<option>").text(m).val(f).appendTo(d)}l.append(e("<br/>"));var v,g,y,_=!0;window.cordova&&(v=e("<div></div>").addClass("cordova-button-container")),window.cordova?(g=e("<label></label>").text(i("Select")).addClass("cordova-dialog-btn"),v.append(g)):((g=e("<button></button>")).text(i("OK")),g.button({icons:{primary:"ui-icon-check"}}),l.append(g)),g.click(function(){_=!1;var t=e("#"+a),n=t.find("select").val();return t.dialog("close"),s.schemaRepository.getSchema({name:n,onSuccess:o.onSelected,onError:function(e){o.onError(i("Unable to fetch schema"))}}),!1}),window.cordova?(y=e("<label></label>").addClass("cordova-dialog-btn"),v.append(y)):((y=e("<button></button>")).button({icons:{primary:"ui-icon-cancel"}}),l.append(y)),y.text(i("Cancel")),y.click(function(){return e("#"+a).dialog("close"),!1}),window.cordova&&l.append(v);var S={autoOpen:!0,title:i("Select a schema"),modal:!0,resizable:!window.cordova,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove(),_&&o.onReset()},open:function(t,i){window.cordova&&e(".ui-dialog-titlebar-close",i.dialog|i).hide()}};if(window.cordova&&e("<style type='text/css'> .ui-dialog-title { font-size: large } </style>").appendTo("head"),window.cordova)S.maxWidth="300px";else{var b=r(740);"number"==typeof b&&(S.width=b)}l.dialog(S)}else o.onSelected(o.schemas[0]);else o.onReset();else this.schemaRepository.getRootSchemas({names:o.schemaNames,onSuccess:function(e){s.selectSchema({schemas:e,onSelected:o.onSelected,onError:o.onError,onReset:o.onReset})},onError:o.onError})}});t.couchDialogs={DialogService:y,SearchBriefDialogFactory:c,FilteredSearchDialogFactory:g,ProgressDialog:o,AlertDialog:s,SearchRelatedMediaDialogFactory:h}}(jQuery,nunaliit2),function(e){var t;"undefined"!=typeof OpenLayers&&(OpenLayers.Format.Couch=OpenLayers.Class(OpenLayers.Format,{dbProj:null,initialize:function(e){OpenLayers.Format.prototype.initialize.apply(this,[e]),this.dbProj=new OpenLayers.Projection("EPSG:4326")},read:function(t){try{for(var i=[],n=0,r=t.length;n<r;++n){var o=t[n],s=null,a=null;if(o._id&&(s=o._id),o.nunaliit_geom.wkt&&((a=OpenLayers.Geometry.fromWKT(o.nunaliit_geom.wkt))&&(e.olUtils.isValidGeom(a)||(a=null)),a||e.log("Invalid WKT("+o._id+"): "+o.nunaliit_geom.wkt)),s&&a){var l=new OpenLayers.Feature.Vector(a,o);l.fid=s,l.n2GeomProj=this.dbProj,i.push(l)}else e.log("Invalid feature",o)}return i}catch(r){e.log("Error during CouchDB format read",r)}return null},write:function(e){for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i],o=r.data;null==o&&(o={}),r.fid&&(o._id=r.fid);var s=r.geometry,a=r.layer.map.getProjectionObject();r.layer.projection&&a&&r.layer.projection.getCode()!=a.getCode()&&(s=s.clone()).transform(a,r.layer.projection),o.nunaliit_geom||(o.nunaliit_geom={nunaliit_type:"geometry"}),o.nunaliit_geom.wkt=s.toString();var l=s.getBounds();o.nunaliit_geom.bbox=[l.left,l.bottom,l.right,l.top],o.nunaliit_geom.simplified&&delete o.nunaliit_geom.simplified,t.push(o)}return t},CLASS_NAME:"OpenLayers.Format.Couch"}),OpenLayers.Protocol.Couch=OpenLayers.Class(OpenLayers.Protocol,{documentSource:null,layerName:null,callback:null,scope:null,notifications:null,wildcarded:!1,initialize:function(e){(e=e||{}).format||(e.format=new OpenLayers.Format.Couch),e.projection=new OpenLayers.Projection("EPSG:4326"),OpenLayers.Protocol.prototype.initialize.apply(this,arguments)},destroy:function(){OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(t){var i=this;this.notifications&&this.notifications.readStart&&this.notifications.readStart();var n=t.object;OpenLayers.Protocol.prototype.read.apply(this,arguments),t=OpenLayers.Util.applyDefaults(t,this.options);var r=new OpenLayers.Protocol.Response({requestType:"read"}),o=this.getBboxFromFilter(t.filter),s=this.getFidsFromFilter(t.filter),a="string"==typeof t.layerName?t.layerName:null,l=null;return n&&n.map&&(l=n.map.getProjectionObject().getCode()),this.documentSource.getDocumentsFromGeographicFilter({docIds:s,layerId:a,bbox:o,projectionCode:l,onSuccess:function(e){i.handleRead(r,t,e)},onError:function(t){e.log(t),i.notifications&&i.notifications.readEnd&&i.notifications.readEnd()}}),r},handleRead:function(t,i,n){var r=this;i.callback&&(t.features=this.format.read(n),e.olUtils.sortFeatures(t.features),t.code=OpenLayers.Protocol.Response.SUCCESS,i.callback.call(i.scope,t),window.setTimeout(function(){r.notifications&&r.notifications.readEnd&&r.notifications.readEnd()},0))},create:function(t,i){i=OpenLayers.Util.applyDefaults(i,this.options);var n=this.format.write(t);if(i.layerName)for(var r=0,o=n.length;r<o;++r){var s=n[r];s.nunaliit_layers||(s.nunaliit_layers=[]),jQuery.inArray(i.layerName,s.nunaliit_layers)<0&&s.nunaliit_layers.push(i.layerName)}var a=new OpenLayers.Protocol.Response({reqFeatures:t,requestType:"create"}),l=this;return this.db.bulkDocuments(n,{onSuccess:function(e){l.handleCreate(a,i,e)},onError:function(t){e.reportError(t)}}),a},handleCreate:function(t,i,n){var r=t.reqFeatures,o=[];if(r.length!=n.length)e.reportError(e.ERROR_NO_SUPRESS,"Invalid feature bulk create");else for(var s=0,a=n.length;s<a;++s){var l=r[s],c=n[s];c.error?c.reason?e.reportError(e.ERROR_NO_SUPRESS,c.error+" : "+c.reason):e.reportError(e.ERROR_NO_SUPRESS,c.error):(l.fid=c.id,l.data&&(l.data._id=c.id,l.data._rev=c.rev),l.attribute&&(l.attribute._id=c.id,l.attribute._rev=c.rev),o.push(l))}i.callback&&o.length>0&&(t.features=o,t.code=OpenLayers.Protocol.Response.SUCCESS,i.callback.call(i.scope,t))},update:function(t,i){i=i||{},i=OpenLayers.Util.applyDefaults(i,this.options);var n=this.format.write([t]),r=new OpenLayers.Protocol.Response({reqFeatures:t,requestType:"update"}),o=this;return this.db.updateDocument({data:n[0],onSuccess:function(e){o.handleUpdate(r,i,e)},onError:function(t){e.reportError(t)}}),r},handleUpdate:function(e,t,i){var n=e.reqFeatures;n.data&&(n.data._rev=i.rev),n.attribute&&(n.attribute._rev=i.rev),t.callback&&(e.features=[n],e.code=OpenLayers.Protocol.Response.SUCCESS,t.callback.call(t.scope,e))},delete:function(t,i){i=i||{},i=OpenLayers.Util.applyDefaults(i,this.options);var n=new OpenLayers.Protocol.Response({reqFeatures:t,requestType:"delete"}),r=this;return this.db.deleteDocument({data:t.data,onSuccess:function(e){r.handleDelete(n,i,e)},onError:function(t){e.reportError(t)}}),n},handleDelete:function(e,t){t.callback&&(e.code=OpenLayers.Protocol.Response.SUCCESS,t.callback.call(t.scope,e))},commit:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var i=[],n=0,r={};r[OpenLayers.State.INSERT]=[],r[OpenLayers.State.UPDATE]=[],r[OpenLayers.State.DELETE]=[];for(var o,s,a=[],l=0,c=e.length;l<c;++l)(s=r[(o=e[l]).state])&&(s.push(o),a.push(o));var d=(r[OpenLayers.State.INSERT].length>0?1:0)+r[OpenLayers.State.UPDATE].length+r[OpenLayers.State.DELETE].length,u=!0,h=new OpenLayers.Protocol.Response({reqFeatures:a});function p(e){this.callUserCallback(e,t),u=u&&e.success(),++n>=d&&t.callback&&(h.code=u?OpenLayers.Protocol.Response.SUCCESS:OpenLayers.Protocol.Response.FAILURE,t.callback.apply(t.scope,[h]))}var f=r[OpenLayers.State.INSERT];f.length>0&&i.push(this.create(f,OpenLayers.Util.applyDefaults({callback:function(e){for(var t=e.features?e.features.length:0,i=new Array(t),n=0;n<t;++n)i[n]=e.features[n].fid;h.insertIds=i,p.apply(this,[e])},scope:this},t.create)));for(l=(f=r[OpenLayers.State.UPDATE]).length-1;l>=0;--l)i.push(this.update(f[l],OpenLayers.Util.applyDefaults({callback:p,scope:this},t.update)));for(l=(f=r[OpenLayers.State.DELETE]).length-1;l>=0;--l)i.push(this.delete(f[l],OpenLayers.Util.applyDefaults({callback:p,scope:this},t.delete)));return i},abort:function(e){},callUserCallback:function(e,t){var i=t[e.requestType];i&&i.callback&&i.callback.call(i.scope,e)},getBboxFromFilter:function(e){if(!e)return null;if(e.type===OpenLayers.Filter.Spatial.BBOX)return[e.value.left,e.value.bottom,e.value.right,e.value.top];if(e.filters)for(var t=0,i=e.filters.length;t<i;++t){var n=this.getBboxFromFilter(e.filters[t]);if(n)return n}return null},getFidsFromFilter:function(e){if(!e)return null;if("OpenLayers.Filter.FeatureId"===e.CLASS_NAME)return e.fids;if(e.filters)for(var t=0,i=e.filters.length;t<i;++t){var n=this.getFidsFromFilter(e.filters[t]);if(n)return n}return null},CLASS_NAME:"OpenLayers.Protocol.Couch"}),(t=OpenLayers.Protocol.Couch.COMP_TYPE_TO_OP_STR={})[OpenLayers.Filter.Comparison.EQUAL_TO]="eq",t[OpenLayers.Filter.Comparison.NOT_EQUAL_TO]="ne",t[OpenLayers.Filter.Comparison.LESS_THAN]="lt",t[OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO]="lte",t[OpenLayers.Filter.Comparison.GREATER_THAN]="gt",t[OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO]="gte",t[OpenLayers.Filter.Comparison.LIKE]="ilike")}(nunaliit2),function(e){var t="n2.couchL10n",i=e.Class({db:null,designDoc:null,dispatchService:null,lookupViewName:null,translatedViewName:null,scriptList:null,isLoggedIn:null,pendingRequests:null,processingRequests:null,initialize:function(i){var n=e.extend({db:null,designDoc:null,dispatchService:null,lookupViewName:"l10n-all",translatedViewName:"l10n-translated",scriptList:"l10n"},i),r=this;if(this.db=n.db,this.designDoc=n.designDoc,this.dispatchService=n.dispatchService,this.lookupViewName=n.lookupViewName,this.translatedViewName=n.translatedViewName,this.scriptList=n.scriptList,this.pendingRequests=[],this.processingRequests=!1,this.isLoggedIn=!1,this.dispatchService){var o=function(e,t,i){r._handle(e,t,i)};this.dispatchService.register(t,"authLoggedIn",o),this.dispatchService.register(t,"authLoggedOut",o);var s={type:"authIsLoggedIn",isLoggedIn:!1};this.dispatchService.synchronousCall(t,s),s.isLoggedIn&&(this.isLoggedIn=!0)}e.l10n.sendTranslationRequest=function(e){r.sendTranslationRequest(e)},this._loadTranslatedStrings(),this._processPendingRequests()},sendTranslationRequest:function(t){e.log("Translate "+t.str+" to "+t.lang+" ("+t.packageName+")"),this.pendingRequests.push(t),this._processPendingRequests()},_handle:function(e,t,i){"authLoggedIn"===e.type?(this.isLoggedIn=!0,this._processPendingRequests()):"authLoggedOut"===e.type&&(this.isLoggedIn=!1)},_tryPostingRequests:function(){var i=this;if(this.pendingRequests.length<1)this.processingRequests=!1;else if(this.isLoggedIn){var n=this.pendingRequests.shift(),r=[n.lang,n.str];this.designDoc.queryView({viewName:this.lookupViewName,startkey:r,endkey:r,onSuccess:function(r){r.length<1?function(n){var r=null,o=null;if(i.dispatchService){var s={type:"authIsLoggedIn"};i.dispatchService.synchronousCall(t,s),o=s.context}o&&(r=o.name);var a=(new Date).getTime(),l={nunaliit_type:"translationRequest",nunaliit_schema:"translationRequest",str:n.str,lang:n.lang,packageName:n.packageName};r?(l.nunaliit_created={nunaliit_type:"actionstamp",name:r,time:a,action:"created"},l.nunaliit_last_updated={nunaliit_type:"actionstamp",name:r,time:a,action:"updated"},i.db.createDocument({data:l,onSuccess:function(){i._tryPostingRequests()},onError:function(t){e.reportError(t),i._tryPostingRequests()}})):(e.log("User not logged in. Translation request ignored."),i._tryPostingRequests())}(n):i._tryPostingRequests()},onError:function(t){e.log(t),i._tryPostingRequests()}})}else this.processingRequests=!1},_processPendingRequests:function(){this.processingRequests||(this.processingRequests=!0,this._tryPostingRequests())},_loadTranslatedStrings:function(){if(e.scripts){var t=e.l10n.getLocale().lang,i=this.designDoc.getQueryUrl({viewName:this.translatedViewName,listName:this.scriptList});i+='?startkey="'+t+'"&endkey="'+t+'"&include_docs=true&reduce=false';var n=e.scripts.getCoreScriptLocation();e.scripts.loadScript({url:i,scriptLocation:n})}}});e.couchL10n={LocalizationService:i}}(nunaliit2),function(e){var t,i="n2.couchMap";function n(){var e=null;if(t){var n={type:"authIsLoggedIn"};t.synchronousCall(i,n),e=n.context}return e}function r(){var t=!1,i=n();if(i&&i.roles&&(-1!==e.inArray("_admin",i.roles)&&(t=!0),-1!==e.inArray("administrator",i.roles)&&(t=!0),"object"==typeof n2atlas&&"string"==typeof n2atlas.name)){var r=n2atlas.name+"_administrator";-1!==e.inArray(r,i.roles)&&(t=!0)}return t}function o(e){if(r())return!0;var t=null,i={},o=n();if(o&&(t=o.name,o.roles))for(var s=0,a=o.roles.length;s<a;++s)i[o.roles[s]]=!0;if("object"==typeof n2atlas&&n2atlas.submissionDbEnabled&&t)return!0;var l=!1;if(e.nunaliit_layers&&e.nunaliit_layers.length){for(s=0,a=e.nunaliit_layers.length;s<a;++s){var c=e.nunaliit_layers[s];if("public"===c);else if("public_"===c.substr(0,7));else{l=!0;if(!i["object"==typeof n2atlas&&"string"==typeof n2atlas.name?n2atlas.name+"_layer_"+c:"layer_"+c])return!1}}if(l)return!0}return!(!e.nunaliit_created||!e.nunaliit_created.nunaliit_type||"actionstamp"!==e.nunaliit_created.nunaliit_type||e.nunaliit_created.name!==t)}e.couchMap={Configure:function(i){var n=e.extend({dispatchService:null},i);n.dispatchService&&(t=n.dispatchService)},adjustDocument:function(t){e.couchDocument.adjustDocument(t)},isAdmin:r,canEditDoc:o,canDeleteDoc:function(e){return o(e)},documentContainsMedia:function(e){var t=!1;if(e.nunaliit_attachments&&e.nunaliit_attachments.files)for(var i in e.nunaliit_attachments.files)t=!0;return t},documentContainsApprovedMedia:function(e){var t=!1;if(e.nunaliit_attachments&&e.nunaliit_attachments.files)for(var i in e.nunaliit_attachments.files){var n=e.nunaliit_attachments.files[i];"approved"!==n.status&&"attached"!==n.status||(t=!0)}return t},documentContainsDeniedMedia:function(e){var t=!1;if(e.nunaliit_attachments&&e.nunaliit_attachments.files)for(var i in e.nunaliit_attachments.files)"denied"===e.nunaliit_attachments.files[i].status&&(t=!0);return t}}}(nunaliit2),function(e,t){var i="n2.couchRequests";function n(e,t){this.pending={},this.docsbyId={},this.cbFn=e,this.multipleDocs=t}n.prototype.waitForDocId=function(e){this.pending[e]=!0},n.prototype.continueDocId=function(e){delete this.pending[e]},n.prototype.isPending=function(){for(var e in this.pending)return!0;return!1},n.prototype.receiveDocument=function(e){var t=e._id;this.docsbyId[t]&&(this.docsbyId[t]=e),this.pending[t]&&(delete this.pending[t],this.docsbyId[t]=e)},n.prototype.callListener=function(){if("function"==typeof this.cbFn){if(this.multipleDocs){var e=[];for(var t in this.docsbyId){var i=this.docsbyId[t];e.push(i)}this.cbFn(e)}else for(var t in this.docsbyId){i=this.docsbyId[t];this.cbFn(i)}this.cbFn=null}};var r=new n;r.waitForDocId=function(){},r.continueDocId=function(){},r.isPending=function(){return!1},r.receiveDocument=function(){},r.callListener=function(){},t.couchRequests=t.Class({options:null,currentRequests:null,scheduled:null,userListeners:null,documentListeners:null,initialize:function(e){this.options=t.extend({},{documentSource:null,userDb:null,dispatchService:null,userServerUrl:null},e);var n=this;if(this.currentRequests={},this.scheduled=!1,this.userListeners=[],this.documentListeners=[],this.options.dispatchService){var r=function(e){n._handleMessage(e)};this.options.dispatchService.register(i,"requestDocument",r),this.options.dispatchService.register(i,"requestDocuments",r),this.options.dispatchService.register(i,"requestUserDocument",r),this.options.dispatchService.register(i,"requestUserDocumentComplete",r),this.options.dispatchService.register(i,"requestLayerDefinition",r),this.options.dispatchService.register(i,"requestLayerDefinitions",r)}},addUserListener:function(e){"function"==typeof e&&this.userListeners.push(e)},addDocumentListener:function(e){"function"==typeof e&&this.documentListeners.push(e)},requestUser:function(e){this.currentRequests.users||(this.currentRequests.users={}),this.currentRequests.users[e]=1,this._schedule()},requestCompleteUserDocument:function(e){this.currentRequests.completeUsers||(this.currentRequests.completeUsers={}),this.currentRequests.completeUsers[e]=1,this._schedule()},requestDocument:function(e,t){this.currentRequests.docs||(this.currentRequests.docs={}),this.currentRequests.docs[e]||(this.currentRequests.docs[e]=[]);var i=void 0;(i=t?new n(t):r).waitForDocId(e),this.currentRequests.docs[e].push(i),this._schedule()},requestDocuments:function(e,t){var i=this;this.currentRequests.docs||(this.currentRequests.docs={});var o=void 0;o=t?new n(t,!0):r,e.forEach(function(e){o.waitForDocId(e),i.currentRequests.docs[e]||(i.currentRequests.docs[e]=[]),i.currentRequests.docs[e].push(o)}),this._schedule()},requestLayerDefinition:function(e){this.currentRequests.layerIds||(this.currentRequests.layerIds={}),this.currentRequests.layerIds[e]=!0,this._schedule()},requestLayerDefinitions:function(e){var i=this;t.isArray(e)&&e.forEach(function(e){"string"==typeof e&&i.requestLayerDefinition(e)})},_schedule:function(){if(!this.scheduled){var e=this;this.scheduled=!0,setTimeout(function(){e.scheduled=!1,e._performRequests()},0)}},_performRequests:function(){var t=this,i=this.currentRequests;if(this.currentRequests={},i.users&&this.options.userServerUrl){var n=[];for(var r in i.users)n.push({name:"user",value:r});var o=this.options.userServerUrl+"getUsers";e.ajax({url:o,type:"GET",async:!0,traditional:!0,data:n,dataType:"json",success:function(e){if(e.users)for(var i=0,n=e.users.length;i<n;++i){var r=e.users[i];t._callUserListeners(r)}},error:function(e,t,i){}})}else if(i.users&&this.options.userDb)for(var r in i.users)this.options.userDb.getUser({name:r,onSuccess:function(e){t._callUserListeners(e)},onError:function(e){}});if(i.completeUsers&&this.options.userServerUrl){n=[];for(var r in i.completeUsers)n.push({name:"user",value:r});o=this.options.userServerUrl+"getUserDocuments";e.ajax({url:o,type:"GET",async:!0,traditional:!0,data:n,dataType:"json",success:function(e){if(e.users)for(var i=0,n=e.users.length;i<n;++i){var r=e.users[i];t._callCompleteUserListeners(r)}},error:function(e,t,i){}})}var s=null;if(i.docs&&this.options.documentSource){var a=[];for(var l in i.docs){var c=this._getCachedDoc(l);c?(s||(s=[]),s.push(c)):a.push(l)}if(a.length){var d=a;if(d.length>25){var u=d.splice(25),h=this.currentRequests.docs;h||(h={},this.currentRequests.docs=h),u.forEach(function(e){h[e]=i.docs[e]}),this._schedule()}this.options.documentSource.getDocuments({docIds:d,onSuccess:function(e){t._callDocumentListeners(e,i,!0,d)}})}}if(null!==s&&this._callDocumentListeners(s,i,!1),i.layerIds&&this.options.documentSource){var p=[];for(var f in i.layerIds)p[p.length]=f;p.length>0&&this.options.documentSource.getLayerDefinitions({layerIds:p,fullDocuments:!0,onSuccess:function(e){t._callDocumentListeners(e,i,!0)}})}},_callUserListeners:function(e){this._dispatch({type:"userInfo",userInfo:e});for(var t=0,i=this.userListeners.length;t<i;++t){(0,this.userListeners[t])(e)}},_callCompleteUserListeners:function(e){this._dispatch({type:"userDocument",userDoc:e})},_callDocumentListeners:function(e,t,i,n){for(var r=0,o=e.length;r<o;++r){var s=e[r];i&&this._dispatch({type:"documentVersion",docId:s._id,rev:s._rev}),this._dispatch({type:"documentContent",docId:s._id,doc:s});for(var a=0,l=this.documentListeners.length;a<l;++a){(0,this.documentListeners[a])(s)}var c=s._id;if(t.docs&&t.docs[c])t.docs[c].forEach(function(e){e.receiveDocument(s)})}if(n&&n.forEach(function(e){t.docs&&t.docs[e]&&t.docs[e].forEach(function(t){t.continueDocId(e)})}),t.docs)for(var c in t.docs){t.docs[c].forEach(function(e){e.isPending()||e.callListener()})}},_getDispatcher:function(){var e=null;return this.options.dispatchService&&(e=this.options.dispatchService),e},_dispatch:function(e){var t=this._getDispatcher();t&&t.send(i,e)},_handleMessage:function(e){if("requestDocument"===e.type){var t=e.docId;this.requestDocument(t,e.callback)}else if("requestDocuments"===e.type){var i=e.docIds;this.requestDocuments(i,e.callback)}else if("requestUserDocument"===e.type){var n=e.userId;this.requestUser(n)}else if("requestUserDocumentComplete"===e.type){n=e.userId;this.requestCompleteUserDocument(n)}else if("requestLayerDefinition"===e.type){var r=e.layerId;this.requestLayerDefinition(r)}else if("requestLayerDefinitions"===e.type){var o=e.layerIds;this.requestLayerDefinitions(o)}},_getCachedDoc:function(e){var t=this._getDispatcher();if(t){var n={type:"cacheRetrieveDocument",docId:e,doc:null};if(t.synchronousCall(i,n),n.doc)return n.doc}return null}})}(jQuery,nunaliit2),function(e,t){var i="n2.couch.sound";function n(e){}function r(e,t){t(e)}var o=t.Class({db:null,dispatcher:null,requestService:null,customService:null,handleDocumentSound:null,currentFocusDocIdMap:null,initialize:function(e){var n=t.extend({db:null,dispatchService:void 0,requestService:void 0,customService:void 0,handleDocumentSound:r},e),o=this;if(this.db=n.db,this.dispatcher=n.dispatchService,this.requestService=n.requestService,this.customService=n.customService,this.handleDocumentSound=n.handleDocumentSound,this.currentFocusDocIdMap={},this.dispatcher){var s=function(e){o._handleDispatch(e)};this.dispatcher.register(i,"focusOn",s),this.dispatcher.register(i,"focusOff",s),this.dispatcher.register(i,"playHoverSoundOn",s),this.dispatcher.register(i,"playHoverSoundOff",s),this.dispatcher.register(i,"playSoundOn",s),this.dispatcher.register(i,"playSoundOff",s)}},handleFeatureHover:function(e,t){if(e){var i=e.attributes;i||(i=e.data),i&&this.findDocumentHoverSound(i,t)}},findDocumentHoverSound:function(e,i){var r=t.extend({installSoundFn:n,handleDocumentSound:this.handleDocumentSound},i),o=this;if(e){var s={docId:e._id,doc:e,soundUrl:null,installSoundFn:r.installSoundFn};r.handleDocumentSound(s,function(e){o._defaultDocumentSound(e)})}},_defaultDocumentSound:function(e){e.soundUrl?e.installSoundFn(e):s({db:this.db,requestService:this.requestService,doc:e.doc,onSuccess:function(t){e.soundUrl=t,e.installSoundFn(e)}})},_handleDispatch:function(e){var t=this;if("focusOn"===e.type){if(e.doc){for(var i in this.currentFocusDocIdMap)this._removeFocusSound(i);this.currentFocusDocIdMap={},this.currentFocusDocIdMap[e.doc._id]=!0,this.findDocumentHoverSound(e.doc,{installSoundFn:function(e){t._installFocusSound(e)}})}else if(e.docs){for(var i in this.currentFocusDocIdMap)this._removeFocusSound(i);this.currentFocusDocIdMap={};var n=!0;if(e.docs.length>1&&(n=!!this.customService&&this.customService.getOption("soundPlayMultipleOnFocus",!1)),n)for(var r=0,o=e.docs.length;r<o;++r){var s=e.docs[r];this.currentFocusDocIdMap[s._id]=!0,this.findDocumentHoverSound(s,{installSoundFn:function(e){t._installFocusSound(e)}})}}else if(e.docId){for(var i in this.currentFocusDocIdMap)this._removeFocusSound(i);this.currentFocusDocIdMap={},this.currentFocusDocIdMap[e.docId]=!0,this.requestService&&this.requestService.requestDocument(e.docId,function(i){t.currentFocusDocIdMap[e.docId]&&t.findDocumentHoverSound(i,{installSoundFn:function(e){t._installFocusSound(e)}})})}else if(e.docIds){for(var i in this.currentFocusDocIdMap)this._removeFocusSound(i);this.currentFocusDocIdMap={};n=!0;if(e.docIds.length>1&&(n=!!this.customService&&this.customService.getOption("soundPlayMultipleOnFocus",!1)),n)for(r=0,o=e.docIds.length;r<o;++r)this.currentFocusDocIdMap[e.docId]=!0,this.requestService&&this.requestService.requestDocument(e.docId,function(i){t.currentFocusDocIdMap[e.docId]&&t.findDocumentHoverSound(i,{installSoundFn:function(e){t._installFocusSound(e)}})})}}else if("focusOff"===e.type)for(var i in this.currentFocusDocIdMap)this._removeFocusSound(i);else if("playHoverSoundOn"===e.type)e.doc&&(this._initiatePlaySound(e.doc._id),this.findDocumentHoverSound(e.doc,{installSoundFn:function(e){t._installPlaySound(e)}}));else if("playHoverSoundOff"===e.type)e.doc&&this._removePlaySound(e.doc._id);else if("playSoundOn"===e.type){if(e.id&&e.url){this._initiatePlaySound(e.id);var a={docId:e.id,soundUrl:e.url};this._installPlaySound(a)}}else"playSoundOff"===e.type&&e.id&&this._removePlaySound(e.id)},_installFocusSound:function(e){var t=e.docId,i=e.soundUrl;if(i&&this.currentFocusDocIdMap[t]){var n=this._getFocusSoundDiv(),r=this._computeFocusClassName(t);this._insertSoundElement(n,i,r)}},_removeFocusSound:function(e){var t=this._computeFocusClassName(e);this._getFocusSoundDiv().find("."+t).remove()},_computeFocusClassName:function(e){return"n2SoundFocus_"+t.utils.stringToHtmlId(e)},_initiatePlaySound:function(i){var n="n2CouchPlaySound_"+t.utils.stringToHtmlId(i),r=e("#"+n);r.length<1&&(r=e('<div id="'+n+'"></div>'),this._getSoundDiv().append(r))},_installPlaySound:function(i){var n=i.docId,r=i.soundUrl,o=e("#n2CouchPlaySound_"+t.utils.stringToHtmlId(n));this._insertSoundElement(o,r)},_removePlaySound:function(i){e("#n2CouchPlaySound_"+t.utils.stringToHtmlId(i)).remove()},_getSoundDiv:function(){var t=e("#n2CouchSound");return t.length<1&&(t=e("<div>").attr("id","n2CouchSound").addClass("n2CouchSound").appendTo(e("body"))),t},_getFocusSoundDiv:function(){var t=e("#n2CouchFocusSound");if(t.length<1){var i=this._getSoundDiv();t=e("<div>").attr("id","n2CouchFocusSound").addClass("n2CouchFocusSound").appendTo(i)}return t},_insertSoundElement:function(i,n,r){var o=t.utils.getBrowserInfo();if(t.log("browser info",o),"Safari"===o.browser){var s=this._generateHtml5Tag({url:n,sourceType:"audio",autoplay:!0,loop:!1,controller:!1}),a=e(s);r&&a.addClass(r),i.append(a)}else{a=e("<embed>").attr("src",n).attr("autostart",!0).attr("loop",!1);r&&a.addClass(r),a.css("visibility","hidden"),i.append(a)}},_generateHtml5Tag:function(e){var i=t.extend({url:null,sourceType:null,mimeType:null,width:null,height:null,autoplay:!1,loop:!1,controller:!1},e),n=[];if("video"===i.sourceType)n.push("<video");else{if("audio"!==i.sourceType)return null;n.push("<audio")}if(i.width&&n.push(' width="'+i.width+'"'),i.height&&n.push(' height="'+i.height+'"'),i.controller&&n.push(' controls="controls"'),i.autoplay&&n.push(' autoplay="autoplay"'),n.push(' src="'),n.push(i.url),n.push('"'),i.mimeType&&n.push(' type="'+i.mimeType+'"'),n.push(">"),n.push("<embed"),i.width&&n.push(' width="'+i.width+'"'),i.height&&n.push(' height="'+i.height+'"'),i.autoplay?n.push(' autoplay="true"'):n.push(' autoplay="false"'),i.controller&&n.push(' controller="true"'),i.loop&&n.push(' loop="true"'),n.push(' src="'),n.push(i.url),n.push('"></embed>'),"video"===i.sourceType)n.push("</video>");else{if("audio"!==i.sourceType)return null;n.push("</audio>")}return n.join("")}}),s=function(e){var i=t.extend({db:null,requestService:null,doc:null,onSuccess:function(e){},onError:function(e){}},e),n=i.doc,r=null;if(i&&(r=i.requestService),!r&&i.serviceDirectory&&(r=i.serviceDirectory.requestService),r)if(n.sound&&n.sound.nunaliit_type&&"reference"===n.sound.nunaliit_type&&n.sound.doc){var o=i.db.getAttachmentUrl(n.sound.doc,"converted");i.onSuccess(o)}else{if(n.nunaliit_attachments&&"attachment_descriptions"===n.nunaliit_attachments.nunaliit_type&&n.nunaliit_attachments.files){var s=null;for(var a in n.nunaliit_attachments.files){var l=n.nunaliit_attachments.files[a];if(l&&l.data&&l.data.hoverSound){s=a;break}}if(s){o=i.db.getAttachmentUrl(n,a);return void i.onSuccess(o)}}if(n.nunaliit_hoverSound&&"reference"===n.nunaliit_hoverSound.nunaliit_type&&n.nunaliit_hoverSound.doc){var c=n.nunaliit_hoverSound.doc;r.requestDocument(c,function(e){if(e&&e.nunaliit_attachments&&e.nunaliit_attachments.files)for(var t in e.nunaliit_attachments.files){var n=e.nunaliit_attachments.files[t];if(e._attachments&&e._attachments[t]&&"audio"==n.fileClass){var r=i.db.getAttachmentUrl(e._id,t);return void i.onSuccess(r)}}i.onError("Can not find sound url")})}else i.onError("Can not find sound url")}else i.onError("Request service not available")};t.couchSound={HoverSoundService:o,GetHoverSoundUrlFromDocument:s,DocumentContainsHoverSound:function(e){if(e.sound&&e.sound.nunaliit_type&&"reference"===e.sound.nunaliit_type&&e.sound.doc)return!0;if(e.nunaliit_attachments&&"attachment_descriptions"===e.nunaliit_attachments.nunaliit_type&&e.nunaliit_attachments.files){var t=null;for(var i in e.nunaliit_attachments.files){var n=e.nunaliit_attachments.files[i];if(n&&n.data&&n.data.hoverSound){t=i;break}}if(t)return!0}return!(!e.nunaliit_hoverSound||"reference"!==e.nunaliit_hoverSound.nunaliit_type||!e.nunaliit_hoverSound.doc)}}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchAuth",r=function(e,t){var n=[];if(e){n.push(""+e.message);for(var r=e.cause;r;)n.push("\n>"+r.message),r=r.cause}else n.push(i("<Unknown error>"));alert(n.join(""))},o=t.Class({options:null,couchServer:null,loginStateListeners:null,lastAuthSessionCookie:null,lastSessionContext:null,userServiceAvailable:null,autoRegistrationAvailable:null,currentUserDoc:null,initialize:function(o){var s=this;if(this.options=t.extend({onSuccess:function(e,t){},onError:r,atlasDb:null,schemaRepository:null,disableCreateUserButton:!1,directory:null,listeners:null,autoRefresh:!0,prompt:i("Please login"),refreshIntervalInSec:2,userServerUrl:null},o),this.loginStateListeners=[],this.lastAuthSessionCookie=null,this.lastSessionContext=null,this.userServiceAvailable=!1,this.autoRegistrationAvailable=!1,this.couchServer=void 0,this.options.directory&&(this.couchServer=this.options.directory.couchServer),!this.couchServer)return t.log("Couch Server must be specified for CouchDb AuthService"),void this.options.onError(i("Server must be specified for CouchDb AuthService"));this.options.listeners&&(this.addListeners(this.options.listeners),delete this.options.listeners);var a=this.options.onSuccess;delete this.options.onSuccess;var l=this.options.onError;delete this.options.onError;var c=t.extend({},this.options,{onSuccess:a,onError:l});this.couchServer.getSession().refreshContext({onSuccess:function(e){t.log("Login(adjustCookies) successful",e,s.options),a(e,c),s._notifyListeners()},onError:function(e){t.log("Login(adjustCookies) error: "+e),l({message:"Problem initializing authentication library",cause:{message:e}},c),s._notifyListeners()}}),this.couchServer.getSession().addChangedContextListener(function(e){s._handleSessionContextChange(e)}),this.options.autoRefresh&&this.options.refreshIntervalInSec>0&&"function"==typeof setInterval&&(setInterval(function(){s.couchServer.getSession().refreshContext({onError:function(){}})},1e3*this.options.refreshIntervalInSec),setInterval(function(){var e=t.cookie.getCookie("NunaliitAuth");e!==s.lastAuthSessionCookie&&(s.lastAuthSessionCookie=e,s.couchServer.getSession().refreshContext({onError:function(){}}))},2e3));var d=this._getDispatcher();if(d){var u=function(e){s._handleEvent(e)};d.register(n,"login",u),d.register(n,"loginShowForm",u),d.register(n,"logout",u),d.register(n,"authIsLoggedIn",u)}if(this.options.userServerUrl){var h=this.options.userServerUrl;e.ajax({url:h,type:"GET",async:!0,traditional:!0,data:null,dataType:"json",success:function(e){s.userServiceAvailable=!0,e.autoRegistration&&(s.autoRegistrationAvailable=!0)},error:function(e,t,i){}})}},addListeners:function(e){var i=this,n=this._getCurrentListenerInfo();if("function"==typeof e)s(e);else if(t.isArray(e))for(var r=0;r<e.length;++r){var o=e[r];"function"==typeof o&&s(o)}function s(e){i.loginStateListeners.push(e);try{e(n)}catch(e){t.log("CouchAuthService: EXCEPTION caught in listener (add)",e)}}},_notifyListeners:function(){var i=this._getAuthContext(),n=null;i&&(n=i.name);var r=!1;i&&i.roles&&this.doRolesContainAdmin(i.roles)&&(r=!0),t.cookie.setCookie({name:"NunaliitAuth",value:n,path:"/"});var o=e("body");n?(o.removeClass("nunaliit_logged_out"),o.addClass("nunaliit_logged_in")):(o.removeClass("nunaliit_logged_in"),o.removeClass("nunaliit_user_advanced"),o.addClass("nunaliit_logged_out")),r?o.addClass("nunaliit_user_administrator"):o.removeClass("nunaliit_user_administrator"),n?this._dispatch({type:"authLoggedIn",user:i}):this._dispatch({type:"authLoggedOut"});for(var s=this._getCurrentListenerInfo(),a=0;a<this.loginStateListeners.length;++a){var l=this.loginStateListeners[a];if(l)try{l(s)}catch(e){t.log("CouchAuthService: EXCEPTION caught in listener (notify)",e)}}},_getCurrentListenerInfo:function(){var e=this._getAuthContext(),t=null;return e&&e.name&&(t={name:e.name,roles:e.roles}),t},login:function(n){var r=t.extend({username:null,password:null,onSuccess:function(e){},onError:function(e){}},n),o=this,s=r.username,a=r.password;if("string"==typeof s&&"string"==typeof a)if(this.userServiceAvailable){var l=this.options.userServerUrl+"getUser";e.ajax({url:l,type:"GET",async:!0,traditional:!0,data:{email:s},dataType:"json",success:function(e){e.name&&(s=e.name),c()},error:c})}else c();else r.onError("Name and password must be provided when logging in");function c(){o.couchServer.getSession().login({name:s,password:a,onSuccess:d,onError:function(e){t.log("Unable to log in: "+e),f(i("Invalid e-mail and/or password"))}})}function d(n){o.couchServer.getUserDb().getUser({name:s,onSuccess:function(r){var s="nunaliit_agreement_"+o._getAtlasName();if(r&&r.roles)for(var a=0,l=r.roles.length;a<l;++a){if(r.roles[a]===s)return void h(n,r)}!function(n,r){o.options.atlasDb.getDocument({docId:"org.nunaliit.user_agreement",onSuccess:function(o){if(o&&o.nunaliit_user_agreement&&o.nunaliit_user_agreement.content&&o.nunaliit_user_agreement.enabled){var s=o.nunaliit_user_agreement.content;"object"==typeof o.nunaliit_user_agreement.content&&"localized"===o.nunaliit_user_agreement.content.nunaliit_type&&(s=i(o.nunaliit_user_agreement.content));var a=!1,l=t.getUniqueId(),c=e("<div>").attr("id",l),d=e("<div>").addClass("n2Auth_user_agreement_dialog").appendTo(c);e("<div>").addClass("n2Auth_user_agreement_label").text(i("User agreement has changed. You must accept before you can authenticate.")).appendTo(d),e("<textarea>").addClass("n2Auth_user_agreement_content").attr("readonly","readonly").val(s).appendTo(d);var h=e("<div>").addClass("n2Auth_user_agreement_buttons").appendTo(d);e("<button>").addClass("n2_button_ok").text(i("Accept")).click(function(){a=!0;var t=e("#"+l);t.dialog("close"),u(s,n,r)}).appendTo(h),e("<button>").addClass("n2_button_cancel").text(i("Reject")).click(function(){var t=e("#"+l);t.dialog("close")}).appendTo(h),c.dialog({autoOpen:!0,title:i("User Agreement and Terms of Service"),modal:!0,width:"auto",close:function(t,n){var r=e("#"+l);r.remove(),a||f(i("User refused agreement"))}})}else u("",n,r)},onError:function(e){t.log("Error getting user agreement: "+e),f(i("Unable to obtain user agreement"))}})}(n,r)},onError:function(e){var r=!1;if(n&&n.roles)for(var o=0,s=n.roles.length;o<s;++o){if("_admin"===n.roles[o]){r=!0;break}}r?h(n,null):(t.log("Unable to obtain user information: "+e),f(i("Unable to obtain information about user")))}})}function u(t,n,r){var s=o.options.userServerUrl+"acceptUserAgreement";e.ajax({url:s,type:"POST",async:!0,traditional:!0,data:{userAgreement:t},dataType:"json",success:function(){h(n,r)},error:function(e,t,n){f(i("Error attempting to accept user agreement"))}})}function h(n,r){r&&o.options.schemaRepository?o.options.schemaRepository.getSchema({name:"nunaliit_user_questions",onSuccess:function(s){var a=s.createObject();if(!a.version)return t.log("User questions found without a version number. Ignored."),void p(n,r);var l=o._getAtlasName(),c=null;r&&r.nunaliit_answers&&(c=r.nunaliit_answers[l]);var d=!1;c?c.version!=a.version&&(d=!0):(d=!0,c=a),d?function(n,r,s,a){var l=t.getUniqueId(),c=e("<div>").attr("id",l),d=e("<div>").addClass("n2Auth_user_questions_dialog").appendTo(c),u=e("<div>").addClass("n2Auth_user_questions_form").appendTo(d);s.form(a,u);var h=e("<div>").addClass("n2Auth_user_questions_buttons").appendTo(d);e("<button>").addClass("n2_button_ok").text(i("OK")).click(function(){var s=e("#"+l);s.dialog("close"),function(e,n,r){function s(n){t.log("Error saving user answers",n),alert(i("There was a problem saving your answers. You will be prompted again next time you log in.")),p(e)}function a(){o.couchServer.getUserDb().getUser({id:n._id,onSuccess:function(t){p(e,t)},onError:function(i){t.log("Error retrieving updated version of user document",i),p(e,n)}})}o.couchServer.getUserDb().getUser({name:n.name,onSuccess:function(e){var t=o._getAtlasName();e.nunaliit_answers||(e.nunaliit_answers={}),e.nunaliit_answers[t]=r,o.couchServer.getUserDb().updateDocument({data:e,onSuccess:a,onError:s})},onError:s})}(n,r,a)}).appendTo(h),e("<button>").addClass("n2_button_cancel").text(i("Remind me later")).click(function(){var t=e("#"+l);t.dialog("close"),p(n,r)}).appendTo(h),c.dialog({autoOpen:!0,title:i("User Questionnaire"),modal:!0,width:"auto",close:function(t,i){var n=e("#"+l);n.remove()}})}(n,r,s,c):p(n,r)},onError:function(e){p(n,r)}}):p(n,r)}function p(e,i){var n=o.couchServer.getSession().getContext();t.log("Login successful",n,r),n&&n.name?(r.onSuccess(n),o._notifyListeners()):m()}function f(e){o.couchServer.getSession().logout({onError:function(){}}),t.log("Login error",e),m(e)}function m(e){e?r.onError(e):r.onError(i("Invalid e-mail and/or password")),o._notifyListeners()}},_fillDialogWithLogin:function(n,r){var o=t.extend({prompt:null,userName:null,onSuccess:function(e){},onError:function(e){}},r),s=this,a=e("#"+n),l=e('<div class="n2Auth_login"></div>'),c=e("<form></form>").appendTo(l),d=e('<div class="n2Auth_login_user_line"></div>').appendTo(c),u=i("user name");this.autoRegistrationAvailable&&(u=i("e-mail address"));var h="";o.userName&&(h=o.userName);var p=e('<div class="n2Auth_login_input"></div>').appendTo(d);e('<input class="n2Auth_user_input n2Auth_input_field" type="text" name="username"/>').val(h).appendTo(p),e('<div class="n2Auth_login_label"></div>').text(u).appendTo(p);var f=e('<div class="n2Auth_login_pw_line"></div>').appendTo(c),m=e('<div class="n2Auth_login_input"></div>').appendTo(f);e('<input class="n2Auth_pw_input n2Auth_input_field" type="password" name="password"/>').appendTo(m),e('<div class="n2Auth_login_label"></div>').text(i("password")).appendTo(m);var v=e('<div class="n2Auth_login_button_line"></div>').appendTo(c);if(e('<input type="submit" class="n2Auth_button_login"></input>').appendTo(v).val(i("Login")).click(function(){var t,i,r;return t=e("#"+n),i=t.find(".n2Auth_user_input").val(),r=t.find(".n2Auth_pw_input").val(),s.login({username:i,password:r,onSuccess:o.onSuccess,onError:o.onError}),!1}),!this._shouldDisableCreateUserButton()){var g=e('<div class="n2Auth_login_create_line"></div>').appendTo(l);e('<a class="n2Auth_button_createUser" href="#"></a>').appendTo(g).text(i("Create a new user")).click(function(){var t=e("#"+n).find(".n2Auth_user_input").val();return o.userName=t,s._fillDialogWithUserCreation(n,o),!1})}if(this.autoRegistrationAvailable){var y=e('<div class="n2Auth_login_recover_line"></div>').appendTo(l);e('<a class="n2Auth_button_recoverPassword" href="#"></a>').appendTo(y).text(i("Reset password?")).click(function(){var t=e("#"+n).find(".n2Auth_user_input").val();return o.userName=t,s._fillDialogWithPasswordRecovery(n,o),!1})}a.empty().append(l),o.prompt?a.dialog("option","title",o.prompt):a.dialog("option","title",i("Please login"))},_fillDialogWithUserCreation:function(n,r){if(this.autoRegistrationAvailable)this._fillDialogWithUserAutoRegistration(n,r);else{var o=t.extend({prompt:null,userName:null,onSuccess:function(e){},onError:function(e){}},r),s=this,a=e("#"+n);a.empty();var l=e("<div>").addClass("n2Auth_create").appendTo(a),c=e("<div>").addClass("n2Auth_create_user_line").appendTo(l),d=e("<div>").addClass("n2Auth_create_input").appendTo(c);e('<input type="text" autofocus>').addClass("n2Auth_user_input n2Auth_input_field").appendTo(d),e("<div>").addClass("n2Auth_create_label").text(i("user name")).appendTo(d);var u=e("<div>").addClass("n2Auth_create_display_line").appendTo(l),h=e("<div>").addClass("n2Auth_create_input").appendTo(u);e('<input type="text">').addClass("n2Auth_display_input n2Auth_input_field").appendTo(h),e("<div>").addClass("n2Auth_create_label").text(i("display name")).appendTo(h);var p=e("<div>").addClass("n2Auth_create_pw1_line").appendTo(l),f=e("<div>").addClass("n2Auth_create_input").appendTo(p);e('<input type="password">').addClass("n2Auth_pw_input n2Auth_input_field").appendTo(f),e("<div>").addClass("n2Auth_create_label").text(i("password")).appendTo(f);var m=e("<div>").addClass("n2Auth_create_pw2_line").appendTo(l),v=e("<div>").addClass("n2Auth_create_input").appendTo(m);if(e('<input type="password">').addClass("n2Auth_pw_input2 n2Auth_input_field").appendTo(v),e("<div>").addClass("n2Auth_create_label").text(i("confirm password")).appendTo(v),o.userName){var g=a.find(".n2Auth_user_input");g.val(o.userName),g.addClass("n2_input_detected")}var y=e("<div>").addClass("n2Auth_create_button_line").appendTo(l);e("<button>").addClass("n2Auth_button_create").text(i("Create User")).appendTo(y).click(function(){return _(),!1}),a.find(".n2Auth_input_field").keydown(function(e){var t=null;null===e&&(e=window.event),null!==e&&e.keyCode&&(t=e.keyCode),13===t&&_()}),a.dialog("option","title",i("User Creation"))}function _(){var t=e("#"+n),r=t.find(".n2Auth_user_input").val(),a=t.find(".n2Auth_display_input").val(),l=t.find(".n2Auth_pw_input").val(),c=t.find(".n2Auth_pw_input2").val();return null==r||r.length<3?(alert(i("User name should have at least 3 characters")),!1):l!=c?(alert(i("The two passwords should match")),!1):null==l||l.length<6?(alert(i("Password should have at least 6 characters")),!1):((null==a||a.length<1)&&(a=r),void s.couchServer.getUserDb().createUser({name:r,password:l,display:a,onSuccess:function(){s.login({username:r,password:l,onSuccess:o.onSuccess,onError:function(e){alert(i("User created but unable to log in: ")+e)}})},onError:function(e){alert(i("Unable to create user: ")+e)}}))}},_fillDialogWithUserAutoRegistration:function(n,r){var o=t.extend({prompt:null,userName:null,onSuccess:function(e){},onError:function(e){}},r),s=this,a=e("#"+n);a.empty();var l=e("<div>").addClass("n2Auth_create").appendTo(a),c=e("<div>").addClass("n2Auth_create_email_line").appendTo(l),d=e("<div>").addClass("n2Auth_create_input").appendTo(c);if(e('<input type="text" autofocus>').addClass("n2Auth_email_input n2Auth_input_field").appendTo(d).keydown(function(e){var t=null;null===e&&(e=window.event),null!==e&&e.keyCode&&(t=e.keyCode),13===t&&h()}),o.userName){var u=a.find(".n2Auth_email_input");u.val(o.userName),u.addClass("n2_input_detected")}e("<div>").addClass("n2Auth_create_label").text(i("e-mail address")).appendTo(d);c=e("<div>").addClass("n2Auth_create_button_line").appendTo(l);function h(){var r=e("#"+n).find(".n2Auth_email_input").val();if(r&&(r=t.trim(r)),!r)return alert(i("E-Mail address must be specified")),!1;var a=s.options.userServerUrl+"initUserCreation";e.ajax({url:a,type:"GET",async:!0,traditional:!0,data:{email:r},dataType:"json",success:function(t){t.error?alert(i("Unable to register user: ")+t.error):function(){var t=e("#"+n);t.empty();var r=e("<div>").addClass("n2Auth_registered").appendTo(t),s=e("<div>").addClass("n2Auth_registered_line").appendTo(r).text(i("User registration initiated. Check for e-mail to complete user creation")),s=e("<div>").addClass("n2Auth_registered_button_line").appendTo(r);e("<button>").addClass("n2Auth_button_ok").text(i("OK")).appendTo(s).button({icons:{primary:"ui-icon-check"}}).click(function(){return o.onSuccess(),!1}),t.dialog("option","title",i("Registration Initiated"))}()},error:function(e,t,n){alert(i("Unable to register user: ")+t)}})}e("<button>").addClass("n2Auth_button_create").text(i("Create User")).appendTo(c).click(function(){return h(),!1}),a.dialog("option","title",i("User Registration"))},_fillDialogWithPasswordRecovery:function(n,r){var o=t.extend({userName:null,onSuccess:function(e){},onError:function(e){}},r),s=this,a=e("#"+n);a.empty();var l=e("<div>").addClass("n2Auth_recoverPassword").appendTo(a),c=e("<div>").addClass("n2Auth_recoverPassword_email_line").appendTo(l),d=e("<div>").addClass("n2Auth_recoverPassword_input").appendTo(c);if(e('<input type="text" autofocus>').addClass("n2Auth_email_input n2Auth_input_field").appendTo(d).keydown(function(e){var t=null;null===e&&(e=window.event),null!==e&&e.keyCode&&(t=e.keyCode),13===t&&h()}),o.userName){var u=a.find(".n2Auth_email_input");u.val(o.userName),u.addClass("n2_input_detected")}e("<div>").addClass("n2Auth_recoverPassword_label").text(i("e-mail address")).appendTo(d);c=e("<div>").addClass("n2Auth_recoverPassword_button_line").appendTo(l);function h(){var r=e("#"+n).find(".n2Auth_email_input").val();if(r&&(r=t.trim(r)),!r)return alert(i("E-Mail address must be specified")),!1;var a=s.options.userServerUrl+"initPasswordRecovery";e.ajax({url:a,type:"GET",async:!0,traditional:!0,data:{email:r},dataType:"json",success:function(t){t.error?p(t.error):function(){var t=e("#"+n);t.empty();var r=e("<div>").addClass("n2Auth_registered").appendTo(t),s=e("<div>").addClass("n2Auth_registered_line").appendTo(r).text(i("Password recovery initiated. Check for an e-mail to complete password recovery")),s=e("<div>").addClass("n2Auth_registered_button_line").appendTo(r);e("<button>").addClass("n2Auth_button_ok").text(i("OK")).appendTo(s).button({icons:{primary:"ui-icon-check"}}).click(function(){return o.onSuccess(),!1}),t.dialog("option","title",i("Password Recovery Initiated"))}()},error:function(e,i,n){p(t.utils.parseHttpJsonError(e,void 0).error)}})}function p(t){var r=e("#"+n);r.empty();var a=e("<div>").addClass("n2Auth_recoverError").appendTo(r);e("<div>").addClass("n2Auth_recoverError_line").appendTo(a).text(i("Unable to initiate password recovery. Contact your administrator to resolve this issue.")),t&&e("<div>").addClass("n2Auth_recoverError_report").appendTo(a).text(t);var l=e("<div>").addClass("n2Auth_recoverError_button_line").appendTo(a);e("<button>").addClass("n2Auth_button_ok").text(i("OK")).appendTo(l).button({icons:{primary:"ui-icon-check"}}).click(function(){return s._fillDialogWithLogin(n,o),!1}),r.dialog("option","title",i("Password Recovery Failure"))}e("<button>").addClass("n2Auth_button_recover").text(i("Reset Password")).appendTo(c).click(function(){return h(),!1}),a.dialog("option","title",i("Recover Password"))},showLoginForm:function(i){var n=e.extend({prompt:this.options.prompt,onSuccess:function(e){},onError:t.reportErrorForced},i),r=t.getUniqueId(),o=e('<div id="'+r+'"></div>');e(document.body).append(o),this._fillDialogWithLogin(r,{prompt:n.prompt,onSuccess:function(t){e("#"+r).dialog("close"),n.onSuccess(t)},onError:function(t){e("#"+r).dialog("close"),n.onError(t)}});var s={autoOpen:!0,modal:!0,width:"auto",close:function(t,i){e("#"+r).remove()}};n.prompt&&(s.title=n.prompt),o.dialog(s)},logout:function(e){var i=t.extend({onSuccess:function(e){},onError:function(e){}},e),n=this;this.couchServer.getSession().logout({onSuccess:function(e){t.log("Logout successful",e),i.onSuccess(e),n._notifyListeners()},onError:i.onError})},editUser:function(n){var r=t.extend({userName:null,onSuccess:function(e){},onError:function(e){}},n),o=this,s=r.userName;if(!s){var a=this._getAuthContext();a&&a.name&&(s=a.name)}function l(n){var r=o._getUserService();if(r){var s=e("<div>").addClass("n2Auth_userEdit").appendTo(e(document.body)),a=t.utils.getElementIdentifier(s);r.startEdit({userDoc:n,elem:s,onSavedFn:function(e){var t=o._getRequestService();t&&e&&e.name&&t.requestUser(e.name)},onFinishedFn:function(){e("#"+a).dialog("close")}});var l={autoOpen:!0,modal:!0,width:"auto",title:i("Edit User"),close:function(t,i){e("#"+a).remove()}};s.dialog(l)}}s?this.couchServer.getUserDb().getUser({name:s,onSuccess:l,onError:function(e){l({_id:"org.couchdb.user:"+s,name:s,display:"",nunaliit_emails:[],roles:[],type:"user"})}}):r.onError("No user name provided")},getCurrentUserName:function(){var e=this._getAuthContext();return e&&e.name?e.name:null},getCurrentUserRoles:function(){var e=this._getAuthContext();return e&&e.roles?e.roles:null},doRolesContainAdmin:function(t){var i=!1;if(t&&t.length&&(e.inArray("_admin",t)>=0&&(i=!0),e.inArray("administrator",t)>=0&&(i=!0),"object"==typeof n2atlas&&"string"==typeof n2atlas.name)){var n=n2atlas.name+"_administrator";e.inArray(n,t)>=0&&(i=!0)}return i},_getAuthContext:function(){return this.couchServer.getSession().getContext()},isLoggedIn:function(){var e=this._getAuthContext();return!(!e||!e.name)},createAuthWidget:function(e){var i=null,n=null;this.options.directory&&(i=this.options.directory.dispatchService,n=this.options.directory.customService);var r={elemId:null,elem:null,authService:this,dispatchService:i};if(n){var o=n.getOption("authWidgetLoginLabel");o&&(r.labelLogin=o),(o=n.getOption("authWidgetLogoutLabel"))&&(r.labelLogout=o),(o=n.getOption("authWidgetWelcomeLabel"))&&(r.labelWelcome=o)}var a=t.extend(r,e);return new s(a)},_getDispatcher:function(){var e=null;return this.options.directory&&(e=this.options.directory.dispatchService),e},_getUserService:function(){var e=null;return this.options.directory&&(e=this.options.directory.userService),e},_getRequestService:function(){var e=null;return this.options.directory&&(e=this.options.directory.requestService),e},_dispatch:function(e){var t=this._getDispatcher();if(t){var i=t.getHandle("n2.couchAuth");t.send(i,e)}},_handleSessionContextChange:function(e){var i=this;t.couch.compareSessionContexts(this.lastSessionContext,e)||(this.lastSessionContext=e,this.currentUserDoc=null,this._notifyListeners(),e.name&&this.couchServer.getUserDb().getUser({name:e.name,onSuccess:function(e){e.name===i.lastSessionContext.name&&i._handleCurrentUserDoc(e)},onError:function(t){e.name===i.lastSessionContext.name&&i._handleCurrentUserDoc(null)}}))},_handleCurrentUserDoc:function(t){this.currentUserDoc=t;var i=e("body");this.currentUserDoc&&this.currentUserDoc.nunaliit_options&&this.currentUserDoc.nunaliit_options.advanced?i.addClass("nunaliit_user_advanced"):i.removeClass("nunaliit_user_advanced"),t&&this._dispatch({type:"authCurrentUserDoc",userDoc:t}),this._updateUserDocWithLoggedIn()},_handleEvent:function(e){e&&"login"===e.type?this.login({username:e.username,password:e.password}):e&&"loginShowForm"===e.type?this.showLoginForm():e&&"logout"===e.type?this.logout():e&&"authIsLoggedIn"===e.type&&this.isLoggedIn()&&(e.isLoggedIn=!0,e.context=this.lastSessionContext,e.userDoc=this.currentUserDoc)},_getCustomService:function(){var e=null;return this.options.directory&&(e=this.options.directory.customService),e},_shouldDisableCreateUserButton:function(){var e=this.options.disableCreateUserButton,t=this._getCustomService();if(t&&!e){var i=t.getOption("disableCreateUserButton");void 0!==i&&(e=i)}return e},_updateUserDocWithLoggedIn:function(){var e=this.currentUserDoc;e&&n2atlas&&n2atlas.name&&(e.nunaliit_atlases&&e.nunaliit_atlases[n2atlas.name]&&e.nunaliit_atlases[n2atlas.name].auth||(e.nunaliit_atlases||(e.nunaliit_atlases={}),e.nunaliit_atlases[n2atlas.name]||(e.nunaliit_atlases[n2atlas.name]={name:n2atlas.name}),e.nunaliit_atlases[n2atlas.name].auth=!0,this.couchServer.getUserDb().updateDocument({data:e,onSuccess:function(){},onError:function(e){t.log("Unable to save user's authentication flag to user db",e)}})))},_getAtlasName:function(){var e="atlas";return"object"==typeof n2atlas&&n2atlas.name&&(e=n2atlas.name),e}}),s=t.Class({authService:null,elemId:null,currentUserName:null,currentUserDisplay:null,labelLogin:null,labelLogout:null,labelWelcome:null,initialize:function(e){var i=t.extend({elemId:null,elem:null,authService:null,dispatchService:null,labelLogin:null,labelLogout:null,labelWelcome:null},e),r=this;if(this.authService=i.authService,this.dispatchService=i.dispatchService,this.labelLogin=i.labelLogin,this.labelLogout=i.labelLogout,this.labelWelcome=i.labelWelcome,this.elemId=i.elemId,!this.elemId&&i.elem&&(this.elemId=t.utils.getElementIdentifier(i.elem)),this.dispatchService){var o=function(e,t,i){r._handleDispatch(e,t,i)};this.dispatchService.register(n,"authLoggedIn",o),this.dispatchService.register(n,"authLoggedOut",o),this.dispatchService.register(n,"authCurrentUserDoc",o),this.dispatchService.register(n,"userInfo",o),this.dispatchService.register(n,"userDocument",o);var s={type:"authIsLoggedIn",isLoggedIn:!1};this.dispatchService.synchronousCall(n,s),s.isLoggedIn?(s.context&&s.context.name&&(this.currentUserName=s.context.name),s.userDoc&&s.userDoc.display&&(this.currentUserDisplay=s.userDoc.display)):(this.currentUserName=null,this.currentUserDisplay=null),this._loginStateChanged()}},_getElem:function(){return e("#"+this.elemId)},_handleDispatch:function(e,t,i){if(this._getElem().length<1)i.deregister(t);else if("authLoggedIn"===e.type){var n=e.user;this.currentUserName!==n.name&&(this.currentUserName=n.name,this.currentUserDisplay=null,this._loginStateChanged())}else if("authLoggedOut"===e.type)this.currentUserName=null,this.currentUserDisplay=null,this._loginStateChanged();else if("authCurrentUserDoc"===e.type){var r=e.userDoc;r&&r.display!==this.currentUserDisplay&&(this.currentUserDisplay=r.display,this._loginStateChanged())}else"userInfo"===e.type?e.userInfo&&this.currentUserName===e.userInfo.name&&(this.currentUserDisplay=e.userInfo.display,this._loginStateChanged()):"userDocument"===e.type&&e.userDoc&&this.currentUserName===e.userDoc.name&&(this.currentUserDisplay=e.userDoc.display,this._loginStateChanged())},_loginStateChanged:function(){var t=this._getElem();if(!(t.length<1)){t.empty();var n=this.authService;if(n){var r=null,o=null,s=null,a=null,l=null,c=null;this.currentUserName?(r="javascript:Logout",(o=this.currentUserDisplay)||(o=this.currentUserName),c="nunaliit_login_greeting_name",s=this.labelLogout?this.labelLogout:i("Logout"),a=function(){return n.logout(),!1},l=function(){return n.editUser({userName:null}),!1}):(r="javascript:Login",o=this.labelWelcome?this.labelWelcome:i("Welcome"),c="nunaliit_login_greeting_welcome",s=this.labelLogin?this.labelLogin:i("Login"),a=function(){return n.showLoginForm(),!1});var d=e('<a class="nunaliit_login_link"></a>').attr("href",r).text(s),u=e('<div class="nunaliit_login_link_inner_container"></div>').append(d),h=e('<div class="nunaliit_login_link_outer_container"></div>').append(u).click(a),p=e("<span></span>").text(o),f=e('<div class="nunaliit_login_greeting_inner_container"></div>').append(p),m=e('<div class="nunaliit_login_greeting_outer_container"></div>').addClass(c).append(f);l&&m.addClass("nunaliit_login_greeting_with_editor").click(l),t.empty().append(m).append(h)}}}});t.couchAuth={AuthService:o,AuthWidget:s}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchModule";var r=t.Class({moduleDoc:null,atlasDb:null,initialize:function(e,t){this.moduleDoc=e,this.atlasDb=t},getModuleInfo:function(){var e=null;return this.moduleDoc&&(e=this.moduleDoc.nunaliit_module),e},getMapInfo:function(){var e=null,t=this.getModuleInfo();return t&&(e=t.map),e},getCanvasInfo:function(){var e=null,t=this.getModuleInfo();return t&&(e=t.canvas),e},getDisplayInfo:function(){var e=null,t=this.getModuleInfo();return t&&(e=t.display),e},getEditInfo:function(){var e=null,t=this.getModuleInfo();return t&&(e=t.edit),e},getSearchInfo:function(){var e=null,t=this.getModuleInfo();return t&&(e=t.search),e},getModelInfos:function(){var e=null,t=this.getModuleInfo();return t&&(e=t.models),e||(e=[]),e},getUtilityInfos:function(){var e=null,t=this.getModuleInfo();return t&&(e=t.utilities),e||(e=[]),e},getWidgetInfos:function(){var e=null,t=this.getModuleInfo();return t&&(e=t.widgets),e||(e=[]),e},getModuleCSS:function(){var e,t=this.getModuleInfo();return t&&(e=t.css),e},displayIntro:function(r){var o=t.extend({elem:null,showService:null,dispatchService:null,onLoaded:function(){}},r),s=this,a=o.elem,l=null,c=this.getModuleInfo();c&&(l=c.introduction);var d=!1;if(o.dispatchService){var u={type:"modulePerformIntroduction",performed:!1,elem:o.elem,module:this};o.dispatchService.synchronousCall(n,u),u.performed&&(d=!0)}if(!d&&l)if("html"===l.type&&l.content){a.empty();var h=e("<div>").addClass("n2ModuleIntro n2ModuleIntro_html").appendTo(a);(p=i(l.content))&&(h.html(p),o.showService&&o.showService.fixElementAndChildren(h,{},this.moduleDoc)),o.onLoaded(),d=!0}else if("text"===l.type&&l.content){a.empty();var p;h=e("<div>").addClass("n2ModuleIntro n2ModuleIntro_text").appendTo(a);if(p=i(l.content)){var f=e("<div>").text(p);h.empty().append(f),o.showService&&(f.addClass("n2s_preserveSpaces"),o.showService.fixElementAndChildren(f,{},this.moduleDoc))}o.onLoaded(),d=!0}else if("attachment"===l.type&&l.attachmentName&&this.atlasDb){var m=t.getUniqueId();a.empty(),e("<div>").attr("id",m).addClass("n2ModuleIntro n2ModuleIntro_attachment").appendTo(a),d=!0;var v=t.l10n.getStringForLocale(l.attachmentName);if(v.str){var g=this.atlasDb.getAttachmentUrl(this.moduleDoc,v.str);e.ajax({url:g,type:"get",async:!0,success:function(t){if(v.fallback){var i=e('<span class="n2_localized_string n2_localize_fallback"></span>');e('<span class="n2_localize_fallback_lang"></span>').text("("+v.lang+")").appendTo(i),e("<span></span>").html(t).appendTo(i),e("#"+m).empty().append(i)}else e("#"+m).html(t);o.showService&&o.showService.fixElementAndChildren(e("#"+m),{},s.moduleDoc),o.onLoaded()},error:function(e,i,n){t.log("Unable to obtain module intro: "+i)}})}}return!!d||(a.empty(),!1)},getAttachmentUrl:function(e){return this.atlasDb.getAttachmentUrl(this.moduleDoc,e)}}),o=t.Class({config:null,moduleId:null,module:null,mapControl:null,displayControl:null,titleName:null,moduleTitleName:null,contentName:null,mapName:null,mapInteractionName:null,sidePanelName:null,filterPanelName:null,searchPanelName:null,loginPanelNames:null,navigationName:null,navigationDocId:null,languageSwitcherName:null,helpButtonName:null,helpDialogId:null,styleMapFn:null,mapStyles:null,dispatchService:null,navigationService:null,initialize:function(o){var s=t.extend({moduleName:null,moduleDoc:null,config:null,titleName:"title",moduleTitleName:"module_title",contentName:null,mapName:"map",mapInteractionName:"map_interaction_div",sidePanelName:"side",filterPanelName:"filters",searchPanelName:null,loginPanelName:"login",loginPanels:null,navigationName:"navigation",navigationDoc:null,languageSwitcherName:null,helpButtonName:null,styleMapFn:null,onSuccess:function(e){},onError:function(e){t.reportErrorForced(errorMsg)}},o),a=this;if(s.moduleName||s.moduleDoc)if(this.config=s.config,this.config){this.contentName=s.contentName,this.mapName=s.mapName,this.mapInteractionName=s.mapInteractionName,this.sidePanelName=s.sidePanelName,this.filterPanelName=s.filterPanelName,this.searchPanelName=s.searchPanelName,this.navigationName=s.navigationName,this.navigationDocId=s.navigationDoc,this.titleName=s.titleName,this.moduleTitleName=s.moduleTitleName,this.languageSwitcherName=s.languageSwitcherName,this.helpButtonName=s.helpButtonName,this.styleMapFn=s.styleMapFn,this.config&&this.config.directory&&(this.dispatchService=this.config.directory.dispatchService,this.navigationService=this.config.directory.navigationService),this.loginPanelNames=[],s.loginPanels?e(s.loginPanels).each(function(){var i=e(this),n=i.attr("id");n||(n=t.getUniqueId(),i.attr("id",n)),a.loginPanelNames.push(n)}):s.loginPanelName&&this.loginPanelNames.push(s.loginPanelName);var l=this.config,c=l.atlasDb,d=(l.atlasDesign,l.documentSource,this._getCustomService()),u=this.dispatchService;u&&(u.register(n,"unselected",function(e){a._initSidePanel()}),u.register(n,"moduleGetCurrent",function(e){e.moduleId=a.getCurrentModuleId(),a.module&&(e.module=a.module,e.doc=a.module.moduleDoc,e.moduleDisplay=a)}));for(var h=0,p=this.loginPanelNames.length;h<p;++h){var f=this.loginPanelNames[h];l.directory.authService.createAuthWidget({elemId:f})}if(t.isDefined(s.moduleDoc)?g(s.moduleDoc):(this.moduleId=s.moduleName,c.getDocument({docId:s.moduleName,onSuccess:g,onError:function(e){s.onError("Unable to load module: "+e)}})),this.navigationDocId){var m=e("#"+this.titleName);m.length>0&&(m.empty(),this.navigationService&&this.navigationService.printTitle({elem:m}));var v=e("#"+this.navigationName);v.length>0&&(v.empty(),this.navigationService&&this.navigationService.printMenu({elem:v})),this.navigationService&&this.navigationService.setCurrentNavigation({docId:this.navigationDocId})}}else s.onError('"config" must be specified');else s.onError('"moduleName" or "moduleDoc" must be specified');function g(n){if(n.nunaliit_module){if(n._id){a.moduleId=n._id;var o=t.utils.stringToHtmlId(n._id);e("body").addClass("nunaliit_module_"+o),e(".n2_nav_module+"+o).addClass("n2_nav_currentModule")}a.module=new r(n,c),a._sendDispatchMessage({type:"reportModuleDocument",doc:n,moduleId:n._id,module:a.module,moduleDisplay:a});var u=a.module.getModuleInfo(),h=a.module.getMapInfo(),p=a.module.getCanvasInfo(),f=a.module.getDisplayInfo(),m=a.module.getSearchInfo(),v=a.module.getModelInfos(),g=a.module.getUtilityInfos(),_=a.module.getModuleCSS();if("string"==typeof _&&t.css.setCss({css:_,name:"module"}),v)for(var S=0,b=v.length;S<b;++S){var I=v[S],C={type:"modelCreate",modelType:I.modelType,modelId:I.modelId,modelOptions:I,created:!1,config:l,moduleDisplay:a};a._sendSynchronousMessage(C),C.created||t.logError("Model not created: "+I.modelType+"/"+I.modelId)}var D=!1;if(g)for(S=0,b=g.length;S<b;++S){var w=g[S];"inputChangeDetector"===w.utilityType&&(D=!0);C={type:"utilityCreate",utilityType:w.utilityType,utilityOptions:w,created:!1,config:l,moduleDisplay:a};a._sendSynchronousMessage(C),C.created||t.logError("Utility not created: "+w.utilityType)}if(!D){C={type:"utilityCreate",utilityType:"inputChangeDetector",utilityOptions:{type:"inputChangeDetector"},created:!1,config:l,moduleDisplay:a};a._sendSynchronousMessage(C),C.created||t.logError("Unable to add utility inputChangeDetector")}var E=!1;if(p&&p.canvasType){C={type:"canvasIsTypeAvailable",canvasType:p.canvasType,canvasOptions:p,isAvailable:!1};a._sendSynchronousMessage(C),C.isAvailable&&(E=!0)}if(p&&!E&&(t.logError("Canvas handler not found for type: "+p.canvasType),p=null),a.contentName){var x=e("#"+a.contentName).empty();h||p?(a.mapName=t.getUniqueId(),e("<div></div>").attr("id",a.mapName).addClass("n2_content_map").appendTo(x),x.addClass("n2_content_contains_map"),a.mapInteractionName=t.getUniqueId(),e("<div></div>").attr("id",a.mapInteractionName).addClass("n2_content_map_interaction").appendTo(x)):(a.mapName=null,a.mapInteractionName=null,x.addClass("n2_content_contains_no_map")),m&&m.disabled?(a.searchPanelName=null,x.addClass("n2_content_contains_no_search")):a.searchPanelName?x.addClass("n2_content_contains_no_search"):(a.searchPanelName=t.getUniqueId(),e("<div></div>").attr("id",a.searchPanelName).addClass("n2_content_searchInput").appendTo(x),x.addClass("n2_content_contains_search")),a.sidePanelName=t.getUniqueId(),e("<div></div>").attr("id",a.sidePanelName).addClass("n2_content_text").appendTo(x),x.addClass("n2_content_contains_text")}if(h&&t.isArray(h.styles)?a.mapStyles=new t.mapStyles.MapStylesAdaptor({ruleArray:h.styles,dispatchService:this.dispatchService}):h&&"object"==typeof h.styles?a.mapStyles=new t.mapStyles.MapFeatureStyles(h.styles):a.mapStyles=new t.mapStyles.MapFeatureStyles(null),u&&u.title){(T=i(u.title))&&(document.title=T,a._installModuleTitle(e("#"+s.moduleTitleName),T))}else{var T=i("Nunaliit Atlas");document.title=T,a._installModuleTitle(e("#"+s.moduleTitleName),T)}if(a.languageSwitcherName&&a.config.directory.languageService&&a.config.directory.languageService.drawWidget({elemId:a.languageSwitcherName}),u.help&&a.helpButtonName&&a._installHelpButton(),f){var k=null;f.type&&(k=f.type),!k&&d&&(k=d.getOption("displayFormat",k)),k||(k="classic");var L=!1;C={type:"displayIsTypeAvailable",displayType:k,isAvailable:!1,displayOptions:f};a._sendSynchronousMessage(C),C.isAvailable&&(L=!0),L?a._sendDispatchMessage({type:"displayRender",displayType:k,displayOptions:f,displayId:a.sidePanelName,config:l,moduleDisplay:a,onSuccess:function(e){a.displayControl=e,y(m,h,p)},onError:s.onError}):y(m,h,p)}}else s.onError("Loaded document does not include module information")}function y(i,n,r){var o=a.module.getEditInfo();l.couchEditor.setPanelName(a.sidePanelName);var c="object";o&&o.defaultSchemaName&&(c=o.defaultSchemaName),l.directory.schemaRepository.getSchema({name:c,onSuccess:function(e){l.couchEditor.options.defaultEditSchema=e}}),o&&o.newDocumentSchemaNames&&("ALL_SCHEMAS"===o.newDocumentSchemaNames?l.couchEditor.setSchemas(t.couchEdit.Constants.ALL_SCHEMAS):o.newDocumentSchemaNames.length&&l.directory.schemaRepository.getSchemas({names:o.newDocumentSchemaNames,onSuccess:function(e){l.couchEditor.setSchemas(e)},onError:function(e){t.log("Error obtaining new edit document schemas: "+e)}})),o&&l.directory.editService&&l.directory.editService.configureOptions(o),o&&l.directory.createDocProcess&&l.directory.createDocProcess.configureOptions(o),i&&i.constraint&&l.directory.searchService.setConstraint(i.constraint),a.searchPanelName&&l.directory.searchService.installSearchWidget({elem:e("#"+a.searchPanelName)}),n?a._initializeMap({config:l,onSuccess:_,onError:s.onError}):r?a._sendDispatchMessage({type:"canvasDisplay",canvasType:r.canvasType,canvasOptions:r,canvasId:a.mapName,interactionId:a.mapInteractionName,config:l,moduleDisplay:a,onSuccess:_,onError:s.onError}):_()}function _(){var i=a.module.getWidgetInfos(),n=[];if(i)for(var r=0,o=i.length;r<o;++r){var c=i[r],d=!1;if(c&&c.widgetType){var u={type:"widgetIsTypeAvailable",widgetType:c.widgetType,widgetOptions:c,isAvailable:!1};a._sendSynchronousMessage(u),u.isAvailable&&(d=!0)}c&&!d?t.logError("Widget handler not found for type: "+c.widgetType):n.push(c)}var h=!1;for(r=0,o=n.length;r<o;++r){var p={type:"widgetDisplay",widgetType:(c=n[r]).widgetType,widgetOptions:c,contentId:a.contentName,config:l,moduleDisplay:a},f=!1;c.containerId&&(p.containerId=c.containerId,a._sendDispatchMessage(p),f=!0),c.containerClass&&(e("."+c.containerClass).each(function(){var e=t.utils.getElementIdentifier(this);p.containerId=e,a._sendDispatchMessage(p)}),f=!0),f||(p.containerId=a.contentName,a._sendDispatchMessage(p)),"modelBrowserWidget"===c.widgetType&&(h=!0)}if(!h){var m=e(".nunaliit_footer");if(m.length>0){var v=t.utils.getElementIdentifier(m);p={type:"widgetDisplay",widgetType:"modelBrowserWidget",widgetOptions:{widgetType:"modelBrowserWidget"},contentId:a.contentName,containerId:v,config:l,moduleDisplay:a};a._sendDispatchMessage(p)}}a._initSidePanel(),a._sendDispatchMessage({type:"reportModuleDisplay",moduleDisplay:a}),s.onSuccess(a)}},getCurrentModuleId:function(){return this.module&&this.module._id?this.module._id:this.moduleId},_initializeMap:function(e){var r=t.extend({config:null,onSuccess:function(e){},onError:function(e){}},e),o=this,s=o.module.getMapInfo(),a=this._getCustomService(),l=!1;s&&s.addPointsOnly&&(l=s.addPointsOnly);var c=!1;s&&s.toggleClick&&(c=s.toggleClick);var d=!1;s&&s.showSRSAttribution&&(d=s.showSRSAttribution);var u={visible:!1};s&&s.scaleLine&&s.scaleLine.visible&&(u=s.scaleLine);var h=!1;s&&s.enableWheelZoom&&(h=!0);var p={relMediaPath:"./"};s&&s.dbSearchEngine&&(p=s.dbSearchEngine);var f=void 0;s&&"string"==typeof s.canvasName&&(f=s.canvasName);var m={dbSearchEngine:p,canvasName:f,mapIdentifier:o.mapName,mapInteractionDivName:o.mapInteractionName,mapCoordinateSpecifications:{initialBounds:null},uniqueIdentifier:"_id",addPointsOnly:l,overlays:[],toggleClick:c,showSRSAttribution:d,scaleLine:u,enableWheelZoom:h,sidePanelName:o.sidePanelName,filterPanelName:o.filterPanelName,saveFeature:o.config.couchEditor,mapDisplay:{},directory:o.config.directory,layerSwitcher:{suppress:!1,initiallyOpened:!1}};s&&s.layerSelector&&(s.layerSelector.suppress&&(m.layerSwitcher.suppress=!0),s.layerSelector.initiallyOpened&&(m.layerSwitcher.initiallyOpened=!0));var v,g=null;if(s&&s.coordinates){if(g=s.coordinates.initialBounds,s.coordinates.srsName){if(0==(v=s.coordinates.srsName,!!("undefined"!=typeof OpenLayers&&OpenLayers.Projection&&OpenLayers.Projection.transforms&&OpenLayers.Projection.transforms[v])||!("undefined"==typeof Proj4js||!Proj4js.Proj||!new Proj4js.Proj(v).readyToUse))){var y=i("The projection {srsName} is not supported. Atlas may no function properly.",{srsName:s.coordinates.srsName});alert(y)}m.mapDisplay.srsName=s.coordinates.srsName,m.mapCoordinateSpecifications.srsName=s.coordinates.srsName}else m.mapDisplay.srsName="EPSG:4326",m.mapCoordinateSpecifications.srsName="EPSG:4326";if(s.coordinates.mousePositionSrsName&&(m.mapCoordinateSpecifications.mousePositionSrsName=s.coordinates.mousePositionSrsName),s.backgrounds)for(var _=0,S=s.backgrounds.length;_<S;++_)"Google Maps"===s.backgrounds[_].type?m.mapDisplay.srsName="EPSG:900913":"osm"===s.backgrounds[_].type?m.mapDisplay.srsName="EPSG:900913":"stamen"===s.backgrounds[_].type&&(m.mapDisplay.srsName="EPSG:900913")}if(s&&s.backgrounds){m.mapDisplay.backgrounds=[];for(_=0,S=s.backgrounds.length;_<S;++_){var b=t.extend({},s.backgrounds[_]);if("image"===b.type){if(b.options&&b.options.attachmentName){var I=o.config.atlasDb.getAttachmentUrl(this.module.moduleDoc,b.options.attachmentName);b.options.url=I}if(b.options&&b.options.extent&&m.mapDisplay.srsName!=m.mapCoordinateSpecifications.srsName){var C=new OpenLayers.Projection(m.mapCoordinateSpecifications.srsName),D=new OpenLayers.Projection(m.mapDisplay.srsName),w=new OpenLayers.Geometry.Point(b.options.extent[0],b.options.extent[1]),E=new OpenLayers.Geometry.Point(b.options.extent[2],b.options.extent[3]);w.transform(C,D),E.transform(C,D),b.options.extent[0]=w.x,b.options.extent[1]=w.y,b.options.extent[2]=E.x,b.options.extent[3]=E.y}}m.mapDisplay.backgrounds.push(b)}}if(s&&s.overlays){var x=o.styleMapFn;!x&&a&&"function"!=typeof(x=a.getOption("mapGetStyleFunctionForLayer"))&&(x=null),x||(x=function(e){return o.mapStyles.getStyleMapForLayerInfo(e)});for(_=0,S=s.overlays.length;_<S;++_){var T=s.overlays[_],k={id:T.id,name:T.name,type:T.type,visibility:T.visibility,featurePopupHtmlFn:o.config.popupHtmlFn,featurePopupDelay:0,styleMapFn:x,useHoverSound:!0,clustering:!1};t.isDefined(T.gutter)&&(k.gutter=T.gutter),t.isDefined(T.displayInLayerSwitcher)&&(k.displayInLayerSwitcher=T.displayInLayerSwitcher),"couchdb"===T.type?(k.options=t.extend({viewName:"geom",layerName:null,documentSource:o.config.documentSource},T.options),k.options.layerName||(k.options.layerName=k.id),!k.id&&k.options&&k.options.layerName&&(k.id=k.options.layerName)):k.options=T.options,T.featurePopupDelayMs&&(k.featurePopupDelay=T.featurePopupDelayMs),"boolean"==typeof T.useHoverSound&&(k.useHoverSound=T.useHoverSound),T.clustering&&(k.clustering=T.clustering),"number"==typeof T.minimumLinePixelSize&&(k.minimumLinePixelSize=T.minimumLinePixelSize),"number"==typeof T.minimumPolygonPixelSize&&(k.minimumPolygonPixelSize=T.minimumPolygonPixelSize),m.overlays.push(k)}}if(s&&s.coordinates&&s.coordinates.autoInitialBounds){var L=void 0;L=m.mapCoordinateSpecifications.srsName?new OpenLayers.Projection(m.mapCoordinateSpecifications.srsName):new OpenLayers.Projection("EPSG:4326");var M=void 0;if("object"==typeof s.coordinates.autoInitialBounds){var O=t.extend({},s.coordinates.autoInitialBounds);O._mapInfo=s;var A={type:"instanceCreate",instanceConfiguration:O};o.dispatchService.synchronousCall(n,A),M=A.instance}if(!M){A={type:"instanceCreate",instanceConfiguration:{type:"mapAutoInitialBoundsCouchDbOverlays"}};o.dispatchService.synchronousCall(n,A),M=A.instance}M&&"function"==typeof M.computeInitialBounds?M.computeInitialBounds({mapOptions:m,mapInfo:s,initialBounds:g,coordinateProjection:L,onSuccess:function(e){F(m,e||g)},onError:function(e){t.log("Error while computing initial bounds: "+e),F(m,g)}}):F(m,g)}else F(m,g);function F(e,i){if(i){e.mapCoordinateSpecifications.initialBounds=i;var n=o.module.getMapInfo();n&&n.coordinates&&n.coordinates.maxExtent?e.mapCoordinateSpecifications.maxExtent=n.coordinates.maxExtent:null!==e.mapDisplay.srsName&&"EPSG:4326"!==e.mapDisplay.srsName&&(e.mapCoordinateSpecifications.maxExtent=e.mapCoordinateSpecifications.initialBounds);try{o.mapControl=nunaliit2.mapAndControls(e),o.mapControl.contributions=o.config.contributions,o.mapControl.requests=o.config.directory.requestService}catch(e){t.log("Error while creating map: "+e),e.stack&&t.log("Stack",e.stack)}t.log("module",o),r.onSuccess(o)}else r.onError("Initial map extent not specified")}},_initSidePanel:function(){var t=this,i=this._getCustomService(),n=e("#"+this.sidePanelName),r=i.getOption("moduleDisplayIntroFunction",null);r?r({elem:n,config:this.config,moduleDisplay:this}):this.module.displayIntro({elem:n,showService:this._getShowService(),dispatchService:this.dispatchService,onLoaded:function(){t._sendDispatchMessage({type:"loadedModuleContent"})}})},_getShowService:function(){var e=null;return this.config.directory&&(e=this.config.directory.showService),e},_getCustomService:function(){var e=null;return this.config.directory&&(e=this.config.directory.customService),e},_sendDispatchMessage:function(e){var t=this.dispatchService;t&&t.send(n,e)},_sendSynchronousMessage:function(e){var t=this.dispatchService;t&&t.synchronousCall(n,e)},_installModuleTitle:function(t,i){var r=this;t.empty();var o=e('<a class="nunaliit_module_title_link" href="#"></a>').addClass("nunaliit_module_title_link").attr("href","#").text(i).appendTo(t).click(function(e){var t=r.dispatchService;return t&&t.send(n,{type:"mapResetExtent"}),!0}),s=this.moduleId;if(s){o.addClass("n2s_insertModuleName"),o.attr("nunaliit-document",s);var a=this._getShowService();a&&a.fixElementAndChildren(t)}},_installHelpButton:function(){var n=this,r=e("#"+this.helpButtonName);if(!(r.length<1)){r.empty();var o=this.module.getModuleInfo();o.help&&"reference"===o.help.nunaliit_type&&o.help.doc?this.config.atlasDb.getDocument({docId:o.help.doc,onSuccess:function(o){var s;o&&o.nunaliit_help?(t.help.InstallHelpInfo("main",o.nunaliit_help),(s=e('<a class="nunaliit_module_help_button" href="#"></a>')).text(i("Help")),e("#"+n.helpButtonName).empty().append(s),s.click(function(){var i=e(this);return t.help.ToggleHelp("main",i),!1})):(t.log("Do not know how to interpret help document"),r.attr("n2_error","Do not know how to interpret help document"))},onError:function(e){t.log("Unable to load help document",e),r.attr("n2_error","Unable to load help document"+e)}}):(t.log("Do not know how to handle help information"),r.attr("n2_error","Do not know how to handle help information"))}}});t.couchModule={ModuleDisplay:o}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n="n2.couchNavigation";function r(e){e.addClass("n2_nav_currentModule"),e.parents(".n2nav_setChildModuleCurrent").addClass("n2_nav_childModuleCurrent")}var o=t.Class({dispatchService:null,showService:null,navigationDoc:null,elemId:null,initialize:function(i){var n=t.extend({dispatchService:null,showService:null,navigationDoc:null,elem:null},i);this.dispatchService=n.dispatchService,this.showService=n.showService,this.navigationDoc=n.navigationDoc;var r=e(n.elem);this.elemId=t.utils.getElementIdentifier(r),this._display()},_display:function(){var o=e("#"+this.elemId),s=this.navigationDoc;if(this.navigationDoc&&this.navigationDoc.nunaliit_navigation&&o.length>0){var a={type:"moduleGetCurrent"};this.dispatchService.synchronousCall(n,a);var l=a.moduleId;if(o.empty(),s.nunaliit_navigation.items&&s.nunaliit_navigation.items.length>0)!function n(o,s,a){for(var l=0,c=s.length;l<c;++l){var d=s[l],u=e("<li>").addClass("n2nav_setChildModuleCurrent").appendTo(o);if(d.key&&u.attr("n2nav-key",d.key),d.title&&d.href){var h=null,p=new t.url.Url({url:d.href});p&&(h=p.getParamValue("module",null)),h&&(u.attr("n2nav-module",h),u.addClass("n2nav_setModuleCurrent")),h&&h===a&&r(u);var f=i(d.title);e("<a>").attr("href",d.href).text(f).appendTo(u)}else if(d.module){var m=t.url.getCurrentLocation(),v=m.clone().setHash(null).setParamValue("module",d.module);u.attr("n2nav-module",d.module),u.addClass("n2nav_setModuleCurrent"),d.module===a&&r(u);var g=e("<a>").attr("href",v.getUrl()).appendTo(u);if(d.title){var f=i(d.title);g.text(f)}else g.attr("nunaliit-document",d.module),g.addClass("n2s_insertModuleName"),g.text(d.module)}else if(d.title){var y=e("<span></span>"),f=i(d.title);y.text(f),u.append(y)}if(d.items&&d.items.length>0){var _=e("<ul>").addClass("n2nav_setChildModuleCurrent").appendTo(u);n(_,d.items,a)}}}(e("<ul>").addClass("n2nav_setChildModuleCurrent").appendTo(o),s.nunaliit_navigation.items,l);this.showService&&this.showService.fixElementAndChildren(o)}}}),s=t.Class({dispatchService:null,showService:null,documentSource:null,currentNavigationDoc:null,initialize:function(e){var i=t.extend({dispatchService:null,showService:null,documentSource:null},e),r=this;this.dispatchService=i.dispatchService,this.showService=i.showService,this.documentSource=i.documentSource;var o=this.dispatchService;if(o){var s=function(e,t,i){r._handle(e,t,i)};o.register(n,"reportModuleDocument",s),o.register(n,"navigationGetCurrent",s),o.register(n,"showPreprocessElement",s)}},setCurrentNavigation:function(i){var r=t.extend({docId:null,doc:null},i),o=this;r.doc&&r.doc.nunaliit_navigation?(this.navigationDoc=r.doc,this._fixElements(e("body"),this.navigationDoc),this.dispatchService&&this.dispatchService.send(n,{type:"navigationReportCurrent",navigationId:this.navigationDoc._id,navigationDoc:this.navigationDoc})):r.docId&&this.documentSource&&this.documentSource.getDocument({docId:r.docId,onSuccess:function(e){o.setCurrentNavigation({doc:e})}})},printTitle:function(i){var n=t.extend({elem:null},i),r=e(n.elem).addClass("n2nav_insertTitle");this._fixElements(r,this.navigationDoc)},printMenu:function(i){var n=t.extend({elem:null},i),r=e(n.elem).addClass("n2nav_insertMenu");this._fixElements(r,this.navigationDoc)},_fixElements:function(t,i){if(i){var n=this,r=t.find("*").addBack();r.filter(".n2nav_insertTitle").each(function(){var t=e(this);t.removeClass("n2nav_insertTitle").addClass("n2nav_insertedTitle"),n._insertTitle(t,i)}),r.filter(".n2nav_insertMenu").each(function(){var t=e(this);t.removeClass("n2nav_insertMenu").addClass("n2nav_insertedMenu"),n._insertMenu(t,i)})}},_insertTitle:function(e,t){var n=this._associateDocumentToElement(t,e);if(t&&n===t._id){var r=void 0;t.nunaliit_navigation&&(r=t.nunaliit_navigation.title),r?e.text(i(r)):e.empty()}},_insertMenu:function(e,t){var i=this._associateDocumentToElement(t,e);t&&i===t._id&&new o({dispatchService:this.dispatchService,showService:this.showService,navigationDoc:t,elem:e})},_associateDocumentToElement:function(e,i){var r=i.attr("nunaliit-document");!r&&e?r=e.nunaliit_navigation?e._id:this.navigationDoc._id:r||e||(r=this.navigationDoc._id);var o=i.hasClass("n2show_documentAssociated");if(r&&!o){i.attr("nunaliit-document",r),i.addClass("n2show_documentAssociated");var s="n2show_documentUpdate_"+t.utils.stringToHtmlId(r);if(i.addClass(s),e&&e._id===r);else{var a="n2show_documentContent_"+t.utils.stringToHtmlId(r);i.addClass(a),this.dispatchService.send(n,{type:"requestDocument",docId:r})}}return r},_handle:function(t,i,n){if("reportModuleDocument"===t.type){var o=t.moduleId;e(".n2nav_setModuleCurrent").removeClass("n2_nav_currentModule"),e(".n2nav_setChildModuleCurrent").removeClass("n2_nav_childModuleCurrent"),e(".n2nav_setModuleCurrent").each(function(){var t=e(this),i=t.attr("n2nav-module");i&&i===o&&r(t)})}else if("navigationGetCurrent"===t.type)this.navigationDoc&&(t.navigationId=this.navigationDoc._id,t.navigationDoc=this.navigationDoc);else if("showPreprocessElement"===t.type){var s=t.elem,a=t.doc;this._fixElements(s,a)}}});t.couchNavigation={NavigationService:s,NavigationDisplay:o}}(jQuery,nunaliit2),function($,$n2){var _loc=function(e,t){return $n2.loc(e,"nunaliit2",t)},ExportApplication=$n2.Class("ExportApplication",{exportService:null,atlasDb:null,atlasDesign:null,config:null,logger:null,docIds:null,initialize:function(e){var t=$n2.extend({exportService:null,atlasDb:null,atlasDesign:null,config:null,logger:null,docIds:null,docs:null},e),i=this;if(this.exportService=t.exportService,this.atlasDb=t.atlasDb,this.atlasDesign=t.atlasDesign,this.config=t.config,this.logger=t.logger,this.docIds=[],$n2.isArray(t.docIds)&&t.docIds.forEach(function(e){i.docIds.push(e)}),$n2.isArray(t.docs)&&t.docs.forEach(function(e){i.docIds.push(e)}),!this.exportService)throw new Error("In ExportApplication, export service must be supplied");this.exportService.checkAvailable({onAvailable:function(){i._getExportSettings()},onNotAvailable:function(){i._reportError(_loc("Export service is not available"))}})},_reportError:function(e,t){new $n2.couchDialogs.AlertDialog({title:t||_loc("Export Error"),message:e})},_logError:function(e){this.logger&&this.logger.reportError(e)},_getExportSettings:function(){var e=this,t={},i="function(opts){\n\tvar config = opts.config;\n\tvar doc = opts.doc;\n\tif( doc ){\n\t\tvar record = { _id: doc._id, _geometry: doc._id };\n\t\topts.addRecord(record);\n\t};\n\topts.next();\n}",n=$n2.getUniqueId(),r=$('<div id="'+n+'"></div>');$("<div>").text(_loc("Exporting")).appendTo(r);var o=$n2.getUniqueId(),s=$("<div>").appendTo(r);$("<label>").text(_loc("Script:")).attr("for",l).appendTo(s);var a=$("<select>").attr("id",o).appendTo(s).change(I);$("<option>").val("__custom__").text(_loc("Custom Script")).appendTo(a);var l=$n2.getUniqueId(),c=$("<div>").appendTo(r);$("<label>").text(_loc("Filter:")).attr("for",l).appendTo(c);var d=$("<select>").attr("id",l).appendTo(c);$('<option value="all"></options>').text(_loc("All Geometries")).appendTo(d),$('<option value="points"></options>').text(_loc("Only Point Geometries")).appendTo(d),$('<option value="linestrings"></options>').text(_loc("Only LineString Geometries")).appendTo(d),$('<option value="polygons"></options>').text(_loc("Only Polygon Geometries")).appendTo(d);var u=$n2.getUniqueId(),h=$("<div>").appendTo(r);$("<label>").text(_loc("Format:")).attr("for",u).appendTo(h);var p=$("<select>").attr("id",u).appendTo(h).change(b);$('<option value="geojson"></options>').text(_loc("geojson")).appendTo(p),$('<option value="csv"></options>').text(_loc("CSV")).appendTo(p);var f=$n2.getUniqueId(),m=$("<div>").appendTo(r);$("<label>").text(_loc("File Name:")).attr("for",f).appendTo(m),$("<input>").attr("type","text").attr("id",f).addClass("n2_export_fileNameInput").val("export.geojson").appendTo(r);var v=$n2.getUniqueId(),g=$n2.getUniqueId(),y=$("<div>").appendTo(r);$("<label>").text(_loc("Script:")).attr("for",v).appendTo(y),$("<textarea>").attr("id",v).addClass("n2_export_scriptArea").appendTo(y),$("<div>").attr("id",g).addClass("n2_export_scriptDisplay").appendTo(y);var _=$("<div>").appendTo(r);$("<button>").text(_loc("Export")).appendTo(_).click(function(){var t=$("#"+l).val(),i=$("#"+u).val(),n=$("#"+f).val();""===n&&(n=null);var o=$("#"+v).val();return r.dialog("close"),e._performExportScript({filter:t,fileName:n,format:i,script:o}),!1});var S={autoOpen:!0,title:_loc("Export"),modal:!0,width:550,close:function(e,t){var i=$(e.target);i.dialog("destroy"),i.remove()}};function b(){var e=$("#"+u).val(),t=$("#"+f).val(),i=t.lastIndexOf(".");i>=0&&(t=t.substr(0,i)),t=t+"."+e,$("#"+f).val(t)}function I(){var e=$("#"+o).val(),n=t[e];n&&(i=n);var r=$("#"+v),s=$("#"+g);return r.text(i),s.text(i),"__custom__"===e?(r.removeAttr("disabled").css("display",""),s.css("display","none")):(r.attr("disabled","disabled").css("display","none"),s.css("display","")),!0}r.dialog(S),b(),I(),this.atlasDesign&&this.atlasDesign.queryView({viewName:"nunaliit-script",include_docs:!0,onSuccess:function(e){e.forEach(function(e){var i=$("#"+o),n=e.doc;if(n&&n.nunaliit_script&&"export"===n.nunaliit_script.type&&n.nunaliit_script.script){var r=void 0;(r=n.nunaliit_script.label?_loc(n.nunaliit_script.label):n.nunaliit_script.name)||(r=n._id),$("<option>").val(n._id).text(r).appendTo(i),t[n._id]=n.nunaliit_script.script}})},onError:function(t){var i=_loc("Unable to obtain list of export scripts")+": "+t;e._reportError(i),e._logError(i)}})},_performExportScript:function(opts_){var opts=$n2.extend({filter:"all",fileName:"export",format:"geojson",script:null},opts_),_this=this;if("string"!=typeof opts.script)throw new Error("Script is not a string");for(var docIdsRemaining=[],i=0,e=this.docIds.length;i<e;++i)docIdsRemaining.push(this.docIds[i]);var totalCount=docIdsRemaining.length,processedCount=0,errorCount=0,opCancelled=!1,records=[],my_scriptConfig=$n2.extend({},this.config),scriptFn=null;try{scriptFn=eval("("+opts.script+");")}catch(e){return this._reportError(_loc("Error")+": "+e),void this._logError("Unable to evaluate script: "+e,opts.script)}if("function"==typeof scriptFn){var progressDialog=new $n2.couchDialogs.ProgressDialog({title:_loc("Compiling records"),onCancelFn:function(){opCancelled=!0}});processNextDocument()}else this._reportError(_loc("You must enter a valid function"));function processNextDocument(){if(opCancelled)cancel();else if(docIdsRemaining.length<1)progressDialog.updateHtmlMessage("<span>100%</span>"),scriptFn({config:my_scriptConfig,addRecord:addRecord,next:onFinish});else{if(totalCount){var e=Math.floor(100*processedCount/totalCount),t=["<div>"];t.push("<span>Percent: "+e+"%</span><br/>"),t.push("<span>Processed: "+processedCount+"</span><br/>"),t.push("<span>Error: "+errorCount+"</span><br/>"),t.push("</div>"),progressDialog.updateHtmlMessage(t.join(""))}else progressDialog.updateHtmlMessage("<span>0%</span>");var i=docIdsRemaining.pop();"string"==typeof i?_this.atlasDb.getDocument({docId:i,onSuccess:retrievedDocument,onError:function(e){var t=_loc("Failure to fetch {docId}",{docId:i});_this._logError(t),errorCount+=1,processNextDocument()}}):"object"==typeof i?window.setTimeout(function(){retrievedDocument(i)},0):window.setTimeout(function(){_this._logError(_loc("Invalid document")),errorCount+=1,processNextDocument()},0)}}function retrievedDocument(e){opCancelled?cancel():scriptFn({doc:e,config:my_scriptConfig,addRecord:addRecord,next:next})}function addRecord(e){records.push(e)}function next(){processedCount+=1,processNextDocument()}function onFinish(){progressDialog.updateHtmlMessage("<span>Sending records to server</span>");var e=$n2.getUniqueId();$("<iframe>").attr("name",e).attr("src","javascript:false").css({visibility:"hidden",display:"none"}).appendTo($("body")),_this.exportService.exportByRecords({records:records,targetWindow:e,filter:opts.filter,contentType:"application/binary",fileName:opts.fileName,format:opts.format,onError:function(e){alert(_loc("Error during export")+": "+e)}}),progressDialog.close(),new $n2.couchDialogs.AlertDialog({title:_loc("Warning"),message:_loc("Please, wait until download starts. It might take a while.")})}function cancel(){_this._logError(_loc("Operation cancelled by user")),progressDialog.close()}}}),ExportService=$n2.Class("ExportService",{serverUrl:null,atlasDb:null,atlasDesign:null,config:null,initialize:function(e){var t=$n2.extend({url:null,atlasDb:null,atlasDesign:null,config:null},e);this.serverUrl=t.url,this.atlasDb=t.atlasDb,this.atlasDesign=t.atlasDesign,this.config=t.config},checkAvailable:function(e){var t=$n2.extend({onAvailable:function(){},onNotAvailable:function(){}},e);this.serverUrl?$.ajax({url:this.serverUrl+"welcome",type:"GET",dataType:"json",success:function(e,i,n){e&&e.ok?t.onAvailable(e):t.onNotAvailable()},error:function(e,i,n){t.onNotAvailable()}}):t.onNotAvailable()},createExportApplication:function(e){var t=$n2.extend({docIds:null,atlasDb:this.atlasDb,atlasDesign:this.atlasDesign,config:this.config,logger:null},e);return t.exportService=this,new ExportApplication(t)},exportByRecords:function(e){var t=$n2.extend({records:null,targetWindow:null,contentType:null,fileName:null,format:null,onError:$n2.reportError},e);if(!$n2.isArray(t.records))throw new Error("records must be provided as an array when exporting by records");var i=this.serverUrl+"records/";t.fileName?i+=t.fileName:i+="export";var n=$("<form>").attr("action",i).attr("method","POST").attr("enctype","multipart/form-data").css({display:"none",visibility:"hidden"});t.targetWindow&&n.attr("target",t.targetWindow),t.contentType&&$("<input>").attr("type","hidden").attr("name","contentType").val(t.contentType).appendTo(n),t.filter?$("<input>").attr("type","hidden").attr("name","filter").val(t.filter).appendTo(n):$("<input>").attr("type","hidden").attr("name","filter").val("all").appendTo(n),t.format?$("<input>").attr("type","hidden").attr("name","format").val(t.format).appendTo(n):$("<input>").attr("type","hidden").attr("name","format").val("geojson").appendTo(n),$('<input type="hidden" name="data"></input>').val(JSON.stringify(t.records)).appendTo(n),$("body").append(n),n.submit()},exportByDocIds:function(e){var t=$n2.extend({docIds:null,targetWindow:null,filter:"all",contentType:null,fileName:null,format:null,onError:$n2.reportError},e);t.docIds||onError("docIds must be provided when exporting by docIds");var i=this.serverUrl+"definition/";t.fileName?i+=t.fileName:i+="export";var n=$("<form>").attr("action",i).attr("method","POST").css({display:"none",visibility:"hidden"});t.targetWindow&&n.attr("target",t.targetWindow),$('<input type="hidden" name="method" value="doc-id"></input>').appendTo(n),t.contentType&&$("<input>").attr("type","hidden").attr("name","contentType").val(t.contentType).appendTo(n),t.filter?$("<input>").attr("type","hidden").attr("name","filter").val(t.filter).appendTo(n):$("<input>").attr("type","hidden").attr("name","filter").val("all").appendTo(n),t.format?$("<input>").attr("type","hidden").attr("name","format").val(t.format).appendTo(n):$("<input>").attr("type","hidden").attr("name","format").val("geojson").appendTo(n);for(var r=0,o=t.docIds.length;r<o;++r){var s=t.docIds[r];$('<input type="hidden" name="name"></input>').val(s).appendTo(n)}$("body").append(n),n.submit()},exportBySchemaName:function(e){var t=$n2.extend({schemaName:null,targetWindow:null,filter:"all",contentType:null,fileName:null,format:null,onError:$n2.reportError},e);t.schemaName||t.onError("schemaName must be provided when exporting by schema name"),t.docIds=void 0,t.layerId=void 0,t.targetWindow?this._exportByForm(t):this._exportByAjax(t)},exportByLayerId:function(e){var t=$n2.extend({layerId:null,targetWindow:null,filter:"all",contentType:null,fileName:null,format:null,onError:$n2.reportError},e);t.layerId||t.onError("layerId must be provided when exporting by layer identifier"),t.docIds=void 0,t.schemaName=void 0,t.targetWindow?this._exportByForm(t):this._exportByAjax(t)},_exportByForm:function(e){var t=$n2.extend({docIds:null,schemaName:null,layerId:null,targetWindow:null,filter:"all",contentType:"application/binary",fileName:null,format:null,onError:$n2.reportError},e),i=this.serverUrl+"export/definition/";t.fileName?i+=t.fileName:i+="export";var n=$("<form>").attr("action",i).attr("method","POST").css({display:"none",visibility:"hidden"});if(t.targetWindow&&n.attr("target",t.targetWindow),t.docIds){$("<input>").attr("type","hidden").attr("name","method").attr("value","doc-id").appendTo(n);for(var r=0,o=t.docIds.length;r<o;++r){var s=t.docIds[r];$("<input>").attr("type","hidden").attr("name","name").val(s).appendTo(n)}}else t.schemaName?($("<input>").attr("type","hidden").attr("name","method").attr("value","schema").appendTo(n),$("<input>").attr("type","hidden").attr("name","name").val(t.schemaName).appendTo(n)):t.layerId?($("<input>").attr("type","hidden").attr("name","method").attr("value","layer").appendTo(n),$("<input>").attr("type","hidden").attr("name","name").val(t.layerId).appendTo(n)):t.onError("Unrecognized export method");t.contentType&&$("<input>").attr("type","hidden").attr("name","contentType").val(t.contentType).appendTo(n),t.filter?$("<input>").attr("type","hidden").attr("name","filter").val(t.filter).appendTo(n):$("<input>").attr("type","hidden").attr("name","filter").val("all").appendTo(n),t.format?$("<input>").attr("type","hidden").attr("name","format").val(t.format).appendTo(n):$("<input>").attr("type","hidden").attr("name","format").val("geojson").appendTo(n),$("body").append(n),n.submit()},_exportByAjax:function(e){var t=$n2.extend({docIds:null,schemaName:null,layerId:null,filter:"all",format:null,onSuccess:function(e){},onError:$n2.reportError},e),i=this.serverUrl+"export/definition/export",n={};t.docIds?(n.method="doc-id",n.name=t.docIds):t.schemaName?(n.method="schema",n.name=t.schemaName):t.layerId?(n.method="layer",n.name=t.layerId):t.onError("Unrecognized export method"),t.contentType&&(n.contentType="text/plain"),t.filter?n.filter=t.filter:n.filter="all",t.format?n.format=t.format:n.format="geojson",$.ajax({url:i,type:"POST",data:n,traditional:!0,dataType:"text",success:function(e,i,n){t.onSuccess(e)},error:function(e,i,n){var r=$n2.utils.parseHttpJsonError(e,i);t.onError(r.error,r)}})}});$n2.couchExport={ExportService:ExportService,ExportApplication:ExportApplication}}(jQuery,nunaliit2),function(e){var t="n2.couchDispatchSupport",i=e.Class("DispatchSupport",{dispatchService:null,initialize:function(i){var n=e.extend({dispatchService:null},i),r=this;if(this.dispatchService=n.dispatchService,this.dispatchService){this.dispatchService.register(t,"editClosed",function(e){r._handleDispatch(e)})}$(window).resize(function(){r._windowResized()})},_handleDispatch:function(e){e.type},_windowResized:function(){var e=this.dispatchService;e&&e.send(t,{type:"windowResized"})}});e.couchDispatchSupport={DispatchSupport:i}}(nunaliit2),function(e){var t="n2.couchEvents",i=e.Class("SelectionRedirector",{dispatchService:null,eventService:null,atlasDb:null,customService:null,showService:null,originalEventHandler:null,currentSelectionNumber:null,currentFocusNumber:null,popupMaxLines:null,suppressEmptySelection:null,forceEmptyFocus:null,initialize:function(t){var i=e.extend({dispatchService:null,eventService:null,atlasDb:null,customService:null,showService:null,popupMaxLines:12,suppressEmptySelection:!1,forceEmptyFocus:!1},t),n=this;if(this.dispatchService=i.dispatchService,this.eventService=i.eventService,this.atlasDb=i.atlasDb,this.customService=i.customService,this.showService=i.showService,this.popupMaxLines=i.popupMaxLines,this.suppressEmptySelection=!1,i.suppressEmptySelection&&(this.suppressEmptySelection=!0),this.forceEmptyFocus=!1,i.forceEmptyFocus&&(this.forceEmptyFocus=!0),!this.dispatchService)throw new Error("SelectionRedirector requires dispatchService");if(!this.eventService)throw new Error("SelectionRedirector requires eventService");if(!this.atlasDb)throw new Error("SelectionRedirector requires atlasDb");this.currentSelectionNumber=0,this.currentFocusNumber=0,this.originalEventHandler=this.eventService.getHandler(),this.eventService.register("userSelect"),this.eventService.register("userFocusOn"),this.eventService.setHandler(function(e,t,i){n._handleEvent(e,t,i)}),this.customService&&this.showService&&this.customService.setOption("mapFeaturePopupCallback",function(e){n._handleMapFeaturePopup(e)})},_retrieveDocuments:function(i){var n=e.extend({docId:null,docIds:null,doc:null,docs:null,onSuccess:function(e){},onError:function(e){}},i),r=this;function o(e){var i=[],o=[];e.forEach(function(e){var n=void 0;if(r.dispatchService){var s={type:"cacheRetrieveDocument",docId:e};r.dispatchService.synchronousCall(t,s),n=s.doc}n?i.push(n):o.push(e)}),o.length<1?n.onSuccess(i):r.atlasDb.getDocuments({docIds:o,onSuccess:function(e){e.forEach(function(e){i.push(e)}),n.onSuccess(i)},onError:function(e){n.onError(e)}})}n.doc?n.onSuccess([n.doc]):n.docs?n.onSuccess(n.docs):n.docId?o([n.docId]):n.docIds&&o(n.docIds)},_handleUserSelect:function(e,i,n,r){var o=this;this._getDocumentsFromSelectedDocument({docId:e.docId,docIds:e.docIds,doc:e.doc,docs:e.docs,isSelect:!0,onSuccess:function(i,n){if(r===o.currentSelectionNumber){var s={};for(var a in e){var l=e[a];s[a]=l}if(i.length>1){delete s.docId,delete s.docIds,delete s.doc,delete s.docs,s.type="selected",s.docIds=[],s.docs=[];for(var c=0,d=i.length;c<d;++c){var u=i[c];s.docs.push(u),s.docIds.push(u._id)}o.dispatchService.send(t,s)}else i.length>0?(delete s.docId,delete s.docIds,delete s.doc,delete s.docs,s.type="selected",s.doc=i[0],s.docId=i[0]._id,o.dispatchService.send(t,s)):o.suppressEmptySelection||(s.type="selected",o.dispatchService.send(t,s));n&&i.length>0&&n.forEach(function(e){o.dispatchService.send(t,{type:"selectedSupplement",docId:e,origin:i[0]._id})})}},onError:function(t){r===o.currentSelectionNumber&&this._performOriginalHandler(e,i,n)}})},_handleUserFocus:function(e,i,n,r){var o=this;this._getDocumentsFromSelectedDocument({docId:e.docId,docIds:e.docIds,doc:e.doc,docs:e.docs,isFocus:!0,onSuccess:function(i,n){if(r===o.currentFocusNumber){var s={};for(var a in e){var l=e[a];s[a]=l}if(i.length>1){delete s.docId,delete s.docIds,delete s.doc,delete s.docs,s.type="focusOn",s.docIds=[],s.docs=[];for(var c=0,d=i.length;c<d;++c){var u=i[c];s.docs.push(u),s.docIds.push(u._id)}o.dispatchService.send(t,s)}else i.length>0?(delete s.docId,delete s.docIds,delete s.doc,delete s.docs,s.type="focusOn",s.doc=i[0],s.docId=i[0]._id,o.dispatchService.send(t,s)):o.forceEmptyFocus&&(s.type="focusOn",o.dispatchService.send(t,s));n&&i.length>0&&n.forEach(function(e){o.dispatchService.send(t,{type:"focusOnSupplement",docId:e,origin:i[0]._id})})}},onError:function(t){r===o.currentFocusNumber&&this._performOriginalHandler(e,i,n)}})},_getDocumentsFromSelectedDocument:function(t){var i=e.extend({docId:null,docIds:null,doc:null,docs:null,isSelect:!1,isFocus:!1,onSuccess:function(e,t){},onError:function(e){}},t),n=this;this._retrieveDocuments({docId:i.docId,docIds:i.docIds,doc:i.doc,docs:i.docs,onSuccess:function(e){n.translateUserSelection({docs:e,isSelect:i.isSelect,isFocus:i.isFocus,onSuccess:i.onSuccess,onError:i.onError})},onError:function(t){e.log("Error while retrieving selected documents",t),i.onError(t)}})},translateUserSelection:function(t){var i=e.extend({docs:null,isSelect:!1,isFocus:!1,onSuccess:function(e,t){},onError:function(e){}},t);i.onSuccess(i.docs,[])},_handleEvent:function(e,t,i){var n=!1;"userSelect"===e.type?(this.currentSelectionNumber=this.currentSelectionNumber+1,this._handleUserSelect(e,t,i,this.currentSelectionNumber),n=!0):"userFocusOn"===e.type&&(this.currentFocusNumber=this.currentFocusNumber+1,this._handleUserFocus(e,t,i,this.currentFocusNumber),n=!0),n||this._performOriginalHandler(e,t,i)},_performOriginalHandler:function(e,t,i){this.originalEventHandler(e,t,i)},_handleMapFeaturePopup:function(t){var i=e.extend({feature:null,layerInfo:null,onSuccess:function(e){},onError:function(e){}},t),n=this,r=i.feature,o=[];if(r.cluster)r.cluster.forEach(function(e){var t=e.data;t&&o.push(t)});else{var s=r.data;s&&o.push(s)}function a(){var e=$("<div></div>"),t=r.data;n.showService.displayBriefDescription(e,{},t);var o=e.html();i.onSuccess(o)}this._getDocumentsFromSelectedDocument({docs:o,onSuccess:function(e,t){var r,o;e.length>0?(r=e,o=n.generatePopupHtmlFromDocuments(r),i.onSuccess(o)):a()},onError:a})},generatePopupHtmlFromDocuments:function(t){var i,n,r=this,o=this.popupMaxLines,s=$("<div>"),a=t.length,l=0;if(a>o&&(l=a- --o),t.forEach(function(e){if(o>0){--o;var t=$("<div>").addClass("n2redirect_popup_line n2redirect_popup_doc").appendTo(s);r.showService.displayBriefDescription(t,{},e)}}),l>0)$("<div>").addClass("n2redirect_popup_line n2redirect_popup_overflow").text((i="More lines... ({num})",n={num:l},e.loc(i,"nunaliit2-couch",n))).appendTo(s);return s.html()}}),n=e.Class("EventSupport",{options:null,dispatchCallback:null,handler:null,registeredEvents:null,initialize:function(t){this.options=e.extend({directory:null},t);var i=this;this.registeredEvents={},this.handler=function(e,t,n){i._defaultHandler(e,t,n)},this.dispatchCallback=function(e,t,n){i.handler(e,t,n)},this.register("userSelect"),this.register("userUnselect"),this.register("userFocusOn"),this.register("userFocusOff")},register:function(e){if(!this.registeredEvents[e]){var i=this._getDispatcher();i&&i.register(t,e,this.dispatchCallback),this.registeredEvents[e]=!0}},setHandler:function(e){"function"==typeof e&&(this.handler=e)},getHandler:function(){return this.handler},_getDispatcher:function(){var e=null;return this.options.directory&&(e=this.options.directory.dispatchService),e},_dispatch:function(e){var i=this._getDispatcher();i&&i.send(t,e)},_defaultHandler:function(e,i,n){if("userSelect"===e.type){var r=!0,o=this._getDispatcher();if(o){var s={type:"historyIsHashChangePermitted",permitted:!0};o.synchronousCall(t,s),s.permitted||(r=!1)}if(r){var a={type:"selected"};for(var l in e)"type"===l?a.type="selected":a[l]=e[l];this._dispatch(a)}else this._dispatch({type:"userSelectCancelled"})}else if("userUnselect"===e.type){a={};for(var l in e)a[l]=e[l];a.type="unselected",this._dispatch(a)}else"userFocusOn"===e.type?this._dispatch({type:"focusOn",docId:e.docId,doc:e.doc,docIds:e.docIds,docs:e.docs,feature:e.feature}):"userFocusOff"===e.type&&this._dispatch({type:"focusOff",docId:e.docId,doc:e.doc,docIds:e.docIds,docs:e.docs,feature:e.feature})}});e.couchEvents={EventSupport:n,SelectionRedirector:i}}(nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)};function n(e,t,i){return!!t&&("_id"!==t[0]&&"_rev"!==t[0])}function r(e,t,i){return!!t&&("_id"!==t[0]&&"_rev"!==t[0])}function o(e,t,i){return!!t&&("_id"!==t[0]&&"_rev"!==t[0])}function s(e,n){var r=t.utils.parseHttpJsonError(e,n);return r.tokenExpired?i("The information is expired."):r.userUpdated?i("Unable to complete operation because the user information has been updated."):i("Unable to complete operation : {err}",{err:r.error})}var a=t.Class({userDoc:null,userSchema:null,schemaEditorService:null,configService:null,originalDoc:null,userDb:null,elemId:null,schemaEditor:null,treeEditor:null,onPreSaveFn:null,onSavedFn:null,onPreDeleteFn:null,onDeletedFn:null,onCancelledFn:null,onFinishedFn:null,showServerRoles:null,initialize:function(i){var n=t.extend({userDoc:null,userDb:null,elem:null,elemId:null,userSchema:null,schemaRepository:null,schemaEditorService:null,configService:null,onPreSaveFn:function(e){return!0},onSavedFn:function(e){},onPreDeleteFn:function(e){return!0},onDeletedFn:function(e){},onCancelledFn:function(e){},onFinishedFn:function(e){},showServerRoles:!1},i),r=this;if(this.userDoc=n.userDoc,this.userDb=n.userDb,this.onPreSaveFn=n.onPreSaveFn,this.onSavedFn=n.onSavedFn,this.onPreDeleteFn=n.onPreDeleteFn,this.onDeletedFn=n.onDeletedFn,this.onCancelledFn=n.onCancelledFn,this.onFinishedFn=n.onFinishedFn,this.schemaEditorService=n.schemaEditorService,this.configService=n.configService,this.showServerRoles=n.showServerRoles,this.originalDoc=t.extend(!0,{},this.userDoc),this.userDoc.nunaliit_emails||(this.userDoc.nunaliit_emails=[]),this.elemId=n.elemId,n.elem){var o=e(n.elem),s=o.attr("id");s||(s=t.getUniqueId(),o.attr("id",s)),this.elemId=s}function a(e){r.userSchema=e,r._display()}n.userSchema?a(n.userSchema):n.schemaRepository?n.schemaRepository.getSchema({name:"user",onSuccess:function(e){a(e)},onError:function(){a(null)}}):a(null)},documentUpdated:function(){this._refresh()},_getElem:function(){return e("#"+this.elemId)},_getCouchServer:function(){return this.userDb.getServer()},_display:function(){var s=this,a=this.userDoc,l=this._getElem();l.empty();var c=e('<div class="n2UserEdit_editor"></div>').appendTo(l),d=e('<div class="n2UserEdit_editorContainer"></div>').appendTo(c),u=!1;if(this.userSchema&&this.schemaEditorService){u=!0,e('<h3><a href="#">'+i("Form View")+"</a></h3>").appendTo(d);var h=e('<div class="n2UserEdit_schemaEditor"></div>').appendTo(d);this.schemaEditor=this.schemaEditorService.editDocument({doc:a,schema:this.userSchema,$div:h,onChanged:function(){s.treeEditor&&s.treeEditor.refresh()}})}u&&e('<h3><a href="#">'+i("Tree View")+"</a></h3>").appendTo(d);var p=e('<div class="n2UserEdit_treeEditor"></div>').appendTo(d),f=new t.tree.ObjectTree(p,a);this.treeEditor=new t.tree.ObjectTreeEditor(f,a,{onObjectChanged:function(){s.schemaEditor&&s.schemaEditor.refresh()},isKeyEditingAllowed:n,isValueEditingAllowed:r,isKeyDeletionAllowed:o}),u&&d.accordion({heightStyle:"content",autoHeight:!1,clearStyle:!0});var m=e('<div class="n2UserEdit_buttons"></div>').appendTo(c);e('<input type="button"/>').addClass("n2UserEdit_saveButton").val(i("Save")).appendTo(m).click(function(){return s._save(),!1}),e('<input type="button"/>').addClass("n2UserEdit_deleteButton").val(i("Delete")).appendTo(m).click(function(){return s._delete(),!1}),e('<input type="button"/>').addClass("n2UserEdit_rolesButton").val(i("Roles")).appendTo(m).click(function(e){return s._rolesDialog(a,function(e){e.length>0?a.roles=e:a.roles&&delete a.roles,s.treeEditor.refresh()}),!1}),e('<input type="button"/>').addClass("n2UserEdit_passwordButton").val(i("Set Password")).appendTo(m).click(function(e){return s._passwordDialog(),!1}),e('<input type="button"/>').addClass("n2UserEdit_cancelButton").val(i("Cancel")).appendTo(m).click(function(e){return s._cancel(),!1})},_refresh:function(){this.treeEditor.refresh()},_rolesDialog:function(n,r){var o=t.getUniqueId(),s=e('<div id="'+o+'" class="n2_roles_dialog"></div>');e('<div class="n2_roles_list"></div>').appendTo(s).append(e('<div class="olkit_wait"></div>'));var a=e('<div class="n2_roles_buttons"></div>').appendTo(s);e('<input type="button"/>').val(i("OK")).appendTo(a).click(function(){var t=e("#"+o),i=[];t.find("input[type=checkbox]:checked").each(function(){var t=e(this);i.push(t.attr("name"))}),r(i),t.dialog("close")}),e('<input type="button"/>').val(i("Cancel")).appendTo(a).click(function(){e("#"+o).dialog("close")});var l={autoOpen:!0,title:i("Select Roles"),modal:!0,width:740,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};function c(i){for(var r={},s=0,a=i.length;s<a;++s)r[i[s]]=!1;if(n.roles)for(s=0,a=n.roles.length;s<a;++s)r[n.roles[s]]=!0;for(var l in i=[],r)i.push(l);i.sort();var c=e("#"+o).find(".n2_roles_list");c.empty();for(s=0,a=i.length;s<a;++s){l=i[s];var d=e("<div></div>"),u=t.getUniqueId(),h=e('<input type="checkbox"/>').attr("name",l).attr("id",u).appendTo(d);r[l]&&h.attr("checked","checked"),e("<label/>").attr("for",u).text(l).appendTo(d),c.append(d)}}s.dialog(l),this.configService&&this.showServerRoles?this.configService.getNunaliitServerRoles({onSuccess:function(e){c(e)},onError:function(e){c([])}}):this.configService?this.configService.getAtlasRoles({onSuccess:function(e){c(e)},onError:function(e){c([])}}):c([])},_passwordDialog:function(){var n=this,r=t.getUniqueId(),o=e('<div id="'+r+'" class="n2User_setPassword_dialog"></div>'),s=e('<div class="n2User_setPassword_inputs"></div>').appendTo(o),a=t.getUniqueId(),l=e("<div></div>").appendTo(s);e("<label/>").attr("for",a).text(i("Enter password:")).appendTo(l),e('<input type="password" name="password"/>').attr("id",a).appendTo(l);a=t.getUniqueId(),l=e("<div></div>").appendTo(s);e("<label/>").attr("for",a).text(i("Confirm password:")).appendTo(l),e('<input type="password" name="confirm"/>').attr("id",a).appendTo(l);var c=e('<div class="n2User_setPassword_buttons"></div>').appendTo(o);e('<input type="button"/>').val(i("OK")).appendTo(c).click(function(){var t=e("#"+r),o=t.find("input[name=password]").val();o!=t.find("input[name=confirm]").val()?alert(i("Passwords do not match")):o.length<6?alert(i("Password is too short")):n.userDb.computeUserPassword({userDoc:n.userDoc,password:o,onSuccess:function(){n._refresh(),t.dialog("close")},onError:function(e){alert(i("Unable to set password: ")+e)}})}),e('<input type="button"/>').val(i("Cancel")).appendTo(c).click(function(){e("#"+r).dialog("close")});var d={autoOpen:!0,title:i("Change Password"),modal:!0,width:740,close:function(t,i){var n=e(t.target);n.dialog("destroy"),n.remove()}};o.dialog(d)},_save:function(){var e=this;this.onPreSaveFn(this.userDoc),this.userDb.updateUser({user:this.userDoc,onSuccess:function(i){e.userDoc._rev=i.rev,e.originalDoc=t.extend(!0,{},e.userDoc),e._refresh(),e.onSavedFn(e.userDoc),e.onFinishedFn(e.userDoc)},onError:function(e){alert(i("Unable to save user document: ")+e)}})},_delete:function(){var e=this;0!=confirm("You are about delete a user configuration object. Do you wish to proceed?")&&(this.onPreDeleteFn(this.userDoc),this.userDb.deleteUser({user:this.userDoc,onSuccess:function(){e._getElem().empty(),e.onDeletedFn(e.userDoc),e.onFinishedFn(e.userDoc)},onError:function(e){alert(i("Unable to delete user document: ")+e)}}))},_cancel:function(){patcher.computePatch(this.originalDoc,this.userDoc)&&0==confirm(i("Document was modified and changes will be lost. Do you wish to continue?"))||(this._getElem().empty(),this.onCancelledFn(this.userDoc),this.onFinishedFn(this.userDoc))}}),l=t.Class({userDb:null,userServerUrl:null,userSchema:null,schemaRepository:null,schemaEditorService:null,configService:null,showServerRoles:null,initialize:function(e){var i=t.extend({userDb:null,userServerUrl:null,configService:null,userSchema:null,schemaRepository:null,schemaEditorService:null,customService:null},e);(this.showServerRoles=!1,this.userDb=i.userDb,this.userServerUrl=i.userServerUrl,this.configService=i.configService,this.userSchema=i.userSchema,this.schemaRepository=i.schemaRepository,this.schemaEditorService=i.schemaEditorService,i.customService)&&(i.customService.getOption("userShowServerRoles",!1)&&(this.showServerRoles=!0))},startEdit:function(e){var i=t.extend({userSchema:this.userSchema,schemaRepository:this.schemaRepository,schemaEditorService:this.schemaEditorService,showServerRoles:this.showServerRoles},e,{userDb:this.userDb,configService:this.configService});return new a(i)},initiateUserCreation:function(i){var n=t.extend({emailAddress:null,onSuccess:function(){},onError:function(e){}},i),r=this.userServerUrl+"initUserCreation";e.ajax({url:r,type:"GET",async:!0,traditional:!0,data:{email:n.emailAddress},dataType:"json",success:function(e){e.error?n.onError(e.error):n.onSuccess(e)},error:function(e,t,i){var r=s(e,t);n.onError(r)}})},validateUserCreation:function(i){var n=t.extend({token:null,onSuccess:function(){},onError:function(e){}},i),r=this.userServerUrl+"validateUserCreation";e.ajax({url:r,type:"GET",async:!0,traditional:!0,data:{token:n.token},dataType:"json",success:function(e){e.error?n.onError(e.error):n.onSuccess(e)},error:function(e,t,i){var r=s(e,t);n.onError(r)}})},completeUserCreation:function(i){var n=t.extend({token:null,displayName:null,password:null,sendEmailPasswordReminder:!1,userAgreement:null,onSuccess:function(){},onError:function(e){}},i),r=this.userServerUrl+"completeUserCreation";e.ajax({url:r,type:"POST",async:!0,traditional:!0,data:{token:n.token,display:n.displayName,password:n.password,emailPassword:n.sendEmailPasswordReminder,userAgreement:n.userAgreement},dataType:"json",success:function(e){e.error?n.onError(e.error):n.onSuccess(e)},error:function(e,t,i){var r=s(e,t);n.onError(r)}})},initiatePasswordRecovery:function(i){var n=t.extend({emailAddress:null,onSuccess:function(){},onError:function(e){}},i),r=this.userServerUrl+"initPasswordRecovery";e.ajax({url:r,type:"GET",async:!0,traditional:!0,data:{email:n.emailAddress},dataType:"json",success:function(e){e.error?n.onError(e.error):n.onSuccess(e)},error:function(e,t,i){var r=s(e,t);n.onError(r)}})},validatePasswordRecovery:function(i){var n=t.extend({token:null,onSuccess:function(){},onError:function(e){}},i),r=this.userServerUrl+"validatePasswordRecovery";e.ajax({url:r,type:"GET",async:!0,traditional:!0,data:{token:n.token},dataType:"json",success:function(e){e.error?n.onError(e.error):n.onSuccess(e)},error:function(e,t,i){var r=s(e,t);n.onError(r)}})},completePasswordRecovery:function(i){var n=t.extend({token:null,password:null,sendEmailPasswordReminder:!1,onSuccess:function(){},onError:function(e){}},i),r=this.userServerUrl+"completePasswordRecovery";e.ajax({url:r,type:"GET",async:!0,traditional:!0,data:{token:n.token,password:n.password,emailPassword:n.sendEmailPasswordReminder},dataType:"json",success:function(e){e.error?n.onError(e.error):n.onSuccess(e)},error:function(e,t,i){var r=s(e,t);n.onError(r)}})},generatePassword:function(i){var n=t.extend({onSuccess:function(e){},onError:function(e){}},i),r=this.userServerUrl+"generatePassword";e.ajax({url:r,type:"GET",async:!0,traditional:!0,data:{},dataType:"json",success:function(e){e.error?n.onError(e.error):n.onSuccess(e.password)},error:function(e,t,i){var r=s(e,t);n.onError(r)}})},acceptUserAgreement:function(i){var n=t.extend({userAgreement:null,onSuccess:function(){},onError:function(e){}},i),r=this.userServerUrl+"acceptUserAgreement";e.ajax({url:r,type:"POST",async:!0,traditional:!0,data:{userAgreement:n.userAgreement},dataType:"json",success:function(e){n.onSuccess()},error:function(e,t,i){var r=s(e,t);n.onError(r)}})}});t.couchUser={UserEditor:a,UserService:l}}(jQuery,nunaliit2),function(e,t){var i=function(e,i){return t.loc(e,"nunaliit2-couch",i)},n=function(n){var r=t.extend({db:null,id:null,onSuccess:function(e){},onError:function(e){}},n);r.db||r.onError(i("A database must be provided")),r.id||r.onError(i("A document identifier must be provided")),r.db.getDocument({docId:r.id,onSuccess:function(n){n&&n.nunaliit_help?"html"===n.nunaliit_help.type?r.onSuccess(n.nunaliit_help):"text"===n.nunaliit_help.type?r.onSuccess(n.nunaliit_help):"attachment"===n.nunaliit_help.type?function(n){if(n.nunaliit_help.attachmentName){var o=t.l10n.getStringForLocale(n.nunaliit_help.attachmentName);if(o.str){var s=r.db.getAttachmentUrl(n,o.str);return void e.ajax({url:s,type:"get",async:!0,success:function(t){var i=t;if(o.fallback){var s=e('<span class="n2_localized_string n2_localize_fallback"></span>');e('<span class="n2_localize_fallback_lang"></span>').text("("+o.lang+")").appendTo(s),e("<span></span>").html(t).appendTo(s),i=s.html()}n.nunaliit_help.type="html",n.nunaliit_help.content=i,r.onSuccess(n.nunaliit_help)},error:function(e,t,n){r.onError(i("Error fetching attachment from help document"))}})}}r.onError(i("Invalid attachment in help document"))}(n):r.onError(i("Unknown type for help document: {docId}",{docId:r.id})):r.onError(i("Invalid help document: {docId}",{docId:r.id}))},onError:function(e){r.onError(i("Unable to access help document: {docId}",{docId:r.id}))}})};function r(e){var i=t.extend({db:null,id:null,key:null,onSuccess:function(){},onError:function(e){}},e);n({db:i.db,id:i.id,onSuccess:function(e){t.help.InstallHelpInfo(i.key,e),i.onSuccess()},onError:i.onError})}t.couchHelp={LoadHelpDocument:n,InstallHelpDocument:r,CheckBrowserCompliance:function(e){var n=t.extend({db:null,helpDocumentId:"help.browsers"},e),o=t.utils.getBrowserInfo();o&&"Explorer"===o.browser&&"number"==typeof o.version&&(9==o.version||o.version<8)&&function(e){r({db:e.db,id:e.helpDocumentId,key:"browsers",onSuccess:function(){t.help.ShowHelp("browsers")},onError:function(){alert(i("Your browser is not supported by this web site."))}})}(n)}}}(jQuery,nunaliit2),function(e,t){var i,n=function(e,i){return t.loc(e,"nunaliit2-couch",i)},r="n2.couchDocument";function o(e){var n=null;if(i){var o={type:"authIsLoggedIn"};i.synchronousCall(r,o);var s=o.context;s&&(n=s.name)}var a=(new Date).getTime();n&&(e.nunaliit_created||e._rev||(e.nunaliit_created={nunaliit_type:"actionstamp",name:n,time:a,action:"created"}),e.nunaliit_last_updated={nunaliit_type:"actionstamp",name:n,time:a,action:"updated"});var l=[];t.couchUtils.extractSpecificType(e,"date",l);for(var c=0,d=l.length;c<d;++c){var u=l[c];if(u.date)try{var h=t.date.parseUserDate(u.date);u.min=h.min,u.max=h.max}catch(d){u.min&&delete u.min,u.max&&delete u.max}}}var s=t.Class({dispatchService:null,documentSource:null,dbChangeNotifier:null,initialize:function(e){var i=t.extend({atlasDb:null,dispatchService:null,documentSource:null},e),n=this;this.dispatchService=i.dispatchService,this.documentSource=i.documentSource,i.atlasDb&&i.atlasDb.getChangeNotifier({onSuccess:function(e){n.dbChangeNotifier=e,n.dbChangeNotifier&&n.dbChangeNotifier.addListener(function(e){n._dbChanges(e)})}})},_dbChanges:function(e){var i=this;t.log("update",e);var n=e.results;if(this.dispatchService)for(var o=0,s=n.length;o<s;++o){var a=n[o],l=!1,c=null;if(a.changes)for(var d=0,u=a.changes.length;d<u;++d)"1-"===(c=a.changes[d].rev).substr(0,2)&&(l=!0);c&&this.dispatchService.send(r,{type:"documentVersion",docId:a.id,rev:c}),a.deleted?this.dispatchService.send(r,{type:"documentDeleted",docId:a.id}):l?(this.dispatchService.send(r,{type:"documentCreated",docId:a.id}),this.documentSource.getDocument({docId:a.id,onSuccess:function(e){i._docUploaded(e,!0)}})):(this.dispatchService.send(r,{type:"documentUpdated",docId:a.id}),this.documentSource.getDocument({docId:a.id,onSuccess:function(e){i._docUploaded(e,!1)}}))}},_docUploaded:function(e,t){if(this.dispatchService){var i=t?"documentContentCreated":"documentContentUpdated";this.dispatchService.send(r,{type:i,docId:e._id,doc:e})}}}),a=t.Class("CouchDocumentSource",t.document.DocumentSource,{db:null,designDoc:null,dispatchService:null,attachmentService:null,geometryRepository:null,isDefaultDocumentSource:null,notifier:null,initialize:function(e){var n=t.extend({id:null,db:null,dispatchService:null,attachmentService:null,isDefaultDocumentSource:!1},e),o=this;if(t.document.DocumentSource.prototype.initialize.call(this,n),this.db=n.db,this.attachmentService=n.attachmentService,this.dispatchService=n.dispatchService,this.dispatchService&&(i=this.dispatchService),this.isDefaultDocumentSource=n.isDefaultDocumentSource,this.designDoc=this.db.getDesignDoc({ddName:"atlas"}),this.geometryRepository=new l({db:this.db,designDoc:this.designDoc,dispatchService:this.dispatchService}),this.dispatchService){this.dispatchService.register(r,"documentSourceFromDocument",function(e,t,i){o._handle(e,t,i)})}this.notifier=new s({atlasDb:this.db,dispatchService:this.dispatchService,documentSource:this})},adoptDocument:function(e){e.__n2Source=this.getId()},createDocument:function(e){var i=t.extend({doc:{},onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},e),n=this,r=i.doc;o(r),this.db.createDocument({data:r,onSuccess:function(e){r._id=e.id,r._rev=e.rev,n.adoptDocument(r),n._dispatch({type:"documentVersion",docId:e.id,rev:e.rev}),n._dispatch({type:"documentCreated",docId:e.id}),n._dispatch({type:"documentContentCreated",docId:r._id,doc:r}),i.onSuccess(r)},onError:i.onError})},getDocument:function(e){var i=t.extend({docId:null,rev:null,revs_info:!1,revisions:!1,conflicts:!1,deleted_conflicts:!1,onSuccess:function(e){},onError:function(e){}},e),n=this;this.db.getDocument({docId:i.docId,rev:i.rev,revs_info:i.revs_info,revisions:i.revisions,conflicts:i.conflicts,deleted_conflicts:i.deleted_conflicts,onSuccess:function(e){n.adoptDocument(e),i.onSuccess(e)},onError:i.onError})},getDocuments:function(e){var i=t.extend({docIds:null,onSuccess:function(e){},onError:function(e){}},e),n=this;this.db.getDocuments({docIds:i.docIds,onSuccess:function(e){for(var t=0,r=e.length;t<r;++t){var o=e[t];n.adoptDocument(o)}i.onSuccess(e)},onError:i.onError})},getDocumentAttachments:function(e){return this.attachmentService.getAttachments(e,this)},getDocumentAttachment:function(e,t){return this.attachmentService.getAttachment(e,t,this)},getDocumentAttachmentUrl:function(e,t){return this.db.getAttachmentUrl(e,t)},verifyDocumentExistence:function(e){var i=t.extend({docIds:null,onSuccess:function(e){},onError:function(e){}},e),n=i.docIds;this.db.getDocumentRevisions({docIds:n,onSuccess:function(e){var t={};for(var n in e)t[n]={rev:e[n]};i.onSuccess(t)},onError:i.onError})},updateDocument:function(e){var i=t.extend({doc:null,originalDoc:null,onSuccess:function(e){},onError:function(e){}},e),r=this,s=i.doc;o(s);var a={};for(var l in s)"__n2Source"===l||(a[l]=s[l]);function c(e){r.db.getDocument({docId:s._id,skipCache:!0,onSuccess:function(n){!function(e,n){var o=patcher.computePatch(i.originalDoc,s);t.log("Conflict detected. Applying patch.",o),patcher.applyPatch(e,o),o.nunaliit_geom&&e.nunaliit_geom&&e.nunaliit_geom.simplified&&delete e.nunaliit_geom.simplified;r.db.updateDocument({data:e,onSuccess:d,onError:function(e){n&&t.error.checkErrorCondition(e,"couchDb_conflict")?(t.couch.setBadProxy(!0),t.debug.setBadProxy(!0),t.log("Assuming that operations are behind a bad proxy"),c(!1)):u(e)}})}(n,e)},onError:function(e){u(t.error.fromString(n("Unable to reload conflicting document"),e))}})}function d(e){s._id=e.id,s._rev=e.rev,r.adoptDocument(s),r._dispatch({type:"documentVersion",docId:e.id,rev:e.rev}),r._dispatch({type:"documentUpdated",docId:e.id}),r._dispatch({type:"documentContentUpdated",docId:s._id,doc:s}),i.onSuccess(s)}function u(e){var r=t.error.fromString(n("Error while updating document {id}",{id:s._id}),e);i.onError(r)}this.db.updateDocument({data:a,onSuccess:d,onError:function(e){i.originalDoc&&t.error.checkErrorCondition(e,"couchDb_conflict")?c(!0):u(e)}})},deleteDocument:function(e){var i=t.extend({doc:null,onSuccess:function(){},onError:function(e){t.reportErrorForced(e)}},e),r=this,o=i.doc,s={};for(var a in o)"__n2Source"===a||(s[a]=o[a]);function l(){r._dispatch({type:"documentDeleted",docId:o._id}),i.onSuccess()}function c(e){var r=t.error.fromString(n("Unable to delete document {id}",{id:o._id}),e);i.onError(r)}this.db.deleteDocument({data:s,onSuccess:l,onError:function(e){t.error.checkErrorCondition(e,"couchDb_conflict")?(t.log("Conflict document detected during deletion"),function e(s){r.db.getDocument({docId:o._id,onSuccess:function(i){r.db.deleteDocument({data:i,onSuccess:l,onError:function(i){s&&t.error.checkErrorCondition(i,"couchDb_conflict")?(t.log("Conflict document detected during deletion"),t.couch.setBadProxy(!0),t.debug.setBadProxy(!0),t.log("Assuming that operations are behind a bad proxy"),e(!1)):c(i)}})},onError:function(e){var r=t.error.fromString(n("Error reloading conflicting document during deletion"),e);i.onError(r)}})}(!0)):c(e)}})},getLayerDefinitions:function(e){var i=t.extend({layerIds:null,fullDocuments:!1,onSuccess:function(e){},onError:function(e){}},e),n=void 0;i.layerIds&&(n=[],i.layerIds.forEach(function(e){n.push(e)})),this.designDoc.queryView({viewName:"layer-definitions",include_docs:!0,keys:n,onSuccess:function(e){for(var t=[],n=0,r=e.length;n<r;++n){var o=e[n].doc;if(i.fullDocuments)t.push(o);else if(o.nunaliit_layer_definition){var s=o.nunaliit_layer_definition;s.id||(s.id=o._id),t.push(s)}}i.onSuccess(t)},onError:i.onError})},getDocumentInfoFromIds:function(e){var i=t.extend({docIds:null,onSuccess:function(e){},onError:function(e){}},e);this.designDoc.queryView({viewName:"info",keys:i.docIds,onSuccess:function(e){for(var t=[],n=0,r=e.length;n<r;++n)t.push(e[n].value);i.onSuccess(t)},onError:i.onError})},getReferencesFromId:function(e){var i=t.extend({docId:null,onSuccess:function(e){},onError:function(e){}},e);this.designDoc.queryView({viewName:"link-references",startkey:i.docId,endkey:i.docId,onSuccess:function(e){for(var t={},n=0,r=e.length;n<r;++n)t[e[n].id]=!0;var o=[];for(var s in t)o.push(s);i.onSuccess(o)},onError:i.onError})},getProductFromId:function(e){var i=t.extend({docId:null,onSuccess:function(e){},onError:function(e){}},e);this.designDoc.queryView({viewName:"nunaliit-source",startkey:i.docId,endkey:i.docId,onSuccess:function(e){for(var t={},n=0,r=e.length;n<r;++n)t[e[n].id]=!0;var o=[];for(var s in t)o.push(s);i.onSuccess(o)},onError:i.onError})},getDocumentsFromGeographicFilter:function(e){var i=t.extend({docIds:null,layerId:null,bbox:null,projectionCode:null,onSuccess:function(e){},onError:function(e){}},e),n=this,r=i.onSuccess;i.onSuccess=function(e){for(var t=0,i=e.length;t<i;++t){var o=e[t];n.adoptDocument(o)}r(e)},this.geometryRepository.getDocumentsFromGeographicFilter(i)},getGeographicBoundingBox:function(e){this.geometryRepository.getGeographicBoundingBox(e)},getReferencesFromOrigin:function(e){var i=t.extend({docId:null,onSuccess:function(e){},onError:function(e){}},e);this.designDoc.queryView({viewName:"nunaliit-origin",startkey:i.docId,endkey:i.docId,onSuccess:function(e){for(var t={},n=0,r=e.length;n<r;++n)t[e[n].id]=!0;var o=[];for(var s in t)o.push(s);i.onSuccess(o)},onError:i.onError})},getUniqueIdentifier:function(e){var i=t.extend({onSuccess:function(e){},onError:function(e){}},e);this.db.getServer().getUniqueId(i)},_dispatch:function(e){this.dispatchService&&this.dispatchService.send(r,e)},_handle:function(e,t,i){if("documentSourceFromDocument"===e.type){var n=e.doc;n&&n.__n2Source===this.getId()?e.documentSource=this:n&&!n.__n2Source&&this.isDefaultDocumentSource&&(e.documentSource=this)}}}),l=t.Class("GeometryRepository",{db:null,designDoc:null,dispatchService:null,dbProjection:null,poles:null,mapProjectionMaxWidth:null,initialize:function(e){var i=t.extend({db:null,designDoc:null,dispatchService:null},e);this.db=i.db,this.designDoc=i.designDoc,this.dispatchService=i.dispatchService,this.dbProjection=new OpenLayers.Projection("EPSG:4326"),this.poles={n:{},s:{}},this.mapProjectionMaxWidth={}},getDocumentsFromGeographicFilter:function(e){var i=t.extend({docIds:null,layerId:null,bbox:null,projectionCode:null,onSuccess:function(e){},onError:function(e){}},e),n=this,o={viewName:"geom",onSuccess:function(e){var t=[],o=[];for(;e.length>0;){var s=e.pop(),a=s.id;if(n.dispatchService){var l={type:"cacheRetrieveDocument",docId:a,doc:null};n.dispatchService.synchronousCall(r,l),l.doc?o.push(l.doc):t.push(a)}else t.push(a)}t.length>0?n.db.getDocuments({docIds:t,onSuccess:function(e){for(var t=0,n=e.length;t<n;++t)o.push(e[t]);i.onSuccess(o)},onError:i.onError}):i.onSuccess(o)},onError:i.onError},s=i.bbox,a=i.docIds,l="string"==typeof i.layerId?i.layerId:null;if(s&&i.projectionCode&&i.projectionCode!=this.dbProjection.getCode()){var c=new OpenLayers.Projection(i.projectionCode),d=new OpenLayers.Bounds(s[0],s[1],s[2],s[3]),u=d.clone().transform(c,this.dbProjection),h=this._getPole(!0,c);if(h&&d.contains(h.x,h.y)){var p=new OpenLayers.Bounds(-180,90,180,90);u.extend(p)}var f=this._getPole(!1,c);if(f&&d.contains(f.x,f.y)){var m=new OpenLayers.Bounds(-180,-90,180,-90);u.extend(m)}s=[u.left,u.bottom,u.right,u.top];var v=this._getMapMaxWidth(c);v&&v<=d.right-d.left&&(s[0]=-180,s[2]=180)}t.couchGeom.selectTileViewFromBounds(o,s,l,a),this.designDoc.queryView(o)},getGeographicBoundingBox:function(e){var i=t.extend({layerId:null,bbox:null,onSuccess:function(e){},onError:function(e){}},e);this.designDoc.queryView({viewName:"geom-layer-bbox",startkey:i.layerId,endkey:i.layerId,onlyRows:!0,reduce:!0,onSuccess:function(e){e.length>0?i.onSuccess(e[0].value):i.onSuccess(null)},onError:i.onError})},_getPole:function(e,t){var i=t.getCode(),n=e?"n":"s";if(this.poles[n][i])return this.poles[n][i];if(e)var r=new OpenLayers.Geometry.Point(0,90);else r=new OpenLayers.Geometry.Point(0,-90);var o=!1,s=null;return"undefined"!=typeof Proj4js&&(s=Proj4js.reportError,Proj4js.reportError=function(e){o=!0}),r.transform(this.dbProjection,t),o&&(r=null),s&&(Proj4js.reportError=s),this.poles[n][i]=r,r},_getMapMaxWidth:function(e){var t=e.getCode();if(this.mapProjectionMaxWidth[t])return this.mapProjectionMaxWidth[t];if(e&&e.proj&&"merc"===e.proj.projName){var i=new OpenLayers.Geometry.Point(-180,0),n=new OpenLayers.Geometry.Point(180,0),r=!1,o=null;"undefined"!=typeof Proj4js&&(o=Proj4js.reportError,Proj4js.reportError=function(e){r=!0}),i.transform(this.dbProjection,e),n.transform(this.dbProjection,e),r&&(i=null,n=null),o&&(Proj4js.reportError=o),n&&i&&(this.mapProjectionMaxWidth[t]=i.x-n.x)}return this.mapProjectionMaxWidth[t]}}),c=t.Class("CouchDocumentSourceWithSubmissionDb",a,{submissionDb:null,submissionServerUrl:null,submissionServerDb:null,isSubmissionDataSource:null,deviceId:null,initialize:function(e){var i=t.extend({submissionDb:null,submissionServletUrl:null,deviceId:void 0},e);a.prototype.initialize.call(this,i);var r=this;this.isSubmissionDataSource=!0,this.submissionDb=i.submissionDb,this.submissionServerUrl=i.submissionServerUrl,this.deviceId=i.deviceId;t.couch.getServer({pathToServer:this.submissionServerUrl,skipSessionInitialization:!0,userDbName:"_users",onSuccess:function(e){r.submissionServerDb=e.getDb({dbName:"submissionDb"})},onError:function(e){t.log("Unable to initialize submission server",e),alert(n("Unable to initialize submission database"))}})},createDocument:function(e){var i=t.extend({doc:{},onSuccess:function(e){},onError:function(e){t.reportErrorForced(e)}},e),n=this;if(i.doc||i.onError("Document must be provided"),i.doc._id)s(i.doc._id);else{var r=this.db.getServer();r?r.getUniqueId({onSuccess:s,onError:i.onError}):i.onError("No server associated with database")}function s(e){var t=i.doc;t._id=e,o(t),n.submissionServerDb.createDocument({data:t,deviceId:n.deviceId,onSuccess:function(e){n._warnUser(),n.adoptDocument(t),i.onSuccess(t)},onError:i.onError})}},updateDocument:function(e){var i=t.extend({doc:null,onSuccess:function(e){},onError:function(e){}},e),n=this,r=i.doc;o(r);var s={};for(var a in r)"__n2Source"===a||(s[a]=r[a]);this.submissionServerDb.updateDocument({data:s,deviceId:n.deviceId,onSuccess:function(e){n._warnUser(),i.onSuccess(r)},onError:i.onError})},deleteDocument:function(e){var i=t.extend({doc:null,onSuccess:function(){},onError:function(e){t.reportErrorForced(e)}},e),n=this,r=i.doc;this.submissionServerDb.deleteDocument({data:r,deviceId:n.deviceId,onSuccess:function(e){n._warnUser(),i.onSuccess(r)},onError:i.onError})},_warnUser:function(){var i=!0;if(t.cookie.getCookie("nunaliit_submissions")&&(i=!1),i){var r=t.getUniqueId(),o=e("<div>").attr("id",r).addClass("n2_submission_warning_dialog");e("<div>").addClass("n2_submission_warning_text").appendTo(o);e("<span>").text(n("Submissions to the database will not appear until they are approved")).appendTo(o);var s=e("<div>").addClass("n2_submission_warning_memory").appendTo(o),a=t.getUniqueId();e('<input type="checkbox">').attr("id",a).appendTo(s),e("<label>").attr("for",a).text(n("Do not show this warning again")).appendTo(s);var l=e("<div>").addClass("n2_submission_warning_buttons").appendTo(o);e("<button>").addClass("n2_button_ok").appendTo(l).text(n("OK")).click(function(){e("#"+r).dialog("close")}),o.dialog({autoOpen:!0,title:n("Warning on Database Submissions"),modal:!0,width:"auto",close:function(i,n){var o=e("#"+r),s=o.find("input[type=checkbox]"),a=!1;s.length>0&&(a=s.is(":checked")),o.remove(),a&&t.cookie.setCookie({name:"nunaliit_submissions",value:"do not warn",end:31536e3,path:"/"})}})}}});t.couchDocument={CouchDocumentSource:a,CouchDocumentSourceWithSubmissionDb:c,adjustDocument:o}}(jQuery,nunaliit2),function(e,t){var i="n2.couchDocumentList",n={},r=t.Class({sourceModelId:null,dispatchService:null,docsById:null,initialize:function(e){var n=t.extend({sourceModelId:null,dispatchService:null},e);this.sourceModelId=n.sourceModelId,this.dispatchService=n.dispatchService,this.docsById={};var r=this;if(this.dispatchService){this.dispatchService.register(i,"modelStateUpdated",function(e,t,i){r._handle(e,t,i)})}this.refresh()},refresh:function(){if(this.sourceModelId){var e=t.model.getModelState({dispatchService:this.dispatchService,modelId:this.sourceModelId});e&&this._sourceModelUpdated(e)}},_handle:function(e,t,i){"modelStateUpdated"===e.type&&this.sourceModelId===e.modelId&&this._sourceModelUpdated(e.state)},_sourceModelUpdated:function(e){if(e.added)for(var t=0,n=e.added.length;t<n;++t){var r=(s=e.added[t])._id;this.docsById[r]=s}if(e.updated)for(t=0,n=e.updated.length;t<n;++t){r=(s=e.updated[t])._id;this.docsById[r]=s}if(e.removed)for(t=0,n=e.removed.length;t<n;++t){r=(s=e.removed[t])._id;this.docsById[r]&&delete this.docsById[r]}var o={type:"documentListResults",listType:"model",listName:this.sourceModelId,docIds:[],docs:[]};for(var r in this.docsById){var s=this.docsById[r];o.docIds.push(r),o.docs.push(s)}this.dispatchService.send(i,o)}}),o=t.Class({atlasDesign:null,dispatchService:null,initialize:function(e){var n=t.extend({atlasDesign:null,dispatchService:null},e),r=this;if(this.atlasDesign=n.atlasDesign,this.dispatchService=n.dispatchService,this.dispatchService){this.dispatchService.register(i,"documentListQuery",function(e,t,i){r._handle(e,t,i)})}},_handle:function(e,t,i){"documentListQuery"===e.type&&("layer"===e.listType?this._handleLayerQuery(e):"schema"===e.listType?this._handleSchemaQuery(e):"model"===e.listType&&this._handleModelQuery(e))},_handleLayerQuery:function(e){var n=this,r=[];if(e.listName)for(var o=0,s=(r=e.listName.split(",")).length;o<s;++o)r[o]=t.trim(r[o]);this.dispatchService&&this.atlasDesign&&r.length>0&&this.atlasDesign.queryView({viewName:"layers",keys:r,include_docs:!0,onSuccess:function(t){for(var r=[],o=[],s=0,a=t.length;s<a;++s)r.push(t[s].id),o.push(t[s].doc);n.dispatchService.send(i,{type:"documentListResults",listType:e.listType,listName:e.listName,docIds:r,docs:o})},onError:function(i){t.log("Unable to retrieve document list ("+e.listType+"/"+e.listName+")",i)}})},_handleSchemaQuery:function(e){var n=this,r=[];if(e.listName)for(var o=0,s=(r=e.listName.split(",")).length;o<s;++o)r[o]=t.trim(r[o]);this.dispatchService&&this.atlasDesign&&r.length>0&&this.atlasDesign.queryView({viewName:"nunaliit-schema",keys:r,include_docs:!0,onSuccess:function(t){for(var r=[],o=[],s=0,a=t.length;s<a;++s)r.push(t[s].id),o.push(t[s].doc);n.dispatchService.send(i,{type:"documentListResults",listType:e.listType,listName:e.listName,docIds:r,docs:o})},onError:function(i){t.log("Unable to retrieve document list ("+e.listType+"/"+e.listName+")",i)}})},_handleModelQuery:function(e){var t=e.listName,i=n[t];i?i.refresh():(i=new r({sourceModelId:t,dispatchService:this.dispatchService}),n[t]=i)}});t.couchDocumentList={DocumentListService:o}}(jQuery,nunaliit2),function(e,t){var i="n2.couchAttachment",n=t.Class({doc:null,documentSource:null,attName:null,mediaRelativePath:null,initialize:function(e){var i=t.extend({doc:null,attName:null,mediaRelativePath:null,documentSource:null},e);this.doc=i.doc,this.attName=i.attName,this.mediaRelativePath=i.mediaRelativePath,this.documentSource=i.documentSource},getName:function(){return this.attName},getStatus:function(){return this._getAtt().status},isAttached:function(){return"attached"===this.getStatus()&&!!(this.doc&&this.doc._attachments&&this.doc._attachments[this.attName])},getFileClass:function(){return this._getAtt().fileClass},getMediaFileUrl:function(){var e=this._getAtt();return e&&e.mediaFile&&this.mediaRelativePath?this.mediaRelativePath+e.mediaFile:null},getStructure:function(){return this._getAtt()},isSource:function(){return!this._getAtt().source},getThumbnailAttachment:function(){var e=null,t=this._getAtt();if(t){var i=t.thumbnail;if(i)this._getAtt(i)&&(e=new n({doc:this.doc,attName:i,mediaRelativePath:this.mediaRelativePath,documentSource:this.documentSource}))}return e},getOriginalAttachment:function(){var e=null,t=this._getAtt();if(t){var i=t.originalAttachment;if(i)this._getAtt(i)&&(e=new n({doc:this.doc,attName:i,mediaRelativePath:this.mediaRelativePath,documentSource:this.documentSource}))}return e},getSourceAttachment:function(){var e=null,t=this._getAtt();if(t){var i=t.source;if(i)this._getAtt(i)&&(e=new n({doc:this.doc,attName:i,mediaRelativePath:this.mediaRelativePath,documentSource:this.documentSource}))}return e},changeStatus:function(e){var t=this._getAtt();if(t){t.status=e;var i=t.thumbnail;if(null!=i){var n=this._getAtt(i);n&&(n.status=e)}var r=t.originalAttachment;if(null!=r){var o=this._getAtt(r);o&&(o.status=e)}}},computeUrl:function(){var e=void 0;if(this._getAtt()){if(!this.documentSource)throw new Error("Can not compute URL since document source is not set");e=this.documentSource.getDocumentAttachmentUrl(this.doc,this.attName)}return e},_getAtt:function(e){return e=e||this.attName,this.doc&&this.doc.nunaliit_attachments&&this.doc.nunaliit_attachments.files&&this.doc.nunaliit_attachments.files[e]?this.doc.nunaliit_attachments.files[e]:null}});function r(e,t,i,r){var o=null;return e&&e.nunaliit_attachments&&e.nunaliit_attachments.files&&e.nunaliit_attachments.files[t]&&(o=new n({doc:e,attName:t,mediaRelativePath:i,documentSource:r})),o}function o(e,t,i){var r=[];if(e&&e.nunaliit_attachments&&e.nunaliit_attachments.files)for(var o in e.nunaliit_attachments.files){var s=new n({doc:e,attName:o,mediaRelativePath:t,documentSource:i});s&&r.push(s)}return r}var s=t.Class({mediaRelativePath:null,dispatchService:null,initialize:function(e){var i=t.extend({mediaRelativePath:null,dispatchService:null},e);this.mediaRelativePath=i.mediaRelativePath,this.dispatchService=i.dispatchService},getAttachments:function(e,n){if(!n){var r={type:"documentSourceFromDocument",doc:e,documentSource:null};this.dispatchService.synchronousCall(i,r),r.documentSource&&(n=r.documentSource)}return n||(n=new t.document.DocumentSource({doc:e,dispatchService:this.dispatchService,dispatchHandle:i})),o(e,this.mediaRelativePath,n)},getAttachment:function(e,n,o){if(!o){var s={type:"documentSourceFromDocument",doc:e,documentSource:null};this.dispatchService.synchronousCall(i,s),s.documentSource&&(o=s.documentSource)}return o||(o=new t.document.DocumentSource({doc:e,dispatchService:this.dispatchService,dispatchHandle:i})),r(e,n,this.mediaRelativePath,o)}});t.couchAttachment={AttachmentService:s,getAttachments:o,getAttachmentFromName:r}}(jQuery,nunaliit2),function(e,t){var i=t.Class({dispatchService:null,initialize:function(e){var i=t.extend({dispatchService:null},e);this.dispatchService=i.dispatchService},getImageSourceForDoc:function(e){var i=t.extend({doc:null,attName:null,showService:null,onSuccess:function(e,t){},onError:function(e){}},e),n=this,r=i.doc,o=t.document.getDocumentSourceFromDocument({doc:r,dispatchService:this.dispatchService}),s={},a=[];t.couchUtils.extractLinks(r,a);for(var l=0,c=a.length;l<c;++l){var d=a[l].doc;s[d]=!0}function u(){var e=[];for(var t in s)t!==r._id&&e.push(t);o.getDocuments({docIds:e,onSuccess:h,onError:function(e){i.onError(e)}})}function h(e){var s=new t.displayBox.DisplayImageSourceDoc({showService:i.showService,dispatchService:n.dispatchService});s.addDocument(r,i.attName);for(var a=0,l=e.length;a<l;++a)for(var c=e[a],d=o.getDocumentAttachments(c),u=0,h=d.length;u<h;++u){var p=d[u];if("image"===p.getFileClass()&&"attached"===p.getStatus()&&p.isSource()){var f=p.getName();s.addDocument(c,f)}}i.onSuccess(s,r)}o.getReferencesFromId({docId:r._id,onSuccess:function(e){for(var t=0,n=e.length;t<n;++t){var a=e[t];s[a]=!0}r.nunaliit_source&&r.nunaliit_source.doc?o.getProductFromId({docId:r.nunaliit_source.doc,onSuccess:function(e){for(var t=0,i=e.length;t<i;++t){var n=e[t];s[n]=!0}u()},onError:function(e){i.onError(e)}}):u()},onError:function(e){i.onError(e)}})}});t.couchDisplayBox={DisplayImageSourceFactory:i}}(jQuery,nunaliit2),function(e,t){var i="__geometry__",n=function(e,i){return t.loc(e,"nunaliit2-couch",i)},r=[];function o(e,t){r.push({pattern:e,supportingClass:t})}function s(e){for(var i=t.extend({operationString:null,atlasDb:null,atlasDesign:null},e),n=0,o=r.length;n<o;++n){var s=r[n];if(s.pattern.test(i.operationString))return l=new s.supportingClass(i)}try{var a=t.importProfileOperation.parse(i.operationString),l=new T({operationString:i.operationString,program:a,atlasDb:i.atlasDb,atlasDesign:i.atlasDesign});return t.log("ImportProfileOperationParsed",l),l}catch(e){t.logError("Error while parsing operation string: "+i.operationString,e)}return null}var a=t.Class({collisionId:null,copyOperation:null,resolution:null,initialize:function(e){var i=t.extend({copyOperation:void 0},e);this.collisionId=t.getUniqueId(),this.resolution=void 0,this.copyOperation=i.copyOperation},getCollisionId:function(){return this.collisionId},getCopyOperation:function(){return this.copyOperation},isResolved:function(){return!!this.resolution},isKeepCurrentValue:function(){return"currentValue"===this.resolution},setKeepCurrentValue:function(){this.resolution="currentValue"},isUpdateValue:function(){return"updateValue"===this.resolution},setUpdateValue:function(){this.resolution="updateValue"},shouldPerformCopyOperation:function(){return"updateValue"===this.resolution}}),l=t.Class({propertyName:null,lastImportedValue:null,currentImportedValue:null,initialize:function(e){var i=t.extend({propertyName:void 0,lastImportedValue:void 0,currentImportedValue:void 0},e);this.propertyName=i.propertyName,this.lastImportedValue=i.lastImportedValue,this.currentImportedValue=i.currentImportedValue},getPropertyName:function(){return this.propertyName}}),c=t.Class({changeId:null,importId:null,isAddition:null,isModification:null,isDeletion:null,type:null,auto:null,modifiedProperties:null,modifiedImportValueByName:null,copyOperations:null,collisionOperationsById:null,initialize:function(e){var i=t.extend({importId:void 0,isAddition:!1,isModification:!1,isDeletion:!1,isAuto:void 0,modifiedProperties:void 0},e),n=this;if(this.changeId=t.getUniqueId(),this.modifiedProperties=[],this.modifiedImportValueByName={},this.copyOperations=[],this.collisionOperationsById={},this.importId=i.importId,this.isAddition=i.isAddition,this.isModification=i.isModification,this.isDeletion=i.isDeletion,this.auto=i.isAuto,this.isAddition&&(this.type="addition"),this.isModification){if(this.type)throw new Error("Only one of isAddition, isModification or isDeletion can be set");this.type="modification"}if(this.isDeletion){if(this.type)throw new Error("Only one of isAddition, isModification or isDeletion can be set");this.type="deletion"}if("string"!=typeof this.importId&&"number"!=typeof this.importId)throw new Error("importId must be set as a string");if(void 0===i.modifiedProperties);else{if(!t.isArray(i.modifiedProperties))throw new Error("Unexpected value for modifiedProperties");i.modifiedProperties.forEach(function(e){n.modifiedProperties.push(e)})}},getId:function(){return this.changeId},isAuto:function(){if(void 0!==this.auto)return this.auto;if(this.isAddition)return!0;if(this.isDeletion)return!1;for(var e in this.collisionOperationsById)return!1;return!0},addModifiedImportValue:function(e){var t=e.getPropertyName();this.modifiedImportValueByName[t]=e},getModifiedImportValueNames:function(){var e=[];for(var t in this.modifiedImportValueByName)e.push(t);return e.sort(),e},getModifiedImportValueFromName:function(e){return this.modifiedImportValueByName[e]},hasAnyValueChangedSinceLastImport:function(e){for(var t=0,i=e.length;t<i;++t){var n=e[t];if(this.modifiedImportValueByName[n])return!0}return!1},addCopyOperation:function(e){this.copyOperations.push(e)},addCollisionOperation:function(e){var t=new a({copyOperation:e});this.auto=!1,this.collisionOperationsById[t.getCollisionId()]=t},getCopyOperations:function(){var e=this,t=[];return this.copyOperations.forEach(function(i){var n=i.propertyNames;n.length<1?t.push(i):e.hasAnyValueChangedSinceLastImport(n)&&t.push(i)}),t},getEffectiveCopyOperations:function(){var e=this,t=[];for(var i in this.copyOperations.forEach(function(i){var n=i.propertyNames;n.length<1?t.push(i):e.hasAnyValueChangedSinceLastImport(n)&&t.push(i)}),this.collisionOperationsById){var n=this.collisionOperationsById[i];n.shouldPerformCopyOperation()&&t.push(n.getCopyOperation())}return t},getCollisionOperations:function(){var e=[];for(var t in this.collisionOperationsById){var i=this.collisionOperationsById[t];e.push(i)}return e},getCollisionFromId:function(e){return this.collisionOperationsById[e]},isResolved:function(){for(var e in this.collisionOperationsById){if(!this.collisionOperationsById[e].isResolved())return!1}return!0}}),d=t.Class({profile:null,changesById:null,dbDocIdByImportId:null,dbDocsByImportId:null,entriesByImportId:null,initialize:function(e){var i=t.extend({profile:null},e);this.profile=i.profile,this.changesById={},this.dbDocsByImportId={},this.dbDocIdByImportId={},this.entriesByImportId={},this.modificationCount=0,this.additionCount=0,this.deletionCount=0},getImportProfile:function(){return this.profile},getChange:function(e){return this.changesById[e]},getChanges:function(){var e=[];for(var t in this.changesById)e.push(this.changesById[t]);return e},removeChange:function(e){delete this.changesById[e]},addDbDocIdForImportId:function(e,t){this.dbDocIdByImportId[t]=e},getDbDocIds:function(){var e=[];for(var t in this.dbDocIdByImportId){var i=this.dbDocIdByImportId[t];e.push(i)}return e},getDbDoc:function(e){return this.dbDocsByImportId[e]},getDbDocs:function(){var e=[];for(var t in this.dbDocsByImportId){var i=this.dbDocsByImportId[t];e.push(i)}return e},getImportEntry:function(e){return this.entriesByImportId[e]},getImportEntries:function(){var e=[];for(var t in this.entriesByImportId){var i=this.entriesByImportId[t];e.push(i)}return e},addChange:function(e){var i=t.extend({change:void 0,importEntry:void 0,dbDoc:void 0},e),n=i.change,r=n.importId,o=i.importEntry;o&&(this.entriesByImportId[r]=o);var s=i.dbDoc;s&&(this.dbDocsByImportId[r]=s),n.isAddition&&++this.additionCount,n.isModification&&++this.modificationCount,n.isDeletion&&++this.deletionCount,this.changesById[n.getId()]=n}}),u=t.Class({profile:null,atlasDesign:null,dispatchService:null,initialize:function(e){var i=t.extend({profile:null,atlasDesign:null,dispatchService:null},e);this.profile=i.profile,this.atlasDesign=i.atlasDesign,this.dispatchService=i.dispatchService},analyzeEntries:function(e){var r=t.extend({entries:null,onSuccess:function(e){},onError:function(e){}},e),o=this,s=this.profile.getId(),a=new d({profile:this.profile}),u={},h=[],p={},f={},m=0;if(r.entries){for(var v=0,g=r.entries.length;v<g;++v){var y=r.entries[v],_=y.getId();null==_?(m++,h.push(y)):p[_]?f[_]?f[_]=f[_]+1:f[_]=2:(p[_]=y,h.push(y))}if(m>0&&!this.profile.ignoreId)return void r.onError(n("Number of imported entries without an id attribute: {count}",{count:m}));var S=[];for(var b in f)S.push(b);if(S.length>0)return void r.onError(n("Colliding id attributes: {ids}",{ids:S.join(",")}))}function I(){if(h.length<1)r.onSuccess(a);else{var e=h.shift(),s=e.getId();if(u[s])o._compare({importEntry:e,doc:u[s],onSuccess:function(t){t&&a.addChange({change:t,dbDoc:u[s],importEntry:e}),window.setTimeout(I,0)},onError:function(e){r.onError(n("Unable to analyze change: {err}",{err:""+e}))}});else{s||(s=t.getUniqueId());var d=new c({isAddition:!0,importId:s}),p=[],f=e.getProperties();for(var m in f){p.push(m);var v=f[m],g=new l({propertyName:m,lastImportedValue:void 0,currentImportedValue:v});d.addModifiedImportValue(g)}var y=e.getGeometry();if(y){g=new l({propertyName:i,lastImportedValue:void 0,currentImportedValue:y});d.addModifiedImportValue(g)}var _=new O({doc:void 0});o.profile.reportCopyOperations({doc:r.doc,importEntry:e,lastImportEntry:_,allPropertyNames:p,onSuccess:function(t){t.forEach(function(e){d.addCopyOperation(e)}),a.addChange({change:d,importEntry:e}),window.setTimeout(I,0)}})}}}this.atlasDesign.queryView({viewName:"nunaliit-import",reduce:!1,include_docs:!0,startkey:[s,null],endkey:[s,{}],onSuccess:function(e){for(var t=0,i=e.length;t<i;++t){var n=e[t].doc;n&&n.nunaliit_import&&void 0!==n.nunaliit_import.id&&null!==n.nunaliit_import.id&&(0,u[n.nunaliit_import.id]=n,a.addDbDocIdForImportId(n._id,n.nunaliit_import.id))}!function(){for(var e in u)if(p[e]);else{var t=new c({isDeletion:!0,importId:e});a.addChange({change:t,dbDoc:u[e]})}I()}()},onError:function(e){r.onError(n("Error loading documents from database: {err}",{err:e}))}})},_compare:function(e){var n=t.extend({importEntry:null,doc:null,onSuccess:function(e){},onError:function(e){}},e),r=this,o=n.importEntry,s=o.getProperties();this._retrieveLastEntryFromDoc({doc:n.doc,onSuccess:function(e){var t=e.getProperties(),a=e.getGeometry(),d=e.getId(),u=new c({importId:d,isModification:!0}),h={};for(var p in s)h[p]=!0;for(var p in t)h[p]=!0;var f=!1,m=o.getGeometry();m?a?m!==a&&(f=!0):f=!0:a&&(f=!0);if(f){var v=new l({propertyName:i,lastImportedValue:a,currentImportedValue:m});u.addModifiedImportValue(v)}var g={},y=[];for(var p in h){var _=t[p],S=s[p];if(y.push(p),S!==_){var b={property:p,lastImportValue:_,externalValue:S,collisions:[],copyOperations:[]};g[p]=b,u.modifiedProperties.push(b);var v=new l({propertyName:p,lastImportedValue:_,currentImportedValue:S});u.addModifiedImportValue(v)}}r.profile.reportCopyOperations({doc:n.doc,importEntry:o,lastImportEntry:e,allPropertyNames:y,onSuccess:function(e){var t=!1;e.forEach(function(e){var i=e.propertyNames;u.hasAnyValueChangedSinceLastImport(i)?e.isEqual||(t=!0,e.changedSinceLastImport?u.addCollisionOperation(e):u.addCopyOperation(e)):i.length<1&&(e.isEqual||(t=!0,u.addCopyOperation(e)))}),t||(u=void 0),n.onSuccess(u)}})},onError:function(e){n.onError(new Error("Error while retrieving last import entry: "+e))}})},_retrieveLastEntryFromDoc:function(i){var n=t.extend({doc:null,onSuccess:function(e){},onError:function(e){}},i),r=n.doc;if(r)if(r.nunaliit_import.dataAttachmentName){var o=r.nunaliit_import.dataAttachmentName;if(r._attachments&&r._attachments[o]){var s,a={type:"documentSourceFromDocument",doc:r,documentSource:null};this.dispatchService.synchronousCall("n2.couchImportProfile",a),a.documentSource&&(s=a.documentSource);var l=s.getDocumentAttachmentUrl(r,o);e.ajax({url:l,type:"GET",dataType:"json",success:function(e,t,i){var o=new O({doc:r,data:e.data,geometryWkt:e.wkt});n.onSuccess(o)},error:function(e,i,r){var o=t.utils.parseHttpJsonError(e,i);n.onError(o)}})}else{var c=new Error("Attachment for import data can not be found");n.onError(c)}}else{var d=r.nunaliit_import.data,u=void 0;r.nunaliit_import.geometry&&(u=r.nunaliit_import.geometry.wkt);h=new O({doc:r,data:d,geometryWkt:u});n.onSuccess(h)}else{var h=new O({doc:void 0});n.onSuccess(h)}}}),h=t.Class({elemId:null,analysis:null,logFn:null,initialize:function(i){var r=t.extend({elem:null,elemId:null,analysis:null,logFn:null},i);if(this.elemId=r.elemId,!this.elemId&&r.elem){var o=e(r.elem);this.elemId=o.attr("id"),this.elemId||(this.elemId=t.getUniqueId(),o.attr("id",this.elemId))}this.analysis=r.analysis,this.logFn=r.logFn,(o=this._getElem()).empty(),e('<div class="title">').appendTo(o).text(n("Verification")),e('<div class="changes">').appendTo(o),this._reportChanges()},_getElem:function(){return e("#"+this.elemId)},_log:function(e){this.logFn&&this.logFn(e)},_reportChanges:function(){var i=this,r=this._getElem().find(".changes").empty(),o=this.analysis,s=o.getChanges();if(s.length<1)r.text(n("No changes detected in the import data"));else{if(o.getDbDocIds().length<1){var a=t.getUniqueId();(f=e("<div>").attr("id",a).addClass("prompt").appendTo(r)).text(n("This appears to be the first time that you are importing this profile. Accept all?")),e("<button>").text(n("Proceed")).appendTo(f).click(function(){i._proceedAll({onSuccess:function(){e("#"+a).remove()}})}),e("<button>").text(n("Discard")).appendTo(f).click(function(){e(this).parents(".prompt").remove()})}else{for(var l=[],c=0;c<s.length;++c){(p=s[c]).isAuto()&&l.push(p)}if(l.length>0){var d=t.getUniqueId();(f=e("<div>").attr("id",d).addClass("prompt").appendTo(r)).text(n("It appears that {count} changes can be completed automatically. Accept automatic changes?",{count:l.length})),e("<button>").text(n("Proceed")).appendTo(f).click(function(){i._proceedAutomatics({onSuccess:function(){e("#"+d).remove()}})}),e("<button>").text(n("Discard")).appendTo(f).click(function(){e(this).parents(".prompt").remove()})}}s.sort(function(e,t){if(e.isAddition&&!t.isAddition)return-1;if(!e.isAddition&&t.isAddition)return 1;if(e.isDeletion&&!t.isDeletion)return 1;if(!e.isDeletion&&t.isDeletion)return-1;if(e.importId&&t.importId){if(e.importId<t.importId)return-1;if(e.importId>t.importId)return 1}return 0});for(var u=0,h=s.length;u<h;++u){var p=s[u],f=e("<div>").attr("id",p.changeId).addClass("operation").appendTo(r);this._refreshChangeDiv(p,f)}}},_refreshChangeDiv:function(i,r){var o=this,s=function(){var t=e(this);return o._proceed(t),!1},a=function(){var t=e(this);return o._discard(t),!1},l=function(){var t=e(this);return o._collisionSelectionClicked(t),!0},c=this.analysis;if(r.empty(),i.isModification||i.isAddition){var d=i.importId,u=c.getDbDoc(d),h=(c.getImportEntry(d),!1),p=i.getCollisionOperations();p.length>0&&(h=!0);var f=i.getModifiedImportValueNames();i.isModification?r.addClass("modify"):i.isAddition&&r.addClass("addition"),h&&r.addClass("collision"),i.isAuto()&&r.addClass("autoOperation"),e("<button>").addClass("discard").text(n("Discard")).appendTo(r).click(a);var m=e("<button>").attr("id",i.changeId+"_proceed").addClass("proceed").text(n("Modify Document")).appendTo(r).click(s);i.isAddition&&m.text(n("Create new document")),i.isResolved()||m.attr("disabled","disabled");var v=n("Modify existing document");i.isAddition&&(v=n("Create new document")),i.isAuto()&&(v+=" "+n("AUTO")),h&&(v+=" "+n("COLLISION")),e("<div>").addClass("explanation").text(v).appendTo(r),e("<div>").addClass("geoJsonId").text("Import ID: "+d).appendTo(r),u&&u._id&&e("<div>").addClass("docId").text("Database ID: "+u._id).appendTo(r);for(var g=e("<div>").addClass("properties").appendTo(r),y=0,_=f.length;y<_;++y){var S=f[y],b=i.getModifiedImportValueFromName(S),I=e("<div>").addClass("property").appendTo(g);e("<div>").addClass("propertyName").text(S).appendTo(I),e("<div>").addClass("previousValue").text(this._printValue(b.lastImportedValue)).appendTo(I),e("<div>").addClass("newValue").text(this._printValue(b.currentImportedValue)).appendTo(I)}if(p.length>0){var C=e("<div>").addClass("collisions").appendTo(r);p.forEach(function(r){var s=r.getCopyOperation(),a=e("<div>").addClass("collision").appendTo(C);e("<div>").addClass("selector").text(n("Collision on selector {selector}",{selector:s.targetSelector.getSelectorString()})).appendTo(a);var c=r.getCollisionId(),d=t.getUniqueId(),u=e("<div>").appendTo(a),h=e("<input>").attr("type","radio").attr("id",d).attr("name",c).attr("value","updateValue").attr("data-changeId",i.getId()).click(l).appendTo(u);e("<label>").attr("for",d).text(o._printValue(s.computedValue)).appendTo(u),r.isUpdateValue()&&h.prop("checked",!0);var p=t.getUniqueId(),f=e("<div>").appendTo(a),m=e("<input>").attr("type","radio").attr("id",p).attr("name",c).attr("value","current").attr("data-changeId",i.getId()).click(l).appendTo(f);e("<label>").attr("for",p).text(o._printValue(s.targetValue)).appendTo(f),r.isKeepCurrentValue()&&m.prop("checked",!0)})}var D=i.getCopyOperations();if(D.length>0){var w=e("<div>").addClass("copyOperations").appendTo(r);D.forEach(function(t){var i=e("<div>").addClass("copyOperation").appendTo(w);e("<div>").addClass("selector").text(t.targetSelector.getSelectorString()).appendTo(i),e("<div>").addClass("currentValue").text(o._printValue(t.targetValue)).appendTo(i),e("<div>").addClass("updatedValue").text(o._printValue(t.computedValue)).appendTo(i)})}}else if(i.isDeletion){d=i.importId,u=c.getDbDoc(d);var E=e("<div>").attr("id",i.changeId).addClass("delete operation").appendTo(r);i.isAuto()&&E.addClass("autoOperation"),e("<button>").addClass("discard").text(n("Discard")).appendTo(E).click(a),e("<button>").addClass("proceed").text(n("Delete Database Document")).appendTo(E).click(s);v=n("Delete existing document");i.isAuto()&&(v+=" "+n("AUTO")),e("<div>").addClass("explanation").text(v).appendTo(E),e("<div>").addClass("geoJsonId").text("Import ID: "+d).appendTo(E),e("<div>").addClass("docId").text("Database ID: "+u._id).appendTo(E);g=e("<div>").addClass("properties").appendTo(E)}},_printValue:function(e){return null===e?"null":void 0===e?"undefined":"string"==typeof e?'"'+e+'"':"number"==typeof e?""+e:"boolean"==typeof e?""+e:"object"==typeof e&&"string"==typeof e.wkt?e.wkt:"<?>"},_proceed:function(e){var t=e.parents(".operation");this._proceedWithOperationElement({elem:t})},_proceedAll:function(e){var i=t.extend({onSuccess:function(){},onError:function(e){}},e);this._proceedElementsWithSelector({selector:".operation",onSuccess:i.onSuccess,onError:i.onError})},_proceedAutomatics:function(e){var i=t.extend({onSuccess:function(){},onError:function(e){}},e);this._proceedElementsWithSelector({selector:".autoOperation",onSuccess:i.onSuccess,onError:i.onError})},_proceedElementsWithSelector:function(i){var r=t.extend({selector:null,onSuccess:function(){},onError:function(e){}},i),o=this,s=t.getUniqueId(),a=e("<div>").attr("id",s);e("<span>").addClass("n2ImportProfile_progressDialog_text").appendTo(a),a.dialog({autoOpen:!0,title:n("Proceed with Import Operations"),modal:!0,width:"auto",close:function(t,i){e("#"+s).remove()}});var l=void 0;!function t(){var i=o._getElem();var a=i.find(".changes");var c=a.find(r.selector);void 0===l&&(l=c.length);if(c.length>0){var d=l-c.length+1;e("#"+s).find(".n2ImportProfile_progressDialog_text").text(n("Operation {index} of {count}",{index:d,count:l})),o._proceedWithOperationElement({elem:c.first(),onSuccess:t,onError:r.onError})}else e("#"+s).dialog("close"),r.onSuccess()}()},_proceedWithOperationElement:function(e){var i=t.extend({elem:null,onSuccess:function(){},onError:function(e){}},e),r=i.elem.attr("id"),o=this.analysis.getChange(r);o.isAddition?this._createDocument({change:o,onSuccess:i.onSuccess,onError:i.onError}):o.isModification?this._modifyDocument({change:o,onSuccess:i.onSuccess,onError:i.onError}):o.isDeletion?this._deleteDocument({change:o,onSuccess:i.onSuccess,onError:i.onError}):(alert(n("Operation not recognized")),i.onError("Operation not recognized"))},_discard:function(e){var t=e.parents(".operation").attr("id");this._completed(t)},_collisionSelectionClicked:function(t){var i=this.analysis,n=(i.getChanges(),t.attr("name")),r=t.attr("data-changeId"),o=i.getChange(r),s=o.getCollisionFromId(n),a=t.val();if("current"===a)s.setKeepCurrentValue();else{if("updateValue"!==a)throw Error("Unexpected value: "+a);s.setUpdateValue()}var l=e("#"+o.getId());this._refreshChangeDiv(o,l)},_completed:function(t){this.analysis.removeChange(t),e("#"+t).remove()},_createDocument:function(e){var i=t.extend({change:null,onSuccess:function(){},onError:function(e){}},e),r=this,o=i.change,s=o.importId,a=this.analysis.getImportEntry(s),l=this.analysis.getImportProfile(),c=l.getSchema(),d=l.getLayerName(),u=(new O({doc:void 0}),null);c?(u=c.createObject()).nunaliit_attachments&&delete u.nunaliit_attachments:u={},!u.nunaliit_schema&&c&&(u.nunaliit_schema=c.name),d&&(u.nunaliit_layers||(u.nunaliit_layers=[]),u.nunaliit_layers.indexOf(d)<0&&u.nunaliit_layers.push(d)),this._updateImportAttachment(u,l,a);var h=o.getEffectiveCopyOperations();l.performCopyOperations(u,h,a),t.couchMap&&t.couchMap.adjustDocument&&t.couchMap.adjustDocument(u),l.getAtlasDb().createDocument({data:u,onSuccess:function(e){r._log(n("Created document with id: {id}",{id:e.id})),r._completed(o.changeId),i.onSuccess()},onError:function(e){alert(n("Unable to create document. Are you logged in?")),i.onError(e)}})},_modifyDocument:function(e){var i=t.extend({change:null,onSuccess:function(){},onError:function(e){}},e),r=this,o=i.change,s=o.importId,a=this.analysis.getDbDoc(s),l=this.analysis.getImportEntry(s),c=this.analysis.getImportProfile(),d=c.getSchema();if(this._updateImportAttachment(a,c,l),!a.nunaliit_schema&&d&&(a.nunaliit_schema=d.name),!o.isResolved())throw"Invalid state for change since some collision is not resolved";var u=o.getEffectiveCopyOperations();c.performCopyOperations(a,u,l),t.couchMap&&t.couchMap.adjustDocument&&t.couchMap.adjustDocument(a),c.getAtlasDb().updateDocument({data:a,onSuccess:function(e){r._log(n("Updated document with id: {id}",{id:e.id})),r._completed(o.changeId),i.onSuccess()},onError:function(e){alert(n("Unable to update document. Are you logged in?")),i.onError(e)}})},_deleteDocument:function(e){var i=t.extend({change:null,onSuccess:function(){},onError:function(e){}},e),r=this,o=i.change,s=o.importId,a=this.analysis.getDbDoc(s);this.analysis.getImportProfile().getAtlasDb().deleteDocument({data:a,onSuccess:function(e){r._log(n("Deleted document with id: {id}",{id:e.id})),r._completed(o.changeId),i.onSuccess()},onError:function(e){alert(n("Unable to delete document. Are you logged in?")),i.onError(e)}})},_updateImportAttachment:function(e,i,n){e.nunaliit_import||(e.nunaliit_import={id:n.getId(),profile:i.getId(),dataAttachmentName:"nunaliit_import"}),e.nunaliit_import.data&&delete e.nunaliit_import.data,e.nunaliit_import.wkt&&delete e.nunaliit_import.wkt;var r={data:{},wkt:void 0};r.id=n.getId(),r.profile=i.getId();var o=n.getGeometry();o&&(r.wkt=o);var s=n.getProperties();for(var a in s){var l=s[a];r.data[a]=l}var c=JSON.stringify(r),d=t.Base64.encode(c);e._attachments||(e._attachments={}),e._attachments.nunaliit_import={content_type:"text/json",data:d}}}),p=t.Class({initialize:function(){},reportCopyOperations:function(e){throw'Subclasses of ImportProfileOperation must implement "reportCopyOperations()"'},performCopyOperation:function(e){throw'Subclasses of ImportProfileOperation must implement "performCopyOperation()"'}}),f=/^\s*copyAll\((.*)\)\s*$/,m=t.Class(p,{operationString:null,targetSelector:null,initialize:function(e){var i=t.extend({operationString:null,atlasDb:null,atlasDesign:null},e);p.prototype.initialize.call(this),this.operationString=i.operationString;var n=f.exec(this.operationString);if(!n)throw"Invalid operation string for ImportProfileOperationCopyAll: "+operationString;this.targetSelector=t.objectSelector.parseSelector(n[1])},reportCopyOperations:function(e){for(var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),n=[],r=i.importEntry.getProperties(),o=i.lastImportEntry.getProperties(),s=0,a=i.allPropertyNames.length;s<a;++s){var l=i.allPropertyNames[s],c=this.targetSelector.getChildSelector(l),d=c.getValue(i.doc),u=r[l],h=!0;o[l]===d&&(h=!1);var p=!1;u===d&&(p=!0),n.push({propertyNames:[l],computedValue:u,targetSelector:c,targetValue:d,isEqual:p,changedSinceLastImport:h})}i.onSuccess(n)},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e),n=i.copyOperation.propertyNames[0],r=i.copyOperation.targetSelector,o=i.importEntry.getProperties()[n];void 0===o?r.removeValue(i.doc):r.setValue(i.doc,o,!0)}});o(f,m);var v=/^\s*copyAllAndFixNames\((.*)\)\s*$/,g=t.Class(p,{operationString:null,targetSelector:null,initialize:function(e){var i=t.extend({operationString:null,atlasDb:null,atlasDesign:null},e);p.prototype.initialize.call(this),this.operationString=i.operationString;var n=v.exec(this.operationString);if(!n)throw"Invalid operation string for ImportProfileOperationCopyAllAndFixNames: "+operationString;this.targetSelector=t.objectSelector.parseSelector(n[1])},reportCopyOperations:function(e){for(var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),n=[],r=i.importEntry.getProperties(),o=i.lastImportEntry.getProperties(),s=0,a=i.allPropertyNames.length;s<a;++s){var l=i.allPropertyNames[s],c=this._fixKey(l),d=this.targetSelector.getChildSelector(c),u=d.getValue(i.doc),h=r[l],p=!0;o[l]===u&&(p=!1);var f=!1;h===u&&(f=!0),n.push({propertyNames:[l],computedValue:h,targetSelector:d,targetValue:u,isEqual:f,changedSinceLastImport:p})}i.onSuccess(n)},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e),n=i.copyOperation.propertyNames[0],r=i.copyOperation.targetSelector,o=i.importEntry.getProperties()[n];void 0===o?r.removeValue(i.doc):r.setValue(i.doc,o,!0)},_fixKey:function(e){for(var t=[],i=!1,n=0,r=e.length;n<r;++n){var o=e[n];" _.(){}[]!@#$%^&*-+=:;,'\"\\/~`<>".indexOf(o)>=0?i||(t.push("_"),i=!0):(t.push(o),i=!1)}return t.join("")}});o(v,g);var y=/^\s*assign\((.*),\s*'([^']*)'\s*\)\s*$/,_=t.Class(p,{operationString:null,sourceName:null,targetSelector:null,initialize:function(e){var i=t.extend({operationString:null,atlasDb:null,atlasDesign:null},e);p.prototype.initialize.call(this),this.operationString=i.operationString;var n=y.exec(this.operationString);if(!n)throw"Invalid operation string for ImportProfileOperationAssign: "+operationString;this.targetSelector=t.objectSelector.parseSelector(n[1]),this.sourceName=n[2]},reportCopyOperations:function(e){var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),n=[],r=i.importEntry.getProperties(),o=i.lastImportEntry.getProperties();if(i.allPropertyNames.indexOf(this.sourceName)>=0){var s=r[this.sourceName],a=o[this.sourceName],l=this.targetSelector.getValue(i.doc),c=!0;a===l&&(c=!1);var d=!1;s===l&&(d=!0),n.push({propertyNames:[this.sourceName],computedValue:s,targetSelector:this.targetSelector,targetValue:l,isEqual:d,changedSinceLastImport:c})}i.onSuccess(n)},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e),n=i.importEntry.getProperties()[this.sourceName];void 0===n?this.targetSelector.removeValue(i.doc):this.targetSelector.setValue(i.doc,n,!0)}});o(y,_);var S=/^\s*longLat\(\s*'([^']*)'\s*,\s*'([^']*)'\s*\)\s*$/,b=t.Class(p,{operationString:null,longName:null,latName:null,targetSelector:null,initialize:function(e){var i=t.extend({operationString:null,atlasDb:null,atlasDesign:null},e);p.prototype.initialize.call(this),this.operationString=i.operationString;var n=S.exec(this.operationString);if(!n)throw"Invalid operation string for ImportProfileOperationLongLat: "+operationString;this.longName=n[1],this.latName=n[2],this.targetSelector=t.objectSelector.parseSelector("nunaliit_geom")},reportCopyOperations:function(e){var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),n=[],r=i.importEntry.getProperties(),o=i.lastImportEntry.getProperties();if(i.allPropertyNames.indexOf(this.longName)>=0&&i.allPropertyNames.indexOf(this.latName)>=0){var s=r[this.longName],a=r[this.latName],l=this._computeWKT(s,a),c=this._computeGeometry(l),d=o[this.longName],u=o[this.latName],h=this._computeWKT(d,u),p=(this._computeGeometry(h),this.targetSelector.getValue(i.doc)),f=void 0;p&&(f=p.wkt);var m=!0;h===f&&(m=!1);var v=!1;l===f&&(v=!0),n.push({propertyNames:[this.longName,this.latName],computedValue:c,targetSelector:this.targetSelector,targetValue:p,isEqual:v,changedSinceLastImport:m})}i.onSuccess(n)},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e),n=i.doc,r=i.copyOperation.computedValue;void 0===r?n.nunaliit_geom&&delete n.nunaliit_geom:n.nunaliit_geom=r},getGeometry:function(e){var t=e[this.longName],i=e[this.latName];return this._computeWKT(t,i)},_computeGeometry:function(e){var t=void 0;if(e){(t={nunaliit_type:"geometry"}).wkt=e;var i=(new OpenLayers.Format.WKT).read(e).geometry.getBounds();t.bbox=[i.left,i.bottom,i.right,i.top]}return t},_computeWKT:function(e,t){var i=void 0;return void 0!==e&&void 0!==t&&(i="MULTIPOINT(("+(e*=1)+" "+(t*=1)+"))"),i}});o(S,b);var I=/^\s*reference\(([^,]*),\s*'([^']*)'\s*\)\s*$/,C=t.Class(p,{operationString:null,refKey:null,targetSelector:null,initialize:function(e){var i=t.extend({operationString:null,atlasDb:null,atlasDesign:null},e);p.prototype.initialize.call(this),this.operationString=i.operationString;var n=I.exec(this.operationString);if(!n)throw"Invalid operation string for ImportProfileOperationReference: "+operationString;this.targetSelector=t.objectSelector.parseSelector(n[1]),this.refKey=n[2]},reportCopyOperations:function(e){var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),n=[],r=i.importEntry.getProperties(),o=i.lastImportEntry.getProperties();if(i.allPropertyNames.indexOf(this.refKey)>=0){var s=r[this.refKey],a=o[this.refKey],l=void 0;s&&(l={nunaliit_type:"reference",doc:s});var c=this.targetSelector.getValue(i.doc),d=void 0;"object"==typeof c&&"reference"===c.nunaliit_type&&(d=c.doc);var u=!0;a===d&&(u=!1);var h=!1;s===d&&(h=!0),n.push({propertyNames:[this.refKey],computedValue:l,targetSelector:this.targetSelector,targetValue:c,isEqual:h,changedSinceLastImport:u})}i.onSuccess(n)},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e),n=i.doc,r=i.importEntry.getProperties()[this.refKey],o=void 0;r&&(o={nunaliit_type:"reference",doc:r}),void 0===o?this.targetSelector.removeValue(n):this.targetSelector.setValue(n,o,!0)}});o(I,C);var D=/^\s*importReference\(([^,]*),\s*'([^']*)'\s*,\s*'([^']*)'\s*\)\s*$/,w=t.Class(p,{operationString:null,atlasDesign:null,profileId:null,importId:null,targetSelector:null,initialize:function(e){var i=t.extend({operationString:null,atlasDb:null,atlasDesign:null},e);p.prototype.initialize.call(this),this.operationString=i.operationString,this.atlasDesign=i.atlasDesign;var n=D.exec(this.operationString);if(!n)throw"Invalid operation string for ImportProfileOperationImportReference: "+operationString;this.targetSelector=t.objectSelector.parseSelector(n[1]),this.profileId=n[2],this.importId=n[3]},reportCopyOperations:function(e){var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),n=this,r=i.importEntry.getProperties(),o=i.lastImportEntry.getProperties(),s=void 0;if(i.allPropertyNames.indexOf(this.importId)>=0){var a=r[this.importId];this._getDocIdFromImportId({importId:a,onSuccess:l,onError:function(e){l(void 0)}})}else l(void 0);function l(e){if(s=e,i.allPropertyNames.indexOf(n.importId)>=0){var t=o[n.importId];this._getDocIdFromImportId({importId:t,onSuccess:c,onError:function(e){c(void 0)}})}else c(void 0)}function c(e){var t=[],r=void 0;s&&(r={nunaliit_type:"reference",doc:s});var o=n.targetSelector.getValue(i.doc),a=void 0;"object"==typeof o&&"reference"===o.nunaliit_type&&(a=o.doc);var l=!0;e===a&&(l=!1);var c=!1;s===a&&(c=!0),t.push({propertyNames:[n.importId],computedValue:r,targetSelector:n.targetSelector,targetValue:o,isEqual:c,changedSinceLastImport:l}),i.onSuccess(t)}},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e),n=i.doc,r=(i.importEntry.getProperties()[this.refKey],void 0);i.copyOperation&&i.copyOperation.computedValue&&(r=i.copyOperation.computedValue),void 0===r?this.targetSelector.removeValue(n):this.targetSelector.setValue(n,r,!0)},_getDocIdFromImportId:function(e){var i=t.extend({importId:void 0,onSuccess:function(e){},onError:function(e){}},e),n=i.importId;void 0===n?i.onSuccess(void 0):this.atlasDesign.queryView({viewName:"nunaliit-import",startkey:[this.profileId,n],endkey:[this.profileId,n],onSuccess:function(e){for(var t=void 0,n=0,r=e.length;n<r;++n){t=e[n].id}i.onSuccess(t)},onError:function(e){i.onError(e)}})}});o(D,w);var E=/^\s*setValue\((.*),\s*(.*)\s*\)\s*$/,x=t.Class(p,{operationString:null,value:null,targetSelector:null,initialize:function(e){var i=t.extend({operationString:null,atlasDb:null,atlasDesign:null},e);p.prototype.initialize.call(this),this.operationString=i.operationString;var n=E.exec(this.operationString);if(!n)throw"Invalid operation string for ImportProfileOperationSetValue: "+operationString;this.targetSelector=t.objectSelector.parseSelector(n[1]);var r=n[2];r.length>2&&"'"===r[0]&&"'"===r[r.length-1]?this.value=r.substr(1,r.length-2):this.value="null"===r?null:"true"===r||"false"!==r&&1*r},reportCopyOperations:function(e){var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),n=[],r=this.targetSelector.getValue(i.doc),o=!0;this.value===r&&(o=!1);var s=!1;this.value===r&&(s=!0),n.push({propertyNames:[],computedValue:this.value,targetSelector:this.targetSelector,targetValue:r,isEqual:s,changedSinceLastImport:o}),i.onSuccess(n)},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e);void 0===this.value?this.targetSelector.removeValue(i.doc):this.targetSelector.setValue(i.doc,this.value,!0)}});o(E,x);o(/^\s*findReference\(([^,]*),\s*'([^']*)'\s*,\s*'([^']*)'\s*\)\s*$/,t.Class(p,{operationString:null,atlasDesign:null,profileId:null,importId:null,targetSelector:null,initialize:function(e){var i=t.extend({operationString:null,atlasDb:null,atlasDesign:null},e);p.prototype.initialize.call(this),this.operationString=i.operationString,this.atlasDesign=i.atlasDesign;var n=D.exec(this.operationString);if(!n)throw"Invalid operation string for ImportProfileOperationImportReference: "+operationString;this.targetSelector=t.objectSelector.parseSelector(n[1]),this.profileId=n[2],this.importId=n[3]},reportCopyOperations:function(e){var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),n=this,r=i.importEntry.getProperties(),o=i.lastImportEntry.getProperties(),s=void 0;if(i.allPropertyNames.indexOf(this.importId)>=0){var a=r[this.importId];this._getDocIdFromImportId({importId:a,onSuccess:l,onError:function(e){l(void 0)}})}else l(void 0);function l(e){if(s=e,i.allPropertyNames.indexOf(n.importId)>=0){var t=o[n.importId];n._getDocIdFromImportId({importId:t,onSuccess:c,onError:function(e){c(void 0)}})}else c(void 0)}function c(e){var t=[],r=void 0;refId&&(r={nunaliit_type:"reference",doc:refId});var o=n.targetSelector.getValue(i.doc),a=void 0;"object"==typeof o&&"reference"===o.nunaliit_type&&(a=o.doc);var l=!0;e===a&&(l=!1);var c=!1;s===a&&(c=!0),t.push({propertyNames:[n.importId],computedValue:r,targetSelector:n.targetSelector,targetValue:o,isEqual:c,changedSinceLastImport:l}),i.onSuccess(t)}},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e),n=i.doc,r=(i.importEntry.getProperties()[this.refKey],void 0);i.copyOperation&&i.copyOperation.computedValue&&(r=i.copyOperation.computedValue),void 0===r?this.targetSelector.removeValue(n):this.targetSelector.setValue(n,r,!0)},_getDocIdFromImportId:function(e){var i=t.extend({importId:void 0,onSuccess:function(e){},onError:function(e){}},e),n=i.importId;void 0===n?i.onSuccess(void 0):this.atlasDesign.queryView({viewName:"nunaliit-import",startkey:[this.profileId,n],endkey:[this.profileId,n],onSuccess:function(e){for(var t=void 0,n=0,r=e.length;n<r;++n){t=e[n].id}i.onSuccess(t)},onError:function(e){i.onError(e)}})}}));var T=t.Class("ImportProfileOperationParsed",p,{operationString:null,program:null,initialize:function(e){var i=t.extend({operationString:void 0,program:void 0,atlasDb:void 0,atlasDesign:void 0},e);p.prototype.initialize.call(this),this.operationString=i.operationString,this.program=i.program,this.program.configure(i)},reportCopyOperations:function(e){var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e);this.program.reportCopyOperations(i)},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e);this.program.performCopyOperation(i)}}),k=t.Class("ImportProfileOperationGeoJSON",p,{targetSelector:null,initialize:function(e){t.extend({},e);p.prototype.initialize.call(this),this.targetSelector=new t.objectSelector.ObjectSelector(["nunaliit_geom"])},reportCopyOperations:function(e){var n=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),r=n.importEntry.getGeometry(),o=n.lastImportEntry.getGeometry(),s=void 0;r&&(s=this._computeGeometry(r));o&&this._computeGeometry(o);var a=this.targetSelector.getValue(n.doc),l=void 0;"object"==typeof a&&"geometry"===a.nunaliit_type&&(l=a.wkt);var c=!0;o===l&&(c=!1);var d=!1;r===l&&(d=!0);var u=[];u.push({propertyNames:[i],computedValue:s,targetSelector:this.targetSelector,targetValue:a,isEqual:d,changedSinceLastImport:c}),n.onSuccess(u)},performCopyOperation:function(e){var i=t.extend({doc:null,importEntry:null,copyOperation:null},e),n=i.doc,r=void 0;i.copyOperation&&i.copyOperation.computedValue&&(r=i.copyOperation.computedValue),void 0===r?this.targetSelector.removeValue(n):this.targetSelector.setValue(n,r,!0)},_computeGeometry:function(e){var t=void 0;if(e){(t={nunaliit_type:"geometry"}).wkt=e;var i=(new OpenLayers.Format.WKT).read(e).geometry.getBounds();t.bbox=[i.left,i.bottom,i.right,i.top]}return t}}),L=t.Class({initialize:function(){},getId:function(){throw"Subclasses to ImportEntry must implement getId()"},getProperties:function(){throw"Subclasses to ImportEntry must implement getProperties()"},getGeometry:function(){throw"Subclasses to ImportEntry must implement getGeometry()"}}),M=t.Class({id:null,sessionId:null,label:null,unrelated:null,layerName:null,schema:null,operations:null,operationsById:null,atlasDb:null,atlasDesign:null,dispatchService:null,initialize:function(e){var i=t.extend({id:void 0,label:void 0,unrelated:!1,layerName:void 0,schema:void 0,operations:void 0,atlasDb:void 0,atlasDesign:void 0,dispatchService:void 0},e);if(this.id=i.id,this.label=i.label,this.unrelated=i.unrelated,this.layerName=i.layerName,this.schema=i.schema,this.atlasDb=i.atlasDb,this.atlasDesign=i.atlasDesign,this.dispatchService=i.dispatchService,this.operations=[],this.operationsById={},t.isArray(i.operations))for(var n=0,r=i.operations.length;n<r;++n){var o=i.operations[n];this._addOperation(o)}this.sessionId=this.id+"_"+(new Date).toISOString()},getType:function(){throw"getType() must be implemented by all subclasses of ImportProfile"},parseEntries:function(e){throw"parseEntries() must be implemented by all subclasses of ImportProfile"},getId:function(){return this.unrelated?this.sessionId:this.id},getLabel:function(){return this.label},getLayerName:function(){return this.layerName},getSchema:function(){return this.schema},getAtlasDb:function(){return this.atlasDb},performImportAnalysis:function(e){var i=t.extend({entries:null,onSuccess:function(e){},onError:function(e){}},e);new u({profile:this,atlasDesign:this.atlasDesign,dispatchService:this.dispatchService}).analyzeEntries({entries:i.entries,onSuccess:i.onSuccess,onError:i.onError})},reportCopyOperations:function(e){var i=t.extend({doc:null,importEntry:null,lastImportEntry:null,allPropertyNames:null,onSuccess:function(e){}},e),n=[],r=this.operations.slice(0);!function e(){if(r.length<1)return void i.onSuccess(n);var t=r.shift();t.reportCopyOperations({doc:i.doc,importEntry:i.importEntry,lastImportEntry:i.lastImportEntry,allPropertyNames:i.allPropertyNames,onSuccess:function(i){i&&i.length&&i.forEach(function(e){e._n2OpId=t._n2OpId,n.push(e)}),window.setTimeout(e,0)}})}()},performCopyOperations:function(e,t,i){var n=this;t.forEach(function(t){var r=t._n2OpId,o=n.operationsById[r];o&&o.performCopyOperation({doc:e,importEntry:i,copyOperation:t})})},_addOperation:function(e){var i=e._n2OpId;i||(i=t.getUniqueId(),e._n2OpId=i),this.operations.push(e),this.operationsById[i]=e}}),O=t.Class("ImportEntryFromDoc",L,{id:null,data:null,geometryWkt:null,initialize:function(e){L.prototype.initialize.call(this,e);var i=t.extend({doc:void 0,data:void 0,geometryWkt:void 0},e);this.id=void 0,this.data=i.data?i.data:{},this.geometryWkt=i.geometryWkt;var n=i.doc;n&&n.nunaliit_import&&(this.id=n.nunaliit_import.id)},getId:function(){return this.id},getProperties:function(){return this.data},getGeometry:function(){return this.geometryWkt}}),A=t.Class(L,{data:null,profile:null,initialize:function(e){L.prototype.initialize.call(this,e);var i=t.extend({data:null,profile:null},e);this.data=i.data,this.profile=i.profile},getId:function(){if(!this.profile.ignoreId){var e=this.profile.idAttribute;return this.data[e]}},getProperties:function(){return this.data},getGeometry:function(){}}),F=t.Class(M,{idAttribute:null,ignoreId:null,initialize:function(e){var i=t.extend({idAttribute:void 0,ignoreId:!1},e);if(i.ignoreId&&(e.unrelated=!0),M.prototype.initialize.call(this,e),this.idAttribute=i.idAttribute,this.ignoreId=i.ignoreId,this.ignoreId);else if(!this.idAttribute)throw'Option "ignoreId" is set or "idAttribute" must be specified for ImportProfileJson'},getType:function(){return"json"},parseEntries:function(e){var i=t.extend({importData:null,onSuccess:function(e){},onError:function(e){}},e),r=i.importData;if(r){var o=null;try{o=JSON.parse(r)}catch(l){return void i.onError(n("Unable to parse import data: {err}",{err:l}))}if(t.isArray(o)){for(var s=[],a=0,l=o.length;a<l;++a){var c=o[a],d={};for(var u in c)u&&(""===t.trim(u)||(d[u]=c[u]));var h=new A({data:d,profile:this});s.push(h)}i.onSuccess(s)}else i.onError(n("JSON definition must be an array"))}else i.onError(n("Import data must be provided"))}}),R=t.Class(L,{id:null,data:null,profile:null,geom:void 0,initialize:function(e){L.prototype.initialize.call(this,e);var i=t.extend({id:null,data:null,geom:void 0,profile:null},e);this.id=i.id,this.data=i.data,this.geom=i.geom,this.profile=i.profile},getId:function(){return this.id},getProperties:function(){return this.data},getGeometry:function(){return this.geom}}),N=t.Class(M,{idAttribute:null,olGeoJsonFormat:null,olWktFormat:null,initialize:function(e){var i=t.extend({idAttribute:void 0},e);if(M.prototype.initialize.call(this,e),this.idAttribute=i.idAttribute,OpenLayers&&OpenLayers.Format&&OpenLayers.Format.GeoJSON&&(this.olGeoJsonFormat=new OpenLayers.Format.GeoJSON({ignoreExtraDims:!0})),OpenLayers&&OpenLayers.Format&&OpenLayers.Format.WKT&&(this.olWktFormat=new OpenLayers.Format.WKT),!this.olGeoJsonFormat||!this.olWktFormat)throw"OpenLayers is required for ImportProfileGeoJson";var n=new k;this._addOperation(n)},getType:function(){return"geojson"},parseEntries:function(e){var i=t.extend({importData:null,onSuccess:function(e){},onError:function(e){}},e),r=i.importData;if(r){var o=void 0;"string"==typeof this.idAttribute&&this.idAttribute.length>0&&"="===this.idAttribute[0]&&(o=t.styleRuleParser.parse(this.idAttribute.substr(1)));var s=null;try{s=JSON.parse(r)}catch(c){return void i.onError(n("Unable to parse import data: {err}",{err:c}))}if("FeatureCollection"===s.type)if(t.isArray(s.features)){for(var a=[],l=0,c=s.features.length;l<c;++l){var d=s.features[l],u=void 0;d.id&&(u=d.id);var h={};if(d.properties)for(var p in d.properties)p&&(""===t.trim(p)||(h[p]=d.properties[p])),p!==this.idAttribute||u||(u=d.properties[p]);void 0===u&&o&&"function"==typeof o.getValue&&(u=o.getValue(d));var f=null;if(d.geometry&&this.olGeoJsonFormat){var m=this.olGeoJsonFormat.parseGeometry(d.geometry);f=this.olWktFormat.extractGeometry(m)}var v=new R({id:u,data:h,geom:f,profile:this});a.push(v)}i.onSuccess(a)}else i.onError(n('GeoJSON definition must include an array named "features"'));else i.onError(n('GeoJSON import is supported only for type "FeatureCollection"'))}else i.onError(n("Import data must be provided"))}}),P=t.Class(M,{idAttribute:null,ignoreId:null,initialize:function(e){var i=t.extend({idAttribute:void 0,ignoreId:!1},e);if(i.ignoreId&&(e.unrelated=!0),M.prototype.initialize.call(this,e),this.idAttribute=i.idAttribute,this.ignoreId=i.ignoreId,this.ignoreId);else if(!this.idAttribute)throw'Option "ignoreId" is set or "idAttribute" must be specified for ImportProfileCsv'},getType:function(){return"csv"},parseEntries:function(e){var i=t.extend({importData:null,onSuccess:function(e){},onError:function(e){}},e),r=i.importData;if(r){var o=null;try{o=t.csv.Parse({csv:r})}catch(l){return void i.onError(n("Unable to parse import data: {err}",{err:l}))}if(t.isArray(o)){for(var s=[],a=0,l=o.length;a<l;++a){var c=o[a],d={};for(var u in c)u&&(""===t.trim(u)||(d[u]=c[u]));var h=new A({data:d,profile:this});s.push(h)}i.onSuccess(s)}else i.onError(n("CSV definition should yield an array"))}else i.onError(n("Import data must be provided"))}}),B=(t.Class("ReferencesFromSchema",{atlasDesign:null,docsbySchemaName:null,initialize:function(e){var i=t.extend({atlasDesign:void 0,globalContext:void 0},e),n=this;this.atlasDesign=i.atlasDesign,this.docsbySchemaName={},i.globalContext&&(i.globalContext.referencesFromSchema=function(){n._getReferences(this,schemaName,expression)})},_getReferences:function(e,t,i,n){}}),t.Class({schemaRepository:null,atlasDb:null,atlasDesign:null,profileClasses:null,dispatchService:null,initialize:function(e){var i=t.extend({atlasDb:null,atlasDesign:null,schemaRepository:null,dispatchService:null},e);(this.atlasDb=i.atlasDb,this.atlasDesign=i.atlasDesign,this.schemaRepository=i.schemaRepository,this.dispatchService=i.dispatchService,this.profileClasses={},this.addImportProfileClass("json",F),this.addImportProfileClass("geojson",N),this.addImportProfileClass("csv",P),t.importProfileOperation&&"function"==typeof t.importProfileOperation.getGlobalContext)&&(t.importProfileOperation.getGlobalContext().test=function(e,t,i){e(2*i)})},addImportProfileClass:function(e,t){this.profileClasses[e]=t},loadImportProfiles:function(e){var i=t.extend({onSuccess:function(e){},onError:function(e){}},e),r=this;this.atlasDesign.queryView({viewName:"nunaliit-import-profile",include_docs:!0,onSuccess:function(e){for(var n=[],o=e.length+1,s=0,a=e.length;s<a;++s){var l=e[s].doc;l?r._parseImportProfile({doc:l,onSuccess:function(e){n.push(e),c()},onError:function(e){t.log("Unable to load profile: "+e),c()}}):--o}function c(){--o<=0&&i.onSuccess(n)}c()},onError:function(e){i.onError(n("Unable to load import profiles: {err}",{err:e}))}})},_parseImportProfile:function(e){var i=t.extend({doc:null,importProfile:null,onSuccess:function(e){},onError:function(e){}},e),r=this,o=i.importProfile;if(!o&&i.doc&&i.doc.nunaliit_import_profile&&(o=i.doc.nunaliit_import_profile),o){var a=null;if(o.type){var l=o.type;if(!(a=this.profileClasses[l]))return void i.onError(n("Unknown import profile type: {type}",{type:l}));var c={};if("object"==typeof o.options)for(var d in o.options){var u=o.options[d];c[d]=u}c.id=o.id,c.label=o.label,c.layerName=o.layerName,c.atlasDb=this.atlasDb,c.atlasDesign=this.atlasDesign,c.dispatchService=this.dispatchService,c.schema=void 0,o.schemaName?this.schemaRepository.getSchema({name:o.schemaName,onSuccess:function(e){c.schema=e,h(c)},onError:function(e){i.onError(n("Unknown schema: {name}",{name:o.schemaName}))}}):h(c)}else i.onError("Import profile must contain a type")}else i.onError("Import profile must be provided");function h(e){var t=[];if(e.operations=t,o.operations)for(var l=0,c=o.operations.length;l<c;++l){var d=o.operations[l],u=s({operationString:d,atlasDb:r.atlasDb,atlasDesign:r.atlasDesign});if(!u)return void i.onError(n("Error creating import profile. Unknown operation string: {string}",{string:d}));t.push(u)}!function(e){try{var t=new a(e);i.onSuccess(t)}catch(e){i.onError(n("Error creating import profile: {err}",{err:e}))}}(e)}}}));t.couchImportProfile={ImportProfileService:B,AnalysisReport:h}}(jQuery,nunaliit2),function(e){var t=function(){var t=function(e,t,i,n){for(i=i||{},n=e.length;n--;i[e[n]]=t);return i},i=[1,4],n=[1,7],r=[1,8],o=[5,7,9,10,12,13,14,15,16,17,18,19,25,26,27,28,29,30,31,33,34],s=[1,10],a=[1,11],l=[1,13],c=[1,14],d=[1,15],u=[1,16],h=[1,19],p=[1,20],f=[1,21],m=[1,22],v=[1,23],g=[1,24],y=[1,25],_=[1,26],S=[1,27],b=[1,28],I=[1,29],C=[1,30],D=[1,31],w=[5,9,10,13,14,15,16,17,18,19,25,26,27,28,29,30,34],E=[5,9,10,13,30,34],x=[5,9,10,13,14,15,16,17,18,19,30,34],T=[5,9,10,13,14,15,16,17,18,19,25,26,30,34],k={trace:function(){},yy:{},symbols_:{error:2,program:3,operation:4,EOF:5,identifier:6,"=":7,value:8,"&&":9,"||":10,"!":11,"(":12,")":13,"==":14,"!=":15,">=":16,"<=":17,">":18,"<":19,arguments:20,true:21,false:22,NUMBER:23,STRING:24,"+":25,"-":26,"*":27,"/":28,"%":29,",":30,".":31,VAR_NAME:32,"[":33,"]":34,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",7:"=",9:"&&",10:"||",11:"!",12:"(",13:")",14:"==",15:"!=",16:">=",17:"<=",18:">",19:"<",21:"true",22:"false",23:"NUMBER",24:"STRING",25:"+",26:"-",27:"*",28:"/",29:"%",30:",",31:".",32:"VAR_NAME",33:"[",34:"]"},productions_:[0,[3,2],[4,3],[8,3],[8,3],[8,2],[8,3],[8,3],[8,3],[8,3],[8,3],[8,3],[8,3],[8,3],[8,4],[8,1],[8,1],[8,1],[8,1],[8,1],[8,3],[8,3],[8,3],[8,3],[8,3],[20,3],[20,1],[6,3],[6,4],[6,1]],performAction:function(e,t,i,n,r,o,s){var a=o.length-1;switch(r){case 1:return o[a-1];case 2:this.$=new O(o[a-2],o[a]);break;case 3:this.$=new R(o[a-2],"&&",o[a]);break;case 4:this.$=new R(o[a-2],"||",o[a]);break;case 5:this.$=new R(o[a],"!");break;case 6:this.$=o[a-1];break;case 7:this.$=new P(o[a-2],o[a],"==");break;case 8:this.$=new P(o[a-2],o[a],"!=");break;case 9:this.$=new P(o[a-2],o[a],">=");break;case 10:this.$=new P(o[a-2],o[a],"<=");break;case 11:this.$=new P(o[a-2],o[a],">");break;case 12:this.$=new P(o[a-2],o[a],"<");break;case 13:this.$=new A(o[a-2],null);break;case 14:this.$=new A(o[a-3],o[a-1]);break;case 15:this.$=o[a];break;case 16:this.$=new N(!0);break;case 17:this.$=new N(!1);break;case 18:this.$=new N(1*o[a]);break;case 19:this.$=new N(o[a]);break;case 20:this.$=new B(o[a-2],o[a],"+");break;case 21:this.$=new B(o[a-2],o[a],"-");break;case 22:this.$=new B(o[a-2],o[a],"*");break;case 23:this.$=new B(o[a-2],o[a],"/");break;case 24:this.$=new B(o[a-2],o[a],"%");break;case 25:this.$=new F(o[a-2],o[a]);break;case 26:this.$=new F(o[a]);break;case 27:var l=new N(o[a]);this.$=new U(l,o[a-2]);break;case 28:this.$=new U(o[a-1],o[a-3]);break;case 29:this.$=new j(o[a])}},table:[{3:1,4:2,6:3,32:i},{1:[3]},{5:[1,5]},{7:[1,6],31:n,33:r},t(o,[2,29]),{1:[2,1]},{6:12,8:9,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{32:[1,17]},{6:12,8:18,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{5:[2,2],9:h,10:p,14:f,15:m,16:v,17:g,18:y,19:_,25:S,26:b,27:I,28:C,29:D},{6:12,8:32,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:33,11:s,12:a,21:l,22:c,23:d,24:u,32:i},t(w,[2,15],{12:[1,34],31:n,33:r}),t(w,[2,16]),t(w,[2,17]),t(w,[2,18]),t(w,[2,19]),t(o,[2,27]),{9:h,10:p,14:f,15:m,16:v,17:g,18:y,19:_,25:S,26:b,27:I,28:C,29:D,34:[1,35]},{6:12,8:36,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:37,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:38,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:39,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:40,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:41,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:42,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:43,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:44,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:45,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:46,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:47,11:s,12:a,21:l,22:c,23:d,24:u,32:i},{6:12,8:48,11:s,12:a,21:l,22:c,23:d,24:u,32:i},t(w,[2,5]),{9:h,10:p,13:[1,49],14:f,15:m,16:v,17:g,18:y,19:_,25:S,26:b,27:I,28:C,29:D},{6:12,8:52,11:s,12:a,13:[1,50],20:51,21:l,22:c,23:d,24:u,32:i},t(o,[2,28]),t(E,[2,3],{14:f,15:m,16:v,17:g,18:y,19:_,25:S,26:b,27:I,28:C,29:D}),t(E,[2,4],{14:f,15:m,16:v,17:g,18:y,19:_,25:S,26:b,27:I,28:C,29:D}),t(x,[2,7],{25:S,26:b,27:I,28:C,29:D}),t(x,[2,8],{25:S,26:b,27:I,28:C,29:D}),t(x,[2,9],{25:S,26:b,27:I,28:C,29:D}),t(x,[2,10],{25:S,26:b,27:I,28:C,29:D}),t(x,[2,11],{25:S,26:b,27:I,28:C,29:D}),t(x,[2,12],{25:S,26:b,27:I,28:C,29:D}),t(T,[2,20],{27:I,28:C,29:D}),t(T,[2,21],{27:I,28:C,29:D}),t(w,[2,22]),t(w,[2,23]),t(w,[2,24]),t(w,[2,6]),t(w,[2,13]),{13:[1,53]},{9:h,10:p,13:[2,26],14:f,15:m,16:v,17:g,18:y,19:_,25:S,26:b,27:I,28:C,29:D,30:[1,54]},t(w,[2,14]),{6:12,8:52,11:s,12:a,20:55,21:l,22:c,23:d,24:u,32:i},{13:[2,25]}],defaultActions:{5:[2,1],55:[2,25]},parseError:function(e,t){if(!t.recoverable)throw i.prototype=Error,new i(e,t);function i(e,t){this.message=e,this.hash=t}this.trace(e)},parse:function(e){var t=this,i=[0],n=[null],r=[],o=this.table,s="",a=0,l=0,c=0,d=r.slice.call(arguments,1),u=Object.create(this.lexer),h={yy:{}};for(var p in this.yy)Object.prototype.hasOwnProperty.call(this.yy,p)&&(h.yy[p]=this.yy[p]);u.setInput(e,h.yy),h.yy.lexer=u,h.yy.parser=this,void 0===u.yylloc&&(u.yylloc={});var f=u.yylloc;r.push(f);var m=u.options&&u.options.ranges;"function"==typeof h.yy.parseError?this.parseError=h.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var v,g,y,_,S,b,I,C,D,w=function(){var e;return"number"!=typeof(e=u.lex()||1)&&(e=t.symbols_[e]||e),e},E={};;){if(y=i[i.length-1],this.defaultActions[y]?_=this.defaultActions[y]:(null==v&&(v=w()),_=o[y]&&o[y][v]),void 0===_||!_.length||!_[0]){var x="";for(b in D=[],o[y])this.terminals_[b]&&b>2&&D.push("'"+this.terminals_[b]+"'");x=u.showPosition?"Parse error on line "+(a+1)+":\n"+u.showPosition()+"\nExpecting "+D.join(", ")+", got '"+(this.terminals_[v]||v)+"'":"Parse error on line "+(a+1)+": Unexpected "+(1==v?"end of input":"'"+(this.terminals_[v]||v)+"'"),this.parseError(x,{text:u.match,token:this.terminals_[v]||v,line:u.yylineno,loc:f,expected:D})}if(_[0]instanceof Array&&_.length>1)throw new Error("Parse Error: multiple actions possible at state: "+y+", token: "+v);switch(_[0]){case 1:i.push(v),n.push(u.yytext),r.push(u.yylloc),i.push(_[1]),v=null,g?(v=g,g=null):(l=u.yyleng,s=u.yytext,a=u.yylineno,f=u.yylloc,c>0&&c--);break;case 2:if(I=this.productions_[_[1]][1],E.$=n[n.length-I],E._$={first_line:r[r.length-(I||1)].first_line,last_line:r[r.length-1].last_line,first_column:r[r.length-(I||1)].first_column,last_column:r[r.length-1].last_column},m&&(E._$.range=[r[r.length-(I||1)].range[0],r[r.length-1].range[1]]),void 0!==(S=this.performAction.apply(E,[s,l,a,h.yy,_[1],n,r].concat(d))))return S;I&&(i=i.slice(0,-1*I*2),n=n.slice(0,-1*I),r=r.slice(0,-1*I)),i.push(this.productions_[_[1]][0]),n.push(E.$),r.push(E._$),C=o[i[i.length-2]][i[i.length-1]],i.push(C);break;case 3:return!0}}}};function L(t,i){if(t===i)return 0;if(typeof t!=typeof i)return typeof t<typeof i?-1:1;if("string"==typeof t||"number"==typeof t)return t<i?-1:1;if("boolean"==typeof t)return i?-1:1;if("function"==typeof t){var n=t.toString(),r=i.toString();return n<r?-1:n>r?1:0}if(e.isArray(t)&&e.isArray(i)){var o=!0;return t.forEach(function(e){e?"reference"!==e.nunaliit_type&&(o=!1):o=!1}),i.forEach(function(e){e?"reference"!==e.nunaliit_type&&(o=!1):o=!1}),o?function(e,t){if(e===t)return 0;if(!e)return-1;if(!t)return 1;var i={};e.forEach(function(e){e&&"string"==typeof e.doc&&(i[e.doc]=!0)});var n={};for(var r in t.forEach(function(e){e&&"string"==typeof e.doc&&(n[e.doc]=!0)}),i)if(!n[r])return-1;for(var r in n)if(!i[r])return 1;return 0}(t,i):function(e,t){if(e.length>t.length)return 1;if(e.length<t.length)return-1;for(var i=0;i<e.length;++i){var n=L(e[i],t[i]);if(0!==n)return n}return 0}(t,i)}if(e.isArray(t)&&!e.isArray(i))return-1;if(!e.isArray(t)&&e.isArray(i))return 1;if("reference"===t.nunaliit_type&&"reference"===i.nunaliit_type)return(s=t)===(a=i)?0:s?a?s.doc===a.doc?0:void 0===s.doc||null===s.doc?-1:void 0===a.doc||null===a.doc?1:s.doc<a.doc?-1:s.doc>a.doc?1:0:1:-1;var s,a,l={};for(var c in t)l[c]=!0;for(var c in i)l[c]=!0;var d=[];for(var c in l)d.push(c);d.sort();for(var u=0;u<d.length;++u){var h=d[u],p=L(t[h],i[h]);if(0!==p)return p}return 0}var M={};k.global=M;var O=function(e,t){this.leftop=e,this.rightop=t};O.prototype.configure=function(e){this.identifier&&"function"==typeof this.identifier.configure&&this.identifier.configure(e),this.rightop&&"function"==typeof this.rightop.configure&&this.rightop.configure(e)},O.prototype.reportCopyOperations=function(e){var t=this,i=e.importEntry.getProperties(),n=e.lastImportEntry.getProperties(),r={},o=void 0,s=void 0,a=void 0,l=void 0,c={variables:{doc:e.doc,import:i},propertyNameMap:r};function d(t){e.onSuccess([])}function u(i){s=i;var n={variables:{doc:e.doc}};t.leftop.getValue(n,h,d)}function h(i){a=i;var n={variables:{doc:e.doc}};t.leftop.getObjectSelector(n,p,d)}function p(t){l=t;var i=!1;0===L(a,o)&&(i=!0);var n=!0;0===L(a,s)&&(n=!1);var c=[];for(var d in r)c.push(d);var u={propertyNames:c,computedValue:o,targetSelector:l,targetValue:a,isEqual:i,changedSinceLastImport:n};e.onSuccess([u])}this.rightop.getValue(c,function(i){o=i;var r={variables:{doc:e.doc,import:n}};t.rightop.getValue(r,u,d)},d)},O.prototype.performCopyOperation=function(t){var i=e.extend({doc:null,importEntry:null,copyOperation:null},t),n=i.doc,r=i.copyOperation,o=r.computedValue,s=r.targetSelector;void 0===o?s.removeValue(n):s.setValue(n,o,!0)};var A=function(e,t){this.value=e,this.args=t};A.prototype.getValue=function(e,t,i){var n=this,r=[s,i];function o(){n.value.getValue(e,function(t){"function"==typeof t?t.apply(e,r):s(void 0)},i)}function s(e){t(e)}this.args?this.args.pushValuesOnArray(e,r,o,i):o()};var F=function(e,t){this.valueNode=e,this.nextArgument=t||null};F.prototype.pushValuesOnArray=function(e,t,i,n){var r=this;this.valueNode.getValue(e,function(o){t.push(o),r.nextArgument?r.nextArgument.pushValuesOnArray(e,t,i,n):i()},n)};var R=function(e,t,i){this.n1=e,this.n2=i,this.op=t};R.prototype.getValue=function(e,t,i){var n=this;function r(e,i){"!"===this.op?t(!e):"&&"===this.op?t(e&&i):"||"===this.op?t(e||i):t(!1)}this.n1.getValue(e,function(t){n.n2?this.n2.getValue(e,function(e){r(t,e)},i):r(t,void 0)},i)};var N=function(e){this.value=e};N.prototype.getValue=function(e,t,i){t(this.value)};var P=function(e,t,i){this.leftNode=e,this.rightNode=t,this.op=i};P.prototype.getValue=function(e,t,i){var n=this;this.leftNode.getValue(e,function(r){n.rightNode.getValue(e,function(e){"=="===n.op?t(r==e):"!="===n.op?t(r!=e):">="===n.op?t(r>=e):"<="===n.op?t(r<=e):">"===n.op?t(r>e):"<"===n.op?t(r<e):t(!1)},i)},i)};var B=function(e,t,i){this.leftNode=e,this.rightNode=t,this.op=i};B.prototype.getValue=function(e,t,i){var n=this;this.leftNode.getValue(e,function(r){n.rightNode.getValue(e,function(e){"+"===n.op?t(r+e):"-"===n.op?t(r-e):"*"===n.op?t(r*e):"/"===n.op?t(r/e):"%"===n.op?t(r%e):t(0)},i)},i)};var U=function(e,t){this.idNode=e,this.previousSelector=t};U.prototype.getValue=function(e,t,i){var n=this;this.previousSelector.getValue(e,function(r){"object"==typeof r?n.idNode.getValue(e,function(i){void 0===i?t(void 0):(n.previousSelector.isVariable&&"import"===n.previousSelector.variableName&&e.propertyNameMap&&(e.propertyNameMap[i]=!0),t(r[i]))},i):t(void 0)},i)},U.prototype.getObjectSelector=function(e,t,i){var n=this;this.previousSelector.getObjectSelector(e,function(r){n.idNode.getValue(e,function(e){var i=r.getChildSelector(e);t(i)},i)},i)};var j=function(e){this.isVariable=!0,this.variableName=e};j.prototype.getValue=function(e,t,i){var n=void 0;e&&e.variables&&e.variables[this.variableName]?n=e.variables[this.variableName]:M&&M[this.variableName]&&(n=M[this.variableName]),t(n)},j.prototype.getObjectSelector=function(t,i,n){i(new e.objectSelector.ObjectSelector([]))};var z={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,i=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),i.length-1&&(this.yylineno-=i.length-1);var r=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:i?(i.length===n.length?this.yylloc.first_column:0)+n[n.length-i.length].length-i[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[r[0],r[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var i,n,r;if(this.options.backtrack_lexer&&(r={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(r.yylloc.range=this.yylloc.range.slice(0))),(n=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],i=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),i)return i;if(this._backtrack){for(var o in r)this[o]=r[o];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,i,n;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var r=this._currentRules(),o=0;o<r.length;o++)if((i=this._input.match(this.rules[r[o]]))&&(!t||i[0].length>t[0].length)){if(t=i,n=o,this.options.backtrack_lexer){if(!1!==(e=this.test_match(i,r[o])))return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?!1!==(e=this.test_match(t,r[n]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return(e=this.conditionStack.length-1-Math.abs(e||0))>=0?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(e,t,i,n){switch(i){case 0:break;case 1:return 21;case 2:return 22;case 3:return 23;case 4:return 32;case 5:return t.yytext=t.yytext.substr(1,t.yytext.length-2),24;case 6:return 14;case 7:return 15;case 8:return 16;case 9:return 17;case 10:return 18;case 11:return 19;case 12:return 12;case 13:return 13;case 14:return"{";case 15:return"}";case 16:return 33;case 17:return 34;case 18:return 30;case 19:return 31;case 20:return 11;case 21:return 25;case 22:return 26;case 23:return 27;case 24:return 28;case 25:return 29;case 26:return 7;case 27:return 9;case 28:return 10;case 29:return 5;case 30:return"INVALID"}},rules:[/^(?:\s+)/,/^(?:true\b)/,/^(?:false\b)/,/^(?:[0-9]+(\.[0-9]+)?\b)/,/^(?:[_a-zA-Z][_a-zA-Z0-9]*)/,/^(?:'(\\'|[^'])*')/,/^(?:==)/,/^(?:!=)/,/^(?:>=)/,/^(?:<=)/,/^(?:>)/,/^(?:<)/,/^(?:\()/,/^(?:\))/,/^(?:\{)/,/^(?:\})/,/^(?:\[)/,/^(?:\])/,/^(?:,)/,/^(?:\.)/,/^(?:!)/,/^(?:\+)/,/^(?:-)/,/^(?:\*)/,/^(?:\/)/,/^(?:%)/,/^(?:=)/,/^(?:&&)/,/^(?:\|\|)/,/^(?:$)/,/^(?:.)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],inclusive:!0}}};function G(){this.yy={}}return k.lexer=z,G.prototype=k,k.Parser=G,new G}();exports.parser=t,exports.Parser=t.Parser,exports.parse=function(){return t.parse.apply(t,arguments)},exports.main=function(e){e[1]||(console.log("Usage: "+e[0]+" FILE"),process.exit(1));var t=__webpack_require__(0).readFileSync(__webpack_require__(1).normalize(e[1]),"utf8");return exports.parser.parse(t)},__webpack_require__.c[__webpack_require__.s]===module&&exports.main(process.argv.slice(1)),e.importProfileOperation={parse:function(){return t.parse.apply(t,arguments)},getGlobalContext:function(){return t.global}}}(nunaliit2),function(e,t){var i="n2.couchDbPerspective",n={valid:!1,visible:!1},r={valid:!0,visible:!1},o={valid:!0,visible:!0},s=t.Class({initialize:function(e){t.extend({},e)},load:function(e){t.extend({onSuccess:function(e){},onError:function(e){}},e);throw"Subclasses of DbSelector must implement function load()"},isDocValid:function(e){throw"Subclasses of DbSelector must implement function isValidDoc()"},getLabel:function(){throw"Subclasses of DbSelector must implement function getLabel()"}}),a=t.Class(s,{layerId:null,name:null,atlasDesign:null,documentSource:null,initialize:function(e){var i=t.extend({layer:null,name:null,atlasDesign:null,documentSource:null},e);s.prototype.initialize.call(this,e),this.layerId=i.layer,this.name=i.name,this.atlasDesign=i.atlasDesign,this.documentSource=i.documentSource},load:function(e){var i=t.extend({onSuccess:function(e){},onError:function(e){}},e),n=this;this.atlasDesign.queryView({viewName:"layers",include_docs:!0,startkey:this.layerId,endkey:this.layerId,onSuccess:function(e){for(var t=[],r=0,o=e.length;r<o;++r){var s=e[r].doc;s&&n.isDocValid(s)&&(n.documentSource&&n.documentSource.adoptDocument(s),t.push(s))}i.onSuccess(t)},onError:i.onError})},isDocValid:function(e){return!!(e&&e.nunaliit_layers&&e.nunaliit_layers.indexOf(this.layerId)>=0)},getLabel:function(){return this.name?this.name:this.layerId}}),l=t.Class(s,{schemaName:null,name:null,atlasDesign:null,documentSource:null,initialize:function(e){var i=t.extend({schemaName:null,name:null,atlasDesign:null,documentSource:null},e);s.prototype.initialize.call(this,e),this.schemaName=i.schemaName,this.name=i.name,this.atlasDesign=i.atlasDesign,this.documentSource=i.documentSource},load:function(e){var i=t.extend({onSuccess:function(e){},onError:function(e){}},e),n=this;this.atlasDesign.queryView({viewName:"nunaliit-schema",include_docs:!0,startkey:this.schemaName,endkey:this.schemaName,onSuccess:function(e){for(var t=[],r=0,o=e.length;r<o;++r){var s=e[r].doc;s&&n.isDocValid(s)&&(n.documentSource&&n.documentSource.adoptDocument(s),t.push(s))}i.onSuccess(t)},onError:i.onError})},isDocValid:function(e){return!(!e||this.schemaName!==e.nunaliit_schema)},getLabel:function(){return this.name?this.name:this.schemaName}}),c=t.Class({dispatchService:null,atlasDesign:null,siteDesign:null,documentSource:null,modelId:null,dbSelectors:null,selectorListeners:null,docInfosByDocId:null,docListeners:null,loadingCount:null,initialize:function(e){var n=t.extend({dispatchService:null,atlasDesign:null,siteDesign:null,documentSource:null,modelId:null},e),r=this;if(this.dispatchService=n.dispatchService,this.atlasDesign=n.atlasDesign,this.siteDesign=n.siteDesign,this.documentSource=n.documentSource,this.modelId=n.modelId,this.dbSelectors=[],this.selectorListeners=[],this.docInfosByDocId={},this.docListeners=[],this.loadingCount=0,this.modelId||(this.modelId=t.getUniqueId()),this.dispatchService){var o=function(e){r._handleMessage(e)};this.dispatchService.register(i,"documentContentCreated",o),this.dispatchService.register(i,"documentContentUpdated",o),this.dispatchService.register(i,"documentDeleted",o),this.dispatchService.register(i,"documentVersion",o),this.dispatchService.register(i,"cacheRetrieveDocument",o),this.dispatchService.register(i,"modelGetInfo",o),this.dispatchService.register(i,"modelGetState",o)}t.log("DbPerspective",this)},addDbSelector:function(e,i){var n=t.extend({visibility:!0},i),r=this,o={selector:e,visible:n.visibility,id:t.getUniqueId()};this.dbSelectors.push(o),++this.loadingCount,this._reportStateUpdate([],[],[]),e.load({onSuccess:function(e){--r.loadingCount,r._docsLoaded(e)},onError:function(e){--r.loadingCount,r._reportStateUpdate([],[],[])}})},addDbSelectorFromConfigObject:function(e){var i=null;if(e)if("couchDbLayer"===e.type){var n={layer:null,atlasDesign:this.atlasDesign,documentSource:this.documentSource};if(!e.options||!e.options.layerId)return t.log('DbPerspective unable to create selector. "layerId" required for "couchDbLayer"'),null;n.layer=e.options.layerId,e.name&&(n.name=e.name),i=new a(n)}else if("couchDbSchema"===e.type){n={schemaName:null,atlasDesign:this.atlasDesign,documentSource:this.documentSource};if(!e.options||!e.options.schemaName)return t.log('DbPerspective unable to create selector. "schemaName" required for "couchDbSchema"'),null;n.schemaName=e.options.schemaName,e.name&&(n.name=e.name),i=new l(n)}else t.log("Unknown DbPerspective selector type: "+e.type);return i&&this.addDbSelector(i,e),i},addSelectorListener:function(e){this.selectorListeners.push(e),e(this.getDbSelectorInfos())},getDbSelectorInfos:function(){for(var e=[],t=0,i=this.dbSelectors.length;t<i;++t){var n=this.dbSelectors[t],r=n.selector,o={id:n.id,visible:n.visible,name:r.getLabel()};e.push(o)}return e},setDbSelectorVisibility:function(e,t){for(var i=!1,n=0,r=this.dbSelectors.length;n<r;++n){var o=this.dbSelectors[n];o.id===e&&t!==o.visible&&(o.visible=t,i=!0)}if(i){this._selectorVisibilityChanged();var s=this.getDbSelectorInfos();for(n=0,r=this.selectorListeners.length;n<r;++n){(0,this.selectorListeners[n])(s)}}},addListener:function(e){this.docListeners.push(e);var t=[];for(var i in this.docInfosByDocId){var n=this.docInfosByDocId[i].doc;this._getDocVisibility(n).visible&&t.push(n)}t.length>0&&e({added:t,updated:[],removed:[]})},isDocValid:function(e){for(var t=0,i=this.dbSelectors.length;t<i;++t){if(this.dbSelectors[t].selector.isDocValid(e))return!0}return!1},isLoading:function(){return this.loadingCount>0},_selectorVisibilityChanged:function(){var e=[],t=[];for(var i in this.docInfosByDocId){var n=this.docInfosByDocId[i],r=n.doc,o=this._getDocVisibility(r);!n.visible&&o.visible?e.push(r):n.visible&&!o.visible&&t.push(r),n.visible=o.visible}this._reportStateUpdate(e,[],t)},_getDocVisibility:function(e){for(var t=n,i=0,s=this.dbSelectors.length;i<s;++i){var a=this.dbSelectors[i];if(a.selector.isDocValid(e)&&(t=r,a.visible))return o}return t},_docsLoaded:function(e){for(var t=[],i=[],n=[],r=0,o=e.length;r<o;++r){var s=e[r],a=this._getDocVisibility(s),l=this.docInfosByDocId[s._id];if(!l&&a.valid)this.docInfosByDocId[s._id]={doc:s,cacheValid:!0,visible:a.visible},a.visible&&t.push(s);else if(l&&!a.valid)delete this.docInfosByDocId[s._id],l.visible&&n.push(l.doc);else if(l&&a.valid){var c=!1;l.doc._rev!==s._rev&&(l.doc=s,l.cacheValid=!0,c=!0),l.visible&&a.visible?c&&i.push(s):!l.visible&&a.visible?(t.push(s),l.visible=!0):l.visible&&!a.visible&&(n.push(s),l.visible=!1)}}this._reportStateUpdate(t,i,n)},_handleMessage:function(e){if("documentContentCreated"===e.type||"documentContentUpdated"===e.type)e.doc&&this._docsLoaded([e.doc]);else if("documentDeleted"===e.type){var t=e.docId;if(r=this.docInfosByDocId[t]){delete this.docInfosByDocId[t];var i=[r.doc];this._reportStateUpdate([],[],i)}}else if("documentVersion"===e.type){(r=this.docInfosByDocId[e.docId])&&r.doc&&r.cacheValid&&r.doc._rev!==e.rev&&(r.cacheValid=!1)}else if("cacheRetrieveDocument"===e.type){(r=this.docInfosByDocId[e.docId])&&r.doc&&r.cacheValid&&(e.doc=r.doc)}else if("modelGetInfo"===e.type)e.modelId===this.modelId&&(e.modelInfo={modelId:this.modelId,modelType:"couchDb",parameters:{},_instance:this});else if("modelGetState"===e.type&&e.modelId===this.modelId){var n=[];for(var t in this.docInfosByDocId){var r;if((r=this.docInfosByDocId[t]).visible){var o=r.doc;n.push(o)}}e.state={added:n,updated:[],removed:[],loading:this.isLoading()}}},_reportStateUpdate:function(e,t,n){for(var r={added:e,updated:t,removed:n,loading:this.isLoading()},o=0,s=this.docListeners.length;o<s;++o){(0,this.docListeners[o])(r)}this.dispatchService&&this.dispatchService.send(i,{type:"modelStateUpdated",modelId:this.modelId,state:r})}}),d=t.Class({dispatchService:null,atlasDesign:null,siteDesign:null,modelId:null,viewName:null,isSiteView:null,includeValues:null,designDoc:null,atlasDb:null,cacheByDocId:null,docsById:null,loadingCount:null,initialize:function(e){var n=t.extend({dispatchService:null,atlasDesign:null,modelId:null,view:null,isSiteView:!1,includeValues:!0},e),r=this;if(this.dispatchService=n.dispatchService,this.atlasDesign=n.atlasDesign,this.siteDesign=n.siteDesign,this.modelId=n.modelId,this.viewName=n.view,this.isSiteView=n.isSiteView,this.includeValues=n.includeValues,"string"!=typeof this.viewName)throw new Error('Model "couchDbView" requires a string parameter "view"');if(this.designDoc=this.atlasDesign,this.isSiteView&&(this.designDoc=this.siteDesign),this.atlasDb=this.designDoc.getDatabase(),this.docsById={},this.cacheByDocId={},this.loadingCount=0,this.modelId||(this.modelId=t.getUniqueId()),this.dispatchService){var o=function(e){r._handleMessage(e)};this.dispatchService.register(i,"documentContentCreated",o),this.dispatchService.register(i,"documentContentUpdated",o),this.dispatchService.register(i,"documentDeleted",o),this.dispatchService.register(i,"documentVersion",o),this.dispatchService.register(i,"cacheRetrieveDocument",o),this.dispatchService.register(i,"modelGetInfo",o),this.dispatchService.register(i,"modelGetState",o)}this._loadView(),t.log("ModelCouchDbView",this)},isLoading:function(){return this.loadingCount>0},_loadView:function(e){t.extend({onSuccess:function(e){},onError:function(e){}},e);var i=this;++this.loadingCount,this._reportStateUpdate([],[],[]),this.designDoc.queryView({viewName:this.viewName,include_docs:!1,onSuccess:function(e){var n={};e.forEach(function(e){var t=e.id;n[t]||(n[t]=[]),n[t].push(e)}),function(e){var n=[];for(var r in e)n.push(r);i.atlasDb.getDocuments({docIds:n,onSuccess:function(t){i.cacheByDocId={};var n={};t.forEach(function(t){var r=t._id;i.cacheByDocId[r]=t;var o=e[r],s=i._computeClone(t,o);n[r]={doc:t,clone:s,values:o}}),--this.loadingCount,i._docInfoMapLoaded(n)},onError:function(e){t.log("Unable to fetch documents for CouchDb view: "+i.viewName,e),--this.loadingCount,this._reportStateUpdate([],[],[])}})}(n)},onError:function(e){t.log("Unable to load CouchDb view: "+i.viewName,e),--this.loadingCount,this._reportStateUpdate([],[],[])}})},_computeClone:function(e,i){if(this.includeValues){var n=t.extend({},e);return n.__view={},n.__view[this.viewName]=i,n}return e},_docInfoMapLoaded:function(e){var t=[],i=[],n=[];for(var r in this.docsById){this.docsById[r]&&(o=this.docsById[r].clone),e[r]&&(s=e[r].clone),s?s._rev===o._rev||i.push(s):n.push(o)}for(var r in e){var o,s;this.docsById[r]&&(o=this.docsById[r].clone),e[r]&&(s=e[r].clone),o||t.push(s)}this.docsById=e,this._reportStateUpdate(t,i,n)},_handleMessage:function(e){if("documentContentCreated"===e.type||"documentContentUpdated"===e.type){if(e.doc){var t=e.docId;this.cacheByDocId[t]&&(this.cacheByDocId[t]=e.doc),this._loadView()}}else if("documentDeleted"===e.type){t=e.docId;if(this.cacheByDocId[t]&&delete this.cacheByDocId[t],o=this.docsById[t]){delete this.docsById[t];var i=[o.clone];this._reportStateUpdate([],[],i)}}else if("documentVersion"===e.type){(n=this.cacheByDocId[e.docId])&&n._rev!==e.rev&&delete this.cacheByDocId[e.docId]}else if("cacheRetrieveDocument"===e.type){var n;(n=this.cacheByDocId[e.docId])&&(e.doc=n)}else if("modelGetInfo"===e.type)e.modelId===this.modelId&&(e.modelInfo={modelId:this.modelId,modelType:"couchDbView",parameters:{},_instance:this});else if("modelGetState"===e.type&&e.modelId===this.modelId){var r=[];for(var t in this.docsById){var o,s=(o=this.docsById[t]).clone;r.push(s)}e.state={added:r,updated:[],removed:[],loading:this.isLoading()}}},_reportStateUpdate:function(e,t,n){var r={added:e,updated:t,removed:n,loading:this.isLoading()};this.dispatchService&&this.dispatchService.send(i,{type:"modelStateUpdated",modelId:this.modelId,state:r})}});var u=t.Class({elemId:null,dispatchService:null,sourceModelId:null,dbPerspective:null,initialize:function(n){var r=t.extend({dispatchService:null,sourceModelId:null,containerId:null},n),o=this;if(this.dispatchService=r.dispatchService,this.sourceModelId=r.sourceModelId,this.dispatchService){var s={type:"modelGetInfo",modelId:this.sourceModelId};this.dispatchService.synchronousCall(i,s),s.modelInfo&&(this.dbPerspective=s.modelInfo._instance)}var a=r.containerId;if(!a)throw new Error("containerId must be specified");this.elemId=t.getUniqueId();var l=e("<div>").attr("id",this.elemId).addClass("n2dbPerspective_chooser").appendTo(e("#"+a));if(r.style)for(var c in r.style){var d=r.style[c];d&&l.css(c,d)}e("<div>").addClass("n2dbPerspective_chooser_button").appendTo(l).click(function(){o._togglePanel()}),e("<div>").addClass("n2dbPerspective_chooser_panel").appendTo(l),this._hidePanel(),this.dbPerspective&&this.dbPerspective.addSelectorListener(function(e){o._refresh()})},_refresh:function(){var e=this._getElem().find(".n2dbPerspective_chooser_panel");if(e.empty(),this.dbPerspective)for(var t=this.dbPerspective.getDbSelectorInfos(),i=0,n=t.length;i<n;++i){var r=t[i];this._addSelector(e,r)}},_addSelector:function(i,n){var r=this,o=t.getUniqueId(),s=t.getUniqueId(),a=e("<div>").attr("id",o).addClass("n2dbPerspective_chooser_line").appendTo(i),l=e("<div>").addClass("n2dbPerspective_chooser_line_input").appendTo(a),c=e("<input>").attr("type","checkbox").attr("id",s).appendTo(l).change(function(){var t=e("#"+o).find("input").is(":checked");r.dbPerspective.setDbSelectorVisibility(n.id,t)});n.visible&&c.attr("checked","checked");var d,u,h=(d=n.name,t.loc(d,"nunaliit2-couch",u)),p=e("<div>").addClass("n2dbPerspective_chooser_line_label").appendTo(a);e("<label>").attr("for",s).text(h).appendTo(p)},_togglePanel:function(){this._getElem().find(".n2dbPerspective_chooser_panel").hasClass("n2dbPerspective_chooser_panel_on")?this._hidePanel():this._showPanel()},_showPanel:function(){var e=this._getElem().find(".n2dbPerspective_chooser_panel");e.removeClass("n2dbPerspective_chooser_panel_off"),e.addClass("n2dbPerspective_chooser_panel_on")},_hidePanel:function(){var e=this._getElem().find(".n2dbPerspective_chooser_panel");e.removeClass("n2dbPerspective_chooser_panel_on"),e.addClass("n2dbPerspective_chooser_panel_off")},_getElem:function(){return e("#"+this.elemId)}});t.couchDbPerspective={DbPerspective:c,DbSelector:s,CouchLayerDbSelector:a,handleModelCreate:function(e){if("couchDb"===e.modelType||"couchDbDataSource"===e.modelType){var t={modelId:e.modelId};e&&e.config&&(t.atlasDesign=e.config.atlasDesign,t.siteDesign=e.config.siteDesign,t.documentSource=e.config.documentSource,e.config.directory&&(t.dispatchService=e.config.directory.dispatchService));var i=new c(t);if(e.modelOptions&&e.modelOptions.selectors)for(var n=e.modelOptions.selectors,r=0,o=n.length;r<o;++r){var s=n[r];i.addDbSelectorFromConfigObject(s)}e.model=i,e.created=!0}else if("couchDbView"===e.modelType){if(t={},e.modelOptions)for(var a in e.modelOptions)t[a]=e.modelOptions[a];t.modelId=e.modelId,e.config&&(t.atlasDesign=e.config.atlasDesign,t.siteDesign=e.config.siteDesign,e.config.directory&&(t.dispatchService=e.config.directory.dispatchService)),e.model=new d(t),e.created=!0}},DbPerspectiveChooser:u,HandleWidgetAvailableRequests:function(e){"couchDbSelector"===e.widgetType&&(e.isAvailable=!0)},HandleWidgetDisplayRequests:function(e){if("couchDbSelector"===e.widgetType){var t=e.widgetOptions,i=e.contentId,n=e.containerId,r=e.config,o={};if(t)for(var s in t){var a=t[s];o[s]=a}o.contentId=i,o.containerId=n,r&&r.directory&&(o.dispatchService=r.directory.dispatchService),new u(o)}}}}(jQuery,nunaliit2),function(e,t){var i="n2.couchSimplifiedGeometry",n=t.Class({url:null,dispatchService:null,customService:null,documentCache:null,dbName:null,dbProjection:null,pendingRequests:null,sendingRequests:null,initialize:function(e){var n=t.extend({url:null,dispatchService:null,customService:null,indexedDbService:null,dbName:null},e),r=this;if(this.url=n.url,this.dispatchService=n.dispatchService,this.customService=n.customService,this.dbName=n.dbName,n.indexedDbService&&(this.documentCache=n.indexedDbService.getDocumentCache()),this.sendingRequests=!1,this.pendingRequests={},this.dbProjection=null,"undefined"!=typeof OpenLayers&&OpenLayers.Projection&&(this.dbProjection=new OpenLayers.Projection("EPSG:4326")),this.dispatchService){this.dispatchService.register(i,"simplifiedGeometryRequest",function(e,t,i){r._handleDispatch(e,t,i)})}},_handleDispatch:function(e,i,n){if("simplifiedGeometryRequest"===e.type){var r=e.requester;if(!t.isArray(e.geometriesRequested))throw new Error('Event simplifiedGeometryRequest should have an array for "geometriesRequested"');e.geometriesRequested.forEach(function(e){if("object"!=typeof e)throw new Error("In event simplifiedGeometryRequest, geometriesRequested[*] should be an object");if("string"!=typeof e.id)throw new Error("In event simplifiedGeometryRequest, geometriesRequested[*].id should be a string");if("string"!=typeof e.attName)throw new Error("In event simplifiedGeometryRequest, geometriesRequested[*].attName should be a string")}),this._handleRequest(r,e.geometriesRequested)}},_handleRequest:function(e,t){this.pendingRequests[e]=t;for(var i in this.pendingRequests)this.pendingRequests[i].length;this._sendRequests()},_sendRequests:function(){var n,r,o,s=this;function a(){var e={};for(var t in n=[],s.pendingRequests)for(var a=s.pendingRequests[t],c=0,d=a.length;c<d;++c){var u=a[c],h=e[u.id];if(h||(h={},e[u.id]=h),h[u.attName]);else{h[u.attName]=!0;var p={id:u.id,attName:u.attName};n.push(p)}}n.length<=0?s.sendingRequests=!1:s.documentCache&&s.dbName?(r=[],o=[],function e(){if(n.length<=0||r.length>=100)s._cleanUpPendingRequests(o),o.length>0&&(s.dispatchService.send(i,{type:"simplifiedGeometryReport",simplifiedGeometries:o}),o=[]),l();else{var t=n.shift();s.documentCache.getAttachment({dbName:s.dbName,docId:t.id,attName:t.attName,onSuccess:function(i,n){if(i){var a={id:t.id,rev:n,attName:t.attName,wkt:i};s.dbProjection&&(a.proj=s.dbProjection),o.push(a)}else r.push(t);e()},onError:function(i){r.push(t),e()}})}}()):(r=n,l())}function l(){var n={geometryRequests:r};if(n.geometryRequests.length>100&&(n.geometryRequests=n.geometryRequests.slice(0,100)),s.customService){var o=s.customService.getOption("simplifiedGeometriesSizeLimit");"number"==typeof o&&(n.sizeLimit=o)}if(s.customService){var l=s.customService.getOption("simplifiedGeometriesTimeLimit");"number"==typeof l&&(n.timeLimit=l)}n.geometryRequests.length>0?e.ajax({url:s.url+"getAttachments",type:"post",async:!0,data:JSON.stringify(n),contentType:"application/json",dataType:"json",success:function(e){e&&e.geometries?function(e){for(var t=[],n=0,r=e.length;n<r;++n){var o=e[n];if(o.att&&o.att.length>0){var l={id:o.id,rev:o.rev,attName:o.attName,wkt:o.att};s.dbProjection&&(l.proj=s.dbProjection),t.push(l)}}if(s.dbName&&s.documentCache){var c=[];e.forEach(function(e){var t={dbName:s.dbName,id:e.id,rev:e.rev,attachments:{}};t.attachments[e.attName]=e.att,c.push(t)}),s.documentCache.performChanges(c)}s._cleanUpPendingRequests(t),t.length>0&&s.dispatchService.send(i,{type:"simplifiedGeometryReport",simplifiedGeometries:t});a()}(e.geometries):a()},error:function(e,i,r){t.log("Unable to get simplified geometries",n);var o=void 0;for(o in s.pendingRequests)break;o&&delete s.pendingRequests[o],a()}}):a()}this.sendingRequests||(this.sendingRequests=!0,a())},_cleanUpPendingRequests:function(e){var t={};for(var i in e.forEach(function(e){var i=e.id,n=e.attName,r=t[i];r||(r={},t[i]=r),r[n]=!0}),this.pendingRequests){var n=this.pendingRequests[i],r=[];n.forEach(function(e){t[e.id]&&t[e.id][e.attName]||r.push(e)}),this.pendingRequests[i]=r}}});t.couchSimplifiedGeometries={Service:n}}(jQuery,nunaliit2),module.exports=nunaliit2}).call(this,__webpack_require__(2),__webpack_require__(6)(module))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){e.exports=function(){throw new Error("define cannot be used indirect")}},function(e,t){(function(t){e.exports=t}).call(this,{})},function(e,t,i){"use strict";function n(){return function(){throw new Error("Unimplemented abstract method.")}()}i.r(t);var r=0;function o(e){return e.ol_uid||(e.ol_uid=String(++r))}var s="5.3.0",a=function(e){function t(t){var i="Assertion failed. See https://openlayers.org/en/"+("latest"===s?s:"v"+s.split("-")[0])+"/doc/errors/#"+t+" for details.";e.call(this,i),this.code=t,this.name="AssertionError",this.message=i}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(Error);function l(e,t){if(!e)throw new a(t)}var c="function"==typeof Object.assign?Object.assign:function(e,t){var i=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),r=1,o=arguments.length;r<o;++r){var s=i[r];if(null!=s)for(var a in s)s.hasOwnProperty(a)&&(n[a]=s[a])}return n};function d(e){for(var t in e)delete e[t]}function u(e){var t;for(t in e)return!1;return!t}function h(e,t,i,n){for(var r,o=0,s=e.length;o<s;++o)if((r=e[o]).listener===t&&r.bindTo===i)return n&&(r.deleteIndex=o),r}function p(e,t){var i=f(e);return i?i[t]:void 0}function f(e,t){var i=e.ol_lm;return!i&&t&&(i=e.ol_lm={}),i}function m(e,t){var i=p(e,t);if(i){for(var n=0,r=i.length;n<r;++n)e.removeEventListener(t,i[n].boundListener),d(i[n]);i.length=0;var o=f(e);o&&(delete o[t],0===Object.keys(o).length&&function(e){delete e.ol_lm}(e))}}function v(e,t,i,n,r){var o=f(e,!0),s=o[t];s||(s=o[t]=[]);var a=h(s,i,n,!1);return a?r||(a.callOnce=!1):(a={bindTo:n,callOnce:!!r,listener:i,target:e,type:t},e.addEventListener(t,function(e){var t=function(t){var i=e.listener,n=e.bindTo||e.target;return e.callOnce&&_(e),i.call(n,t)};return e.boundListener=t,t}(a)),s.push(a)),a}function g(e,t,i,n){return v(e,t,i,n,!0)}function y(e,t,i,n){var r=p(e,t);if(r){var o=h(r,i,n,!0);o&&_(o)}}function _(e){if(e&&e.target){e.target.removeEventListener(e.type,e.boundListener);var t=p(e.target,e.type);if(t){var i="deleteIndex"in e?e.deleteIndex:t.indexOf(e);-1!==i&&t.splice(i,1),0===t.length&&m(e.target,e.type)}d(e)}}var S={CHANGE:"change",CLEAR:"clear",CONTEXTMENU:"contextmenu",CLICK:"click",DBLCLICK:"dblclick",DRAGENTER:"dragenter",DRAGOVER:"dragover",DROP:"drop",ERROR:"error",KEYDOWN:"keydown",KEYPRESS:"keypress",LOAD:"load",MOUSEDOWN:"mousedown",MOUSEMOVE:"mousemove",MOUSEOUT:"mouseout",MOUSEUP:"mouseup",MOUSEWHEEL:"mousewheel",MSPOINTERDOWN:"MSPointerDown",RESIZE:"resize",TOUCHSTART:"touchstart",TOUCHMOVE:"touchmove",TOUCHEND:"touchend",WHEEL:"wheel"},b="propertychange",I=function(){this.disposed_=!1};I.prototype.dispose=function(){this.disposed_||(this.disposed_=!0,this.disposeInternal())},I.prototype.disposeInternal=function(){};var C=I;function D(){return!0}function w(){}var E=function(e){this.propagationStopped,this.type=e,this.target=null};E.prototype.preventDefault=function(){this.propagationStopped=!0},E.prototype.stopPropagation=function(){this.propagationStopped=!0};var x=E;var T=function(e){function t(){e.call(this),this.revision_=0}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.changed=function(){++this.revision_,this.dispatchEvent(S.CHANGE)},t.prototype.getRevision=function(){return this.revision_},t.prototype.on=function(e,t){if(Array.isArray(e)){for(var i=e.length,n=new Array(i),r=0;r<i;++r)n[r]=v(this,e[r],t);return n}return v(this,e,t)},t.prototype.once=function(e,t){if(Array.isArray(e)){for(var i=e.length,n=new Array(i),r=0;r<i;++r)n[r]=g(this,e[r],t);return n}return g(this,e,t)},t.prototype.un=function(e,t){if(Array.isArray(e))for(var i=0,n=e.length;i<n;++i)y(this,e[i],t);else y(this,e,t)},t}(function(e){function t(){e.call(this),this.pendingRemovals_={},this.dispatching_={},this.listeners_={}}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.addEventListener=function(e,t){var i=this.listeners_[e];i||(i=this.listeners_[e]=[]),-1===i.indexOf(t)&&i.push(t)},t.prototype.dispatchEvent=function(e){var t="string"==typeof e?new x(e):e,i=t.type;t.target=this;var n,r=this.listeners_[i];if(r){i in this.dispatching_||(this.dispatching_[i]=0,this.pendingRemovals_[i]=0),++this.dispatching_[i];for(var o=0,s=r.length;o<s;++o)if(!1===r[o].call(this,t)||t.propagationStopped){n=!1;break}if(--this.dispatching_[i],0===this.dispatching_[i]){var a=this.pendingRemovals_[i];for(delete this.pendingRemovals_[i];a--;)this.removeEventListener(i,w);delete this.dispatching_[i]}return n}},t.prototype.disposeInternal=function(){!function(e){var t=f(e);if(t)for(var i in t)m(e,i)}(this)},t.prototype.getListeners=function(e){return this.listeners_[e]},t.prototype.hasListener=function(e){return e?e in this.listeners_:Object.keys(this.listeners_).length>0},t.prototype.removeEventListener=function(e,t){var i=this.listeners_[e];if(i){var n=i.indexOf(t);e in this.pendingRemovals_?(i[n]=w,++this.pendingRemovals_[e]):(i.splice(n,1),0===i.length&&delete this.listeners_[e])}},t}(C)),k=function(e){function t(t,i,n){e.call(this,t),this.key=i,this.oldValue=n}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(x),L={};function M(e){return L.hasOwnProperty(e)?L[e]:L[e]="change:"+e}var O=function(e){function t(t){e.call(this),o(this),this.values_={},void 0!==t&&this.setProperties(t)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.get=function(e){var t;return this.values_.hasOwnProperty(e)&&(t=this.values_[e]),t},t.prototype.getKeys=function(){return Object.keys(this.values_)},t.prototype.getProperties=function(){return c({},this.values_)},t.prototype.notify=function(e,t){var i;i=M(e),this.dispatchEvent(new k(i,e,t)),i=b,this.dispatchEvent(new k(i,e,t))},t.prototype.set=function(e,t,i){if(i)this.values_[e]=t;else{var n=this.values_[e];this.values_[e]=t,n!==t&&this.notify(e,n)}},t.prototype.setProperties=function(e,t){for(var i in e)this.set(i,e[i],t)},t.prototype.unset=function(e,t){if(e in this.values_){var i=this.values_[e];delete this.values_[e],t||this.notify(e,i)}},t}(T);var A=function(e){function t(t){if(e.call(this),this.id_=void 0,this.geometryName_="geometry",this.style_=null,this.styleFunction_=void 0,this.geometryChangeKey_=null,v(this,M(this.geometryName_),this.handleGeometryChanged_,this),t)if("function"==typeof t.getSimplifiedGeometry){var i=t;this.setGeometry(i)}else{var n=t;this.setProperties(n)}}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.clone=function(){var e=new t(this.getProperties());e.setGeometryName(this.getGeometryName());var i=this.getGeometry();i&&e.setGeometry(i.clone());var n=this.getStyle();return n&&e.setStyle(n),e},t.prototype.getGeometry=function(){return this.get(this.geometryName_)},t.prototype.getId=function(){return this.id_},t.prototype.getGeometryName=function(){return this.geometryName_},t.prototype.getStyle=function(){return this.style_},t.prototype.getStyleFunction=function(){return this.styleFunction_},t.prototype.handleGeometryChange_=function(){this.changed()},t.prototype.handleGeometryChanged_=function(){this.geometryChangeKey_&&(_(this.geometryChangeKey_),this.geometryChangeKey_=null);var e=this.getGeometry();e&&(this.geometryChangeKey_=v(e,S.CHANGE,this.handleGeometryChange_,this)),this.changed()},t.prototype.setGeometry=function(e){this.set(this.geometryName_,e)},t.prototype.setStyle=function(e){this.style_=e,this.styleFunction_=e?function(e){if("function"==typeof e)return e;var t;if(Array.isArray(e))t=e;else{l("function"==typeof e.getZIndex,41);var i=e;t=[i]}return function(){return t}}(e):void 0,this.changed()},t.prototype.setId=function(e){this.id_=e,this.changed()},t.prototype.setGeometryName=function(e){y(this,M(this.geometryName_),this.handleGeometryChanged_,this),this.geometryName_=e,v(this,M(this.geometryName_),this.handleGeometryChanged_,this),this.handleGeometryChanged_()},t}(O),F={POINT:"Point",LINE_STRING:"LineString",LINEAR_RING:"LinearRing",POLYGON:"Polygon",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon",GEOMETRY_COLLECTION:"GeometryCollection",CIRCLE:"Circle"};var R="cosh"in Math?Math.cosh:function(e){var t=Math.exp(e);return(t+1/t)/2};function N(e,t,i,n){var r=i-e,o=n-t;return r*r+o*o}function P(e,t){return e[0]+=t[0],e[1]+=t[1],e}function B(e,t){return e[0]*=t,e[1]*=t,e}function U(e,t,i){return i?(i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]+t,i[3]=e[3]+t,i):[e[0]-t,e[1]-t,e[2]+t,e[3]+t]}function j(e,t,i){return e[0]<=t&&t<=e[2]&&e[1]<=i&&i<=e[3]}function z(e,t,i,n,r){return r?(r[0]=e,r[1]=t,r[2]=i,r[3]=n,r):[e,t,i,n]}function G(e){return z(1/0,1/0,-1/0,-1/0,e)}function q(e,t){var i=e[0],n=e[1];return z(i,n,i,n,t)}function V(e,t,i,n,r){return function(e,t,i,n,r){for(;i<n;i+=r)W(e,t[i],t[i+1]);return e}(G(r),e,t,i,n)}function H(e,t){return e[0]==t[0]&&e[2]==t[2]&&e[1]==t[1]&&e[3]==t[3]}function W(e,t,i){e[0]=Math.min(e[0],t),e[1]=Math.min(e[1],i),e[2]=Math.max(e[2],t),e[3]=Math.max(e[3],i)}function $(e){return[(e[0]+e[2])/2,(e[1]+e[3])/2]}function K(e){return e[3]-e[1]}function Y(e,t,i){var n=[e[0],e[1],e[0],e[3],e[2],e[1],e[2],e[3]];return t(n,n,2),function(e,t,i){return z(Math.min.apply(null,e),Math.min.apply(null,t),Math.max.apply(null,e),Math.max.apply(null,t),i)}([n[0],n[2],n[4],n[6]],[n[1],n[3],n[5],n[7]],i)}function J(e,t,i,n,r,o){for(var s=o||[],a=0,l=t;l<i;l+=n){var c=e[l],d=e[l+1];s[a++]=r[0]*c+r[2]*d+r[4],s[a++]=r[1]*c+r[3]*d+r[5]}return o&&s.length!=a&&(s.length=a),s}var X={DEGREES:"degrees",FEET:"ft",METERS:"m",PIXELS:"pixels",TILE_PIXELS:"tile-pixels",USFEET:"us-ft"},Q={};Q[X.DEGREES]=2*Math.PI*6370997/360,Q[X.FEET]=.3048,Q[X.METERS]=1,Q[X.USFEET]=1200/3937;var Z=X,ee=function(e){this.code_=e.code,this.units_=e.units,this.extent_=void 0!==e.extent?e.extent:null,this.worldExtent_=void 0!==e.worldExtent?e.worldExtent:null,this.axisOrientation_=void 0!==e.axisOrientation?e.axisOrientation:"enu",this.global_=void 0!==e.global&&e.global,this.canWrapX_=!(!this.global_||!this.extent_),this.getPointResolutionFunc_=e.getPointResolution,this.defaultTileGrid_=null,this.metersPerUnit_=e.metersPerUnit};ee.prototype.canWrapX=function(){return this.canWrapX_},ee.prototype.getCode=function(){return this.code_},ee.prototype.getExtent=function(){return this.extent_},ee.prototype.getUnits=function(){return this.units_},ee.prototype.getMetersPerUnit=function(){return this.metersPerUnit_||Q[this.units_]},ee.prototype.getWorldExtent=function(){return this.worldExtent_},ee.prototype.getAxisOrientation=function(){return this.axisOrientation_},ee.prototype.isGlobal=function(){return this.global_},ee.prototype.setGlobal=function(e){this.global_=e,this.canWrapX_=!(!e||!this.extent_)},ee.prototype.getDefaultTileGrid=function(){return this.defaultTileGrid_},ee.prototype.setDefaultTileGrid=function(e){this.defaultTileGrid_=e},ee.prototype.setExtent=function(e){this.extent_=e,this.canWrapX_=!(!this.global_||!e)},ee.prototype.setWorldExtent=function(e){this.worldExtent_=e},ee.prototype.setGetPointResolution=function(e){this.getPointResolutionFunc_=e},ee.prototype.getPointResolutionFunc=function(){return this.getPointResolutionFunc_};var te=ee,ie=6378137,ne=Math.PI*ie,re=[-ne,-ne,ne,ne],oe=[-180,-85,180,85],se=function(e){function t(t){e.call(this,{code:t,units:Z.METERS,extent:re,global:!0,worldExtent:oe,getPointResolution:function(e,t){return e/R(t[1]/ie)}})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(te),ae=[new se("EPSG:3857"),new se("EPSG:102100"),new se("EPSG:102113"),new se("EPSG:900913"),new se("urn:ogc:def:crs:EPSG:6.18:3:3857"),new se("urn:ogc:def:crs:EPSG::3857"),new se("http://www.opengis.net/gml/srs/epsg.xml#3857")];function le(e,t,i){var n=e.length,r=i>1?i:2,o=t;void 0===o&&(o=r>2?e.slice():new Array(n));for(var s=ne,a=0;a<n;a+=r){o[a]=s*e[a]/180;var l=ie*Math.log(Math.tan(Math.PI*(e[a+1]+90)/360));l>s?l=s:l<-s&&(l=-s),o[a+1]=l}return o}function ce(e,t,i){var n=e.length,r=i>1?i:2,o=t;void 0===o&&(o=r>2?e.slice():new Array(n));for(var s=0;s<n;s+=r)o[s]=180*e[s]/ne,o[s+1]=360*Math.atan(Math.exp(e[s+1]/ie))/Math.PI-90;return o}var de=[-180,-90,180,90],ue=6378137*Math.PI/180,he=function(e){function t(t,i){e.call(this,{code:t,units:Z.DEGREES,extent:de,axisOrientation:i,global:!0,metersPerUnit:ue,worldExtent:de})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(te),pe=[new he("CRS:84"),new he("EPSG:4326","neu"),new he("urn:ogc:def:crs:EPSG::4326","neu"),new he("urn:ogc:def:crs:EPSG:6.6:4326","neu"),new he("urn:ogc:def:crs:OGC:1.3:CRS84"),new he("urn:ogc:def:crs:OGC:2:84"),new he("http://www.opengis.net/gml/srs/epsg.xml#4326","neu"),new he("urn:x-ogc:def:crs:EPSG:4326","neu")],fe={};var me,ve,ge,ye={};function _e(e,t,i){var n=e.getCode(),r=t.getCode();n in ye||(ye[n]={}),ye[n][r]=i}function Se(e,t,i){var n;if(void 0!==t){for(var r=0,o=e.length;r<o;++r)t[r]=e[r];n=t}else n=e.slice();return n}function be(e,t,i){if(void 0!==t&&e!==t){for(var n=0,r=e.length;n<r;++n)t[n]=e[n];e=t}return e}function Ie(e){!function(e,t){fe[e]=t}(e.getCode(),e),_e(e,e,Se)}function Ce(e){return"string"==typeof e?fe[e]||null:e||null}function De(e){!function(e){e.forEach(Ie)}(e),e.forEach(function(t){e.forEach(function(e){t!==e&&_e(t,e,Se)})})}function we(e,t){var i=function(e,t){var i;return e in ye&&t in ye[e]&&(i=ye[e][t]),i}(e.getCode(),t.getCode());return i||(i=be),i}function Ee(e,t){return we(Ce(e),Ce(t))}De(ae),De(pe),me=ae,ve=le,ge=ce,pe.forEach(function(e){me.forEach(function(t){_e(e,t,ve),_e(t,e,ge)})});new Array(6);var xe=[1,0,0,1,0,0],Te={XY:"XY",XYZ:"XYZ",XYM:"XYM",XYZM:"XYZM"};function ke(e){var t;return e==Te.XY?t=2:e==Te.XYZ||e==Te.XYM?t=3:e==Te.XYZM&&(t=4),t}var Le=function(e){function t(t,i){e.call(this),this.setCoordinates(t,i)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.clone=function(){return new t(this.flatCoordinates.slice(),this.layout)},t.prototype.closestPointXY=function(e,t,i,n){var r=this.flatCoordinates,o=N(e,t,r[0],r[1]);if(o<n){for(var s=this.stride,a=0;a<s;++a)i[a]=r[a];return i.length=s,o}return n},t.prototype.getCoordinates=function(){return this.flatCoordinates?this.flatCoordinates.slice():[]},t.prototype.computeExtent=function(e){return q(this.flatCoordinates,e)},t.prototype.getType=function(){return F.POINT},t.prototype.intersectsExtent=function(e){return j(e,this.flatCoordinates[0],this.flatCoordinates[1])},t.prototype.setCoordinates=function(e,t){this.setLayout(t,e,0),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=function(e,t,i,n){for(var r=0,o=i.length;r<o;++r)e[t++]=i[r];return t}(this.flatCoordinates,0,e,this.stride),this.changed()},t}(function(e){function t(){e.call(this),this.layout=Te.XY,this.stride=2,this.flatCoordinates=null}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.computeExtent=function(e){return V(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,e)},t.prototype.getCoordinates=function(){return n()},t.prototype.getFirstCoordinate=function(){return this.flatCoordinates.slice(0,this.stride)},t.prototype.getFlatCoordinates=function(){return this.flatCoordinates},t.prototype.getLastCoordinate=function(){return this.flatCoordinates.slice(this.flatCoordinates.length-this.stride)},t.prototype.getLayout=function(){return this.layout},t.prototype.getSimplifiedGeometry=function(e){if(this.simplifiedGeometryRevision!=this.getRevision()&&(d(this.simplifiedGeometryCache),this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=this.getRevision()),e<0||0!==this.simplifiedGeometryMaxMinSquaredTolerance&&e<=this.simplifiedGeometryMaxMinSquaredTolerance)return this;var t=e.toString();if(this.simplifiedGeometryCache.hasOwnProperty(t))return this.simplifiedGeometryCache[t];var i=this.getSimplifiedGeometryInternal(e);return i.getFlatCoordinates().length<this.flatCoordinates.length?(this.simplifiedGeometryCache[t]=i,i):(this.simplifiedGeometryMaxMinSquaredTolerance=e,this)},t.prototype.getSimplifiedGeometryInternal=function(e){return this},t.prototype.getStride=function(){return this.stride},t.prototype.setFlatCoordinates=function(e,t){this.stride=ke(e),this.layout=e,this.flatCoordinates=t},t.prototype.setCoordinates=function(e,t){n()},t.prototype.setLayout=function(e,t,i){var n;if(e)n=ke(e);else{for(var r=0;r<i;++r){if(0===t.length)return this.layout=Te.XY,void(this.stride=2);t=t[0]}e=function(e){var t;2==e?t=Te.XY:3==e?t=Te.XYZ:4==e&&(t=Te.XYZM);return t}(n=t.length)}this.layout=e,this.stride=n},t.prototype.applyTransform=function(e){this.flatCoordinates&&(e(this.flatCoordinates,this.flatCoordinates,this.stride),this.changed())},t.prototype.rotate=function(e,t){var i=this.getFlatCoordinates();if(i){var n=this.getStride();!function(e,t,i,n,r,o,s){for(var a=s||[],l=Math.cos(r),c=Math.sin(r),d=o[0],u=o[1],h=0,p=t;p<i;p+=n){var f=e[p]-d,m=e[p+1]-u;a[h++]=d+f*l-m*c,a[h++]=u+f*c+m*l;for(var v=p+2;v<p+n;++v)a[h++]=e[v]}s&&a.length!=h&&(a.length=h)}(i,0,i.length,n,e,t,i),this.changed()}},t.prototype.scale=function(e,t,i){var n=t;void 0===n&&(n=e);var r=i;r||(r=$(this.getExtent()));var o=this.getFlatCoordinates();if(o){var s=this.getStride();!function(e,t,i,n,r,o,s,a){for(var l=a||[],c=s[0],d=s[1],u=0,h=t;h<i;h+=n){var p=e[h]-c,f=e[h+1]-d;l[u++]=c+r*p,l[u++]=d+o*f;for(var m=h+2;m<h+n;++m)l[u++]=e[m]}a&&l.length!=u&&(l.length=u)}(o,0,o.length,s,e,n,r,o),this.changed()}},t.prototype.translate=function(e,t){var i=this.getFlatCoordinates();if(i){var n=this.getStride();!function(e,t,i,n,r,o,s){for(var a=s||[],l=0,c=t;c<i;c+=n){a[l++]=e[c]+r,a[l++]=e[c+1]+o;for(var d=c+2;d<c+n;++d)a[l++]=e[d]}s&&a.length!=l&&(a.length=l)}
/**
 * @license
 * Latitude/longitude spherical geodesy formulae taken from
 * http://www.movable-type.co.uk/scripts/latlong.html
 * Licensed under CC-BY-3.0.
 */(i,0,i.length,n,e,t,i),this.changed()}},t}(function(e){function t(){e.call(this),this.extent_=[1/0,1/0,-1/0,-1/0],this.extentRevision_=-1,this.simplifiedGeometryCache={},this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=0}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.clone=function(){return n()},t.prototype.closestPointXY=function(e,t,i,r){return n()},t.prototype.containsXY=function(e,t){return!1},t.prototype.getClosestPoint=function(e,t){var i=t||[NaN,NaN];return this.closestPointXY(e[0],e[1],i,1/0),i},t.prototype.intersectsCoordinate=function(e){return this.containsXY(e[0],e[1])},t.prototype.computeExtent=function(e){return n()},t.prototype.getExtent=function(e){return this.extentRevision_!=this.getRevision()&&(this.extent_=this.computeExtent(this.extent_),this.extentRevision_=this.getRevision()),function(e,t){return t?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t):e}(this.extent_,e)},t.prototype.rotate=function(e,t){n()},t.prototype.scale=function(e,t,i){n()},t.prototype.simplify=function(e){return this.getSimplifiedGeometry(e*e)},t.prototype.getSimplifiedGeometry=function(e){return n()},t.prototype.getType=function(){return n()},t.prototype.applyTransform=function(e){n()},t.prototype.intersectsExtent=function(e){return n()},t.prototype.translate=function(e,t){n()},t.prototype.transform=function(e,t){var i=Ce(e),n=i.getUnits()==Z.TILE_PIXELS?function(e,n,r){var o,s,a,l,c,d,u,h,p,f,m=i.getExtent(),v=i.getWorldExtent(),g=K(v)/K(m);return o=xe,s=v[0],a=v[3],l=g,c=-g,d=0,u=0,h=0,p=Math.sin(d),f=Math.cos(d),o[0]=l*f,o[1]=c*p,o[2]=-l*p,o[3]=c*f,o[4]=u*l*f-h*l*p+s,o[5]=u*c*p+h*c*f+a,J(e,0,e.length,r,xe,n),Ee(i,t)(e,n,r)}:Ee(i,t);return this.applyTransform(n),this},t}(O))),Me="add",Oe="remove",Ae="length",Fe=function(e){function t(t,i){e.call(this,t),this.element=i}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(x),Re=function(e){function t(t,i){e.call(this);var n=i||{};if(this.unique_=!!n.unique,this.array_=t||[],this.unique_)for(var r=0,o=this.array_.length;r<o;++r)this.assertUnique_(this.array_[r],r);this.updateLength_()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.clear=function(){for(;this.getLength()>0;)this.pop()},t.prototype.extend=function(e){for(var t=0,i=e.length;t<i;++t)this.push(e[t]);return this},t.prototype.forEach=function(e){for(var t=this.array_,i=0,n=t.length;i<n;++i)e(t[i],i,t)},t.prototype.getArray=function(){return this.array_},t.prototype.item=function(e){return this.array_[e]},t.prototype.getLength=function(){return this.get(Ae)},t.prototype.insertAt=function(e,t){this.unique_&&this.assertUnique_(t),this.array_.splice(e,0,t),this.updateLength_(),this.dispatchEvent(new Fe(Me,t))},t.prototype.pop=function(){return this.removeAt(this.getLength()-1)},t.prototype.push=function(e){this.unique_&&this.assertUnique_(e);var t=this.getLength();return this.insertAt(t,e),this.getLength()},t.prototype.remove=function(e){for(var t=this.array_,i=0,n=t.length;i<n;++i)if(t[i]===e)return this.removeAt(i)},t.prototype.removeAt=function(e){var t=this.array_[e];return this.array_.splice(e,1),this.updateLength_(),this.dispatchEvent(new Fe(Oe,t)),t},t.prototype.setAt=function(e,t){var i=this.getLength();if(e<i){this.unique_&&this.assertUnique_(t,e);var n=this.array_[e];this.array_[e]=t,this.dispatchEvent(new Fe(Oe,n)),this.dispatchEvent(new Fe(Me,t))}else{for(var r=i;r<e;++r)this.insertAt(r,void 0);this.insertAt(e,t)}},t.prototype.updateLength_=function(){this.set(Ae,this.array_.length)},t.prototype.assertUnique_=function(e,t){for(var i=0,n=this.array_.length;i<n;++i)if(this.array_[i]===e&&i!==t)throw new a(58)},t}(O);var Ne={ARRAY_BUFFER:"arraybuffer",JSON:"json",TEXT:"text",XML:"xml"};function Pe(e,t){return function(e,t,i,n){return function(r,o,s){var a=new XMLHttpRequest;a.open("GET","function"==typeof e?e(r,o,s):e,!0),t.getType()==Ne.ARRAY_BUFFER&&(a.responseType="arraybuffer"),a.onload=function(e){if(!a.status||a.status>=200&&a.status<300){var r,o=t.getType();o==Ne.JSON||o==Ne.TEXT?r=a.responseText:o==Ne.XML?(r=a.responseXML)||(r=(new DOMParser).parseFromString(a.responseText,"application/xml")):o==Ne.ARRAY_BUFFER&&(r=a.response),r?i.call(this,t.readFeatures(r,{featureProjection:s}),t.readProjection(r),t.getLastExtent()):n.call(this)}else n.call(this)}.bind(this),a.onerror=function(){n.call(this)}.bind(this),a.send()}}(e,t,function(e,t){"function"==typeof this.addFeatures&&this.addFeatures(e)},w)}function Be(e,t){return[[-1/0,-1/0,1/0,1/0]]}var Ue={UNDEFINED:"undefined",LOADING:"loading",READY:"ready",ERROR:"error"};function je(e){return e?Array.isArray(e)?function(t){return e}:"function"==typeof e?e:function(t){return[e]}:null}var ze=function(e){function t(t){e.call(this),this.projection_=Ce(t.projection),this.attributions_=je(t.attributions),this.attributionsCollapsible_=void 0===t.attributionsCollapsible||t.attributionsCollapsible,this.loading=!1,this.state_=void 0!==t.state?t.state:Ue.READY,this.wrapX_=void 0!==t.wrapX&&t.wrapX}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.getAttributions=function(){return this.attributions_},t.prototype.getAttributionsCollapsible=function(){return this.attributionsCollapsible_},t.prototype.getProjection=function(){return this.projection_},t.prototype.getResolutions=function(){return n()},t.prototype.getState=function(){return this.state_},t.prototype.getWrapX=function(){return this.wrapX_},t.prototype.refresh=function(){this.changed()},t.prototype.setAttributions=function(e){this.attributions_=je(e),this.changed()},t.prototype.setState=function(e){this.state_=e,this.changed()},t}(O),Ge="addfeature",qe="changefeature",Ve="clear",He="removefeature",We=i(3),$e=i.n(We),Ke=function(e){this.rbush_=$e()(e,void 0),this.items_={}};Ke.prototype.insert=function(e,t){var i={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(i),this.items_[o(t)]=i},Ke.prototype.load=function(e,t){for(var i=new Array(t.length),n=0,r=t.length;n<r;n++){var s=e[n],a=t[n],l={minX:s[0],minY:s[1],maxX:s[2],maxY:s[3],value:a};i[n]=l,this.items_[o(a)]=l}this.rbush_.load(i)},Ke.prototype.remove=function(e){var t=o(e),i=this.items_[t];return delete this.items_[t],null!==this.rbush_.remove(i)},Ke.prototype.update=function(e,t){var i=this.items_[o(t)];H([i.minX,i.minY,i.maxX,i.maxY],e)||(this.remove(t),this.insert(e,t))},Ke.prototype.getAll=function(){return this.rbush_.all().map(function(e){return e.value})},Ke.prototype.getInExtent=function(e){var t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(e){return e.value})},Ke.prototype.forEach=function(e,t){return this.forEach_(this.getAll(),e,t)},Ke.prototype.forEachInExtent=function(e,t,i){return this.forEach_(this.getInExtent(e),t,i)},Ke.prototype.forEach_=function(e,t,i){for(var n,r=0,o=e.length;r<o;r++)if(n=t.call(i,e[r]))return n;return n},Ke.prototype.isEmpty=function(){return u(this.items_)},Ke.prototype.clear=function(){this.rbush_.clear(),this.items_={}},Ke.prototype.getExtent=function(e){var t=this.rbush_.toJSON();return z(t.minX,t.minY,t.maxX,t.maxY,e)},Ke.prototype.concat=function(e){for(var t in this.rbush_.load(e.rbush_.all()),e.items_)this.items_[t]=e.items_[t]};var Ye=Ke,Je=function(e){function t(t,i){e.call(this,t),this.feature=i}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(x),Xe=function(e){function t(t){e.call(this,{attributions:t.attributions,wrapX:t.wrapX}),this.resolution=void 0,this.distance=void 0!==t.distance?t.distance:20,this.features=[],this.geometryFunction=t.geometryFunction||function(e){var t=e.getGeometry();return l(t.getType()==F.POINT,10),t},this.source=t.source,v(this.source,S.CHANGE,this.refresh,this)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.getDistance=function(){return this.distance},t.prototype.getSource=function(){return this.source},t.prototype.loadFeatures=function(e,t,i){this.source.loadFeatures(e,t,i),t!==this.resolution&&(this.clear(),this.resolution=t,this.cluster(),this.addFeatures(this.features))},t.prototype.setDistance=function(e){this.distance=e,this.refresh()},t.prototype.refresh=function(){this.clear(),this.cluster(),this.addFeatures(this.features),e.prototype.refresh.call(this)},t.prototype.cluster=function(){if(void 0!==this.resolution){this.features.length=0;for(var e=[1/0,1/0,-1/0,-1/0],t=this.distance*this.resolution,i=this.source.getFeatures(),n={},r=0,s=i.length;r<s;r++){var a=i[r];if(!(o(a)in n)){var l=this.geometryFunction(a);if(l){q(l.getCoordinates(),e),U(e,t,e);var c=this.source.getFeaturesInExtent(e);c=c.filter(function(e){var t=o(e);return!(t in n)&&(n[t]=!0,!0)}),this.features.push(this.createCluster(c))}}}}},t.prototype.createCluster=function(e){for(var t=[0,0],i=e.length-1;i>=0;--i){var n=this.geometryFunction(e[i]);n?P(t,n.getCoordinates()):e.splice(i,1)}B(t,1/e.length);var r=new A(new Le(t));return r.set("features",e),r},t}(function(e){function t(t){var i=t||{};e.call(this,{attributions:i.attributions,projection:void 0,state:Ue.READY,wrapX:void 0===i.wrapX||i.wrapX}),this.loader_=w,this.format_=i.format,this.overlaps_=null==i.overlaps||i.overlaps,this.url_=i.url,void 0!==i.loader?this.loader_=i.loader:void 0!==this.url_&&(l(this.format_,7),this.loader_=Pe(this.url_,this.format_)),this.strategy_=void 0!==i.strategy?i.strategy:Be;var n,r,o=void 0===i.useSpatialIndex||i.useSpatialIndex;this.featuresRtree_=o?new Ye:null,this.loadedExtentsRtree_=new Ye,this.nullGeometryFeatures_={},this.idIndex_={},this.undefIdIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null,Array.isArray(i.features)?r=i.features:i.features&&(r=(n=i.features).getArray()),o||void 0!==n||(n=new Re(r)),void 0!==r&&this.addFeaturesInternal(r),void 0!==n&&this.bindFeaturesCollection_(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.addFeature=function(e){this.addFeatureInternal(e),this.changed()},t.prototype.addFeatureInternal=function(e){var t=o(e);if(this.addToIndex_(t,e)){this.setupChangeEvents_(t,e);var i=e.getGeometry();if(i){var n=i.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(n,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new Je(Ge,e))}},t.prototype.setupChangeEvents_=function(e,t){this.featureChangeKeys_[e]=[v(t,S.CHANGE,this.handleFeatureChange_,this),v(t,b,this.handleFeatureChange_,this)]},t.prototype.addToIndex_=function(e,t){var i=!0,n=t.getId();return void 0!==n?n.toString()in this.idIndex_?i=!1:this.idIndex_[n.toString()]=t:(l(!(e in this.undefIdIndex_),30),this.undefIdIndex_[e]=t),i},t.prototype.addFeatures=function(e){this.addFeaturesInternal(e),this.changed()},t.prototype.addFeaturesInternal=function(e){for(var t=[],i=[],n=[],r=0,s=e.length;r<s;r++){var a=e[r],l=o(a);this.addToIndex_(l,a)&&i.push(a)}for(var c=0,d=i.length;c<d;c++){var u=i[c],h=o(u);this.setupChangeEvents_(h,u);var p=u.getGeometry();if(p){var f=p.getExtent();t.push(f),n.push(u)}else this.nullGeometryFeatures_[h]=u}this.featuresRtree_&&this.featuresRtree_.load(t,n);for(var m=0,v=i.length;m<v;m++)this.dispatchEvent(new Je(Ge,i[m]))},t.prototype.bindFeaturesCollection_=function(e){var t=!1;v(this,Ge,function(i){t||(t=!0,e.push(i.feature),t=!1)}),v(this,He,function(i){t||(t=!0,e.remove(i.feature),t=!1)}),v(e,Me,function(e){t||(t=!0,this.addFeature(e.element),t=!1)},this),v(e,Oe,function(e){t||(t=!0,this.removeFeature(e.element),t=!1)},this),this.featuresCollection_=e},t.prototype.clear=function(e){if(e){for(var t in this.featureChangeKeys_){this.featureChangeKeys_[t].forEach(_)}this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.undefIdIndex_={})}else if(this.featuresRtree_)for(var i in this.featuresRtree_.forEach(this.removeFeatureInternal,this),this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[i]);this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.loadedExtentsRtree_.clear(),this.nullGeometryFeatures_={};var n=new Je(Ve);this.dispatchEvent(n),this.changed()},t.prototype.forEachFeature=function(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)},t.prototype.forEachFeatureAtCoordinateDirect=function(e,t){var i=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(i,function(i){return i.getGeometry().intersectsCoordinate(e)?t(i):void 0})},t.prototype.forEachFeatureInExtent=function(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)},t.prototype.forEachFeatureIntersectingExtent=function(e,t){return this.forEachFeatureInExtent(e,function(i){if(i.getGeometry().intersectsExtent(e)){var n=t(i);if(n)return n}})},t.prototype.getFeaturesCollection=function(){return this.featuresCollection_},t.prototype.getFeatures=function(){var e;return this.featuresCollection_?e=this.featuresCollection_.getArray():this.featuresRtree_&&(e=this.featuresRtree_.getAll(),u(this.nullGeometryFeatures_)||function(e,t){for(var i=Array.isArray(t)?t:[t],n=i.length,r=0;r<n;r++)e[e.length]=i[r]}(e,function(e){var t=[];for(var i in e)t.push(e[i]);return t}(this.nullGeometryFeatures_))),e},t.prototype.getFeaturesAtCoordinate=function(e){var t=[];return this.forEachFeatureAtCoordinateDirect(e,function(e){t.push(e)}),t},t.prototype.getFeaturesInExtent=function(e){return this.featuresRtree_.getInExtent(e)},t.prototype.getClosestFeatureToCoordinate=function(e,t){var i=e[0],n=e[1],r=null,o=[NaN,NaN],s=1/0,a=[-1/0,-1/0,1/0,1/0],l=t||D;return this.featuresRtree_.forEachInExtent(a,function(e){if(l(e)){var t=e.getGeometry(),c=s;if((s=t.closestPointXY(i,n,o,s))<c){r=e;var d=Math.sqrt(s);a[0]=i-d,a[1]=n-d,a[2]=i+d,a[3]=n+d}}}),r},t.prototype.getExtent=function(e){return this.featuresRtree_.getExtent(e)},t.prototype.getFeatureById=function(e){var t=this.idIndex_[e.toString()];return void 0!==t?t:null},t.prototype.getFormat=function(){return this.format_},t.prototype.getOverlaps=function(){return this.overlaps_},t.prototype.getUrl=function(){return this.url_},t.prototype.handleFeatureChange_=function(e){var t=e.target,i=o(t),n=t.getGeometry();if(n){var r=n.getExtent();i in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[i],this.featuresRtree_&&this.featuresRtree_.insert(r,t)):this.featuresRtree_&&this.featuresRtree_.update(r,t)}else i in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[i]=t);var s=t.getId();if(void 0!==s){var a=s.toString();i in this.undefIdIndex_?(delete this.undefIdIndex_[i],this.idIndex_[a]=t):this.idIndex_[a]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[a]=t)}else i in this.undefIdIndex_||(this.removeFromIdIndex_(t),this.undefIdIndex_[i]=t);this.changed(),this.dispatchEvent(new Je(qe,t))},t.prototype.hasFeature=function(e){var t=e.getId();return void 0!==t?t in this.idIndex_:o(e)in this.undefIdIndex_},t.prototype.isEmpty=function(){return this.featuresRtree_.isEmpty()&&u(this.nullGeometryFeatures_)},t.prototype.loadFeatures=function(e,t,i){var n=this,r=this.loadedExtentsRtree_,o=this.strategy_(e,t);this.loading=!1;for(var s=function(e,s){var a=o[e];r.forEachInExtent(a,function(e){return t=e.extent,i=a,t[0]<=i[0]&&i[2]<=t[2]&&t[1]<=i[1]&&i[3]<=t[3];var t,i})||(n.loader_.call(n,a,t,i),r.insert(a,{extent:a.slice()}),n.loading=n.loader_!==w)},a=0,l=o.length;a<l;++a)s(a)},t.prototype.removeLoadedExtent=function(e){var t,i=this.loadedExtentsRtree_;i.forEachInExtent(e,function(i){if(H(i.extent,e))return t=i,!0}),t&&i.remove(t)},t.prototype.removeFeature=function(e){var t=o(e);t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e),this.removeFeatureInternal(e),this.changed()},t.prototype.removeFeatureInternal=function(e){var t=o(e);this.featureChangeKeys_[t].forEach(_),delete this.featureChangeKeys_[t];var i=e.getId();void 0!==i?delete this.idIndex_[i.toString()]:delete this.undefIdIndex_[t],this.dispatchEvent(new Je(He,e))},t.prototype.removeFromIdIndex_=function(e){var t=!1;for(var i in this.idIndex_)if(this.idIndex_[i]===e){delete this.idIndex_[i],t=!0;break}return t},t.prototype.setLoader=function(e){this.loader_=e},t}(ze));var Qe=class extends Xe{constructor(e){super(e),this.distance=void 0!==e.distance?e.distance:20,this.minimumPolygonPixelSize=void 0!==e.minimumPolygonPixelSize?e.minimumPolygonPixelSize:this.distance,this.minimumLinePixelSize=void 0!==e.minimumLinePixelSize?e.minimumLinePixelSize:this.distance,this.disableDynamicClustering=void 0!==e.disableDynamicClustering&&e.disableDynamicClustering,this.clusterPointsOnly=void 0!==e.clusterPointsOnly&&e.clusterPointsOnly,this.threshold=void 0!==e.threshold?e.threshold:null,this.resolution=1,this.projection=null,this.clusterPrefix=e.clusterPrefix,this.clusterId=1}loadFeatures(e,t,i){this.source.loadFeatures(e,t,i),t!==this.resolution&&(this.clear(),this.resolution=t,this.projection=i,this.cluster(),this.addFeatures(this.features))}cluster(){var e=this;if(void 0===this.resolution)return;this.features.length=0;const t=[1/0,1/0,-1/0,-1/0],i=this.distance*this.resolution,n=this.source.getFeatures(),r={},s={};for(let a=0,l=n.length;a<l;a++){let l=n[a];const c=o(l);if(this._isEligibleFeature(l)){if(!(o(l)in r)){q($(l.getGeometry().computeExtent()),t),U(t,i,t);let n=this.source.getFeaturesInExtent(t);n=n.filter(function(t){const i=o(t);return!(i in r||i in s||!e._isEligibleFeature(l)||(r[i]=!0,0))}),this.features.push(this.createCluster(n))}}else s[c]=!0,this.features.push(l)}}createCluster(e){const t=[0,0];for(let i=e.length-1;i>=0;--i){const n=$(e[i].getGeometry().computeExtent());n&&P(t,n)}B(t,1/e.length);const i=new A(new Le(t));return i.set("features",e),i.set("fid",this.clusterPrefix+this.clusterId),++this.clusterId,i}_isEligibleFeature(e){if(e.n2DisableClustering)return!1;let t=!0;if(this.disableDynamicClustering)this.clusterPointsOnly&&(t=!1,e.getGeometry().getType().indexOf("Point")>=0&&(t=!0));else{t=!1;const i=this._computeFullBoundingBox(e);if(i){const e=(i[2]-i[0])/this.resolution,n=(i[3]-i[1])/this.resolution;e<this.minimumLinePixelSize&&n<this.minimumLinePixelSize&&(t=!0)}else if(e.getGeometry().getType().indexOf("Point")>=0)t=!0;else{const i=e.getGeometry().computeExtent(),n=(i[2]-i[0])/this.resolution,r=(i[3]-i[1])/this.resolution;n<this.minimumLinePixelSize&&r<this.minimumLinePixelSize&&(t=!0)}}return t}_computeFullBoundingBox(e){return this._ComputeFeatureOriginalBboxForMapProjection(e,this.projection)}_ComputeFeatureOriginalBboxForMapProjection(e,t){if(e&&e.n2ConvertedBbox)return e.n2ConvertedBbox;let i=void 0;if(e.data&&e.data.nunaliit_geom&&e.data.nunaliit_geom.bbox&&e.n2GeomProj&&t){const o=e.data.nunaliit_geom.bbox;Array.isArray(o)&&o.length>=4&&(i=o,t.getCode()!==e.n2GeomProj.getCode&&(n=o,r=e.n2GeomProj,i=Y(n,Ee(r,t))),e.n2ConvertedBbox=i)}var n,r;return i}},Ze=(i(5),{ol5support:{}});Ze.ol5support.N2Cluster=Qe;t.default=Ze}]).default});
//# sourceMappingURL=n2es6.js.map